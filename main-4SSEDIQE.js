var bz=Object.create;var s1=Object.defineProperty,wz=Object.defineProperties,Ez=Object.getOwnPropertyDescriptor,Tz=Object.getOwnPropertyDescriptors,Iz=Object.getOwnPropertyNames,Fv=Object.getOwnPropertySymbols,Sz=Object.getPrototypeOf,a1=Object.prototype.hasOwnProperty,XA=Object.prototype.propertyIsEnumerable;var ZA=(a,d,l)=>d in a?s1(a,d,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[d]=l,Gt=(a,d)=>{for(var l in d||={})a1.call(d,l)&&ZA(a,l,d[l]);if(Fv)for(var l of Fv(d))XA.call(d,l)&&ZA(a,l,d[l]);return a},Vi=(a,d)=>wz(a,Tz(d));var Nv=(a,d)=>{var l={};for(var m in a)a1.call(a,m)&&d.indexOf(m)<0&&(l[m]=a[m]);if(a!=null&&Fv)for(var m of Fv(a))d.indexOf(m)<0&&XA.call(a,m)&&(l[m]=a[m]);return l};var Dz=(a,d)=>()=>(d||a((d={exports:{}}).exports,d),d.exports);var Cz=(a,d,l,m)=>{if(d&&typeof d=="object"||typeof d=="function")for(let b of Iz(d))!a1.call(a,b)&&b!==l&&s1(a,b,{get:()=>d[b],enumerable:!(m=Ez(d,b))||m.enumerable});return a};var Az=(a,d,l)=>(l=a!=null?bz(Sz(a)):{},Cz(d||!a||!a.__esModule?s1(l,"default",{value:a,enumerable:!0}):l,a));var bl=(a,d,l)=>new Promise((m,b)=>{var r=G=>{try{N(l.next(G))}catch(fe){b(fe)}},M=G=>{try{N(l.throw(G))}catch(fe){b(fe)}},N=G=>G.done?m(G.value):Promise.resolve(G.value).then(r,M);N((l=l.apply(a,d)).next())});var RO=Dz((EI,TI)=>{"use strict";(function(a,d){typeof EI=="object"&&typeof TI<"u"?TI.exports=d():typeof define=="function"&&define.amd?define(d):(a=typeof globalThis<"u"?globalThis:a||self,a.mapboxgl=d())})(EI,function(){"use strict";var a,d,l;function m(r,M){if(!a)a=M;else if(!d)d=M;else{var N="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+a+")(sharedChunk); ("+d+")(sharedChunk); self.onerror = null;",G={};a(G),l=M(G),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(l.workerUrl=window.URL.createObjectURL(new Blob([N],{type:"text/javascript"})))}}m(["exports"],function(r){var M=1e-6,N=typeof Float32Array<"u"?Float32Array:Array;function G(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=n*f-c*s;return p?(i[0]=f*(p=1/p),i[1]=-s*p,i[2]=-c*p,i[3]=n*p,i):null}function fe(){var i=new N(9);return N!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function Me(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=e[4],y=e[5],x=e[6],w=e[7],I=e[8];return i[0]=p*I-y*w,i[1]=c*w-s*I,i[2]=s*y-c*p,i[3]=y*x-f*I,i[4]=n*I-c*x,i[5]=c*f-n*y,i[6]=f*w-p*x,i[7]=s*x-n*w,i[8]=n*p-s*f,i}function Ue(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3],y=e[4],x=e[5],w=e[6],I=e[7],S=e[8],D=n[0],P=n[1],O=n[2],F=n[3],B=n[4],H=n[5],X=n[6],Z=n[7],K=n[8];return i[0]=D*s+P*p+O*w,i[1]=D*c+P*y+O*I,i[2]=D*f+P*x+O*S,i[3]=F*s+B*p+H*w,i[4]=F*c+B*y+H*I,i[5]=F*f+B*x+H*S,i[6]=X*s+Z*p+K*w,i[7]=X*c+Z*y+K*I,i[8]=X*f+Z*x+K*S,i}function bt(){var i=new N(16);return N!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i}function Fe(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function Pt(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=e[4],y=e[5],x=e[6],w=e[7],I=e[8],S=e[9],D=e[10],P=e[11],O=e[12],F=e[13],B=e[14],H=e[15],X=n*y-s*p,Z=n*x-c*p,K=n*w-f*p,de=s*x-c*y,ae=s*w-f*y,ce=c*w-f*x,ge=I*F-S*O,ye=I*B-D*O,ke=I*H-P*O,be=S*B-D*F,ze=S*H-P*F,et=D*H-P*B,Ve=X*et-Z*ze+K*be+de*ke-ae*ye+ce*ge;return Ve?(i[0]=(y*et-x*ze+w*be)*(Ve=1/Ve),i[1]=(c*ze-s*et-f*be)*Ve,i[2]=(F*ce-B*ae+H*de)*Ve,i[3]=(D*ae-S*ce-P*de)*Ve,i[4]=(x*ke-p*et-w*ye)*Ve,i[5]=(n*et-c*ke+f*ye)*Ve,i[6]=(B*K-O*ce-H*Z)*Ve,i[7]=(I*ce-D*K+P*Z)*Ve,i[8]=(p*ze-y*ke+w*ge)*Ve,i[9]=(s*ke-n*ze-f*ge)*Ve,i[10]=(O*ae-F*K+H*X)*Ve,i[11]=(S*K-I*ae-P*X)*Ve,i[12]=(y*ye-p*be-x*ge)*Ve,i[13]=(n*be-s*ye+c*ge)*Ve,i[14]=(F*Z-O*de-B*X)*Ve,i[15]=(I*de-S*Z+D*X)*Ve,i):null}function Vt(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3],y=e[4],x=e[5],w=e[6],I=e[7],S=e[8],D=e[9],P=e[10],O=e[11],F=e[12],B=e[13],H=e[14],X=e[15],Z=n[0],K=n[1],de=n[2],ae=n[3];return i[0]=Z*s+K*y+de*S+ae*F,i[1]=Z*c+K*x+de*D+ae*B,i[2]=Z*f+K*w+de*P+ae*H,i[3]=Z*p+K*I+de*O+ae*X,i[4]=(Z=n[4])*s+(K=n[5])*y+(de=n[6])*S+(ae=n[7])*F,i[5]=Z*c+K*x+de*D+ae*B,i[6]=Z*f+K*w+de*P+ae*H,i[7]=Z*p+K*I+de*O+ae*X,i[8]=(Z=n[8])*s+(K=n[9])*y+(de=n[10])*S+(ae=n[11])*F,i[9]=Z*c+K*x+de*D+ae*B,i[10]=Z*f+K*w+de*P+ae*H,i[11]=Z*p+K*I+de*O+ae*X,i[12]=(Z=n[12])*s+(K=n[13])*y+(de=n[14])*S+(ae=n[15])*F,i[13]=Z*c+K*x+de*D+ae*B,i[14]=Z*f+K*w+de*P+ae*H,i[15]=Z*p+K*I+de*O+ae*X,i}function jt(i,e,n){var s,c,f,p,y,x,w,I,S,D,P,O,F=n[0],B=n[1],H=n[2];return e===i?(i[12]=e[0]*F+e[4]*B+e[8]*H+e[12],i[13]=e[1]*F+e[5]*B+e[9]*H+e[13],i[14]=e[2]*F+e[6]*B+e[10]*H+e[14],i[15]=e[3]*F+e[7]*B+e[11]*H+e[15]):(c=e[1],f=e[2],p=e[3],y=e[4],x=e[5],w=e[6],I=e[7],S=e[8],D=e[9],P=e[10],O=e[11],i[0]=s=e[0],i[1]=c,i[2]=f,i[3]=p,i[4]=y,i[5]=x,i[6]=w,i[7]=I,i[8]=S,i[9]=D,i[10]=P,i[11]=O,i[12]=s*F+y*B+S*H+e[12],i[13]=c*F+x*B+D*H+e[13],i[14]=f*F+w*B+P*H+e[14],i[15]=p*F+I*B+O*H+e[15]),i}function Nt(i,e,n){var s=n[0],c=n[1],f=n[2];return i[0]=e[0]*s,i[1]=e[1]*s,i[2]=e[2]*s,i[3]=e[3]*s,i[4]=e[4]*c,i[5]=e[5]*c,i[6]=e[6]*c,i[7]=e[7]*c,i[8]=e[8]*f,i[9]=e[9]*f,i[10]=e[10]*f,i[11]=e[11]*f,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function ar(i,e,n){var s=Math.sin(n),c=Math.cos(n),f=e[4],p=e[5],y=e[6],x=e[7],w=e[8],I=e[9],S=e[10],D=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=f*c+w*s,i[5]=p*c+I*s,i[6]=y*c+S*s,i[7]=x*c+D*s,i[8]=w*c-f*s,i[9]=I*c-p*s,i[10]=S*c-y*s,i[11]=D*c-x*s,i}function lr(i,e,n){var s=Math.sin(n),c=Math.cos(n),f=e[0],p=e[1],y=e[2],x=e[3],w=e[8],I=e[9],S=e[10],D=e[11];return e!==i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=f*c-w*s,i[1]=p*c-I*s,i[2]=y*c-S*s,i[3]=x*c-D*s,i[8]=f*s+w*c,i[9]=p*s+I*c,i[10]=y*s+S*c,i[11]=x*s+D*c,i}function Ri(i,e,n){var s=Math.sin(n),c=Math.cos(n),f=e[0],p=e[1],y=e[2],x=e[3],w=e[4],I=e[5],S=e[6],D=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=f*c+w*s,i[1]=p*c+I*s,i[2]=y*c+S*s,i[3]=x*c+D*s,i[4]=w*c-f*s,i[5]=I*c-p*s,i[6]=S*c-y*s,i[7]=D*c-x*s,i}function _s(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=e[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function xo(i,e,n){var s,c,f,p=n[0],y=n[1],x=n[2],w=Math.hypot(p,y,x);return w<M?null:(p*=w=1/w,y*=w,x*=w,s=Math.sin(e),c=Math.cos(e),i[0]=p*p*(f=1-c)+c,i[1]=y*p*f+x*s,i[2]=x*p*f-y*s,i[3]=0,i[4]=p*y*f-x*s,i[5]=y*y*f+c,i[6]=x*y*f+p*s,i[7]=0,i[8]=p*x*f+y*s,i[9]=y*x*f-p*s,i[10]=x*x*f+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i)}function ys(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=n+n,y=s+s,x=c+c,w=n*p,I=s*p,S=s*y,D=c*p,P=c*y,O=c*x,F=f*p,B=f*y,H=f*x;return i[0]=1-S-O,i[1]=I+H,i[2]=D-B,i[3]=0,i[4]=I-H,i[5]=1-w-O,i[6]=P+F,i[7]=0,i[8]=D+B,i[9]=P-F,i[10]=1-w-S,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});var qd=Vt;function Nn(){var i=new N(3);return N!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function zl(i){var e=new N(3);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e}function Er(i){return Math.hypot(i[0],i[1],i[2])}function Wi(i,e,n){var s=new N(3);return s[0]=i,s[1]=e,s[2]=n,s}function Ui(i,e,n,s){return i[0]=e,i[1]=n,i[2]=s,i}function pi(i,e,n){return i[0]=e[0]+n[0],i[1]=e[1]+n[1],i[2]=e[2]+n[2],i}function lo(i,e,n){return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],i}function ru(i,e,n){return i[0]=e[0]*n[0],i[1]=e[1]*n[1],i[2]=e[2]*n[2],i}function Ps(i,e,n){return i[0]=Math.min(e[0],n[0]),i[1]=Math.min(e[1],n[1]),i[2]=Math.min(e[2],n[2]),i}function $o(i,e,n){return i[0]=Math.max(e[0],n[0]),i[1]=Math.max(e[1],n[1]),i[2]=Math.max(e[2],n[2]),i}function hi(i,e,n){return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i}function zr(i,e,n,s){return i[0]=e[0]+n[0]*s,i[1]=e[1]+n[1]*s,i[2]=e[2]+n[2]*s,i}function Bl(i,e){var n=e[0]-i[0],s=e[1]-i[1],c=e[2]-i[2];return n*n+s*s+c*c}function Wd(i){var e=i[0],n=i[1],s=i[2];return e*e+n*n+s*s}function aa(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i}function ci(i,e){var n=e[0],s=e[1],c=e[2],f=n*n+s*s+c*c;return f>0&&(f=1/Math.sqrt(f)),i[0]=e[0]*f,i[1]=e[1]*f,i[2]=e[2]*f,i}function Fi(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function Zi(i,e,n){var s=e[0],c=e[1],f=e[2],p=n[0],y=n[1],x=n[2];return i[0]=c*x-f*y,i[1]=f*p-s*x,i[2]=s*y-c*p,i}function Yr(i,e,n,s){var c=e[0],f=e[1],p=e[2];return i[0]=c+s*(n[0]-c),i[1]=f+s*(n[1]-f),i[2]=p+s*(n[2]-p),i}function Ni(i,e,n){var s=e[0],c=e[1],f=e[2],p=n[3]*s+n[7]*c+n[11]*f+n[15];return i[0]=(n[0]*s+n[4]*c+n[8]*f+n[12])/(p=p||1),i[1]=(n[1]*s+n[5]*c+n[9]*f+n[13])/p,i[2]=(n[2]*s+n[6]*c+n[10]*f+n[14])/p,i}function la(i,e,n){var s=e[0],c=e[1],f=e[2];return i[0]=s*n[0]+c*n[3]+f*n[6],i[1]=s*n[1]+c*n[4]+f*n[7],i[2]=s*n[2]+c*n[5]+f*n[8],i}function ca(i,e,n){var s=n[0],c=n[1],f=n[2],p=e[0],y=e[1],x=e[2],w=c*x-f*y,I=f*p-s*x,S=s*y-c*p,D=c*S-f*I,P=f*w-s*S,O=s*I-c*w,F=2*n[3];return I*=F,S*=F,P*=2,O*=2,i[0]=p+(w*=F)+(D*=2),i[1]=y+I+P,i[2]=x+S+O,i}function ou(i){return i[0]=0,i[1]=0,i[2]=0,i}function Go(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]}var zi=lo,Kr=ru,ua=Er;function su(){var i=new N(4);return N!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function Os(i,e,n){return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i[3]=e[3]*n,i}function bo(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=n*n+s*s+c*c+f*f;return p>0&&(p=1/Math.sqrt(p)),i[0]=n*p,i[1]=s*p,i[2]=c*p,i[3]=f*p,i}function co(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3];return i[0]=n[0]*s+n[4]*c+n[8]*f+n[12]*p,i[1]=n[1]*s+n[5]*c+n[9]*f+n[13]*p,i[2]=n[2]*s+n[6]*c+n[10]*f+n[14]*p,i[3]=n[3]*s+n[7]*c+n[11]*f+n[15]*p,i}function Ls(){var i=new N(4);return N!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function ks(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function Ka(i,e,n){n*=.5;var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x+p*y,i[1]=c*x+f*y,i[2]=f*x-c*y,i[3]=p*x-s*y,i}function Vl(i,e,n){n*=.5;var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x-f*y,i[1]=c*x+p*y,i[2]=f*x+s*y,i[3]=p*x-c*y,i}Nn(),su();var Jr,wo,au,Fs=bo,jl=(Jr=Nn(),wo=Wi(1,0,0),au=Wi(0,1,0),function(i,e,n){var s=Fi(e,n);return s<-.999999?(Zi(Jr,wo,e),ua(Jr)<1e-6&&Zi(Jr,au,e),ci(Jr,Jr),function(c,f,p){p*=.5;var y=Math.sin(p);c[0]=y*f[0],c[1]=y*f[1],c[2]=y*f[2],c[3]=Math.cos(p)}(i,Jr,Math.PI),i):s>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(Zi(Jr,e,n),i[0]=Jr[0],i[1]=Jr[1],i[2]=Jr[2],i[3]=1+s,Fs(i,i))});function Mr(){var i=new N(2);return N!=Float32Array&&(i[0]=0,i[1]=0),i}function Eo(i,e){var n=new N(2);return n[0]=i,n[1]=e,n}function da(i,e,n){return i[0]=e[0]+n[0],i[1]=e[1]+n[1],i}function Ns(i,e,n){return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i}function ha(i,e,n){return i[0]=e[0]*n,i[1]=e[1]*n,i}function fa(i){return Math.hypot(i[0],i[1])}function Ul(i,e){var n=e[0],s=e[1],c=n*n+s*s;return c>0&&(c=1/Math.sqrt(c)),i[0]=e[0]*c,i[1]=e[1]*c,i}function ui(i,e){return i[0]*e[0]+i[1]*e[1]}Ls(),Ls(),fe();var lu,cu,To=Ns;function uu(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}Mr();var fp=function(){if(cu)return lu;function i(e,n,s,c){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(c-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=n,this.p2x=s,this.p2y=c}return cu=1,lu=i,i.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,n){if(n===void 0&&(n=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,c=0;c<8;c++){var f=this.sampleCurveX(s)-e;if(Math.abs(f)<n)return s;var p=this.sampleCurveDerivativeX(s);if(Math.abs(p)<1e-6)break;s-=f/p}var y=0,x=1;for(s=e,c=0;c<20&&(f=this.sampleCurveX(s),!(Math.abs(f-e)<n));c++)e>f?y=s:x=s,s=.5*(x-y)+y;return s},solve:function(e,n){return this.sampleCurveY(this.solveCurveX(e,n))}},lu}(),Hl=uu(fp);function Xe(i,e){this.x=i,this.y=e}function zs(i,e){if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let n=0;n<i.length;n++)if(!zs(i[n],e[n]))return!1;return!0}if(typeof i=="object"&&i!==null&&e!==null){if(typeof e!="object"||Object.keys(i).length!==Object.keys(e).length)return!1;for(let n in i)if(!zs(i[n],e[n]))return!1;return!0}return i===e}Xe.prototype={clone(){return new Xe(this.x,this.y)},add(i){return this.clone()._add(i)},sub(i){return this.clone()._sub(i)},multByPoint(i){return this.clone()._multByPoint(i)},divByPoint(i){return this.clone()._divByPoint(i)},mult(i){return this.clone()._mult(i)},div(i){return this.clone()._div(i)},rotate(i){return this.clone()._rotate(i)},rotateAround(i,e){return this.clone()._rotateAround(i,e)},matMult(i){return this.clone()._matMult(i)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(i){return this.x===i.x&&this.y===i.y},dist(i){return Math.sqrt(this.distSqr(i))},distSqr(i){let e=i.x-this.x,n=i.y-this.y;return e*e+n*n},angle(){return Math.atan2(this.y,this.x)},angleTo(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith(i){return this.angleWithSep(i.x,i.y)},angleWithSep(i,e){return Math.atan2(this.x*e-this.y*i,this.x*i+this.y*e)},_matMult(i){let e=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=e,this},_add(i){return this.x+=i.x,this.y+=i.y,this},_sub(i){return this.x-=i.x,this.y-=i.y,this},_mult(i){return this.x*=i,this.y*=i,this},_div(i){return this.x/=i,this.y/=i,this},_multByPoint(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint(i){return this.x/=i.x,this.y/=i.y,this},_unit(){return this._div(this.mag()),this},_perp(){let i=this.y;return this.y=this.x,this.x=-i,this},_rotate(i){let e=Math.cos(i),n=Math.sin(i),s=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=s,this},_rotateAround(i,e){let n=Math.cos(i),s=Math.sin(i),c=e.y+s*(this.x-e.x)+n*(this.y-e.y);return this.x=e.x+n*(this.x-e.x)-s*(this.y-e.y),this.y=c,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Xe},Xe.convert=function(i){if(i instanceof Xe)return i;if(Array.isArray(i))return new Xe(+i[0],+i[1]);if(i.x!==void 0&&i.y!==void 0)return new Xe(+i.x,+i.y);throw new Error("Expected [x, y] or {x, y} point format")};let pp=Math.PI/180,du=180/Math.PI;function Sn(i){return i*pp}function Se(i){return i*du}let $=[[0,0],[1,0],[1,1],[0,1]];function q(i){if(i<=0)return 0;if(i>=1)return 1;let e=i*i,n=e*i;return 4*(i<.5?n:3*(i-e)+n-.75)}function te(i,e,n,s){let c=new Hl(i,e,n,s);return function(f){return c.solve(f)}}let he=te(.25,.1,.25,1);function ne(i,e,n){return Math.min(n,Math.max(e,i))}function _e(i,e,n){return(n=ne((n-i)/(e-i),0,1))*n*(3-2*n)}function Ae(i,e,n){let s=n-e,c=((i-e)%s+s)%s+e;return c===e?n:c}function ve(i,e,n){if(!i.length)return n(null,[]);let s=i.length,c=new Array(i.length),f=null;i.forEach((p,y)=>{e(p,(x,w)=>{x&&(f=x),c[y]=w,--s==0&&n(f,c)})})}function De(i,...e){for(let n of e)for(let s in n)i[s]=n[s];return i}let nt=1;function je(){return nt++}function Dt(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))}function Ft(i,e){i.forEach(n=>{e[n]&&(e[n]=e[n].bind(e))})}function Ut(i,e,n){let s={};for(let c in i)s[c]=e.call(this,i[c],c,i);return s}function dn(i,e,n){let s={};for(let c in i)e.call(this,i[c],c,i)&&(s[c]=i[c]);return s}function rn(i){return Array.isArray(i)?i.map(rn):typeof i=="object"&&i?Ut(i,rn):i}function hn(i,e){for(let n=0;n<i.length;n++)if(e.indexOf(i[n])>=0)return!0;return!1}let Kn={};function fn(i){Kn[i]||(typeof console<"u"&&console.warn(i),Kn[i]=!0)}function Pi(i,e,n){return(n.y-i.y)*(e.x-i.x)>(e.y-i.y)*(n.x-i.x)}function ir(i){let e=0;for(let n,s,c=0,f=i.length,p=f-1;c<f;p=c++)n=i[c],s=i[p],e+=(s.x-n.x)*(n.y+s.y);return e}function Ki([i,e,n]){let s=Sn(e+90),c=Sn(n);return{x:i*Math.cos(s)*Math.sin(c),y:i*Math.sin(s)*Math.sin(c),z:i*Math.cos(c),azimuthal:e,polar:n}}function Gn(i){return(typeof self<"u"||i!==void 0)&&typeof WorkerGlobalScope<"u"&&(i!==void 0?i:self)instanceof WorkerGlobalScope}function An(i){let e={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,s,c,f)=>{let p=c||f;return e[s]=!p||p.toLowerCase(),""}),e["max-age"]){let n=parseInt(e["max-age"],10);isNaN(n)?delete e["max-age"]:e["max-age"]=n}return e}let Ai=null;function bi(i,e){return[i[4*e],i[4*e+1],i[4*e+2],i[4*e+3]]}function mi(i,e,n,s){for(;e<n;){let c=e+n>>1;i[c]<s?e=c+1:n=c}return e}function hr(i,e,n,s){for(;e<n;){let c=e+n>>1;i[c]<=s?e=c+1:n=c}return e}function Qr(i){return i>0?1/(1.001-i):1+i}function Rr(i){return i>0?1-1/(1.001-i):-i}function hu(i,e,n){return(i-e.min)*(n.max-n.min)/(e.max-e.min)+n.min}let vr={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!vr.API_URL)return null;try{let i=new URL(vr.API_URL);return i.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":i.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.1.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function pa(i){return vr.API_URL_REGEX.test(i)}function Zd(i){return vr.API_SPRITE_REGEX.test(i)}let fu,pu,Xd,Yd,Ja,mu;function Kd(){return fu==null&&(fu=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),fu}let rs={now:()=>Yd!==void 0?Yd:performance.now(),setNow(i){Yd=i},restoreNow(){Yd=void 0},frame(i){let e=requestAnimationFrame(i);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(i,e=0){let{width:n,height:s}=i;Ja||(Ja=document.createElement("canvas"));let c=Ja.getContext("2d",{willReadFrequently:!0});if(!c)throw new Error("failed to create canvas 2d context");return(n>Ja.width||s>Ja.height)&&(Ja.width=n,Ja.height=s),c.clearRect(-e,-e,n+2*e,s+2*e),c.drawImage(i,0,0,n,s),c.getImageData(-e,-e,n+2*e,s+2*e)},resolveURL:i=>(pu||(pu=document.createElement("a")),pu.href=i,pu.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Xd==null&&(Xd=window.matchMedia("(prefers-reduced-motion: reduce)")),Xd.matches)},hasCanvasFingerprintNoise(){if(mu!==void 0)return mu;if(!Kd())return mu=!1,!1;let i=new OffscreenCanvas(85,1),e=i.getContext("2d",{willReadFrequently:!0}),n=0;for(let c=0;c<i.width;++c)e.fillStyle=`rgba(${n++},${n++},${n++}, 255)`,e.fillRect(c,0,1,1);let s=e.getImageData(0,0,i.width,i.height);n=0;for(let c=0;c<s.data.length;++c)if(c%4!=3&&n++!==s.data[c])return mu=!0,!0;return mu=!1,!1}};function Io(i,e){let n=i.indexOf("?");if(n<0)return`${i}?${new URLSearchParams(e).toString()}`;let s=new URLSearchParams(i.slice(n));for(let c in e)s.set(c,e[c]);return`${i.slice(0,n)}?${s.toString()}`}function qo(i,e={persistentParams:[]}){let n=i.indexOf("?");if(n<0)return i;let s=new URLSearchParams,c=new URLSearchParams(i.slice(n));for(let p of e.persistentParams){let y=c.get(p);y&&s.set(p,y)}let f=s.toString();return`${i.slice(0,n)}${f.length>0?`?${f}`:""}`}let Bs="mapbox-tiles",os=500,Vs=50,gu=["language","worldview","jobid"],vs,_u;function Qa(){try{return caches}catch{}}function $l(){let i=Qa();i&&vs==null&&(vs=i.open(Bs))}let mp=1/0,gp={supported:!1,testSupport:function(i){!yu&&el&&(Gl?F_(i):eo=i)}},eo,el,yu=!1,Gl=!1,k_=typeof self<"u"?self:{};function F_(i){let e=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);try{if(i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,el),i.isContextLost())return;gp.supported=!0}catch{}i.deleteTexture(e),yu=!0}k_.document&&(el=k_.document.createElement("img"),el.onload=function(){eo&&F_(eo),eo=null,Gl=!0},el.onerror=function(){yu=!0,eo=null},el.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let vu={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(vu);class xn extends Error{constructor(e,n,s){n===401&&pa(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=n,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let Jd=Gn()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,ql=function(i,e){if(!(/^file:/.test(n=i.url)||/^file:/.test(Jd())&&!/^\w+:/.test(n))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,c){let f=new AbortController,p=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:Jd(),referrerPolicy:s.referrerPolicy,signal:f.signal}),y=!1,x=!1,w=(I=p.url).indexOf("sku=")>0&&pa(I);var I;s.type==="json"&&p.headers.set("Accept","application/json");let S=(P,O,F)=>{if(x)return;if(P&&P.message!=="SecurityError"&&fn(P.toString()),O&&F)return D(O);let B=Date.now();fetch(p).then(H=>{if(H.ok){let X=w?H.clone():null;return D(H,X,B)}return c(new xn(H.statusText,H.status,s.url))}).catch(H=>{H.name!=="AbortError"&&c(new Error(`${H.message} ${s.url}`))})},D=(P,O,F)=>{(s.type==="arrayBuffer"?P.arrayBuffer():s.type==="json"?P.json():P.text()).then(B=>{x||(O&&F&&function(H,X,Z){if($l(),vs==null)return;let K=An(X.headers.get("Cache-Control")||"");if(K["no-store"])return;let de={status:X.status,statusText:X.statusText,headers:new Headers};X.headers.forEach((ge,ye)=>de.headers.set(ye,ge)),K["max-age"]&&de.headers.set("Expires",new Date(Z+1e3*K["max-age"]).toUTCString());let ae=de.headers.get("Expires");if(!ae||new Date(ae).getTime()-Z<42e4)return;let ce=qo(H.url,{persistentParams:gu});if(X.status===206){let ge=H.headers.get("Range");if(!ge)return;de.status=200,ce=Io(ce,{range:ge})}(function(ge,ye){if(_u===void 0)try{new Response(new ReadableStream),_u=!0}catch{_u=!1}_u?ye(ge.body):ge.blob().then(ye).catch(ke=>fn(ke.message))})(X,ge=>{let ye=new Response((ke=X.status)!==200&&ke!==404&&[101,103,204,205,304].includes(ke)?null:ge,de);var ke;$l(),vs?.then(be=>be.put(ce,ye)).catch(be=>fn(be.message))})}(p,O,F),y=!0,c(null,B,P.headers.get("Cache-Control"),P.headers.get("Expires")))}).catch(B=>{x||c(new Error(B.message))})};return w?function(P,O){if($l(),vs==null)return O(null);vs.then(F=>{let B=qo(P.url,{persistentParams:gu}),H=P.headers.get("Range");H&&(B=Io(B,{range:H})),F.match(B).then(X=>{let Z=function(K){if(!K)return!1;let de=new Date(K.headers.get("Expires")||0),ae=An(K.headers.get("Cache-Control")||"");return Number(de)>Date.now()&&!ae["no-cache"]}(X);F.delete(B).catch(O),Z&&F.put(B,X.clone()).catch(O),O(null,X,Z)}).catch(O)}).catch(O)}(p,S):S(null,null),{cancel:()=>{x=!0,y||f.abort()}}}(i,e);if(Gn(self)&&self.worker.actor)return self.worker.actor.send("getResource",i,e,void 0,!0)}var n;return function(s,c){let f=new XMLHttpRequest;f.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(f.responseType="arraybuffer");for(let p in s.headers)f.setRequestHeader(p,s.headers[p]);return s.type==="json"&&(f.responseType="text",f.setRequestHeader("Accept","application/json")),f.withCredentials=s.credentials==="include",f.onerror=()=>{c(new Error(f.statusText))},f.onload=()=>{if((f.status>=200&&f.status<300||f.status===0)&&f.response!==null){let p=f.response;if(s.type==="json")try{p=JSON.parse(f.response)}catch(y){return c(y)}c(null,p,f.getResponseHeader("Cache-Control"),f.getResponseHeader("Expires"))}else c(new xn(f.statusText,f.status,s.url))},f.send(s.body),{cancel:()=>f.abort()}}(i,e)},xu=function(i,e){return ql(De(i,{type:"arrayBuffer"}),e)};function db(i){let e=document.createElement("a");return e.href=i,e.protocol===location.protocol&&e.host===location.host}let bu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",tl,ma;tl=[],ma=0;let wu=function(i,e){if(gp.supported&&(i.headers||(i.headers={}),i.headers.accept="image/webp,*/*"),ma>=vr.MAX_PARALLEL_IMAGE_REQUESTS){let f={requestParameters:i,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return tl.push(f),f}ma++;let n=!1,s=()=>{if(!n)for(n=!0,ma--;tl.length&&ma<vr.MAX_PARALLEL_IMAGE_REQUESTS;){let f=tl.shift(),{requestParameters:p,callback:y,cancelled:x}=f;x||(f.cancel=wu(p,y).cancel)}},c=xu(i,(f,p,y,x)=>{s(),f?e(f):p&&(self.createImageBitmap?function(w,I){let S=new Blob([new Uint8Array(w)],{type:"image/png"});createImageBitmap(S).then(D=>{I(null,D)}).catch(D=>{I(new Error(`Could not load image because of ${D.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(p,(w,I)=>e(w,I,y,x)):function(w,I){let S=new Image;S.onload=()=>{I(null,S),URL.revokeObjectURL(S.src),S.onload=null,requestAnimationFrame(()=>{S.src=bu})},S.onerror=()=>I(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let D=new Blob([new Uint8Array(w)],{type:"image/png"});S.src=w.byteLength?URL.createObjectURL(D):bu}(p,(w,I)=>e(w,I,y,x)))});return{cancel:()=>{c.cancel(),s()}}};var N_,Qd,z_,Wl={exports:{}},nl={exports:{}},B_={exports:{}},Eu=function(){if(z_)return Wl.exports;z_=1;var i=(N_||(N_=1,nl.exports=function(n,s){var c,f,p,y,x,w,I,S;for(f=n.length-(c=3&n.length),p=s,x=3432918353,w=461845907,S=0;S<f;)I=255&n.charCodeAt(S)|(255&n.charCodeAt(++S))<<8|(255&n.charCodeAt(++S))<<16|(255&n.charCodeAt(++S))<<24,++S,p=27492+(65535&(y=5*(65535&(p=(p^=I=(65535&(I=(I=(65535&I)*x+(((I>>>16)*x&65535)<<16)&4294967295)<<15|I>>>17))*w+(((I>>>16)*w&65535)<<16)&4294967295)<<13|p>>>19))+((5*(p>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(I=0,c){case 3:I^=(255&n.charCodeAt(S+2))<<16;case 2:I^=(255&n.charCodeAt(S+1))<<8;case 1:p^=I=(65535&(I=(I=(65535&(I^=255&n.charCodeAt(S)))*x+(((I>>>16)*x&65535)<<16)&4294967295)<<15|I>>>17))*w+(((I>>>16)*w&65535)<<16)&4294967295}return p^=n.length,p=2246822507*(65535&(p^=p>>>16))+((2246822507*(p>>>16)&65535)<<16)&4294967295,p=3266489909*(65535&(p^=p>>>13))+((3266489909*(p>>>16)&65535)<<16)&4294967295,(p^=p>>>16)>>>0}),nl.exports),e=(Qd||(Qd=1,B_.exports=function(n,s){for(var c,f=n.length,p=s^f,y=0;f>=4;)c=1540483477*(65535&(c=255&n.charCodeAt(y)|(255&n.charCodeAt(++y))<<8|(255&n.charCodeAt(++y))<<16|(255&n.charCodeAt(++y))<<24))+((1540483477*(c>>>16)&65535)<<16),p=1540483477*(65535&p)+((1540483477*(p>>>16)&65535)<<16)^(c=1540483477*(65535&(c^=c>>>24))+((1540483477*(c>>>16)&65535)<<16)),f-=4,++y;switch(f){case 3:p^=(255&n.charCodeAt(y+2))<<16;case 2:p^=(255&n.charCodeAt(y+1))<<8;case 1:p=1540483477*(65535&(p^=255&n.charCodeAt(y)))+((1540483477*(p>>>16)&65535)<<16)}return p=1540483477*(65535&(p^=p>>>13))+((1540483477*(p>>>16)&65535)<<16),(p^=p>>>15)>>>0}),B_.exports);return Wl.exports=i,Wl.exports.murmur3=i,Wl.exports.murmur2=e,Wl.exports}(),Zl=uu(Eu);class js{constructor(e,...n){De(this,n[0]||{}),this.type=e}}class So extends js{constructor(e,n={}){super("error",De({error:e},n))}}function _p(i,e,n){n[i]&&n[i].indexOf(e)!==-1||(n[i]=n[i]||[],n[i].push(e))}function yp(i,e,n){if(n&&n[i]){let s=n[i].indexOf(e);s!==-1&&n[i].splice(s,1)}}class il{on(e,n){return this._listeners=this._listeners||{},_p(e,n,this._listeners),this}off(e,n){return yp(e,n,this._listeners),yp(e,n,this._oneTimeListeners),this}once(e,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},_p(e,n,this._oneTimeListeners),this):new Promise(s=>{this.once(e,s)})}fire(e,n){let s=typeof e=="string"?new js(e,n):e,c=s.type;if(this.listens(c)){s.target=this;let f=this._listeners&&this._listeners[c]?this._listeners[c].slice():[];for(let x of f)x.call(this,s);let p=this._oneTimeListeners&&this._oneTimeListeners[c]?this._oneTimeListeners[c].slice():[];for(let x of p)yp(c,x,this._oneTimeListeners),x.call(this,s);let y=this._eventedParent;y&&(De(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),y.fire(s))}else s instanceof So&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,n){return this._eventedParent=e,this._eventedParentData=n,this}}class uo{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new uo(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){let[n,s]=e.split("");return new uo({name:n,iconsetId:s})}static isEqual(e,n){return e.name===n.name&&e.iconsetId===n.iconsetId}toString(){return uo.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var vp,eh={},xp=function(){if(vp)return eh;vp=1;var i={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(f){return(f=Math.round(f))<0?0:f>255?255:f}function n(f){return e(f[f.length-1]==="%"?parseFloat(f)/100*255:parseInt(f))}function s(f){return(p=f[f.length-1]==="%"?parseFloat(f)/100:parseFloat(f))<0?0:p>1?1:p;var p}function c(f,p,y){return y<0?y+=1:y>1&&(y-=1),6*y<1?f+(p-f)*y*6:2*y<1?p:3*y<2?f+(p-f)*(2/3-y)*6:f}try{eh.parseCSSColor=function(f){var p,y=f.replace(/ /g,"").toLowerCase();if(y in i)return i[y].slice();if(y[0]==="#")return y.length===4?(p=parseInt(y.substr(1),16))>=0&&p<=4095?[(3840&p)>>4|(3840&p)>>8,240&p|(240&p)>>4,15&p|(15&p)<<4,1]:null:y.length===7&&(p=parseInt(y.substr(1),16))>=0&&p<=16777215?[(16711680&p)>>16,(65280&p)>>8,255&p,1]:null;var x=y.indexOf("("),w=y.indexOf(")");if(x!==-1&&w+1===y.length){var I=y.substr(0,x),S=y.substr(x+1,w-(x+1)).split(","),D=1;switch(I){case"rgba":if(S.length!==4)return null;D=s(S.pop());case"rgb":return S.length!==3?null:[n(S[0]),n(S[1]),n(S[2]),D];case"hsla":if(S.length!==4)return null;D=s(S.pop());case"hsl":if(S.length!==3)return null;var P=(parseFloat(S[0])%360+360)%360/360,O=s(S[1]),F=s(S[2]),B=F<=.5?F*(O+1):F+O-F*O,H=2*F-B;return[e(255*c(H,B,P+1/3)),e(255*c(H,B,P)),e(255*c(H,B,P-1/3)),D];default:return null}}return null}}catch{}return eh}();class Ln{constructor(e,n,s,c=1){this.r=e,this.g=n,this.b=s,this.a=c}static parse(e){if(!e)return;if(e instanceof Ln)return e;if(typeof e!="string")return;let n=xp.parseCSSColor(e);return n?new Ln(n[0]/255,n[1]/255,n[2]/255,n[3]):void 0}toString(){let[e,n,s,c]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*n)},${Math.round(255*s)},${c})`}toNonPremultipliedRenderColor(e){let{r:n,g:s,b:c,a:f}=this;return new Xl(e,n,s,c,f)}toPremultipliedRenderColor(e){let{r:n,g:s,b:c,a:f}=this;return new V_(e,n*f,s*f,c*f,f)}clone(){return new Ln(this.r,this.g,this.b,this.a)}}class Tu{constructor(e,n,s,c,f,p=!1){if(this.premultiplied=!1,this.premultiplied=p,e){let y=e.image.height,x=y*y;this.premultiplied?(n=f===0?0:n/f*(y-1),s=f===0?0:s/f*(y-1),c=f===0?0:c/f*(y-1)):(n*=y-1,s*=y-1,c*=y-1);let w=Math.floor(n),I=Math.floor(s),S=Math.floor(c),D=Math.ceil(n),P=Math.ceil(s),O=Math.ceil(c),F=n-w,B=s-I,H=c-S,X=e.image.data,Z=4*(w+I*x+S*y),K=4*(w+I*x+O*y),de=4*(w+P*x+S*y),ae=4*(w+P*x+O*y),ce=4*(D+I*x+S*y),ge=4*(D+I*x+O*y),ye=4*(D+P*x+S*y),ke=4*(D+P*x+O*y);if(Z<0||ke>=X.length)throw new Error("out of range");this.r=Ct(Ct(Ct(X[Z],X[K],H),Ct(X[de],X[ae],H),B),Ct(Ct(X[ce],X[ge],H),Ct(X[ye],X[ke],H),B),F)/255*(this.premultiplied?f:1),this.g=Ct(Ct(Ct(X[Z+1],X[K+1],H),Ct(X[de+1],X[ae+1],H),B),Ct(Ct(X[ce+1],X[ge+1],H),Ct(X[ye+1],X[ke+1],H),B),F)/255*(this.premultiplied?f:1),this.b=Ct(Ct(Ct(X[Z+2],X[K+2],H),Ct(X[de+2],X[ae+2],H),B),Ct(Ct(X[ce+2],X[ge+2],H),Ct(X[ye+2],X[ke+2],H),B),F)/255*(this.premultiplied?f:1),this.a=f}else this.r=n,this.g=s,this.b=c,this.a=f}toArray(){let{r:e,g:n,b:s,a:c}=this;return[255*e,255*n,255*s,c]}toHslaArray(){let{r:e,g:n,b:s,a:c}=this;if(this.premultiplied){if(c===0)return[0,0,0,0];e/=c,n/=c,s/=c}let f=Math.min(Math.max(e,0),1),p=Math.min(Math.max(n,0),1),y=Math.min(Math.max(s,0),1),x=Math.min(f,p,y),w=Math.max(f,p,y),I=(x+w)/2;if(x===w)return[0,0,100*I,c];let S=w-x,D=I>.5?S/(2-w-x):S/(w+x),P=0;return w===f?P=(p-y)/S+(p<y?6:0):w===p?P=(y-f)/S+2:w===y&&(P=(f-p)/S+4),P*=60,[Math.min(Math.max(P,0),360),Math.min(Math.max(100*D,0),100),Math.min(Math.max(100*I,0),100),c]}toArray01(){let{r:e,g:n,b:s,a:c}=this;return[e,n,s,c]}toArray01Scaled(e){let{r:n,g:s,b:c}=this;return[n*e,s*e,c*e]}toArray01Linear(){let{r:e,g:n,b:s,a:c}=this;return[Math.pow(e,2.2),Math.pow(n,2.2),Math.pow(s,2.2),c]}}class Xl extends Tu{constructor(e,n,s,c,f){super(e,n,s,c,f,!1)}}class V_ extends Tu{constructor(e,n,s,c,f){super(e,n,s,c,f,!0)}}function Ct(i,e,n){return i*(1-n)+e*n}function j_(i,e,n){return i.map((s,c)=>Ct(s,e[c],n))}Ln.black=new Ln(0,0,0,1),Ln.white=new Ln(1,1,1,1),Ln.transparent=new Ln(0,0,0,0),Ln.red=new Ln(1,0,0,1),Ln.blue=new Ln(0,0,1,1);var Iu=Object.freeze({__proto__:null,array:j_,color:function(i,e,n){return new Ln(Ct(i.r,e.r,n),Ct(i.g,e.g,n),Ct(i.b,e.b,n),Ct(i.a,e.a,n))},number:Ct});function rl(i,...e){for(let n of e)for(let s in n)i[s]=n[s];return i}class Do extends Error{constructor(e,n){super(n),this.message=n,this.key=e}}class bp{constructor(e,n=[]){this.parent=e,this.bindings={};for(let[s,c]of n)this.bindings[s]=c}concat(e){return new bp(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}let Yl={kind:"null"},It={kind:"number"},Pn={kind:"string"},On={kind:"boolean"},ho={kind:"color"},Us={kind:"object"},kn={kind:"value"},th={kind:"collator"},Su={kind:"formatted"},Du={kind:"resolvedImage"};function Pr(i,e){return{kind:"array",itemType:i,N:e}}function Ji(i){if(i.kind==="array"){let e=Ji(i.itemType);return typeof i.N=="number"?`array<${e}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${e}>`}return i.kind}let hb=[Yl,It,Pn,On,ho,Su,Us,Pr(kn),Du];function Kl(i,e){if(e.kind==="error")return null;if(i.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Kl(i.itemType,e.itemType))&&(typeof i.N!="number"||i.N===e.N))return null}else{if(i.kind===e.kind)return null;if(i.kind==="value"){for(let n of hb)if(!Kl(n,e))return null}}return`Expected ${Ji(i)} but found ${Ji(e)} instead.`}function ga(i,e){return e.some(n=>n.kind===i.kind)}function Cu(i,e){return e.some(n=>n==="null"?i===null:n==="array"?Array.isArray(i):n==="object"?i&&!Array.isArray(i)&&typeof i=="object":n===typeof i)}function nh(i,e){return i.kind==="array"&&e.kind==="array"?i.N===e.N&&nh(i.itemType,e.itemType):i.kind===e.kind}class Au{constructor(e,n,s){this.sensitivity=e?n?"variant":"case":n?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,n){return this.collator.compare(e,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ih{constructor(e,n,s,c,f){this.text=e.normalize?e.normalize():e,this.image=n,this.scale=s,this.fontStack=c,this.textColor=f}}class Br{constructor(e){this.sections=e}static fromString(e){return new Br([new ih(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Br?e:Br.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){let e=["format"];for(let n of this.sections){if(n.image){let c=n.image.getPrimary().id.toString();e.push(["image",c]);continue}e.push(n.text);let s={};n.fontStack&&(s["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(s["font-scale"]=n.scale),n.textColor&&(s["text-color"]=["rgba"].concat(n.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class Hs{constructor(e,n={}){if(this.id=uo.from(e),this.options=Object.assign({},n),n.transform){let{a:s,b:c,c:f,d:p,e:y,f:x}=n.transform;this.options.transform=new DOMMatrix([s,c,f,p,y,x])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:e,b:n,c:s,d:c,e:f,f:p}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:n,c:s,d:c,e:f,f:p}})}static parse(e){let n,s,c,f;try{({name:n,iconsetId:s,params:c,transform:f}=JSON.parse(e)||{})}catch{return null}if(!n)return null;let{a:p,b:y,c:x,d:w,e:I,f:S}=f||{};return new Hs({name:n,iconsetId:s},{params:c,transform:new DOMMatrix([p,y,x,w,I,S])})}scaleSelf(e,n){return this.options.transform.scaleSelf(e,n),this}}class to{constructor(e,n,s,c,f=!1){this.primaryId=uo.from(e),this.primaryOptions=n,s&&(this.secondaryId=uo.from(s)),this.secondaryOptions=c,this.available=f}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Hs(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Hs(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?to.build({name:e}):e}static build(e,n,s,c){return!e||typeof e=="object"&&!("name"in e)?null:new to(e,s,n,c)}}function ol(i,e,n,s){return typeof i=="number"&&i>=0&&i<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof n=="number"&&n>=0&&n<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[i,e,n,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[i,e,n,s]:[i,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Yt(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof Ln||i instanceof Au||i instanceof Br||i instanceof to)return!0;if(Array.isArray(i)){for(let e of i)if(!Yt(e))return!1;return!0}if(typeof i=="object"){for(let e in i)if(!Yt(i[e]))return!1;return!0}return!1}function pt(i){if(i===null)return Yl;if(typeof i=="string")return Pn;if(typeof i=="boolean")return On;if(typeof i=="number")return It;if(i instanceof Ln)return ho;if(i instanceof Au)return th;if(i instanceof Br)return Su;if(i instanceof to)return Du;if(Array.isArray(i)){let e=i.length,n;for(let s of i){let c=pt(s);if(n){if(n===c)continue;n=kn;break}n=c}return Pr(n||kn,e)}return Us}function Wo(i){let e=typeof i;return i===null?"":e==="string"||e==="number"||e==="boolean"?String(i):i instanceof Br||i instanceof to||i instanceof Ln?i.toString():JSON.stringify(i)}class Lt{constructor(e,n){this.type=e,this.value=n}static parse(e,n){if(e.length!==2)return n.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Yt(e[1]))return n.error("invalid value");let s=e[1],c=pt(s),f=n.expectedType;return c.kind!=="array"||c.N!==0||!f||f.kind!=="array"||typeof f.N=="number"&&f.N!==0||(c=f),new Lt(c,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ln?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Br?this.value.serialize():this.value}}class Xi{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}let Mu={string:Pn,number:It,boolean:On,object:Us};class At{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s,c=1,f=e[0];if(f==="array"){let y,x;if(e.length>2){let w=e[1];if(typeof w!="string"||!(w in Mu)||w==="object")return n.error('The item type argument of "array" must be one of string, number, boolean',1);y=Mu[w],c++}else y=kn;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return n.error('The length argument to "array" must be a positive integer literal',2);x=e[2],c++}s=Pr(y,x)}else s=Mu[f];let p=[];for(;c<e.length;c++){let y=n.parse(e[c],c,kn);if(!y)return null;p.push(y)}return new At(s,p)}evaluate(e){for(let n=0;n<this.args.length;n++){let s=this.args[n].evaluate(e);if(!Kl(this.type,pt(s)))return s;if(n===this.args.length-1)throw new Xi(`The expression ${JSON.stringify(this.args[n].serialize())} evaluated to ${Ji(pt(s))} but was expected to be of type ${Ji(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=this.type,n=[e.kind];if(e.kind==="array"){let s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){n.push(s.kind);let c=e.N;(typeof c=="number"||this.args.length>1)&&n.push(c)}}return n.concat(this.args.map(s=>s.serialize()))}}class Jl{constructor(e){this.type=Su,this.sections=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s=e[1];if(!Array.isArray(s)&&typeof s=="object")return n.error("First argument must be an image or text section.");let c=[],f=!1;for(let p=1;p<=e.length-1;++p){let y=e[p];if(f&&typeof y=="object"&&!Array.isArray(y)){f=!1;let x=null;if(y["font-scale"]&&(x=n.parseObjectValue(y["font-scale"],p,"font-scale",It),!x))return null;let w=null;if(y["text-font"]&&(w=n.parseObjectValue(y["text-font"],p,"text-font",Pr(Pn)),!w))return null;let I=null;if(y["text-color"]&&(I=n.parseObjectValue(y["text-color"],p,"text-color",ho),!I))return null;let S=c[c.length-1];S.scale=x,S.font=w,S.textColor=I}else{let x=n.parse(e[p],p,kn);if(!x)return null;let w=x.type.kind;if(w!=="string"&&w!=="value"&&w!=="null"&&w!=="resolvedImage")return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");f=!0,c.push({content:x,scale:null,font:null,textColor:null})}}return new Jl(c)}evaluate(e){return new Br(this.sections.map(n=>{let s=n.content.evaluate(e);return nh(pt(s),Du)?new ih("",s,null,null,null):new ih(Wo(s),null,n.scale?n.scale.evaluate(e):null,n.font?n.font.evaluate(e).join(","):null,n.textColor?n.textColor.evaluate(e):null)}))}eachChild(e){for(let n of this.sections)e(n.content),n.scale&&e(n.scale),n.font&&e(n.font),n.textColor&&e(n.textColor)}outputDefined(){return!1}serialize(){let e=["format"];for(let n of this.sections){e.push(n.content.serialize());let s={};n.scale&&(s["font-scale"]=n.scale.serialize()),n.font&&(s["text-font"]=n.font.serialize()),n.textColor&&(s["text-color"]=n.textColor.serialize()),e.push(s)}return e}}class Ql{constructor(e,n,s,c){this._imageWarnHistory={},this.type=Du,this.namePrimary=e,this.nameSecondary=n,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),c&&(this.paramsSecondary=c.params,this.iconsetIdSecondary=c.iconset?c.iconset.id:void 0)}static parse(e,n){if(e.length<2)return n.error("Expected two or more arguments.");let s=1,c=[];function f(){if(s<e.length){let y=n.parse(e[s],s++,Pn);return y?(c.push({image:y,options:{}}),!0):(n.error(c.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function p(){if(s<e.length){let x=e[s];if((y=x)===null||typeof y!="object"||Array.isArray(y))return!0;let w=x.params,I=x.iconset,S=n.concat(s);if(!w&&!I)return s++,!0;if(w){if(typeof w!="object"||w.constructor!==Object)return S.error('Image options "params" should be an object'),!1;let D={},P=S.concat(void 0,"params");for(let O in w){if(!O)return P.error("Image parameter name should be non-empty"),!1;let F=P.concat(void 0,O).parse(w[O],void 0,ho,void 0,{typeAnnotation:"coerce"});if(!F)return!1;D[O]=F}c[c.length-1].options.params=D}if(I){if(typeof I!="object"||I.constructor!==Object)return S.error('Image options "iconset" should be an object'),!1;if(!I.id)return S.error('Image options "iconset" should have an "id" property'),!1;c[c.length-1].options.iconset=I}return s++,!0}var y;return!0}for(let y=0;y<2;y++)if(!f()||!p())return;return new Ql(c[0].image,c[1]?c[1].image:void 0,c[0].options,c[1]?c[1].options:void 0)}evaluateParams(e,n){let s={};if(n){for(let c in n)if(n[c])try{s[c]=n[c].evaluate(e)}catch{continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){let n={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,c=to.build(n,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(c&&e.availableImages){let f=c.getPrimary().id;if(c.available=e.availableImages.some(p=>uo.isEqual(p,f)),c.available){let p=c.getSecondary()?c.getSecondary().id:null;p&&(c.available=e.availableImages.some(y=>uo.isEqual(y,p)))}}return c}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(let n in this.paramsPrimary)this.paramsPrimary[n]&&e(this.paramsPrimary[n]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(let n in this.paramsSecondary)this.paramsSecondary[n]&&e(this.paramsSecondary[n])}outputDefined(){return!1}serializeOptions(e,n){let s={};if(n&&(s.iconset={id:n}),e){s.params={};for(let c in e)e[c]&&(s.params[c]=e[c].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){let e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let n=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);n&&e.push(n)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let n=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);n&&e.push(n)}return e}}function _a(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}let U_={"to-boolean":On,"to-color":ho,"to-number":It,"to-string":Pn};class Zo{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s=e[0],c=[],f=Yl;if(s==="to-array"){if(!Array.isArray(e[1]))return null;let p=e[1].length;if(n.expectedType){if(n.expectedType.kind!=="array")return n.error(`Expected ${n.expectedType.kind} but found array.`);f=Pr(n.expectedType.itemType,p)}else{if(!(p>0&&Yt(e[1][0])))return null;f=Pr(pt(e[1][0]),p)}for(let y=0;y<p;y++){let x=e[1][y],w;if(_a(x)==="array")w=n.parse(x,void 0,f.itemType);else{let I=_a(x);if(I!==f.itemType.kind)return n.error(`Expected ${f.itemType.kind} but found ${I}.`);w=n.registry.literal.parse(["literal",x===void 0?null:x],n)}if(!w)return null;c.push(w)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return n.error("Expected one argument.");f=U_[s];for(let p=1;p<e.length;p++){let y=n.parse(e[p],p,kn);if(!y)return null;c.push(y)}}return new Zo(f,c)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let n,s;for(let c of this.args){if(n=c.evaluate(e),s=null,n instanceof Ln)return n;if(typeof n=="string"){let f=e.parseColor(n);if(f)return f}else if(Array.isArray(n)&&(s=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:ol(n[0],n[1],n[2],n[3]),!s))return new Ln(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Xi(s||`Could not parse color from value '${typeof n=="string"?n:String(JSON.stringify(n))}'`)}if(this.type.kind==="number"){let n=null;for(let s of this.args){if(n=s.evaluate(e),n===null)return 0;let c=Number(n);if(!isNaN(c))return c}throw new Xi(`Could not convert ${JSON.stringify(n)} to number.`)}return this.type.kind==="formatted"?Br.fromString(Wo(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?to.build(Wo(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(n=>n.evaluate(e)):Wo(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Jl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Ql(this.args[0]).serialize();let e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{e.push(n.serialize())}),e}}let Vr=["Unknown","Point","LineString","Polygon"];class Ru{constructor(e,n){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=n}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Vr[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let e=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:s,y:c}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*n-e[0])+this.featureDistanceData.bearing[1]*(c*n-e[1])}return 0}parseColor(e){let n=this._parseColorCache[e];return n||(n=this._parseColorCache[e]=Ln.parse(e)),n}getConfig(e){return this.options?this.options.get(e):null}}class fr{constructor(e,n,s,c,f){this.name=e,this.type=n,this._evaluate=s,this.args=c,this._overloadIndex=f}evaluate(e){if(!this._evaluate){let n=fr.definitions[this.name];this._evaluate=Array.isArray(n)?n[2]:n.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,n){let s=e[0],c=fr.definitions[s];if(!c)return n.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);let f=Array.isArray(c)?c[0]:c.type,p=Array.isArray(c)?[[c[1],c[2]]]:c.overloads,y=[],x=null,w=-1;for(let[I,S]of p){if(Array.isArray(I)&&I.length!==e.length-1)continue;y.push(I),w++,x=new gh(n.registry,n.path,null,n.scope,void 0,n._scope,n.options);let D=[],P=!1;for(let O=1;O<e.length;O++){let F=e[O],B=Array.isArray(I)?I[O-1]:I.type,H=x.parse(F,1+D.length,B);if(!H){P=!0;break}D.push(H)}if(!P)if(Array.isArray(I)&&I.length!==D.length)x.error(`Expected ${I.length} arguments, but found ${D.length} instead.`);else{for(let O=0;O<D.length;O++){let F=Array.isArray(I)?I[O]:I.type,B=D[O];x.concat(O+1).checkSubtype(F,B.type)}if(x.errors.length===0)return new fr(s,f,S,D,w)}}if(y.length===1)n.errors.push(...x.errors);else{let I=(y.length?y:p.map(([D])=>D)).map(wp).join(" | "),S=[];for(let D=1;D<e.length;D++){let P=n.parse(e[D],1+S.length);if(!P)return null;S.push(Ji(P.type))}n.error(`Expected arguments of type ${I}, but found (${S.join(", ")}) instead.`)}return null}static register(e,n){fr.definitions=n;for(let s in n)e[s]=fr}}function wp(i){return Array.isArray(i)?`(${i.map(Ji).join(", ")})`:`(${Ji(i.type)}...)`}class xs{constructor(e,n,s){this.type=th,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=n}static parse(e,n){if(e.length!==2)return n.error("Expected one argument.");let s=e[1];if(typeof s!="object"||Array.isArray(s))return n.error("Collator options argument must be an object.");let c=s["case-sensitive"]===void 0?n.parse(!1,1,On):n.parseObjectValue(s["case-sensitive"],1,"case-sensitive",On);if(!c)return null;let f=s["diacritic-sensitive"]===void 0?n.parse(!1,1,On):n.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",On);if(!f)return null;let p=null;return s.locale&&(p=n.parseObjectValue(s.locale,1,"locale",Pn),!p)?null:new xs(c,f,p)}evaluate(e){return new Au(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){let e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Or(i,e,n=0,s=i.length-1,c=fb){for(;s>n;){if(s-n>600){let x=s-n+1,w=e-n+1,I=Math.log(x),S=.5*Math.exp(2*I/3),D=.5*Math.sqrt(I*S*(x-S)/x)*(w-x/2<0?-1:1);Or(i,e,Math.max(n,Math.floor(e-w*S/x+D)),Math.min(s,Math.floor(e+(x-w)*S/x+D)),c)}let f=i[e],p=n,y=s;for(Pu(i,n,e),c(i[s],f)>0&&Pu(i,n,s);p<y;){for(Pu(i,p,y),p++,y--;c(i[p],f)<0;)p++;for(;c(i[y],f)>0;)y--}c(i[n],f)===0?Pu(i,n,y):(y++,Pu(i,y,s)),y<=e&&(n=y+1),e<=y&&(s=y-1)}}function Pu(i,e,n){let s=i[e];i[e]=i[n],i[n]=s}function fb(i,e){return i<e?-1:i>e?1:0}function pb(i){let e=0;for(let n,s,c=0,f=i.length,p=f-1;c<f;p=c++)n=i[c],s=i[p],e+=(s.x-n.x)*(n.y+s.y);return e}function ya(i,e){i[0]=Math.min(i[0],e[0]),i[1]=Math.min(i[1],e[1]),i[2]=Math.max(i[2],e[0]),i[3]=Math.max(i[3],e[1])}function ec(i,e){return!(i[0]<=e[0]||i[2]>=e[2]||i[1]<=e[1]||i[3]>=e[3])}function sl(i,e,n){let s=i[0]-e[0],c=i[1]-e[1],f=i[0]-n[0],p=i[1]-n[1];return s*p-f*c==0&&s*f<=0&&c*p<=0}function tc(i,e,n=!1){let s=!1;for(let y=0,x=e.length;y<x;y++){let w=e[y];for(let I=0,S=w.length,D=S-1;I<S;D=I++){let P=w[D],O=w[I];if(sl(i,P,O))return n;(f=P)[1]>(c=i)[1]!=(p=O)[1]>c[1]&&c[0]<(p[0]-f[0])*(c[1]-f[1])/(p[1]-f[1])+f[0]&&(s=!s)}}var c,f,p;return s}function H_(i,e,n,s){let c=s[0]-n[0],f=s[1]-n[1],p=(i[0]-n[0])*f-c*(i[1]-n[1]),y=(e[0]-n[0])*f-c*(e[1]-n[1]);return p>0&&y<0||p<0&&y>0}function rh(i,e,n,s){return(c=[s[0]-n[0],s[1]-n[1]])[0]*(f=[e[0]-i[0],e[1]-i[1]])[1]-c[1]*f[0]!=0&&!(!H_(i,e,n,s)||!H_(n,s,i,e));var c,f}function Ep(i){let e=new Xe(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=new Xe(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let s of i[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),n.x<s.x&&(n.x=s.x),n.y<s.y&&(n.y=s.y);return{min:e,max:n}}let va=8192;function mb(i,e){let n=(180+i[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,c=Math.pow(2,e.z);return[Math.round(n*c*va),Math.round(s*c*va)]}function $_(i,e){for(let n=0;n<e.length;n++)if(tc(i,e[n]))return!0;return!1}function gb(i,e,n){for(let s of n)for(let c=0,f=s.length,p=f-1;c<f;p=c++)if(rh(i,e,s[p],s[c]))return!0;return!1}function G_(i,e){for(let n=0;n<i.length;++n)if(!tc(i[n],e))return!1;for(let n=0;n<i.length-1;++n)if(gb(i[n],i[n+1],e))return!1;return!0}function q_(i,e){for(let n=0;n<e.length;n++)if(G_(i,e[n]))return!0;return!1}function Tp(i,e,n){let s=[];for(let c=0;c<i.length;c++){let f=[];for(let p=0;p<i[c].length;p++){let y=mb(i[c][p],n);ya(e,y),f.push(y)}s.push(f)}return s}function xa(i,e,n){let s=[];for(let c=0;c<i.length;c++){let f=Tp(i[c],e,n);s.push(f)}return s}function W_(i,e,n,s){if(i[0]<n[0]||i[0]>n[2]){let c=.5*s,f=i[0]-n[0]>c?-s:n[0]-i[0]>c?s:0;f===0&&(f=i[0]-n[2]>c?-s:n[2]-i[0]>c?s:0),i[0]+=f}ya(e,i)}function Z_(i,e,n,s){let c=Math.pow(2,s.z)*va,f=[s.x*va,s.y*va],p=[];if(!i)return p;for(let y of i)for(let x of y){let w=[x.x+f[0],x.y+f[1]];W_(w,e,n,c),p.push(w)}return p}function oh(i,e,n,s){let c=Math.pow(2,s.z)*va,f=[s.x*va,s.y*va],p=[];if(!i)return p;for(let x of i){let w=[];for(let I of x){let S=[I.x+f[0],I.y+f[1]];ya(e,S),w.push(S)}p.push(w)}if(e[2]-e[0]<=c/2){(y=e)[0]=y[1]=1/0,y[2]=y[3]=-1/0;for(let x of p)for(let w of x)W_(w,e,n,c)}var y;return p}class ba{constructor(e,n){this.type=On,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Yt(e[1])){let s=e[1];if(s.type==="FeatureCollection")for(let c=0;c<s.features.length;++c){let f=s.features[c].geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new ba(s,s.features[c].geometry)}else if(s.type==="Feature"){let c=s.geometry.type;if(c==="Polygon"||c==="MultiPolygon")return new ba(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new ba(s,s)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(n,s){let c=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(!p)return!1;if(s.type==="Polygon"){let y=Tp(s.coordinates,f,p),x=Z_(n.geometry(),c,f,p);if(!ec(c,f))return!1;for(let w of x)if(!tc(w,y))return!1}if(s.type==="MultiPolygon"){let y=xa(s.coordinates,f,p),x=Z_(n.geometry(),c,f,p);if(!ec(c,f))return!1;for(let w of x)if(!$_(w,y))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(n,s){let c=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(!p)return!1;if(s.type==="Polygon"){let y=Tp(s.coordinates,f,p),x=oh(n.geometry(),c,f,p);if(!ec(c,f))return!1;for(let w of x)if(!G_(w,y))return!1}if(s.type==="MultiPolygon"){let y=xa(s.coordinates,f,p),x=oh(n.geometry(),c,f,p);if(!ec(c,f))return!1;for(let w of x)if(!q_(w,y))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let Ou={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Xo=1/298.257223563,Ip=Xo*(2-Xo),nc=Math.PI/180;class ic{static fromTile(e,n,s){let c=Math.PI*(1-2*(e+.5)/Math.pow(2,n)),f=Math.atan(.5*(Math.exp(c)-Math.exp(-c)))/nc;return new ic(f,s)}static get units(){return Ou}constructor(e,n){if(e===void 0)throw new Error("No latitude given.");if(n&&!Ou[n])throw new Error(`Unknown unit ${n}. Use one of: ${Object.keys(Ou).join(", ")}`);let s=6378.137*nc*(n?Ou[n]:1),c=Math.cos(e*nc),f=1/(1-Ip*(1-c*c)),p=Math.sqrt(f);this.kx=s*p*c,this.ky=s*p*f*(1-Ip)}distance(e,n){let s=Co(e[0]-n[0])*this.kx,c=(e[1]-n[1])*this.ky;return Math.sqrt(s*s+c*c)}bearing(e,n){let s=Co(n[0]-e[0])*this.kx;return Math.atan2(s,(n[1]-e[1])*this.ky)/nc}destination(e,n,s){let c=s*nc;return this.offset(e,Math.sin(c)*n,Math.cos(c)*n)}offset(e,n,s){return[e[0]+n/this.kx,e[1]+s/this.ky]}lineDistance(e){let n=0;for(let s=0;s<e.length-1;s++)n+=this.distance(e[s],e[s+1]);return n}area(e){let n=0;for(let s=0;s<e.length;s++){let c=e[s];for(let f=0,p=c.length,y=p-1;f<p;y=f++)n+=Co(c[f][0]-c[y][0])*(c[f][1]+c[y][1])*(s?-1:1)}return Math.abs(n)/2*this.kx*this.ky}along(e,n){let s=0;if(n<=0)return e[0];for(let c=0;c<e.length-1;c++){let f=e[c],p=e[c+1],y=this.distance(f,p);if(s+=y,s>n)return sh(f,p,(n-(s-y))/y)}return e[e.length-1]}pointToSegmentDistance(e,n,s){let[c,f]=n,p=Co(s[0]-c)*this.kx,y=(s[1]-f)*this.ky;if(p!==0||y!==0){let x=(Co(e[0]-c)*this.kx*p+(e[1]-f)*this.ky*y)/(p*p+y*y);x>1?(c=s[0],f=s[1]):x>0&&(c+=p/this.kx*x,f+=y/this.ky*x)}return p=Co(e[0]-c)*this.kx,y=(e[1]-f)*this.ky,Math.sqrt(p*p+y*y)}pointOnLine(e,n){let s=1/0,c=e[0][0],f=e[0][1],p=0,y=0;for(let x=0;x<e.length-1;x++){let w=e[x][0],I=e[x][1],S=Co(e[x+1][0]-w)*this.kx,D=(e[x+1][1]-I)*this.ky,P=0;S===0&&D===0||(P=(Co(n[0]-w)*this.kx*S+(n[1]-I)*this.ky*D)/(S*S+D*D),P>1?(w=e[x+1][0],I=e[x+1][1]):P>0&&(w+=S/this.kx*P,I+=D/this.ky*P)),S=Co(n[0]-w)*this.kx,D=(n[1]-I)*this.ky;let O=S*S+D*D;O<s&&(s=O,c=w,f=I,p=x,y=P)}return{point:[c,f],index:p,t:Math.max(0,Math.min(1,y))}}lineSlice(e,n,s){let c=this.pointOnLine(s,e),f=this.pointOnLine(s,n);if(c.index>f.index||c.index===f.index&&c.t>f.t){let w=c;c=f,f=w}let p=[c.point],y=c.index+1,x=f.index;!Sp(s[y],p[0])&&y<=x&&p.push(s[y]);for(let w=y+1;w<=x;w++)p.push(s[w]);return Sp(s[x],f.point)||p.push(f.point),p}lineSliceAlong(e,n,s){let c=0,f=[];for(let p=0;p<s.length-1;p++){let y=s[p],x=s[p+1],w=this.distance(y,x);if(c+=w,c>e&&f.length===0&&f.push(sh(y,x,(e-(c-w))/w)),c>=n)return f.push(sh(y,x,(n-(c-w))/w)),f;c>e&&f.push(x)}return f}bufferPoint(e,n){let s=n/this.ky,c=n/this.kx;return[e[0]-c,e[1]-s,e[0]+c,e[1]+s]}bufferBBox(e,n){let s=n/this.ky,c=n/this.kx;return[e[0]-c,e[1]-s,e[2]+c,e[3]+s]}insideBBox(e,n){return Co(e[0]-n[0])>=0&&Co(e[0]-n[2])<=0&&e[1]>=n[1]&&e[1]<=n[3]}}function Sp(i,e){return i[0]===e[0]&&i[1]===e[1]}function sh(i,e,n){let s=Co(e[0]-i[0]);return[i[0]+s*n,i[1]+(e[1]-i[1])*n]}function Co(i){for(;i<-180;)i+=360;for(;i>180;)i-=360;return i}class ah{constructor(e=[],n=(s,c)=>s<c?-1:s>c?1:0){if(this.data=e,this.length=this.data.length,this.compare=n,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;let e=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),e}peek(){return this.data[0]}_up(e){let{data:n,compare:s}=this,c=n[e];for(;e>0;){let f=e-1>>1,p=n[f];if(s(c,p)>=0)break;n[e]=p,e=f}n[e]=c}_down(e){let{data:n,compare:s}=this,c=this.length>>1,f=n[e];for(;e<c;){let p=1+(e<<1),y=p+1;if(y<this.length&&s(n[y],n[p])<0&&(p=y),s(n[p],f)>=0)break;n[e]=n[p],e=p}n[e]=f}}var st=8192;function Dp(i,e){return e.dist-i.dist}let lh=100,ch=50;function Lu(i){let e=[1/0,1/0,-1/0,-1/0];if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==i[n])return!1;return!0}function al(i){return i[1]-i[0]+1}function Yo(i,e){let n=i[1]>=i[0]&&i[1]<e;return n||console.warn("Distance Expression: Index is out of range"),n}function uh(i,e){if(i[0]>i[1])return[null,null];let n=al(i);if(e){if(n===2)return[i,null];let s=Math.floor(n/2);return[[i[0],i[0]+s],[i[0]+s,i[1]]]}{if(n===1)return[i,null];let s=Math.floor(n/2)-1;return[[i[0],i[0]+s],[i[0]+s+1,i[1]]]}}function wa(i,e){let n=[1/0,1/0,-1/0,-1/0];if(!Yo(e,i.length))return n;for(let s=e[0];s<=e[1];++s)ya(n,i[s]);return n}function ku(i){let e=[1/0,1/0,-1/0,-1/0];for(let n=0;n<i.length;++n)for(let s=0;s<i[n].length;++s)ya(e,i[n][s]);return e}function ss(i,e,n){if(Lu(i)||Lu(e))return NaN;let s=0,c=0;return i[2]<e[0]&&(s=e[0]-i[2]),i[0]>e[2]&&(s=i[0]-e[2]),i[1]>e[3]&&(c=i[1]-e[3]),i[3]<e[1]&&(c=e[1]-i[3]),n.distance([0,0],[s,c])}function mn(i){return 360*i-180}function _b(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}function Cp(i,e){let n=Math.pow(2,e.z),s=(i.y/st+e.y)/n;return[mn((i.x/st+e.x)/n),_b(s)]}function yb(i,e){let n=[];for(let s=0;s<i.length;++s)n.push(Cp(i[s],e));return n}function Ap(i,e,n){let s=n.pointOnLine(e,i).point;return n.distance(i,s)}function X_(i,e,n,s,c){let f=n.slice(s[0],s[1]+1),p=1/0;for(let y=e[0];y<=e[1];++y)if((p=Math.min(p,Ap(i[y],f,c)))===0)return 0;return p}function fi(i,e,n,s,c){let f=Math.min(c.pointToSegmentDistance(i,n,s),c.pointToSegmentDistance(e,n,s)),p=Math.min(c.pointToSegmentDistance(n,i,e),c.pointToSegmentDistance(s,i,e));return Math.min(f,p)}function vb(i,e,n,s,c){if(!Yo(e,i.length)||!Yo(s,n.length))return NaN;let f=1/0;for(let p=e[0];p<e[1];++p)for(let y=s[0];y<s[1];++y){if(rh(i[p],i[p+1],n[y],n[y+1]))return 0;f=Math.min(f,fi(i[p],i[p+1],n[y],n[y+1],c))}return f}function xb(i,e,n,s,c){if(!Yo(e,i.length)||!Yo(s,n.length))return NaN;let f=1/0;for(let p=e[0];p<=e[1];++p)for(let y=s[0];y<=s[1];++y)if((f=Math.min(f,c.distance(i[p],n[y])))===0)return f;return f}function bb(i,e,n){if(tc(i,e,!0))return 0;let s=1/0;for(let c of e){let f=c.length;if(f<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(c[0]!==c[f-1]&&(s=Math.min(s,n.pointToSegmentDistance(i,c[f-1],c[0])))===0||(s=Math.min(s,Ap(i,c,n)))===0)return s}return s}function wb(i,e,n,s){if(!Yo(e,i.length))return NaN;for(let f=e[0];f<=e[1];++f)if(tc(i[f],n,!0))return 0;let c=1/0;for(let f=e[0];f<e[1];++f)for(let p of n)for(let y=0,x=p.length,w=x-1;y<x;w=y++){if(rh(i[f],i[f+1],p[w],p[y]))return 0;c=Math.min(c,fi(i[f],i[f+1],p[w],p[y],s))}return c}function Y_(i,e){for(let n of i)for(let s=0;s<=n.length-1;++s)if(tc(n[s],e,!0))return!0;return!1}function Eb(i,e,n,s=1/0){let c=ku(i),f=ku(e);if(s!==1/0&&ss(c,f,n)>=s)return s;if(ec(c,f)){if(Y_(i,e))return 0}else if(Y_(e,i))return 0;let p=s;for(let y of i)for(let x=0,w=y.length,I=w-1;x<w;I=x++)for(let S of e)for(let D=0,P=S.length,O=P-1;D<P;O=D++){if(rh(y[I],y[x],S[O],S[D]))return 0;p=Math.min(p,fi(y[I],y[x],S[O],S[D],n))}return p}function dh(i,e,n,s,c,f,p){if(f===null||p===null)return;let y=ss(wa(s,f),wa(c,p),n);y<e&&i.push({dist:y,range1:f,range2:p})}function Tb(i,e,n,s,c=1/0){let f=Math.min(s.distance(i[0],n[0][0]),c);if(f===0)return f;let p=new ah([{dist:0,range1:[0,i.length-1],range2:[0,0]}],Dp),y=e?ch:lh,x=ku(n);for(;p.length;){let w=p.pop();if(w.dist>=f)continue;let I=w.range1;if(al(I)<=y){if(!Yo(I,i.length))return NaN;if(e){let S=wb(i,I,n,s);if((f=Math.min(f,S))===0)return f}else for(let S=I[0];S<=I[1];++S){let D=bb(i[S],n,s);if((f=Math.min(f,D))===0)return f}}else{let S=uh(I,e);if(S[0]!==null){let D=ss(wa(i,S[0]),x,s);D<f&&p.push({dist:D,range1:S[0],range2:[0,0]})}if(S[1]!==null){let D=ss(wa(i,S[1]),x,s);D<f&&p.push({dist:D,range1:S[1],range2:[0,0]})}}}return f}function K_(i,e,n,s,c,f=1/0){let p=Math.min(f,c.distance(i[0],n[0]));if(p===0)return p;let y=new ah([{dist:0,range1:[0,i.length-1],range2:[0,n.length-1]}],Dp),x=e?ch:lh,w=s?ch:lh;for(;y.length;){let I=y.pop();if(I.dist>=p)continue;let S=I.range1,D=I.range2;if(al(S)<=x&&al(D)<=w){if(!Yo(S,i.length)||!Yo(D,n.length))return NaN;if(e&&s?p=Math.min(p,vb(i,S,n,D,c)):e||s?e&&!s?p=Math.min(p,X_(n,D,i,S,c)):!e&&s&&(p=Math.min(p,X_(i,S,n,D,c))):p=Math.min(p,xb(i,S,n,D,c)),p===0)return p}else{let P=uh(S,e),O=uh(D,s);dh(y,p,c,i,n,P[0],O[0]),dh(y,p,c,i,n,P[0],O[1]),dh(y,p,c,i,n,P[1],O[0]),dh(y,p,c,i,n,P[1],O[1])}}return p}function Mp(i,e,n,s,c=1/0){let f=c,p=wa(i,[0,i.length-1]);for(let y of n)if(!(f!==1/0&&ss(p,wa(y,[0,y.length-1]),s)>=f)&&(f=Math.min(f,K_(i,e,y,!0,s,f)),f===0))return f;return f}function hh(i,e,n,s,c=1/0){let f=c,p=wa(i,[0,i.length-1]);for(let y of n){if(f!==1/0&&ss(p,ku(y),s)>=f)continue;let x=Tb(i,e,y,s,f);if(isNaN(x))return x;if((f=Math.min(f,x))===0)return f}return f}function Rp(i){return i==="Point"||i==="MultiPoint"||i==="LineString"||i==="MultiLineString"||i==="Polygon"||i==="MultiPolygon"}class ll{constructor(e,n){this.type=It,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(Yt(e[1])){let s=e[1];if(s.type==="FeatureCollection"){for(let c=0;c<s.features.length;++c)if(Rp(s.features[c].geometry.type))return new ll(s,s.features[c].geometry)}else if(s.type==="Feature"){if(Rp(s.geometry.type))return new ll(s,s.geometry)}else if(Rp(s.type))return new ll(s,s)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){let n=e.geometry(),s=e.canonicalID();if(n!=null&&s!=null){if(e.geometryType()==="Point")return function(c,f,p){let y=[];for(let w of c)for(let I of w)y.push(Cp(I,f));let x=new ic(y[0][1],"meters");return p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString"?K_(y,!1,p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",x):p.type==="MultiLineString"?Mp(y,!1,p.coordinates,x):p.type==="Polygon"||p.type==="MultiPolygon"?hh(y,!1,p.type==="Polygon"?[p.coordinates]:p.coordinates,x):null}(n,s,this.geometries);if(e.geometryType()==="LineString")return function(c,f,p){let y=[];for(let w of c){let I=[];for(let S of w)I.push(Cp(S,f));y.push(I)}let x=new ic(y[0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return Mp(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,x);if(p.type==="MultiLineString"){let w=1/0;for(let I=0;I<p.coordinates.length;I++){let S=Mp(p.coordinates[I],!0,y,x,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}if(p.type==="Polygon"||p.type==="MultiPolygon"){let w=1/0;for(let I=0;I<y.length;I++){let S=hh(y[I],!0,p.type==="Polygon"?[p.coordinates]:p.coordinates,x,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}return null}(n,s,this.geometries);if(e.geometryType()==="Polygon")return function(c,f,p){let y=[];for(let w of function(I,S){let D=I.length;if(D<=1)return[I];let P=[],O,F;for(let B=0;B<D;B++){let H=pb(I[B]);H!==0&&(I[B].area=Math.abs(H),F===void 0&&(F=H<0),F===H<0?(O&&P.push(O),O=[I[B]]):O.push(I[B]))}return O&&P.push(O),P}(c)){let I=[];for(let S=0;S<w.length;++S)I.push(yb(w[S],f));y.push(I)}let x=new ic(y[0][0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return hh(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,x);if(p.type==="MultiLineString"){let w=1/0;for(let I=0;I<p.coordinates.length;I++){let S=hh(p.coordinates[I],!0,y,x,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}return p.type==="Polygon"||p.type==="MultiPolygon"?function(w,I,S){let D=1/0;for(let P of w)for(let O of I){let F=Eb(P,O,S,D);if(isNaN(F))return F;if((D=Math.min(D,F))===0)return D}return D}(p.type==="Polygon"?[p.coordinates]:p.coordinates,y,x):null}(n,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function rc(i){if(i instanceof fr&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof ba||i instanceof ll)return!1;if(i instanceof sc)return i.featureConstant;let e=!0;return i.eachChild(n=>{e&&!rc(n)&&(e=!1)}),e}function fh(i){if(i instanceof fr&&i.name==="feature-state")return!1;let e=!0;return i.eachChild(n=>{e&&!fh(n)&&(e=!1)}),e}function ph(i){if(i instanceof sc)return new Set([i.key]);let e=new Set;return i.eachChild(n=>{e=new Set([...e,...ph(n)])}),e}function oc(i,e){if(i instanceof fr&&e.indexOf(i.name)>=0)return!1;let n=!0;return i.eachChild(s=>{n&&!oc(s,e)&&(n=!1)}),n}function J_(i,e,n){return[i,e,n].filter(Boolean).join("")}function Pp(i,e){switch(i){case"string":return Wo(e);case"number":return+e;case"boolean":return!!e;case"color":return Ln.parse(e);case"formatted":return Br.fromString(Wo(e));case"resolvedImage":return to.build(Wo(e))}return e}function Q_(i,e,n,s){return s!==void 0&&(i=s*Math.round(i/s)),e!==void 0&&i<e&&(i=e),n!==void 0&&i>n&&(i=n),i}class sc{constructor(e,n,s,c=!1){this.type=e,this.key=n,this.scope=s,this.featureConstant=c}static parse(e,n){let s=n.expectedType;if(s==null&&(s=kn),e.length<2||e.length>3)return n.error("Invalid number of arguments for 'config' expression.");let c=n.parse(e[1],1);if(!(c instanceof Lt))return n.error("Key name of 'config' expression must be a string literal.");let f,p=!0,y=Wo(c.value);if(e.length>=3){let x=n.parse(e[2],2);if(!(x instanceof Lt))return n.error("Scope of 'config' expression must be a string literal.");f=Wo(x.value)}if(n.options){let x=J_(y,f,n._scope),w=n.options.get(x);w&&(p=rc(w.value||w.default))}return new sc(s,y,f,p)}evaluate(e){let n=J_(this.key,this.scope,e.scope),s=e.getConfig(n);if(!s)return null;let{type:c,value:f,values:p,minValue:y,maxValue:x,stepValue:w}=s,I=s.default.evaluate(e),S=I;if(f){let D=e.scope;e.scope=(D||"").split("").slice(1).join(""),S=f.evaluate(e),e.scope=D}return c&&(S=Pp(c,S)),S===void 0||y===void 0&&x===void 0&&w===void 0||(typeof S=="number"?S=Q_(S,y,x,w):Array.isArray(S)&&(S=S.map(D=>typeof D=="number"?Q_(D,y,x,w):D))),f!==void 0&&S!==void 0&&p&&!p.includes(S)&&(S=I,c&&(S=Pp(c,S))),(c&&c!==this.type||S!==void 0&&!nh(pt(S),this.type))&&(S=Pp(this.type.kind,S)),S}eachChild(){}outputDefined(){return!1}serialize(){let e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class mh{constructor(e,n){this.type=n.type,this.name=e,this.boundExpression=n}static parse(e,n){if(e.length!==2||typeof e[1]!="string")return n.error("'var' expression requires exactly one string literal argument.");let s=e[1];return n.scope.has(s)?new mh(s,n.scope.get(s)):n.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class gh{constructor(e,n=[],s,c=new bp,f=[],p,y){this.registry=e,this.path=n,this.key=n.map(x=>typeof x=="string"?`['${x}']`:`[${x}]`).join(""),this.scope=c,this.errors=f,this.expectedType=s,this._scope=p,this.options=y}parse(e,n,s,c,f={}){return n||s?this.concat(n,null,s,c)._parse(e,f):this._parse(e,f)}parseObjectValue(e,n,s,c,f,p={}){return this.concat(n,s,c,f)._parse(e,p)}_parse(e,n){function s(c,f,p){return p==="assert"?new At(f,[c]):p==="coerce"?new Zo(f,[c]):c}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let c=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(c){let f=c.parse(e,this);if(!f)return null;if(this.expectedType){let p=this.expectedType,y=f.type;if(p.kind!=="string"&&p.kind!=="number"&&p.kind!=="boolean"&&p.kind!=="object"&&p.kind!=="array"||y.kind!=="value")if(p.kind!=="color"&&p.kind!=="formatted"&&p.kind!=="resolvedImage"||y.kind!=="value"&&y.kind!=="string"){if(this.checkSubtype(p,y))return null}else f=s(f,p,n.typeAnnotation||"coerce");else f=s(f,p,n.typeAnnotation||"assert")}if(!(f instanceof Lt)&&f.type.kind!=="resolvedImage"&&Op(f)){let p=new Ru(this._scope,this.options);try{f=new Lt(f.type,f.evaluate(p))}catch(y){return this.error(y.message),null}}return f}return Zo.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,n,s,c){let f=typeof e=="number"?this.path.concat(e):this.path;f=typeof n=="string"?f.concat(n):f;let p=c?this.scope.concat(c):this.scope;return new gh(this.registry,f,s||null,p,this.errors,this._scope,this.options)}error(e,...n){let s=`${this.key}${n.map(c=>`[${c}]`).join("")}`;this.errors.push(new Do(s,e))}checkSubtype(e,n){let s=Kl(e,n);return s&&this.error(s),s}}function Op(i){if(i instanceof mh)return Op(i.boundExpression);if(i instanceof fr&&i.name==="error"||i instanceof xs||i instanceof ba||i instanceof ll||i instanceof sc)return!1;let e=i instanceof Zo||i instanceof At,n=!0;return i.eachChild(s=>{n=e?n&&Op(s):n&&s instanceof Lt}),!!n&&rc(i)&&oc(i,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function _h(i,e){let n=i.length-1,s,c,f=0,p=n,y=0;for(;f<=p;)if(y=Math.floor((f+p)/2),s=i[y],c=i[y+1],s<=e){if(y===n||e<c)return y;f=y+1}else{if(!(s>e))throw new Xi("Input is not a number.");p=y-1}return 0}class Fu{constructor(e,n,s){this.type=e,this.input=n,this.labels=[],this.outputs=[];for(let[c,f]of s)this.labels.push(c),this.outputs.push(f)}static parse(e,n){if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");let s=n.parse(e[1],1,It);if(!s)return null;let c=[],f=null;n.expectedType&&n.expectedType.kind!=="value"&&(f=n.expectedType);for(let p=1;p<e.length;p+=2){let y=p===1?-1/0:e[p],x=e[p+1],w=p,I=p+1;if(typeof y!="number")return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(c.length&&c[c.length-1][0]>=y)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',w);let S=n.parse(x,I,f);if(!S)return null;f=f||S.type,c.push([y,S])}return new Fu(f,s,c)}evaluate(e){let n=this.labels,s=this.outputs;if(n.length===1)return s[0].evaluate(e);let c=this.input.evaluate(e);if(c<=n[0])return s[0].evaluate(e);let f=n.length;return c>=n[f-1]?s[f-1].evaluate(e):s[_h(n,c)].evaluate(e)}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&e.push(this.labels[n]),e.push(this.outputs[n].serialize());return e}}let ey=.95047,ty=1.08883,ny=4/29,ac=6/29,iy=3*ac*ac,Lp=ac*ac*ac,Ib=Math.PI/180,ry=180/Math.PI;function kp(i){return i>Lp?Math.pow(i,1/3):i/iy+ny}function Fp(i){return i>ac?i*i*i:iy*(i-ny)}function Np(i){return 255*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055)}function yh(i){return(i/=255)<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function zp(i){let e=yh(i.r),n=yh(i.g),s=yh(i.b),c=kp((.4124564*e+.3575761*n+.1804375*s)/ey),f=kp((.2126729*e+.7151522*n+.072175*s)/1);return{l:116*f-16,a:500*(c-f),b:200*(f-kp((.0193339*e+.119192*n+.9503041*s)/ty)),alpha:i.a}}function cl(i){let e=(i.l+16)/116,n=isNaN(i.a)?e:e+i.a/500,s=isNaN(i.b)?e:e-i.b/200;return e=1*Fp(e),n=ey*Fp(n),s=ty*Fp(s),new Ln(Np(3.2404542*n-1.5371385*e-.4985314*s),Np(-.969266*n+1.8760108*e+.041556*s),Np(.0556434*n-.2040259*e+1.0572252*s),i.alpha)}function oy(i,e,n){let s=e-i;return i+n*(s>180||s<-180?s-360*Math.round(s/360):s)}let lc={forward:zp,reverse:cl,interpolate:function(i,e,n){return{l:Ct(i.l,e.l,n),a:Ct(i.a,e.a,n),b:Ct(i.b,e.b,n),alpha:Ct(i.alpha,e.alpha,n)}}},Nu={forward:function(i){let{l:e,a:n,b:s}=zp(i),c=Math.atan2(s,n)*ry;return{h:c<0?c+360:c,c:Math.sqrt(n*n+s*s),l:e,alpha:i.a}},reverse:function(i){let e=i.h*Ib,n=i.c;return cl({l:i.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:i.alpha})},interpolate:function(i,e,n){return{h:oy(i.h,e.h,n),c:Ct(i.c,e.c,n),l:Ct(i.l,e.l,n),alpha:Ct(i.alpha,e.alpha,n)}}};var vh=Object.freeze({__proto__:null,hcl:Nu,lab:lc});class no{constructor(e,n,s,c,f){this.type=e,this.operator=n,this.interpolation=s,this.input=c,this.labels=[],this.outputs=[];for(let[p,y]of f)this.labels.push(p),this.outputs.push(y)}static interpolationFactor(e,n,s,c){let f=0;if(e.name==="exponential")f=Bp(n,e.base,s,c);else if(e.name==="linear")f=Bp(n,1,s,c);else if(e.name==="cubic-bezier"){let p=e.controlPoints;f=new Hl(p[0],p[1],p[2],p[3]).solve(Bp(n,1,s,c))}return f}static parse(e,n){let[s,c,f,...p]=e;if(!Array.isArray(c)||c.length===0)return n.error("Expected an interpolation type expression.",1);if(c[0]==="linear")c={name:"linear"};else if(c[0]==="exponential"){let w=c[1];if(typeof w!="number")return n.error("Exponential interpolation requires a numeric base.",1,1);c={name:"exponential",base:w}}else{if(c[0]!=="cubic-bezier")return n.error(`Unknown interpolation type ${String(c[0])}`,1,0);{let w=c.slice(1);if(w.length!==4||w.some(I=>typeof I!="number"||I<0||I>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);c={name:"cubic-bezier",controlPoints:w}}}if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(f=n.parse(f,2,It),!f)return null;let y=[],x=null;s==="interpolate-hcl"||s==="interpolate-lab"?x=ho:n.expectedType&&n.expectedType.kind!=="value"&&(x=n.expectedType);for(let w=0;w<p.length;w+=2){let I=p[w],S=p[w+1],D=w+3,P=w+4;if(typeof I!="number")return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',D);if(y.length&&y[y.length-1][0]>=I)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',D);let O=n.parse(S,P,x);if(!O)return null;x=x||O.type,y.push([I,O])}return x.kind==="number"||x.kind==="color"||x.kind==="array"&&x.itemType.kind==="number"&&typeof x.N=="number"?new no(x,s,c,f,y):n.error(`Type ${Ji(x)} is not interpolatable.`)}evaluate(e){let n=this.labels,s=this.outputs;if(n.length===1)return s[0].evaluate(e);let c=this.input.evaluate(e);if(c<=n[0])return s[0].evaluate(e);let f=n.length;if(c>=n[f-1])return s[f-1].evaluate(e);let p=_h(n,c),y=no.interpolationFactor(this.interpolation,c,n[p],n[p+1]),x=s[p].evaluate(e),w=s[p+1].evaluate(e);return this.operator==="interpolate"?Iu[this.type.kind.toLowerCase()](x,w,y):this.operator==="interpolate-hcl"?Nu.reverse(Nu.interpolate(Nu.forward(x),Nu.forward(w),y)):lc.reverse(lc.interpolate(lc.forward(x),lc.forward(w),y))}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let n=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)n.push(this.labels[s],this.outputs[s].serialize());return n}}function Bp(i,e,n,s){let c=s-n,f=i-n;return c===0?0:e===1?f/c:(Math.pow(e,f)-1)/(Math.pow(e,c)-1)}class xh{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expectected at least one argument.");let s=null,c=n.expectedType;c&&c.kind!=="value"&&(s=c);let f=[];for(let y of e.slice(1)){let x=n.parse(y,1+f.length,s,void 0,{typeAnnotation:"omit"});if(!x)return null;s=s||x.type,f.push(x)}let p=c&&f.some(y=>Kl(c,y.type));return new xh(p?kn:s,f)}evaluate(e){let n,s=null,c=0;for(let f of this.args){if(c++,s=f.evaluate(e),s&&s instanceof to&&!s.available&&(n||(n=s),s=null,c===this.args.length))return n;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=["coalesce"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class zu{constructor(e,n){this.type=n.type,this.bindings=[].concat(e),this.result=n}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(let n of this.bindings)e(n[1]);e(this.result)}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);let s=[];for(let f=1;f<e.length-1;f+=2){let p=e[f];if(typeof p!="string")return n.error(`Expected string, but found ${typeof p} instead.`,f);if(/[^a-zA-Z0-9_]/.test(p))return n.error("Variable names must contain only alphanumeric characters or '_'.",f);let y=n.parse(e[f+1],f+1);if(!y)return null;s.push([p,y])}let c=n.parse(e[e.length-1],e.length-1,n.expectedType,s);return c?new zu(s,c):null}outputDefined(){return this.result.outputDefined()}serialize(){let e=["let"];for(let[n,s]of this.bindings)e.push(n,s.serialize());return e.push(this.result.serialize()),e}}class bh{constructor(e,n,s){this.type=e,this.index=n,this.input=s}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,It),c=n.parse(e[2],2,Pr(n.expectedType||kn));return s&&c?new bh(c.type.itemType,s,c):null}evaluate(e){let n=this.index.evaluate(e),s=this.input.evaluate(e);if(n<0)throw new Xi(`Array index out of bounds: ${n} < 0.`);if(n>=s.length)throw new Xi(`Array index out of bounds: ${n} > ${s.length-1}.`);if(n!==Math.floor(n))throw new Xi(`Array index must be an integer, but found ${n} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return s[n]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Vp{constructor(e,n,s){this.type=e,this.index=n,this.input=s}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,It),c=n.parse(e[2],2,Pr(n.expectedType||kn));return s&&c?new Vp(c.type.itemType,s,c):null}evaluate(e){let n=this.index.evaluate(e),s=this.input.evaluate(e);if(n<0)throw new Xi(`Array index out of bounds: ${n} < 0.`);if(n>s.length-1)throw new Xi(`Array index out of bounds: ${n} > ${s.length-1}.`);if(n===Math.floor(n))return s[n];let c=Math.floor(n),f=Math.ceil(n),p=s[c],y=s[f];if(typeof p!="number"||typeof y!="number")throw new Xi(`Cannot interpolate between non-number values at index ${n}.`);let x=n-c;return p*(1-x)+y*x}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class jp{constructor(e,n){this.type=On,this.needle=e,this.haystack=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,kn),c=n.parse(e[2],2,kn);return s&&c?ga(s.type,[On,Pn,It,Yl,kn])?new jp(s,c):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ji(s.type)} instead`):null}evaluate(e){let n=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!Cu(n,["boolean","string","number","null"]))throw new Xi(`Expected first argument to be of type boolean, string, number or null, but found ${Ji(pt(n))} instead.`);if(!Cu(s,["string","array"]))throw new Xi(`Expected second argument to be of type array or string, but found ${Ji(pt(s))} instead.`);return s.indexOf(n)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class wh{constructor(e,n,s){this.type=It,this.needle=e,this.haystack=n,this.fromIndex=s}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,kn),c=n.parse(e[2],2,kn);if(!s||!c)return null;if(!ga(s.type,[On,Pn,It,Yl,kn]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ji(s.type)} instead`);if(e.length===4){let f=n.parse(e[3],3,It);return f?new wh(s,c,f):null}return new wh(s,c)}evaluate(e){let n=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Cu(n,["boolean","string","number","null"]))throw new Xi(`Expected first argument to be of type boolean, string, number or null, but found ${Ji(pt(n))} instead.`);if(!Cu(s,["string","array"]))throw new Xi(`Expected second argument to be of type array or string, but found ${Ji(pt(s))} instead.`);if(this.fromIndex){let c=this.fromIndex.evaluate(e);return s.indexOf(n,c)}return s.indexOf(n)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Eh{constructor(e,n,s,c,f,p){this.inputType=e,this.type=n,this.input=s,this.cases=c,this.outputs=f,this.otherwise=p}static parse(e,n){if(e.length<5)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return n.error("Expected an even number of arguments.");let s,c;n.expectedType&&n.expectedType.kind!=="value"&&(c=n.expectedType);let f={},p=[];for(let w=2;w<e.length-1;w+=2){let I=e[w],S=e[w+1];Array.isArray(I)||(I=[I]);let D=n.concat(w);if(I.length===0)return D.error("Expected at least one branch label.");for(let O of I){if(typeof O!="number"&&typeof O!="string")return D.error("Branch labels must be numbers or strings.");if(typeof O=="number"&&Math.abs(O)>Number.MAX_SAFE_INTEGER)return D.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof O=="number"&&Math.floor(O)!==O)return D.error("Numeric branch labels must be integer values.");if(s){if(D.checkSubtype(s,pt(O)))return null}else s=pt(O);if(f[String(O)]!==void 0)return D.error("Branch labels must be unique.");f[String(O)]=p.length}let P=n.parse(S,w,c);if(!P)return null;c=c||P.type,p.push(P)}let y=n.parse(e[1],1,kn);if(!y)return null;let x=n.parse(e[e.length-1],e.length-1,c);return x?y.type.kind!=="value"&&n.concat(1).checkSubtype(s,y.type)?null:new Eh(s,c,y,f,p,x):null}evaluate(e){let n=this.input.evaluate(e);return(nh(pt(n),this.inputType)&&this.outputs[this.cases[n]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),s=[],c={};for(let p of n){let y=c[this.cases[p]];y===void 0?(c[this.cases[p]]=s.length,s.push([this.cases[p],[p]])):s[y][1].push(p)}let f=p=>this.inputType.kind==="number"?Number(p):p;for(let[p,y]of s)e.push(y.length===1?f(y[0]):y.map(f)),e.push(this.outputs[p].serialize());return e.push(this.otherwise.serialize()),e}}class Th{constructor(e,n,s){this.type=e,this.branches=n,this.otherwise=s}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return n.error("Expected an odd number of arguments.");let s;n.expectedType&&n.expectedType.kind!=="value"&&(s=n.expectedType);let c=[];for(let p=1;p<e.length-1;p+=2){let y=n.parse(e[p],p,On);if(!y)return null;let x=n.parse(e[p+1],p+1,s);if(!x)return null;c.push([y,x]),s=s||x.type}let f=n.parse(e[e.length-1],e.length-1,s);return f?new Th(s,c,f):null}evaluate(e){for(let[n,s]of this.branches)if(n.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(let[n,s]of this.branches)e(n),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["case"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class ul{constructor(e,n,s,c){this.type=e,this.input=n,this.beginIndex=s,this.endIndex=c}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,kn),c=n.parse(e[2],2,It);if(!s||!c)return null;if(!ga(s.type,[Pr(kn),Pn,kn]))return n.error(`Expected first argument to be of type array or string, but found ${Ji(s.type)} instead`);if(e.length===4){let f=n.parse(e[3],3,It);return f?new ul(s.type,s,c,f):null}return new ul(s.type,s,c)}evaluate(e){let n=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Cu(n,["string","array"]))throw new Xi(`Expected first argument to be of type array or string, but found ${Ji(pt(n))} instead.`);if(this.endIndex){let c=this.endIndex.evaluate(e);return n.slice(s,c)}return n.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class Up{constructor(e,n){this.type=Pr(Pn),this.str=e,this.delimiter=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Pn),c=n.parse(e[2],2,Pn);return s&&c?new Up(s,c):void 0}evaluate(e){let n=this.str.evaluate(e),s=this.delimiter.evaluate(e);return n.split(s)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Hp(i,e){return i==="=="||i==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function sy(i,e,n,s){return s.compare(e,n)===0}function cc(i,e,n){let s=i!=="=="&&i!=="!=";return class MO{constructor(f,p,y){this.type=On,this.lhs=f,this.rhs=p,this.collator=y,this.hasUntypedArgument=f.type.kind==="value"||p.type.kind==="value"}static parse(f,p){if(f.length!==3&&f.length!==4)return p.error("Expected two or three arguments.");let y=f[0],x=p.parse(f[1],1,kn);if(!x)return null;if(!Hp(y,x.type))return p.concat(1).error(`"${y}" comparisons are not supported for type '${Ji(x.type)}'.`);let w=p.parse(f[2],2,kn);if(!w)return null;if(!Hp(y,w.type))return p.concat(2).error(`"${y}" comparisons are not supported for type '${Ji(w.type)}'.`);if(x.type.kind!==w.type.kind&&x.type.kind!=="value"&&w.type.kind!=="value")return p.error(`Cannot compare types '${Ji(x.type)}' and '${Ji(w.type)}'.`);s&&(x.type.kind==="value"&&w.type.kind!=="value"?x=new At(w.type,[x]):x.type.kind!=="value"&&w.type.kind==="value"&&(w=new At(x.type,[w])));let I=null;if(f.length===4){if(x.type.kind!=="string"&&w.type.kind!=="string"&&x.type.kind!=="value"&&w.type.kind!=="value")return p.error("Cannot use collator to compare non-string types.");if(I=p.parse(f[3],3,th),!I)return null}return new MO(x,w,I)}evaluate(f){let p=this.lhs.evaluate(f),y=this.rhs.evaluate(f);if(s&&this.hasUntypedArgument){let x=pt(p),w=pt(y);if(x.kind!==w.kind||x.kind!=="string"&&x.kind!=="number")throw new Xi(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${x.kind}, ${w.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){let x=pt(p),w=pt(y);if(x.kind!=="string"||w.kind!=="string")return e(f,p,y)}return this.collator?n(f,p,y,this.collator.evaluate(f)):e(f,p,y)}eachChild(f){f(this.lhs),f(this.rhs),this.collator&&f(this.collator)}outputDefined(){return!0}serialize(){let f=[i];return this.eachChild(p=>{f.push(p.serialize())}),f}}}let ay=cc("==",function(i,e,n){return e===n},sy),ly=cc("!=",function(i,e,n){return e!==n},function(i,e,n,s){return!sy(0,e,n,s)}),Sb=cc("<",function(i,e,n){return e<n},function(i,e,n,s){return s.compare(e,n)<0}),Db=cc(">",function(i,e,n){return e>n},function(i,e,n,s){return s.compare(e,n)>0}),Cb=cc("<=",function(i,e,n){return e<=n},function(i,e,n,s){return s.compare(e,n)<=0}),Ih=cc(">=",function(i,e,n){return e>=n},function(i,e,n,s){return s.compare(e,n)>=0});class $p{constructor(e,n,s,c,f,p){this.type=Pn,this.number=e,this.locale=n,this.currency=s,this.unit=c,this.minFractionDigits=f,this.maxFractionDigits=p}static parse(e,n){if(e.length!==3)return n.error("Expected two arguments.");let s=n.parse(e[1],1,It);if(!s)return null;let c=e[2];if(typeof c!="object"||Array.isArray(c))return n.error("NumberFormat options argument must be an object.");let f=null;if(c.locale&&(f=n.parseObjectValue(c.locale,2,"locale",Pn),!f))return null;let p=null;if(c.currency&&(p=n.parseObjectValue(c.currency,2,"currency",Pn),!p))return null;let y=null;if(c.unit&&(y=n.parseObjectValue(c.unit,2,"unit",Pn),!y))return null;let x=null;if(c["min-fraction-digits"]&&(x=n.parseObjectValue(c["min-fraction-digits"],2,"min-fraction-digits",It),!x))return null;let w=null;return c["max-fraction-digits"]&&(w=n.parseObjectValue(c["max-fraction-digits"],2,"max-fraction-digits",It),!w)?null:new $p(s,f,p,y,x,w)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Gp{constructor(e){this.type=It,this.input=e}static parse(e,n){if(e.length!==2)return n.error(`Expected 1 argument, but found ${e.length-1} instead.`);let s=n.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?n.error(`Expected argument of type string or array, but found ${Ji(s.type)} instead.`):new Gp(s):null}evaluate(e){let n=this.input.evaluate(e);if(typeof n=="string"||Array.isArray(n))return n.length;throw new Xi(`Expected value to be of type string or array, but found ${Ji(pt(n))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){let e=["length"];return this.eachChild(n=>{e.push(n.serialize())}),e}}function cy(i){return function(){i=1831565813+(i|=0)|0;let e=Math.imul(i^i>>>15,1|i);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let uc={"==":ay,"!=":ly,">":Db,"<":Sb,">=":Ih,"<=":Cb,array:At,at:bh,"at-interpolated":Vp,boolean:At,case:Th,coalesce:xh,collator:xs,format:Jl,image:Ql,in:jp,"index-of":wh,interpolate:no,"interpolate-hcl":no,"interpolate-lab":no,length:Gp,let:zu,literal:Lt,match:Eh,number:At,"number-format":$p,object:At,slice:ul,step:Fu,string:At,"to-boolean":Zo,"to-color":Zo,"to-number":Zo,"to-string":Zo,var:mh,within:ba,distance:ll,config:sc,split:Up};function qp(i,[e,n,s,c]){e=e.evaluate(i),n=n.evaluate(i),s=s.evaluate(i);let f=c?c.evaluate(i):1,p=ol(e,n,s,f);if(p)throw new Xi(p);return new Ln(e/255,n/255,s/255,f)}function uy(i,[e,n,s,c]){e=e.evaluate(i),n=n.evaluate(i),s=s.evaluate(i);let f=c?c.evaluate(i):1,p=function(w,I,S,D){return typeof w=="number"&&w>=0&&w<=360?typeof I=="number"&&I>=0&&I<=100&&typeof S=="number"&&S>=0&&S<=100?D===void 0||typeof D=="number"&&D>=0&&D<=1?null:`Invalid hsla value [${[w,I,S,D].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof D=="number"?[w,I,S,D]:[w,I,S]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof D=="number"?[w,I,S,D]:[w,I,S]).join(", ")}]: 'h' must be between 0 and 360.`}(e,n,s,f);if(p)throw new Xi(p);let y=`hsla(${e}, ${n}%, ${s}%, ${f})`,x=Ln.parse(y);if(!x)throw new Xi(`Failed to parse HSLA color: ${y}`);return x}function dy(i,e){return i in e}function Sh(i,e){let n=e[i];return n===void 0?null:n}function Ea(i){return{type:i}}function Wp(i){return{result:"success",value:i}}function Ta(i){return{result:"error",value:i}}function Ia(i,e){return!!i&&!!i.parameters&&i.parameters.indexOf(e)>-1}function Dh(i){return i["property-type"]==="data-driven"}function hy(i){return Ia(i.expression,"measure-light")}function fy(i){return Ia(i.expression,"zoom")}function Ch(i){return!!i.expression&&i.expression.interpolated}function Ah(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function py(i){return i}function Zp(i,e){let n=e.type==="color",s=i.stops&&typeof i.stops[0][0]=="object",c=s||!(s||i.property!==void 0),f=i.type||(Ch(e)?"exponential":"interval");if(n&&((i=rl({},i)).stops&&(i.stops=i.stops.map(w=>[w[0],Ln.parse(w[1])])),i.default=Ln.parse(i.default?i.default:e.default)),i.colorSpace&&i.colorSpace!=="rgb"&&!vh[i.colorSpace])throw new Error(`Unknown color space: ${i.colorSpace}`);let p,y,x;if(f==="exponential")p=gy;else if(f==="interval")p=my;else if(f==="categorical"){p=Xp,y=Object.create(null);for(let w of i.stops)y[w[0]]=w[1];x=typeof i.stops[0][0]}else{if(f!=="identity")throw new Error(`Unknown function type "${f}"`);p=_y}if(s){let w={},I=[];for(let P=0;P<i.stops.length;P++){let O=i.stops[P],F=O[0].zoom;w[F]===void 0&&(w[F]={zoom:F,type:i.type,property:i.property,default:i.default,stops:[]},I.push(F)),w[F].stops.push([O[0].value,O[1]])}let S=[];for(let P of I)S.push([w[P].zoom,Zp(w[P],e)]);let D={name:"linear"};return{kind:"composite",interpolationType:D,interpolationFactor:no.interpolationFactor.bind(void 0,D),zoomStops:S.map(P=>P[0]),evaluate:({zoom:P},O)=>gy({stops:S,base:i.base},e,P).evaluate(P,O)}}if(c){let w=f==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:w,interpolationFactor:no.interpolationFactor.bind(void 0,w),zoomStops:i.stops.map(I=>I[0]),evaluate:({zoom:I})=>p(i,e,I,y,x)}}return{kind:"source",evaluate(w,I){let S=I&&I.properties?I.properties[i.property]:void 0;return S===void 0?dl(i.default,e.default):p(i,e,S,y,x)}}}function dl(i,e,n){return i!==void 0?i:e!==void 0?e:n!==void 0?n:void 0}function Xp(i,e,n,s,c){return dl(typeof n===c?s[n]:void 0,i.default,e.default)}function my(i,e,n){if(_a(n)!=="number")return dl(i.default,e.default);let s=i.stops.length;if(s===1||n<=i.stops[0][0])return i.stops[0][1];if(n>=i.stops[s-1][0])return i.stops[s-1][1];let c=_h(i.stops.map(f=>f[0]),n);return i.stops[c][1]}function gy(i,e,n){let s=i.base!==void 0?i.base:1;if(_a(n)!=="number")return dl(i.default,e.default);let c=i.stops.length;if(c===1||n<=i.stops[0][0])return i.stops[0][1];if(n>=i.stops[c-1][0])return i.stops[c-1][1];let f=_h(i.stops.map(I=>I[0]),n),p=function(I,S,D,P){let O=P-D,F=I-D;return O===0?0:S===1?F/O:(Math.pow(S,F)-1)/(Math.pow(S,O)-1)}(n,s,i.stops[f][0],i.stops[f+1][0]),y=i.stops[f][1],x=i.stops[f+1][1],w=Iu[e.type]||py;if(i.colorSpace&&i.colorSpace!=="rgb"){let I=vh[i.colorSpace];w=(S,D)=>I.reverse(I.interpolate(I.forward(S),I.forward(D),p))}return typeof y.evaluate=="function"?{evaluate(...I){let S=y.evaluate.apply(void 0,I),D=x.evaluate.apply(void 0,I);if(S!==void 0&&D!==void 0)return w(S,D,p)}}:w(y,x,p)}function _y(i,e,n){return e.type==="color"?n=Ln.parse(n):e.type==="formatted"?n=Br.fromString(n.toString()):e.type==="resolvedImage"?n=to.build(n.toString()):_a(n)===e.type||e.type==="enum"&&e.values[n]||(n=void 0),dl(n,i.default,e.default)}fr.register(uc,{error:[{kind:"error"},[Pn],(i,[e])=>{throw new Xi(e.evaluate(i))}],typeof:[Pn,[kn],(i,[e])=>Ji(pt(e.evaluate(i)))],"to-rgba":[Pr(It,4),[ho],(i,[e])=>e.evaluate(i).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Pr(It,4),[ho],(i,[e])=>e.evaluate(i).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[ho,[It,It,It],qp],rgba:[ho,[It,It,It,It],qp],hsl:[ho,[It,It,It],uy],hsla:[ho,[It,It,It,It],uy],has:{type:On,overloads:[[[Pn],(i,[e])=>dy(e.evaluate(i),i.properties())],[[Pn,Us],(i,[e,n])=>dy(e.evaluate(i),n.evaluate(i))]]},get:{type:kn,overloads:[[[Pn],(i,[e])=>Sh(e.evaluate(i),i.properties())],[[Pn,Us],(i,[e,n])=>Sh(e.evaluate(i),n.evaluate(i))]]},"feature-state":[kn,[Pn],(i,[e])=>Sh(e.evaluate(i),i.featureState||{})],properties:[Us,[],i=>i.properties()],"geometry-type":[Pn,[],i=>i.geometryType()],worldview:[Pn,[],i=>i.globals.worldview||""],id:[kn,[],i=>i.id()],zoom:[It,[],i=>i.globals.zoom],pitch:[It,[],i=>i.globals.pitch||0],"distance-from-center":[It,[],i=>i.distanceFromCenter()],"measure-light":[It,[Pn],(i,[e])=>i.measureLight(e.evaluate(i))],"heatmap-density":[It,[],i=>i.globals.heatmapDensity||0],"line-progress":[It,[],i=>i.globals.lineProgress||0],"raster-value":[It,[],i=>i.globals.rasterValue||0],"raster-particle-speed":[It,[],i=>i.globals.rasterParticleSpeed||0],"sky-radial-progress":[It,[],i=>i.globals.skyRadialProgress||0],accumulated:[kn,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[It,Ea(It),(i,e)=>{let n=0;for(let s of e)n+=s.evaluate(i);return n}],"*":[It,Ea(It),(i,e)=>{let n=1;for(let s of e)n*=s.evaluate(i);return n}],"-":{type:It,overloads:[[[It,It],(i,[e,n])=>e.evaluate(i)-n.evaluate(i)],[[It],(i,[e])=>-e.evaluate(i)]]},"/":[It,[It,It],(i,[e,n])=>e.evaluate(i)/n.evaluate(i)],"%":[It,[It,It],(i,[e,n])=>e.evaluate(i)%n.evaluate(i)],ln2:[It,[],()=>Math.LN2],pi:[It,[],()=>Math.PI],e:[It,[],()=>Math.E],"^":[It,[It,It],(i,[e,n])=>Math.pow(e.evaluate(i),n.evaluate(i))],sqrt:[It,[It],(i,[e])=>Math.sqrt(e.evaluate(i))],log10:[It,[It],(i,[e])=>Math.log(e.evaluate(i))/Math.LN10],ln:[It,[It],(i,[e])=>Math.log(e.evaluate(i))],log2:[It,[It],(i,[e])=>Math.log(e.evaluate(i))/Math.LN2],sin:[It,[It],(i,[e])=>Math.sin(e.evaluate(i))],cos:[It,[It],(i,[e])=>Math.cos(e.evaluate(i))],tan:[It,[It],(i,[e])=>Math.tan(e.evaluate(i))],asin:[It,[It],(i,[e])=>Math.asin(e.evaluate(i))],acos:[It,[It],(i,[e])=>Math.acos(e.evaluate(i))],atan:[It,[It],(i,[e])=>Math.atan(e.evaluate(i))],min:[It,Ea(It),(i,e)=>Math.min(...e.map(n=>n.evaluate(i)))],max:[It,Ea(It),(i,e)=>Math.max(...e.map(n=>n.evaluate(i)))],abs:[It,[It],(i,[e])=>Math.abs(e.evaluate(i))],round:[It,[It],(i,[e])=>{let n=e.evaluate(i);return n<0?-Math.round(-n):Math.round(n)}],floor:[It,[It],(i,[e])=>Math.floor(e.evaluate(i))],ceil:[It,[It],(i,[e])=>Math.ceil(e.evaluate(i))],"filter-==":[On,[Pn,kn],(i,[e,n])=>i.properties()[e.value]===n.value],"filter-id-==":[On,[kn],(i,[e])=>i.id()===e.value],"filter-type-==":[On,[Pn],(i,[e])=>i.geometryType()===e.value],"filter-<":[On,[Pn,kn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s<c}],"filter-id-<":[On,[kn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n<s}],"filter->":[On,[Pn,kn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s>c}],"filter-id->":[On,[kn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n>s}],"filter-<=":[On,[Pn,kn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s<=c}],"filter-id-<=":[On,[kn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n<=s}],"filter->=":[On,[Pn,kn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s>=c}],"filter-id->=":[On,[kn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n>=s}],"filter-has":[On,[kn],(i,[e])=>e.value in i.properties()],"filter-has-id":[On,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[On,[Pr(Pn)],(i,[e])=>e.value.indexOf(i.geometryType())>=0],"filter-id-in":[On,[Pr(kn)],(i,[e])=>e.value.indexOf(i.id())>=0],"filter-in-small":[On,[Pn,Pr(kn)],(i,[e,n])=>n.value.indexOf(i.properties()[e.value])>=0],"filter-in-large":[On,[Pn,Pr(kn)],(i,[e,n])=>function(s,c,f,p){for(;f<=p;){let y=f+p>>1;if(c[y]===s)return!0;c[y]>s?p=y-1:f=y+1}return!1}(i.properties()[e.value],n.value,0,n.value.length-1)],all:{type:On,overloads:[[[On,On],(i,[e,n])=>e.evaluate(i)&&n.evaluate(i)],[Ea(On),(i,e)=>{for(let n of e)if(!n.evaluate(i))return!1;return!0}]]},any:{type:On,overloads:[[[On,On],(i,[e,n])=>e.evaluate(i)||n.evaluate(i)],[Ea(On),(i,e)=>{for(let n of e)if(n.evaluate(i))return!0;return!1}]]},"!":[On,[On],(i,[e])=>!e.evaluate(i)],"is-supported-script":[On,[Pn],(i,[e])=>{let n=i.globals&&i.globals.isSupportedScript;return!n||n(e.evaluate(i))}],upcase:[Pn,[Pn],(i,[e])=>e.evaluate(i).toUpperCase()],downcase:[Pn,[Pn],(i,[e])=>e.evaluate(i).toLowerCase()],concat:[Pn,Ea(kn),(i,e)=>e.map(n=>Wo(n.evaluate(i))).join("")],"resolved-locale":[Pn,[th],(i,[e])=>e.evaluate(i).resolvedLocale()],random:[It,[It,It,kn],(i,e)=>{let[n,s,c]=e.map(p=>p.evaluate(i));if(n>s||n===s)return n;let f;if(typeof c=="string")f=function(p){let y=0;if(p.length===0)return y;for(let x=0;x<p.length;x++)y=(y<<5)-y+p.charCodeAt(x),y|=0;return y}(c);else{if(typeof c!="number")throw new Xi(`Invalid seed input: ${c}`);f=c}return n+cy(f)()*(s-n)}]});class Yp{constructor(e,n,s,c){this.expression=e,this._warningHistory={},this._evaluator=new Ru(s,c),this._defaultValue=n?function(f){return f.type==="color"&&(Ah(f.default)||Array.isArray(f.default))?new Ln(0,0,0,0):f.type==="color"?Ln.parse(f.default)||null:f.default===void 0?null:f.default}(n):null,this._enumValues=n&&n.type==="enum"?n.values:null,this.configDependencies=ph(e)}evaluateWithoutErrorHandling(e,n,s,c,f,p,y,x){return this._evaluator.globals=e,this._evaluator.feature=n,this._evaluator.featureState=s,this._evaluator.canonical=c||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=x||null,this.expression.evaluate(this._evaluator)}evaluate(e,n,s,c,f,p,y,x){this._evaluator.globals=e,this._evaluator.feature=n||null,this._evaluator.featureState=s||null,this._evaluator.canonical=c||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p||null,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=x||null;try{let w=this.expression.evaluate(this._evaluator);if(w==null||typeof w=="number"&&w!=w)return this._defaultValue;if(this._enumValues&&!(w in this._enumValues))throw new Xi(`Expected value to be one of ${Object.keys(this._enumValues).map(I=>JSON.stringify(I)).join(", ")}, but found ${JSON.stringify(w)} instead.`);return w}catch(w){return this._warningHistory[w.message]||(this._warningHistory[w.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${w.message}`)),this._defaultValue}}}function Kp(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in uc}function hl(i,e,n,s){let c=new gh(uc,[],e?function(p){let y={color:ho,string:Pn,number:It,enum:Pn,boolean:On,formatted:Su,resolvedImage:Du};return p.type==="array"?Pr(y[p.value]||kn,p.length):y[p.type]}(e):void 0,void 0,void 0,n,s),f=c.parse(i,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?Wp(new Yp(f,e,n,s)):Ta(c.errors)}class Mh{constructor(e,n,s,c){this.kind=e,this._styleExpression=n,this.isLightConstant=s,this.isLineProgressConstant=c,this.isStateDependent=e!=="constant"&&!fh(n.expression),this.configDependencies=ph(n.expression)}evaluateWithoutErrorHandling(e,n,s,c,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,n,s,c,f,p)}evaluate(e,n,s,c,f,p){return this._styleExpression.evaluate(e,n,s,c,f,p)}}class Sa{constructor(e,n,s,c,f,p){this.kind=e,this.zoomStops=s,this._styleExpression=n,this.isStateDependent=e!=="camera"&&!fh(n.expression),this.isLightConstant=f,this.isLineProgressConstant=p,this.configDependencies=ph(n.expression),this.interpolationType=c}evaluateWithoutErrorHandling(e,n,s,c,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,n,s,c,f,p)}evaluate(e,n,s,c,f,p){return this._styleExpression.evaluate(e,n,s,c,f,p)}interpolationFactor(e,n,s){return this.interpolationType?no.interpolationFactor(this.interpolationType,e,n,s):0}}function Jp(i,e,n,s){if((i=hl(i,e,n,s)).result==="error")return i;let c=i.value.expression,f=rc(c);if(!f&&!Dh(e))return Ta([new Do("","data expressions not supported")]);let p=oc(c,["zoom","pitch","distance-from-center"]);if(!p&&!fy(e))return Ta([new Do("","zoom expressions not supported")]);let y=oc(c,["measure-light"]);if(!y&&!hy(e))return Ta([new Do("","measure-light expression not supported")]);let x=oc(c,["line-progress"]);if(!x&&!function(S){return Ia(S.expression,"line-progress")}(e))return Ta([new Do("","line-progress expression not supported")]);let w=e.expression&&e.expression.relaxZoomRestriction,I=Bu(c);return I||p||w?I instanceof Do?Ta([I]):I instanceof no&&!Ch(e)?Ta([new Do("",'"interpolate" expressions cannot be used with this property')]):Wp(I?new Sa(f&&x?"camera":"composite",i.value,I.labels,I instanceof no?I.interpolation:void 0,y,x):new Mh(f&&x?"constant":"source",i.value,y,x)):Ta([new Do("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class fl{constructor(e,n){this._parameters=e,this._specification=n,rl(this,Zp(this._parameters,this._specification))}static deserialize(e){return new fl(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Bu(i){let e=null;if(i instanceof zu)e=Bu(i.result);else if(i instanceof xh){for(let n of i.args)if(e=Bu(n),e)break}else(i instanceof Fu||i instanceof no)&&i.input instanceof fr&&i.input.name==="zoom"&&(e=i);return e instanceof Do||i.eachChild(n=>{let s=Bu(n);s instanceof Do?e=s:e&&s&&e!==s&&(e=new Do("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Qp,yy,em=function(){if(yy)return Qp;yy=1,Qp=e;var i=3;function e(n,s,c){var f=this.cells=[];if(n instanceof ArrayBuffer){this.arrayBuffer=n;var p=new Int32Array(this.arrayBuffer);n=p[0],this.d=(s=p[1])+2*(c=p[2]);for(var y=0;y<this.d*this.d;y++){var x=p[i+y],w=p[i+y+1];f.push(x===w?null:p.subarray(x,w))}var I=p[i+f.length+1];this.keys=p.subarray(p[i+f.length],I),this.bboxes=p.subarray(I),this.insert=this._insertReadonly}else{this.d=s+2*c;for(var S=0;S<this.d*this.d;S++)f.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=n,this.padding=c,this.scale=s/n,this.uid=0;var D=c/s*n;this.min=-D,this.max=n+D}return e.prototype.insert=function(n,s,c,f,p){this._forEachCell(s,c,f,p,this._insertCell,this.uid++),this.keys.push(n),this.bboxes.push(s),this.bboxes.push(c),this.bboxes.push(f),this.bboxes.push(p)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(n,s,c,f,p,y){this.cells[p].push(y)},e.prototype.query=function(n,s,c,f,p){var y=this.min,x=this.max;if(n<=y&&s<=y&&x<=c&&x<=f&&!p)return Array.prototype.slice.call(this.keys);var w=[];return this._forEachCell(n,s,c,f,this._queryCell,w,{},p),w},e.prototype._queryCell=function(n,s,c,f,p,y,x,w){var I=this.cells[p];if(I!==null)for(var S=this.keys,D=this.bboxes,P=0;P<I.length;P++){var O=I[P];if(x[O]===void 0){var F=4*O;(w?w(D[F+0],D[F+1],D[F+2],D[F+3]):n<=D[F+2]&&s<=D[F+3]&&c>=D[F+0]&&f>=D[F+1])?(x[O]=!0,y.push(S[O])):x[O]=!1}}},e.prototype._forEachCell=function(n,s,c,f,p,y,x,w){for(var I=this._convertToCellCoord(n),S=this._convertToCellCoord(s),D=this._convertToCellCoord(c),P=this._convertToCellCoord(f),O=I;O<=D;O++)for(var F=S;F<=P;F++){var B=this.d*F+O;if((!w||w(this._convertFromCellCoord(O),this._convertFromCellCoord(F),this._convertFromCellCoord(O+1),this._convertFromCellCoord(F+1)))&&p.call(this,n,s,c,f,B,y,x,w))return}},e.prototype._convertFromCellCoord=function(n){return(n-this.padding)/this.scale},e.prototype._convertToCellCoord=function(n){return Math.max(0,Math.min(this.d-1,Math.floor(n*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var n=this.cells,s=i+this.cells.length+1+1,c=0,f=0;f<this.cells.length;f++)c+=this.cells[f].length;var p=new Int32Array(s+c+this.keys.length+this.bboxes.length);p[0]=this.extent,p[1]=this.n,p[2]=this.padding;for(var y=s,x=0;x<n.length;x++){var w=n[x];p[i+x]=y,p.set(w,y),y+=w.length}return p[i+n.length]=y,p.set(this.keys,y),p[i+n.length+1]=y+=this.keys.length,p.set(this.bboxes,y),y+=this.bboxes.length,p.buffer},Qp}(),Da=uu(em);let Vu={};function gt(i,e,n={}){Object.defineProperty(i,"_classRegistryKey",{value:e,writable:!1}),Vu[e]={klass:i,omit:n.omit||[]}}gt(Object,"Object"),Da.serialize=function(i,e){let n=i.toArrayBuffer();return e&&e.add(n),{buffer:n}},Da.deserialize=function(i){return new Da(i.buffer)},Object.defineProperty(Da,"name",{value:"Grid"}),gt(Da,"Grid"),delete Xe.prototype.constructor,typeof DOMMatrix<"u"&&gt(DOMMatrix,"DOMMatrix"),gt(Ln,"Color"),gt(Error,"Error"),gt(Br,"Formatted"),gt(ih,"FormattedSection"),gt(xn,"AJAXError"),gt(to,"ResolvedImage"),gt(fl,"StylePropertyFunction"),gt(Yp,"StyleExpression",{omit:["_evaluator"]}),gt(uo,"ImageId"),gt(Hs,"ImageVariant"),gt(Sa,"ZoomDependentExpression"),gt(Mh,"ZoomConstantExpression"),gt(fr,"CompoundExpression",{omit:["_evaluate"]});for(let i in uc)Vu[uc[i]._classRegistryKey]||gt(uc[i],`Expression${i}`);function Rh(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function ju(i){return self.ImageBitmap&&i instanceof ImageBitmap}function $s(i,e){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp)return i;if(Rh(i)||ju(i))return e&&e.add(i),i;if(ArrayBuffer.isView(i))return e&&e.add(i.buffer),i;if(i instanceof ImageData)return e&&e.add(i.data.buffer),i;if(Array.isArray(i)){let n=[];for(let s of i)n.push($s(s,e));return n}if(i instanceof Map){let n={$name:"Map",entries:[]};for(let[s,c]of i.entries())n.entries.push($s(s),$s(c,e));return n}if(i instanceof Set){let n={$name:"Set"},s=0;for(let c of i.values())n[++s]=$s(c);return n}if(i instanceof DOMMatrix){let n={$name:"DOMMatrix"},s=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(let c of s)n[c]=i[c];return n}if(typeof i=="bigint")return{$name:"BigInt",value:i.toString()};if(typeof i=="object"){let n=i.constructor,s=n._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${n.name}".`);let c=n.serialize?n.serialize(i,e):{};if(!n.serialize){for(let f in i)i.hasOwnProperty(f)&&(Vu[s].omit.indexOf(f)>=0||(c[f]=$s(i[f],e)));i instanceof Error&&(c.message=i.message)}if(c.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(c.$name=s),c}throw new Error("can't serialize object of type "+typeof i)}function io(i){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||Rh(i)||ju(i)||ArrayBuffer.isView(i)||i instanceof ImageData)return i;if(Array.isArray(i))return i.map(io);if(typeof i=="object"){let e=i.$name||"Object";if(e==="Map"){let c=i.entries||[],f=new Map;for(let p=0;p<c.length;p+=2)f.set(io(c[p]),io(c[p+1]));return f}if(e==="Set"){let c=new Set;for(let f of Object.keys(i))f!=="$name"&&c.add(io(i[f]));return c}if(e==="DOMMatrix"){let c;return c=i.is2D?[i.a,i.b,i.c,i.d,i.e,i.f]:[i.m11,i.m12,i.m13,i.m14,i.m21,i.m22,i.m23,i.m24,i.m31,i.m32,i.m33,i.m34,i.m41,i.m42,i.m43,i.m44],new DOMMatrix(c)}if(e==="BigInt")return BigInt(i.value);let{klass:n}=Vu[e];if(!n)throw new Error(`Can't deserialize unregistered class "${e}".`);if(n.deserialize)return n.deserialize(i);let s=Object.create(n.prototype);for(let c of Object.keys(i))c!=="$name"&&(s[c]=io(i[c]));return s}throw new Error("can't deserialize object of type "+typeof i)}let Rt={"Latin-1 Supplement":i=>i>=128&&i<=255,Arabic:i=>i>=1536&&i<=1791,"Arabic Supplement":i=>i>=1872&&i<=1919,"Arabic Extended-A":i=>i>=2208&&i<=2303,"Hangul Jamo":i=>i>=4352&&i<=4607,"Unified Canadian Aboriginal Syllabics":i=>i>=5120&&i<=5759,Khmer:i=>i>=6016&&i<=6143,"Unified Canadian Aboriginal Syllabics Extended":i=>i>=6320&&i<=6399,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"CJK Radicals Supplement":i=>i>=11904&&i<=12031,"Kangxi Radicals":i=>i>=12032&&i<=12255,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Hiragana:i=>i>=12352&&i<=12447,Katakana:i=>i>=12448&&i<=12543,Bopomofo:i=>i>=12544&&i<=12591,"Hangul Compatibility Jamo":i=>i>=12592&&i<=12687,Kanbun:i=>i>=12688&&i<=12703,"Bopomofo Extended":i=>i>=12704&&i<=12735,"CJK Strokes":i=>i>=12736&&i<=12783,"Katakana Phonetic Extensions":i=>i>=12784&&i<=12799,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"CJK Unified Ideographs Extension A":i=>i>=13312&&i<=19903,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"CJK Unified Ideographs":i=>i>=19968&&i<=40959,"Yi Syllables":i=>i>=40960&&i<=42127,"Yi Radicals":i=>i>=42128&&i<=42191,"Hangul Jamo Extended-A":i=>i>=43360&&i<=43391,"Hangul Syllables":i=>i>=44032&&i<=55215,"Hangul Jamo Extended-B":i=>i>=55216&&i<=55295,"Private Use Area":i=>i>=57344&&i<=63743,"CJK Compatibility Ideographs":i=>i>=63744&&i<=64255,"Arabic Presentation Forms-A":i=>i>=64336&&i<=65023,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Arabic Presentation Forms-B":i=>i>=65136&&i<=65279,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519,Osage:i=>i>=66736&&i<=66815,"CJK Unified Ideographs Extension B":i=>i>=131072&&i<=173791};function tm(i){for(let e of i)if(Ph(e.charCodeAt(0)))return!0;return!1}function Ab(i){for(let e of i)if(!Mb(e.charCodeAt(0)))return!1;return!0}function Mb(i){return!(Rt.Arabic(i)||Rt["Arabic Supplement"](i)||Rt["Arabic Extended-A"](i)||Rt["Arabic Presentation Forms-A"](i)||Rt["Arabic Presentation Forms-B"](i))}function Ph(i){return!(i!==746&&i!==747&&(i<4352||!(Rt["Bopomofo Extended"](i)||Rt.Bopomofo(i)||Rt["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||Rt["CJK Compatibility Ideographs"](i)||Rt["CJK Compatibility"](i)||Rt["CJK Radicals Supplement"](i)||Rt["CJK Strokes"](i)||!(!Rt["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||Rt["CJK Unified Ideographs Extension A"](i)||Rt["CJK Unified Ideographs"](i)||Rt["Enclosed CJK Letters and Months"](i)||Rt["Hangul Compatibility Jamo"](i)||Rt["Hangul Jamo Extended-A"](i)||Rt["Hangul Jamo Extended-B"](i)||Rt["Hangul Jamo"](i)||Rt["Hangul Syllables"](i)||Rt.Hiragana(i)||Rt["Ideographic Description Characters"](i)||Rt.Kanbun(i)||Rt["Kangxi Radicals"](i)||Rt["Katakana Phonetic Extensions"](i)||Rt.Katakana(i)&&i!==12540||!(!Rt["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!Rt["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||Rt["Unified Canadian Aboriginal Syllabics"](i)||Rt["Unified Canadian Aboriginal Syllabics Extended"](i)||Rt["Vertical Forms"](i)||Rt["Yijing Hexagram Symbols"](i)||Rt["Yi Syllables"](i)||Rt["Yi Radicals"](i))))}function Oh(i){return!(Ph(i)||function(e){return!!(Rt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Rt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Rt["Letterlike Symbols"](e)||Rt["Number Forms"](e)||Rt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Rt["Control Pictures"](e)&&e!==9251||Rt["Optical Character Recognition"](e)||Rt["Enclosed Alphanumerics"](e)||Rt["Geometric Shapes"](e)||Rt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Rt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Rt["CJK Symbols and Punctuation"](e)||Rt.Katakana(e)||Rt["Private Use Area"](e)||Rt["CJK Compatibility Forms"](e)||Rt["Small Form Variants"](e)||Rt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(i))}function vy(i){return Rt.Arabic(i)||Rt["Arabic Supplement"](i)||Rt["Arabic Extended-A"](i)||Rt["Arabic Presentation Forms-A"](i)||Rt["Arabic Presentation Forms-B"](i)}function Lh(i){return i>=1424&&i<=2303||Rt["Arabic Presentation Forms-A"](i)||Rt["Arabic Presentation Forms-B"](i)}function Rb(i,e){return!(!e&&Lh(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||Rt.Khmer(i))}function Pb(i){for(let e of i)if(Lh(e.charCodeAt(0)))return!0;return!1}let fo={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"},nm=null,jr=fo.unavailable,Ca=null,xy=function(i){i&&typeof i=="string"&&i.indexOf("NetworkError")>-1&&(jr=fo.error),nm&&nm(i)};function im(){rm.fire(new js("pluginStateChange",{pluginStatus:jr,pluginURL:Ca}))}let rm=new il,om=function(){return jr},by=function(){if(jr!==fo.deferred||!Ca)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");jr=fo.loading,im(),Ca&&xu({url:Ca},i=>{i?xy(i):(jr=fo.loaded,im())})},bs={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>jr===fo.loaded||bs.applyArabicShaping!=null,isLoading:()=>jr===fo.loading,setState(i){jr=i.pluginStatus,Ca=i.pluginURL},isParsing:()=>jr===fo.parsing,isParsed:()=>jr===fo.parsed,getPluginURL:()=>Ca};class Un{constructor(e,n){this.zoom=e,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness,this.worldview=n.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(n,s){for(let c of n)if(!Rb(c.charCodeAt(0),s))return!1;return!0}(e,bs.isLoaded())}}class Uu{constructor(e,n,s,c){this.property=e,this.value=n,this.expression=function(f,p,y,x){if(Ah(f))return new fl(f,p);if(Kp(f)||Array.isArray(f)&&f.length>0){let w=Jp(f,p,y,x);if(w.result==="error")throw new Error(w.value.map(I=>`${I.key}: ${I.message}`).join(", "));return w.value}{let w=f;return typeof f=="string"&&p.type==="color"&&(w=Ln.parse(f)),{kind:"constant",configDependencies:new Set,evaluate:()=>w}}}(n===void 0?e.specification.default:n,e.specification,s,c)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,n,s){return this.property.possiblyEvaluate(this,e,n,s)}}class kh{constructor(e,n,s){this.property=e,this.value=new Uu(e,void 0,n,s)}transitioned(e,n){return new wy(this.property,this.value,n,De({},e.transition,this.transition),e.now)}untransitioned(){return new wy(this.property,this.value,null,{},0)}}class Hu{constructor(e,n,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=n,this._options=s,this.configDependencies=new Set}getValue(e){return rn(this._values[e].value.value)}setValue(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new kh(this._values[e].property,this._scope,this._options)),this._values[e].value=new Uu(this._values[e].property,n===null?void 0:rn(n),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,n){n&&(this._options=n);let s=this._properties.properties;if(e)for(let c in e){let f=e[c];if(c.endsWith("-transition")){let p=c.slice(0,-11);s[p]&&this.setTransition(p,f)}else s.hasOwnProperty(c)&&this.setValue(c,f)}}getTransition(e){return rn(this._values[e].transition)}setTransition(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new kh(this._values[e].property)),this._values[e].transition=rn(n)||void 0}serialize(){let e={};for(let n of Object.keys(this._values)){let s=this.getValue(n);s!==void 0&&(e[n]=s);let c=this.getTransition(n);c!==void 0&&(e[`${n}-transition`]=c)}return e}transitioned(e,n){let s=new Ey(this._properties);for(let c of Object.keys(this._values))s._values[c]=this._values[c].transitioned(e,n._values[c]);return s}untransitioned(){let e=new Ey(this._properties);for(let n of Object.keys(this._values))e._values[n]=this._values[n].untransitioned();return e}}class wy{constructor(e,n,s,c,f){let p=c.delay||0,y=c.duration||0;f=f||0,this.property=e,this.value=n,this.begin=f+p,this.end=this.begin+y,e.specification.transition&&(c.delay||c.duration)&&(this.prior=s)}possiblyEvaluate(e,n,s){let c=e.now||0,f=this.value.possiblyEvaluate(e,n,s),p=this.prior;if(p){if(c>this.end)return this.prior=null,f;if(this.value.isDataDriven())return this.prior=null,f;if(c<this.begin)return p.possiblyEvaluate(e,n,s);{let y=(c-this.begin)/(this.end-this.begin);return this.property.interpolate(p.possiblyEvaluate(e,n,s),f,q(y))}}return f}}class Ey{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,n,s){let c=new as(this._properties);for(let f of Object.keys(this._values))c._values[f]=this._values[f].possiblyEvaluate(e,n,s);return c}hasTransition(){for(let e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Aa{constructor(e,n,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=n,this._options=s,this.configDependencies=new Set}getValue(e){return rn(this._values[e].value)}setValue(e,n){this._values[e]=new Uu(this._values[e].property,n===null?void 0:rn(n),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){let e={};for(let n of Object.keys(this._values)){let s=this.getValue(n);s!==void 0&&(e[n]=s)}return e}possiblyEvaluate(e,n,s){let c=new as(this._properties);for(let f of Object.keys(this._values))c._values[f]=this._values[f].possiblyEvaluate(e,n,s);return c}}class pl{constructor(e,n,s){this.property=e,this.value=n,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,n,s,c){return this.property.evaluate(this.value,this.parameters,e,n,s,c)}}class as{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class tt{constructor(e){this.specification=e}possiblyEvaluate(e,n){return e.expression.evaluate(n)}interpolate(e,n,s){let c=Iu[this.specification.type];return c?c(e,n,s):e}}class ut{constructor(e,n){this.specification=e,this.overrides=n}possiblyEvaluate(e,n,s,c){return new pl(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(n,null,{},s,c)}:e.expression,n)}interpolate(e,n,s){if(e.value.kind!=="constant"||n.value.kind!=="constant")return e;if(e.value.value===void 0||n.value.value===void 0)return new pl(this,{kind:"constant",value:void 0},e.parameters);let c=Iu[this.specification.type];return c?new pl(this,{kind:"constant",value:c(e.value.value,n.value.value,s)},e.parameters):e}evaluate(e,n,s,c,f,p){return e.kind==="constant"?e.value:e.evaluate(n,s,c,f,p)}}class dc{constructor(e){this.specification=e}possiblyEvaluate(e,n,s,c){return!!e.expression.evaluate(n,null,{},s,c)}interpolate(){return!1}}class Mi{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let n=new Un(0,{});for(let s in e){let c=e[s];c.specification.overridable&&this.overridableProperties.push(s);let f=this.defaultPropertyValues[s]=new Uu(c,void 0),p=this.defaultTransitionablePropertyValues[s]=new kh(c);this.defaultTransitioningPropertyValues[s]=p.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=f.possiblyEvaluate(n)}}}gt(ut,"DataDrivenProperty"),gt(tt,"DataConstantProperty"),gt(dc,"ColorRampProperty");var xe=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"expression"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Ty(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function $u(i){if(Array.isArray(i))return i.map($u);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){let e={};for(let n in i)e[n]=$u(i[n]);return e}return Ty(i)}function Gu(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(let e of i.slice(1))if(!Gu(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function hc(i,e="",n=null,s="fill"){if(i==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Gu(i)||(i=Nh(i));let c=i,f=!0;try{f=function(I){if(!fc(I))return I;let S=$u(I);return Fh(S),S=sm(S),S}(c)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(c,null,2)}
        `)}let p=null,y=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){y=xe[`filter_${s}`];let I=hl(f,y,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));p=(S,D,P)=>I.value.evaluate(S,D,{},P)}let x=null,w=null;if(f!==c){let I=hl(c,y,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));x=(S,D,P,O,F)=>I.value.evaluate(S,D,{},P,void 0,void 0,O,F),w=!rc(I.value.expression)}return{filter:p,dynamicFilter:x||void 0,needGeometry:am(f),needFeature:!!w}}function sm(i){if(!Array.isArray(i))return i;let e=function(n){if(ws.has(n[0])){for(let s=1;s<n.length;s++)if(fc(n[s]))return!0}return n}(i);return e===!0?e:e.map(n=>sm(n))}function Fh(i){let e=!1,n=[];if(i[0]==="case"){for(let s=1;s<i.length-1;s+=2)e=e||fc(i[s]),n.push(i[s+1]);n.push(i[i.length-1])}else if(i[0]==="match"){e=e||fc(i[1]);for(let s=2;s<i.length-1;s+=2)n.push(i[s+1]);n.push(i[i.length-1])}else if(i[0]==="step"){e=e||fc(i[1]);for(let s=1;s<i.length-1;s+=2)n.push(i[s+1])}e&&(i.length=0,i.push("any",...n));for(let s=1;s<i.length;s++)Fh(i[s])}function fc(i){if(!Array.isArray(i))return!1;if((e=i[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let n=1;n<i.length;n++)if(fc(i[n]))return!0;return!1}let ws=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Ob(i,e){return i<e?-1:i>e?1:0}function am(i){if(!Array.isArray(i))return!1;if(i[0]==="within"||i[0]==="distance")return!0;for(let e=1;e<i.length;e++)if(am(i[e]))return!0;return!1}function Nh(i){if(!i)return!0;let e=i[0];return i.length<=1?e!=="any":e==="=="?lm(i[1],i[2],"=="):e==="!="?zh(lm(i[1],i[2],"==")):e==="<"||e===">"||e==="<="||e===">="?lm(i[1],i[2],e):e==="any"?(n=i.slice(1),["any"].concat(n.map(Nh))):e==="all"?["all"].concat(i.slice(1).map(Nh)):e==="none"?["all"].concat(i.slice(1).map(Nh).map(zh)):e==="in"?Iy(i[1],i.slice(2)):e==="!in"?zh(Iy(i[1],i.slice(2))):e==="has"?Sy(i[1]):e!=="!has"||zh(Sy(i[1]));var n}function lm(i,e,n){switch(i){case"$type":return[`filter-type-${n}`,e];case"$id":return[`filter-id-${n}`,e];default:return[`filter-${n}`,i,e]}}function Iy(i,e){if(e.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(n=>typeof n!=typeof e[0])?["filter-in-large",i,["literal",e.sort(Ob)]]:["filter-in-small",i,["literal",e]]}}function Sy(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function zh(i){return["!",i]}let qu="";function pc(i,e){return e?`${i}${qu}${e}`:i}let Dy="-transition",Lb=new Set(["fill","line","background","hillshade","raster"]);class Lr extends il{constructor(e,n,s,c,f){if(super(),this.id=e.id,this.fqid=pc(this.id,s),this.type=e.type,this.scope=s,this.lut=c,this.options=f,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;let p=hl(this.filter,xe[`filter_${e.type}`]);p.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...p.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),n.layout&&(this._unevaluatedLayout=new Aa(n.layout,this.scope,f),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),n.paint){this._transitionablePaint=new Hu(n.paint,this.scope,f);for(let p in e.paint)this.setPaintProperty(p,e.paint[p]);for(let p in e.layout)this.setLayoutProperty(p,e.layout[p]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new as(n.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Lb.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,n){if(this.type==="custom"&&e==="visibility")return void(this.visibility=n);let s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(Dy)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,n){let s=this._transitionablePaint,c=s._properties.properties;if(e.endsWith(Dy)){let S=e.slice(0,-11);return c[S]&&s.setTransition(S,n||void 0),!1}if(!c[e])return!1;let f=s._values[e],p=f.value.isDataDriven(),y=f.value;s.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);let x=s._values[e].value,w=x.isDataDriven(),I=e.endsWith("pattern")||e==="line-dasharray";return w||p||I||this._handleOverridablePaintPropertyUpdate(e,y,x)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,n,s){return null}_handleOverridablePaintPropertyUpdate(e,n,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,n)}serialize(){return dn({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,n)=>!(e===void 0||n==="layout"&&!Object.keys(e).length||n==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(let e in this.paint._values){let n=this.paint.get(e);if(n instanceof pl&&Dh(n.property.specification)&&(n.value.kind==="source"||n.value.kind==="composite")&&n.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=hc(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,n,s,c,f,p,y,x,w){}}let kb={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Wu{constructor(e,n){this._structArray=e,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class si{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,n){return e._trim(),n&&n.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){let n=Object.create(this.prototype);return n.arrayBuffer=e.arrayBuffer,n.length=e.length,n.capacity=e.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function gn(i,e=1){let n=0,s=0;return{members:i.map(c=>{let f=kb[c.type].BYTES_PER_ELEMENT,p=n=cm(n,Math.max(e,f)),y=c.components||1;return s=Math.max(s,f),n+=f*y,{name:c.name,type:c.type,components:y,offset:p}}),size:cm(n,Math.max(s,e)),alignment:e}}function cm(i,e){return Math.ceil(i/e)*e}class ro extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let c=2*e;return this.int16[c+0]=n,this.int16[c+1]=s,e}}ro.prototype.bytesPerElement=4,gt(ro,"StructArrayLayout2i4");class mc extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=3*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.int16[f+2]=c,e}}mc.prototype.bytesPerElement=6,gt(mc,"StructArrayLayout3i6");class gc extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=4*e;return this.int16[p+0]=n,this.int16[p+1]=s,this.int16[p+2]=c,this.int16[p+3]=f,e}}gc.prototype.bytesPerElement=8,gt(gc,"StructArrayLayout4i8");class ml extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.float32[1*e+0]=n,e}}ml.prototype.bytesPerElement=4,gt(ml,"StructArrayLayout1f4");class um extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=4*e,p=2*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.float32[p+1]=c,e}}um.prototype.bytesPerElement=8,gt(um,"StructArrayLayout2i1f8");class dm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=4*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.int16[f+2]=c,e}}dm.prototype.bytesPerElement=8,gt(dm,"StructArrayLayout3i8");class Bh extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=5*e;return this.int16[y+0]=n,this.int16[y+1]=s,this.int16[y+2]=c,this.int16[y+3]=f,this.int16[y+4]=p,e}}Bh.prototype.bytesPerElement=10,gt(Bh,"StructArrayLayout5i10");class Vh extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=6*e,I=12*e,S=3*e;return this.int16[w+0]=n,this.int16[w+1]=s,this.uint8[I+4]=c,this.uint8[I+5]=f,this.uint8[I+6]=p,this.uint8[I+7]=y,this.float32[S+2]=x,e}}Vh.prototype.bytesPerElement=12,gt(Vh,"StructArrayLayout2i4ub1f12");class Ao extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=3*e;return this.float32[f+0]=n,this.float32[f+1]=s,this.float32[f+2]=c,e}}Ao.prototype.bytesPerElement=12,gt(Ao,"StructArrayLayout3f12");class Ma extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=6*e,x=3*e;return this.uint16[y+0]=n,this.uint16[y+1]=s,this.uint16[y+2]=c,this.uint16[y+3]=f,this.float32[x+2]=p,e}}Ma.prototype.bytesPerElement=12,gt(Ma,"StructArrayLayout4ui1f12");class _c extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=4*e;return this.uint16[p+0]=n,this.uint16[p+1]=s,this.uint16[p+2]=c,this.uint16[p+3]=f,e}}_c.prototype.bytesPerElement=8,gt(_c,"StructArrayLayout4ui8");class jh extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=6*e;return this.int16[x+0]=n,this.int16[x+1]=s,this.int16[x+2]=c,this.int16[x+3]=f,this.int16[x+4]=p,this.int16[x+5]=y,e}}jh.prototype.bytesPerElement=12,gt(jh,"StructArrayLayout6i12");class Uh extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D){let P=this.length;return this.resize(P+1),this.emplace(P,e,n,s,c,f,p,y,x,w,I,S,D)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P){let O=12*e;return this.int16[O+0]=n,this.int16[O+1]=s,this.int16[O+2]=c,this.int16[O+3]=f,this.uint16[O+4]=p,this.uint16[O+5]=y,this.uint16[O+6]=x,this.uint16[O+7]=w,this.int16[O+8]=I,this.int16[O+9]=S,this.int16[O+10]=D,this.int16[O+11]=P,e}}Uh.prototype.bytesPerElement=24,gt(Uh,"StructArrayLayout4i4ui4i24");class yc extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=10*e,w=5*e;return this.int16[x+0]=n,this.int16[x+1]=s,this.int16[x+2]=c,this.float32[w+2]=f,this.float32[w+3]=p,this.float32[w+4]=y,e}}yc.prototype.bytesPerElement=20,gt(yc,"StructArrayLayout3i3f20");class Ra extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=4*e;return this.float32[p+0]=n,this.float32[p+1]=s,this.float32[p+2]=c,this.float32[p+3]=f,e}}Ra.prototype.bytesPerElement=16,gt(Ra,"StructArrayLayout4f16");class hm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint32[1*e+0]=n,e}}hm.prototype.bytesPerElement=4,gt(hm,"StructArrayLayout1ul4");class Es extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let c=2*e;return this.uint16[c+0]=n,this.uint16[c+1]=s,e}}Es.prototype.bytesPerElement=4,gt(Es,"StructArrayLayout2ui4");class fm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P){let O=this.length;return this.resize(O+1),this.emplace(O,e,n,s,c,f,p,y,x,w,I,S,D,P)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O){let F=20*e,B=10*e;return this.int16[F+0]=n,this.int16[F+1]=s,this.int16[F+2]=c,this.int16[F+3]=f,this.int16[F+4]=p,this.float32[B+3]=y,this.float32[B+4]=x,this.float32[B+5]=w,this.float32[B+6]=I,this.int16[F+14]=S,this.uint32[B+8]=D,this.uint16[F+18]=P,this.uint16[F+19]=O,e}}fm.prototype.bytesPerElement=40,gt(fm,"StructArrayLayout5i4f1i1ul2ui40");class Hh extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=8*e;return this.int16[w+0]=n,this.int16[w+1]=s,this.int16[w+2]=c,this.int16[w+4]=f,this.int16[w+5]=p,this.int16[w+6]=y,this.int16[w+7]=x,e}}Hh.prototype.bytesPerElement=16,gt(Hh,"StructArrayLayout3i2i2i16");class vc extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=4*e,x=8*e;return this.float32[y+0]=n,this.float32[y+1]=s,this.float32[y+2]=c,this.int16[x+6]=f,this.int16[x+7]=p,e}}vc.prototype.bytesPerElement=16,gt(vc,"StructArrayLayout2f1f2i16");class xc extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=20*e,w=5*e;return this.uint8[x+0]=n,this.uint8[x+1]=s,this.float32[w+1]=c,this.float32[w+2]=f,this.float32[w+3]=p,this.float32[w+4]=y,e}}xc.prototype.bytesPerElement=20,gt(xc,"StructArrayLayout2ub4f20");class di extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=3*e;return this.uint16[f+0]=n,this.uint16[f+1]=s,this.uint16[f+2]=c,e}}di.prototype.bytesPerElement=6,gt(di,"StructArrayLayout3ui6");class bc extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H,X,Z,K,de){let ae=this.length;return this.resize(ae+1),this.emplace(ae,e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H,X,Z,K,de)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H,X,Z,K,de,ae){let ce=30*e,ge=15*e,ye=60*e;return this.int16[ce+0]=n,this.int16[ce+1]=s,this.int16[ce+2]=c,this.float32[ge+2]=f,this.float32[ge+3]=p,this.uint16[ce+8]=y,this.uint16[ce+9]=x,this.uint32[ge+5]=w,this.uint32[ge+6]=I,this.uint32[ge+7]=S,this.uint16[ce+16]=D,this.uint16[ce+17]=P,this.uint16[ce+18]=O,this.float32[ge+10]=F,this.float32[ge+11]=B,this.uint8[ye+48]=H,this.uint8[ye+49]=X,this.uint8[ye+50]=Z,this.uint32[ge+13]=K,this.int16[ce+28]=de,this.uint8[ye+58]=ae,e}}bc.prototype.bytesPerElement=60,gt(bc,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class pm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H,X,Z,K,de,ae,ce,ge,ye,ke,be,ze,et,Ve,We,Je,Oe){let Ze=this.length;return this.resize(Ze+1),this.emplace(Ze,e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H,X,Z,K,de,ae,ce,ge,ye,ke,be,ze,et,Ve,We,Je,Oe)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H,X,Z,K,de,ae,ce,ge,ye,ke,be,ze,et,Ve,We,Je,Oe,Ze){let we=20*e,Le=40*e,it=80*e;return this.float32[we+0]=n,this.float32[we+1]=s,this.int16[Le+4]=c,this.int16[Le+5]=f,this.int16[Le+6]=p,this.int16[Le+7]=y,this.int16[Le+8]=x,this.int16[Le+9]=w,this.int16[Le+10]=I,this.int16[Le+11]=S,this.int16[Le+12]=D,this.uint16[Le+13]=P,this.uint16[Le+14]=O,this.uint16[Le+15]=F,this.uint16[Le+16]=B,this.uint16[Le+17]=H,this.uint16[Le+18]=X,this.uint16[Le+19]=Z,this.uint16[Le+20]=K,this.uint16[Le+21]=de,this.uint16[Le+22]=ae,this.uint16[Le+23]=ce,this.uint16[Le+24]=ge,this.uint16[Le+25]=ye,this.uint16[Le+26]=ke,this.uint16[Le+27]=be,this.uint32[we+14]=ze,this.float32[we+15]=et,this.float32[we+16]=Ve,this.float32[we+17]=We,this.float32[we+18]=Je,this.uint8[it+76]=Oe,this.uint16[Le+39]=Ze,e}}pm.prototype.bytesPerElement=80,gt(pm,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class mm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=6*e;return this.float32[x+0]=n,this.float32[x+1]=s,this.float32[x+2]=c,this.float32[x+3]=f,this.float32[x+4]=p,this.float32[x+5]=y,e}}mm.prototype.bytesPerElement=24,gt(mm,"StructArrayLayout6f24");class gl extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=5*e;return this.float32[y+0]=n,this.float32[y+1]=s,this.float32[y+2]=c,this.float32[y+3]=f,this.float32[y+4]=p,e}}gl.prototype.bytesPerElement=20,gt(gl,"StructArrayLayout5f20");class gm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=7*e;return this.float32[w+0]=n,this.float32[w+1]=s,this.float32[w+2]=c,this.float32[w+3]=f,this.float32[w+4]=p,this.float32[w+5]=y,this.float32[w+6]=x,e}}gm.prototype.bytesPerElement=28,gt(gm,"StructArrayLayout7f28");class Zu extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S){let D=this.length;return this.resize(D+1),this.emplace(D,e,n,s,c,f,p,y,x,w,I,S)}emplace(e,n,s,c,f,p,y,x,w,I,S,D){let P=11*e;return this.float32[P+0]=n,this.float32[P+1]=s,this.float32[P+2]=c,this.float32[P+3]=f,this.float32[P+4]=p,this.float32[P+5]=y,this.float32[P+6]=x,this.float32[P+7]=w,this.float32[P+8]=I,this.float32[P+9]=S,this.float32[P+10]=D,e}}Zu.prototype.bytesPerElement=44,gt(Zu,"StructArrayLayout11f44");class _m extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,s,c,f,p,y,x,w)}emplace(e,n,s,c,f,p,y,x,w,I){let S=9*e;return this.float32[S+0]=n,this.float32[S+1]=s,this.float32[S+2]=c,this.float32[S+3]=f,this.float32[S+4]=p,this.float32[S+5]=y,this.float32[S+6]=x,this.float32[S+7]=w,this.float32[S+8]=I,e}}_m.prototype.bytesPerElement=36,gt(_m,"StructArrayLayout9f36");class Pa extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let c=2*e;return this.float32[c+0]=n,this.float32[c+1]=s,e}}Pa.prototype.bytesPerElement=8,gt(Pa,"StructArrayLayout2f8");class ym extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=6*e;return this.uint32[3*e+0]=n,this.uint16[p+2]=s,this.uint16[p+3]=c,this.uint16[p+4]=f,e}}ym.prototype.bytesPerElement=12,gt(ym,"StructArrayLayout1ul3ui12");class vm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint16[1*e+0]=n,e}}vm.prototype.bytesPerElement=2,gt(vm,"StructArrayLayout1ui2");class $h extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B){let H=this.length;return this.resize(H+1),this.emplace(H,e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H){let X=16*e;return this.float32[X+0]=n,this.float32[X+1]=s,this.float32[X+2]=c,this.float32[X+3]=f,this.float32[X+4]=p,this.float32[X+5]=y,this.float32[X+6]=x,this.float32[X+7]=w,this.float32[X+8]=I,this.float32[X+9]=S,this.float32[X+10]=D,this.float32[X+11]=P,this.float32[X+12]=O,this.float32[X+13]=F,this.float32[X+14]=B,this.float32[X+15]=H,e}}$h.prototype.bytesPerElement=64,gt($h,"StructArrayLayout16f64");class wc extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=10*e,I=5*e;return this.uint16[w+0]=n,this.uint16[w+1]=s,this.uint16[w+2]=c,this.uint16[w+3]=f,this.float32[I+2]=p,this.float32[I+3]=y,this.float32[I+4]=x,e}}wc.prototype.bytesPerElement=20,gt(wc,"StructArrayLayout4ui3f20");class xm extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.int16[1*e+0]=n,e}}xm.prototype.bytesPerElement=2,gt(xm,"StructArrayLayout1i2");class Gh extends si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint8[1*e+0]=n,e}}Gh.prototype.bytesPerElement=1,gt(Gh,"StructArrayLayout1ub1");class bm extends Wu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}bm.prototype.size=40;class Cy extends fm{get(e){return new bm(this,e)}}gt(Cy,"CollisionBoxArray");class qh extends Wu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}qh.prototype.size=60;class Xu extends bc{get(e){return new qh(this,e)}}gt(Xu,"PlacedSymbolArray");class wm extends Wu{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}wm.prototype.size=80;class Ay extends pm{get(e){return new wm(this,e)}}gt(Ay,"SymbolInstanceArray");class Em extends ml{getoffsetX(e){return this.float32[1*e+0]}}gt(Em,"GlyphOffsetArray");class My extends ro{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}gt(My,"SymbolLineVertexArray");class Wh extends Wu{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Wh.prototype.size=12;class Ry extends ym{get(e){return new Wh(this,e)}}gt(Ry,"FeatureIndexArray");class Py extends Es{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}gt(Py,"FillExtrusionCentroidArray");class Oy extends Wu{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Oy.prototype.size=6;class Ly extends mc{get(e){return new Oy(this,e)}}gt(Ly,"FillExtrusionWallArray");let ky=gn([{name:"a_pos",components:2,type:"Int16"}],4),Fb=gn([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Nb=gn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class gi{constructor(e=[]){this.segments=e}_prepareSegment(e,n,s,c){let f=this.segments[this.segments.length-1];return e>gi.MAX_VERTEX_ARRAY_LENGTH&&fn(`Max vertices per segment is ${gi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!f||f.vertexLength+e>gi.MAX_VERTEX_ARRAY_LENGTH||f.sortKey!==c)&&(f={vertexOffset:n,primitiveOffset:s,vertexLength:0,primitiveLength:0},c!==void 0&&(f.sortKey=c),this.segments.push(f)),f}prepareSegment(e,n,s,c){return this._prepareSegment(e,n.length,s.length,c)}get(){return this.segments}destroy(){for(let e of this.segments)for(let n in e.vaos)e.vaos[n].destroy()}static simpleSegment(e,n,s,c){return new gi([{vertexOffset:e,primitiveOffset:n,vertexLength:s,primitiveLength:c,vaos:{},sortKey:0}])}}function Fy(i,e){return 256*(i=ne(Math.floor(i),0,255))+ne(Math.floor(e),0,255)}gi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,gt(gi,"SegmentVector");let zb=gn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Tm=gn([{name:"a_pattern_b",components:4,type:"Uint16"}]),Bb=gn([{name:"a_dash",components:4,type:"Uint16"}]);class Yu{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,n,s,c){this.ids.push(Ku(e)),this.positions.push(n,s,c)}eachPosition(e,n){let s=Ku(e),c=0,f=this.ids.length-1;for(;c<f;){let p=c+f>>1;this.ids[p]>=s?f=p:c=p+1}for(;this.ids[c]===s;)n(this.positions[3*c],this.positions[3*c+1],this.positions[3*c+2]),c++}static serialize(e,n){let s=new Float64Array(e.ids),c=new Uint32Array(e.positions);return Im(s,c,0,s.length-1),n&&(n.add(s.buffer),n.add(c.buffer)),{ids:s,positions:c}}static deserialize(e){let n=new Yu,s;n.ids=e.ids,n.positions=e.positions;for(let c of n.ids)c!==s&&n.uniqueIds.push(c),s=c;return n.indexed=!0,n}}function Ku(i){let e=+i;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Zl(String(i))}function Im(i,e,n,s){for(;n<s;){let c=i[n+s>>1],f=n-1,p=s+1;for(;;){do f++;while(i[f]<c);do p--;while(i[p]>c);if(f>=p)break;Zh(i,f,p),Zh(e,3*f,3*p),Zh(e,3*f+1,3*p+1),Zh(e,3*f+2,3*p+2)}p-n<s-p?(Im(i,e,n,p),n=p+1):(Im(i,e,p+1,s),s=p)}}function Zh(i,e,n){let s=i[e];i[e]=i[n],i[n]=s}gt(Yu,"FeaturePositionMap");class Ko{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,n),this.initialized=!0),!!this.location}set(e,n,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Xh extends Ko{constructor(e){super(e),this.current=0}set(e,n,s){this.fetchUniformLocation(e,n)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class Hi extends Ko{constructor(e){super(e),this.current=0}set(e,n,s){this.fetchUniformLocation(e,n)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class Ts extends Ko{constructor(e){super(e),this.current=[0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class Ec extends Ko{constructor(e){super(e),this.current=[0,0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class Ju extends Ko{constructor(e){super(e),this.current=[0,0,0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class Sm extends Ko{constructor(e){super(e),this.current=Ln.transparent.toPremultipliedRenderColor(null)}set(e,n,s){this.fetchUniformLocation(e,n)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}let Ny=new Float32Array(16);class Qu extends Ko{constructor(e){super(e),this.current=Ny}set(e,n,s){if(this.fetchUniformLocation(e,n)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let c=1;c<16;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}let Vb=new Float32Array(9),zy=new Float32Array(4);class Dm extends Ko{constructor(e){super(e),this.current=zy}set(e,n,s){if(this.fetchUniformLocation(e,n)){for(let c=0;c<4;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function Cm(i){return[Fy(255*i.r,255*i.g),Fy(255*i.b,255*i.a)]}class ed{constructor(e,n,s,c){this.value=e,this.uniformNames=n.map(f=>`u_${f}`),this.type=s,this.context=c}setUniform(e,n,s,c,f){let p=c.constantOr(this.value);n.set(e,f,p instanceof Ln?p.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):p)}getBinding(e,n){return this.type==="color"?new Sm(e):new Hi(e)}}class Tc{constructor(e,n){this.uniformNames=n.map(s=>`u_${s}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,n){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=n?n.tl.concat(n.br):this.pattern}setUniform(e,n,s,c,f){let p=null;f!=="u_pattern"&&f!=="u_dash"||(p=this.pattern),f==="u_pattern_b"&&(p=this.patternTransition),f==="u_pixel_ratio"&&(p=this.pixelRatio),p&&n.set(e,f,p)}getBinding(e,n){return n==="u_pattern"||n==="u_pattern_b"||n==="u_dash"?new Ju(e):new Hi(e)}}class Gs{constructor(e,n,s,c){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=n.map(f=>({name:`a_${f}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new c}populatePaintArray(e,n,s,c,f,p,y,x){let w=this.paintVertexArray.length,I=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new Un(0,{brightness:p,worldview:x}),n,{},f,c,y):this.expression.kind==="constant"&&this.expression.value,S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Un(0,{brightness:p,worldview:x}),n,{},f,c,y):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(w,e,I,S?null:this.context.lut)}updatePaintArray(e,n,s,c,f,p,y,x){let w=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:y,worldview:x},s,c,void 0,f):this.expression.kind==="constant"&&this.expression.value,I=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Un(0,{brightness:y,worldview:x}),s,c,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,n,w,I?null:this.context.lut)}_setPaintValue(e,n,s,c){if(this.type==="color"){let f=Cm(s.toPremultipliedRenderColor(c));for(let p=e;p<n;p++)this.paintVertexArray.emplace(p,f[0],f[1])}else{for(let f=e;f<n;f++)this.paintVertexArray.emplace(f,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Jo{constructor(e,n,s,c,f,p){this.expression=e,this.uniformNames=n.map(y=>`u_${y}_t`),this.type=s,this.useIntegerZoom=c,this.context=f,this.maxValue=0,this.paintVertexAttributes=n.map(y=>({name:`a_${y}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new p}populatePaintArray(e,n,s,c,f,p,y,x){let w=this.expression.evaluate(new Un(this.context.zoom,{brightness:p,worldview:x}),n,{},f,c,y),I=this.expression.evaluate(new Un(this.context.zoom+1,{brightness:p,worldview:x}),n,{},f,c,y),S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Un(0,{brightness:p,worldview:x}),n,{},f,c,y):this.lutExpression.value)==="none",D=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(D,e,w,I,S?null:this.context.lut)}updatePaintArray(e,n,s,c,f,p,y,x){let w=this.expression.evaluate({zoom:this.context.zoom,brightness:y,worldview:x},s,c,void 0,f),I=this.expression.evaluate({zoom:this.context.zoom+1,brightness:y,worldview:x},s,c,void 0,f),S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Un(0,{brightness:y,worldview:x}),s,c,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,n,w,I,S?null:this.context.lut)}_setPaintValue(e,n,s,c,f){if(this.type==="color"){let p=Cm(s.toPremultipliedRenderColor(f)),y=Cm(s.toPremultipliedRenderColor(f));for(let x=e;x<n;x++)this.paintVertexArray.emplace(x,p[0],p[1],y[0],y[1])}else{for(let p=e;p<n;p++)this.paintVertexArray.emplace(p,s,c);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(c))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,n,s,c,f){let p=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,y=ne(this.expression.interpolationFactor(p,this.context.zoom,this.context.zoom+1),0,1);n.set(e,f,y)}getBinding(e,n){return new Hi(e)}}class Mo{constructor(e,n,s,c,f){this.expression=e,this.layerId=f,this.paintVertexAttributes=(s==="array"?Bb:zb).members;for(let p=0;p<n.length;++p);this.paintVertexArray=new c,this.paintTransitionVertexArray=new _c}populatePaintArray(e,n,s,c){let f=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(f,e,n.patterns&&n.patterns[this.layerId],s)}updatePaintArray(e,n,s,c,f,p,y){this._setPaintValues(e,n,s.patterns&&s.patterns[this.layerId],p)}_setPaintValues(e,n,s,c){if(!c||!s)return;let f=c[s[0]],p=c[s[1]];if(f){if(f){let{tl:y,br:x,pixelRatio:w}=f;for(let I=e;I<n;I++)this.paintVertexArray.emplace(I,y[0],y[1],x[0],x[1],w)}if(p){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);let{tl:y,br:x}=p;for(let w=e;w<n;w++)this.paintTransitionVertexArray.emplace(w,y[0],y[1],x[0],x[1])}}}upload(e){let n=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,n)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Tm.members,n))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Ur{constructor(e,n,s=()=>!0){this.binders={},this._buffers=[],this.context=n;let c=[];for(let f in e.paint._values){let p=e.paint.get(f);if(f.endsWith("-use-theme")||!s(f)||!(p instanceof pl&&Dh(p.property.specification)))continue;let y=Ub(f,e.type),x=p.value,w=p.property.specification.type,I=!!p.property.useIntegerZoom,S=f==="line-dasharray"||f.endsWith("pattern"),D=e.paint.get(`${f}-use-theme`),P=f==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||D&&D.value.kind!=="constant";if(x.kind!=="constant"||P)if(x.kind==="source"||P||S){let O=By(f,w,"source");this.binders[f]=S?new Mo(x,y,w,O,e.id):new Gs(x,y,w,O),c.push(`/a_${f}`)}else{let O=By(f,w,"composite");this.binders[f]=new Jo(x,y,w,I,n,O),c.push(`/z_${f}`)}else this.binders[f]=S?new Tc(x.value,y):new ed(x.value,y,w,n),c.push(`/u_${f}`);D&&(this.binders[f].lutExpression=D.value)}this.cacheKey=c.sort().join("")}getMaxValue(e){let n=this.binders[e];return n instanceof Gs||n instanceof Jo?n.maxValue:0}populatePaintArrays(e,n,s,c,f,p,y,x){for(let w in this.binders){let I=this.binders[w];I.context=this.context,(I instanceof Gs||I instanceof Jo||I instanceof Mo)&&I.populatePaintArray(e,n,s,c,f,p,y,x)}}setConstantPatternPositions(e,n){for(let s in this.binders){let c=this.binders[s];c instanceof Tc&&c.setConstantPatternPositions(e,n)}}getPatternTransitionVertexBuffer(e){let n=this.binders[e];return n instanceof Mo?n.paintTransitionVertexBuffer:null}updatePaintArrays(e,n,s,c,f,p,y,x,w,I){let S=!1,D=Object.keys(e),P=D.length!==0&&!x,O=P?D:n.uniqueIds;this.context.lut=f.lut;for(let F in this.binders){let B=this.binders[F];if(B.context=this.context,(B instanceof Gs||B instanceof Jo||B instanceof Mo)&&B.expression&&B.expression.kind&&B.expression.kind!=="constant"&&(B.expression.isStateDependent===!0||B.expression.isLightConstant===!1)){let H=f.paint.get(F);B.expression=H.value;for(let X of O){let Z=e[X.toString()];n.eachPosition(X,(K,de,ae)=>{let ce=c.feature(K);B.updatePaintArray(de,ae,ce,Z,p,y,w,I)})}if(!P)for(let X of s.uniqueIds){let Z=e[X.toString()];s.eachPosition(X,(K,de,ae)=>{let ce=c.feature(K);B.updatePaintArray(de,ae,ce,Z,p,y,w,I)})}S=!0}}return S}defines(){let e=[];for(let n in this.binders){let s=this.binders[n];(s instanceof ed||s instanceof Tc)&&e.push(...s.uniformNames.map(c=>`#define HAS_UNIFORM_${c}`))}return e}getBinderAttributes(){let e=[];for(let n in this.binders){let s=this.binders[n];if(s instanceof Gs||s instanceof Jo||s instanceof Mo)for(let c=0;c<s.paintVertexAttributes.length;c++)e.push(s.paintVertexAttributes[c].name);if(s instanceof Mo)for(let c=0;c<Tm.members.length;c++)e.push(Tm.members[c].name)}return e}getBinderUniforms(){let e=[];for(let n in this.binders){let s=this.binders[n];if(s instanceof ed||s instanceof Tc||s instanceof Jo)for(let c of s.uniformNames)e.push(c)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){let n=[];for(let s in this.binders){let c=this.binders[s];if(c instanceof ed||c instanceof Tc||c instanceof Jo)for(let f of c.uniformNames)n.push({name:f,property:s,binding:c.getBinding(e,f)})}return n}setUniforms(e,n,s,c,f){for(let{name:p,property:y,binding:x}of s)this.binders[y].setUniform(e,x,f,c.get(y),p)}updatePaintBuffers(){this._buffers=[];for(let e in this.binders){let n=this.binders[e];(n instanceof Gs||n instanceof Jo||n instanceof Mo)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer),n instanceof Mo&&n.paintTransitionVertexBuffer&&this._buffers.push(n.paintTransitionVertexBuffer)}}upload(e){for(let n in this.binders){let s=this.binders[n];(s instanceof Gs||s instanceof Jo||s instanceof Mo)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(let e in this.binders){let n=this.binders[e];(n instanceof Gs||n instanceof Jo||n instanceof Mo)&&n.destroy()}}}class Ro{constructor(e,n,s=()=>!0){this.programConfigurations={};for(let c of e)this.programConfigurations[c.id]=new Ur(c,n,s);this.needsUpload=!1,this._featureMap=new Yu,this._featureMapWithoutIds=new Yu,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,n,s,c,f,p,y,x,w){for(let I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(e,n,c,f,p,y,x,w);n.id!==void 0?this._featureMap.add(n.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,n,s,c,f,p,y,x){for(let w of s)this.needsUpload=this.programConfigurations[w.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,n,w,c,f,p,y||0,x)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(let n in this.programConfigurations)this.programConfigurations[n].upload(e);this.needsUpload=!1}}destroy(){for(let e in this.programConfigurations)this.programConfigurations[e].destroy()}}let jb={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function Ub(i,e){return jb[i]||[i.replace(`${e}-`,"").replace(/-/g,"_")]}let Hb={"line-pattern":{source:Ma,composite:Ma},"fill-pattern":{source:Ma,composite:Ma},"fill-extrusion-pattern":{source:Ma,composite:Ma},"line-dasharray":{source:_c,composite:_c}},$b={color:{source:Pa,composite:Ra},number:{source:ml,composite:Pa}};function By(i,e,n){let s=Hb[i];return s&&s[n]||$b[e][n]}gt(ed,"ConstantBinder"),gt(Tc,"PatternConstantBinder"),gt(Gs,"SourceExpressionBinder"),gt(Mo,"PatternCompositeBinder"),gt(Jo,"CompositeExpressionBinder"),gt(Ur,"ProgramConfiguration",{omit:["_buffers"]}),gt(Ro,"ProgramConfigurationSet");let kr=st/Math.PI/2,Vy=5,u=6,t=16383,o=64,h=[o,32,16],g=-kr,_=kr;function v(i,e,n,s=kr){return n=Sn(n),[i*Math.sin(n)*s,-e*s,i*Math.cos(n)*s]}function E(i,e,n){return v(Math.cos(Sn(i)),Math.sin(Sn(i)),e,n)}let T=63710088e-1,C=2*Math.PI*T;class A{constructor(e,n){if(isNaN(e)||isNaN(n))throw new Error(`Invalid LngLat object: (${e}, ${n})`);if(this.lng=+e,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new A(Ae(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){let n=Math.PI/180,s=this.lat*n,c=e.lat*n,f=Math.sin(s)*Math.sin(c)+Math.cos(s)*Math.cos(c)*Math.cos((e.lng-this.lng)*n);return T*Math.acos(Math.min(f,1))}toBounds(e=0){let n=360*e/40075017,s=n/Math.cos(Math.PI/180*this.lat);return new L({lng:this.lng-s,lat:this.lat-n},{lng:this.lng+s,lat:this.lat+n})}toEcef(e){return E(this.lat,this.lng,kr+e*kr/T)}static convert(e){if(e instanceof A)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new A(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new A(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class L{constructor(e,n){if(e)if(n)this.setSouthWest(e).setNorthEast(n);else if(e.length===4){let s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{let s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof A?new A(e.lng,e.lat):A.convert(e),this}setSouthWest(e){return this._sw=e instanceof A?new A(e.lng,e.lat):A.convert(e),this}extend(e){let n=this._sw,s=this._ne,c,f;if(e instanceof A)c=e,f=e;else{if(!(e instanceof L))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(L.convert(e)):this.extend(A.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(A.convert(e)):this;if(c=e._sw,f=e._ne,!c||!f)return this}return n||s?(n.lng=Math.min(c.lng,n.lng),n.lat=Math.min(c.lat,n.lat),s.lng=Math.max(f.lng,s.lng),s.lat=Math.max(f.lat,s.lat)):(this._sw=new A(c.lng,c.lat),this._ne=new A(f.lng,f.lat)),this}getCenter(){return new A((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new A(this.getWest(),this.getNorth())}getSouthEast(){return new A(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){let{lng:n,lat:s}=A.convert(e),c=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(c=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&c}static convert(e){if(e)return e instanceof L?e:new L(e)}}let R=0,k=25.5;function V(i){return C*Math.cos(i*Math.PI/180)}function z(i){return(180+i)/360}function U(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function j(i,e){return i/V(e)}function W(i){return 360*i-180}function Y(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}function J(i,e){return i*V(Y(e))}let ie=85.051129;function le(i){return Math.cos(Sn(ne(i,-ie,ie)))}function ue(i,e){let n=ne(e,R,k),s=Math.pow(2,n);return le(i)*C/(512*s)}function re(i){return 1/Math.cos(i*Math.PI/180)}function oe(i,e=0){let n=Math.exp(Math.PI*(1-(i.y+e/st)/(1<<i.z)*2));return 80150034*n/(n*n+1)/st/(1<<i.z)}class se{constructor(e,n,s=0){this.x=+e,this.y=+n,this.z=+s}static fromLngLat(e,n=0){let s=A.convert(e);return new se(z(s.lng),U(s.lat),j(n,s.lat))}toLngLat(){return new A(W(this.x),Y(this.y))}toAltitude(){return J(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/C*re(Y(this.y))}}function Ee(i,e,n,s,c,f,p,y,x){let w=(e+s)/2,I=(n+c)/2,S=new Xe(w,I);y(S),function(D,P,O,F,B,H){let X=O-B,Z=F-H;return Math.abs((F-P)*X-(O-D)*Z)/Math.hypot(X,Z)}(S.x,S.y,f.x,f.y,p.x,p.y)>=x?(Ee(i,e,n,w,I,f,S,y,x),Ee(i,w,I,s,c,S,p,y,x)):i.push(p)}function me(i,e,n){let s=i[0],c=s.x,f=s.y;e(s);let p=[s];for(let y=1;y<i.length;y++){let x=i[y],{x:w,y:I}=x;e(x),Ee(p,c,f,w,I,s,x,e,n),c=w,f=I,s=x}return p}function Ne(i,e,n,s){if(s(e,n)){let c=e.add(n)._mult(.5);Ne(i,e,c,s),Ne(i,c,n,s)}else i.push(n)}function Ce(i,e){let n=i[0],s=[n];for(let c=1;c<i.length;c++){let f=i[c];Ne(s,n,f,e),n=f}return s}let Be=Math.pow(2,14)-1,Qe=-Be-1;function Te(i,e){let n=Math.round(i.x*e),s=Math.round(i.y*e);return i.x=ne(n,Qe,Be),i.y=ne(s,Qe,Be),(n<i.x||n>i.x+1||s<i.y||s>i.y+1)&&fn("Geometry exceeds allowed extent, reduce your vector tile buffer size"),i}function pe(i,e,n){let s=i.loadGeometry(),c=i.extent,f=st/c;if(e&&n&&n.projection.isReprojectedInTileSpace){let p=1<<e.z,{scale:y,x,y:w,projection:I}=n,S=D=>{let P=W((e.x+D.x/c)/p),O=Y((e.y+D.y/c)/p),F=I.project(P,O);D.x=(F.x*y-x)*c,D.y=(F.y*y-w)*c};for(let D=0;D<s.length;D++)if(i.type!==1)s[D]=me(s[D],S,1);else{let P=[];for(let O of s[D])O.x<0||O.x>=c||O.y<0||O.y>=c||(S(O),P.push(O));s[D]=P}}for(let p of s)for(let y of p)Te(y,f);return s}function Pe(i,e){return{type:i.type,id:i.id,properties:i.properties,geometry:e?pe(i):[]}}class Ie{constructor(e,n,s,c,f){this.properties={},this.extent=s,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=c,this._values=f,e.readFields(He,this,n)}loadGeometry(){let e=this._pbf;e.pos=this._geometry;let n=e.readVarint()+e.pos,s=[],c,f=1,p=0,y=0,x=0;for(;e.pos<n;){if(p<=0){let w=e.readVarint();f=7&w,p=w>>3}if(p--,f===1||f===2)y+=e.readSVarint(),x+=e.readSVarint(),f===1&&(c&&s.push(c),c=[]),c&&c.push(new Xe(y,x));else{if(f!==7)throw new Error(`unknown command ${f}`);c&&c.push(c[0].clone())}}return c&&s.push(c),s}bbox(){let e=this._pbf;e.pos=this._geometry;let n=e.readVarint()+e.pos,s=1,c=0,f=0,p=0,y=1/0,x=-1/0,w=1/0,I=-1/0;for(;e.pos<n;){if(c<=0){let S=e.readVarint();s=7&S,c=S>>3}if(c--,s===1||s===2)f+=e.readSVarint(),p+=e.readSVarint(),f<y&&(y=f),f>x&&(x=f),p<w&&(w=p),p>I&&(I=p);else if(s!==7)throw new Error(`unknown command ${s}`)}return[y,w,x,I]}toGeoJSON(e,n,s){let c=this.extent*Math.pow(2,s),f=this.extent*e,p=this.extent*n,y=this.loadGeometry();function x(D){return[360*(D.x+f)/c-180,360/Math.PI*Math.atan(Math.exp((1-2*(D.y+p)/c)*Math.PI))-90]}function w(D){return D.map(x)}let I;if(this.type===1){let D=[];for(let O of y)D.push(O[0]);let P=w(D);I=D.length===1?{type:"Point",coordinates:P[0]}:{type:"MultiPoint",coordinates:P}}else if(this.type===2){let D=y.map(w);I=D.length===1?{type:"LineString",coordinates:D[0]}:{type:"MultiLineString",coordinates:D}}else{if(this.type!==3)throw new Error("unknown feature type");{let D=function(O){let F=O.length;if(F<=1)return[O];let B=[],H,X;for(let Z=0;Z<F;Z++){let K=$e(O[Z]);K!==0&&(X===void 0&&(X=K<0),X===K<0?(H&&B.push(H),H=[O[Z]]):H&&H.push(O[Z]))}return H&&B.push(H),B}(y),P=[];for(let O of D)P.push(O.map(w));I=P.length===1?{type:"Polygon",coordinates:P[0]}:{type:"MultiPolygon",coordinates:P}}}let S={type:"Feature",geometry:I,properties:this.properties};return this.id!=null&&(S.id=this.id),S}}function He(i,e,n){i===1?e.id=n.readVarint():i===2?function(s,c){let f=s.readVarint()+s.pos;for(;s.pos<f;){let p=c._keys[s.readVarint()],y=c._values[s.readVarint()];c.properties[p]=y}}(n,e):i===3?e.type=n.readVarint():i===4&&(e._geometry=n.pos)}function $e(i){let e=0;for(let n,s,c=0,f=i.length,p=f-1;c<f;p=c++)n=i[c],s=i[p],e+=(s.x-n.x)*(n.y+s.y);return e}Ie.types=["Unknown","Point","LineString","Polygon"];class qe{constructor(e,n){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(ot,this,n),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];let n=this._pbf.readVarint()+this._pbf.pos;return new Ie(this._pbf,n,this.extent,this._keys,this._values)}}function ot(i,e,n){i===15?e.version=n.readVarint():i===1?e.name=n.readString():i===5?e.extent=n.readVarint():i===2?e._features.push(n.pos):i===3?e._keys.push(n.readString()):i===4&&e._values.push(function(s){let c=null,f=s.readVarint()+s.pos;for(;s.pos<f;){let p=s.readVarint()>>3;c=p===1?s.readString():p===2?s.readFloat():p===3?s.readDouble():p===4?s.readVarint64():p===5?s.readVarint():p===6?s.readSVarint():p===7?s.readBoolean():null}if(c==null)throw new Error("unknown feature value");return c}(n))}class xt{constructor(e,n){this.layers=e.readFields(St,{},n)}}function St(i,e,n){if(i===3){let s=new qe(n,n.readVarint()+n.pos);s.length&&(e[s.name]=s)}}let dt="3d_elevation_id",Tt="level";class wt{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,n){return this._valid&&e(n(this._geometry)),this}require(e,n,s){return this.get(e,!0,n,s)}optional(e,n,s){return this.get(e,!1,n,s)}success(){return this._valid}get(e,n,s,c){let f=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&f!==void 0&&!Number.isNaN(f)?s(c?c(f):f):n&&(this._valid=!1),this}}class zt{constructor(e,n){this.featureFunc=e,this.vertexFunc=n}parseFeature(e,n,s){return this.featureFunc(e,n,s)}parseVertex(e,n,s){return this.vertexFunc(e,n,s)}}let qt=new zt((i,e,n)=>i.reset(e).require(dt,s=>{n.id=s}).optional("fixed_height_relative",s=>{n.constantHeight=s},bn.decodeRelativeHeight).geometry(s=>{n.bounds=s},Ep).success(),(i,e,n)=>i.reset(e).require(dt,s=>{n.id=s}).require("elevation_idx",s=>{n.idx=s}).require("extent",s=>{n.extent=s}).require("height_relative",s=>{n.height=s},bn.decodeRelativeHeight).geometry(s=>{n.position=s},bn.getPoint).success()),on=new zt((i,e,n)=>i.reset(e).require(dt,s=>{n.id=s}).optional("fixed_height",s=>{n.constantHeight=s},bn.decodeMetricHeight).geometry(s=>{n.bounds=s},Ep).success(),(i,e,n)=>i.reset(e).require(dt,s=>{n.id=s}).require("elevation_idx",s=>{n.idx=s}).require("extent",s=>{n.extent=s}).require("height",s=>{n.height=s},bn.decodeMetricHeight).geometry(s=>{n.position=s},bn.getPoint).success());class bn{static getPoint(e){return Eo(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){let n=[],s=[],c=e.length,f=new wt;for(let y=0;y<c;y++){let x=e.feature(y),w=x.properties.version,I=(p=w)?p==="1.0.1"?on:void 0:qt;if(I===void 0){fn(`Unknown elevation feature version number ${w||"(unknown)"}`);continue}let S=x.properties.hasOwnProperty("type")?x.properties.type:void 0;if(S){if(Ie.types[x.type]==="Point"&&S==="curve_point"){let D={};I.parseVertex(f,x,D)&&n.push(D)}else if(Ie.types[x.type]==="Polygon"&&S==="curve_meta"){let D={};I.parseFeature(f,x,D)&&s.push(D)}}}var p;return{vertices:n,features:s}}}class Ht{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,s){let c=ui(n,this.dir);if(Math.abs(c)<1e-6)return!1;let f=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1])/c;return s[0]=this.pos[0]+this.dir[0]*f,s[1]=this.pos[1]+this.dir[1]*f,!0}}class wn{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,s){let c=Fi(n,this.dir);if(Math.abs(c)<1e-6)return!1;let f=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1]+(e[2]-this.pos[2])*n[2])/c;return s[0]=this.pos[0]+this.dir[0]*f,s[1]=this.pos[1]+this.dir[1]*f,s[2]=this.pos[2]+this.dir[2]*f,!0}closestPointOnSphere(e,n,s){if(function(P,O){var F=P[0],B=P[1],H=P[2],X=O[0],Z=O[1],K=O[2];return Math.abs(F-X)<=M*Math.max(1,Math.abs(F),Math.abs(X))&&Math.abs(B-Z)<=M*Math.max(1,Math.abs(B),Math.abs(Z))&&Math.abs(H-K)<=M*Math.max(1,Math.abs(H),Math.abs(K))}(this.pos,e)||n===0)return s[0]=s[1]=s[2]=0,!1;let[c,f,p]=this.dir,y=this.pos[0]-e[0],x=this.pos[1]-e[1],w=this.pos[2]-e[2],I=c*c+f*f+p*p,S=2*(y*c+x*f+w*p),D=S*S-4*I*(y*y+x*x+w*w-n*n);if(D<0){let P=Math.max(-S/2,0),O=y+c*P,F=x+f*P,B=w+p*P,H=Math.hypot(O,F,B);return s[0]=O*n/H,s[1]=F*n/H,s[2]=B*n/H,!1}{let P=(-S-Math.sqrt(D))/(2*I);if(P<0){let O=Math.hypot(y,x,w);return s[0]=y*n/O,s[1]=x*n/O,s[2]=w*n/O,!1}return s[0]=y+c*P,s[1]=x+f*P,s[2]=w+p*P,!0}}}class Dn{constructor(e,n,s,c,f){this.TL=e,this.TR=n,this.BR=s,this.BL=c,this.horizon=f}static fromInvProjectionMatrix(e,n,s){let c=[-1,1,1],f=[1,1,1],p=[1,-1,1],y=[-1,-1,1],x=Ni(c,c,e),w=Ni(f,f,e),I=Ni(p,p,e),S=Ni(y,y,e);return new Dn(x,w,I,S,n/s)}}function Xn(i,e,n){let s=1/0,c=-1/0,f=[];for(let p of i){zi(f,p,e);let y=Fi(f,n);s=Math.min(s,y),c=Math.max(c,y)}return[s,c]}function tn(i,e){let n=!0;for(let s=0;s<i.planes.length;s++){let c=i.planes[s],f=0;for(let p=0;p<e.length;p++)f+=Fi(c,e[p])+c[3]>=0;if(f===0)return 0;f!==e.length&&(n=!1)}return n?2:1}function En(i,e){for(let n of i.projections){let s=Xn(e,i.points[0],n.axis);if(n.projection[1]<s[0]||n.projection[0]>s[1])return 0}return 1}function Tn(i,e){let n=0,s=[0,0,0,0];for(let p=0;p<i.length;p++)s[0]=i[p][0],s[1]=i[p][1],s[2]=i[p][2],s[3]=1,(c=s)[0]*(f=e)[0]+c[1]*f[1]+c[2]*f[2]+c[3]*f[3]>=0&&n++;var c,f;return n}class Mn{constructor(e,n){this.points=e||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=sn.fromPoints(this.points),this.projections=[],this.frustumEdges=[zi([],this.points[2],this.points[3]),zi([],this.points[0],this.points[3]),zi([],this.points[4],this.points[0]),zi([],this.points[5],this.points[1]),zi([],this.points[6],this.points[2]),zi([],this.points[7],this.points[3])];for(let s of this.frustumEdges){let c=[0,-s[2],s[1]],f=[s[2],0,-s[0]];this.projections.push({axis:c,projection:Xn(this.points,this.points[0],c)}),this.projections.push({axis:f,projection:Xn(this.points,this.points[0],f)})}}static fromInvProjectionMatrix(e,n,s,c){let f=Math.pow(2,s),p=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(w=>{let I=co([],w,e),S=1/I[3]/n*f;return(D=I)[0]=(P=I)[0]*(O=[S,S,c?1/I[3]:S,S])[0],D[1]=P[1]*O[1],D[2]=P[2]*O[2],D[3]=P[3]*O[3],D;var D,P,O}),y=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(w=>{let I=ci([],Zi([],zi([],p[w[0]],p[w[1]]),zi([],p[w[2]],p[w[1]]))),S=-Fi(I,p[w[1]]);return I.concat(S)}),x=[];for(let w=0;w<p.length;w++)x.push([p[w][0],p[w][1],p[w][2]]);return new Mn(x,y)}intersectsPrecise(e,n,s){for(let c=0;c<n.length;c++)if(!Tn(e,n[c]))return 0;for(let c=0;c<this.planes.length;c++)if(!Tn(e,this.planes[c]))return 0;for(let c of s)for(let f of this.frustumEdges){let p=Zi([],c,f),y=Er(p);if(y===0)continue;hi(p,p,1/y);let x=Xn(this.points,this.points[0],p),w=Xn(e,this.points[0],p);if(x[0]>w[1]||w[0]>x[1])return 0}return 1}containsPoint(e){for(let n of this.planes){let s=n[3];if(Fi([n[0],n[1],n[2]],e)+s<0)return!1}return!0}}class sn{static fromPoints(e){let n=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(let c of e)Ps(n,n,c),$o(s,s,c);return new sn(n,s)}static fromTileIdAndHeight(e,n,s){let c=1<<e.canonical.z,f=e.canonical.x,p=e.canonical.y;return new sn([f/c,p/c,n],[(f+1)/c,(p+1)/c,s])}static applyTransform(e,n){let s=e.getCorners();for(let c=0;c<s.length;++c)Ni(s[c],s[c],n);return sn.fromPoints(s)}static applyTransformFast(e,n){let s=[n[12],n[13],n[14]],c=[...s];for(let f=0;f<3;f++)for(let p=0;p<3;p++){let y=n[4*p+f],x=y*e.min[p],w=y*e.max[p];s[f]+=Math.min(x,w),c[f]+=Math.max(x,w)}return new sn(s,c)}static projectAabbCorners(e,n){let s=e.getCorners();for(let c=0;c<s.length;++c)Ni(s[c],s[c],n);return s}constructor(e,n){this.min=e,this.max=n,this.center=hi([],pi([],this.min,this.max),.5)}quadrant(e){let n=[e%2==0,e<2],s=zl(this.min),c=zl(this.max);for(let f=0;f<n.length;f++)s[f]=n[f]?this.min[f]:this.center[f],c[f]=n[f]?this.center[f]:this.max[f];return c[2]=this.max[2],new sn(s,c)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){let e=this.min,n=this.max;return[[e[0],e[1],e[2]],[n[0],e[1],e[2]],[n[0],n[1],e[2]],[e[0],n[1],e[2]],[e[0],e[1],n[2]],[n[0],e[1],n[2]],[n[0],n[1],n[2]],[e[0],n[1],n[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?tn(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?tn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,n){return n||this.intersects(e)?En(e,this.getCorners()):0}intersectsPreciseFlat(e,n){return n||this.intersectsFlat(e)?En(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let n=0;n<3;++n)if(this.min[n]>e.max[n]||e.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e.min[n]),this.max[n]=Math.max(this.max[n],e.max[n])}encapsulatePoint(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e[n]),this.max[n]=Math.max(this.max[n],e[n])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}gt(sn,"Aabb");class zn{constructor(e,n){this.feature=e,this.metersToTile=n,this.index=0}get(){let e=this.feature.vertices[this.index],n=this.feature.vertexProps[this.index].dir,s=n[1],c=-n[0],f=(e.extent+1)*this.metersToTile;return[new Xe(Math.trunc(e.position[0]+s*f),Math.trunc(e.position[1]+c*f)),new Xe(Math.trunc(e.position[0]-s*f),Math.trunc(e.position[1]-c*f))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Cn{constructor(e,n,s,c,f,p){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:s,max:s},this.safeArea=n,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||c.length!==0)){this.vertices=c,this.edges=f,this.edges=this.edges.filter(y=>{return y.a<this.vertices.length&&y.b<this.vertices.length&&!((x=this.vertices[y.a].position)[0]===(w=this.vertices[y.b].position)[0]&&x[1]===w[1]);var x,w}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let y of this.vertices)this.vertexProps.push({dir:Eo(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,y.height),this.heightRange.max=Math.max(this.heightRange.max,y.height);for(let y of this.edges){let x=this.vertices[y.a].position,w=this.vertices[y.b].position,I=Ns(Mr(),w,x),S=fa(I),D=ha(Mr(),I,1/S);this.edgeProps.push({vec:I,dir:D,len:S});let P=this.vertexProps[y.a].dir,O=this.vertexProps[y.b].dir;da(P,P,D),da(O,O,D)}for(let y of this.vertexProps)y.dir[0]===0&&y.dir[1]===0||Ul(y.dir,y.dir);this.tessellate(p)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;let n=this.getClosestEdge(e);if(n==null)return 0;let[s,c]=n;return Ct(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,c)}computeSlopeNormal(e,n){let s=this.getClosestEdge(e);if(!s)return Wi(0,0,1);let c=s[0],f=this.edges[c],p=this.edgeProps[c].vec,y=Wi(p[0],p[1],(this.vertices[f.b].height-this.vertices[f.a].height)*n),x=Wi(y[1],-y[0],0);Zi(x,x,y);let w=Er(x);return w>0?hi(x,x,1/w):Wi(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let n=0,s=Number.POSITIVE_INFINITY,c=0,f=Eo(e.x,e.y);for(let p=0;p<this.edges.length;p++){let y=this.edges[p],x=this.edgeProps[p].dir,w=new Ht(f,this.edgeProps[p].dir),I=this.vertices[y.a].position,S=this.vertices[y.b].position,D=Mr(),P=Mr(),O=w.intersectsPlane(I,this.vertexProps[y.a].dir,D),F=w.intersectsPlane(S,this.vertexProps[y.b].dir,P);if(!O||!F)continue;let B=Ns(Mr(),P,D),H=Ns(Mr(),f,D),X=ui(B,B),Z=X>0?ui(H,B)/X:0,K=ne(Z,0,1),de=Math.abs((Z-K)*this.edgeProps[p].len),ae=Ns(Mr(),f,I),ce=de+Math.abs(ui(ae,Eo(x[1],-x[0])));ce<s&&(n=p,s=ce,c=K)}return[n,c]}tessellate(e){for(let n=this.edges.length-1;n>=0;--n){let s=this.edges[n].a,c=this.edges[n].b,{position:f,height:p,extent:y}=this.vertices[s],{position:x,height:w,extent:I}=this.vertices[c],S=this.vertexProps[s].dir,D=this.vertexProps[c].dir,P=Wi(f[0]/e,f[1]/e,p),O=Wi(x[0]/e,x[1]/e,w),F=Wi(S[1],-S[0],0);hi(F,F,y);let B=Wi(D[1],-D[0],0);if(hi(B,B,I),this.distSqLines(Wi(P[0]+.5*F[0],P[1]+.5*F[1],P[2]+.5*F[2]),Wi(O[0]-.5*B[0],O[1]-.5*B[1],O[2]-.5*B[2]),Wi(P[0]-.5*F[0],P[1]-.5*F[1],P[2]-.5*F[2]),Wi(O[0]+.5*B[0],O[1]+.5*B[1],O[2]+.5*B[2]))<=.0025000000000000005)continue;let H=this.vertices.length,X=da(Mr(),f,x);this.vertices.push({position:ha(X,X,.5),height:.5*(p+w),extent:.5*(y+I)});let Z=da(Mr(),S,D);this.vertexProps.push({dir:Ul(Z,Z)}),this.edges.splice(n,1),this.edgeProps.splice(n,1),this.edges.push({a:s,b:H}),this.edges.push({a:H,b:c});let K=Ns(Mr(),this.vertices[H].position,f),de=fa(K),ae={vec:K,dir:ha(Mr(),K,1/de),len:de};this.edgeProps.push(ae),this.edgeProps.push(ae)}}distSqLines(e,n,s,c){let f=lo(Nn(),n,e),p=lo(Nn(),c,s),y=lo(Nn(),e,s),x=Fi(f,f),w=Fi(f,p),I=Fi(f,y),S=Fi(p,p),D=Fi(p,y),P=x*S-w*w;if(P===0){let B=Fi(y,p)/Fi(p,p);return Bl(Yr(Nn(),s,c,B),e)}let O=(w*D-I*S)/P,F=(x*D-w*I)/P;return Bl(Yr(Nn(),e,n,O),Yr(Nn(),s,c,F))}}class _i{static parseFrom(e,n){let s=bn.parse(e);if(!s)return[];let{vertices:c,features:f}=s,p=1/oe(n);f.sort((I,S)=>I.id-S.id),c.sort((I,S)=>I.id-S.id||I.idx-S.idx),c=c.filter((I,S,D)=>S===D.findIndex(P=>P.id===I.id&&P.idx===I.idx));let y=new Array,x=0,w=c.length;for(let I of f){if(I.constantHeight){y.push(new Cn(I.id,I.bounds,I.constantHeight));continue}for(;x!==w&&c[x].id<I.id;)x++;if(x===w||c[x].id!==I.id)continue;let S=new Array,D=new Array,P=x;for(;x!==w&&c[x].id===I.id;){let O=c[x];if(S.push({position:O.position,height:O.height,extent:O.extent}),x!==P&&c[x-1].idx===O.idx-1){let F=x-P;D.push({a:F-1,b:F})}x++}y.push(new Cn(I.id,I.bounds,void 0,S,D,p))}return y}static getElevationFeature(e,n){if(!n)return;let s=+e.properties[dt];return Number.isNaN(s)?void 0:n.find(c=>c.id===s)}}class yn{constructor(e,n){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(n)||(this.zScale=Math.pow(2,n.z-e.z),this.xOffset=(e.x*this.zScale-n.x)*st,this.yOffset=(e.y*this.zScale-n.y)*st)}constantElevation(e,n){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,n)}pointElevation(e,n,s){let c=this.constantElevation(n,s);return c??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(n.pointElevation(e),s))}computeBiasedHeight(e,n){return n<=0?e:e+n*_e(0,n,e>=0?e:Math.abs(.5*e))}}gt(Cn,"ElevationFeature");class Rn{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new ro,this.indexArray=new di,this.segments=new gi,this.programConfigurations=new Ro(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new ml),this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){let f=this.layers[0],p=[],y=null;f.type==="circle"&&(y=f.layout.get("circle-sort-key"));for(let{feature:w,id:I,index:S,sourceLayerIndex:D}of e){let P=this.layers[0]._featureFilter.needGeometry,O=Pe(w,P);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom,{worldview:this.worldview}),O,s))continue;let F=y?y.evaluate(O,{},s):void 0,B={id:I,properties:w.properties,type:w.type,sourceLayerIndex:D,index:S,geometry:P?O.geometry:pe(w,s,c),patterns:{},sortKey:F};p.push(B)}y&&p.sort((w,I)=>w.sortKey-I.sortKey);let x=null;c.projection.name==="globe"&&(this.globeExtVertexArray=new jh,x=c.projection);for(let w of p){let{geometry:I,index:S,sourceLayerIndex:D}=w,P=e[S].feature;this.addFeature(w,I,S,n.availableImages,s,x,n.brightness,n.elevationFeatures),n.featureIndex.insert(P,I,S,D,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,n,s,c,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,ky.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Nb.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Fb.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,n,s,c,f,p,y,x){let w;this.elevationMode!=="none"&&(w=_i.getElevationFeature(e,x));for(let I of n)for(let S of I){let D=S.x,P=S.y;if(D<0||D>=st||P<0||P>=st)continue;if(p){let B=p.projectTilePoint(D,P,f),H=p.upVector(f,D,P);this.addGlobeExtVertex(B,H),this.addGlobeExtVertex(B,H),this.addGlobeExtVertex(B,H),this.addGlobeExtVertex(B,H)}let O=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),F=O.vertexLength;if(this.addCircleVertex(D,P,-1,-1),this.addCircleVertex(D,P,1,-1),this.addCircleVertex(D,P,1,1),this.addCircleVertex(D,P,-1,1),this.elevationMode!=="none"){let B=w?w.pointElevation(new Xe(D,P)):0;this.hasElevation=this.hasElevation||B!==0;for(let H=0;H<4;H++)this.elevatedLayoutVertexArray.emplaceBack(B)}this.indexArray.emplaceBack(F,F+1,F+2),this.indexArray.emplaceBack(F,F+2,F+3),O.vertexLength+=4,O.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},c,f,y,void 0,this.worldview)}addCircleVertex(e,n,s,c){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*n+(c+1)/2)}addGlobeExtVertex(e,n){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}}function qn(i,e){for(let n=0;n<i.length;n++)if(Ir(e,i[n]))return!0;for(let n=0;n<e.length;n++)if(Ir(i,e[n]))return!0;return!!pr(i,e)}function $i(i,e,n){return!!Ir(i,e)||!!Tr(e,i,n)}function Bi(i,e){if(i.length===1)return Qo(e,i[0]);for(let n=0;n<e.length;n++){let s=e[n];for(let c=0;c<s.length;c++)if(Ir(i,s[c]))return!0}for(let n=0;n<i.length;n++)if(Qo(e,i[n]))return!0;for(let n=0;n<e.length;n++)if(pr(i,e[n]))return!0;return!1}function qi(i,e,n){if(i.length>1){if(pr(i,e))return!0;for(let s=0;s<e.length;s++)if(Tr(e[s],i,n))return!0}for(let s=0;s<i.length;s++)if(Tr(i[s],e,n))return!0;return!1}function pr(i,e){if(i.length===0||e.length===0)return!1;for(let n=0;n<i.length-1;n++){let s=i[n],c=i[n+1];for(let f=0;f<e.length-1;f++)if(ls(s,c,e[f],e[f+1]))return!0}return!1}function ls(i,e,n,s){return Pi(i,n,s)!==Pi(e,n,s)&&Pi(i,e,n)!==Pi(i,e,s)}function Hr(i,e,n){return(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x)}function po(i,e,n,s){let c=Hr(i,e,s),f=Hr(i,e,n);if(Math.sign(c)===Math.sign(f))return;let p=Hr(n,s,i),y=p+f-c;return Math.sign(p)!==Math.sign(y)?[p/(p-y),f/(f-c)]:void 0}function Tr(i,e,n){let s=n*n;if(e.length===1)return i.distSqr(e[0])<s;for(let c=1;c<e.length;c++)if(Po(i,e[c-1],e[c])<s)return!0;return!1}function Po(i,e,n){let s=e.distSqr(n);if(s===0)return i.distSqr(e);let c=((i.x-e.x)*(n.x-e.x)+(i.y-e.y)*(n.y-e.y))/s;return i.distSqr(c<0?e:c>1?n:n.sub(e)._mult(c)._add(e))}function Qo(i,e){let n,s,c,f=!1;for(let p=0;p<i.length;p++){n=i[p];for(let y=0,x=n.length-1;y<n.length;x=y++)s=n[y],c=n[x],s.y>e.y!=c.y>e.y&&e.x<(c.x-s.x)*(e.y-s.y)/(c.y-s.y)+s.x&&(f=!f)}return f}function Ir(i,e){let n=!1;for(let s=0,c=i.length-1;s<i.length;c=s++){let f=i[s],p=i[c];f.y>e.y!=p.y>e.y&&e.x<(p.x-f.x)*(e.y-f.y)/(p.y-f.y)+f.x&&(n=!n)}return n}function Oi(i,e,n,s,c){for(let p of i)if(e<=p.x&&n<=p.y&&s>=p.x&&c>=p.y)return!0;let f=[new Xe(e,n),new Xe(e,c),new Xe(s,c),new Xe(s,n)];if(i.length>2){for(let p of f)if(Ir(i,p))return!0}for(let p=0;p<i.length-1;p++)if(Si(i[p],i[p+1],f))return!0;return!1}function Si(i,e,n){let s=n[0],c=n[2];if(i.x<s.x&&e.x<s.x||i.x>c.x&&e.x>c.x||i.y<s.y&&e.y<s.y||i.y>c.y&&e.y>c.y)return!1;let f=Pi(i,e,n[0]);return f!==Pi(i,e,n[1])||f!==Pi(i,e,n[2])||f!==Pi(i,e,n[3])}function Jn(i,e,n,s,c,f){let p=e.y-i.y,y=i.x-e.x;if(f=f||0){let x=p*p+y*y;if(x===0)return!0;let w=Math.sqrt(x);p/=w,y/=w}return!((n.x-i.x)*p+(n.y-i.y)*y-f<0||(s.x-i.x)*p+(s.y-i.y)*y-f<0||(c.x-i.x)*p+(c.y-i.y)*y-f<0)}function Qi(i,e,n,s,c,f,p){return!(Jn(i,e,s,c,f,p)||Jn(e,n,s,c,f,p)||Jn(n,i,s,c,f,p)||Jn(s,c,i,e,n,p)||Jn(c,f,i,e,n,p)||Jn(f,s,i,e,n,p))}function mr(i,e,n){let s=e.paint.get(i).value;return s.kind==="constant"?s.value:n.programConfigurations.get(e.id).getMaxValue(i)}function Li(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function Oo(i,e,n,s,c){if(!e[0]&&!e[1])return i;let f=Xe.convert(e)._mult(c);n==="viewport"&&f._rotate(-s);let p=[];for(let y=0;y<i.length;y++)p.push(i[y].sub(f));return p}function _l(i,e,n,s){let c=Xe.convert(i)._mult(s);return e==="viewport"&&c._rotate(-n),c}let Oa,Ic;function Sc(i,e,n){var s=2*Math.PI*6378137/256/Math.pow(2,n);return[i*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}gt(Rn,"CircleBucket",{omit:["layers"]});class Lo{constructor(e,n,s){this.z=e,this.x=n,this.y=s,this.key=ko(0,e,e,n,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){let n=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>n&&e.y===this.y>>n}url(e,n){let s=function(f,p,y){var x=Sc(256*f,256*(p=Math.pow(2,y)-p-1),y),w=Sc(256*(f+1),256*(p+1),y);return x[0]+","+x[1]+","+w[0]+","+w[1]}(this.x,this.y,this.z),c=function(f,p,y){let x,w="";for(let I=f;I>0;I--)x=1<<I-1,w+=(p&x?1:0)+(y&x?2:0);return w}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(n==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",c).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Is{constructor(e,n){this.wrap=e,this.canonical=n,this.key=ko(e,n.z,n.z,n.x,n.y)}}class er{constructor(e,n,s,c,f){this.overscaledZ=e,this.wrap=n,this.canonical=new Lo(s,+c,+f),this.key=n===0&&e===s?this.canonical.key:ko(n,e,s,c,f)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){let n=this.canonical.z-e;return e>this.canonical.z?new er(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new er(e,this.wrap,e,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(e,n=!0){if(this.overscaledZ===e&&n)return this.key;if(e>this.canonical.z)return ko(this.wrap*+n,e,this.canonical.z,this.canonical.x,this.canonical.y);{let s=this.canonical.z-e;return ko(this.wrap*+n,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;let n=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>n&&e.canonical.y===this.canonical.y>>n}children(e){if(this.overscaledZ>=e)return[new er(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let n=this.canonical.z+1,s=2*this.canonical.x,c=2*this.canonical.y;return[new er(n,this.wrap,n,s,c),new er(n,this.wrap,n,s+1,c),new er(n,this.wrap,n,s,c+1),new er(n,this.wrap,n,s+1,c+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new er(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new er(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Is(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function ko(i,e,n,s,c){let f=1<<Math.min(n,22),p=f*(c%f)+s%f;return i&&n<22&&(p+=f*f*((i<0?-2*i-1:2*i)%(1<<2*(22-n)))),16*(32*p+n)+(e-n)}let yl=[i=>{let e=i.canonical.x-1,n=i.wrap;return e<0&&(e=(1<<i.canonical.z)-1,n--),new er(i.overscaledZ,n,i.canonical.z,e,i.canonical.y)},i=>{let e=i.canonical.x+1,n=i.wrap;return e===1<<i.canonical.z&&(e=0,n++),new er(i.overscaledZ,n,i.canonical.z,e,i.canonical.y)},i=>new er(i.overscaledZ,i.wrap,i.canonical.z,i.canonical.x,(i.canonical.y===0?1<<i.canonical.z:i.canonical.y)-1),i=>new er(i.overscaledZ,i.wrap,i.canonical.z,i.canonical.x,i.canonical.y===(1<<i.canonical.z)-1?0:i.canonical.y+1)];gt(Lo,"CanonicalTileID"),gt(er,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let ZL=gn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:jy}=ZL,XL=gn([{name:"a_pos_3",components:3,type:"Int16"}]);var oS=gn([{name:"a_pos",type:"Int16",components:2}]);function Uy(i){return i*kr/T}let YL=[new sn([g,g,g],[_,_,_]),new sn([g,g,g],[0,0,_]),new sn([0,g,g],[_,0,_]),new sn([g,0,g],[0,_,_]),new sn([0,0,g],[_,_,_])];function sS(i,e,n,s=!0){let c=hi([],i._camera.position,i.worldSize),f=[e,n,1,1];co(f,f,i.pixelMatrixInverse),Os(f,f,1/f[3]);let p=ci([],zi([],f,c)),y=i.globeMatrix,x=[y[12],y[13],y[14]],w=zi([],x,c),I=Er(w),S=ci([],w),D=i.worldSize/(2*Math.PI),P=Fi(S,p),O=Math.asin(D/I);if(O<Math.acos(P)){if(!s)return null;let ke=[],be=[];hi(ke,p,I/P),ci(be,zi(be,ke,w)),ci(p,pi(p,w,hi(p,be,Math.tan(O)*I)))}let F=[];new wn(c,p).closestPointOnSphere(x,D,F);let B=ci([],bi(y,0)),H=ci([],bi(y,1)),X=ci([],bi(y,2)),Z=Fi(B,F),K=Fi(H,F),de=Fi(X,F),ae=Se(Math.asin(-K/D)),ce=Se(Math.atan2(Z,de));ce=i.center.lng+function(ke,be){let ze=(be-ke+180)%360-180;return ze<-180?ze+360:ze}(i.center.lng,ce);let ge=z(ce),ye=ne(U(ae),0,1);return new se(ge,ye)}class KL{constructor(e,n,s){this.a=zi([],e,s),this.b=zi([],n,s),this.center=s;let c=ci([],this.a),f=ci([],this.b);this.angle=Math.acos(Fi(c,f))}}function Gb(i,e){if(i.angle===0)return null;let n;return n=i.a[e]===0?1/i.angle*.5*Math.PI:1/i.angle*Math.atan(i.b[e]/i.a[e]/Math.sin(i.angle)-1/Math.tan(i.angle)),n<0||n>1?null:function(s,c,f,p){let y=Math.sin(f);return s*(Math.sin((1-p)*f)/y)+c*(Math.sin(p*f)/y)}(i.a[e],i.b[e],i.angle,ne(n,0,1))+i.center[e]}function La(i){if(i.z<=1)return YL[i.z+2*i.y+i.x];let e=qb(Hy(i));return sn.fromPoints(e)}function vl(i,e,n){return hi(i,i,1-n),zr(i,i,e,n)}function aS(i,e,n){for(let s of i)Ni(s,s,e),hi(s,s,n)}function lS(i,e,n,s){let c=e/i.worldSize,f=i.globeMatrix;if(n.z<=1){let ye=La(n).getCorners();return aS(ye,f,c),sn.fromPoints(ye)}let p=Hy(n,s),y=qb(p,kr+Uy(i._tileCoverLift));aS(y,f,c);let x=Number.MAX_VALUE,w=[-x,-x,-x],I=[x,x,x];if(p.contains(i.center)){for(let be of y)Ps(I,I,be),$o(w,w,be);w[2]=0;let ye=i.point,ke=[ye.x*c,ye.y*c,0];return Ps(I,I,ke),$o(w,w,ke),new sn(I,w)}if(i._tileCoverLift>0){for(let ye of y)Ps(I,I,ye),$o(w,w,ye);return new sn(I,w)}let S=[f[12]*c,f[13]*c,f[14]*c],D=p.getCenter(),P=ne(i.center.lat,-ie,ie),O=ne(D.lat,-ie,ie),F=z(i.center.lng),B=U(P),H=F-z(D.lng),X=B-U(O);H>.5?H-=1:H<-.5&&(H+=1);let Z=0;Math.abs(H)>Math.abs(X)?Z=H>=0?1:3:(Z=X>=0?0:2,zr(S,S,[f[4]*c,f[5]*c,f[6]*c],-Math.sin(Sn(X>=0?p.getSouth():p.getNorth()))*kr));let K=y[Z],de=y[(Z+1)%4],ae=new KL(K,de,S),ce=[Gb(ae,0)||K[0],Gb(ae,1)||K[1],Gb(ae,2)||K[2]],ge=Dc(i.zoom);if(ge>0){let ye=function({x:be,y:ze,z:et},Ve,We,Je,Oe){let Ze=1/(1<<et),we=be*Ze,Le=we+Ze,it=ze*Ze,Ye=it+Ze,Et=0,_t=(we+Le)/2-Je;return _t>.5?Et=-1:_t<-.5&&(Et=1),we=((we+Et)*Ve-(Je*=Ve))*We+Je,Le=((Le+Et)*Ve-Je)*We+Je,it=(it*Ve-(Oe*=Ve))*We+Oe,Ye=(Ye*Ve-Oe)*We+Oe,[[we,Ye,0],[Le,Ye,0],[Le,it,0],[we,it,0]]}(n,e,i._pixelsPerMercatorPixel,F,B);for(let be=0;be<y.length;be++)vl(y[be],ye[be],ge);let ke=pi([],ye[Z],ye[(Z+1)%4]);hi(ke,ke,.5),vl(ce,ke,ge)}for(let ye of y)Ps(I,I,ye),$o(w,w,ye);return I[2]=Math.min(K[2],de[2]),Ps(I,I,ce),$o(w,w,ce),new sn(I,w)}function Hy({x:i,y:e,z:n},s=!1){let c=1/(1<<n),f=new A(W(i*c),e===(1<<n)-1&&s?-90:Y((e+1)*c)),p=new A(W((i+1)*c),e===0&&s?90:Y(e*c));return new L(f,p)}function qb(i,e=kr){let n=Sn(i.getNorth()),s=Sn(i.getSouth()),c=Math.cos(n),f=Math.cos(s),p=Math.sin(n),y=Math.sin(s),x=i.getWest(),w=i.getEast();return[v(f,y,x,e),v(f,y,w,e),v(c,p,w,e),v(c,p,x,e)]}function Am(i,e,n,s){let c=1<<n.z,f=(i/st+n.x)/c;return E(Y((e/st+n.y)/c),W(f),s)}function $y({min:i,max:e}){return t/Math.max(e[0]-i[0],e[1]-i[1],e[2]-i[2])}let cS=new Float64Array(16);function Gy(i){let e=$y(i),n=_s(cS,[e,e,e]);return jt(n,n,aa([],i.min))}function Wb(i){let e=(s=i.min,(n=cS)[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=s[0],n[13]=s[1],n[14]=s[2],n[15]=1,n);var n,s;let c=1/$y(i);return Nt(e,e,[c,c,c])}function Zb(i){let e=st/(2*Math.PI);return i/(2*Math.PI)/e}function uS(i,e){return st/(512*Math.pow(2,i))*$y(La(e))}function dS(i,e,n,s,c){let f=Zb(n),p=[i,e,-n/(2*Math.PI)],y=Fe(new Float64Array(16));return jt(y,y,p),Nt(y,y,[f,f,f]),ar(y,y,Sn(-c)),lr(y,y,Sn(-s)),y}function Dc(i){return _e(Vy,u,i)}function hS(i,e){let n=E(e.lat,e.lng),s=function(O){let F=E(O._center.lat,O._center.lng),B=Zi([],Wi(0,1,0),F),H=xo([],-O.angle,F);B=Ni(B,B,H),xo(H,-O._pitch,B);let X=ci([],F);return hi(X,X,Uy(O.cameraToCenterDistance/O.pixelsPerMeter)),Ni(X,X,H),pi([],F,X)}(i);return p=(c=lo([],s,n))[0],y=c[1],x=c[2],w=(f=n)[0],I=f[1],S=f[2],P=(D=Math.sqrt(p*p+y*y+x*x)*Math.sqrt(w*w+I*I+S*S))&&Fi(c,f)/D,Math.acos(Math.min(Math.max(P,-1),1));var c,f,p,y,x,w,I,S,D,P}function Xb(i,e){return hS(i,e)>Math.PI/2*1.01}let fS=Sn(85),JL=Math.cos(fS),QL=Math.sin(fS),ek=bt(),pS=i=>{let e=[];return i.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),i.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function mS(i,e,n,s,c,f,p,y,x){if(f&&i.queryGeometry.isAboveHorizon)return!1;f&&(x*=i.pixelToTileUnitsFactor);let w=i.tileID.canonical,I=n.projection.upVectorScale(w,n.center.lat,n.worldSize).metersToTile;for(let S of e)for(let D of S){let P=D.add(y),O=c&&n.elevation?n.elevation.exaggeration()*c.getElevationAt(P.x,P.y,!0):0,F=n.projection.projectTilePoint(P.x,P.y,w);if(O>0){let Z=n.projection.upVector(w,P.x,P.y);F.x+=Z[0]*I*O,F.y+=Z[1]*I*O,F.z+=Z[2]*I*O}let B=f?P:tk(F.x,F.y,F.z,s),H=f?i.tilespaceRays.map(Z=>ik(Z,O)):i.queryGeometry.screenGeometry,X=co([],[F.x,F.y,F.z,1],s);if(!p&&f?x*=X[3]/n.cameraToCenterDistance:p&&!f&&(x*=n.cameraToCenterDistance/X[3]),f){let Z=Y((D.y/st+w.y)/(1<<w.z));x/=n.projection.pixelsPerMeter(Z,1)/j(1,Z)}if($i(H,B,x))return!0}return!1}function tk(i,e,n,s){let c=co([],[i,e,n,1],s);return new Xe(c[0]/c[3],c[1]/c[3])}let gS=Wi(0,0,0),nk=Wi(0,0,1);function ik(i,e){let n=Nn();return gS[2]=e,i.intersectsPlane(gS,nk,n),new Xe(n[0],n[1])}class _S extends Rn{}let yS,vS,xS,bS;function wS(i,{width:e,height:n},s,c){if(c){if(c instanceof Uint8ClampedArray)c=new Uint8Array(c.buffer);else if(c.length!==e*n*s)throw new RangeError("mismatched image size")}else c=new Uint8Array(e*n*s);return i.width=e,i.height=n,i.data=c,i}function ES(i,e,n){let{width:s,height:c}=e;s===i.width&&c===i.height||(Yb(i,e,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,s),height:Math.min(i.height,c)},n,null),i.width=s,i.height=c,i.data=e.data)}function Yb(i,e,n,s,c,f,p,y){if(c.width===0||c.height===0)return e;if(c.width>i.width||c.height>i.height||n.x>i.width-c.width||n.y>i.height-c.height)throw new RangeError("out of range source coordinates for image copy");if(c.width>e.width||c.height>e.height||s.x>e.width-c.width||s.y>e.height-c.height)throw new RangeError("out of range destination coordinates for image copy");let x=i.data,w=e.data,I=f===4&&y;for(let S=0;S<c.height;S++){let D=((n.y+S)*i.width+n.x)*f,P=((s.y+S)*e.width+s.x)*f;if(I)for(let O=0;O<c.width;O++){let F=D+O*f+3,B=P+O*f;w[B+0]=255,w[B+1]=255,w[B+2]=255,w[B+3]=x[F]}else if(p)for(let O=0;O<c.width;O++){let F=D+O*f,B=P+O*f,H=new Ln(x[F+0]/255,x[F+1]/255,x[F+2]/255,x[F+3]).toNonPremultipliedRenderColor(p).toArray();w[B+0]=H[0],w[B+1]=H[1],w[B+2]=H[2],w[B+3]=H[3]}else for(let O=0;O<c.width*f;O++)w[P+O]=x[D+O]}return e}gt(_S,"HeatmapBucket",{omit:["layers"]});class Cc{constructor(e,n){wS(this,e,1,n)}resize(e){ES(this,new Cc(e),1)}clone(){return new Cc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,s,c,f){Yb(e,n,s,c,f,1,null)}}class Sr{constructor(e,n){wS(this,e,4,n)}resize(e){ES(this,new Sr(e),4)}replace(e,n){n?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Sr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,s,c,f,p,y){Yb(e,n,s,c,f,4,p,y)}}class TS{constructor(e,n){this.width=e.width,this.height=e.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}function Mm(i){let e={},n=i.resolution||256,s=i.clips?i.clips.length:1,c=i.image||new Sr({width:n,height:s}),f=(p,y,x)=>{e[i.evaluationKey]=x;let w=i.expression.evaluate(e),I=w?w.toNonPremultipliedRenderColor(null):null;I&&(c.data[p+y+0]=Math.floor(255*I.r),c.data[p+y+1]=Math.floor(255*I.g),c.data[p+y+2]=Math.floor(255*I.b),c.data[p+y+3]=Math.floor(255*I.a))};if(i.clips)for(let p=0,y=0;p<s;++p,y+=4*n)for(let x=0,w=0;x<n;x++,w+=4){let I=x/(n-1),{start:S,end:D}=i.clips[p];f(y,w,S*(1-I)+D*I)}else for(let p=0,y=0;p<n;p++,y+=4)f(0,y,p/(n-1));return c}gt(Cc,"AlphaImage"),gt(Sr,"RGBAImage");let rk=gn([{name:"a_pos",components:2,type:"Int16"}],4),ok=gn([{name:"a_road_z_offset",components:1,type:"Float32"}],4),sk=gn([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),ak=gn([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Yh(i,e,n=2){let s=e&&e.length,c=s?e[0]*n:i.length,f=IS(i,0,c,n,!0),p=[];if(!f||f.next===f.prev)return p;let y,x,w;if(s&&(f=function(I,S,D,P){let O=[];for(let F=0,B=S.length;F<B;F++){let H=IS(I,S[F]*P,F<B-1?S[F+1]*P:I.length,P,!1);H===H.next&&(H.steiner=!0),O.push(mk(H))}O.sort(hk);for(let F=0;F<O.length;F++)D=fk(O[F],D);return D}(i,e,f,n)),i.length>80*n){y=i[0],x=i[1];let I=y,S=x;for(let D=n;D<c;D+=n){let P=i[D],O=i[D+1];P<y&&(y=P),O<x&&(x=O),P>I&&(I=P),O>S&&(S=O)}w=Math.max(I-y,S-x),w=w!==0?32767/w:0}return Rm(f,p,n,y,x,w,0),p}function IS(i,e,n,s,c){let f;if(c===function(p,y,x,w){let I=0;for(let S=y,D=x-w;S<x;S+=w)I+=(p[D]-p[S])*(p[S+1]+p[D+1]),D=S;return I}(i,e,n,s)>0)for(let p=e;p<n;p+=s)f=AS(p/s|0,i[p],i[p+1],f);else for(let p=n-s;p>=e;p-=s)f=AS(p/s|0,i[p],i[p+1],f);return f&&Kh(f,f.next)&&(Lm(f),f=f.next),f}function td(i,e){if(!i)return i;e||(e=i);let n,s=i;do if(n=!1,s.steiner||!Kh(s,s.next)&&cr(s.prev,s,s.next)!==0)s=s.next;else{if(Lm(s),s=e=s.prev,s===s.next)break;n=!0}while(n||s!==e);return e}function Rm(i,e,n,s,c,f,p){if(!i)return;!p&&f&&function(x,w,I,S){let D=x;do D.z===0&&(D.z=Kb(D.x,D.y,w,I,S)),D.prevZ=D.prev,D.nextZ=D.next,D=D.next;while(D!==x);D.prevZ.nextZ=null,D.prevZ=null,function(P){let O,F=1;do{let B,H=P;P=null;let X=null;for(O=0;H;){O++;let Z=H,K=0;for(let ae=0;ae<F&&(K++,Z=Z.nextZ,Z);ae++);let de=F;for(;K>0||de>0&&Z;)K!==0&&(de===0||!Z||H.z<=Z.z)?(B=H,H=H.nextZ,K--):(B=Z,Z=Z.nextZ,de--),X?X.nextZ=B:P=B,B.prevZ=X,X=B;H=Z}X.nextZ=null,F*=2}while(O>1)}(D)}(i,s,c,f);let y=i;for(;i.prev!==i.next;){let x=i.prev,w=i.next;if(f?ck(i,s,c,f):lk(i))e.push(x.i,i.i,w.i),Lm(i),i=w.next,y=w.next;else if((i=w)===y){p?p===1?Rm(i=uk(td(i),e),e,n,s,c,f,2):p===2&&dk(i,e,n,s,c,f):Rm(td(i),e,n,s,c,f,1);break}}}function lk(i){let e=i.prev,n=i,s=i.next;if(cr(e,n,s)>=0)return!1;let c=e.x,f=n.x,p=s.x,y=e.y,x=n.y,w=s.y,I=Math.min(c,f,p),S=Math.min(y,x,w),D=Math.max(c,f,p),P=Math.max(y,x,w),O=s.next;for(;O!==e;){if(O.x>=I&&O.x<=D&&O.y>=S&&O.y<=P&&Pm(c,y,f,x,p,w,O.x,O.y)&&cr(O.prev,O,O.next)>=0)return!1;O=O.next}return!0}function ck(i,e,n,s){let c=i.prev,f=i,p=i.next;if(cr(c,f,p)>=0)return!1;let y=c.x,x=f.x,w=p.x,I=c.y,S=f.y,D=p.y,P=Math.min(y,x,w),O=Math.min(I,S,D),F=Math.max(y,x,w),B=Math.max(I,S,D),H=Kb(P,O,e,n,s),X=Kb(F,B,e,n,s),Z=i.prevZ,K=i.nextZ;for(;Z&&Z.z>=H&&K&&K.z<=X;){if(Z.x>=P&&Z.x<=F&&Z.y>=O&&Z.y<=B&&Z!==c&&Z!==p&&Pm(y,I,x,S,w,D,Z.x,Z.y)&&cr(Z.prev,Z,Z.next)>=0||(Z=Z.prevZ,K.x>=P&&K.x<=F&&K.y>=O&&K.y<=B&&K!==c&&K!==p&&Pm(y,I,x,S,w,D,K.x,K.y)&&cr(K.prev,K,K.next)>=0))return!1;K=K.nextZ}for(;Z&&Z.z>=H;){if(Z.x>=P&&Z.x<=F&&Z.y>=O&&Z.y<=B&&Z!==c&&Z!==p&&Pm(y,I,x,S,w,D,Z.x,Z.y)&&cr(Z.prev,Z,Z.next)>=0)return!1;Z=Z.prevZ}for(;K&&K.z<=X;){if(K.x>=P&&K.x<=F&&K.y>=O&&K.y<=B&&K!==c&&K!==p&&Pm(y,I,x,S,w,D,K.x,K.y)&&cr(K.prev,K,K.next)>=0)return!1;K=K.nextZ}return!0}function uk(i,e){let n=i;do{let s=n.prev,c=n.next.next;!Kh(s,c)&&DS(s,n,n.next,c)&&Om(s,c)&&Om(c,s)&&(e.push(s.i,n.i,c.i),Lm(n),Lm(n.next),n=i=c),n=n.next}while(n!==i);return td(n)}function dk(i,e,n,s,c,f){let p=i;do{let y=p.next.next;for(;y!==p.prev;){if(p.i!==y.i&&gk(p,y)){let x=CS(p,y);return p=td(p,p.next),x=td(x,x.next),Rm(p,e,n,s,c,f,0),void Rm(x,e,n,s,c,f,0)}y=y.next}p=p.next}while(p!==i)}function hk(i,e){let n=i.x-e.x;return n===0&&(n=i.y-e.y,n===0)&&(n=(i.next.y-i.y)/(i.next.x-i.x)-(e.next.y-e.y)/(e.next.x-e.x)),n}function fk(i,e){let n=function(c,f){let p=f,y=c.x,x=c.y,w,I=-1/0;if(Kh(c,p))return p;do{if(Kh(c,p.next))return p.next;if(x<=p.y&&x>=p.next.y&&p.next.y!==p.y){let F=p.x+(x-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(F<=y&&F>I&&(I=F,w=p.x<p.next.x?p:p.next,F===y))return w}p=p.next}while(p!==f);if(!w)return null;let S=w,D=w.x,P=w.y,O=1/0;p=w;do{if(y>=p.x&&p.x>=D&&y!==p.x&&SS(x<P?y:I,x,D,P,x<P?I:y,x,p.x,p.y)){let F=Math.abs(x-p.y)/(y-p.x);Om(p,c)&&(F<O||F===O&&(p.x>w.x||p.x===w.x&&pk(w,p)))&&(w=p,O=F)}p=p.next}while(p!==S);return w}(i,e);if(!n)return e;let s=CS(n,i);return td(s,s.next),td(n,n.next)}function pk(i,e){return cr(i.prev,i,e.prev)<0&&cr(e.next,i,i.next)<0}function Kb(i,e,n,s,c){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-n)*c|0)|i<<8))|i<<4))|i<<2))|i<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*c|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function mk(i){let e=i,n=i;do(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next;while(e!==i);return n}function SS(i,e,n,s,c,f,p,y){return(c-p)*(e-y)>=(i-p)*(f-y)&&(i-p)*(s-y)>=(n-p)*(e-y)&&(n-p)*(f-y)>=(c-p)*(s-y)}function Pm(i,e,n,s,c,f,p,y){return!(i===p&&e===y)&&SS(i,e,n,s,c,f,p,y)}function gk(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!function(n,s){let c=n;do{if(c.i!==n.i&&c.next.i!==n.i&&c.i!==s.i&&c.next.i!==s.i&&DS(c,c.next,n,s))return!0;c=c.next}while(c!==n);return!1}(i,e)&&(Om(i,e)&&Om(e,i)&&function(n,s){let c=n,f=!1,p=(n.x+s.x)/2,y=(n.y+s.y)/2;do c.y>y!=c.next.y>y&&c.next.y!==c.y&&p<(c.next.x-c.x)*(y-c.y)/(c.next.y-c.y)+c.x&&(f=!f),c=c.next;while(c!==n);return f}(i,e)&&(cr(i.prev,i,e.prev)||cr(i,e.prev,e))||Kh(i,e)&&cr(i.prev,i,i.next)>0&&cr(e.prev,e,e.next)>0)}function cr(i,e,n){return(e.y-i.y)*(n.x-e.x)-(e.x-i.x)*(n.y-e.y)}function Kh(i,e){return i.x===e.x&&i.y===e.y}function DS(i,e,n,s){let c=Wy(cr(i,e,n)),f=Wy(cr(i,e,s)),p=Wy(cr(n,s,i)),y=Wy(cr(n,s,e));return c!==f&&p!==y||!(c!==0||!qy(i,n,e))||!(f!==0||!qy(i,s,e))||!(p!==0||!qy(n,i,s))||!(y!==0||!qy(n,e,s))}function qy(i,e,n){return e.x<=Math.max(i.x,n.x)&&e.x>=Math.min(i.x,n.x)&&e.y<=Math.max(i.y,n.y)&&e.y>=Math.min(i.y,n.y)}function Wy(i){return i>0?1:i<0?-1:0}function Om(i,e){return cr(i.prev,i,i.next)<0?cr(i,e,i.next)>=0&&cr(i,i.prev,e)>=0:cr(i,e,i.prev)<0||cr(i,i.next,e)<0}function CS(i,e){let n=Jb(i.i,i.x,i.y),s=Jb(e.i,e.x,e.y),c=i.next,f=e.prev;return i.next=e,e.prev=i,n.next=c,c.prev=n,s.next=n,n.prev=s,f.next=s,s.prev=f,s}function AS(i,e,n,s){let c=Jb(i,e,n);return s?(c.next=s.next,c.prev=s,s.next.prev=c,s.next=c):(c.prev=c,c.next=c),c}function Lm(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function Jb(i,e,n){return{i,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function km(i,e){let n=i.length;if(n<=1)return[i];let s=[],c,f;for(let p=0;p<n;p++){let y=ir(i[p]);y!==0&&(i[p].area=Math.abs(y),f===void 0&&(f=y<0),f===y<0?(c&&s.push(c),c=[i[p]]):c.push(i[p]))}if(c&&s.push(c),e>1)for(let p=0;p<s.length;p++)s[p].length<=e||(Or(s[p],e,1,s[p].length-1,_k),s[p]=s[p].slice(0,e));return s}function _k(i,e){return e.area-i.area}function MS(i,e,n=1){if(!i)return null;let s=typeof i=="string"?to.from(i).getPrimary():i.getPrimary(),c=typeof i=="string"?null:i.getSecondary();for(let f of[s,c]){if(!f)continue;let p=f.id.toString();e.has(p)||e.set(p,[]),f.scaleSelf(n),e.get(p).push(f)}return{primary:s.toString(),secondary:c?c.toString():null}}function Qb(i,e,n,s){let c=s.patternDependencies,f=!1;for(let p of e){let y=p.paint.get(`${i}-pattern`);y.isConstant()||(f=!0),MS(y.constantOr(null),c,n)&&(f=!0)}return f}function ew(i,e,n,s,c,f){let p=f.patternDependencies;for(let y of e){let x=y.paint.get(`${i}-pattern`).value;if(x.kind!=="constant"){let w=x.evaluate({zoom:s},n,{},f.availableImages);w=w&&w.name?w.name:w;let I=MS(w,p,c);if(!I)continue;let{primary:S,secondary:D}=I;S&&(n.patterns[y.id]=[S,D].filter(Boolean))}}return n}class RS{constructor(){this.polygons=new Map}add(e,...n){this.polygons.has(e)?this.polygons.get(e).push(...n):this.polygons.set(e,n)}merge(e){for(let[n,s]of e.polygons)this.add(n,...s)}}class nd{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new nd;let n=[];for(let w of e)n.push(...w.portals);if(n.length===0)return new nd;let s=(w,I)=>w<=0&&I<=0||w>=st&&I>=st;for(let w of n){let I=w.va,S=w.vb;(s(I.x,S.x)||s(I.y,S.y))&&(w.type="border")}let c=n.filter(w=>w.type!=="unevaluated"),f=n.filter(w=>w.type==="unevaluated");if(f.length===0)return new nd;f.sort((w,I)=>w.hash===I.hash?w.isTunnel===I.isTunnel?0:w.isTunnel?-1:1:w.hash<I.hash?1:-1),n=c.concat(f);let p=c.length,y=p,x=p;do if(y++,y===n.length||n[p].hash!==n[y].hash){if(y-p==2){x<p&&(n[x]=n[p],n[p]=null);let w=n[x],I=n[y-1];w.type=w.isTunnel!==I.isTunnel?"tunnel":"polygon",w.connection={a:w.connection.a,b:I.connection.a},x++}p=y}while(p!==n.length);return n.splice(x),n.sort((w,I)=>w.hash<I.hash?1:-1),{portals:n}}}gt(nd,"ElevationPortalGraph"),gt(RS,"ElevationPolygons");class yk{constructor(e,n,s){this.outPositions=e,this.outNormals=n,this.outIndices=s,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,n,s){let c=e[2];s!=null&&(c*=s);let f=this.getVec3Bits(e)<<96n|this.getVec3Bits(n),p=this.vertexLookup.get(f);if(p!=null)return p;let y=this.outPositions.length;this.vertexLookup.set(f,y);let x=Math.trunc(16384*n[0]),w=Math.trunc(16384*n[1]),I=Math.trunc(16384*n[2]);return this.outPositions.emplaceBack(e[0],e[1],c),this.outNormals.emplaceBack(x,w,I),y}addTriangle(e,n,s){this.outIndices.emplaceBack(e,n,s)}addTriangles(e,n,s){if(e.length===0)return;let c=s.length===1,f=Nn(),p=Nn();for(let y=0;y<e.length;y+=3){let x=n[e[y+0]],w=n[e[y+1]],I=n[e[y+2]],S=c?s[0]:s[e[y+1]],D=c?s[0]:s[e[y+2]];Ui(f,x.x,x.y,c?s[0]:s[e[y+0]]);let P=this.addVertex(f,p);Ui(f,w.x,w.y,S);let O=this.addVertex(f,p);Ui(f,I.x,I.y,D);let F=this.addVertex(f,p);this.outIndices.emplaceBack(P,O,F)}}addQuad(e,n,s,c,f,p){let y=this.addVertex(e,f,p),x=this.addVertex(n,f,p),w=this.addVertex(s,f,p),I=this.addVertex(c,f,p);this.addTriangle(y,x,w),this.addTriangle(w,I,y)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class Fo{constructor(e,n,s,c){this.unevaluatedPortals=new nd,this.portalPolygons=new RS,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new um,this.vertexNormals=new dm,this.indexArray=new di,this.tileToMeters=oe(e),this.bridgeProgramConfigurations=new Ro(n,{zoom:s,lut:c},f=>f!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new Ro(n,{zoom:s,lut:c},f=>f!=="fill-bridge-guard-rail-color")}addVertices(e,n){let s=this.unevalVertices.length;for(let c=0;c<e.length;c++)this.unevalVertices.push(e[c]),this.unevalHeights.push(n[c]);return s}addTriangles(e,n,s){let c=s?this.unevalTunnelTriangles:this.unevalTriangles;for(let f of e)c.push(f+n)}addRenderableRing(e,n,s,c,f,p){let y=[new Xe(f.min.x,f.min.y),new Xe(f.max.x,f.min.y),new Xe(f.max.x,f.max.y),new Xe(f.min.x,f.max.y)];for(let x=0;x<s-1;x++){let w=n+x,I=w+1,S=this.unevalVertices[w],D=this.unevalVertices[I];if(!(S.x>=f.min.x&&S.x<=f.max.x&&S.y>=f.min.y&&S.y<=f.max.y||D.x>=f.min.x&&D.x<=f.max.x&&D.y>=f.min.y&&D.y<=f.max.y||Si(S,D,y))||this.isOnBorder(S.x,D.x)||this.isOnBorder(S.y,D.y))continue;let P=Fo.computeEdgeHash(this.unevalVertices[w],this.unevalVertices[I]),O,F=this.vertexHashLookup.get(Fo.computePosHash(S));F!=null?O=F.next:(F=this.vertexHashLookup.get(Fo.computePosHash(D)),O=F!=null?F.prev:P),this.unevalEdges.push({polygonIdx:e,a:w,b:I,hash:P,portalHash:O,isTunnel:c,type:"unevaluated",featureInfo:p})}}addPortalCandidates(e,n,s,c,f){if(n.length===0)return;this.portalPolygons.add(e,{geometry:n,zLevel:f});let p=n[0];this.vertexHashLookup.clear();let y=Fo.computeEdgeHash(p[p.length-2],p[p.length-1]);for(let x=0;x<p.length-1;x++){let w=p[x+0],I=p[x+1],S=Eo(I.x-w.x,I.y-w.y),D=fa(S);if(D===0)continue;let P="unevaluated",O=c.pointElevation(w),F=c.pointElevation(I);Math.abs(O)<.01&&Math.abs(F)<.01?P="entrance":(this.isOnBorder(w.x,I.x)||this.isOnBorder(w.y,I.y))&&(P="border");let B=Fo.computeEdgeHash(w,I);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:w,vb:I,vab:S,length:D,hash:B,isTunnel:s,type:P});let H=Fo.computePosHash(w);this.vertexHashLookup.set(H,{prev:y,next:B}),y=B}}construct(e){if(this.unevalVertices.length===0)return;let n=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=D=>{D.primitiveLength=this.indexArray.length-D.primitiveOffset},c=new yk(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);let f=n(),p=n(),y=n(),x=(D,P)=>{D.sort((F,B)=>F.type===P&&B.type!==P?-1:F.type!==P&&B.type===P?1:0);let O=D.findIndex(F=>F.type!==P);return O>=0?O:D.length},w=0;this.unevalEdges.length>0&&(w=x(this.unevalEdges,"none"),this.constructBridgeStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},this.tileToMeters)),s(y);let I=n(),S=n();if(this.unevalEdges.length>0){let D=this.unevalEdges.splice(w),P=x(D,"tunnel")+w;this.unevalEdges.push(...D),this.constructTunnelStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},{min:w,max:P})}s(I),c.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(S),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(p),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(f),this.maskSegments=gi.simpleSegment(0,S.primitiveOffset,0,S.primitiveLength),this.depthSegments=gi.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.renderableBridgeSegments=gi.simpleSegment(0,y.primitiveOffset,0,y.primitiveLength),this.renderableTunnelSegments=gi.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.shadowCasterSegments=gi.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength)}update(e,n,s,c,f,p,y,x){this.bridgeProgramConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x),this.tunnelProgramConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,sk.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,ak.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,n,s,c,f){let p=(y,x)=>{for(let w=0;w<x.length-1;w++){let I=x[w].featureIndex,S=x[w+1].vertexStart,D=e.feature(I);y.populatePaintArrays(S,D,I,{},s,n,c,void 0,f)}};p(this.bridgeProgramConfigurations,this.bridgeFeatureSections),p(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,n,s,c,f){let p=new Map;for(let y=c;y<f;y++){let x=s[y],w=x.a,I=x.b,S=Fo.computePosHash(e[w]),D=Fo.computePosHash(e[I]),P=p.get(S);P||(P={},p.set(S,P));let O=p.get(D);O||(O={},p.set(D,O)),n[w]<=0&&n[I]<=0||(P.to=I,O.from=w)}return p}isTerminalVertex(e,n){let s=Fo.computePosHash(this.unevalVertices[e]),c=n.get(s);return!c||!c.from||!c.to}constructBridgeStructures(e,n,s,c,f,p){e.clearVertexLookup();let y=this.computeVertexConnections(n,s,c,f.min,f.max),x=1/p,w=.5*x,I=(We,Je)=>Ui(We,n[Je].x,n[Je].y,s[Je]*x),S=Nn(),D=Nn(),P=Nn(),O=Nn(),F=Nn(),B=(We,Je)=>{let Oe=y.get(Fo.computePosHash(n[Je])),Ze=Oe.from,we=Oe.to;if(!Ze||!we)return;I(S,Ze),I(D,Je),I(P,we),ou(O),Go(S,D)||(zi(F,D,S),ci(O,F)),Go(P,D)||(zi(F,P,D),pi(O,O,ci(F,F)));let Le=ua(O);return Le>0?hi(We,O,1/Le):void 0},H=Number.POSITIVE_INFINITY;this.sortSubarray(c,f.min,f.max,(We,Je)=>We.featureInfo.featureIndex-Je.featureInfo.featureIndex);let X=Nn(),Z=Nn(),K=Nn(),de=Nn(),ae=Nn(),ce=Nn(),ge=Nn(),ye=Nn(),ke=Nn(),be=[Nn(),Nn(),Nn(),Nn()],ze=[Nn(),Nn(),Nn(),Nn()],et=[{coord:new Xe(0,0),height:0},{coord:new Xe(0,0),height:0}],Ve=(We,Je)=>We>Je;for(let We=f.min;We<f.max;We++){let Je=c[We];if(!Je.featureInfo.guardRailEnabled||!this.prepareEdgePoints(et,n,s,Je,Ve))continue;let[Oe,Ze]=et;if(Ui(X,Oe.coord.x,Oe.coord.y,x*Oe.height),Ui(Z,Ze.coord.x,Ze.coord.y,x*Ze.height),Go(X,Z))continue;zi(K,Z,X),ci(K,K);let we=B(ye,Je.a)||K,Le=B(ke,Je.b)||K;Ui(de,we[1],-we[0],0),ci(de,de),Ui(ae,Le[1],-Le[0],0),ci(ae,ae),Zi(ye,de,we),ci(ce,ye),Zi(ye,ae,Le),ci(ge,ye),pi(be[0],X,hi(ye,zi(ye,de,ce),w)),pi(be[1],X,hi(ye,pi(ye,de,ce),w)),pi(be[2],X,hi(ye,ce,w)),be[3]=X,pi(ze[0],Z,hi(ye,zi(ye,ae,ge),w)),pi(ze[1],Z,hi(ye,pi(ye,ae,ge),w)),pi(ze[2],Z,hi(ye,ge,w)),ze[3]=Z,H=this.addFeatureSection(Je.featureInfo.featureIndex,H,this.bridgeFeatureSections,e);let it=e.addVertex(be[0],de,p),Ye=e.addVertex(be[1],de,p),Et=e.addVertex(ze[0],ae,p),_t=e.addVertex(ze[1],ae,p);e.addTriangle(it,Ye,Et),e.addTriangle(Ye,_t,Et);let Ge=e.addVertex(be[1],ce,p),Ke=e.addVertex(be[2],ce,p),vt=e.addVertex(ze[1],ge,p),ht=e.addVertex(ze[2],ge,p);e.addTriangle(Ge,Ke,vt),e.addTriangle(Ke,ht,vt),aa(de,de),aa(ae,ae);let at=e.addVertex(be[2],de,p),ft=e.addVertex(be[3],de,p),Mt=e.addVertex(ze[2],ae,p),Bt=e.addVertex(ze[3],ae,p);e.addTriangle(at,ft,Mt),e.addTriangle(ft,Bt,Mt);let Wt=this.isTerminalVertex(Je.a,y),$t=this.isTerminalVertex(Je.b,y);Oe.height<.01&&Wt&&e.addQuad(be[3],be[2],be[1],be[0],aa(we,we),p),Ze.height<.01&&$t&&e.addQuad(ze[0],ze[1],ze[2],ze[3],Le,p)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,n,s,c,f,p){e.clearVertexLookup();let y=Number.POSITIVE_INFINITY,x=(H,X)=>H.featureInfo.featureIndex-X.featureInfo.featureIndex;this.sortSubarray(c,f.min,f.max,x),this.sortSubarray(c,p.min,p.max,x);let w=H=>ci(H,H),I=[{coord:new Xe(0,0),height:0},{coord:new Xe(0,0),height:0}],S=(H,X)=>H<X,D=Nn(),P=Nn(),O=Nn(),F=Nn(),B=Nn();for(let H=f.min;H<f.max;H++){if(!this.prepareEdgePoints(I,n,s,c[H],S))continue;let[X,Z]=I,K=w(Ui(B,-(Z.coord.y-X.coord.y),Z.coord.x-X.coord.x,0));y=this.addFeatureSection(c[H].featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad(Ui(D,X.coord.x,X.coord.y,X.height),Ui(P,Z.coord.x,Z.coord.y,Z.height),Ui(O,Z.coord.x,Z.coord.y,c[H].isTunnel?-.1:0),Ui(F,X.coord.x,X.coord.y,c[H].isTunnel?-.1:0),K)}for(let H=p.min;H<p.max;H++){let X=c[H];X.isTunnel&&([X.a,X.b]=[X.b,X.a]);let Z=n[X.a],K=n[X.b],de=w(Ui(B,-(K.y-Z.y),K.x-Z.x,0));y=this.addFeatureSection(X.featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad(Ui(D,K.x,K.y,0),Ui(P,Z.x,Z.y,0),Ui(O,Z.x,Z.y,s[X.a]+4),Ui(F,K.x,K.y,s[X.b]+4),de),e.addQuad(Ui(D,Z.x,Z.y,0),Ui(P,K.x,K.y,0),Ui(O,K.x,K.y,s[X.b]+4),Ui(F,Z.x,Z.y,s[X.a]+4),de)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,n,s,c){e.coord.x=n,e.coord.y=s,e.height=c}prepareEdgePoints(e,n,s,c,f){let p=n[c.a].x,y=n[c.a].y,x=n[c.b].x,w=n[c.b].y,I=s[c.a],S=s[c.b],D=f(I,0),P=f(S,0);if(D&&P)return this.setElevatedPoint(e[0],p,y,I),this.setElevatedPoint(e[1],x,w,S),!0;if(!D&&!P)return!1;if(D){if(!P){let O=S/(S-I);x=Ct(x,p,O),w=Ct(w,y,O),S=Ct(S,I,O)}}else{let O=I/(I-S);p=Ct(p,x,O),y=Ct(y,w,O),I=Ct(I,S,O)}return this.setElevatedPoint(e[0],p,y,I),this.setElevatedPoint(e[1],x,w,S),!0}prepareEdges(e,n){if(n.length===0)return;n.sort((y,x)=>y.hash===x.hash?x.polygonIdx-y.polygonIdx:x.hash>y.hash?1:-1);let s=0,c=0,f=0,p=n[s].polygonIdx;do c++,(c===n.length||n[s].hash!==n[c].hash)&&((c-s==1||n[c-1].polygonIdx!==p)&&(f<s&&(n[f]=n[s],n[s]=null),n[f].type="none",f++),s=c,s!==n.length&&(p=n[s].polygonIdx));while(s!==n.length);if(n.splice(f),n.length!==0&&e.length!==0){n.sort((w,I)=>w.portalHash<I.portalHash?1:-1);let y=0,x=0;for(;y!==n.length&&x!==e.length;){let w=n[y],I=e[x];w.portalHash>I.hash?y++:I.hash>w.portalHash?x++:(w.type=I.type,y++)}}}isOnBorder(e,n){return e<=0&&n<=0||e>=st&&n>=st}addFeatureSection(e,n,s,c){return e!==n&&(n=e,s.push({featureIndex:e,vertexStart:c.getVertexCount()}),c.clearVertexLookup()),n}sortSubarray(e,n,s,c){let f=e.slice(n,s);f.sort(c),e.splice(n,f.length,...f)}static computeEdgeHash(e,n){return(e.y===n.y&&e.x>n.x||e.y>n.y)&&([e,n]=[n,e]),BigInt(Fo.computePosHash(e))<<32n|BigInt(Fo.computePosHash(n))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var PS,OS={exports:{}},LS=(PS||(PS=1,function(i,e){(function(n){function s(Q,ee){return Q>ee?1:Q<ee?-1:0}var c=function(Q,ee){Q===void 0&&(Q=s),ee===void 0&&(ee=!1),this._compare=Q,this._root=null,this._size=0,this._noDuplicates=!!ee},f={size:{configurable:!0}};function p(Q,ee,Re,rt,ct){var lt=ct-rt;if(lt>0){var yt=rt+Math.floor(lt/2),kt={key:ee[yt],data:Re[yt],parent:Q};return kt.left=p(kt,ee,Re,rt,yt),kt.right=p(kt,ee,Re,yt+1,ct),kt}return null}function y(Q,ee,Re,rt,ct){if(!(Re>=rt)){for(var lt=Q[Re+rt>>1],yt=Re-1,kt=rt+1;;){do yt++;while(ct(Q[yt],lt)<0);do kt--;while(ct(Q[kt],lt)>0);if(yt>=kt)break;var ln=Q[yt];Q[yt]=Q[kt],Q[kt]=ln,ln=ee[yt],ee[yt]=ee[kt],ee[kt]=ln}y(Q,ee,Re,kt,ct),y(Q,ee,kt+1,rt,ct)}}c.prototype.rotateLeft=function(Q){var ee=Q.right;ee&&(Q.right=ee.left,ee.left&&(ee.left.parent=Q),ee.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=ee:Q.parent.right=ee:this._root=ee,ee&&(ee.left=Q),Q.parent=ee},c.prototype.rotateRight=function(Q){var ee=Q.left;ee&&(Q.left=ee.right,ee.right&&(ee.right.parent=Q),ee.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=ee:Q.parent.right=ee:this._root=ee,ee&&(ee.right=Q),Q.parent=ee},c.prototype._splay=function(Q){for(;Q.parent;){var ee=Q.parent;ee.parent?ee.left===Q&&ee.parent.left===ee?(this.rotateRight(ee.parent),this.rotateRight(ee)):ee.right===Q&&ee.parent.right===ee?(this.rotateLeft(ee.parent),this.rotateLeft(ee)):ee.left===Q&&ee.parent.right===ee?(this.rotateRight(ee),this.rotateLeft(ee)):(this.rotateLeft(ee),this.rotateRight(ee)):ee.left===Q?this.rotateRight(ee):this.rotateLeft(ee)}},c.prototype.splay=function(Q){for(var ee,Re,rt,ct,lt;Q.parent;)(Re=(ee=Q.parent).parent)&&Re.parent?((rt=Re.parent).left===Re?rt.left=Q:rt.right=Q,Q.parent=rt):(Q.parent=null,this._root=Q),ct=Q.left,lt=Q.right,Q===ee.left?(Re&&(Re.left===ee?(ee.right?(Re.left=ee.right,Re.left.parent=Re):Re.left=null,ee.right=Re,Re.parent=ee):(ct?(Re.right=ct,ct.parent=Re):Re.right=null,Q.left=Re,Re.parent=Q)),lt?(ee.left=lt,lt.parent=ee):ee.left=null,Q.right=ee,ee.parent=Q):(Re&&(Re.right===ee?(ee.left?(Re.right=ee.left,Re.right.parent=Re):Re.right=null,ee.left=Re,Re.parent=ee):(lt?(Re.left=lt,lt.parent=Re):Re.left=null,Q.right=Re,Re.parent=Q)),ct?(ee.right=ct,ct.parent=ee):ee.right=null,Q.left=ee,ee.parent=Q)},c.prototype.replace=function(Q,ee){Q.parent?Q===Q.parent.left?Q.parent.left=ee:Q.parent.right=ee:this._root=ee,ee&&(ee.parent=Q.parent)},c.prototype.minNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.left;)Q=Q.left;return Q},c.prototype.maxNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.right;)Q=Q.right;return Q},c.prototype.insert=function(Q,ee){var Re=this._root,rt=null,ct=this._compare;if(this._noDuplicates)for(;Re;){if(rt=Re,ct(Re.key,Q)===0)return;Re=ct(Re.key,Q)<0?Re.right:Re.left}else for(;Re;)rt=Re,Re=ct(Re.key,Q)<0?Re.right:Re.left;return Re={key:Q,data:ee,left:null,right:null,parent:rt},rt?ct(rt.key,Re.key)<0?rt.right=Re:rt.left=Re:this._root=Re,this.splay(Re),this._size++,Re},c.prototype.find=function(Q){for(var ee=this._root,Re=this._compare;ee;){var rt=Re(ee.key,Q);if(rt<0)ee=ee.right;else{if(!(rt>0))return ee;ee=ee.left}}return null},c.prototype.contains=function(Q){for(var ee=this._root,Re=this._compare;ee;){var rt=Re(Q,ee.key);if(rt===0)return!0;ee=rt<0?ee.left:ee.right}return!1},c.prototype.remove=function(Q){var ee=this.find(Q);if(!ee)return!1;if(this.splay(ee),ee.left)if(ee.right){var Re=this.minNode(ee.right);Re.parent!==ee&&(this.replace(Re,Re.right),Re.right=ee.right,Re.right.parent=Re),this.replace(ee,Re),Re.left=ee.left,Re.left.parent=Re}else this.replace(ee,ee.left);else this.replace(ee,ee.right);return this._size--,!0},c.prototype.removeNode=function(Q){if(!Q)return!1;if(this.splay(Q),Q.left)if(Q.right){var ee=this.minNode(Q.right);ee.parent!==Q&&(this.replace(ee,ee.right),ee.right=Q.right,ee.right.parent=ee),this.replace(Q,ee),ee.left=Q.left,ee.left.parent=ee}else this.replace(Q,Q.left);else this.replace(Q,Q.right);return this._size--,!0},c.prototype.erase=function(Q){var ee=this.find(Q);if(ee){this.splay(ee);var Re=ee.left,rt=ee.right,ct=null;Re&&(Re.parent=null,ct=this.maxNode(Re),this.splay(ct),this._root=ct),rt&&(Re?ct.right=rt:this._root=rt,rt.parent=ct),this._size--}},c.prototype.pop=function(){var Q=this._root,ee=null;if(Q){for(;Q.left;)Q=Q.left;ee={key:Q.key,data:Q.data},this.remove(Q.key)}return ee},c.prototype.next=function(Q){var ee=Q;if(ee)if(ee.right)for(ee=ee.right;ee&&ee.left;)ee=ee.left;else for(ee=Q.parent;ee&&ee.right===Q;)Q=ee,ee=ee.parent;return ee},c.prototype.prev=function(Q){var ee=Q;if(ee)if(ee.left)for(ee=ee.left;ee&&ee.right;)ee=ee.right;else for(ee=Q.parent;ee&&ee.left===Q;)Q=ee,ee=ee.parent;return ee},c.prototype.forEach=function(Q){for(var ee=this._root,Re=[],rt=!1,ct=0;!rt;)ee?(Re.push(ee),ee=ee.left):Re.length>0?(Q(ee=Re.pop(),ct++),ee=ee.right):rt=!0;return this},c.prototype.range=function(Q,ee,Re,rt){for(var ct=[],lt=this._compare,yt=this._root;ct.length!==0||yt;)if(yt)ct.push(yt),yt=yt.left;else{if(lt((yt=ct.pop()).key,ee)>0)break;if(lt(yt.key,Q)>=0&&Re.call(rt,yt))return this;yt=yt.right}return this},c.prototype.keys=function(){for(var Q=this._root,ee=[],Re=[],rt=!1;!rt;)Q?(ee.push(Q),Q=Q.left):ee.length>0?(Q=ee.pop(),Re.push(Q.key),Q=Q.right):rt=!0;return Re},c.prototype.values=function(){for(var Q=this._root,ee=[],Re=[],rt=!1;!rt;)Q?(ee.push(Q),Q=Q.left):ee.length>0?(Q=ee.pop(),Re.push(Q.data),Q=Q.right):rt=!0;return Re},c.prototype.at=function(Q){for(var ee=this._root,Re=[],rt=!1,ct=0;!rt;)if(ee)Re.push(ee),ee=ee.left;else if(Re.length>0){if(ee=Re.pop(),ct===Q)return ee;ct++,ee=ee.right}else rt=!0;return null},c.prototype.load=function(Q,ee,Re){if(Q===void 0&&(Q=[]),ee===void 0&&(ee=[]),Re===void 0&&(Re=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var rt=Q.length;return Re&&y(Q,ee,0,rt-1,this._compare),this._root=p(null,Q,ee,0,rt),this._size=rt,this},c.prototype.min=function(){var Q=this.minNode(this._root);return Q?Q.key:null},c.prototype.max=function(){var Q=this.maxNode(this._root);return Q?Q.key:null},c.prototype.isEmpty=function(){return this._root===null},f.size.get=function(){return this._size},c.createTree=function(Q,ee,Re,rt,ct){return new c(Re,ct).load(Q,ee,rt)},Object.defineProperties(c.prototype,f);var x=0,w=1,I=2,S=3,D=0,P=1,O=2,F=3;function B(Q,ee,Re){ee===null?(Q.inOut=!1,Q.otherInOut=!0):(Q.isSubject===ee.isSubject?(Q.inOut=!ee.inOut,Q.otherInOut=ee.otherInOut):(Q.inOut=!ee.otherInOut,Q.otherInOut=ee.isVertical()?!ee.inOut:ee.inOut),ee&&(Q.prevInResult=!H(ee,Re)||ee.isVertical()?ee.prevInResult:ee));var rt=H(Q,Re);Q.resultTransition=rt?function(ct,lt){var yt,kt=!ct.inOut,ln=!ct.otherInOut;switch(lt){case D:yt=kt&&ln;break;case P:yt=kt||ln;break;case F:yt=kt^ln;break;case O:yt=ct.isSubject?kt&&!ln:ln&&!kt}return yt?1:-1}(Q,Re):0}function H(Q,ee){switch(Q.type){case x:switch(ee){case D:return!Q.otherInOut;case P:return Q.otherInOut;case O:return Q.isSubject&&Q.otherInOut||!Q.isSubject&&!Q.otherInOut;case F:return!0}break;case I:return ee===D||ee===P;case S:return ee===O;case w:return!1}return!1}var X=function(Q,ee,Re,rt,ct){this.left=ee,this.point=Q,this.otherEvent=Re,this.isSubject=rt,this.type=ct||x,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},Z={inResult:{configurable:!0}};function K(Q,ee){return Q[0]===ee[0]&&Q[1]===ee[1]}X.prototype.isBelow=function(Q){var ee=this.point,Re=this.otherEvent.point;return this.left?(ee[0]-Q[0])*(Re[1]-Q[1])-(Re[0]-Q[0])*(ee[1]-Q[1])>0:(Re[0]-Q[0])*(ee[1]-Q[1])-(ee[0]-Q[0])*(Re[1]-Q[1])>0},X.prototype.isAbove=function(Q){return!this.isBelow(Q)},X.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},Z.inResult.get=function(){return this.resultTransition!==0},X.prototype.clone=function(){var Q=new X(this.point,this.left,this.otherEvent,this.isSubject,this.type);return Q.contourId=this.contourId,Q.resultTransition=this.resultTransition,Q.prevInResult=this.prevInResult,Q.isExteriorRing=this.isExteriorRing,Q.inOut=this.inOut,Q.otherInOut=this.otherInOut,Q},Object.defineProperties(X.prototype,Z);var de=11102230246251565e-32,ae=134217729,ce=(3+8*de)*de;function ge(Q,ee,Re,rt,ct){var lt,yt,kt,ln,cn=ee[0],Jt=rt[0],Hn=0,wi=0;Jt>cn==Jt>-cn?(lt=cn,cn=ee[++Hn]):(lt=Jt,Jt=rt[++wi]);var Zt=0;if(Hn<Q&&wi<Re)for(Jt>cn==Jt>-cn?(kt=lt-((yt=cn+lt)-cn),cn=ee[++Hn]):(kt=lt-((yt=Jt+lt)-Jt),Jt=rt[++wi]),lt=yt,kt!==0&&(ct[Zt++]=kt);Hn<Q&&wi<Re;)Jt>cn==Jt>-cn?(kt=lt-((yt=lt+cn)-(ln=yt-lt))+(cn-ln),cn=ee[++Hn]):(kt=lt-((yt=lt+Jt)-(ln=yt-lt))+(Jt-ln),Jt=rt[++wi]),lt=yt,kt!==0&&(ct[Zt++]=kt);for(;Hn<Q;)kt=lt-((yt=lt+cn)-(ln=yt-lt))+(cn-ln),cn=ee[++Hn],lt=yt,kt!==0&&(ct[Zt++]=kt);for(;wi<Re;)kt=lt-((yt=lt+Jt)-(ln=yt-lt))+(Jt-ln),Jt=rt[++wi],lt=yt,kt!==0&&(ct[Zt++]=kt);return lt===0&&Zt!==0||(ct[Zt++]=lt),Zt}function ye(Q){return new Float64Array(Q)}var ke=33306690738754716e-32,be=22204460492503146e-32,ze=11093356479670487e-47,et=ye(4),Ve=ye(8),We=ye(12),Je=ye(16),Oe=ye(4);function Ze(Q,ee,Re){var rt=function(ct,lt,yt,kt,ln,cn){var Jt=(lt-cn)*(yt-ln),Hn=(ct-ln)*(kt-cn),wi=Jt-Hn;if(Jt===0||Hn===0||Jt>0!=Hn>0)return wi;var Zt=Math.abs(Jt+Hn);return Math.abs(wi)>=ke*Zt?wi:-function(ai,Qn,Fn,yi,ii,ei,ti){var Bn,Qt,$n,vi,Ot,_n,ri,Di,li,tr,Wn,Yi,mo,Dr,xr,go,Na,nr,sr=ai-ii,Cr=Fn-ii,$r=Qn-ei,Fr=yi-ei;et[0]=(xr=(Di=sr-(ri=(_n=ae*sr)-(_n-sr)))*(tr=Fr-(li=(_n=ae*Fr)-(_n-Fr)))-((Dr=sr*Fr)-ri*li-Di*li-ri*tr))-((Wn=xr-(Na=(Di=$r-(ri=(_n=ae*$r)-(_n-$r)))*(tr=Cr-(li=(_n=ae*Cr)-(_n-Cr)))-((go=$r*Cr)-ri*li-Di*li-ri*tr)))+(Ot=xr-Wn))+(Ot-Na),et[1]=(mo=Dr-((Yi=Dr+Wn)-(Ot=Yi-Dr))+(Wn-Ot))-((Wn=mo-go)+(Ot=mo-Wn))+(Ot-go),et[2]=Yi-((nr=Yi+Wn)-(Ot=nr-Yi))+(Wn-Ot),et[3]=nr;var kc=function(S6,qA){for(var WA=qA[0],o1=1;o1<4;o1++)WA+=qA[o1];return WA}(0,et),hg=be*ti;if(kc>=hg||-kc>=hg||(Bn=ai-(sr+(Ot=ai-sr))+(Ot-ii),$n=Fn-(Cr+(Ot=Fn-Cr))+(Ot-ii),Qt=Qn-($r+(Ot=Qn-$r))+(Ot-ei),vi=yi-(Fr+(Ot=yi-Fr))+(Ot-ei),Bn===0&&Qt===0&&$n===0&&vi===0)||(hg=ze*ti+ce*Math.abs(kc),(kc+=sr*vi+Fr*Bn-($r*$n+Cr*Qt))>=hg||-kc>=hg))return kc;Oe[0]=(xr=(Di=Bn-(ri=(_n=ae*Bn)-(_n-Bn)))*(tr=Fr-(li=(_n=ae*Fr)-(_n-Fr)))-((Dr=Bn*Fr)-ri*li-Di*li-ri*tr))-((Wn=xr-(Na=(Di=Qt-(ri=(_n=ae*Qt)-(_n-Qt)))*(tr=Cr-(li=(_n=ae*Cr)-(_n-Cr)))-((go=Qt*Cr)-ri*li-Di*li-ri*tr)))+(Ot=xr-Wn))+(Ot-Na),Oe[1]=(mo=Dr-((Yi=Dr+Wn)-(Ot=Yi-Dr))+(Wn-Ot))-((Wn=mo-go)+(Ot=mo-Wn))+(Ot-go),Oe[2]=Yi-((nr=Yi+Wn)-(Ot=nr-Yi))+(Wn-Ot),Oe[3]=nr;var yz=ge(4,et,4,Oe,Ve);Oe[0]=(xr=(Di=sr-(ri=(_n=ae*sr)-(_n-sr)))*(tr=vi-(li=(_n=ae*vi)-(_n-vi)))-((Dr=sr*vi)-ri*li-Di*li-ri*tr))-((Wn=xr-(Na=(Di=$r-(ri=(_n=ae*$r)-(_n-$r)))*(tr=$n-(li=(_n=ae*$n)-(_n-$n)))-((go=$r*$n)-ri*li-Di*li-ri*tr)))+(Ot=xr-Wn))+(Ot-Na),Oe[1]=(mo=Dr-((Yi=Dr+Wn)-(Ot=Yi-Dr))+(Wn-Ot))-((Wn=mo-go)+(Ot=mo-Wn))+(Ot-go),Oe[2]=Yi-((nr=Yi+Wn)-(Ot=nr-Yi))+(Wn-Ot),Oe[3]=nr;var vz=ge(yz,Ve,4,Oe,We);Oe[0]=(xr=(Di=Bn-(ri=(_n=ae*Bn)-(_n-Bn)))*(tr=vi-(li=(_n=ae*vi)-(_n-vi)))-((Dr=Bn*vi)-ri*li-Di*li-ri*tr))-((Wn=xr-(Na=(Di=Qt-(ri=(_n=ae*Qt)-(_n-Qt)))*(tr=$n-(li=(_n=ae*$n)-(_n-$n)))-((go=Qt*$n)-ri*li-Di*li-ri*tr)))+(Ot=xr-Wn))+(Ot-Na),Oe[1]=(mo=Dr-((Yi=Dr+Wn)-(Ot=Yi-Dr))+(Wn-Ot))-((Wn=mo-go)+(Ot=mo-Wn))+(Ot-go),Oe[2]=Yi-((nr=Yi+Wn)-(Ot=nr-Yi))+(Wn-Ot),Oe[3]=nr;var xz=ge(vz,We,4,Oe,Je);return Je[xz-1]}(ct,lt,yt,kt,ln,cn,Zt)}(Q[0],Q[1],ee[0],ee[1],Re[0],Re[1]);return rt>0?-1:rt<0?1:0}function we(Q,ee){var Re=Q.point,rt=ee.point;return Re[0]>rt[0]?1:Re[0]<rt[0]?-1:Re[1]!==rt[1]?Re[1]>rt[1]?1:-1:function(ct,lt,yt,kt){return ct.left!==lt.left?ct.left?1:-1:Ze(yt,ct.otherEvent.point,lt.otherEvent.point)!==0?ct.isBelow(lt.otherEvent.point)?-1:1:!ct.isSubject&&lt.isSubject?1:-1}(Q,ee,Re)}function Le(Q,ee,Re){var rt=new X(ee,!1,Q,Q.isSubject),ct=new X(ee,!0,Q.otherEvent,Q.isSubject);return K(Q.point,Q.otherEvent.point)&&console.warn("what is that, a collapsed segment?",Q),rt.contourId=ct.contourId=Q.contourId,we(ct,Q.otherEvent)>0&&(Q.otherEvent.left=!0,ct.left=!1),Q.otherEvent.otherEvent=ct,Q.otherEvent=rt,Re.push(ct),Re.push(rt),Re}function it(Q,ee){return Q[0]*ee[1]-Q[1]*ee[0]}function Ye(Q,ee){return Q[0]*ee[0]+Q[1]*ee[1]}function Et(Q,ee,Re){var rt=function(ln,cn,Jt,Hn,wi){var Zt=[cn[0]-ln[0],cn[1]-ln[1]],ai=[Hn[0]-Jt[0],Hn[1]-Jt[1]];function Qn(_n,ri,Di){return[_n[0]+ri*Di[0],_n[1]+ri*Di[1]]}var Fn=[Jt[0]-ln[0],Jt[1]-ln[1]],yi=it(Zt,ai),ii=yi*yi,ei=Ye(Zt,Zt);if(ii>0){var ti=it(Fn,ai)/yi;if(ti<0||ti>1)return null;var Bn=it(Fn,Zt)/yi;return Bn<0||Bn>1?null:ti===0||ti===1?[Qn(ln,ti,Zt)]:Bn===0||Bn===1?[Qn(Jt,Bn,ai)]:[Qn(ln,ti,Zt)]}if((ii=(yi=it(Fn,Zt))*yi)>0)return null;var Qt=Ye(Zt,Fn)/ei,$n=Qt+Ye(Zt,ai)/ei,vi=Math.min(Qt,$n),Ot=Math.max(Qt,$n);return vi<=1&&Ot>=0?vi===1?[Qn(ln,vi>0?vi:0,Zt)]:Ot===0?[Qn(ln,Ot<1?Ot:1,Zt)]:[Qn(ln,vi>0?vi:0,Zt),Qn(ln,Ot<1?Ot:1,Zt)]:null}(Q.point,Q.otherEvent.point,ee.point,ee.otherEvent.point),ct=rt?rt.length:0;if(ct===0||ct===1&&(K(Q.point,ee.point)||K(Q.otherEvent.point,ee.otherEvent.point))||ct===2&&Q.isSubject===ee.isSubject)return 0;if(ct===1)return K(Q.point,rt[0])||K(Q.otherEvent.point,rt[0])||Le(Q,rt[0],Re),K(ee.point,rt[0])||K(ee.otherEvent.point,rt[0])||Le(ee,rt[0],Re),1;var lt=[],yt=!1,kt=!1;return K(Q.point,ee.point)?yt=!0:we(Q,ee)===1?lt.push(ee,Q):lt.push(Q,ee),K(Q.otherEvent.point,ee.otherEvent.point)?kt=!0:we(Q.otherEvent,ee.otherEvent)===1?lt.push(ee.otherEvent,Q.otherEvent):lt.push(Q.otherEvent,ee.otherEvent),yt&&kt||yt?(ee.type=w,Q.type=ee.inOut===Q.inOut?I:S,yt&&!kt&&Le(lt[1].otherEvent,lt[0].point,Re),2):kt?(Le(lt[0],lt[1].point,Re),3):lt[0]!==lt[3].otherEvent?(Le(lt[0],lt[1].point,Re),Le(lt[1],lt[2].point,Re),3):(Le(lt[0],lt[1].point,Re),Le(lt[3].otherEvent,lt[2].point,Re),3)}function _t(Q,ee){if(Q===ee)return 0;if(Ze(Q.point,Q.otherEvent.point,ee.point)!==0||Ze(Q.point,Q.otherEvent.point,ee.otherEvent.point)!==0)return K(Q.point,ee.point)?Q.isBelow(ee.otherEvent.point)?-1:1:Q.point[0]===ee.point[0]?Q.point[1]<ee.point[1]?-1:1:we(Q,ee)===1?ee.isAbove(Q.point)?-1:1:Q.isBelow(ee.point)?-1:1;if(Q.isSubject!==ee.isSubject)return Q.isSubject?-1:1;var Re=Q.point,rt=ee.point;return Re[0]===rt[0]&&Re[1]===rt[1]?(Re=Q.otherEvent.point)[0]===(rt=ee.otherEvent.point)[0]&&Re[1]===rt[1]?0:Q.contourId>ee.contourId?1:-1:we(Q,ee)===1?1:-1}var Ge=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function Ke(Q,ee,Re,rt){var ct,lt=Q+1,yt=ee[Q].point,kt=ee.length;for(lt<kt&&(ct=ee[lt].point);lt<kt&&ct[0]===yt[0]&&ct[1]===yt[1];){if(!Re[lt])return lt;++lt<kt&&(ct=ee[lt].point)}for(lt=Q-1;Re[lt]&&lt>rt;)lt--;return lt}Ge.prototype.isExterior=function(){return this.holeOf==null};var vt=at,ht=at;function at(Q,ee){if(!(this instanceof at))return new at(Q,ee);if(this.data=Q||[],this.length=this.data.length,this.compare=ee||ft,this.length>0)for(var Re=(this.length>>1)-1;Re>=0;Re--)this._down(Re)}function ft(Q,ee){return Q<ee?-1:Q>ee?1:0}at.prototype={push:function(Q){this.data.push(Q),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var Q=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),Q}},peek:function(){return this.data[0]},_up:function(Q){for(var ee=this.data,Re=this.compare,rt=ee[Q];Q>0;){var ct=Q-1>>1,lt=ee[ct];if(Re(rt,lt)>=0)break;ee[Q]=lt,Q=ct}ee[Q]=rt},_down:function(Q){for(var ee=this.data,Re=this.compare,rt=this.length>>1,ct=ee[Q];Q<rt;){var lt=1+(Q<<1),yt=lt+1,kt=ee[lt];if(yt<this.length&&Re(ee[yt],kt)<0&&(lt=yt,kt=ee[yt]),Re(kt,ct)>=0)break;ee[Q]=kt,Q=lt}ee[Q]=ct}},vt.default=ht;var Mt=Math.max,Bt=Math.min,Wt=0;function $t(Q,ee,Re,rt,ct,lt){var yt,kt,ln,cn,Jt,Hn;for(yt=0,kt=Q.length-1;yt<kt;yt++)if(cn=Q[yt+1],Jt=new X(ln=Q[yt],!1,void 0,ee),Hn=new X(cn,!1,Jt,ee),Jt.otherEvent=Hn,ln[0]!==cn[0]||ln[1]!==cn[1]){Jt.contourId=Hn.contourId=Re,lt||(Jt.isExteriorRing=!1,Hn.isExteriorRing=!1),we(Jt,Hn)>0?Hn.left=!0:Jt.left=!0;var wi=ln[0],Zt=ln[1];ct[0]=Bt(ct[0],wi),ct[1]=Bt(ct[1],Zt),ct[2]=Mt(ct[2],wi),ct[3]=Mt(ct[3],Zt),rt.push(Jt),rt.push(Hn)}}var pn=[];function nn(Q,ee,Re){typeof Q[0][0][0]=="number"&&(Q=[Q]),typeof ee[0][0][0]=="number"&&(ee=[ee]);var rt=function(Zt,ai,Qn){var Fn=null;return Zt.length*ai.length==0&&(Qn===D?Fn=pn:Qn===O?Fn=Zt:Qn!==P&&Qn!==F||(Fn=Zt.length===0?ai:Zt)),Fn}(Q,ee,Re);if(rt)return rt===pn?null:rt;var ct=[1/0,1/0,-1/0,-1/0],lt=[1/0,1/0,-1/0,-1/0],yt=function(Zt,ai,Qn,Fn,yi){var ii,ei,ti,Bn,Qt,$n,vi=new vt(null,we);for(ti=0,Bn=Zt.length;ti<Bn;ti++)for(Qt=0,$n=(ii=Zt[ti]).length;Qt<$n;Qt++)(ei=Qt===0)&&Wt++,$t(ii[Qt],!0,Wt,vi,Qn,ei);for(ti=0,Bn=ai.length;ti<Bn;ti++)for(Qt=0,$n=(ii=ai[ti]).length;Qt<$n;Qt++)ei=Qt===0,yi===O&&(ei=!1),ei&&Wt++,$t(ii[Qt],!1,Wt,vi,Fn,ei);return vi}(Q,ee,ct,lt,Re);if(rt=function(Zt,ai,Qn,Fn,yi){var ii=null;return(Qn[0]>Fn[2]||Fn[0]>Qn[2]||Qn[1]>Fn[3]||Fn[1]>Qn[3])&&(yi===D?ii=pn:yi===O?ii=Zt:yi!==P&&yi!==F||(ii=Zt.concat(ai))),ii}(Q,ee,ct,lt,Re))return rt===pn?null:rt;for(var kt=function(Zt){var ai,Qn,Fn=function(ti){var Bn,Qt,$n,vi,Ot=[];for(Qt=0,$n=ti.length;Qt<$n;Qt++)((Bn=ti[Qt]).left&&Bn.inResult||!Bn.left&&Bn.otherEvent.inResult)&&Ot.push(Bn);for(var _n=!1;!_n;)for(_n=!0,Qt=0,$n=Ot.length;Qt<$n;Qt++)Qt+1<$n&&we(Ot[Qt],Ot[Qt+1])===1&&(vi=Ot[Qt],Ot[Qt]=Ot[Qt+1],Ot[Qt+1]=vi,_n=!1);for(Qt=0,$n=Ot.length;Qt<$n;Qt++)(Bn=Ot[Qt]).otherPos=Qt;for(Qt=0,$n=Ot.length;Qt<$n;Qt++)(Bn=Ot[Qt]).left||(vi=Bn.otherPos,Bn.otherPos=Bn.otherEvent.otherPos,Bn.otherEvent.otherPos=vi);return Ot}(Zt),yi={},ii=[],ei=function(){if(!yi[ai]){var ti=ii.length,Bn=function(Ot,_n,ri){var Di=new Ge;if(Ot.prevInResult!=null){var li=Ot.prevInResult,tr=li.outputContourId;if(li.resultTransition>0){var Wn=_n[tr];if(Wn.holeOf!=null){var Yi=Wn.holeOf;_n[Yi].holeIds.push(ri),Di.holeOf=Yi,Di.depth=_n[tr].depth}else _n[tr].holeIds.push(ri),Di.holeOf=tr,Di.depth=_n[tr].depth+1}else Di.holeOf=null,Di.depth=_n[tr].depth}else Di.holeOf=null,Di.depth=0;return Di}(Fn[ai],ii,ti),Qt=function(Ot){yi[Ot]=!0,Ot<Fn.length&&Fn[Ot]&&(Fn[Ot].outputContourId=ti)},$n=ai,vi=ai;for(Bn.points.push(Fn[ai].point);Qt($n),Qt($n=Fn[$n].otherPos),Bn.points.push(Fn[$n].point),!(($n=Ke($n,Fn,yi,vi))==vi||$n>=Fn.length)&&Fn[$n];);ii.push(Bn)}};for(ai=0,Qn=Fn.length;ai<Qn;ai++)ei();return ii}(function(Zt,ai,Qn,Fn,yi,ii){for(var ei,ti,Bn,Qt=new c(_t),$n=[],vi=Math.min(Fn[2],yi[2]);Zt.length!==0;){var Ot=Zt.pop();if($n.push(Ot),ii===D&&Ot.point[0]>vi||ii===O&&Ot.point[0]>Fn[2])break;if(Ot.left){ti=ei=Qt.insert(Ot),ei=ei!==(Bn=Qt.minNode())?Qt.prev(ei):null,ti=Qt.next(ti);var _n=ei?ei.key:null;if(B(Ot,_n,ii),ti&&Et(Ot,ti.key,Zt)===2&&(B(Ot,_n,ii),B(ti.key,Ot,ii)),ei&&Et(ei.key,Ot,Zt)===2){var ri=ei;B(_n,(ri=ri!==Bn?Qt.prev(ri):null)?ri.key:null,ii),B(Ot,_n,ii)}}else ti=ei=Qt.find(Ot=Ot.otherEvent),ei&&ti&&(ei=ei!==Bn?Qt.prev(ei):null,ti=Qt.next(ti),Qt.remove(Ot),ti&&ei&&Et(ei.key,ti.key,Zt))}return $n}(yt,0,0,ct,lt,Re)),ln=[],cn=0;cn<kt.length;cn++){var Jt=kt[cn];if(Jt.isExterior()){for(var Hn=[Jt.points],wi=0;wi<Jt.holeIds.length;wi++)Hn.push(kt[Jt.holeIds[wi]].points);ln.push(Hn)}}return ln}var ni={UNION:P,DIFFERENCE:O,INTERSECTION:D,XOR:F};n.diff=function(Q,ee){return nn(Q,ee,O)},n.intersection=function(Q,ee){return nn(Q,ee,D)},n.operations=ni,n.union=function(Q,ee){return nn(Q,ee,P)},n.xor=function(Q,ee){return nn(Q,ee,F)},Object.defineProperty(n,"__esModule",{value:!0})})(e)}(0,OS.exports)),OS.exports);function Zy(i,e,n,s){let c=[],f=s===0?(p,y,x,w,I,S)=>{p.push(new Xe(S,x+(S-y)/(w-y)*(I-x)))}:(p,y,x,w,I,S)=>{p.push(new Xe(y+(S-x)/(I-x)*(w-y),S))};for(let p of i){let y=[];for(let x of p){if(x.length<=2)continue;let w=[];for(let D=0;D<x.length-1;D++){let P=x[D].x,O=x[D].y,F=x[D+1].x,B=x[D+1].y,H=s===0?P:O,X=s===0?F:B;H<e?X>e&&f(w,P,O,F,B,e):H>n?X<n&&f(w,P,O,F,B,n):w.push(x[D]),X<e&&H>=e&&f(w,P,O,F,B,e),X>n&&H<=n&&f(w,P,O,F,B,n)}let I=x[x.length-1],S=s===0?I.x:I.y;S>=e&&S<=n&&w.push(I),w.length&&(I=w[w.length-1],w[0].x===I.x&&w[0].y===I.y||w.push(w[0]),y.push(w))}y.length&&c.push(y)}return c}function vk(i,e){let n=tw(i),s=tw([e]),c=LS.intersection(n,s);return c==null?[]:kS(c)}function xk(i,e){let s=tw(i,65536);for(;e.valid();e.next()){let[c,f]=e.get(),p=c.x*65536,y=c.y*65536,x=f.x*65536,w=f.y*65536,I=x-p,S=w-y,D=Math.hypot(I,S),P=Math.trunc(S/D*3),O=-Math.trunc(I/D*3);s=LS.diff(s,[[[p,y],[x,w],[x+P,w+O],[p+P,y+O],[p,y]]])}return kS(s,1/65536)}function tw(i,e=1){return[i.map(n=>n.map(s=>[s.x*e,s.y*e]))]}function kS(i,e=1){return i.map(n=>n.map((s,c)=>{let f=s.map(p=>new Xe(p[0]*e,p[1]*e).round());return c>0&&f.reverse(),f}))}class nw{constructor(e,n){this.layoutVertexArray=new ro,this.indexArray=new di,this.lineIndexArray=new Es,this.triangleSegments=new gi,this.lineSegments=new gi,this.programConfigurations=new Ro(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,n&&(this.elevatedLayoutVertexArray=new ml)}update(e,n,s,c,f,p,y,x){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,rk.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,ok.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,n,s,c,f,p,y){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,s,c,f,p,void 0,y)}}class iw{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new nw(e,!1),this.elevationBufferData=new nw(e,!0),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){this.hasPattern=Qb("fill",this.layers,this.pixelRatio,n);let f=this.layers[0].layout.get("fill-sort-key"),p=[];for(let{feature:y,id:x,index:w,sourceLayerIndex:I}of e){let S=this.layers[0]._featureFilter.needGeometry,D=Pe(y,S);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom,{worldview:this.worldview}),D,s))continue;let P=f?f.evaluate(D,{},s,n.availableImages):void 0,O={id:x,properties:y.properties,type:y.type,sourceLayerIndex:I,index:w,geometry:S?D.geometry:pe(y,s,c),patterns:{},sortKey:P};p.push(O)}f&&p.sort((y,x)=>y.sortKey-x.sortKey);for(let y of p){let{geometry:x,index:w,sourceLayerIndex:I}=y;if(this.hasPattern){let S=ew("fill",this.layers,y,this.zoom,this.pixelRatio,n);this.patternFeatures.push(S)}else this.addFeature(y,x,w,s,{},n.availableImages,n.brightness,n.elevationFeatures);n.featureIndex.insert(e[w].feature,x,w,I,this.index)}}update(e,n,s,c,f,p,y){this.bufferData.update(e,n,s,c,f,p,y,this.worldview),this.elevationBufferData.update(e,n,s,c,f,p,y,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,n,s,c,f,p,y,this.worldview)}addFeatures(e,n,s,c,f,p){for(let y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,n,s,c,p,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,n,s,c,f,p=[],y,x){let w=km(n,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,w,c,s,x):this.addGeometry(w,this.bufferData),this.bufferData.populatePaintArrays(e,s,f,p,c,y,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,f,p,c,y,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,n,s,c,f){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(n,s,c,f,this.worldview))}addElevatedRoadFeature(e,n,s,c,f){let p=new Array,y=_i.getElevationFeature(e,f);if(!y)return void this.addGeometry(n,this.bufferData);{let w=this.clipPolygonsToTile(n,1);w.length>0&&p.push({polygons:w,elevationFeature:y,elevationTileID:s})}let x={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:c};for(let w of p)if(w.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Fo(w.elevationTileID,this.layers,this.zoom,this.lut));let S=w.elevationFeature.isTunnel(),D=0;e.properties.hasOwnProperty(Tt)&&(D=+e.properties[Tt]);for(let P of w.polygons)this.elevatedStructures.addPortalCandidates(w.elevationFeature.id,P,S,w.elevationFeature,D)}w.elevationFeature.constantHeight==null&&(w.polygons=this.prepareElevatedPolygons(w.polygons,w.elevationFeature,w.elevationTileID));let I=new yn(s,w.elevationTileID);this.addElevatedGeometry(w.polygons,I,w.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,c,x)}}addElevatedGeometry(e,n,s,c,f,p){let y={elevation:s,elevationSampler:n,bias:c,index:f,featureInfo:p},[x,w]=this.addGeometry(e,this.elevationBufferData,y);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:x,max:w}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,x),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,w))}addGeometry(e,n,s){let c=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,p=null;s&&(p=s.elevationSampler.constantElevation(s.elevation,s.bias),p!=null&&(c=p,f=p));let y=(x,w,I)=>{if(s!=null)if(w.push(x),p!=null)n.elevatedLayoutVertexArray.emplaceBack(p),I.push(p);else{let S=s.elevationSampler.pointElevation(x,s.elevation,s.bias);n.elevatedLayoutVertexArray.emplaceBack(S),I.push(S),c=Math.min(c,S),f=Math.max(f,S)}};for(let x of e){let w=0;for(let Z of x)w+=Z.length;let I=n.triangleSegments.prepareSegment(w,n.layoutVertexArray,n.indexArray),S=I.vertexLength,D=[],P=[],O=[],F=[],B=[],H=n.layoutVertexArray.length;for(let Z of x){if(Z.length===0)continue;Z!==x[0]&&P.push(D.length/2);let K=n.lineSegments.prepareSegment(Z.length,n.layoutVertexArray,n.lineIndexArray),de=K.vertexLength;s&&B.push(n.layoutVertexArray.length-H),y(Z[0],O,F),n.layoutVertexArray.emplaceBack(Z[0].x,Z[0].y),n.lineIndexArray.emplaceBack(de+Z.length-1,de),D.push(Z[0].x),D.push(Z[0].y);for(let ae=1;ae<Z.length;ae++)y(Z[ae],O,F),n.layoutVertexArray.emplaceBack(Z[ae].x,Z[ae].y),n.lineIndexArray.emplaceBack(de+ae-1,de+ae),D.push(Z[ae].x),D.push(Z[ae].y);K.vertexLength+=Z.length,K.primitiveLength+=Z.length}let X=Yh(D,P);for(let Z=0;Z<X.length;Z+=3)n.indexArray.emplaceBack(S+X[Z],S+X[Z+1],S+X[Z+2]);if(X.length>0&&s&&this.elevationMode==="hd-road-base"){let Z=s.elevation.isTunnel(),K=s.elevation.safeArea,de=this.elevatedStructures.addVertices(O,F);this.elevatedStructures.addTriangles(X,de,Z);let ae=B.length;if(ae>0){for(let ce=0;ce<ae-1;ce++)this.elevatedStructures.addRenderableRing(s.index,B[ce]+de,B[ce+1]-B[ce],Z,K,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,B[ae-1]+de,O.length-B[ae-1],Z,K,s.featureInfo)}}I.vertexLength+=w,I.primitiveLength+=X.length/3}return[c,f]}prepareElevatedPolygons(e,n,s){let c=1/oe(s),f=[];for(let p of e){let y=xk(p,new zn(n,c));f.push(...y)}return f}clipPolygonsToTile(e,n){let s=-n,c=-n,f=st+n,p=st+n,y=0,x=[],w=[];for(;y<e.length;y++){let D=e[y],P=Ep(D);(P.min.x>=s&&P.max.x<=f&&P.min.y>=c&&P.max.y<=p?x:w).push(D)}if(x.length===e.length)return e;let I=[new Xe(s,c),new Xe(f,c),new Xe(f,p),new Xe(s,p),new Xe(s,c)],S=x;for(let D of w)S.push(...vk(D,I));return S}}let FS,NS,zS,BS;gt(iw,"FillBucket",{omit:["layers","patternFeatures"]}),gt(nw,"FillBufferData"),gt(Fo,"ElevatedStructures");class Xy{constructor(e,n,s,c){if(this.triangleCount=n.length/3,this.min=new Xe(0,0),this.max=new Xe(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;let[f,p]=[e[0].clone(),e[0].clone()];for(let S=1;S<e.length;++S){let D=e[S];f.x=Math.min(f.x,D.x),f.y=Math.min(f.y,D.y),p.x=Math.max(p.x,D.x),p.y=Math.max(p.y,D.y)}if(c){let S=Math.ceil(Math.max(p.x-f.x,p.y-f.y)/c);s=Math.max(s,S)}if(s===0)return;this.min=f,this.max=p;let y=this.max.sub(this.min);y.x=Math.max(y.x,1),y.y=Math.max(y.y,1);let x=Math.max(y.x,y.y)/s;this.cellsX=Math.max(1,Math.ceil(y.x/x)),this.cellsY=Math.max(1,Math.ceil(y.y/x)),this.xScale=1/x,this.yScale=1/x;let w=[];for(let S=0;S<this.triangleCount;S++){let D=e[n[3*S+0]].sub(this.min),P=e[n[3*S+1]].sub(this.min),O=e[n[3*S+2]].sub(this.min),F=ka(Math.floor(Math.min(D.x,P.x,O.x)),this.xScale,this.cellsX),B=ka(Math.floor(Math.max(D.x,P.x,O.x)),this.xScale,this.cellsX),H=ka(Math.floor(Math.min(D.y,P.y,O.y)),this.yScale,this.cellsY),X=ka(Math.floor(Math.max(D.y,P.y,O.y)),this.yScale,this.cellsY),Z=new Xe(0,0),K=new Xe(0,0),de=new Xe(0,0),ae=new Xe(0,0);for(let ce=H;ce<=X;++ce){Z.y=K.y=ce*x,de.y=ae.y=(ce+1)*x;for(let ge=F;ge<=B;++ge)Z.x=de.x=ge*x,K.x=ae.x=(ge+1)*x,(Qi(D,P,O,Z,K,ae)||Qi(D,P,O,Z,ae,de))&&w.push({cellIdx:ce*this.cellsX+ge,triIdx:S})}}if(w.length===0)return;w.sort((S,D)=>S.cellIdx-D.cellIdx||S.triIdx-D.triIdx);let I=0;for(;I<w.length;){let S=w[I].cellIdx,D={start:this.payload.length,len:0};for(;I<w.length&&w[I].cellIdx===S;)++D.len,this.payload.push(w[I++].triIdx);this.cells[S]=D}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,n){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;let s=ka(e.x-this.min.x,this.xScale,this.cellsX),c=ka(e.y-this.min.y,this.yScale,this.cellsY),f=this.cells[c*this.cellsX+s];if(f){this._lazyInitLookup();for(let p=0;p<f.len;p++){let y=this.payload[f.start+p],x=Math.floor(y/8),w=1<<y%8;if(!(this.lookup[x]&w)&&(this.lookup[x]|=w,n.push(y),n.length===this.triangleCount))return}}}query(e,n,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>n.x||e.y>this.max.y||this.min.y>n.y)return;this._lazyInitLookup();let c=ka(e.x-this.min.x,this.xScale,this.cellsX),f=ka(n.x-this.min.x,this.xScale,this.cellsX),p=ka(e.y-this.min.y,this.yScale,this.cellsY),y=ka(n.y-this.min.y,this.yScale,this.cellsY);for(let x=p;x<=y;x++)for(let w=c;w<=f;w++){let I=this.cells[x*this.cellsX+w];if(I)for(let S=0;S<I.len;S++){let D=this.payload[I.start+S],P=Math.floor(D/8),O=1<<D%8;if(!(this.lookup[P]&O)&&(this.lookup[P]|=O,s.push(D),s.length===this.triangleCount))return}}}}function ka(i,e,n){return Math.max(0,Math.min(n-1,Math.floor(i*e)))}gt(Xy,"TriangleGridIndex");class VS{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,n){for(let s of this.footprints)n.push({footprint:s,id:e})}populate(e,n,s,c){let f=[];for(let{feature:p,id:y,index:x,sourceLayerIndex:w}of e){let I=this.layers[0]._featureFilter.needGeometry,S=Pe(p,I);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom,{worldview:this.worldview}),S,s))continue;let D={id:y,properties:p.properties,type:p.type,sourceLayerIndex:w,index:x,geometry:I?S.geometry:pe(p,s,c),patterns:{}};f.push(D)}for(let p of f){let{geometry:y,index:x,sourceLayerIndex:w}=p;this.addFeature(p,y,x,s,{},n.availableImages,n.brightness),n.featureIndex.insert(e[x].feature,y,x,w,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,n,s,c,f,p,y){}destroy(){}addFeature(e,n,s,c,f,p=[],y){for(let x of km(n,2)){let w=[],I=[],S=[],D=new Xe(1/0,1/0),P=new Xe(-1/0,-1/0);for(let B of x)if(B.length!==0){B!==x[0]&&S.push(I.length/2);for(let H=0;H<B.length;H++)I.push(B[H].x),I.push(B[H].y),w.push(B[H]),D.x=Math.min(D.x,B[H].x),D.y=Math.min(D.y,B[H].y),P.x=Math.max(P.x,B[H].x),P.y=Math.max(P.y,B[H].y)}let O=Yh(I,S),F=new Xy(w,O,8,256);this.footprints.push({vertices:w,indices:O,grid:F,min:D,max:P})}}}gt(VS,"ClipBucket",{omit:["layers"]});let bk=gn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),wk=gn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Ek=gn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Tk=gn([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Ik=gn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Sk=gn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Dk}=bk,Fm=Number.MAX_SAFE_INTEGER,jS=Fm-1;function US(i,e,n,s){return i.order<e||i.order===Fm||!(i.clipMask&n)||function(c,f){return f.length!==0&&f.find(p=>p===c)===void 0}(s,i.clipScope)}function Yy(i,e){return i.x-e.x||i.y-e.y}function HS(i,e){return Yy(i.min,e.min)===0&&Yy(i.max,e.max)===0}function rw(i,e){return!(i.min.x>e.max.x||i.max.x<e.min.x||i.min.y>e.max.y||i.max.y<e.min.y)}function Ky(i,e){if(i.length!==e.length)return!1;for(let n=0;n<i.length;n++)if(i[n].sourceId!==e[n].sourceId||!HS(i[n],e[n])||i[n].order!==e[n].order||i[n].clipMask!==e[n].clipMask||!zs(i[n].clipScope,e[n].clipScope))return!1;return!0}function $S(i,e,n){let s=1/st,c=1/(1<<n.canonical.z),f=(e.x*s+n.canonical.x)*c+n.wrap,p=(e.y*s+n.canonical.y)*c;return{min:new Xe((i.x*s+n.canonical.x)*c+n.wrap,(i.y*s+n.canonical.y)*c),max:new Xe(f,p)}}function Ck(i,e,n){let s=1<<n.canonical.z,c=((e.x-n.wrap)*s-n.canonical.x)*st,f=(e.y*s-n.canonical.y)*st;return{min:new Xe(((i.x-n.wrap)*s-n.canonical.x)*st,(i.y*s-n.canonical.y)*st),max:new Xe(c,f)}}function ow(i,e,n,s,c,f,p){let y=i.indices,x=i.vertices,w=[];for(let I=s;I<s+c;I+=3){let S=e[n[I+0]+f],D=e[n[I+1]+f],P=e[n[I+2]+f],O=Math.min(S.x,D.x,P.x),F=Math.max(S.x,D.x,P.x),B=Math.min(S.y,D.y,P.y),H=Math.max(S.y,D.y,P.y);w.length=0,i.grid.query(new Xe(O,B),new Xe(F,H),w);for(let X=0;X<w.length;X++){let Z=w[X];if(Qi(x[y[3*Z+0]],x[y[3*Z+1]],x[y[3*Z+2]],S,D,P,p))return!0}}return!1}function GS(i,e,n,s){if(!i||!n)return!1;let c=i.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(n.vertices.length<i.vertices.length)return GS(n,s,i,e);let f=e.canonical,p=s.canonical,y=Math.pow(2,p.z-f.z);c=i.vertices.map(x=>new Xe((x.x+f.x*st)*y-p.x*st,(x.y+f.y*st)*y-p.y*st))}return ow(n,c,i.indices,0,i.indices.length,0,0)}function qS(i,e,n,s){let c=Math.pow(2,s.z-n.z);return new Xe((i+n.x*st)*c-s.x*st,(e+n.y*st)*c-s.y*st)}function sw(i,e){let n=[];e.grid.queryPoint(i,n);let s=e.indices,c=e.vertices;for(let f=0;f<n.length;f++){let p=n[f];if(Ir([c[s[3*p+0]],c[s[3*p+1]],c[s[3*p+2]]],i))return!0}return!1}let aw=[new Xe(0,0),new Xe(st,0),new Xe(st,st),new Xe(0,st)];function WS(i,e){let n=[],s=[];if(!e||i.length<2)return[i];if(i.length===2)return Si(i[0],i[1],aw)?[i]:[];for(let c=0;c<i.length+2;c++){let f=i[c%i.length],p=i[(c+1)%i.length],y=Si(c===0?i[i.length-1]:i[(c-1)%i.length],f,aw),x=Si(f,p,aw),w=y||x;w&&s.push(f),w&&x||s.length>0&&(s.length>1&&n.push(s),s=[])}return s.length>1&&n.push(s),n}let lw=Ie.types,Ak=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],Mk=["fill-extrusion-flood-light-ground-radius"],Rk=Math.pow(2,13),Pk=Math.pow(2,15)-1,ZS=new Xe(0,1),Ac=2147483648;function Nm(i,e,n,s,c,f,p,y){i.emplaceBack((e<<1)+p,(n<<1)+f,(Math.floor(s*Rk)<<1)+c,Math.round(y))}function zm(i,e,n){i.emplaceBack(e.x*st,e.y*st,n?1:0)}function Jy(i,e,n,s,c,f){i.emplaceBack(e.x,e.y,(n.x<<1)+s,(n.y<<1)+c,f)}function Bm(i,e,n){i.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class XS{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class YS{constructor(){this.centroidXY=new Xe(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Xe(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Xe(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Xe(this.max.x-this.min.x,this.max.y-this.min.y)}}class KS{constructor(){this.acc=new Xe(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,n){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=n.x,e.min.y=e.max.y=n.y)}appendEdge(e,n,s){this.accCount++,this.acc._add(n);let c=!!this.borders;n.x<e.min.x?(e.min.x=n.x,c=!0):n.x>e.max.x&&(e.max.x=n.x,c=!0),n.y<e.min.y?(e.min.y=n.y,c=!0):n.y>e.max.y&&(e.max.y=n.y,c=!0),((n.x===0||n.x===st)&&n.x===s.x)!=((n.y===0||n.y===st)&&n.y===s.y)&&this.processBorderOverlap(n,s),c&&this.checkBorderIntersection(n,s)}checkBorderIntersection(e,n){n.x<0!=e.x<0&&this.addBorderIntersection(0,Ct(n.y,e.y,(0-n.x)/(e.x-n.x))),n.x>st!=e.x>st&&this.addBorderIntersection(1,Ct(n.y,e.y,(st-n.x)/(e.x-n.x))),n.y<0!=e.y<0&&this.addBorderIntersection(2,Ct(n.x,e.x,(0-n.y)/(e.y-n.y))),n.y>st!=e.y>st&&this.addBorderIntersection(3,Ct(n.x,e.x,(st-n.y)/(e.y-n.y)))}addBorderIntersection(e,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let s=this.borders[e];n<s[0]&&(s[0]=n),n>s[1]&&(s[1]=n)}processBorderOverlap(e,n){if(e.x===n.x){if(e.y===n.y)return;let s=e.x===0?0:1;this.addBorderIntersection(s,n.y),this.addBorderIntersection(s,e.y)}else{let s=e.y===0?2:3;this.addBorderIntersection(s,n.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new Xe(0,0):new Xe(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,n)=>e+ +(n[0]!==Number.MAX_VALUE),0):0}}function JS(i,e){let n=i.add(e)._unit(),s=ne(i.x*n.x+i.y*n.y,-1,1);var c,f,p;return c=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(c)))/4*Pk*((f=i).x*(p=e).y-f.y*p.x<0?-1:1)}let Ok=[i=>i.x<0,i=>i.x>st,i=>i.y<0,i=>i.y>st];function Lk(i,e,n,s){let c=[4];if(s===0)return c;n._mult(s);let f=i.sub(n),p=e.sub(n),y=[i,e,f,p];for(let x=0;x<4;x++)for(let w of y)if(Ok[x](w)){c.push(x);break}return c}class cw{constructor(e){this.vertexArray=new Bh,this.indexArray=new di,this.programConfigurations=new Ro(e.layers,{zoom:e.zoom,lut:e.lut},n=>Mk.includes(n)),this._segments=new gi,this.hiddenByLandmarkVertexArray=new Gh,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new gi}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,n,s,c=!1){let f=e.length;if(f>2){let p=Math.max(0,this._segments.get().length-1),y=this._segments._prepareSegment(4*f,this.vertexArray.length,2*this._segmentToGroundQuads[p].length),x;p!==this._segments.get().length-1&&(p++,this._segmentToGroundQuads[p]=[],this._segmentToRegionTriCounts[p]=[0,0,0,0,0]);{let w=e[0],I=e[1];x=JS(w.sub(e[f-1])._perp()._unit(),I.sub(w)._perp()._unit())}for(let w=0;w<f;w++){let I=w===f-1?0:w+1,S=e[w],D=e[I],P=e[I===f-1?0:I+1],O=D.sub(S)._perp()._unit(),F=JS(O,P.sub(D)._perp()._unit()),B=x,H=F;if(uw(S,D,n)||c&&tD(S,n)&&tD(D,n)){x=F;continue}let X=y.vertexLength;Jy(this.vertexArray,S,D,1,1,B),Jy(this.vertexArray,S,D,1,0,B),Jy(this.vertexArray,S,D,0,1,H),Jy(this.vertexArray,S,D,0,0,H),y.vertexLength+=4;let Z=Lk(S,D,O,s);for(let K of Z)this._segmentToGroundQuads[p].push({id:X,region:K}),this._segmentToRegionTriCounts[p][K]+=2,y.primitiveLength+=2;x=F}}}prepareBorderSegments(){if(!this.hasData())return;let e=this._segments.get(),n=e.length;for(let s=0;s<n;s++)this._segmentToGroundQuads[s].sort((c,f)=>c.region-f.region);for(let s=0;s<n;s++){let c=this._segmentToGroundQuads[s],f=e[s],p=this._segmentToRegionTriCounts[s];p.reduce((x,w)=>x+w,0);let y=0;for(let x=0;x<=4;x++){let w=p[x];if(w!==0){let I=this.regionSegments[x];I||(I=this.regionSegments[x]=new gi);let S={vertexOffset:f.vertexOffset,primitiveOffset:f.primitiveOffset+y,vertexLength:f.vertexLength,primitiveLength:w};I.get().push(S)}y+=w}for(let x=0;x<c.length;x++){let w=c[x].id;this.indexArray.emplaceBack(w,w+1,w+3),this.indexArray.emplaceBack(w,w+3,w+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,n,s,c,f,p,y){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,n,s,c,f,p,void 0,y)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,wk.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,n,s,c,f,p,y,x){this.hasData()&&this.programConfigurations.updatePaintArrays(e,n,s,c,f,p,y,x)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Ac))}updateHiddenByLandmarkRange(e,n,s){if(!this.hasData())return;let c=n+e;if(n!==0){for(let f=e;f<c;++f)this.hiddenByLandmarkVertexArray.emplace(f,s?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,Ik.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){let n=this.regionSegments[e];n&&n.destroy()}}}}class Qy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new di,this.footprintVertices=new ro,this.footprintSegments=[],this.layoutVertexArray=new gc,this.centroidVertexArray=new Py,this.wallVertexArray=new Ly,this.indexArray=new di,this.programConfigurations=new Ro(e.layers,{zoom:e.zoom,lut:e.lut},n=>Ak.includes(n)),this.segments=new gi,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new cw(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){this.features=[],this.hasPattern=Qb("fill-extrusion",this.layers,this.pixelRatio,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=oe(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:f,id:p,index:y,sourceLayerIndex:x}of e){let w=this.layers[0]._featureFilter.needGeometry,I=Pe(f,w);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom,{worldview:this.worldview}),I,s))continue;let S={id:p,sourceLayerIndex:x,index:y,geometry:w?I.geometry:pe(f,s,c),properties:f.properties,type:f.type,patterns:{}},D=this.layoutVertexArray.length,P=lw[S.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:f.id,feature:ew("fill-extrusion",this.layers,S,this.zoom,this.pixelRatio,n)});else if(this.wallMode)for(let O of S.geometry)for(let F of WS(O,P))this.addFeature(f.id,S,[F],y,s,{},n.availableImages,c,n.brightness);else this.addFeature(f.id,S,S.geometry,y,s,{},n.availableImages,c,n.brightness);n.featureIndex.insert(f,S.geometry,y,x,this.index,D)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,n,s,c,f,p){for(let{featureId:y,feature:x}of this.features){let w=lw[x.type]==="Polygon",{geometry:I}=x;if(this.wallMode)for(let S of I)for(let D of WS(S,w))this.addFeature(y,x,[D],x.index,n,s,c,f,p);else this.addFeature(y,x,I,x.index,n,s,c,f,p)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,n,s,c,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview),this.groundEffect.update(e,n,f,s,c,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Dk),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,Tk.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Sk.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Ek.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,n,s,c,f,p,y,x,w){let I=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(n,{})/this.tileToMeter,S=[new Xe(0,0),new Xe(st,st)],D=x.projection,P=D.name==="globe",O=this.wallMode||lw[n.type]==="Polygon",F=new KS;F.centroidDataIndex=this.centroidData.length;let B=new YS;B.buildingId=e,n.properties&&n.properties.hasOwnProperty("building_id")&&(B.buildingId=n.properties.building_id);let H=this.layers[0].paint.get("fill-extrusion-base").evaluate(n,{},f)<=0,X=this.layers[0].paint.get("fill-extrusion-height").evaluate(n,{},f),Z;if(B.height=X,B.vertexArrayOffset=this.layoutVertexArray.length,B.groundVertexArrayOffset=this.groundEffect.vertexArray.length,P&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new jh),this.wallMode){if(P)return void fn("Non zero fill-extrusion-line-width is not yet supported on globe.");if(s.length!==1)return;Z=function(be){let ze=be[0].x===be[be.length-1].x&&be[0].y===be[be.length-1].y;(function(Ke){let vt=0,ht=Ke.length;for(let at=0;at<ht;at++)vt+=(Ke[(at+1)%ht].x-Ke[at].x)*(Ke[(at+1)%ht].y+Ke[at].y);return vt>=0})(be)||(be=be.reverse());let Ve={geometry:[],joinNormals:[],indices:[]},We=[],Je=[],Oe=[],Ze=be.length;for(;Ze>=2&&be[Ze-1].equals(be[Ze-2]);)Ze--;if(Ze<(ze?3:2))return Ve;let we,Le,it,Ye,Et,_t=0;for(;_t<Ze-1&&be[_t].equals(be[_t+1]);)_t++;ze&&(we=be[Ze-2],Et=be[_t].sub(we)._unit()._perp());for(let Ke=_t;Ke<Ze;Ke++){if(it=Ke===Ze-1?ze?be[_t+1]:void 0:be[Ke+1],it&&be[Ke].equals(it))continue;Et&&(Ye=Et),we&&(Le=we),we=be[Ke],Et=it?it.sub(we)._unit()._perp():Ye,Ye=Ye||Et;let vt=Ye.add(Et);vt.x===0&&vt.y===0||vt._unit();let ht=vt.x*Et.x+vt.y*Et.y,at=ht!==0?1/ht:1/0,ft=Ye.x*Et.y-Ye.y*Et.x>0,Mt="miter",Bt=2;Mt==="miter"&&at>Bt&&(Mt="bevel"),Mt==="bevel"&&(at>100&&(Mt="flipbevel"),at<Bt&&(Mt="miter"));let Wt=($t,pn,nn,ni)=>{let Q=new Xe($t.x,$t.y),ee=new Xe($t.x,$t.y);Q.x+=pn.x*ni,Q.y+=pn.y*ni,ee.x-=pn.x*Math.max(nn,1),ee.y-=pn.y*Math.max(nn,1),Oe.push(pn),We.push(Q),Je.push(ee)};if(Mt==="miter")vt._mult(at),Wt(we,vt,0,0);else if(Mt==="flipbevel")vt=Et.mult(-1),Wt(we,vt,0,0),Wt(we,vt.mult(-1),0,0);else{let $t=-Math.sqrt(at*at-1),pn=ft?$t:0,nn=ft?0:$t;Le&&Wt(we,Ye,pn,nn),it&&Wt(we,Et,pn,nn)}}Ve.geometry=[...We,...Je.reverse(),We[0]],Ve.joinNormals=[...Oe,...Oe.reverse(),Oe[Oe.length-1]];let Ge=Ve.geometry.length-1;for(let Ke=0;Ke<Ge/2;Ke++)if(Ke+1<Ge/2){let vt=Ke,ht=Ke+1,at=Ge-1-Ke,ft=Ge-2-Ke;vt=vt===0?Ge-1:vt-1,ht=ht===0?Ge-1:ht-1,at=at===0?Ge-1:at-1,ft=ft===0?Ge-1:ft-1,Ve.indices.push(at),Ve.indices.push(ht),Ve.indices.push(vt),Ve.indices.push(at),Ve.indices.push(ft),Ve.indices.push(ht)}return Ve}(s[0]),s=[Z.geometry]}let K=(be,ze)=>be<(ze.length-1)/2||be===ze.length-1,de=this.wallMode?[s]:km(s,500);for(let be=de.length-1;be>=0;be--){let ze=de[be];(ze.length===0||(ae=ze[0]).every(et=>et.x<=0)||ae.every(et=>et.x>=st)||ae.every(et=>et.y<=0)||ae.every(et=>et.y>=st))&&de.splice(be,1)}var ae;let ce;if(P)ce=oD(de,S,f);else{ce=[];for(let be of de)ce.push({polygon:be,bounds:S})}let ge=O?this.edgeRadius:0,ye=ge>0&&this.zoom<17,ke=(be,ze)=>{if(be.length===0)return!1;let et=be[be.length-1];return ze.x===et.x&&ze.y===et.y};for(let{polygon:be,bounds:ze}of ce){let et=0,Ve=0;for(let Ze of be)O&&!Ze[0].equals(Ze[Ze.length-1])&&Ze.push(Ze[0]),Ve+=O?Ze.length-1:Ze.length;let We=this.segments.prepareSegment((O?5:4)*Ve,this.layoutVertexArray,this.indexArray);B.footprintSegIdx<0&&(B.footprintSegIdx=this.footprintSegments.length),B.polygonSegIdx<0&&(B.polygonSegIdx=this.polygonSegments.length);let Je={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Oe=new XS;if(Oe.vertexOffset=this.footprintVertices.length,Oe.indexOffset=3*this.footprintIndices.length,Oe.ringIndices=[],O){let Ze=[],we=[];et=We.vertexLength;for(let it=0;it<be.length;it++){let Ye=be[it];Ye.length&&it!==0&&we.push(Ze.length/2);let Et=[],_t,Ge;_t=Ye[1].sub(Ye[0])._perp()._unit(),Oe.ringIndices.push(Ye.length-1);for(let Ke=1;Ke<Ye.length;Ke++){let vt=Ye[Ke],ht=Ye[Ke===Ye.length-1?1:Ke+1],at=vt.clone();if(ge){Ge=ht.sub(vt)._perp()._unit();let ft=_t.add(Ge)._unit(),Mt=ge*Math.min(4,1/(_t.x*ft.x+_t.y*ft.y));at.x+=Mt*ft.x,at.y+=Mt*ft.y,at.x=Math.round(at.x),at.y=Math.round(at.y),_t=Ge}if(!H||ge!==0&&!ye||ke(Et,at)||Et.push(at),Nm(this.layoutVertexArray,at.x,at.y,0,0,1,1,0),this.wallMode){let ft=K(Ke,Ye);zm(this.wallVertexArray,Z.joinNormals[Ke],!ft)}We.vertexLength++,this.footprintVertices.emplaceBack(vt.x,vt.y),Ze.push(vt.x,vt.y),P&&Bm(this.layoutVertexExtArray,D.projectTilePoint(at.x,at.y,f),D.upVector(f,at.x,at.y))}H&&(ge===0||ye)&&(Et.length!==0&&ke(Et,Et[0])&&Et.pop(),this.groundEffect.addData(Et,ze,I))}let Le=this.wallMode?Z.indices:Yh(Ze,we);for(let it=0;it<Le.length;it+=3)this.footprintIndices.emplaceBack(Oe.vertexOffset+Le[it+0],Oe.vertexOffset+Le[it+1],Oe.vertexOffset+Le[it+2]),this.indexArray.emplaceBack(et+Le[it],et+Le[it+2],et+Le[it+1]),We.primitiveLength++;Oe.indexCount+=Le.length,Oe.vertexCount+=this.footprintVertices.length-Oe.vertexOffset}for(let Ze=0;Ze<be.length;Ze++){let we=be[Ze];F.startRing(B,we[0]);let Le=we.length>4&&nD(we[we.length-2],we[0],we[1]),it=ge?kk(we[we.length-2],we[0],we[1],ge):0,Ye=[],Et,_t,Ge;_t=we[1].sub(we[0])._perp()._unit();let Ke=!0;for(let vt=1,ht=0;vt<we.length;vt++){let at=we[vt-1],ft=we[vt],Mt=we[vt===we.length-1?1:vt+1];if(F.appendEdge(B,ft,at),uw(ft,at,ze)){ge&&(_t=Mt.sub(ft)._perp()._unit(),Ke=!Ke);continue}let Bt=ft.sub(at)._perp(),Wt=Bt.x/(Math.abs(Bt.x)+Math.abs(Bt.y)),$t=Bt.y>0?1:0,pn=at.dist(ft);if(ht+pn>32768&&(ht=0),ge){Ge=Mt.sub(ft)._perp()._unit();let ee=eD(at,ft,Mt,QS(_t,Ge),ge);isNaN(ee)&&(ee=0);let Re=ft.sub(at)._unit();at=at.add(Re.mult(it))._round(),ft=ft.add(Re.mult(-ee))._round(),it=ee,_t=Ge,H&&this.zoom>=17&&(ke(Ye,at)||Ye.push(at),ke(Ye,ft)||Ye.push(ft))}let nn=We.vertexLength,ni=we.length>4&&nD(at,ft,Mt),Q=iD(ht,Le,Ke);if(Nm(this.layoutVertexArray,at.x,at.y,Wt,$t,0,0,Q),Nm(this.layoutVertexArray,at.x,at.y,Wt,$t,0,1,Q),this.wallMode){let ee=K(vt-1,we),Re=Z.joinNormals[vt-1];zm(this.wallVertexArray,Re,ee),zm(this.wallVertexArray,Re,ee)}if(ht+=pn,Q=iD(ht,ni,!Ke),Le=ni,Nm(this.layoutVertexArray,ft.x,ft.y,Wt,$t,0,0,Q),Nm(this.layoutVertexArray,ft.x,ft.y,Wt,$t,0,1,Q),this.wallMode){let ee=K(vt,we),Re=Z.joinNormals[vt];zm(this.wallVertexArray,Re,ee),zm(this.wallVertexArray,Re,ee)}if(We.vertexLength+=4,this.indexArray.emplaceBack(nn+0,nn+1,nn+2),this.indexArray.emplaceBack(nn+1,nn+3,nn+2),We.primitiveLength+=2,ge){let ee=et+(vt===1?we.length-2:vt-2),Re=vt===1?et:ee+1;if(this.indexArray.emplaceBack(nn+1,ee,nn+3),this.indexArray.emplaceBack(ee,Re,nn+3),We.primitiveLength+=2,Et===void 0&&(Et=nn),!uw(Mt,we[vt],ze)){let rt=vt===we.length-1?Et:We.vertexLength;this.indexArray.emplaceBack(nn+2,nn+3,rt),this.indexArray.emplaceBack(nn+3,rt+1,rt),this.indexArray.emplaceBack(nn+3,Re,rt+1),We.primitiveLength+=3}Ke=!Ke}if(P){let ee=this.layoutVertexExtArray,Re=D.projectTilePoint(at.x,at.y,f),rt=D.projectTilePoint(ft.x,ft.y,f),ct=D.upVector(f,at.x,at.y),lt=D.upVector(f,ft.x,ft.y);Bm(ee,Re,ct),Bm(ee,Re,ct),Bm(ee,rt,lt),Bm(ee,rt,lt)}}O&&(et+=we.length-1),H&&ge&&this.zoom>=17&&(Ye.length!==0&&ke(Ye,Ye[0])&&Ye.pop(),this.groundEffect.addData(Ye,ze,I,ge>0))}this.footprintSegments.push(Oe),Je.triangleCount=this.indexArray.length-Je.triangleArrayOffset,this.polygonSegments.push(Je),++B.footprintSegLen,++B.polygonSegLen}if(B.vertexCount=this.layoutVertexArray.length-B.vertexArrayOffset,B.groundVertexCount=this.groundEffect.vertexArray.length-B.groundVertexArrayOffset,B.vertexCount!==0){if(B.centroidXY=F.borders?ZS:this.encodeCentroid(F,B),this.centroidData.push(B),F.borders){this.featuresOnBorder.push(F);let be=this.featuresOnBorder.length-1;for(let ze=0;ze<F.borders.length;ze++)F.borders[ze][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ze].push(be)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,c,p,y,f,w,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(n,c,p,y,f,w,this.worldview),this.maxHeight=Math.max(this.maxHeight,X)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((n,s)=>this.featuresOnBorder[n].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){let e=[];for(let y=0;y<this.centroidData.length;y++){let x=this.centroidData[y],w=+(x.min.y+x.max.y>st),I=2*w+(+(x.min.x+x.max.x>st)^w);for(let S=0;S<x.polygonSegLen;S++){let D=x.polygonSegIdx+S;e.push({centroidIdx:y,subtile:I,polygonSegmentIdx:D,triangleSegmentIdx:this.polygonSegments[D].triangleSegIdx})}}let n=new di;e.sort((y,x)=>y.triangleSegmentIdx===x.triangleSegmentIdx?y.subtile-x.subtile:y.triangleSegmentIdx-x.triangleSegmentIdx);let s=0,c=0,f=0;for(let y of e){if(y.triangleSegmentIdx!==s)break;f++}let p=e.length;for(;c!==e.length;){s=e[c].triangleSegmentIdx;let y=0,x=c,w=c;for(let I=x;I<f&&e[I].subtile===y;I++)w++;for(;x!==f;){let I=e[x];y=I.subtile;let S=this.centroidData[I.centroidIdx].min.clone(),D=this.centroidData[I.centroidIdx].max.clone(),P={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:n.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let O=x;O<w;O++){let F=e[O],B=this.polygonSegments[F.polygonSegmentIdx],H=this.centroidData[F.centroidIdx].min,X=this.centroidData[F.centroidIdx].max,Z=this.indexArray.uint16;for(let K=B.triangleArrayOffset;K<B.triangleArrayOffset+B.triangleCount;K++)n.emplaceBack(Z[3*K],Z[3*K+1],Z[3*K+2]);P.primitiveLength+=B.triangleCount,S.x=Math.min(S.x,H.x),S.y=Math.min(S.y,H.y),D.x=Math.max(D.x,X.x),D.y=Math.max(D.y,X.y)}P.primitiveLength>0&&this.triangleSubSegments.push({segment:P,min:S,max:D}),x=w;for(let O=x;O<f&&e[O].subtile===e[x].subtile;O++)w++}c=f;for(let I=c;I<p&&e[I].triangleSegmentIdx===e[c].triangleSegmentIdx;I++)f++}n._trim(),this.indexArray=n}getVisibleSegments(e,n,s){let c=new gi;if(this.wallMode){for(let F of this.triangleSubSegments)c.segments.push(F.segment);return c}let f=0,p=0,y=1<<e.canonical.z;if(n){let F=n.getMinMaxForTile(e);F&&(f=F.min,p=F.max)}p+=this.maxHeight;let x=e.toUnwrapped(),w,I=[x.canonical.x/y+x.wrap,x.canonical.y/y],S=[(x.canonical.x+1)/y+x.wrap,(x.canonical.y+1)/y],D=(F,B,H)=>[F[0]*(1-H[0])+B[0]*H[0],F[1]*(1-H[1])+B[1]*H[1]],P=[],O=[];for(let F of this.triangleSubSegments){P[0]=F.min.x/st,P[1]=F.min.y/st,O[0]=F.max.x/st,O[1]=F.max.y/st;let B=D(I,S,P),H=D(I,S,O);if(new sn([B[0],B[1],f],[H[0],H[1],p]).intersectsPrecise(s)===0){w&&(c.segments.push(w),w=void 0);continue}let X=F.segment;w&&w.vertexOffset!==X.vertexOffset&&(c.segments.push(w),w=void 0),w?(w.vertexLength+=X.vertexLength,w.primitiveLength+=X.primitiveLength):w={vertexOffset:X.vertexOffset,primitiveLength:X.primitiveLength,vertexLength:X.vertexLength,primitiveOffset:X.primitiveOffset,sortKey:void 0,vaos:{}}}return w&&c.segments.push(w),c}encodeCentroid(e,n){let s=e.centroid(),c=n.span(),f=Math.min(7,Math.round(c.x*this.tileToMeter/10)),p=Math.min(7,Math.round(c.y*this.tileToMeter/10));return new Xe(ne(s.x,1,st-1)<<3|f,ne(s.y,1,st-1)<<3|p)}encodeBorderCentroid(e){if(!e.borders)return new Xe(0,0);let n=e.borders,s=Number.MAX_VALUE;if(n[0][0]!==s||n[1][0]!==s){let c=n[0][0]!==s?0:1;return new Xe(6|(n[0][0]!==s?0:65528),(n[c][0]+n[c][1])/2<<3|6)}{let c=n[2][0]!==s?2:3;return new Xe((n[c][0]+n[c][1])/2<<3|6,6|(n[2][0]!==s?0:65528))}}showCentroid(e){let n=this.centroidData[e.centroidDataIndex];n.flags&=2147483647,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);let n=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,c=e.flags&Ac?ZS:e.centroidXY,f=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==c.y||f!==c.x){for(let p=n;p<s;++p)this.centroidVertexArray.emplace(p,c.x,c.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,n,s){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let c=n.getReplacementRegionsForTile(e.toUnwrapped());if(Ky(this.activeReplacements,c))return;if(this.activeReplacements=c,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let p of this.centroidData)p.flags&=2147483647;let f=[];for(let p of this.activeReplacements){if(p.order<s)continue;let y=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));if(p.footprint.buildingId){let x=p.footprint.buildingId;for(let w of this.centroidData)w.buildingId===x&&(w.flags|=Ac)}else for(let x of this.centroidData)if(!(x.flags&Ac||p.min.x>x.max.x||x.min.x>p.max.x||p.min.y>x.max.y||x.min.y>p.max.y))for(let w=0;w<x.footprintSegLen;w++){let I=this.footprintSegments[x.footprintSegIdx+w];if(f.length=0,Fk(this.footprintVertices,I.vertexOffset,I.vertexCount,p.footprintTileId.canonical,e.canonical,f),ow(p.footprint,f,this.footprintIndices.uint16,I.indexOffset,I.indexCount,-I.vertexOffset,-y)){x.flags|=Ac;break}}}for(let p of this.centroidData)this.writeCentroidToBuffer(p);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,n,s){let c=!1;for(let f=0;f<s.footprintSegLen;f++){let p=this.footprintSegments[s.footprintSegIdx+f],y=0;for(let x of p.ringIndices){for(let w=y,I=x+y-1;w<x+y;I=w++){let S=this.footprintVertices.int16[2*(w+p.vertexOffset)+0],D=this.footprintVertices.int16[2*(w+p.vertexOffset)+1],P=this.footprintVertices.int16[2*(I+p.vertexOffset)+1];D>n!=P>n&&e<(this.footprintVertices.int16[2*(I+p.vertexOffset)+0]-S)*(n-D)/(P-D)+S&&(c=!c)}y=x}}return c}getHeightAtTileCoord(e,n){let s=Number.NEGATIVE_INFINITY,c=!0,f=4*(e+st)*st+(n+st);if(this.partLookup.hasOwnProperty(f)){let p=this.partLookup[f];return p?{height:p.height,hidden:!!(p.flags&Ac)}:void 0}for(let p of this.centroidData)e>p.max.x||p.min.x>e||n>p.max.y||p.min.y>n||p.height<=s||this.footprintContainsPoint(e,n,p)&&(s=p.height,this.partLookup[f]=p,c=!!(p.flags&Ac));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:c};this.partLookup[f]=void 0}}function QS(i,e){let n=i.add(e)._unit();return i.x*n.x+i.y*n.y}function kk(i,e,n,s){let c=e.sub(i)._perp()._unit(),f=n.sub(e)._perp()._unit();return eD(i,e,n,QS(c,f),s)}function eD(i,e,n,s,c){let f=Math.sqrt(1-s*s);return Math.min(i.dist(e)/3,e.dist(n)/3,c*f/s)}function uw(i,e,n){return i.x<n[0].x&&e.x<n[0].x||i.x>n[1].x&&e.x>n[1].x||i.y<n[0].y&&e.y<n[0].y||i.y>n[1].y&&e.y>n[1].y}function tD(i,e){return i.x<e[0].x||i.x>e[1].x||i.y<e[0].y||i.y>e[1].y}function nD(i,e,n){if(i.x<0||i.x>=st||e.x<0||e.x>=st||n.x<0||n.x>=st)return!1;let s=n.sub(e),c=s.perp(),f=i.sub(e);return(s.x*f.x+s.y*f.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(f.x*f.x+f.y*f.y))>-.866&&c.x*f.x+c.y*f.y<0}function iD(i,e,n){let s=e?2|i:-3&i;return n?1|s:-2&s}function rD(){let i=Math.PI/32,e=Math.tan(i),n=T;return n*Math.sqrt(1+2*e*e)-n}function oD(i,e,n){let s=1<<n.z,c=W(n.x/s),f=W((n.x+1)/s),p=Y(n.y/s),y=Y((n.y+1)/s);return function(x,w,I,S,D=0,P){let O=[];if(!x.length||!I||!S)return O;let F=(ae,ce)=>{for(let ge of ae)O.push({polygon:ge,bounds:ce})},B=Math.ceil(Math.log2(I)),H=Math.ceil(Math.log2(S)),X=B-H,Z=[];for(let ae=0;ae<Math.abs(X);ae++)Z.push(X>0?0:1);for(let ae=0;ae<Math.min(B,H);ae++)Z.push(0),Z.push(1);let K=x;if(K=Zy(K,w[0].y-D,w[1].y+D,1),K=Zy(K,w[0].x-D,w[1].x+D,0),!K.length)return O;let de=[];for(Z.length?de.push({polygons:K,bounds:w,depth:0}):F(K,w);de.length;){let ae=de.pop(),ce=ae.depth,ge=Z[ce],ye=ae.bounds[0],ke=ae.bounds[1],be=ge===0?ye.x:ye.y,ze=ge===0?ke.x:ke.y,et=P?P(ge,be,ze):.5*(be+ze),Ve=Zy(ae.polygons,be-D,et+D,ge),We=Zy(ae.polygons,et-D,ze+D,ge);if(Ve.length){let Je=[ye,new Xe(ge===0?et:ke.x,ge===1?et:ke.y)];Z.length>ce+1?de.push({polygons:Ve,bounds:Je,depth:ce+1}):F(Ve,Je)}if(We.length){let Je=[new Xe(ge===0?et:ye.x,ge===1?et:ye.y),ke];Z.length>ce+1?de.push({polygons:We,bounds:Je,depth:ce+1}):F(We,Je)}}return O}(i,e,Math.ceil((f-c)/11.25),Math.ceil((p-y)/11.25),1,(x,w,I)=>{if(x===0)return .5*(w+I);{let S=Y((n.y+w/st)/s);return(U(.5*(Y((n.y+I/st)/s)+S))*s-n.y)*st}})}function Fk(i,e,n,s,c,f){let p=Math.pow(2,s.z-c.z);for(let y=0;y<n;y++){let x=i.int16[2*(y+e)+0],w=i.int16[2*(y+e)+1];x=(x+c.x*st)*p-s.x*st,w=(w+c.y*st)*p-s.y*st,f.push(new Xe(x,w))}}let sD,aD;gt(Qy,"FillExtrusionBucket",{omit:["layers","features"]}),gt(YS,"PartData"),gt(XS,"FootprintSegment"),gt(KS,"BorderCentroidData"),gt(cw,"GroundEffect");class id extends Xe{constructor(e,n,s){super(e,n),this.z=s}}class lD extends id{constructor(e,n,s,c){super(e,n,s),this.w=c}}function cD(i,e,n,s){let c=n==="x"?"y":"x",f=(s-i[n])/(e[n]-i[n]);i[c]=Math.round(i[c]+(e[c]-i[c])*f),i[n]=s,i.hasOwnProperty("z")&&(i.z=Ct(i.z,e.z,f)),i.hasOwnProperty("w")&&(i.w=Ct(i.w,e.w,f))}function uD(i,e,n,s){let c=n,f=s;for(let p of["x","y"]){let y=i,x=e;y[p]>=x[p]&&(y=e,x=i),y[p]<c&&x[p]>c&&cD(y,x,p,c),y[p]<f&&x[p]>f&&cD(x,y,p,f)}}function ev(i,e,n,s,c,f){let p=[];for(let y=0;y<i.length;y++){let x=i[y],w,I=p.length,S=0;for(let D=0;D<x.length-1;D++){let P=x[D],O=x[D+1],F=0,B=S,H,X;f&&(F=Math.hypot(O.x-P.x,O.y-P.y),S+=F,H=P,X=O),P.x<e&&O.x<e||(P.x<e?P=new Xe(e,P.y+(e-P.x)/(O.x-P.x)*(O.y-P.y))._round():O.x<e&&(O=new Xe(e,P.y+(e-P.x)/(O.x-P.x)*(O.y-P.y))._round()),P.y<n&&O.y<n||(P.y<n?P=new Xe(P.x+(n-P.y)/(O.y-P.y)*(O.x-P.x),n)._round():O.y<n&&(O=new Xe(P.x+(n-P.y)/(O.y-P.y)*(O.x-P.x),n)._round()),P.x>=s&&O.x>=s||(P.x>=s?P=new Xe(s,P.y+(s-P.x)/(O.x-P.x)*(O.y-P.y))._round():O.x>=s&&(O=new Xe(s,P.y+(s-P.x)/(O.x-P.x)*(O.y-P.y))._round()),P.y>=c&&O.y>=c||(P.y>=c?P=new Xe(P.x+(c-P.y)/(O.y-P.y)*(O.x-P.x),c)._round():O.y>=c&&(O=new Xe(P.x+(c-P.y)/(O.y-P.y)*(O.x-P.x),c)._round()),w&&P.equals(w[w.length-1])||(w=[P],p.push(w),f&&f.push({progress:{min:B+dD(H,X,P)*F,max:1},parentIndex:y,prevPoint:H,nextPoint:X})),w.push(O),f&&(f[f.length-1].progress.max=B+dD(H,X,O)*F,f[f.length-1].nextPoint=X)))))}if(f&&S>0)for(let D=I;D<p.length;D++)f[D].progress.min/=S,f[D].progress.max/=S}return p}function Nk(i,e,n,s,c){if(i.length<2)return void s.push(i);let f=[];for(;e.valid();){let[w,I]=e.get();for(let S=0;S<i.length-1;S++){let D=i[S],P=i[S+1],O=po(D,P,w,I);if(O){let[F]=O,B=new Xe(Ct(D.x,P.x,F),Ct(D.y,P.y,F));f.push({t:S+F,distance:0,point:B})}}e.next()}if(f.length===0)return void s.push(i);f.sort((w,I)=>w.t-I.t);let p=0,y=0,x=[];for(s.push(x);p!==i.length;){if(y===f.length){for(;p!==i.length;)x.length!==0&&x[x.length-1].equals(i[p])||x.push(i[p]),p++;break}f[y].t<=p?(x.length!==0&&x[x.length-1].equals(f[y].point)||x.push(f[y].point),Math.trunc(f[y].t),y++):(x.length!==0&&x[x.length-1].equals(i[p])||x.push(i[p]),p++)}}function dD(i,e,n){return i.x!==e.x?(n.x-i.x)/(e.x-i.x):i.y!==e.y?(n.y-i.y)/(e.y-i.y):0}function Vm(i,e){return i.x*e.x+i.y*e.y}function hD(i,e){if(i.length===1){let n=0,s=e[n++],c;for(;!c||s.equals(c);)if(c=e[n++],!c)return 1/0;for(;n<e.length;n++){let f=e[n],p=i[0],y=c.sub(s),x=f.sub(s),w=p.sub(s),I=Vm(y,y),S=Vm(y,x),D=Vm(x,x),P=Vm(w,y),O=Vm(w,x),F=I*D-S*S,B=(D*P-S*O)/F,H=(I*O-S*P)/F,X=s.z*(1-B-H)+c.z*B+f.z*H;if(isFinite(X))return X}return 1/0}{let n=1/0;for(let s of e)n=Math.min(n,s.z);return n}}function fD(i,e,n,s,c,f,p,y){let x=p*c.getElevationAt(i,e,!0,!0),w=f[0]!==0,I=w?f[1]===0?p*(f[0]/7-450):p*function(S,D,P){let O=Math.floor(D[0]/8),F=Math.floor(D[1]/8),B=10*(D[0]-8*O),H=10*(D[1]-8*F),X=S.getElevationAt(O,F,!0,!0),Z=S.getMeterToDEM(P),K=Math.floor(.5*(B*Z-1)),de=Math.floor(.5*(H*Z-1)),ae=S.tileCoordToPixel(O,F),ce=2*K+1,ge=2*de+1,ye=function(We,Je,Oe,Ze,we){return[We.getElevationAtPixel(Je,Oe,!0),We.getElevationAtPixel(Je+we,Oe,!0),We.getElevationAtPixel(Je,Oe+we,!0),We.getElevationAtPixel(Je+Ze,Oe+we,!0)]}(S,ae.x-K,ae.y-de,ce,ge),ke=Math.abs(ye[0]-ye[1]),be=Math.abs(ye[2]-ye[3]),ze=Math.abs(ye[0]-ye[2])+Math.abs(ye[1]-ye[3]),et=Math.min(.25,.5*Z*(ke+be)/ce),Ve=Math.min(.25,.5*Z*ze/ge);return X+Math.max(et*B,Ve*H)}(c,f,y):x;return{base:x+(n===0?-1:n),top:w?Math.max(I+s,x+n+2):x+s}}class zk{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class Bk{constructor(){this.tasks={},this.taskQueue=[],Ft(["process"],this),this.invoker=new zk(this.process),this.nextId=0}add(e,n){let s=this.nextId++,c=function({type:f,isSymbolTile:p,zoom:y}){return y=y||0,f==="message"?0:f!=="maybePrepare"||p?f!=="parseTile"||p?f==="parseTile"&&p?300-y:f==="maybePrepare"&&p?400-y:500:200-y:100-y}(n);if(c===0){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:n,priority:c,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;let e=this.pick();if(e===null)return;let n=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let e=null,n=1/0;for(let c=0;c<this.taskQueue.length;c++){let f=this.tasks[this.taskQueue[c]];f.priority<n&&(n=f.priority,e=c)}if(e===null)return null;let s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class pD{constructor(e,n,s){this.target=e,this.parent=n,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Ft(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new Bk}send(e,n,s,c,f=!1,p){let y=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=p,this.callbacks[y]=s);let x=new Set;return this.target.postMessage({id:y,type:e,hasCallback:!!s,targetMapId:c,mustQueue:f,sourceMapId:this.mapId,data:$s(n,x)},x),{cancel:()=>{s&&delete this.callbacks[y],this.target.postMessage({id:y,type:"<cancel>",targetMapId:c,sourceMapId:this.mapId})}}}receive(e){let n=e.data;if(!n)return;let s=n.id;if(s&&(!n.targetMapId||this.mapId===n.targetMapId))if(n.type==="<cancel>"){let c=this.cancelCallbacks[s];delete this.cancelCallbacks[s],c&&c.cancel()}else if(n.mustQueue||Gn(self)){let c=this.callbacks[s],f=this.scheduler.add(()=>this.processTask(s,n),c&&c.metadata||{type:"message"});f&&(this.cancelCallbacks[s]=f)}else this.processTask(s,n)}processTask(e,n){if(delete this.cancelCallbacks[e],n.type==="<response>"){let s=this.callbacks[e];delete this.callbacks[e],s&&(n.error?s(io(n.error)):s(null,io(n.data)))}else{let s=new Set,c=n.hasCallback?(p,y)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:p?$s(p):null,data:$s(y,s)},s)}:()=>{},f=io(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,f,c);else if(this.parent.getWorkerSource){let p=n.type.split("."),{source:y,scope:x}=f;this.parent.getWorkerSource(n.sourceMapId,p[0],y,x)[p[1]](f,c)}else c(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var jm={workerUrl:"",workerClass:null,workerParams:void 0};let dw="mapboxgl_preloaded_worker_pool",tv=(()=>{class i{constructor(){this.active={}}acquire(n,s=i.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<s;)this.workers.push(jm.workerClass!=null?new jm.workerClass:new self.Worker(jm.workerUrl,jm.workerParams));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.workers&&this.numActive()===0&&(this.workers.forEach(s=>{s.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[dw]}numActive(){return Object.keys(this.active).length}}return i.workerCount=2,i})();class Jh{constructor(e,n,s="Worker",c=tv.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=je();let f=this.workerPool.acquire(this.id,c);for(let p=0;p<f.length;p++){let y=new Jh.Actor(f[p],n,this.id);y.name=`${s} ${p}`,this.actors.push(y)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,n,s){ve(this.actors,(c,f)=>{c.send(e,n,f)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Um,hw;function nv(){return Um||(Um=new tv),Um}Jh.Actor=pD;class Vk{constructor(e){this.module=e}createIntArray(e){let n=new Int32Array(e),s=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heap32.set(n,s/n.BYTES_PER_ELEMENT),s}createFloatArray(e){let n=new Float32Array(e),s=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heapF32.set(n,s/n.BYTES_PER_ELEMENT),s}createStringBuffer(e){let n=this.module.malloc(e.length+1);for(let s=0;s<e.length;++s)this.module.heapU8[n+s]=e.charCodeAt(s);return this.module.heapU8[n+e.length]=0,n}readStringBuffer(e){let n="";for(;this.module.heapU8[e]!==0;)n+=String.fromCharCode(this.module.heapU8[e]),++e;return n}setStyle(e){let n=e.entranceColorRgb,s=e.facadeGlazingColorRgb,c=e.roofColorRgb,f=e.wallColorRgb,p=e.normalScale;this.module.setStyle(n[0],n[1],n[2],s[0],s[1],s[2],c[0],c[1],c[2],f[0],f[1],f[2],p[0],p[1],p[2],e.tileToMeters)}setAOOptions(e,n){this.module.setAOOptions(e?1:0,n)}setMetricOptions(e,n){this.module.setMetricOptions(e?1:0,n)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,n){this.module.setFacadeOptions(e,n?1:0)}setFauxFacadeOptions(e,n,s){this.module.setFauxFacadeOptions(e?1:0,n?1:0,s)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,n){for(let y of e){let x=this.createStringBuffer(y.roofType),w=[0],I=[];for(let P of y.coordinates)if(Array.isArray(P)){for(let O of P)I.push(O.x),I.push(O.y);w.push(I.length)}let S=this.createIntArray(w),D=this.createFloatArray(I);this.module.addFeature(y.id,y.sourceId,y.minHeight,y.height,x,y.roofType.length,D,S,w.length-1),this.module.free(x),this.module.free(S),this.module.free(D)}for(let y of n){let x;x=y.entrances?JSON.parse(y.entrances):[];let w=this.createFloatArray(x),I=[];for(let D of y.coordinates)I.push(D.x),I.push(D.y);let S=this.createFloatArray(I);this.module.addFacade(y.sourceId,y.crossPerc,y.distanceToRoad,w,x.length,S,I.length),this.module.free(w),this.module.free(S)}if(!this.module.generateMesh()){let y=this.module.getLastError();return this.readStringBuffer(y)}let s=this.module.getMeshCount(),c=new Array(s);for(let y=0;y<s;y++){let x=this.module.getPositionsPtr(y),w=this.module.getPositionsLength(y),I=new Float32Array(this.module.heapF32.buffer,x,w),S=this.module.getNormalsPtr(y),D=this.module.getNormalsLength(y),P=new Float32Array(this.module.heapF32.buffer,S,D),O=this.module.getColorsPtr(y),F=this.module.getColorsLength(y),B=new Uint8Array(this.module.heapU8.buffer,O,F),H=this.module.getAOPtr(y),X=this.module.getAOLength(y),Z=new Float32Array(this.module.heapF32.buffer,H,X),K=this.module.getUVPtr(y),de=this.module.getUVLength(y),ae=new Float32Array(this.module.heapF32.buffer,K,de),ce=this.module.getFauxFacadePtr(y),ge=this.module.getFauxFacadeLength(y),ye=new Uint8Array(this.module.heapU8.buffer,ce,ge),ke=this.module.getIndicesPtr(y),be=this.module.getIndicesLength(y),ze=new Int32Array(this.module.heap32.buffer,ke,be),et=this.module.getBuildingPart(y),Ve=this.readStringBuffer(et);c[y]={positions:I,normals:P,colors:B,ao:Z,uv:ae,isFauxFacade:ye,indices:ze,buildingPart:Ve}}let f=this.module.getRingCount(),p=[];for(let y=0;y<f;y++){let x=this.module.getRingPtr(y),w=this.module.getRingLength(y),I=new Float32Array(this.module.heapF32.buffer,x,w);p.push(I)}return{meshes:c,modifiedPolygonRings:p}}}let Hm,fw,qs,Qh,pw,ef=null,tf=null,mD=null,iv=null;function gD(){return Gn(self)&&self.worker.dracoUrl?self.worker.dracoUrl:fw||vr.DRACO_URL}function _D(){if(Gn(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Qh)return Qh;let i=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Qh=WebAssembly.validate(i)?vr.MESHOPT_SIMD_URL:vr.MESHOPT_URL,Qh}function jk(){return iv}let rv={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Uk={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},$m={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function yD(i,e,n){let s=n.json.bufferViews.length,c=n.buffers.length;e.bufferView=s,n.json.bufferViews[s]={buffer:c,byteLength:i.byteLength},n.buffers[c]=i}let mw="KHR_draco_mesh_compression";function Hk(i,e){let n=i.extensions&&i.extensions[mw];if(!n)return;let s=new qs.Decoder,c=wD(e,n.bufferView),f=new qs.Mesh;if(!s.DecodeArrayToMesh(c,c.byteLength,f))throw new Error("Failed to decode Draco mesh");let p=e.json.accessors[i.indices],y=rv[p.componentType],x=p.count*y.BYTES_PER_ELEMENT,w=qs._malloc(x);y===Uint16Array?s.GetTrianglesUInt16Array(f,x,w):s.GetTrianglesUInt32Array(f,x,w),yD(qs.memory.buffer.slice(w,w+x),p,e),qs._free(w);for(let I of Object.keys(n.attributes)){let S=s.GetAttributeByUniqueId(f,n.attributes[I]),D=e.json.accessors[i.attributes[I]],P=Uk[D.componentType],O=D.count*$m[D.type]*rv[D.componentType].BYTES_PER_ELEMENT,F=qs._malloc(O);s.GetAttributeDataArrayForAllPoints(f,S,qs[P],O,F),yD(qs.memory.buffer.slice(F,F+O),D,e),qs._free(F)}s.destroy(),f.destroy(),delete i.extensions[mw]}let ov="EXT_meshopt_compression";function $k(i,e){if(!i.extensions||!i.extensions[ov])return;let n=i.extensions[ov],s=new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength||0),c=new Uint8Array(n.count*n.byteStride);pw.decodeGltfBuffer(c,n.count,n.byteStride,s,n.mode,n.filter),i.buffer=e.buffers.length,i.byteOffset=0,e.buffers[i.buffer]=c.buffer,delete i.extensions[ov]}let vD=1179937895,xD=new TextDecoder("utf8");function bD(i,e){return new URL(i,e).href}function Gk(i,e,n,s){return fetch(bD(i.uri,s)).then(c=>c.arrayBuffer()).then(c=>{e.buffers[n]=c})}function wD(i,e){let n=i.json.bufferViews[e];return new Uint8Array(i.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function qk(i,e,n,s){if(i.uri){let c=bD(i.uri,s);return fetch(c).then(f=>f.blob()).then(f=>createImageBitmap(f)).then(f=>{e.images[n]=f})}if(i.bufferView!==void 0){let c=wD(e,i.bufferView),f=new Blob([c],{type:i.mimeType});return createImageBitmap(f).then(p=>{e.images[n]=p})}}function ED(i,e=0,n){let s={json:null,images:[],buffers:[]};if(new Uint32Array(i,e,1)[0]===vD){let I=new Uint32Array(i,e),S=2,D=(I[S++]>>2)-3,P=I[S++]>>2;if(S++,s.json=JSON.parse(xD.decode(I.subarray(S,S+P))),S+=P,S<D){let O=I[S++];S++;let F=e+(S<<2);s.buffers[0]=i.slice(F,F+O)}}else s.json=JSON.parse(xD.decode(new Uint8Array(i,e)));let{buffers:c,images:f,meshes:p,extensionsUsed:y,bufferViews:x}=s.json,w=Promise.resolve();if(c){let I=[];for(let S=0;S<c.length;S++){let D=c[S];D.uri?I.push(Gk(D,s,S,n)):s.buffers[S]||(s.buffers[S]=null)}w=Promise.all(I)}return w.then(()=>{let I=[],S=y&&y.includes(mw),D=y&&y.includes(ov);if(S&&I.push(function(){if(!qs)return Hm??(Hm=function(P){let O,F=null;function B(){O=new Uint8Array(F.buffer)}function H(){throw new Error("Unexpected Draco error.")}let X={a:{a:H,d:function(Z,K,de){return O.copyWithin(Z,K,K+de)},c:function(Z){let K=O.length,de=Math.max(Z>>>0,Math.ceil(1.2*K)),ae=Math.ceil((de-K)/65536);try{return F.grow(ae),B(),!0}catch{return!1}},b:H}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(P,X):P.then(Z=>Z.arrayBuffer()).then(Z=>WebAssembly.instantiate(Z,X))).then(Z=>{let{Rb:K,Qb:de,P:ae,T:ce,X:ge,Ja:ye,La:ke,Qa:be,Va:ze,Wa:et,eb:Ve,jb:We,f:Je,e:Oe,yb:Ze,zb:we,Ab:Le,Bb:it,Db:Ye,Gb:Et}=Z.instance.exports;F=Oe;let _t=(()=>{let Ge=0,Ke=0,vt=0,ht=0;return at=>{vt&&(K(ht),K(Ge),Ke+=vt,vt=Ge=0),Ge||(Ke+=128,Ge=de(Ke));let ft=at.length+7&-8,Mt=Ge;ft>=Ke&&(vt=ft,Mt=ht=de(ft));for(let Bt=0;Bt<at.length;Bt++)O[Mt+Bt]=at[Bt];return Mt}})();return B(),Je(),{memory:Oe,_free:K,_malloc:de,Mesh:class{constructor(){this.ptr=ae()}destroy(){ce(this.ptr)}},Decoder:class{constructor(){this.ptr=ye()}destroy(){We(this.ptr)}DecodeArrayToMesh(Ge,Ke,vt){let ht=_t(Ge),at=ke(this.ptr,ht,Ke,vt.ptr);return!!ge(at)}GetAttributeByUniqueId(Ge,Ke){return{ptr:be(this.ptr,Ge.ptr,Ke)}}GetTrianglesUInt16Array(Ge,Ke,vt){ze(this.ptr,Ge.ptr,Ke,vt)}GetTrianglesUInt32Array(Ge,Ke,vt){et(this.ptr,Ge.ptr,Ke,vt)}GetAttributeDataArrayForAllPoints(Ge,Ke,vt,ht,at){Ve(this.ptr,Ge.ptr,Ke.ptr,vt,ht,at)}},DT_INT8:Ze(),DT_UINT8:we(),DT_INT16:Le(),DT_UINT16:it(),DT_UINT32:Ye(),DT_FLOAT32:Et()}})}(fetch(gD())),Hm.then(P=>{qs=P,Hm=void 0}))}()),D&&I.push(function(){if(pw)return;let P=function(O){let F,B=WebAssembly.instantiateStreaming(O,{}).then(Z=>{F=Z.instance,F.exports.__wasm_call_ctors()}),H={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},X={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:B,supported:!0,decodeGltfBuffer(Z,K,de,ae,ce,ge){(function(ye,ke,be,ze,et,Ve,We){let Je=ye.exports.sbrk,Oe=ze+3&-4,Ze=Je(Oe*et),we=Je(Ve.length),Le=new Uint8Array(ye.exports.memory.buffer);Le.set(Ve,we);let it=ke(Ze,ze,et,we,Ve.length);if(it===0&&We&&We(Ze,Oe,et),be.set(Le.subarray(Ze,Ze+ze*et)),Je(Ze-Je(0)),it!==0)throw new Error(`Malformed buffer data: ${it}`)})(F,F.exports[X[ce]],Z,K,de,ae,F.exports[H[ge]])}}}(fetch(_D()));return P.ready.then(()=>{pw=P})}()),f)for(let P=0;P<f.length;P++)I.push(qk(f[P],s,P,n));return(I.length?Promise.all(I):Promise.resolve()).then(()=>{if(S&&p)for(let{primitives:P}of p)for(let O of P)Hk(O,s);if(D&&p&&x)for(let P of x)$k(P,s);return s})})}function gw(i){switch(i){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function _w(i){switch(i){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class yw{constructor(e,n,s,c){this.context=e,this.format=s,this.useMipmap=c&&c.useMipmap,this.texture=e.gl.createTexture(),this.update(n,{premultiply:c&&c.premultiply})}update(e,n){let s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,c=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:f}=this,{gl:p}=f,{x:y,y:x}=n&&n.position?n.position:{x:0,y:0},w=y+s,I=x+c;!this.size||this.size[0]===w&&this.size[1]===I||(p.bindTexture(p.TEXTURE_2D,null),p.deleteTexture(this.texture),this.texture=p.createTexture(),this.size=null),p.bindTexture(p.TEXTURE_2D,this.texture),f.pixelStoreUnpackFlipY.set(!1),f.pixelStoreUnpack.set(1),f.pixelStoreUnpackPremultiplyAlpha.set(this.format===p.RGBA8&&(!n||n.premultiply!==!1));let S=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&w>0&&I>0){let D=this.useMipmap?Math.floor(Math.log2(Math.max(w,I)))+1:1;p.texStorage2D(p.TEXTURE_2D,D,this.format,w,I),this.size=[w,I]}if(this.size)if(S)p.texSubImage2D(p.TEXTURE_2D,0,y,x,gw(this.format),_w(this.format),e);else{let D=e.data;D&&p.texSubImage2D(p.TEXTURE_2D,0,y,x,s,c,gw(this.format),_w(this.format),D)}this.useMipmap&&p.generateMipmap(p.TEXTURE_2D)}bind(e,n,s=!1){let{context:c}=this,{gl:f}=c;f.bindTexture(f.TEXTURE_2D,this.texture),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,e),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),n!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,n),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(e,n,s,c,f){let{context:p}=this,{gl:y}=p;y.bindTexture(y.TEXTURE_2D,this.texture),n!==this.magFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,n),this.magFilter=n),e!==this.minFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.useMipmap?e===y.NEAREST?y.NEAREST_MIPMAP_NEAREST:y.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,s),this.wrapS=s),c!==this.wrapT&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,c),this.wrapT=c),f!==this.compareMode&&(f?(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_FUNC,f)):y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.NONE),this.compareMode=f)}destroy(){let{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Gm{constructor(e,n){this.context=e,this.texture=n}bind(e,n){let{context:s}=this,{gl:c}=s;c.bindTexture(c.TEXTURE_2D,this.texture),e!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,e),this.minFilter=e),n!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,n),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,n),this.wrapS=n)}}let Wk=gn([{name:"a_pos_3f",components:3,type:"Float32"}]),Zk=gn([{name:"a_color_3f",components:3,type:"Float32"}]),Xk=gn([{name:"a_color_4f",components:4,type:"Float32"}]),Yk=gn([{name:"a_uv_2f",components:2,type:"Float32"}]),Kk=gn([{name:"a_normal_3f",components:3,type:"Float32"}]),Jk=gn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Qk=gn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function TD(i,e){let n=sv(i.projection,i.zoom,i.width,i.height),s=function(f,p,y,x,w){let I=new A(y.lng-180*Mc,y.lat),S=new A(y.lng+180*Mc,y.lat),D=f.project(I.lng,I.lat),P=f.project(S.lng,S.lat),O=-Math.atan2(P.y-D.y,P.x-D.x),F=se.fromLngLat(y);F.y=ne(F.y,-1+Mc,1-Mc);let B=F.toLngLat(),H=f.project(B.lng,B.lat),X=se.fromLngLat(B);X.x+=Mc;let Z=X.toLngLat(),K=f.project(Z.lng,Z.lat),de=SD(K.x-H.x,K.y-H.y,O),ae=se.fromLngLat(B);ae.y+=Mc;let ce=ae.toLngLat(),ge=f.project(ce.lng,ce.lat),ye=SD(ge.x-H.x,ge.y-H.y,O),ke=Math.abs(de.x)/Math.abs(ye.y),be=Fe([]);Ri(be,be,-O*(1-(w?0:x)));let ze=Fe([]);return Nt(ze,ze,[1,1-(1-ke)*x,1]),ze[4]=-ye.x/ye.y*x,Ri(ze,ze,O),Vt(ze,be,ze),ze}(i.projection,0,i.center,n,e),c=ID(i);return Nt(s,s,[c,c,1]),s}function ID(i){let e=i.projection,n=sv(i.projection,i.zoom,i.width,i.height),s=vw(e,i.center),c=vw(e,A.convert(e.center));return Math.pow(2,s*n+(1-n)*c)}function sv(i,e,n,s,c=1/0){let f=i.range;if(!f)return 0;let p=Math.min(c,Math.max(n,s)),y=Math.log(p/1024)/Math.LN2;return _e(f[0]+y,f[1]+y,e)}let Mc=1/4e4;function vw(i,e){let n=ne(e.lat,-ie,ie),s=new A(e.lng-180*Mc,n),c=new A(e.lng+180*Mc,n),f=i.project(s.lng,n),p=i.project(c.lng,n),y=se.fromLngLat(s),x=se.fromLngLat(c),w=p.x-f.x,I=p.y-f.y,S=x.x-y.x,D=x.y-y.y,P=Math.sqrt((S*S+D*D)/(w*w+I*I));return Math.log(P)/Math.LN2}function SD(i,e,n){let s=Math.cos(n),c=Math.sin(n);return{x:i*s-e*c,y:i*c+e*s}}function DD(i,e,n){Fe(i),Ri(i,i,Sn(e[2])),ar(i,i,Sn(e[0])),lr(i,i,Sn(e[1])),Nt(i,i,n),Vt(i,i,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function av(i,e,n,s,c,f,p,y){let x=[n[0]-e[0],n[1]-e[1],0],w=[s[0]-e[0],s[1]-e[1],0];if(Er(x)<1e-12||Er(w)<1e-12)return ks(i);let I=Zi([],x,w);ci(I,I),lo(w,s,e),x[2]=(f-c)*y,w[2]=(p-c)*y;let S=x;return Zi(S,x,w),ci(S,S),jl(i,I,S)}function xw(i,e,n=!1){let s=Dc(e.zoom),c=function(f,p,y){let x=p.worldSize,w=[f[12],f[13],f[14]],I=Y(w[1]/x),S=W(w[0]/x),D=Fe([]),P=j(1,I)*x,O=j(1,0)*x*ue(I,p.zoom),F=1/Zb(x),B=O*F;if(y){let K=sv(p.projection,p.zoom,p.width,p.height,1024);B=F*p.projection.pixelSpaceConversion(p.center.lat,x,K)}let H=E(I,S);pi(H,H,hi([],ci([],H),P*B*w[2]));let X=function(K){let de=[K[0],K[1],K[2]],ae=[0,1,0],ce=Zi([],ae,de);return Zi(ae,de,ce),Wd(ae)===0&&(ae=[0,1,0],Zi(ce,de,ae)),ci(ce,ce),ci(ae,ae),ci(de,de),[ce[0],ce[1],ce[2],0,ae[0],ae[1],ae[2],0,de[0],de[1],de[2],0,K[0],K[1],K[2],1]}(H);Nt(D,D,[B,B,B*P]),jt(D,D,[-w[0],-w[1],-w[2]]);let Z=Vt([],p.globeMatrix,X);return Vt(Z,Z,D),Vt(Z,Z,f),Z}(i,e,n);if(s>0){let f=function(p,y){let x=y.worldSize,w=j(1,0)*x*ue(y.center.lat,y.zoom)/Zb(x),I=j(1,y.center.lat)*x,S=Fe([]);return lr(S,S,Sn(y.center.lng)),ar(S,S,Sn(y.center.lat)),jt(S,S,[0,0,kr]),Nt(S,S,[w,w,w*I]),jt(S,S,[y.point.x-.5*x,y.point.y-.5*x,0]),Vt(S,S,p),Vt(S,y.globeMatrix,S)}(i,e);return function(p,y,x){let w=(O,F,B)=>{let H=Er(O),X=Er(F),Z=vl(O,F,B);return hi(Z,Z,1/Er(Z)*Ct(H,X,B))},I=w([p[0],p[1],p[2]],[y[0],y[1],y[2]],x),S=w([p[4],p[5],p[6]],[y[4],y[5],y[6]],x),D=w([p[8],p[9],p[10]],[y[8],y[9],y[10]],x),P=vl([p[12],p[13],p[14]],[y[12],y[13],y[14]],x);return[I[0],I[1],I[2],0,S[0],S[1],S[2],0,D[0],D[1],D[2],0,P[0],P[1],P[2],1]}(c,f,s)}return c}function CD(i,e,n,s){let c=sn.projectAabbCorners(s,n),f=Number.MAX_VALUE,p=-1;for(let w=0;w<c.length;++w){let I=c[w];I[0]=(.5*I[0]+.5)*e.width,I[1]=(.5-.5*I[1])*e.height,I[2]<f&&(p=w,f=I[2])}let y=w=>new Xe(c[w][0],c[w][1]),x;switch(p){case 0:case 6:x=[y(1),y(5),y(4),y(7),y(3),y(2),y(1)];break;case 1:case 7:x=[y(0),y(4),y(5),y(6),y(2),y(3),y(0)];break;case 3:case 5:x=[y(1),y(0),y(4),y(7),y(6),y(2),y(1)];break;default:x=[y(1),y(5),y(6),y(7),y(3),y(0),y(1)]}if(qn(i,x))return f}let rd=64,nf={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function AD(i,e,n,s,c,f,p,y,x,w=!1){let I=n.zoom,S=n.project(s),D=ue(s.lat,I),P=1/D;Fe(i),jt(i,i,[S.x+p[0]*P,S.y+p[1]*P,p[2]]);let O=1,F=1,B=n.worldSize;if(w){if(n.projection.name==="mercator"){let K=0;n.elevation&&(K=n.elevation.getAtPointOrZero(new se(S.x/B,S.y/B),0));let de=co([],[S.x,S.y,K,1],n.projMatrix)[3]/n.cameraToCenterDistance;O=de,F=de*ue(n.center.lat,I)}else if(n.projection.name==="globe"){let K=xw(i,n),de=[0,0,0,1];co(de,de,Vt([],n.projMatrix,K));let ae=de[3]/n.cameraToCenterDistance,ce=Dc(I),ge=n.projection.pixelsPerMeter(s.lat,B)*ue(s.lat,I),ye=n.projection.pixelsPerMeter(n.center.lat,B)*ue(n.center.lat,I);O=ae/Ct(ge,le(n.center.lat),ce),F=ae*D/ge,O*=ye,F*=ye}}else O=P;Nt(i,i,[O,O,F]);let H=[...i],X=e.orientation,Z=[];if(DD(Z,[X[0]+c[0],X[1]+c[1],X[2]+c[2]],f),Vt(i,H,Z),y&&n.elevation){let K=0,de=[];if(x&&n.elevation){K=function(ce,ge,ye,ke,be){let ze=ge.elevation;if(!ze)return 0;let et=sn.projectAabbCorners(ye,ke),Ve=j(1,be.lat)*ge.worldSize,We=function(Ke,vt){let ht=[0,0,1],at=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let ft of at){let Mt=Ke[ft.corners[0]],Bt=Ke[ft.corners[1]],Wt=Ke[ft.corners[2]],$t=[Bt[0]-Mt[0],Bt[1]-Mt[1],vt*(Bt[2]-Mt[2])],pn=Zi($t,$t,[Wt[0]-Mt[0],Wt[1]-Mt[1],vt*(Wt[2]-Mt[2])]);ci(pn,pn),ft.dotProductWithUp=Fi(pn,ht)}return at.sort((ft,Mt)=>ft.dotProductWithUp-Mt.dotProductWithUp),at[0].corners}(et,Ve),Je=et[We[0]],Oe=et[We[1]],Ze=et[We[2]],we=et[We[3]],Le=ze.getAtPointOrZero(new se(Je[0]/ge.worldSize,Je[1]/ge.worldSize),0),it=ze.getAtPointOrZero(new se(Oe[0]/ge.worldSize,Oe[1]/ge.worldSize),0),Ye=ze.getAtPointOrZero(new se(Ze[0]/ge.worldSize,Ze[1]/ge.worldSize),0),Et=ze.getAtPointOrZero(new se(we[0]/ge.worldSize,we[1]/ge.worldSize),0),_t=(Le+Et)/2,Ge=(it+Ye)/2;return _t>Ge?it<Ye?av(ce,Oe,we,Je,it,Et,Le,Ve):av(ce,Ze,Je,we,Ye,Le,Et,Ve):Le<Et?av(ce,Je,Oe,Ze,Le,it,Ye,Ve):av(ce,we,Ze,Oe,Et,Ye,it,Ve),Math.max(_t,Ge)}(de,n,e.aabb,i,s);let ae=Vt([],ys([],de),Z);Vt(i,H,ae)}else K=n.elevation.getAtPointOrZero(new se(S.x/B,S.y/B),0);K!==0&&(i[14]+=K)}}function qm(i,e,n=!1){i.uploaded||(i.gfxTexture=new yw(e,i.image,n?e.gl.R8:e.gl.RGBA8,{useMipmap:i.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),i.uploaded=!0,i.image=null)}function eF(i,e,n){i.indexBuffer=e.createIndexBuffer(i.indexArray,!1,!0),i.vertexBuffer=e.createVertexBuffer(i.vertexArray,Wk.members,!1,!0),i.normalArray&&(i.normalBuffer=e.createVertexBuffer(i.normalArray,Kk.members,!1,!0)),i.texcoordArray&&(i.texcoordBuffer=e.createVertexBuffer(i.texcoordArray,Yk.members,!1,!0)),i.colorArray&&(i.colorBuffer=e.createVertexBuffer(i.colorArray,(i.colorArray.bytesPerElement===12?Zk:Xk).members,!1,!0)),i.featureArray&&(i.pbrBuffer=e.createVertexBuffer(i.featureArray,Qk.members,!0)),i.segments=gi.simpleSegment(0,0,i.vertexArray.length,i.indexArray.length);let s=i.material;s.pbrMetallicRoughness.baseColorTexture&&qm(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&qm(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&qm(s.normalTexture,e),s.occlusionTexture&&qm(s.occlusionTexture,e,n),s.emissionTexture&&qm(s.emissionTexture,e)}function bw(i,e,n){if(i.meshes)for(let s of i.meshes)eF(s,e,n);if(i.children)for(let s of i.children)bw(s,e,n)}function lv(i){if(i.meshes)for(let e of i.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(i.children)for(let e of i.children)lv(e)}function ww(i){if(i.meshes)for(let n of i.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((e=n.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(i.children)for(let n of i.children)ww(n)}function od(i,e){let n=i.json.bufferViews[e.bufferView],s=rv[e.componentType];return new s(i.buffers[n.buffer],(e.byteOffset||0)+(n.byteOffset||0),e.count*(n.byteStride&&n.byteStride!==$m[e.type]*s.BYTES_PER_ELEMENT?n.byteStride/s.BYTES_PER_ELEMENT:$m[e.type]))}function Ew(i,e,n,s){let c=rv[e.componentType],f=function(I){switch(I){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(c),p=i.json.bufferViews[e.bufferView],y=p.byteStride?p.byteStride/c.BYTES_PER_ELEMENT:$m[e.type],x=n.float32,w=x.length/n.capacity;for(let I=0,S=0;I<e.count*y;I+=y,S+=w)for(let D=0;D<w;D++)x[S+D]=s[I+D]*f;n._trim()}function tF(i,e,n){let s=i.indices,c=i.attributes,f={};f.indexArray=new di;let p=e.json.accessors[s],y=p.count/3;f.indexArray.reserve(y);let x=od(e,p);for(let D=0;D<y;D++)f.indexArray.emplaceBack(x[3*D],x[3*D+1],x[3*D+2]);f.indexArray._trim(),f.vertexArray=new Ao;let w=e.json.accessors[c.POSITION];f.vertexArray.reserve(w.count);let I=od(e,w);for(let D=0;D<w.count;D++)f.vertexArray.emplaceBack(I[3*D],I[3*D+1],I[3*D+2]);if(f.vertexArray._trim(),f.aabb=new sn(w.min,w.max),f.centroid=function(D,P){let O=[0,0,0],F=D.length;if(F>0){for(let B=0;B<F;B++){let H=3*D[B];O[0]+=P[H],O[1]+=P[H+1],O[2]+=P[H+2]}O[0]/=F,O[1]/=F,O[2]/=F}return O}(x,I),c.COLOR_0!==void 0){let D=e.json.accessors[c.COLOR_0],P=$m[D.type],O=od(e,D);f.colorArray=P===3?new Ao:new Ra,f.colorArray.resize(D.count),Ew(e,D,f.colorArray,O)}if(c.NORMAL!==void 0){f.normalArray=new Ao;let D=e.json.accessors[c.NORMAL];f.normalArray.resize(D.count);let P=od(e,D);Ew(e,D,f.normalArray,P)}if(c.TEXCOORD_0!==void 0&&n.length>0){f.texcoordArray=new Pa;let D=e.json.accessors[c.TEXCOORD_0];f.texcoordArray.resize(D.count);let P=od(e,D);Ew(e,D,f.texcoordArray,P)}if(c._FEATURE_ID_RGBA4444!==void 0){let D=e.json.accessors[c._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(f.featureData=od(e,D))}c._FEATURE_RGBA4444!==void 0&&(f.featureData=new Uint32Array(od(e,e.json.accessors[c._FEATURE_RGBA4444]).buffer));let S=i.material;return f.material=function(D,P){let{emissiveFactor:O=[0,0,0],alphaMode:F="OPAQUE",alphaCutoff:B=.5,normalTexture:H,occlusionTexture:X,emissiveTexture:Z,doubleSided:K}=D,{baseColorFactor:de=[1,1,1,1],metallicFactor:ae=1,roughnessFactor:ce=1,baseColorTexture:ge,metallicRoughnessTexture:ye}=D.pbrMetallicRoughness||{},ke=X?P[X.index]:void 0;if(X&&X.extensions&&X.extensions.KHR_texture_transform&&ke){let be=X.extensions.KHR_texture_transform;ke.offsetScale=[be.offset[0],be.offset[1],be.scale[0],be.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Ln(...de),metallicFactor:ae,roughnessFactor:ce,baseColorTexture:ge?P[ge.index]:void 0,metallicRoughnessTexture:ye?P[ye.index]:void 0},doubleSided:K,emissiveFactor:new Ln(...O),alphaMode:F,alphaCutoff:B,normalTexture:H?P[H.index]:void 0,occlusionTexture:ke,emissionTexture:Z?P[Z.index]:void 0,defined:D.defined===void 0}}(S!==void 0?e.json.materials[S]:{defined:!1},n),f}function MD(i,e,n){let{matrix:s,rotation:c,translation:f,scale:p,mesh:y,extras:x,children:w}=i,I={};if(I.matrix=s||function(S,D,P,O){var F=D[0],B=D[1],H=D[2],X=D[3],Z=F+F,K=B+B,de=H+H,ae=F*Z,ce=F*K,ge=F*de,ye=B*K,ke=B*de,be=H*de,ze=X*Z,et=X*K,Ve=X*de,We=O[0],Je=O[1],Oe=O[2];return S[0]=(1-(ye+be))*We,S[1]=(ce+Ve)*We,S[2]=(ge-et)*We,S[3]=0,S[4]=(ce-Ve)*Je,S[5]=(1-(ae+be))*Je,S[6]=(ke+ze)*Je,S[7]=0,S[8]=(ge+et)*Oe,S[9]=(ke-ze)*Oe,S[10]=(1-(ae+ye))*Oe,S[11]=0,S[12]=P[0],S[13]=P[1],S[14]=P[2],S[15]=1,S}([],c||[0,0,0,1],f||[0,0,0],p||[1,1,1]),y!==void 0){I.meshes=n[y];let S=I.anchor=[0,0];for(let D of I.meshes){let{min:P,max:O}=D.aabb;S[0]+=P[0]+O[0],S[1]+=P[1]+O[1]}S[0]=Math.floor(S[0]/I.meshes.length/2),S[1]=Math.floor(S[1]/I.meshes.length/2)}if(x&&(x.id&&(I.id=x.id),x.lights&&(I.lights=function(S){if(!S.length)return[];let D=function(H){let X=atob(H),Z=new Uint8Array(X.length);for(let K=0;K<X.length;K++)Z[K]=X.codePointAt(K);return Z}(S),P=[],O=D.length/24,F=new Uint16Array(D.buffer),B=new Float32Array(D.buffer);for(let H=0;H<O;H++){let X=F[2*H*6]/30,Z=F[2*H*6+1]/30,K=F[2*H*6+10]/100,de=B[6*H+1],ae=B[6*H+2],ce=B[6*H+3],ge=B[6*H+4],ye=ce-de,ke=ge-ae,be=Math.hypot(ye,ke);P.push({pos:[de+.5*ye,ae+.5*ke,Z],normal:[ke/be,-ye/be,0],width:be,height:X,depth:K,points:[de,ae,ce,ge]})}return P}(x.lights))),w){let S=[];for(let D of w)S.push(MD(e.json.nodes[D],e,n));I.children=S}return I}function nF(i){if(i.vertices.length===0||i.indices.length===0)return null;let e=new Xy(i.vertices,i.indices,8,256),[n,s]=[e.min.clone(),e.max.clone()];return{vertices:i.vertices,indices:i.indices,grid:e,min:n,max:s}}function iF(i){if(!i.extras||!i.extras.ground)return null;let e=i.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;let n=e[0];if(!n||!Array.isArray(n)||n.length===0)return null;let s=[];for(let p of n){if(!Array.isArray(p)||p.length!==2)continue;let y=p[0],x=p[1];typeof y=="number"&&typeof x=="number"&&s.push(new Xe(y,x))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let c=0;for(let p=0;p<s.length;p++){let y=s[p],x=s[(p+1)%s.length],w=s[(p+2)%s.length];c+=(y.x-x.x)*(w.y-x.y)-(w.x-x.x)*(y.y-x.y)}c>0&&s.reverse();let f=Yh(s.flatMap(p=>[p.x,p.y]),[]);return f.length===0?null:{vertices:s,indices:f}}function rF(i,e){let n=[],s=[],c=0,f=[];for(let p of i){c=n.length;let y=p.vertexArray.float32,x=p.indexArray.uint16;for(let w=0;w<p.vertexArray.length;w++)f[0]=y[3*w+0],f[1]=y[3*w+1],f[2]=y[3*w+2],Ni(f,f,e),n.push(new Xe(f[0],f[1]));for(let w=0;w<3*p.indexArray.length;w++)s.push(x[w]+c)}if(s.length%3!=0)return null;for(let p=0;p<s.length;p+=3){let y=n[s[p+0]],x=n[s[p+1]],w=n[s[p+2]];(y.x-x.x)*(w.y-x.y)-(w.x-x.x)*(y.y-x.y)>0&&([s[p+1],s[p+2]]=[s[p+2],s[p+1]])}return{vertices:n,indices:s}}function RD(i){let e=function(x,w){let I=[],S=WebGL2RenderingContext;if(x.json.textures)for(let D of x.json.textures){let P={magFilter:S.LINEAR,minFilter:S.NEAREST,wrapS:S.REPEAT,wrapT:S.REPEAT};D.sampler!==void 0&&Object.assign(P,x.json.samplers[D.sampler]),I.push({image:w[D.source],sampler:P,uploaded:!1})}return I}(i,i.images),n=function(x,w){let I=[];for(let S of x.json.meshes){let D=[];for(let P of S.primitives)D.push(tF(P,x,w));I.push(D)}return I}(i,e),{scenes:s,scene:c,nodes:f}=i.json,p=s?s[c||0].nodes:f,y=[];for(let x of p)y.push(MD(f[x],i,n));return function(x,w,I){let S={},D=new Set;for(let P=0;P<x.length;P++){let O=I[w[P]];if(!O.extras)continue;let F=O.extras["mapbox:footprint:version"],B=O.extras["mapbox:footprint:id"];(F||B)&&D.add(P),F==="1.0.0"&&B&&(S[B]=P)}for(let P=0;P<x.length;P++){if(D.has(P))continue;let O=x[P],F=I[w[P]];if(!F.extras)continue;let B=null;O.id in S&&(B=rF(x[S[O.id]].meshes,O.matrix)),B||(B=iF(F)),B&&(O.footprint=nF(B))}if(D.size>0){let P=Array.from(D.values()).sort((O,F)=>O-F);for(let O=P.length-1;O>=0;O--)x.splice(P[O],1)}}(y,p,i.json.nodes),y}function oF(i){i.heightmap=new Float32Array(4096),i.heightmap.fill(-1);let e=i.vertexArray.float32,n=i.aabb.min[0]-1,s=i.aabb.min[1]-1,c=rd/(i.aabb.max[0]-n+2),f=rd/(i.aabb.max[1]-s+2);for(let p=0;p<e.length;p+=3){let y=e[p+2],x=(e[p+0]-n)*c|0,w=(e[p+1]-s)*f|0;y>i.heightmap[w*rd+x]&&(i.heightmap[w*rd+x]=y)}}function PD(i,e,n,s,c){n.reserve(n.length+4*i.length),s.reserve(s.length+10*i.length),c.reserve(c.length+10*i.length);let f=s.length;for(let p of i){let y=Math.min(10,Math.max(4,1.3*p.height))*e,x=[-p.normal[1],p.normal[0],0],w=Math.min(.29,.1*p.width/p.depth),I=p.width-2*p.depth*e*(w+.01),S=zr([],p.pos,x,I/2),D=zr([],p.pos,x,-I/2),P=[S[0],S[1],S[2]+p.height],O=[D[0],D[1],D[2]+p.height],F=zr([],p.normal,x,w);hi(F,F,y);let B=zr([],p.normal,x,-w);hi(B,B,y),pi(F,S,F),pi(B,D,B),S[2]+=.1,D[2]+=.1,s.emplaceBack(F[0],F[1],F[2]),s.emplaceBack(B[0],B[1],B[2]),s.emplaceBack(S[0],S[1],S[2]),s.emplaceBack(D[0],D[1],D[2]),s.emplaceBack(P[0],P[1],P[2]),s.emplaceBack(O[0],O[1],O[2]),s.emplaceBack(S[0],S[1],S[2]),s.emplaceBack(D[0],D[1],D[2]),s.emplaceBack(F[0],F[1],F[2]),s.emplaceBack(B[0],B[1],B[2]);let H=I/y/2;c.emplaceBack(-H-w,-1,H,.8),c.emplaceBack(H+w,-1,H,.8),c.emplaceBack(-H,0,H,1.3),c.emplaceBack(H,0,H,1.3),c.emplaceBack(H+w,-.8,H,.7),c.emplaceBack(H+w,-.8,H,.7),c.emplaceBack(0,0,H,1.3),c.emplaceBack(0,0,H,1.3),c.emplaceBack(H+w,-1.2,H,.8),c.emplaceBack(H+w,-1.2,H,.8),n.emplaceBack(6+f,4+f,8+f),n.emplaceBack(7+f,9+f,5+f),n.emplaceBack(0+f,1+f,2+f),n.emplaceBack(1+f,3+f,2+f),f+=10}}function sF(i,e){let n={};n.indexArray=new di,n.vertexArray=new Ao,n.colorArray=new Ra,PD(i,e,n.indexArray,n.vertexArray,n.colorArray);let s={defined:!0};s.emissiveFactor=Ln.black;let c={};return c.baseColorFactor=Ln.white,s.pbrMetallicRoughness=c,n.material=s,n.aabb=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}let OD=gn([{name:"a_pos_3f",components:3,type:"Float32"}]),aF=gn([{name:"a_normal_3",components:3,type:"Int16"}]),LD=gn([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),lF=gn([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),kD=Ie.types,Tw=32767;function cF(i,e){let n=st+e;for(let s of i)for(let c of s)if(c.x<-e||c.x>n||c.y<-e||c.y>n)return!1;return!0}class FD{constructor(e){this.layoutAOArray=[],this.indexArrayForConflationUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.layoutVertexArray=new Ao,this.layoutNormalArray=new mc,this.layoutColorArray=new Es,this.indexArray=new di,this.indexArrayForConflation=new di,this.entranceBloom={layoutVertexArray:new Ao,layoutVertexBuffer:null,layoutAttenuationArray:new Ra,layoutAttenuationBuffer:null,layoutColorArray:new Es,layoutColorBuffer:null,indexArray:new di,indexArrayForConflation:new di,indexBuffer:null,segmentsBucket:new gi},this.programConfigurations=new Ro(e.layers,{zoom:e.zoom,lut:e.lut}),this.segmentsBucket=new gi,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.groundEffect=new cw(e)}get segments(){return this.segmentsBucket}get bloomGeometry(){return this.entranceBloom}updateFootprints(e,n){for(let s of this.footprints)n.push({footprint:s,id:e})}prepare(){return function(){if(iv!=null||mD!=null)return null;if(tf!=null)return tf;let e=fetch(vr.BUILDING_GEN_URL);return tf=function(n){let s,c,f,p;function y(){s=new Uint8Array(p.buffer),c=new Int32Array(p.buffer),f=new Float32Array(p.buffer)}function x(){throw new Error("Unexpected BuildingGen error.")}let w=()=>{},I={a:{a:x,f:function(S){let D=s.length,P=Math.max(S>>>0,Math.ceil(1.2*D)),O=Math.ceil((P-D)/65536);try{return p.grow(O),y(),!0}catch{return!1}},g:x,b:w,c:w,d:w,e:w}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(n,I):n.then(S=>S.arrayBuffer()).then(S=>WebAssembly.instantiate(S,I))).then(S=>{let D=S.instance.exports;return(0,D.g)(),p=D.f,y(),new Vk({setStyle:D.h,setAOOptions:D.i,setMetricOptions:D.j,setStructuralOptions:D.k,setFacadeOptions:D.l,setFauxFacadeOptions:D.m,setFacadeClassifierOptions:D.n,addFeature:D.o,addFacade:D.p,generateMesh:D.q,getLastError:D.r,getMeshCount:D.s,getPositionsPtr:D.t,getPositionsLength:D.u,getNormalsPtr:D.v,getNormalsLength:D.w,getColorsPtr:D.x,getColorsLength:D.y,getAOPtr:D.z,getAOLength:D.A,getUVPtr:D.B,getUVLength:D.C,getFauxFacadePtr:D.D,getFauxFacadeLength:D.E,getIndicesPtr:D.F,getIndicesLength:D.G,getBuildingPart:D.H,getRingCount:D.I,getRingPtr:D.J,getRingLength:D.K,free:D.L,malloc:D.M,heapU8:s,heap32:c,heapF32:f})})}(e).then(n=>(tf=null,iv=n,iv)).catch(n=>{fn("Could not load building-gen"),tf=null,mD=n}),tf}()}populate(e,n,s,c){let f=jk();if(!f)return;let p=oe(s);this.tileToMeter=p,this.brightness=n.brightness,f.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,p],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:p,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),f.setAOOptions(!1,.3),f.setMetricOptions(!1,16),f.setStructuralOptions(!0),f.setFacadeOptions(4,!0),f.setFauxFacadeOptions(!1,!1,1),f.setFacadeClassifierOptions(3);let y=new Map;for(let{feature:x}of e){if(kD[x.type]!=="LineString")continue;let w=this.layers[0]._featureFilter.needGeometry,I=Pe(x,w);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom),I,s))continue;let S=w?I.geometry:pe(x,s,c),D=[];for(let B of S)for(let H of B)D.push({x:H.x,y:H.y});let P={coordinates:D,crossPerc:x.properties.cross_perc,distanceToRoad:x.properties.distance_to_road,entrances:x.properties.entrances,sourceId:0},O=x.properties.source_id,F=y.get(O);F||(F=[],y.set(O,F)),F.push(P)}this.maxHeight=0;for(let{feature:x,index:w}of e){if(kD[x.type]==="LineString")continue;let I=this.layers[0]._featureFilter.needGeometry,S=Pe(x,I);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom),S,s))continue;let D=I?S.geometry:pe(x,s,c),P=km(D,500);if(!cF(D,163))continue;let O=this.layers[0],F=O.layout.get("building-base").evaluate(x,{},s),B=O.layout.get("building-height").evaluate(x,{},s),H=O.layout.get("building-roof-shape").evaluate(x,{},s),X=O.paint.get("building-ambient-occlusion-intensity"),Z=O.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if(H==="flat")continue;let K=x.properties.source_id,de;de=y.has(K)?y.get(K):[];let ae=[],ce=new Xe(1/0,1/0),ge=new Xe(-1/0,-1/0);for(let Ge of P)if(Ge.length>0){let Ke=[];for(let vt of Ge){let ht=[];for(let at=vt.length-1;at>=0;at--){let ft=vt[at];ht.push({x:ft.x,y:ft.y}),ce.x=Math.min(ce.x,ft.x),ce.y=Math.min(ce.y,ft.y),ge.x=Math.max(ge.x,ft.x),ge.y=Math.max(ge.y,ft.y)}Ke.push(ht)}ae.push({id:x.id,height:B,minHeight:F,sourceId:0,roofType:H,coordinates:Ke})}let ye=f.generateMesh(ae,de);if(typeof ye=="string"||ye.meshes.length===0||ye.modifiedPolygonRings.length===0)continue;let ke=0;for(let Ge of ye.meshes)ke+=Ge.positions.length/3;let be=this.segmentsBucket.prepareSegment(ke,this.layoutVertexArray,this.indexArray),ze=[],et=null,Ve=0,We=-1,Je=this.indexArray.length,Oe=0;for(let Ge of ye.meshes){let Ke=this.layoutVertexArray.length;if(Ge.buildingPart==="entrance"){let ht=new Array;for(let Bt=0;Bt<Ge.indices.length;Bt+=12){let Wt=Ge.positions[Bt+0],$t=Ge.positions[Bt+1],pn=Ge.positions[Bt+3],nn=Ge.positions[Bt+4],ni=Ge.positions[Bt+2],Q=Ge.positions[Bt+8]-ni,ee=1,Re=pn-Wt,rt=nn-$t,ct=Math.hypot(Re,rt);ht.push({pos:[Wt+.5*Re,$t+.5*rt,ni],normal:[rt/ct,-Re/ct,0],width:ct,height:Q,depth:ee,points:[Wt,$t,pn,nn]})}let at=this.entranceBloom.segmentsBucket.prepareSegment(10*ht.length,this.entranceBloom.layoutVertexArray,this.entranceBloom.indexArray),ft=this.entranceBloom.layoutVertexArray.length;Ve=this.entranceBloom.indexArray.length,PD(ht,.5/this.tileToMeter,this.entranceBloom.indexArray,this.entranceBloom.layoutVertexArray,this.entranceBloom.layoutAttenuationArray);let Mt=this.entranceBloom.layoutVertexArray.length-ft;We=this.entranceBloom.indexArray.length-Ve;for(let Bt=0;Bt<Mt;Bt++)this.entranceBloom.layoutColorArray.emplaceBack(65535,65535);at.vertexLength+=Mt,at.primitiveLength+=We,et={part:Ge.buildingPart,vertexOffset:ft,vertexLength:Mt}}for(let ht=0;ht<Ge.positions.length;ht+=3)Oe=Math.max(Oe,Ge.positions[ht+2]),this.layoutVertexArray.emplaceBack(Ge.positions[ht],Ge.positions[ht+1],Ge.positions[ht+2]);for(let ht=0;ht<Ge.normals.length;ht+=3)this.layoutNormalArray.emplaceBack(Ge.normals[ht+0]*Tw,Ge.normals[ht+1]*Tw,Ge.normals[ht+2]*Tw);for(let ht=0;ht<Ge.ao.length;ht++)this.layoutAOArray.push(Ge.ao[ht]);for(let ht=0;ht<Ge.colors.length;ht+=3){let at=1+(Ge.ao[ht/3]-1)*X;this.layoutColorArray.emplaceBack(Ge.colors[ht]*at<<8|Ge.colors[ht+1]*at,Ge.colors[ht+2]*at<<8)}let vt=be.vertexLength;for(let ht=0;ht<Ge.indices.length;ht+=3)this.indexArray.emplaceBack(vt+Ge.indices[ht],vt+Ge.indices[ht+1],vt+Ge.indices[ht+2]);be.vertexLength+=Ge.positions.length/3,be.primitiveLength+=Ge.indices.length/3,(Ge.buildingPart==="roof"||Ge.buildingPart==="wall"||Ge.buildingPart==="facade_glazing"||Ge.buildingPart==="entrance")&&ze.push({part:Ge.buildingPart,vertexOffset:Ke,vertexLength:Ge.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Oe),this.buildingFeatures.push({feature:S,segment:be,parts:ze,buildingBloom:et});let Ze=this.indexArray.length-Je,we=[],Le=[],it=new Xe(1/0,1/0),Ye=new Xe(-1/0,-1/0),Et=this.groundEffect.vertexArray.length;for(let Ge of ye.modifiedPolygonRings){let Ke=[],vt=new Xe(1/0,1/0),ht=new Xe(-1/0,-1/0);for(let at=0;at<Ge.length;at+=2){let ft=Ge.length-at-2;vt.x=Math.min(vt.x,Ge[ft]),vt.y=Math.min(vt.y,Ge[ft+1]),ht.x=Math.max(ht.x,Ge[ft]),ht.y=Math.max(ht.y,Ge[ft+1]);let Mt=new Xe(Ge[ft],Ge[ft+1]);Ke.push(Mt),we.push(Mt.x,Mt.y),Le.push(Mt.clone())}it.x=Math.min(it.x,vt.x),it.y=Math.min(it.y,vt.y),Ye.x=Math.max(Ye.x,ht.x),Ye.y=Math.max(Ye.y,ht.y),this.groundEffect.addData(Ke,[vt,ht],Z)}let _t=this.groundEffect.vertexArray.length-Et;(ce.x<0||ge.x>st||ce.y<0||ge.y>st)&&this.featuresOnBorder.push({featureId:x.id,footprintIndex:this.footprints.length});{let Ge=Yh(we,null,2),Ke=new Xy(Le,Ge,8,256),vt=x.id;x.properties&&x.properties.hasOwnProperty("building_id")&&(vt=x.properties.building_id),this.footprints.push({vertices:Le,indices:Ge,grid:Ke,min:it,max:Ye,buildingId:vt,hiddenFlags:0,indicesOffset:Je,indicesLength:Ze,bloomIndicesOffset:Ve,bloomIndicesLength:We,groundEffectVertexOffset:Et,groundEffectVertexLength:_t,segment:be,height:Oe})}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,x,w,{},n.availableImages,s,n.brightness),this.groundEffect.addPaintPropertiesData(x,w,{},n.availableImages,s,n.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0])}update(e,n,s,c,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y),this.groundEffect.update(e,n,f,s,c,p,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,OD.members),this.layoutNormalBuffer=e.createVertexBuffer(this.layoutNormalArray,aF.members),this.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(this.entranceBloom.layoutVertexArray,OD.members),this.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(this.entranceBloom.layoutAttenuationArray,lF.members),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutNormalBuffer.destroy(),this.layoutColorBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segmentsBucket.destroy(),this.entranceBloom.layoutVertexBuffer.destroy(),this.entranceBloom.layoutColorBuffer.destroy(),this.entranceBloom.layoutAttenuationBuffer.destroy(),this.entranceBloom.indexBuffer.destroy(),this.entranceBloom.segmentsBucket.destroy())}updateFootprintHiddenFlags(e,n,s=!0){let c=!1,f=s?n:0,p=0|(s?-1:~n);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let y of e){let x=this.footprints[y],w=x.hiddenFlags&p|f;x.hiddenFlags!==w&&(x.hiddenFlags=w,c=!0,this.groundEffect.updateHiddenByLandmarkRange(x.groundEffectVertexOffset,x.groundEffectVertexLength,x.hiddenFlags!==0))}return c&&(this.indexArrayForConflationUploaded=!1),c}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),!this.indexArrayForConflationUploaded&&this.indexArray.length!==0){this.indexArrayForConflation.resize(this.indexArray.length),this.indexArrayForConflation.uint16.set(this.indexArray.uint16),this.entranceBloom.indexArrayForConflation.resize(this.entranceBloom.indexArray.length),this.entranceBloom.indexArrayForConflation.uint16.set(this.entranceBloom.indexArray.uint16);for(let n of this.footprints){let s=n.indicesOffset+n.indicesLength;if(n.hiddenFlags!==0){for(let f=n.indicesOffset;f<s;f++)this.indexArrayForConflation.uint16[3*f+0]=0,this.indexArrayForConflation.uint16[3*f+1]=0,this.indexArrayForConflation.uint16[3*f+2]=0;let c=n.bloomIndicesOffset+n.bloomIndicesLength;for(let f=n.bloomIndicesOffset;f<c;f++)this.entranceBloom.indexArrayForConflation.uint16[3*f+0]=0,this.entranceBloom.indexArrayForConflation.uint16[3*f+1]=0,this.entranceBloom.indexArrayForConflation.uint16[3*f+2]=0}}this.indexBuffer?this.indexBuffer.updateData(this.indexArrayForConflation):this.indexBuffer=e.createIndexBuffer(this.indexArrayForConflation,!0),this.entranceBloom.indexBuffer?this.entranceBloom.indexBuffer.updateData(this.entranceBloom.indexArrayForConflation):this.entranceBloom.indexBuffer=e.createIndexBuffer(this.entranceBloom.indexArrayForConflation,!0),this.indexArrayForConflationUploaded=!0}}uploadUpdatedColorBuffer(e){this.layoutColorBuffer?this.layoutColorBuffer.updateData(this.layoutColorArray):this.layoutColorBuffer=e.createVertexBuffer(this.layoutColorArray,LD.members,!0),this.entranceBloom.layoutColorBuffer?this.entranceBloom.layoutColorBuffer.updateData(this.entranceBloom.layoutColorArray):this.entranceBloom.layoutColorBuffer=e.createVertexBuffer(this.entranceBloom.layoutColorArray,LD.members,!0)}evaluate(e){let n=e.paint.get("building-ambient-occlusion-intensity");for(let s of this.buildingFeatures){let c=s.feature;c.properties["building-part"]="roof";let f=e.paint.get("building-color").evaluate(c,{},this.canonical),p=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);c.properties["building-part"]="wall";let y=e.paint.get("building-color").evaluate(c,{},this.canonical),x=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);c.properties["building-part"]="window";let w=e.paint.get("building-color").evaluate(c,{},this.canonical),I=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);c.properties["building-part"]="door";let S=e.paint.get("building-color").evaluate(c,{},this.canonical),D=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);for(let O of s.parts){let F,B=f;O.part==="roof"?(B=f,F=p):O.part==="wall"?(B=y,F=x):O.part==="facade_glazing"?(B=w,F=I):O.part==="entrance"&&(B=S,F=D),F=ne(F,0,1);for(let H=0;H<O.vertexLength;H++){let X=O.vertexOffset+H,Z=1+(this.layoutAOArray[X]-1)*n;this.layoutColorArray.emplace(X,B.r*Z*255<<8|B.g*Z*255,B.b*Z*255<<8|255*F)}}let P=s.buildingBloom;if(P)for(let O=0;O<P.vertexLength;O++)this.bloomGeometry.layoutColorArray.emplace(P.vertexOffset+O,255*S.r<<8|255*S.g,255*S.b<<8|51*D)}}needsEvaluation(e,n){let s=e.transform.projectionOptions,c=e.style.getBrightness();return!(this.uploaded&&s.name===this.projection.name&&this.brightness===c||(this.projection=s,this.brightness=c,0))}updateReplacement(e,n,s){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let c=n.getReplacementRegionsForTile(e.toUnwrapped());if(Ky(this.activeReplacements,c))return;this.activeReplacements=c;for(let p of this.footprints)p.hiddenFlags&=-2;let f=[];for(let p of this.activeReplacements){if(p.order<=jS)continue;let y=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));for(let x of this.footprints)x.min.x>p.max.x||x.max.x<p.min.x||x.min.y>p.max.y||x.max.y<p.min.y||(f.length=0,uF(x.vertices,0,x.vertices.length,p.footprintTileId.canonical,e.canonical,f),ow(p.footprint,f,x.indices,0,x.indices.length,0,-y)&&(x.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let p of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(p.groundEffectVertexOffset,p.groundEffectVertexLength,p.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(e,n){let s=Number.NEGATIVE_INFINITY,c=!0,f=4*(e+st)*st+(n+st);if(this.footprintLookup.hasOwnProperty(f)){let y=this.footprintLookup[f];return y?{height:y.height,hidden:y.hiddenFlags!==0}:void 0}let p=new Xe(e,n);for(let y of this.footprints)e>y.max.x||y.min.x>e||n>y.max.y||y.min.y>n||y.height<=s||sw(p,y)&&(s=y.height,this.footprintLookup[f]=y,c=y.hiddenFlags!==0);if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:c};this.footprintLookup[f]=void 0}}function uF(i,e,n,s,c,f){let p=Math.pow(2,s.z-c.z);for(let y=0;y<n;y++){let x=i[y+e].x,w=i[y+e].y;x=(x+c.x*st)*p-s.x*st,w=(w+c.y*st)*p-s.y*st,f.push(new Xe(x,w))}}let ND,zD;gt(FD,"BuildingBucket",{omit:["layers"]});let dF=gn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),hF=gn([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:fF}=dF,pF=gn([{name:"a_packed",components:3,type:"Float32"}]),{members:mF}=pF,gF=gn([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:_F}=gF;class BD{constructor(e,n){this.width=e,this.height=n,this.nextRow=0,this.image=new Cc({width:e,height:n}),this.positions={},this.uploaded=!1}getDash(e,n){let s=this.getKey(e,n);return this.positions[s]}trim(){let e=this.width,n=this.height=Dt(this.nextRow);this.image.resize({width:e,height:n})}getKey(e,n){return e.join(",")+n}getDashRanges(e,n,s){let c=[],f=e.length%2==1?-e[e.length-1]*s:0,p=e[0]*s,y=!0;c.push({left:f,right:p,isDash:y,zeroLength:e[0]===0});let x=e[0];for(let w=1;w<e.length;w++){y=!y;let I=e[w];f=x*s,x+=I,p=x*s,c.push({left:f,right:p,isDash:y,zeroLength:I===0})}return c}addRoundDash(e,n,s){let c=n/2;for(let f=-s;f<=s;f++){let p=this.width*(this.nextRow+s+f),y=0,x=e[y];for(let w=0;w<this.width;w++){w/x.right>1&&(x=e[++y]);let I=Math.abs(w-x.left),S=Math.abs(w-x.right),D=Math.min(I,S),P,O=f/s*(c+1);if(x.isDash){let F=c-Math.abs(O);P=Math.sqrt(D*D+F*F)}else P=c-Math.sqrt(D*D+O*O);this.image.data[p+w]=Math.max(0,Math.min(255,P+128))}}}addRegularDash(e,n){for(let x=e.length-1;x>=0;--x){let w=e[x],I=e[x+1];w.zeroLength?e.splice(x,1):I&&I.isDash===w.isDash&&(I.left=w.left,e.splice(x,1))}let s=e[0],c=e[e.length-1];s.isDash===c.isDash&&(s.left=c.left-this.width,c.right=s.right+this.width);let f=this.width*this.nextRow,p=0,y=e[p];for(let x=0;x<this.width;x++){x/y.right>1&&(y=e[++p]);let w=Math.abs(x-y.left),I=Math.abs(x-y.right),S=Math.min(w,I);this.image.data[f+x]=Math.max(0,Math.min(255,(y.isDash?S:-S)+n+128))}}addDash(e,n){let s=this.getKey(e,n);if(this.positions[s])return this.positions[s];let c=n==="round",f=c?7:0,p=2*f+1;if(this.nextRow+p>this.height)return fn("LineAtlas out of space"),null;e.length===0&&e.push(1);let y=0;for(let I=0;I<e.length;I++)e[I]<0&&(fn("Negative value is found in line dasharray, replacing values with 0"),e[I]=0),y+=e[I];if(y!==0){let I=this.width/y,S=this.getDashRanges(e,this.width,I);c?this.addRoundDash(S,I,f):this.addRegularDash(S,n==="square"?.5*I:0)}let x=this.nextRow+f;this.nextRow+=p;let w={tl:[x,f],br:[y,0]};return this.positions[s]=w,w}}gt(BD,"LineAtlas");let yF=Ie.types,vF=Math.cos(Math.PI/180*37.5),xF=Math.cos(Math.PI/180*5);class Iw{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new Vh,this.layoutVertexArray2=new Ao,this.patternVertexArray=new Ao,this.indexArray=new di,this.programConfigurations=new Ro(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new gi,this.maxLineLength=0,this.zOffsetVertexArray=new Ao,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:st/64,this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){this.hasPattern=Qb("line",this.layers,this.pixelRatio,n);let f=this.layers[0].layout.get("line-sort-key");this.tileToMeter=oe(s);let p=this.layers[0].layout.get("line-elevation-reference");if(p==="hd-road-markup")this.elevationType="road";else{let D=this.layers[0].layout.get("line-z-offset"),P=D.isConstant()&&!D.constantOr(0);this.elevationType=p!=="sea"&&p!=="ground"&&P?"none":"offset",this.elevationType==="offset"&&p==="none"&&fn(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}let y=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&y!==void 0;let x=[];for(let{feature:D,id:P,index:O,sourceLayerIndex:F}of e){let B=this.layers[0]._featureFilter.needGeometry,H=Pe(D,B);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom,{worldview:this.worldview}),H,s))continue;let X=f?f.evaluate(H,{},s):void 0,Z={id:P,properties:D.properties,type:D.type,sourceLayerIndex:F,index:O,geometry:B?H.geometry:pe(D,s,c),patterns:{},sortKey:X};x.push(Z)}f&&x.sort((D,P)=>D.sortKey-P.sortKey);let{lineAtlas:w,featureIndex:I}=n,S=this.addConstantDashes(w);for(let D of x){let{geometry:P,index:O,sourceLayerIndex:F}=D;if(S&&this.addFeatureDashes(D,w),this.hasPattern){let B=ew("line",this.layers,D,this.zoom,this.pixelRatio,n);this.patternFeatures.push(B)}else this.addFeature(D,P,O,s,w.positions,n.availableImages,n.brightness,n.elevationFeatures);I.insert(e[O].feature,P,O,F,this.index)}}addConstantDashes(e){let n=!1;for(let s of this.layers){let c=s.paint.get("line-dasharray").value,f=s.layout.get("line-cap").value;if(c.kind!=="constant"||f.kind!=="constant")n=!0;else{let p=f.value,y=c.value;if(!y)continue;e.addDash(y,p)}}return n}addFeatureDashes(e,n){let s=this.zoom;for(let c of this.layers){let f=c.paint.get("line-dasharray").value,p=c.layout.get("line-cap").value;if(f.kind==="constant"&&p.kind==="constant")continue;let y,x;if(f.kind==="constant"){if(y=f.value,!y)continue}else y=f.evaluate({zoom:s},e);x=p.kind==="constant"?p.value:p.evaluate({zoom:s},e),n.addDash(y,x),e.patterns[c.id]=[n.getKey(y,x)]}}update(e,n,s,c,f,p,y,x){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x)}addFeatures(e,n,s,c,f,p){for(let y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,n,s,c,p)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,mF)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,_F)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,hF.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,fF),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,n,s,c,f,p,y,x){let w=this.layers[0].layout,I=w.get("line-join").evaluate(e,{}),S=w.get("line-cap").evaluate(e,{}),D=w.get("line-miter-limit"),P=w.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=w.get("line-z-offset").value;let O=this.layers[0].paint.get("line-width").value;if(O.kind!=="constant"&&O.isLineProgressConstant===!1&&(this.variableWidthValue=O),this.elevationType==="road"){let F=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,n,c,x,I,S,D,P)){let[B,H]=this.clipRuntimeLinesToTile(n,1);for(let X=0;X<B.length;X++){let Z=B[X],K=H[X],de={progress:{min:K.progress.min,max:K.progress.max},nextDir:this.computeSegNextDir(K,Z),prevDir:this.computeSegPrevDir(K,Z)};this.addLine(Z,e,c,I,S,D,P,de)}this.fillNonElevatedRoadSegment(F)}}else for(let F of n)this.addLine(F,e,c,I,S,D,P);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,f,p,c,y,void 0,this.worldview)}computeSegNextDir(e,n){return e.nextPoint.sub(n.at(-2)).unit()}computeSegPrevDir(e,n){return n[1].sub(e.prevPoint).unit()}clipLinesToTile(e,n){return ev(e,-n,-n,st+n,st+n)}clipRuntimeLinesToTile(e,n){let s=[];return[ev(e,-n,-n,st+n,st+n,s),s]}addElevatedRoadFeature(e,n,s,c,f,p,y,x){let w=[],I=_i.getElevationFeature(e,c);if(I){let S=this.clipLinesToTile(n,1),D=this.prepareElevatedLines(S,I,s);for(let P of D)w.push({geometry:P,elevation:I,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(w.length===0)return!1;for(let S of w){let D=this.layoutVertexArray.length;this.addLine(S.geometry,e,s,f,p,y,x);let P=new yn(s,S.elevationTileID);if(S.elevation)for(let O=D;O<this.layoutVertexArray.length;O++){let F=new Xe(this.layoutVertexArray.int16[6*O]>>1,this.layoutVertexArray.int16[6*O+1]>>1),B=P.pointElevation(F,S.elevation,.05);this.updateHeightRange(B),this.zOffsetVertexArray.emplaceBack(B,0,0)}else this.fillNonElevatedRoadSegment(D)}return!0}prepareElevatedLines(e,n,s){if(n.constantHeight!=null)return e;let c=[],f=1/oe(s);for(let p of e)Nk(p,new zn(n,f),0,c);return c}fillNonElevatedRoadSegment(e){for(let n=e;n<this.layoutVertexArray.length;n++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,n,s,c,f,p,y,x){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;let w=c==="none";this.patternJoinNone=this.hasPattern&&w,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];let I=x&&x.progress.min>0,S=x&&x.progress.max<1;if(this.lineClips){let ge={min:this.lineClips.start,max:this.lineClips.end},ye=1;if(x){let ze=this.lineClips.end-this.lineClips.start;ge=function(et,Ve,We){return{min:hu(et.min,Ve,We),max:hu(et.max,Ve,We)}}(x.progress,{min:0,max:1},ge),ze>0&&(ye=(ge.max-ge.min)/ze)}let ke=+n.properties.mapbox_clip_feature_len,be=+n.properties.mapbox_clip_seg_len;if(Number.isNaN(ke)||Number.isNaN(be)){for(let et=0;et<e.length-1;et++)this.totalDistance+=e[et].dist(e[et+1]);let ze=this.totalDistance/(ge.max-ge.min);this.totalFeatureLength=Number.isFinite(ze)?ze:0,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=ke,this.distance=be*ye,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}let D=yF[n.type]==="Polygon",P=e.length;for(;P>=2&&e[P-1].equals(e[P-2]);)P--;let O=0;for(;O<P-1&&e[O].equals(e[O+1]);)O++;if(P<(D?3:2))return;c==="bevel"&&(p=1.05);let F=this.segments.prepareSegment(10*P,this.layoutVertexArray,this.indexArray),B,H,X,Z,K,de,ae,ce;x&&x.prevDir&&(de=x.prevDir.perp()),x&&x.nextDir&&(ae=x.nextDir.perp()),this.e1=this.e2=-1,D&&(B=e[P-2],K=e[O].sub(B)._unit()._perp());for(let ge=O;ge<P;ge++){if(X=ge===P-1?D?e[O+1]:void 0:e[ge+1],X&&e[ge].equals(X))continue;K&&(Z=K),B&&(H=B),B=e[ge],ce=this.evaluateLineProgressFeatures(H?H.dist(B):0),K=X?X.sub(B)._unit()._perp():Z,Z=Z||K;let ye=H&&X,ke=ye?c:D||w?"butt":f,be=Z.x*K.x+Z.y*K.y;if(w){let we=function(Le){if(Le.patternJoinNone){let it=Le.segmentPoints.length/2,Ye=Le.lineSoFar-Le.segmentStart;for(let Et=0;Et<it;++Et){let _t=Le.segmentPoints[2*Et+1],Ge=Math.round(Le.segmentPoints[2*Et])+.5+.25*_t;Le.patternVertexArray.emplaceBack(Ge,Ye,Le.segmentStart),Le.patternVertexArray.emplaceBack(Ge,Ye,Le.segmentStart)}Le.segmentPoints.length=0}Le.e1=Le.e2=-1};if(ye&&be<xF){this.updateDistance(H,B),this.addCurrentVertex(B,Z,1,1,F,ce),we(this),this.addCurrentVertex(B,K,-1,-1,F,ce);continue}if(H){if(!X){this.updateDistance(H,B),this.addCurrentVertex(B,Z,1,1,F,ce),we(this);continue}ke="miter"}}let ze=Z.add(K);ze.x===0&&ze.y===0||ze._unit();let et=ze.x*K.x+ze.y*K.y,Ve=et!==0?1/et:1/0,We=2*Math.sqrt(2-2*et),Je=et<vF&&H&&X,Oe=Z.x*K.y-Z.y*K.x>0,Ze=this.overscaling<=16?15*st/(512*this.overscaling):0;if(ye&&ke==="round"){if(Ve<y)ke="miter";else if(Ve<=2){let we=Sw(B,-10,st+10);ke=this.elevationType==="offset"&&(we||this.hasCrossSlope)?"miter":"fakeround"}}if(ke==="miter"&&Ve>p&&(ke="bevel"),ke==="bevel"&&(Ve>2&&(ke="flipbevel"),Ve<p&&(ke="miter")),H&&!(ke==="miter"&&Je)&&this.updateDistance(H,B),ke==="miter")if(Je){let we=B.dist(H);if(we>2*Ze){let it=B.sub(B.sub(H)._mult(Ze/we)._round());this.updateDistance(H,it),this.addCurrentVertex(it,Z,0,0,F,ce),H=it}this.updateDistance(H,B),ze._mult(Ve),this.addCurrentVertex(B,ze,0,0,F,ce);let Le=B.dist(X);if(Le>2*Ze){let it=B.add(X.sub(B)._mult(Ze/Le)._round());this.updateDistance(B,it),this.addCurrentVertex(it,K,0,0,F,ce),B=it}}else ze._mult(Ve),this.addCurrentVertex(B,ze,0,0,F,ce);else if(ke==="flipbevel"){if(Ve>100)ze=K.mult(-1);else{let we=Ve*Z.add(K).mag()/Z.sub(K).mag();ze._perp()._mult(we*(Oe?-1:1))}this.addCurrentVertex(B,ze,0,0,F,ce),this.addCurrentVertex(B,ze.mult(-1),0,0,F,ce)}else if(ke==="bevel"||ke==="fakeround"){ce!=null&&H&&this.addCurrentVertex(B,ae||Z,-1,-1,F,ce);let we=B.dist(H)<=2*Ze&&ke!=="bevel",Le=ze.mult(Oe?1:-1);Le._mult(Ve);let it=K.mult(Oe?-1:1),Ye=Z.mult(Oe?-1:1),Et=this.evaluateLineProgressFeatures(this.distance);if(ce==null&&(this.addHalfVertex(B,Le.x,Le.y,!1,!Oe,0,F,Et),we||this.addHalfVertex(B,Le.x+2*Ye.x,Le.y+2*Ye.y,!1,Oe,0,F,Et)),ke==="fakeround"){let _t=Math.round(180*We/Math.PI/20);this.addHalfVertex(B,Ye.x,Ye.y,!1,Oe,0,F,Et);for(let Ge=0;Ge<_t;Ge++){let Ke=Ge/_t;if(Ke!==.5){let ht=Ke-.5;Ke+=Ke*ht*(Ke-1)*((1.0904+be*(be*(3.55645-1.43519*be)-3.2452))*ht*ht+(.848013+be*(.215638*be-1.06021)))}let vt=it.sub(Ye)._mult(Ke)._add(Ye)._unit();this.addHalfVertex(B,vt.x,vt.y,!1,Oe,0,F,Et)}this.addHalfVertex(B,it.x,it.y,!1,Oe,0,F,Et)}we||ce!=null||this.addHalfVertex(B,Le.x+2*it.x,Le.y+2*it.y,!1,Oe,0,F,Et),ce!=null&&X&&this.addCurrentVertex(B,de||K,1,1,F,ce)}else if(ke==="butt")this.addCurrentVertex(B,ze,0,0,F,ce);else if(ke==="square"){if(!H){let we=I?0:-1;this.addCurrentVertex(B,ze,we,we,F,ce)}if(this.addCurrentVertex(B,ze,0,0,F,ce),H){let we=S?0:1;this.addCurrentVertex(B,ze,we,we,F,ce)}}else if(ke==="round"){if(H){let we=!ye&&ae?ae:Z;this.addCurrentVertex(B,we,0,0,F,ce),!ye&&S||this.addCurrentVertex(B,we,1,1,F,ce,!0)}if(X){let we=!ye&&de?de:K;!ye&&I||this.addCurrentVertex(B,we,-1,-1,F,ce,!0),this.addCurrentVertex(B,we,0,0,F,ce)}}}}addVerticesTo(e,n,s,c,f,p,y,x,w,I){let S=(n.w-e.w)/this.tessellationStep|0,D=0,P=this.scaledDistance;if(S>1){this.lineSoFar=e.w;let F=(n.x-e.x)/S,B=(n.y-e.y)/S,H=(n.z-e.z)/S,X=(n.w-e.w)/S;for(let Z=1;Z<S;++Z){e.x+=F,e.y+=B,e.z+=H,this.lineSoFar+=X,D+=X;let K=this.evaluateLineProgressFeatures(this.prevDistance+D);this.scaledDistance=(this.prevDistance+D)/this.totalDistance,this.addHalfVertex(e,s,c,I,!1,y,w,K),this.addHalfVertex(e,f,p,I,!0,-x,w,K)}}this.lineSoFar=n.w,this.scaledDistance=P;let O=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(n,s,c,I,!1,y,w,O),this.addHalfVertex(n,f,p,I,!0,-x,w,O)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):fn(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let n=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(n=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:n}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:n}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:n}}addCurrentVertex(e,n,s,c,f,p,y=!1){let x=n.x+n.y*s,w=n.y-n.x*s,I=n.y*c-n.x,S=-n.y-n.x*c;if(p!=null){let D=this.elevationType==="offset",P=-10,O=st+10,F=p.zOffset,B=new lD(e.x,e.y,F,this.lineSoFar),H=!!D&&Sw(e,P,O),X=this.lineSoFar,Z=this.distance;if(this.currentVertex)if(H){let K=this.currentVertexIsOutside,de=this.currentVertex,ae=new lD(e.x,e.y,F,this.lineSoFar);if(uD(de,ae,P,O),!Sw(ae,P,O)){if(K){this.e1=this.e2=-1,this.distance-=de.dist(B),this.lineSoFar=de.w;let ce=this.evaluateLineProgressFeatures(de.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(de,x,w,y,!1,s,f,ce),this.addHalfVertex(de,I,S,y,!0,-c,f,ce),this.prevDistance=this.distance}this.distance=this.prevDistance+de.dist(ae),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(de,ae,x,w,I,S,s,c,f,y),this.distance=Z,this.scaledDistance=this.distance/this.totalDistance}}else{let K=this.currentVertex;if(this.currentVertexIsOutside){uD(K,B,P,O),this.e1=this.e2=-1,this.distance-=K.dist(B),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=K.w;let de=this.evaluateLineProgressFeatures(K.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(K,x,w,y,!1,s,f,de),this.addHalfVertex(K,I,S,y,!0,-c,f,de),this.prevDistance=this.distance,this.distance=Z,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(K,B,x,w,I,S,s,c,f,y)}else H||(this.addHalfVertex(e,x,w,y,!1,s,f,p),this.addHalfVertex(e,I,S,y,!0,-c,f,p));this.currentVertex=B,this.currentVertexIsOutside=H,this.lineSoFar=X}else this.addHalfVertex(e,x,w,y,!1,s,f,p),this.addHalfVertex(e,I,S,y,!0,-c,f,p)}addHalfVertex({x:e,y:n},s,c,f,p,y,x,w){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),p||this.segmentPoints.push(this.lineSoFar-this.segmentStart,y)),this.layoutVertexArray.emplaceBack((e<<1)+(f?1:0),(n<<1)+(p?1:0),Math.round(63*s)+128,Math.round(63*c)+128,1+(y===0?0:y<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let S=Ct(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,S)}let I=x.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,I),x.primitiveLength++),p?this.e2=I:this.e1=I,w!=null&&this.zOffsetVertexArray.emplaceBack(w.zOffset,w.variableWidth,w.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,n){this.prevDistance=this.distance,this.distance+=e.dist(n),this.updateScaledDistance()}}function Sw(i,e,n){return i.x<e||i.x>n||i.y<e||i.y>n}let VD,jD;function UD(i,e,n){return e*(st/(i.tileSize*Math.pow(2,n-i.tileID.overscaledZ)))}gt(Iw,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let HD=(i,e,n)=>(1-n)*i+n*e;function $D(i,e){return 1/UD(i,1,e.tileZoom)}function GD(i,e,n,s){return i.translatePosMatrix(s||e.tileID.projMatrix,e,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}let qD=i=>{let e=[];WD(i)&&e.push("RENDER_LINE_DASH"),i.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");let n=i.paint.get("line-trim-offset");n[0]===0&&n[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),i.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");let s=i.layout.get("line-join").constantOr("miter")==="none",c=!!i.paint.get("line-pattern").constantOr(1);return s&&c&&e.push("LINE_JOIN_NONE"),e};function WD(i){let e=i.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let Dw,ZD=()=>Dw||(Dw={layout:VD||(VD=new Mi({"line-cap":new ut(xe.layout_line["line-cap"]),"line-join":new ut(xe.layout_line["line-join"]),"line-miter-limit":new tt(xe.layout_line["line-miter-limit"]),"line-round-limit":new tt(xe.layout_line["line-round-limit"]),"line-sort-key":new ut(xe.layout_line["line-sort-key"]),"line-z-offset":new ut(xe.layout_line["line-z-offset"]),"line-elevation-reference":new tt(xe.layout_line["line-elevation-reference"]),"line-cross-slope":new tt(xe.layout_line["line-cross-slope"]),visibility:new tt(xe.layout_line.visibility),"line-width-unit":new tt(xe.layout_line["line-width-unit"])})),paint:jD||(jD=new Mi({"line-opacity":new ut(xe.paint_line["line-opacity"]),"line-color":new ut(xe.paint_line["line-color"]),"line-translate":new tt(xe.paint_line["line-translate"]),"line-translate-anchor":new tt(xe.paint_line["line-translate-anchor"]),"line-width":new ut(xe.paint_line["line-width"]),"line-gap-width":new ut(xe.paint_line["line-gap-width"]),"line-offset":new ut(xe.paint_line["line-offset"]),"line-blur":new ut(xe.paint_line["line-blur"]),"line-dasharray":new ut(xe.paint_line["line-dasharray"]),"line-pattern":new ut(xe.paint_line["line-pattern"]),"line-pattern-cross-fade":new tt(xe.paint_line["line-pattern-cross-fade"]),"line-gradient":new dc(xe.paint_line["line-gradient"]),"line-trim-offset":new tt(xe.paint_line["line-trim-offset"]),"line-trim-fade-range":new tt(xe.paint_line["line-trim-fade-range"]),"line-trim-color":new tt(xe.paint_line["line-trim-color"]),"line-emissive-strength":new tt(xe.paint_line["line-emissive-strength"]),"line-border-width":new ut(xe.paint_line["line-border-width"]),"line-border-color":new ut(xe.paint_line["line-border-color"]),"line-occlusion-opacity":new tt(xe.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},Dw);class bF extends ut{possiblyEvaluate(e,n){return n=new Un(Math.floor(n.zoom),{now:n.now,fadeDuration:n.fadeDuration,transition:n.transition,worldview:n.worldview}),super.possiblyEvaluate(e,n)}evaluate(e,n,s,c){return n=De({},n,{zoom:Math.floor(n.zoom)}),super.evaluate(e,n,s,c)}}let Wm;function XD(i,e){return e>0?e+2*i:i}let wF=gn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),EF=gn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),TF=gn([{name:"a_projected_pos",components:4,type:"Float32"}],4);gn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let IF=gn([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),SF=gn([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),DF=gn([{name:"a_texb",components:2,type:"Uint16"}]),CF=gn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),AF=gn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);gn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let YD=gn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),MF=gn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);gn([{name:"triangle",components:3,type:"Uint16"}]),gn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),gn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),gn([{type:"Float32",name:"offsetX"}]),gn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var gr=24;function RF(i,e,n){return i.sections.forEach(s=>{s.text=function(c,f,p){let y=f.layout.get("text-transform").evaluate(p,{});return y==="uppercase"?c=c.toLocaleUpperCase():y==="lowercase"&&(c=c.toLocaleLowerCase()),bs.applyArabicShaping&&(c=bs.applyArabicShaping(c)),c}(s.text,e,n)}),i}let Zm={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function PF(i){return i==="\uFE36"||i==="\uFE48"||i==="\uFE38"||i==="\uFE44"||i==="\uFE42"||i==="\uFE3E"||i==="\uFE3C"||i==="\uFE3A"||i==="\uFE18"||i==="\uFE40"||i==="\uFE10"||i==="\uFE13"||i==="\uFE14"||i==="\uFF40"||i==="\uFFE3"||i==="\uFE11"||i==="\uFE12"}function OF(i){return i==="\uFE35"||i==="\uFE47"||i==="\uFE37"||i==="\uFE43"||i==="\uFE41"||i==="\uFE3D"||i==="\uFE3B"||i==="\uFE39"||i==="\uFE17"||i==="\uFE3F"}let Cw=4294967296,KD=1/Cw,JD=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),cv=class{constructor(i=new Uint8Array(16)){this.buf=ArrayBuffer.isView(i)?i:new Uint8Array(i),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(i,e,n=this.length){for(;this.pos<n;){let s=this.readVarint(),c=s>>3,f=this.pos;this.type=7&s,i(c,e,this),this.pos===f&&this.skip(s)}return e}readMessage(i,e){return this.readFields(i,e,this.readVarint()+this.pos)}readFixed32(){let i=this.dataView.getUint32(this.pos,!0);return this.pos+=4,i}readSFixed32(){let i=this.dataView.getInt32(this.pos,!0);return this.pos+=4,i}readFixed64(){let i=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Cw;return this.pos+=8,i}readSFixed64(){let i=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Cw;return this.pos+=8,i}readFloat(){let i=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,i}readDouble(){let i=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,i}readVarint(i){let e=this.buf,n,s;return s=e[this.pos++],n=127&s,s<128?n:(s=e[this.pos++],n|=(127&s)<<7,s<128?n:(s=e[this.pos++],n|=(127&s)<<14,s<128?n:(s=e[this.pos++],n|=(127&s)<<21,s<128?n:(s=e[this.pos],n|=(15&s)<<28,function(c,f,p){let y=p.buf,x,w;if(w=y[p.pos++],x=(112&w)>>4,w<128||(w=y[p.pos++],x|=(127&w)<<3,w<128)||(w=y[p.pos++],x|=(127&w)<<10,w<128)||(w=y[p.pos++],x|=(127&w)<<17,w<128)||(w=y[p.pos++],x|=(127&w)<<24,w<128)||(w=y[p.pos++],x|=(1&w)<<31,w<128))return rf(c,x,f);throw new Error("Expected varint not more than 10 bytes")}(n,i,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){let i=this.readVarint();return i%2==1?(i+1)/-2:i/2}readBoolean(){return!!this.readVarint()}readString(){let i=this.readVarint()+this.pos,e=this.pos;return this.pos=i,i-e>=12&&JD?JD.decode(this.buf.subarray(e,i)):function(n,s,c){let f="",p=s;for(;p<c;){let y=n[p],x,w,I,S=null,D=y>239?4:y>223?3:y>191?2:1;if(p+D>c)break;D===1?y<128&&(S=y):D===2?(x=n[p+1],(192&x)==128&&(S=(31&y)<<6|63&x,S<=127&&(S=null))):D===3?(x=n[p+1],w=n[p+2],(192&x)==128&&(192&w)==128&&(S=(15&y)<<12|(63&x)<<6|63&w,(S<=2047||S>=55296&&S<=57343)&&(S=null))):D===4&&(x=n[p+1],w=n[p+2],I=n[p+3],(192&x)==128&&(192&w)==128&&(192&I)==128&&(S=(15&y)<<18|(63&x)<<12|(63&w)<<6|63&I,(S<=65535||S>=1114112)&&(S=null))),S===null?(S=65533,D=1):S>65535&&(S-=65536,f+=String.fromCharCode(S>>>10&1023|55296),S=56320|1023&S),f+=String.fromCharCode(S),p+=D}return f}(this.buf,e,i)}readBytes(){let i=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,i);return this.pos=i,e}readPackedVarint(i=[],e){let n=this.readPackedEnd();for(;this.pos<n;)i.push(this.readVarint(e));return i}readPackedSVarint(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readSVarint());return i}readPackedBoolean(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readBoolean());return i}readPackedFloat(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readFloat());return i}readPackedDouble(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readDouble());return i}readPackedFixed32(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readFixed32());return i}readPackedSFixed32(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readSFixed32());return i}readPackedFixed64(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readFixed64());return i}readPackedSFixed64(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readSFixed64());return i}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(i){let e=7&i;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(i,e){this.writeVarint(i<<3|e)}realloc(i){let e=this.length||16;for(;e<this.pos+i;)e*=2;if(e!==this.length){let n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.dataView=new DataView(n.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(i){this.realloc(4),this.dataView.setInt32(this.pos,i,!0),this.pos+=4}writeSFixed32(i){this.realloc(4),this.dataView.setInt32(this.pos,i,!0),this.pos+=4}writeFixed64(i){this.realloc(8),this.dataView.setInt32(this.pos,-1&i,!0),this.dataView.setInt32(this.pos+4,Math.floor(i*KD),!0),this.pos+=8}writeSFixed64(i){this.realloc(8),this.dataView.setInt32(this.pos,-1&i,!0),this.dataView.setInt32(this.pos+4,Math.floor(i*KD),!0),this.pos+=8}writeVarint(i){(i=+i||0)>268435455||i<0?function(e,n){let s,c;if(e>=0?(s=e%4294967296|0,c=e/4294967296|0):(s=~(-e%4294967296),c=~(-e/4294967296),4294967295^s?s=s+1|0:(s=0,c=c+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),function(f,p,y){y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,y.buf[y.pos]=127&(f>>>=7)}(s,0,n),function(f,p){let y=(7&f)<<4;p.buf[p.pos++]|=y|((f>>>=3)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f)))))}(c,n)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))}writeSVarint(i){this.writeVarint(i<0?2*-i-1:2*i)}writeBoolean(i){this.writeVarint(+i)}writeString(i){i=String(i),this.realloc(4*i.length),this.pos++;let e=this.pos;this.pos=function(s,c,f){for(let p,y,x=0;x<c.length;x++){if(p=c.charCodeAt(x),p>55295&&p<57344){if(!y){p>56319||x+1===c.length?(s[f++]=239,s[f++]=191,s[f++]=189):y=p;continue}if(p<56320){s[f++]=239,s[f++]=191,s[f++]=189,y=p;continue}p=y-55296<<10|p-56320|65536,y=null}else y&&(s[f++]=239,s[f++]=191,s[f++]=189,y=null);p<128?s[f++]=p:(p<2048?s[f++]=p>>6|192:(p<65536?s[f++]=p>>12|224:(s[f++]=p>>18|240,s[f++]=p>>12&63|128),s[f++]=p>>6&63|128),s[f++]=63&p|128)}return f}(this.buf,i,this.pos);let n=this.pos-e;n>=128&&QD(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n}writeFloat(i){this.realloc(4),this.dataView.setFloat32(this.pos,i,!0),this.pos+=4}writeDouble(i){this.realloc(8),this.dataView.setFloat64(this.pos,i,!0),this.pos+=8}writeBytes(i){let e=i.length;this.writeVarint(e),this.realloc(e);for(let n=0;n<e;n++)this.buf[this.pos++]=i[n]}writeRawMessage(i,e){this.pos++;let n=this.pos;i(e,this);let s=this.pos-n;s>=128&&QD(n,s,this),this.pos=n-1,this.writeVarint(s),this.pos+=s}writeMessage(i,e,n){this.writeTag(i,2),this.writeRawMessage(e,n)}writePackedVarint(i,e){e.length&&this.writeMessage(i,LF,e)}writePackedSVarint(i,e){e.length&&this.writeMessage(i,kF,e)}writePackedBoolean(i,e){e.length&&this.writeMessage(i,zF,e)}writePackedFloat(i,e){e.length&&this.writeMessage(i,FF,e)}writePackedDouble(i,e){e.length&&this.writeMessage(i,NF,e)}writePackedFixed32(i,e){e.length&&this.writeMessage(i,BF,e)}writePackedSFixed32(i,e){e.length&&this.writeMessage(i,VF,e)}writePackedFixed64(i,e){e.length&&this.writeMessage(i,jF,e)}writePackedSFixed64(i,e){e.length&&this.writeMessage(i,UF,e)}writeBytesField(i,e){this.writeTag(i,2),this.writeBytes(e)}writeFixed32Field(i,e){this.writeTag(i,5),this.writeFixed32(e)}writeSFixed32Field(i,e){this.writeTag(i,5),this.writeSFixed32(e)}writeFixed64Field(i,e){this.writeTag(i,1),this.writeFixed64(e)}writeSFixed64Field(i,e){this.writeTag(i,1),this.writeSFixed64(e)}writeVarintField(i,e){this.writeTag(i,0),this.writeVarint(e)}writeSVarintField(i,e){this.writeTag(i,0),this.writeSVarint(e)}writeStringField(i,e){this.writeTag(i,2),this.writeString(e)}writeFloatField(i,e){this.writeTag(i,5),this.writeFloat(e)}writeDoubleField(i,e){this.writeTag(i,1),this.writeDouble(e)}writeBooleanField(i,e){this.writeVarintField(i,+e)}};function rf(i,e,n){return n?4294967296*e+(i>>>0):4294967296*(e>>>0)+(i>>>0)}function QD(i,e,n){let s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(s);for(let c=n.pos-1;c>=i;c--)n.buf[c+s]=n.buf[c]}function LF(i,e){for(let n=0;n<i.length;n++)e.writeVarint(i[n])}function kF(i,e){for(let n=0;n<i.length;n++)e.writeSVarint(i[n])}function FF(i,e){for(let n=0;n<i.length;n++)e.writeFloat(i[n])}function NF(i,e){for(let n=0;n<i.length;n++)e.writeDouble(i[n])}function zF(i,e){for(let n=0;n<i.length;n++)e.writeBoolean(i[n])}function BF(i,e){for(let n=0;n<i.length;n++)e.writeFixed32(i[n])}function VF(i,e){for(let n=0;n<i.length;n++)e.writeSFixed32(i[n])}function jF(i,e){for(let n=0;n<i.length;n++)e.writeFixed64(i[n])}function UF(i,e){for(let n=0;n<i.length;n++)e.writeSFixed64(i[n])}let Aw=3;function HF(i,e,n){e.glyphs=[],i===1&&n.readMessage($F,e)}function $F(i,e,n){if(i===3){let{id:s,bitmap:c,width:f,height:p,left:y,top:x,advance:w}=n.readMessage(GF,{});e.glyphs.push({id:s,bitmap:new Cc({width:f+2*Aw,height:p+2*Aw},c),metrics:{width:f,height:p,left:y,top:x,advance:w}})}else i===4?e.ascender=n.readSVarint():i===5&&(e.descender=n.readSVarint())}function GF(i,e,n){i===1?e.id=n.readVarint():i===2?e.bitmap=n.readBytes():i===3?e.width=n.readVarint():i===4?e.height=n.readVarint():i===5?e.left=n.readSVarint():i===6?e.top=n.readSVarint():i===7&&(e.advance=n.readVarint())}let eC=Aw,No={horizontal:1,vertical:2,horizontalOnly:3};class Xm{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,n){let s=new Xm;return s.scale=e||1,s.fontStack=n,s}static forImage(e){let n=new Xm;return n.image=e,n}}class of{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,n,s){let c=new of;for(let f=0;f<e.sections.length;f++){let p=e.sections[f];p.image?c.addImageSection(p,s):c.addTextSection(p,n)}return c}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(n,s){let c="";for(let f=0;f<n.length;f++){let p=n.charCodeAt(f+1)||null,y=n.charCodeAt(f-1)||null;c+=!s&&(p&&Oh(p)&&!Zm[n[f+1]]||y&&Oh(y)&&!Zm[n[f-1]])||!Zm[n[f]]?n[f]:Zm[n[f]]}return c}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&uv[this.text.charCodeAt(s)];s++)e++;let n=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&uv[this.text.charCodeAt(s)];s--)n--;this.text=this.text.substring(e,n),this.sectionIndex=this.sectionIndex.slice(e,n)}substring(e,n){let s=new of;return s.text=this.text.substring(e,n),s.sectionIndex=this.sectionIndex.slice(e,n),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,n)=>Math.max(e,this.sections[n].scale),0)}addTextSection(e,n){this.text+=e.text,this.sections.push(Xm.forText(e.scale,e.fontStack||n));let s=this.sections.length-1;for(let c=0;c<e.text.length;++c)this.sectionIndex.push(s)}addImageSection(e,n){let s=e.image?e.image.getPrimary():null;if(!s)return void fn("Can't add FormattedSection with an empty image.");s.scaleSelf(n);let c=this.getNextImageSectionCharCode();c?(this.text+=String.fromCodePoint(c),this.sections.push(Xm.forImage(s)),this.sectionIndex.push(this.sections.length-1)):fn("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Mw(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,F=1){let B=of.fromFeature(i,c,F);S===No.vertical&&B.verticalizePunctuation(D);let H=[],X=function(ce,ge,ye,ke,be,ze){if(!ce)return[];let et=[],Ve=function(Ze,we,Le,it,Ye,Et){let _t=0;for(let Ge=0;Ge<Ze.length();Ge++){let Ke=Ze.getSection(Ge);_t+=tC(Ze.getCodePoint(Ge),Ke,it,Ye,we,Et)}return _t/Math.max(1,Math.ceil(_t/Le))}(ce,ge,ye,ke,be,ze),We=ce.text.indexOf("\u200B")>=0,Je=0;for(let Ze=0;Ze<ce.length();Ze++){let we=ce.getSection(Ze),Le=ce.getCodePoint(Ze);if(uv[Le]||(Je+=tC(Le,we,ke,be,ge,ze)),Ze<ce.length()-1){let it=!((Oe=Le)<11904||!(Rt["Bopomofo Extended"](Oe)||Rt.Bopomofo(Oe)||Rt["CJK Compatibility Forms"](Oe)||Rt["CJK Compatibility Ideographs"](Oe)||Rt["CJK Compatibility"](Oe)||Rt["CJK Radicals Supplement"](Oe)||Rt["CJK Strokes"](Oe)||Rt["CJK Symbols and Punctuation"](Oe)||Rt["CJK Unified Ideographs Extension A"](Oe)||Rt["CJK Unified Ideographs"](Oe)||Rt["Enclosed CJK Letters and Months"](Oe)||Rt["Halfwidth and Fullwidth Forms"](Oe)||Rt.Hiragana(Oe)||Rt["Ideographic Description Characters"](Oe)||Rt["Kangxi Radicals"](Oe)||Rt["Katakana Phonetic Extensions"](Oe)||Rt.Katakana(Oe)||Rt["Vertical Forms"](Oe)||Rt["Yi Radicals"](Oe)||Rt["Yi Syllables"](Oe)));(qF[Le]||it||we.image)&&et.push(iC(Ze+1,Je,Ve,et,WF(Le,ce.getCodePoint(Ze+1),it&&We),!1))}}var Oe;return rC(iC(ce.length(),Je,Ve,et,0,!0))}(B,w,f,e,s,P),{processBidirectionalText:Z,processStyledBidirectionalText:K}=bs;if(Z&&B.sections.length===1){let ce=Z(B.toString(),X);for(let ge of ce){let ye=new of;ye.text=ge,ye.sections=B.sections;for(let ke=0;ke<ge.length;ke++)ye.sectionIndex.push(0);H.push(ye)}}else if(K){let ce=K(B.text,B.sectionIndex,X);for(let ge of ce){let ye=new of;ye.text=ge[0],ye.sectionIndex=ge[1],ye.sections=B.sections,H.push(ye)}}else H=function(ce,ge){let ye=[],ke=ce.text,be=0;for(let ze of ge)ye.push(ce.substring(be,ze)),be=ze;return be<ke.length&&ye.push(ce.substring(be,ke.length)),ye}(B,X);let de=[],ae={positionedLines:de,text:B.toString(),top:I[1],bottom:I[1],left:I[0],right:I[0],writingMode:S,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(ce,ge,ye,ke,be,ze,et,Ve,We,Je,Oe,Ze){let we=0,Le=0,it=0,Ye=Ve==="right"?1:Ve==="left"?0:.5,Et=!1;for(let at of be){let ft=at.getSections();for(let Mt of ft){if(Mt.image)continue;let Bt=ge[Mt.fontStack];if(Bt&&(Et=Bt.ascender!==void 0&&Bt.descender!==void 0,!Et))break}if(!Et)break}let _t=0;for(let at of be){at.trim();let ft=at.getMaxScale(),Mt=(ft-1)*gr,Bt={positionedGlyphs:[],lineOffset:0};ce.positionedLines[_t]=Bt;let Wt=Bt.positionedGlyphs,$t=0;if(!at.length()){Le+=ze,++_t;continue}let pn=0,nn=0;for(let Q=0;Q<at.length();Q++){let ee=at.getSection(Q),Re=at.getSectionIndex(Q),rt=at.getCodePoint(Q),ct=ee.scale,lt=null,yt=null,kt=null,ln=gr,cn=0,Jt=We;Jt===No.vertical&&((Ge=rt)===12312||Ge===12313||Ge===12316||Ge===12540||Ge===12448)&&(Jt=No.horizontal);let Hn=!(Jt===No.horizontal||!Oe&&!Ph(rt)||Oe&&(uv[rt]||vy(rt)));if(ee.image){let wi=ke.get(ee.image.toString());if(!wi)continue;kt=ee.image,ce.iconsInText=ce.iconsInText||!0,yt=wi.paddedRect;let Zt=wi.displaySize;ct=ct*gr/Ze,lt={width:Zt[0],height:Zt[1],left:0,top:-eC,advance:Hn?Zt[1]:Zt[0],localGlyph:!1},cn=Et?-lt.height*ct:ft*gr-17-Zt[1]*ct,ln=lt.advance;let ai=(Hn?Zt[0]:Zt[1])*ct-gr*ft;ai>0&&ai>$t&&($t=ai)}else{let wi=ye[ee.fontStack];if(!wi)continue;wi[rt]&&(yt=wi[rt]);let Zt=ge[ee.fontStack];if(!Zt)continue;let ai=Zt.glyphs[rt];if(!ai)continue;if(lt=ai.metrics,ln=rt!==8203?gr:0,Et){let Qn=Zt.ascender!==void 0?Math.abs(Zt.ascender):0,Fn=Zt.descender!==void 0?Math.abs(Zt.descender):0,yi=(Qn+Fn)*ct;pn<yi&&(pn=yi,nn=(Qn-Fn)/2*ct),cn=-Qn*ct}else cn=(ft-ct)*gr-17}Hn?(ce.verticalizable=!0,Wt.push({glyph:rt,image:kt,x:we,y:Le+cn,vertical:Hn,scale:ct,localGlyph:lt.localGlyph,fontStack:ee.fontStack,sectionIndex:Re,metrics:lt,rect:yt}),we+=ln*ct+Je):(Wt.push({glyph:rt,image:kt,x:we,y:Le+cn,vertical:Hn,scale:ct,localGlyph:lt.localGlyph,fontStack:ee.fontStack,sectionIndex:Re,metrics:lt,rect:yt}),we+=lt.advance*ct+Je)}Wt.length!==0&&(it=Math.max(we-Je,it),Et?oC(Wt,Ye,$t,nn,ze*ft/2):oC(Wt,Ye,$t,0,ze/2)),we=0;let ni=ze*ft+$t;Bt.lineOffset=Math.max($t,Mt),Le+=ni,++_t}var Ge;let Ke=Le,{horizontalAlign:vt,verticalAlign:ht}=Rw(et);(function(at,ft,Mt,Bt,Wt,$t){let pn=(ft-Mt)*Wt,nn=-$t*Bt;for(let ni of at)for(let Q of ni.positionedGlyphs)Q.x+=pn,Q.y+=nn})(ce.positionedLines,Ye,vt,ht,it,Ke),ce.top+=-ht*Ke,ce.bottom=ce.top+Ke,ce.left+=-vt*it,ce.right=ce.left+it,ce.hasBaseline=Et}(ae,e,n,s,H,p,y,x,S,w,D,O),!function(ce){for(let ge of ce)if(ge.positionedGlyphs.length!==0)return!1;return!0}(de))return ae}let uv={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},qF={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function tC(i,e,n,s,c,f){if(e.image){let p=s.get(e.image.toString());return p?p.displaySize[0]*e.scale*gr/f+c:0}{let p=n[e.fontStack],y=p&&p.glyphs[i];return y?y.metrics.advance*e.scale+c:0}}function nC(i,e,n,s){let c=Math.pow(i-e,2);return s?i<e?c/2:2*c:c+Math.abs(n)*n}function WF(i,e,n){let s=0;return i===10&&(s-=1e4),n&&(s+=150),i!==40&&i!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function iC(i,e,n,s,c,f){let p=null,y=nC(e,n,c,f);for(let x of s){let w=nC(e-x.x,n,c,f)+x.badness;w<=y&&(p=x,y=w)}return{index:i,x:e,priorBreak:p,badness:y}}function rC(i){return i?rC(i.priorBreak).concat(i.index):[]}function Rw(i){let e=.5,n=.5;switch(i){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:e,verticalAlign:n}}function oC(i,e,n,s,c){if(!(e||n||s||c))return;let f=i.length-1,p=i[f],y=(p.x+p.metrics.advance*p.scale)*e;for(let x=0;x<=f;x++)i[x].x-=y,i[x].y+=n+s+c}function sC(i){return i.imagePrimary!==void 0&&i.top!==void 0&&i.bottom!==void 0&&i.left!==void 0&&i.right!==void 0}function ZF(i,e,n,s){let{horizontalAlign:c,verticalAlign:f}=Rw(s),p=n[0]-i.displaySize[0]*c,y=n[1]-i.displaySize[1]*f;return{imagePrimary:i,imageSecondary:e,top:y,bottom:y+i.displaySize[1],left:p,right:p+i.displaySize[0]}}function aC(i,e,n,s,c,f){let p=i.imagePrimary,y;if(p.content){let B=p.content,H=p.pixelRatio||1;y=[B[0]/H,B[1]/H,p.displaySize[0]-B[2]/H,p.displaySize[1]-B[3]/H]}let x=e.left*f,w=e.right*f,I,S,D,P;n==="width"||n==="both"?(P=c[0]+x-s[3],S=c[0]+w+s[1]):(P=c[0]+(x+w-p.displaySize[0])/2,S=P+p.displaySize[0]);let O=e.top*f,F=e.bottom*f;return n==="height"||n==="both"?(I=c[1]+O-s[0],D=c[1]+F+s[2]):(I=c[1]+(O+F-p.displaySize[1])/2,D=I+p.displaySize[1]),{imagePrimary:p,imageSecondary:void 0,top:I,right:S,bottom:D,left:P,collisionPadding:y}}function lC(i){return!i.imagePrimary.stretchX}function cC(i){return!i.imagePrimary.stretchY}function uC(i){return{width:i.right-i.left,height:i.bottom-i.top}}let Fa=128;function dC(i,e,n){let{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new Un(i+1,{worldview:n}))};if(s.kind==="source")return{kind:"source"};{let{zoomStops:c,interpolationType:f}=s,p=0;for(;p<c.length&&c[p]<=i;)p++;p=Math.max(0,p-1);let y=p;for(;y<c.length&&c[y]<i+1;)y++;y=Math.min(c.length-1,y);let x=c[p],w=c[y];return s.kind==="composite"?{kind:"composite",minZoom:x,maxZoom:w,interpolationType:f}:{kind:"camera",minZoom:x,maxZoom:w,minSize:s.evaluate(new Un(x,{worldview:n})),maxSize:s.evaluate(new Un(w,{worldview:n})),interpolationType:f}}}function Pw(i,{uSize:e,uSizeT:n},{lowerSize:s,upperSize:c}){return i.kind==="source"?s/Fa:i.kind==="composite"?Ct(s/Fa,c/Fa,n):e}function Ym(i,e,n=1){let s=0,c=0;if(i.kind==="constant")c=i.layoutSize*n;else if(i.kind!=="source"){let{interpolationType:f,minZoom:p,maxZoom:y}=i,x=f?ne(no.interpolationFactor(f,e,p,y),0,1):0;i.kind==="camera"?c=Ct(i.minSize,i.maxSize,x)*n:s=x*n}return{uSizeT:s,uSize:c}}class xl extends Xe{constructor(e,n,s,c,f){super(e,n),this.angle=c,this.z=s,f!==void 0&&(this.segment=f)}clone(){return new xl(this.x,this.y,this.z,this.angle,this.segment)}}function hC(i,e,n,s,c){if(e.segment===void 0)return!0;let f=e,p=e.segment+1,y=0;for(;y>-n/2;){if(p--,p<0)return!1;y-=i[p].dist(f),f=i[p]}y+=i[p].dist(i[p+1]),p++;let x=[],w=0;for(;y<n/2;){let I=i[p],S=i[p+1];if(!S)return!1;let D=i[p-1].angleTo(I)-I.angleTo(S);for(D=Math.abs((D+3*Math.PI)%(2*Math.PI)-Math.PI),x.push({distance:y,angleDelta:D}),w+=D;y-x[0].distance>s;)w-=x.shift().angleDelta;if(w>c)return!1;p++,y+=I.dist(S)}return!0}function fC(i){let e=0;for(let n=0;n<i.length-1;n++)e+=i[n].dist(i[n+1]);return e}function pC(i,e,n){return i?.6*e*n:0}function mC(i,e){return Math.max(i?i.right-i.left:0,e?e.right-e.left:0)}function XF(i,e,n,s,c,f){let p=pC(n,c,f),y=mC(n,s)*f,x=0,w=fC(i)/2;for(let I=0;I<i.length-1;I++){let S=i[I],D=i[I+1],P=S.dist(D);if(x+P>w){let O=(w-x)/P,F=Ct(S.x,D.x,O),B=Ct(S.y,D.y,O),H=new xl(F,B,0,D.angleTo(S),I);return!p||hC(i,H,y,p,e)?H:void 0}x+=P}}function YF(i,e,n,s,c,f,p,y,x){let w=pC(s,f,p),I=mC(s,c),S=I*p,D=i[0].x===0||i[0].x===x||i[0].y===0||i[0].y===x;return e-S<e/4&&(e=S+e/4),gC(i,D?e/2*y%e:(I/2+2*f)*p*y%e,e,w,n,S,D,!1,x)}function gC(i,e,n,s,c,f,p,y,x){let w=f/2,I=fC(i),S=0,D=e-n,P=[];for(let O=0;O<i.length-1;O++){let F=i[O],B=i[O+1],H=F.dist(B),X=B.angleTo(F);for(;D+n<S+H;){D+=n;let Z=(D-S)/H,K=Ct(F.x,B.x,Z),de=Ct(F.y,B.y,Z);if(K>=0&&K<x&&de>=0&&de<x&&D-w>=0&&D+w<=I){let ae=new xl(K,de,0,X,O);s&&!hC(i,ae,f,s,c)||P.push(ae)}}S+=H}return y||P.length||p||(P=gC(i,S/2,n,s,c,f,p,!0,x)),P}function _C(i){let e=0,n=0;for(let p of i)e+=p.w*p.h,n=Math.max(n,p.w);i.sort((p,y)=>y.h-p.h);let s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),n),h:1/0}],c=0,f=0;for(let p of i)for(let y=s.length-1;y>=0;y--){let x=s[y];if(!(p.w>x.w||p.h>x.h)){if(p.x=x.x,p.y=x.y,f=Math.max(f,p.y+p.h),c=Math.max(c,p.x+p.w),p.w===x.w&&p.h===x.h){let w=s.pop();w&&y<s.length&&(s[y]=w)}else p.h===x.h?(x.x+=p.w,x.w-=p.w):p.w===x.w?(x.y+=p.h,x.h-=p.h):(s.push({x:x.x+p.w,y:x.y,w:x.w-p.w,h:p.h}),x.y+=p.h,x.h-=p.h);break}}return{w:c,h:f,fill:e/(c*f)||0}}gt(xl,"Anchor");let sd=1;class Km{static getImagePositionScale(e,n,s){if(n&&e&&e.options&&e.options.transform){let c=e.options.transform;return{x:c.a,y:c.d}}return{x:s,y:s}}constructor(e,n,s,c){this.paddedRect=e;let{pixelRatio:f,version:p,stretchX:y,stretchY:x,content:w,sdf:I,usvg:S}=n;this.pixelRatio=f,this.stretchX=y,this.stretchY=x,this.content=w,this.version=p,this.padding=s,this.sdf=I,this.usvg=S,this.scale=Km.getImagePositionScale(c,S,f)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function Ow(i,e,n){let s=Hs.parse(i),c=function(f,p,y=[1,1]){return{x:0,y:0,w:(f.data?f.data.width:f.width*y[0])+2*p,h:(f.data?f.data.height:f.height*y[1])+2*p}}(e,n,[s.options.transform.a,s.options.transform.d]);return{bin:c,imagePosition:new Km(c,e,n,s),imageVariant:s}}class yC{constructor(e,n,s){let c=new Map,f=new Map;this.haveRenderCallbacks=[];let p=[];this.addImages(e,c,sd,p),this.addImages(n,f,2,p);let{w:y,h:x}=_C(p),w=new Sr({width:y||1,height:x||1});for(let[I,S]of e.entries()){let D=c.get(I).paddedRect;Sr.copy(S.data,w,{x:0,y:0},{x:D.x+sd,y:D.y+sd},S.data,s,S.sdf)}for(let[I,S]of n.entries()){let D=f.get(I),P=D.paddedRect,O=D.padding,F=P.x+O,B=P.y+O,H=S.data.width,X=S.data.height;O=O>1?O-1:O,Sr.copy(S.data,w,{x:0,y:0},{x:F,y:B},S.data,s),Sr.copy(S.data,w,{x:0,y:X-O},{x:F,y:B-O},{width:H,height:O},s),Sr.copy(S.data,w,{x:0,y:0},{x:F,y:B+X},{width:H,height:O},s),Sr.copy(S.data,w,{x:H-O,y:0},{x:F-O,y:B},{width:O,height:X},s),Sr.copy(S.data,w,{x:0,y:0},{x:F+H,y:B},{width:O,height:X},s),Sr.copy(S.data,w,{x:H-O,y:X-O},{x:F-O,y:B-O},{width:O,height:O},s),Sr.copy(S.data,w,{x:0,y:X-O},{x:F+H,y:B-O},{width:O,height:O},s),Sr.copy(S.data,w,{x:0,y:0},{x:F+H,y:B+X},{width:O,height:O},s),Sr.copy(S.data,w,{x:H-O,y:0},{x:F-O,y:B+X},{width:O,height:O},s)}this.lut=s,this.image=w,this.iconPositions=c,this.patternPositions=f}addImages(e,n,s,c){for(let[f,p]of e.entries()){let{bin:y,imagePosition:x,imageVariant:w}=Ow(f,p,s);n.set(f,x),c.push(y),p.hasRenderCallback&&this.haveRenderCallbacks.push(w.id)}}patchUpdatedImages(e,n,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(c=>e.hasImage(c,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(let c of e.getUpdatedImages(s)){for(let f of this.iconPositions.keys()){let p=Hs.parse(f);if(uo.isEqual(p.id,c)){let y=e.getImage(c,s);this.patchUpdatedImage(this.iconPositions.get(f),y,n)}}for(let f of this.patternPositions.keys()){let p=Hs.parse(f);if(uo.isEqual(p.id,c)){let y=e.getImage(c,s);this.patchUpdatedImage(this.patternPositions.get(f),y,n)}}}}patchUpdatedImage(e,n,s){if(!e||!n||e.version===n.version)return;e.version=n.version;let[c,f]=e.tl,p=e.sdf;if(this.lut||p){let y={width:n.data.width,height:n.data.height},x=new Sr(y);Sr.copy(n.data,x,{x:0,y:0},{x:0,y:0},y,this.lut,p),s.update(x,{position:{x:c,y:f}})}else s.update(n.data,{position:{x:c,y:f}})}}gt(Km,"ImagePosition"),gt(yC,"ImageAtlas");let Jm=1e20;function vC(i,e,n,s,c,f,p,y,x){for(let w=e;w<e+s;w++)xC(i,n*f+w,f,c,p,y,x);for(let w=n;w<n+c;w++)xC(i,w*f+e,1,s,p,y,x)}function xC(i,e,n,s,c,f,p){f[0]=0,p[0]=-Jm,p[1]=Jm,c[0]=i[e];for(let y=1,x=0,w=0;y<s;y++){c[y]=i[e+y*n];let I=y*y;do{let S=f[x];w=(c[y]-c[S]+I-S*S)/(y-S)/2}while(w<=p[x]&&--x>-1);x++,f[x]=y,p[x]=w,p[x+1]=Jm}for(let y=0,x=0;y<s;y++){for(;p[x+1]<y;)x++;let w=f[x],I=y-w;i[e+y*n]=c[w]+I*I}}let Ws=2,Lw={none:0,ideographs:1,all:2};class sf{constructor(e,n,s){this.requestManager=e,this.localGlyphMode=n,this.localFontFamily=s,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,n){let s=[],c=this.url||vr.GLYPHS_URL;for(let f in e)for(let p of e[f])s.push({stack:f,id:p});ve(s,({stack:f,id:p},y)=>{let x=this.entries[f];x||(x=this.entries[f]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let w=x.glyphs[p];if(w!==void 0)return void y(null,{stack:f,id:p,glyph:w});if(w=this._tinySDF(x,f,p),w)return x.glyphs[p]=w,void y(null,{stack:f,id:p,glyph:w});let I=Math.floor(p/256);if(256*I>65535)return fn("glyphs > 65535 not supported"),void y(null,{stack:f,id:p,glyph:w});if(x.ranges[I])return void y(null,{stack:f,id:p,glyph:w});let S=x.requests[I];S||(S=x.requests[I]=[],sf.loadGlyphRange(f,I,c,this.requestManager,(D,P)=>{if(P){x.ascender=P.ascender,x.descender=P.descender;for(let O in P.glyphs)this._doesCharSupportLocalGlyph(+O)||(x.glyphs[+O]=P.glyphs[+O]);x.ranges[I]=!0}for(let O of S)O(D,P);delete x.requests[I]})),S.push((D,P)=>{D?y(D):P&&y(null,{stack:f,id:p,glyph:P.glyphs[p]||null})})},(f,p)=>{if(f)n(f);else if(p){let y={};for(let{stack:x,id:w,glyph:I}of p)y[x]===void 0&&(y[x]={}),y[x].glyphs===void 0&&(y[x].glyphs={}),y[x].glyphs[w]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},y[x].ascender=this.entries[x].ascender,y[x].descender=this.entries[x].descender;n(null,y)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Lw.none&&(this.localGlyphMode===Lw.all?!!this.localFontFamily:!!this.localFontFamily&&(Rt["CJK Unified Ideographs"](e)||Rt["Hangul Syllables"](e)||Rt.Hiragana(e)||Rt.Katakana(e)||Rt["CJK Symbols and Punctuation"](e)||Rt["CJK Unified Ideographs Extension A"](e)||Rt["CJK Unified Ideographs Extension B"](e)||Rt.Osage(e)))}_tinySDF(e,n,s){let c=this.localFontFamily;if(!c||!this._doesCharSupportLocalGlyph(s))return;let f=e.tinySDF;if(!f){let F="400";/bold/i.test(n)?F="900":/medium/i.test(n)?F="500":/light/i.test(n)&&(F="200"),f=e.tinySDF=new sf.TinySDF({fontFamily:c,fontWeight:F,fontSize:24*Ws,buffer:3*Ws,radius:8*Ws}),f.fontWeight=F}if(this.localGlyphs[f.fontWeight][s])return this.localGlyphs[f.fontWeight][s];let p=String.fromCodePoint(s),{data:y,width:x,height:w,glyphWidth:I,glyphHeight:S,glyphLeft:D,glyphTop:P,glyphAdvance:O}=f.draw(p);return this.localGlyphs[f.fontWeight][s]={id:s,bitmap:new Cc({width:x,height:w},y),metrics:{width:I/Ws,height:S/Ws,left:D/Ws,top:P/Ws-27,advance:O/Ws,localGlyph:!0}}}}sf.loadGlyphRange=function(i,e,n,s,c){let f=256*e,p=f+255,y=s.transformRequest(s.normalizeGlyphsURL(n).replace("{fontstack}",i).replace("{range}",`${f}-${p}`),vu.Glyphs);xu(y,(x,w)=>{if(x)c(x);else if(w){let I={},S=function(D){return new cv(D).readFields(HF,{})}(w);for(let D of S.glyphs)I[D.id]=D;c(null,{glyphs:I,ascender:S.ascender,descender:S.descender})}})},sf.TinySDF=class{constructor({fontSize:i=24,buffer:e=3,radius:n=8,cutoff:s=.25,fontFamily:c="sans-serif",fontWeight:f="normal",fontStyle:p="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=n;let y=this.size=i+4*e,x=this._createCanvas(y),w=this.ctx=x.getContext("2d",{willReadFrequently:!0});w.font=`${p} ${f} ${i}px ${c}`,w.textBaseline="alphabetic",w.textAlign="left",w.fillStyle="black",this.gridOuter=new Float64Array(y*y),this.gridInner=new Float64Array(y*y),this.f=new Float64Array(y),this.z=new Float64Array(y+1),this.v=new Uint16Array(y)}_createCanvas(i){let e=document.createElement("canvas");return e.width=e.height=i,e}draw(i){let{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:s,actualBoundingBoxLeft:c,actualBoundingBoxRight:f}=this.ctx.measureText(i),p=Math.ceil(n),y=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(f-c))),x=Math.min(this.size-this.buffer,p+Math.ceil(s)),w=y+2*this.buffer,I=x+2*this.buffer,S=Math.max(w*I,0),D=new Uint8ClampedArray(S),P={data:D,width:w,height:I,glyphWidth:y,glyphHeight:x,glyphTop:p,glyphLeft:0,glyphAdvance:e};if(y===0||x===0)return P;let{ctx:O,buffer:F,gridInner:B,gridOuter:H}=this;O.clearRect(F,F,y,x),O.fillText(i,F,F+p);let X=O.getImageData(F,F,y,x);H.fill(Jm,0,S),B.fill(0,0,S);for(let Z=0;Z<x;Z++)for(let K=0;K<y;K++){let de=X.data[4*(Z*y+K)+3]/255;if(de===0)continue;let ae=(Z+F)*w+K+F;if(de===1)H[ae]=0,B[ae]=Jm;else{let ce=.5-de;H[ae]=ce>0?ce*ce:0,B[ae]=ce<0?ce*ce:0}}vC(H,0,0,w,I,w,this.f,this.v,this.z),vC(B,F,F,y,x,w,this.f,this.v,this.z);for(let Z=0;Z<S;Z++){let K=Math.sqrt(H[Z])-Math.sqrt(B[Z]);D[Z]=Math.round(255-255*(K/this.radius+this.cutoff))}return P}};let Rc=sd;function bC(i,e){return i+e[1]-e[0]}function wC(i,e,n,s,c=1){let f=[],p=i.imagePrimary,y=p.pixelRatio,x=p.paddedRect.w-2*Rc,w=p.paddedRect.h-2*Rc,I=(i.right-i.left)*c,S=(i.bottom-i.top)*c,D=p.stretchX||[[0,x]],P=p.stretchY||[[0,w]],O=D.reduce(bC,0),F=P.reduce(bC,0),B=x-O,H=w-F,X=0,Z=O,K=0,de=F,ae=0,ce=B,ge=0,ye=H;if(p.content&&s){let be=p.content;X=dv(D,0,be[0]),K=dv(P,0,be[1]),Z=dv(D,be[0],be[2]),de=dv(P,be[1],be[3]),ae=be[0]-X,ge=be[1]-K,ce=be[2]-be[0]-Z,ye=be[3]-be[1]-de}let ke=(be,ze,et,Ve)=>{let We=hv(be.stretch-X,Z,I,i.left*c),Je=fv(be.fixed-ae,ce,be.stretch,O),Oe=hv(ze.stretch-K,de,S,i.top*c),Ze=fv(ze.fixed-ge,ye,ze.stretch,F),we=hv(et.stretch-X,Z,I,i.left*c),Le=fv(et.fixed-ae,ce,et.stretch,O),it=hv(Ve.stretch-K,de,S,i.top*c),Ye=fv(Ve.fixed-ge,ye,Ve.stretch,F),Et=new Xe(We,Oe),_t=new Xe(we,Oe),Ge=new Xe(we,it),Ke=new Xe(We,it),vt=new Xe(Je/y,Ze/y),ht=new Xe(Le/y,Ye/y),at=e*Math.PI/180;if(at){let pn=Math.sin(at),nn=Math.cos(at),ni=[nn,-pn,pn,nn];Et._matMult(ni),_t._matMult(ni),Ke._matMult(ni),Ge._matMult(ni)}let ft=be.stretch+be.fixed,Mt=et.stretch+et.fixed,Bt=ze.stretch+ze.fixed,Wt=Ve.stretch+Ve.fixed,$t=i.imageSecondary;return{tl:Et,tr:_t,bl:Ke,br:Ge,texPrimary:{x:p.paddedRect.x+Rc+ft,y:p.paddedRect.y+Rc+Bt,w:Mt-ft,h:Wt-Bt},texSecondary:$t?{x:$t.paddedRect.x+Rc+ft,y:$t.paddedRect.y+Rc+Bt,w:Mt-ft,h:Wt-Bt}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:vt,pixelOffsetBR:ht,minFontScaleX:ce/y/I,minFontScaleY:ye/y/S,isSDF:n}};if(s&&(p.stretchX||p.stretchY)){let be=EC(D,B,O),ze=EC(P,H,F);for(let et=0;et<be.length-1;et++){let Ve=be[et],We=be[et+1];for(let Je=0;Je<ze.length-1;Je++)f.push(ke(Ve,ze[Je],We,ze[Je+1]))}}else f.push(ke({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:x+1},{fixed:0,stretch:w+1}));return f}function dv(i,e,n){let s=0;for(let c of i)s+=Math.max(e,Math.min(n,c[1]))-Math.max(e,Math.min(n,c[0]));return s}function EC(i,e,n){let s=[{fixed:-Rc,stretch:0}];for(let[c,f]of i){let p=s[s.length-1];s.push({fixed:c-p.stretch,stretch:p.stretch}),s.push({fixed:c-p.stretch,stretch:p.stretch+(f-c)})}return s.push({fixed:e+Rc,stretch:n}),s}function hv(i,e,n,s){return i/e*n+s}function fv(i,e,n,s){return i-e*n/s}function KF(i,e,n,s){let c=e+i.positionedLines[s].lineOffset;return s===0?n+c/2:n+(c+(e+i.positionedLines[s-1].lineOffset))/2}function JF(i,e=1,n=!1){let s=1/0,c=1/0,f=-1/0,p=-1/0,y=i[0];for(let P=0;P<y.length;P++){let O=y[P];(!P||O.x<s)&&(s=O.x),(!P||O.y<c)&&(c=O.y),(!P||O.x>f)&&(f=O.x),(!P||O.y>p)&&(p=O.y)}let x=Math.min(f-s,p-c),w=x/2,I=new ah([],QF);if(x===0)return new Xe(s,c);for(let P=s;P<f;P+=x)for(let O=c;O<p;O+=x)I.push(new af(P+w,O+w,w,i));let S=function(P){let O=0,F=0,B=0,H=P[0];for(let X=0,Z=H.length,K=Z-1;X<Z;K=X++){let de=H[X],ae=H[K],ce=de.x*ae.y-ae.x*de.y;F+=(de.x+ae.x)*ce,B+=(de.y+ae.y)*ce,O+=3*ce}return new af(F/O,B/O,0,P)}(i),D=I.length;for(;I.length;){let P=I.pop();(P.d>S.d||!S.d)&&(S=P,n&&console.log("found best %d after %d probes",Math.round(1e4*P.d)/1e4,D)),P.max-S.d<=e||(w=P.h/2,I.push(new af(P.p.x-w,P.p.y-w,w,i)),I.push(new af(P.p.x+w,P.p.y-w,w,i)),I.push(new af(P.p.x-w,P.p.y+w,w,i)),I.push(new af(P.p.x+w,P.p.y+w,w,i)),D+=4)}return n&&(console.log(`num probes: ${D}`),console.log(`best distance: ${S.d}`)),S.p}function QF(i,e){return e.max-i.max}class af{constructor(e,n,s,c){this.p=new Xe(e,n),this.h=s,this.d=function(f,p){let y=!1,x=1/0;for(let w=0;w<p.length;w++){let I=p[w];for(let S=0,D=I.length,P=D-1;S<D;P=S++){let O=I[S],F=I[P];O.y>f.y!=F.y>f.y&&f.x<(F.x-O.x)*(f.y-O.y)/(F.y-O.y)+O.x&&(y=!y),x=Math.min(x,Po(f,O,F))}}return(y?1:-1)*Math.sqrt(x)}(this.p,c),this.max=this.d+this.h*Math.SQRT2}}let eN=Object.keys,kw=Number.POSITIVE_INFINITY,tN=Math.sqrt(2);function TC(i,[e,n]){let s=0,c=0;if(n===kw){e<0&&(e=0);let f=e/tN;switch(i){case"top-right":case"top-left":c=f-7;break;case"bottom-right":case"bottom-left":c=7-f;break;case"bottom":c=7-e;break;case"top":c=e-7}switch(i){case"top-right":case"bottom-right":s=-f;break;case"top-left":case"bottom-left":s=f;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),n=Math.abs(n),i){case"top-right":case"top-left":case"top":c=n-7;break;case"bottom-right":case"bottom-left":case"bottom":c=7-n}switch(i){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,c]}function pv(i,e,n,s,c,f,p,y,x){if(!e||!e.usvg)return;let w=uC(s),I=uC(c),S=f!=="both"&&f!=="width"||!lC(s)?1:I.width/w.width,D=f!=="both"&&f!=="height"||!cC(s)?1:I.height/w.height;n.scaleSelf(S,D);let P=n.toString();p.set(P,n),y.set(P,e);let{imagePosition:O}=Ow(P,e,sd);x.set(P,O)}function IC(i,e,n,s,c,f,p,y,x){if(!i)return;let w=function(I,S,D,P,O,F){if(I.kind==="camera")return I.maxSize;if(I.kind==="composite"){let B=S.possiblyEvaluate(new Un(I.maxZoom,{worldview:F}),D).evaluate(O,{},D),H=S.possiblyEvaluate(new Un(I.minZoom,{worldview:F}),D).evaluate(O,{},D);return Math.max(B,H)}return S.possiblyEvaluate(new Un(P,{worldview:F})).evaluate(O,{},D)}(e,n,s,c,f,x);return i.scaleSelf(w*y*p)}function SC(i,e,n,s,c,f,p,y,x){return{iconPrimary:IC(i.getPrimary(),e,n,s,c,f,p,y,x),iconSecondary:IC(i.getSecondary(),e,n,s,c,f,p,y,x)}}function nN(i,e,n){if(!e)return;let s=n.get(i.toString()),c=n.get(e.toString());c&&(s.paddedRect.w===c.paddedRect.w&&s.paddedRect.h===c.paddedRect.h||fn(`Mismatch in icon variant sizes: ${i.toString()} and ${e.toString()}`),s.usvg!==c.usvg&&fn(`Mismatch in icon variant image types: ${i.id} and ${e.id}`))}function DC(i,e,n,s){if(!i)return;let c=e.get(n.toString());if(i.imagePrimary=c,s){let f=e.get(s.toString());i.imageSecondary=f}}function iN(i,e){for(let n in i.horizontal)CC(i.horizontal[n],e);CC(i.vertical,e)}function CC(i,e){if(i){for(let n of i.positionedLines)for(let s of n.positionedGlyphs)if(s.image!==null){let c=s.image.toString();s.rect=e.get(c).paddedRect}}}function Fw(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function rN(i,e,n,s,c,f,p,y,x){let w=Nw(f.horizontal)||f.vertical,I=n.get("icon-text-fit-padding").evaluate(s,{},c),S,D=e;return e&&x!=="none"&&(i.allowVerticalPlacement&&f.vertical&&(S=aC(e,f.vertical,x,I,y,p)),w&&(D=aC(e,w,x,I,y,p))),{defaultShapedIcon:D,verticallyShapedIcon:S}}function oN(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H,X,Z){let K=p.textMaxSize.evaluate(e,{},D);K===void 0?K=y*p.textScaleFactor:K*=p.textScaleFactor;let de=i.layers[0].layout,ae=Nw(n.horizontal)||n.vertical,ce=P.name==="globe",ge=gr,ye=i.tilePixelRatio*K/ge,ke=(Je=i.overscaling,i.zoom>18&&Je>2&&(Je>>=1),Math.max(st/(512*Je),1)*de.get("symbol-spacing")),be=de.get("text-padding")*i.tilePixelRatio,ze=de.get("icon-padding")*i.tilePixelRatio,et=Sn(de.get("text-max-angle")),Ve=de.get("icon-rotation-alignment")==="map"&&Z!=="point",We=ke/2;var Je;i.hasAnyIconTextFit===!1&&B!=="none"&&(i.hasAnyIconTextFit=!0);let Oe=e.properties?+e.properties[dt]:null,Ze=Oe&&i.elevationFeatureIdToIndex?i.elevationFeatureIdToIndex.get(Oe):65535,we=(Le,it,Ye)=>{if(it.x<0||it.x>=st||it.y<0||it.y>=st)return;let Et=null;if(ce){let{x:_t,y:Ge,z:Ke}=P.projectTilePoint(it.x,it.y,Ye);Et={anchor:new xl(_t,Ge,Ke,0,void 0),up:P.upVector(Ye,it.x,it.y)}}(function(_t,Ge,Ke,vt,ht,at,ft,Mt,Bt,Wt,$t,pn,nn,ni,Q,ee,Re,rt,ct,lt,yt,kt,ln,cn,Jt,Hn,wi,Zt,ai){let Qn=_t.addToLineVertexArray(Ge,vt),Fn,yi,ii,ei,ti,Bn,Qt,$n=0,vi=0,Ot=0,_n=0,ri=-1,Di=-1,li={},tr=Zl(""),Wn=Ke?Ke.anchor:Ge,Yi=Zt!=="none",mo=0,Dr=0;if(Bt._unevaluatedLayout.getValue("text-radial-offset")===void 0){let nr=Bt.layout.get("text-offset").evaluate(yt,{},Jt);mo=nr[0]*gr,Dr=nr[1]*gr}else mo=Bt.layout.get("text-radial-offset").evaluate(yt,{},Jt)*gr,Dr=kw;if(_t.allowVerticalPlacement&&ht.vertical){let nr=ht.vertical;if(Q)Bn=zw(nr),Mt&&(Qt=zw(Mt));else{let sr=Bt.layout.get("text-rotate").evaluate(yt,{},Jt)+90;ii=mv(Wt,Wn,Ge,$t,pn,nn,nr,ni,sr,ee),Mt&&(ei=mv(Wt,Wn,Ge,$t,pn,nn,Mt,rt,sr))}}if(at){let nr=_t.iconSizeData,sr=Bt.layout.get("icon-rotate").evaluate(yt,{},Jt),Cr=wC(at,sr,ln,Yi,kt.iconScaleFactor),$r=Mt?wC(Mt,sr,ln,Yi,kt.iconScaleFactor):void 0;yi=mv(Wt,Wn,Ge,$t,pn,nn,at,rt,sr,null),$n=4*Cr.length;let Fr=null;nr.kind==="source"?(Fr=[Fa*Bt.layout.get("icon-size").evaluate(yt,{},Jt)*kt.iconScaleFactor],Fr[0]>Pc&&fn(`${_t.layerIds[0]}: Value for "icon-size" is >= ${Qm}. Reduce your "icon-size".`)):nr.kind==="composite"&&(Fr=[Fa*kt.compositeIconSizes[0].evaluate(yt,{},Jt)*kt.iconScaleFactor,Fa*kt.compositeIconSizes[1].evaluate(yt,{},Jt)*kt.iconScaleFactor],(Fr[0]>Pc||Fr[1]>Pc)&&fn(`${_t.layerIds[0]}: Value for "icon-size" is >= ${Qm}. Reduce your "icon-size".`)),_t.addSymbols(_t.icon,Cr,Fr,lt,ct,yt,void 0,Ke,Ge,Qn.lineStartIndex,Qn.lineLength,-1,cn,Jt,Hn,wi),ri=_t.icon.placedSymbolArray.length-1,$r&&(vi=4*$r.length,_t.addSymbols(_t.icon,$r,Fr,lt,ct,yt,No.vertical,Ke,Ge,Qn.lineStartIndex,Qn.lineLength,-1,cn,Jt,Hn,wi),Di=_t.icon.placedSymbolArray.length-1)}for(let nr in ht.horizontal){let sr=nr,Cr=ht.horizontal[sr];Fn||(tr=Zl(Cr.text),Q?ti=zw(Cr):Fn=mv(Wt,Wn,Ge,$t,pn,nn,Cr,ni,Bt.layout.get("text-rotate").evaluate(yt,{},Jt),ee));let $r=Cr.positionedLines.length===1;if(Ot+=AC(_t,Ke,Ge,Cr,ft,Bt,Q,yt,ee,Qn,ht.vertical?No.horizontal:No.horizontalOnly,$r?eN(ht.horizontal):[sr],li,ri,kt,cn,Jt,Hn),$r)break}ht.vertical&&(_n+=AC(_t,Ke,Ge,ht.vertical,ft,Bt,Q,yt,ee,Qn,No.vertical,["vertical"],li,Di,kt,cn,Jt,Hn));let xr=-1,go=(nr,sr)=>nr?Math.max(nr,sr):sr;xr=go(ti,xr),xr=go(Bn,xr),xr=go(Qt,xr);let Na=xr>-1?1:0;_t.glyphOffsetArray.length>=65535&&fn("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),yt.sortKey!==void 0&&_t.addToSortKeyRanges(_t.symbolInstances.length,yt.sortKey),_t.symbolInstances.emplaceBack(Ge.x,Ge.y,Wn.x,Wn.y,Wn.z,li.right>=0?li.right:-1,li.center>=0?li.center:-1,li.left>=0?li.left:-1,li.vertical>=0?li.vertical:-1,ri,Di,tr,Fn!==void 0?Fn:_t.collisionBoxArray.length,Fn!==void 0?Fn+1:_t.collisionBoxArray.length,ii!==void 0?ii:_t.collisionBoxArray.length,ii!==void 0?ii+1:_t.collisionBoxArray.length,yi!==void 0?yi:_t.collisionBoxArray.length,yi!==void 0?yi+1:_t.collisionBoxArray.length,ei||_t.collisionBoxArray.length,ei?ei+1:_t.collisionBoxArray.length,$t,Ot,_n,$n,vi,Na,0,mo,Dr,xr,0,Yi?1:0,ai)})(i,it,Et,Le,n,s,f,c,i.layers[0],i.collisionBoxArray,e.index,e.sourceLayerIndex,i.index,be,X,w,0,ze,Ve,H,e,p,I,S,D,O,F,B,Ze)};if(Z==="line")for(let Le of ev(e.geometry,0,0,st,st)){let it=YF(Le,ke,et,n.vertical||ae,s,ge,ye,i.overscaling,st);for(let Ye of it)ae&&sN(i,ae.text,We,Ye)||we(Le,Ye,D)}else if(Z==="line-center"){for(let Le of e.geometry)if(Le.length>1){let it=XF(Le,et,n.vertical||ae,s,ge,ye);it&&we(Le,it,D)}}else if(e.type==="Polygon")for(let Le of km(e.geometry,0)){let it=JF(Le,16);we(Le[0],new xl(it.x,it.y,0,0,void 0),D)}else if(e.type==="LineString")for(let Le of e.geometry)we(Le,new xl(Le[0].x,Le[0].y,0,0,void 0),D);else if(e.type==="Point")for(let Le of e.geometry)for(let it of Le)we([it],new xl(it.x,it.y,0,0,void 0),D)}let Qm=255,Pc=Qm*Fa;function AC(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B,H){let X=function(de,ae,ce,ge,ye,ke,be,ze){let et=[];if(ae.positionedLines.length===0)return et;let Ve=ge.layout.get("text-rotate").evaluate(ke,{})*Math.PI/180,We=function(Le){let it=Le[0],Ye=Le[1],Et=it*Ye;return Et>0?[it,-Ye]:Et<0?[-it,Ye]:it===0?[Ye,it]:[Ye,-it]}(ce),Je=Math.abs(ae.top-ae.bottom);for(let Le of ae.positionedLines)Je-=Le.lineOffset;let Oe=ae.positionedLines.length,Ze=Je/Oe,we=ae.top-ce[1];for(let Le=0;Le<Oe;++Le){let it=ae.positionedLines[Le];we=KF(ae,Ze,we,Le);for(let Ye of it.positionedGlyphs){if(!Ye.rect)continue;let Et=Ye.rect||{},_t=eC+1,Ge=!0,Ke=1,vt=0;if(Ye.image){let yt=be.get(Ye.image.toString());if(!yt)continue;if(yt.sdf){fn("SDF images are not supported in formatted text and will be ignored.");continue}Ge=!1,Ke=yt.pixelRatio,_t=sd/Ke}let ht=(ye||ze)&&Ye.vertical,at=Ye.metrics.advance*Ye.scale/2,ft=Ye.metrics,Mt=Ye.rect;if(Mt===null)continue;ze&&ae.verticalizable&&(vt=Ye.image?at-Ye.metrics.width*Ye.scale/2:0);let Bt=ye?[Ye.x+at,Ye.y]:[0,0],Wt=[0,0],$t=[0,0],pn=!1;ye||(ht?($t=[Ye.x+at+We[0],Ye.y+We[1]-vt],pn=!0):Wt=[Ye.x+at+ce[0],Ye.y+ce[1]-vt]);let nn=Mt.w*Ye.scale/(Ke*(Ye.localGlyph?Ws:1)),ni=Mt.h*Ye.scale/(Ke*(Ye.localGlyph?Ws:1)),Q,ee,Re,rt;if(ht){let yt=Ye.y-we,kt=new Xe(-at,at-yt),ln=-Math.PI/2,cn=new Xe(...$t);Q=new Xe(-at+Wt[0],Wt[1]),Q._rotateAround(ln,kt)._add(cn),Q.x+=-yt+at,Q.y-=(ft.left-_t)*Ye.scale;let Jt=Ye.image?ft.advance*Ye.scale:gr*Ye.scale,Hn=String.fromCodePoint(Ye.glyph);PF(Hn)?Q.x+=(1-_t)*Ye.scale:OF(Hn)?Q.x+=Jt-ft.height*Ye.scale+(-_t-1)*Ye.scale:Q.x+=Ye.image||ft.width+2*_t===Mt.w&&ft.height+2*_t===Mt.h?(Jt-ni)/2:(Jt-(ft.height+2*_t)*Ye.scale)/2,ee=new Xe(Q.x,Q.y-nn),Re=new Xe(Q.x+ni,Q.y),rt=new Xe(Q.x+ni,Q.y-nn)}else{let yt=(ft.left-_t)*Ye.scale-at+Wt[0],kt=(-ft.top-_t)*Ye.scale+Wt[1],ln=yt+nn,cn=kt+ni;Q=new Xe(yt,kt),ee=new Xe(ln,kt),Re=new Xe(yt,cn),rt=new Xe(ln,cn)}if(Ve){let yt;yt=ye?new Xe(0,0):pn?new Xe(We[0],We[1]):new Xe(ce[0],ce[1]),Q._rotateAround(Ve,yt),ee._rotateAround(Ve,yt),Re._rotateAround(Ve,yt),rt._rotateAround(Ve,yt)}let ct=new Xe(0,0),lt=new Xe(0,0);et.push({tl:Q,tr:ee,bl:Re,br:rt,texPrimary:Et,texSecondary:void 0,writingMode:ae.writingMode,glyphOffset:Bt,sectionIndex:Ye.sectionIndex,isSDF:Ge,pixelOffsetTL:ct,pixelOffsetBR:lt,minFontScaleX:0,minFontScaleY:0})}}return et}(0,s,x,f,p,y,c,i.allowVerticalPlacement),Z=i.textSizeData,K=null;Z.kind==="source"?(K=[Fa*f.layout.get("text-size").evaluate(y,{},B)*O.textScaleFactor],K[0]>Pc&&fn(`${i.layerIds[0]}: Value for "text-size" is >= ${Qm}. Reduce your "text-size".`)):Z.kind==="composite"&&(K=[Fa*O.compositeTextSizes[0].evaluate(y,{},B)*O.textScaleFactor,Fa*O.compositeTextSizes[1].evaluate(y,{},B)*O.textScaleFactor],(K[0]>Pc||K[1]>Pc)&&fn(`${i.layerIds[0]}: Value for "text-size" is >= ${Qm}. Reduce your "text-size".`)),i.addSymbols(i.text,X,K,x,p,y,I,e,n,w.lineStartIndex,w.lineLength,P,F,B,H,!1);for(let de of S)D[de]=i.text.placedSymbolArray.length-1;return 4*X.length}function Nw(i){for(let e in i)return i[e];return null}function mv(i,e,n,s,c,f,p,y,x,w){let I=p.top,S=p.bottom,D=p.left,P=p.right;if(sC(p)&&p.collisionPadding){let O=p.collisionPadding;D-=O[0],I-=O[1],P+=O[2],S+=O[3]}if(x){let O=new Xe(D,I),F=new Xe(P,I),B=new Xe(D,S),H=new Xe(P,S),X=Sn(x),Z=new Xe(0,0);w&&(Z=new Xe(w[0],w[1])),O._rotateAround(X,Z),F._rotateAround(X,Z),B._rotateAround(X,Z),H._rotateAround(X,Z),D=Math.min(O.x,F.x,B.x,H.x),P=Math.max(O.x,F.x,B.x,H.x),I=Math.min(O.y,F.y,B.y,H.y),S=Math.max(O.y,F.y,B.y,H.y)}return i.emplaceBack(e.x,e.y,e.z,n.x,n.y,D,I,P,S,y,s,c,f),i.length-1}function zw(i){sC(i)&&i.collisionPadding&&(i.top-=i.collisionPadding[1],i.bottom+=i.collisionPadding[3]);let e=i.bottom-i.top;return e>0?Math.max(10,e):null}function sN(i,e,n,s){let c=i.compareText;if(e in c){let f=c[e];for(let p=f.length-1;p>=0;p--)if(s.dist(f[p])<n)return!0}else c[e]=[];return c[e].push(s),!1}function MC(i,e){let n=i.fovAboveCenter,s=i.elevation?i.elevation.getMinElevationBelowMSL()*e:0,c=(i._camera.position[2]*i.worldSize-s)/Math.cos(i._pitch),f=Math.sin(n)*c/Math.sin(Math.max(Math.PI/2-i._pitch-n,.01)),p=Math.sin(i._pitch)*f+c,y=c*(1/i._horizonShift);if(!i.elevation||i.elevation.exaggeration()===0){let x=Math.max(i.zoom-17,0);i.isOrthographic&&(x/=10),p*=1+x}return Math.min(1.01*p,y)}function eg(i,e){if(!e.isReprojectedInTileSpace)return{scale:1<<i.z,x:i.x,y:i.y,x2:i.x+1,y2:i.y+1,projection:e};let n=Math.pow(2,-i.z),s=i.x*n,c=(i.x+1)*n,f=i.y*n,p=(i.y+1)*n,y=W(s),x=W(c),w=Y(f),I=Y(p),S=e.project(y,w),D=e.project(x,w),P=e.project(x,I),O=e.project(y,I),F=Math.min(S.x,D.x,P.x,O.x),B=Math.min(S.y,D.y,P.y,O.y),H=Math.max(S.x,D.x,P.x,O.x),X=Math.max(S.y,D.y,P.y,O.y),Z=n/16;function K(ae,ce,ge,ye,ke,be){let ze=(ge+ke)/2,et=(ye+be)/2,Ve=e.project(W(ze),Y(et)),We=Math.max(0,F-Ve.x,B-Ve.y,Ve.x-H,Ve.y-X);F=Math.min(F,Ve.x),H=Math.max(H,Ve.x),B=Math.min(B,Ve.y),X=Math.max(X,Ve.y),We>Z&&(K(ae,Ve,ge,ye,ze,et),K(Ve,ce,ze,et,ke,be))}K(S,D,s,f,c,f),K(D,P,c,f,c,p),K(P,O,c,p,s,p),K(O,S,s,p,s,f),F-=Z,B-=Z,H+=Z,X+=Z;let de=1/Math.max(H-F,X-B);return{scale:de,x:F*de,y:B*de,x2:H*de,y2:X*de,projection:e}}function RC(i,{x:e,y:n},s=0){return new Xe(((e-s)*i.scale-i.x)*st,(n*i.scale-i.y)*st)}let aN=Fe(new Float32Array(16));class Oc{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,n){return{x:0,y:0,z:0}}unproject(e,n){return new A(0,0)}projectTilePoint(e,n,s){return{x:e,y:n,z:0}}locationPoint(e,n,s,c=!0){return e._coordinatePoint(e.locationCoordinate(n,s),c)}pixelsPerMeter(e,n){return j(1,e)*n}pixelSpaceConversion(e,n,s){return 1}farthestPixelDistance(e){return MC(e,e.pixelsPerMeter)}pointCoordinate(e,n,s,c){let f=e.horizonLineFromTop(!1),p=new Xe(n,Math.max(f,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(p,c))}pointCoordinate3D(e,n,s){let c=new Xe(n,s);if(e.elevation)return e.elevation.pointCoordinate(c);{let f=this.pointCoordinate(e,c.x,c.y,0);return[f.x,f.y,f.z]}}isPointAboveHorizon(e,n){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,n.x,n.y);let s=e.horizonLineFromTop();return n.y<s}createInversionMatrix(e,n){return aN}createTileMatrix(e,n,s){let c,f,p,y=s.canonical,x=Fe(new Float64Array(16));if(this.isReprojectedInTileSpace){let w=eg(y,this);c=1,f=w.x+s.wrap*w.scale,p=w.y,Nt(x,x,[c/w.scale,c/w.scale,e.pixelsPerMeter/n])}else c=n/e.zoomScale(y.z),f=(y.x+Math.pow(2,y.z)*s.wrap)*c,p=y.y*c;return jt(x,x,[f,p,0]),Nt(x,x,[c/st,c/st,1]),x}upVector(e,n,s){return[0,0,1]}upVectorScale(e,n,s){return{metersToTile:1}}}class lN extends Oc{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];let[n,s]=this.parallels=e.parallels||[29.5,45.5],c=Math.sin(Sn(n));this.n=(c+Math.sin(Sn(s)))/2,this.c=1+c*(2*this.n-c),this.r0=Math.sqrt(this.c)/this.n}project(e,n){let{n:s,c,r0:f}=this,p=Sn(e-this.center[0]),y=Sn(n),x=Math.sqrt(c-2*s*Math.sin(y))/s;return{x:x*Math.sin(p*s),y:x*Math.cos(p*s)-f,z:0}}unproject(e,n){let{n:s,c,r0:f}=this,p=f+n,y=Math.atan2(e,Math.abs(p))*Math.sign(p);p*s<0&&(y-=Math.PI*Math.sign(e)*Math.sign(p));let x=Sn(this.center[0])*s;y=Ae(y,-Math.PI-x,Math.PI-x);let w=ne(Se(y/s)+this.center[0],-180,180),I=Math.asin(ne((c-(e*e+p*p)*s*s)/(2*s),-1,1)),S=ne(Se(I),-ie,ie);return new A(w,S)}}let tg=1.340264,ng=-.081106,ig=893e-6,rg=.003796,gv=Math.sqrt(3)/2;class cN extends Oc{project(e,n){n=n/180*Math.PI,e=e/180*Math.PI;let s=Math.asin(gv*Math.sin(n)),c=s*s,f=c*c*c;return{x:.5*(e*Math.cos(s)/(gv*(tg+3*ng*c+f*(7*ig+9*rg*c)))/Math.PI+.5),y:1-.5*(s*(tg+ng*c+f*(ig+rg*c))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let s=n=(2*(1-n)-1)*Math.PI,c=s*s,f=c*c*c;for(let I,S,D,P=0;P<12&&(S=s*(tg+ng*c+f*(ig+rg*c))-n,D=tg+3*ng*c+f*(7*ig+9*rg*c),I=S/D,s=ne(s-I,-Math.PI/3,Math.PI/3),c=s*s,f=c*c*c,!(Math.abs(I)<1e-12));++P);let p=gv*e*(tg+3*ng*c+f*(7*ig+9*rg*c))/Math.cos(s),y=Math.asin(Math.sin(s)/gv),x=ne(180*p/Math.PI,-180,180),w=ne(180*y/Math.PI,-ie,ie);return new A(x,w)}}class uN extends Oc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){return{x:.5+e/360,y:.5-n/360,z:0}}unproject(e,n){let s=360*(e-.5),c=ne(360*(.5-n),-ie,ie);return new A(s,c)}}let lf=Math.PI/2;function _v(i){return Math.tan((lf+i)/2)}class dN extends Oc{constructor(e){super(e),this.center=e.center||[0,30];let[n,s]=this.parallels=e.parallels||[30,30],c=Sn(n),f=Sn(s);this.southernCenter=c+f<0,this.southernCenter&&(c=-c,f=-f);let p=Math.cos(c),y=_v(c);this.n=c===f?Math.sin(c):Math.log(p/Math.cos(f))/Math.log(_v(f)/y),this.f=p*Math.pow(_v(c),this.n)/this.n}project(e,n){n=Sn(n),this.southernCenter&&(n=-n),e=Sn(e-this.center[0]);let s=1e-6,{n:c,f}=this;f>0?n<-lf+s&&(n=-lf+s):n>lf-s&&(n=lf-s);let p=f/Math.pow(_v(n),c),y=p*Math.sin(c*e),x=f-p*Math.cos(c*e);return y=.5*(y/Math.PI+.5),x=.5*(x/Math.PI+.5),{x:y,y:this.southernCenter?x:1-x,z:0}}unproject(e,n){e=(2*e-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;let{n:s,f:c}=this,f=c-n,p=Math.sign(f),y=Math.sign(s)*Math.sqrt(e*e+f*f),x=Math.atan2(e,Math.abs(f))*p;f*s<0&&(x-=Math.PI*Math.sign(e)*p);let w=ne(Se(x/s)+this.center[0],-180,180),I=ne(Se(2*Math.atan(Math.pow(c/y,1/s))-lf),-ie,ie);return new A(w,this.southernCenter?-I:I)}}class PC extends Oc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,n){return{x:z(e),y:U(n),z:0}}unproject(e,n){let s=W(e),c=Y(n);return new A(s,c)}}let OC=Sn(ie);class hN extends Oc{project(e,n){let s=(n=Sn(n))*n,c=s*s;return{x:.5*((e=Sn(e))*(.8707-.131979*s+c*(c*(.003971*s-.001529*c)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+s*(.015085+c*(.028874*s-.044475-.005916*c)))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let s=n=(2*(1-n)-1)*Math.PI,c=25,f=0,p=s*s;do{p=s*s;let w=p*p;f=(s*(1.007226+p*(.015085+w*(.028874*p-.044475-.005916*w)))-n)/(1.007226+p*(.045255+w*(.259866*p-.311325-.005916*11*w))),s=ne(s-f,-OC,OC)}while(Math.abs(f)>1e-6&&--c>0);p=s*s;let y=ne(Se(e/(.8707+p*(p*(p*p*p*(.003971-.001529*p)-.013791)-.131979))),-180,180),x=Se(s);return new A(y,x)}}let LC=Sn(ie);class fN extends Oc{project(e,n){n=Sn(n),e=Sn(e);let s=Math.cos(n),c=2/Math.PI,f=Math.acos(s*Math.cos(e/2)),p=Math.sin(f)/f,y=.5*(e*c+2*s*Math.sin(e/2)/p)||0,x=.5*(n+Math.sin(n)/p)||0;return{x:.5*(y/Math.PI+.5),y:1-.5*(x/Math.PI+1),z:0}}unproject(e,n){let s=e=(2*e-.5)*Math.PI,c=n=(2*(1-n)-1)*Math.PI,f=25,p=1e-6,y=0,x=0;do{let w=Math.cos(c),I=Math.sin(c),S=2*I*w,D=I*I,P=w*w,O=Math.cos(s/2),F=Math.sin(s/2),B=2*O*F,H=F*F,X=1-P*O*O,Z=X?1/X:0,K=X?Math.acos(w*O)*Math.sqrt(1/X):0,de=.5*(2*K*w*F+2*s/Math.PI)-e,ae=.5*(K*I+c)-n,ce=.5*Z*(P*H+K*w*O*D)+1/Math.PI,ge=Z*(B*S/4-K*I*F),ye=.125*Z*(S*F-K*I*P*B),ke=.5*Z*(D*O+K*H*w)+.5,be=ge*ye-ke*ce;y=(ae*ge-de*ke)/be,x=(de*ye-ae*ce)/be,s=ne(s-y,-Math.PI,Math.PI),c=ne(c-x,-LC,LC)}while((Math.abs(y)>p||Math.abs(x)>p)&&--f>0);return new A(Se(s),Se(c))}}class kC extends Oc{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Sn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){let{scale:s,cosPhi:c}=this;return{x:Sn(e)*c*s+.5,y:-Math.sin(Sn(n))/c*s+.5,z:0}}unproject(e,n){let{scale:s,cosPhi:c}=this,f=-(n-.5)/s,p=ne(Se((e-.5)/s)/c,-180,180),y=Math.asin(ne(f*c,-1,1)),x=ne(Se(y),-ie,ie);return new A(p,x)}}class pN extends PC{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,n,s){let c=Am(e,n,s);return Ni(c,c,Gy(La(s))),{x:c[0],y:c[1],z:c[2]}}locationPoint(e,n,s){let c=E(n.lat,n.lng),f=ci([],c),p=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(n),e._centerAltitude):e._centerAltitude;zr(c,c,f,j(1,0)*st*p);let y=Fe(new Float64Array(16));return Vt(y,e.pixelMatrix,e.globeMatrix),Ni(c,c,y),new Xe(c[0],c[1])}pixelsPerMeter(e,n){return j(1,0)*n}pixelSpaceConversion(e,n,s){let c=j(1,e)*n,f=Ct(j(1,45)*n,c,s);return this.pixelsPerMeter(e,n)/f}createTileMatrix(e,n,s){let c=Wb(La(s.canonical));return Vt(new Float64Array(16),e.globeMatrix,c)}createInversionMatrix(e,n){let{center:s}=e,c=Gy(La(n));return lr(c,c,Sn(s.lng)),ar(c,c,Sn(s.lat)),Nt(c,c,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(c)}pointCoordinate(e,n,s,c){return sS(e,n,s,!0)||new se(0,0)}pointCoordinate3D(e,n,s){let c=this.pointCoordinate(e,n,s,0);return[c.x,c.y,c.z]}isPointAboveHorizon(e,n){return!sS(e,n.x,n.y,!1)}farthestPixelDistance(e){let n=function(c,f){let p=c.cameraToCenterDistance,y=c._centerAltitude*f,x=c._camera,w=c._camera.forward(),I=pi([],hi([],w,-p),[0,0,y]),S=c.worldSize/(2*Math.PI),D=[0,0,-S],P=c.width/c.height,O=Math.tan(c.fovAboveCenter),F=hi([],x.up(),O),B=hi([],x.right(),O*P),H=ci([],pi([],pi([],w,F),B)),X=[],Z;if(new wn(I,H).closestPointOnSphere(D,S,X)){let K=pi([],X,D),de=zi([],K,I);Z=Math.cos(c.fovAboveCenter)*Er(de)}else{let K=zi([],I,D),de=zi([],D,I);ci(de,de);let ae=Er(K)-S;Z=Math.sqrt(ae*(ae+2*S));let ce=Math.acos(Z/(S+ae))-Math.acos(Fi(w,de));Z*=Math.cos(ce)}return 1.01*Z}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Dc(e.zoom);if(s>0){let c=MC(e,j(1,e.center.lat)*e.worldSize),f=e.worldSize/(2*Math.PI),p=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Ct(n,c+f*(1-Math.cos(p)),Math.pow(s,10))}return n}upVector(e,n,s){return Am(n,s,e,1)}upVectorScale(e){return{metersToTile:Uy($y(La(e)))}}}function FC(i){let e=i.parallels,n=!!e&&Math.abs(e[0]+e[1])<.01;switch(i.name){case"mercator":return new PC(i);case"equirectangular":return new uN(i);case"naturalEarth":return new hN(i);case"equalEarth":return new cN(i);case"winkelTripel":return new fN(i);case"albers":return n?new kC(i):new lN(i);case"lambertConformalConic":return n?new kC(i):new dN(i);case"globe":return new pN(i)}throw new Error(`Invalid projection name: ${i.name}`)}let mN=Ie.types,gN=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function yv(i,e,n,s,c,f,p,y,x,w,I,S,D){let P=y?Math.min(Pc,Math.round(y[0])):0,O=y?Math.min(Pc,Math.round(y[1])):0;i.emplaceBack(e,n,Math.round(32*s),Math.round(32*c),f,p,(P<<1)+(x?1:0),O,16*w,16*I,256*S,256*D)}function vv(i,e,n){i.emplaceBack(e,n)}function xv(i,e,n,s,c,f,p){i.emplaceBack(e,n,s,c,f,p)}let bv=(i,e,n,s)=>{for(let c=0;c<e;c++)i.emplaceBack(n[0],n[1],n[2],s[0],s[1],s[2])};function wv(i,e,n,s,c){i.emplaceBack(e,n,s,c),i.emplaceBack(e,n,s,c),i.emplaceBack(e,n,s,c),i.emplaceBack(e,n,s,c)}function _N(i){for(let e of i.sections)if(Pb(e.text))return!0;return!1}class Bw{constructor(e){this.layoutVertexArray=new Uh,this.indexArray=new di,this.programConfigurations=e,this.segments=new gi,this.dynamicLayoutVertexArray=new Ra,this.opacityVertexArray=new hm,this.placedSymbolArray=new Xu,this.iconTransitioningVertexArray=new Es,this.globeExtVertexArray=new yc,this.zOffsetVertexArray=new ml,this.orientationVertexArray=new mm}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,n,s,c,f){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,wF.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,TF.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,gN,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,DF.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,EF.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||f)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,IF.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,SF.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||c)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}gt(Bw,"SymbolBuffers");class Vw{constructor(e,n,s){this.layoutVertexArray=new e,this.layoutAttributes=n,this.indexArray=new s,this.segments=new gi,this.collisionVertexArray=new xc,this.collisionVertexArrayExt=new Ra}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,CF.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,AF.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}gt(Vw,"CollisionBuffers");class Ev{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(p=>p.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Fe([]),this.placementViewportMatrix=Fe([]);let n=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=dC(this.zoom,n["text-size"],this.worldview),this.iconSizeData=dC(this.zoom,n["icon-size"],this.worldview);let s=this.layers[0].layout,c=s.get("symbol-sort-key"),f=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=f!=="viewport-y"&&c.constantOr(1)!==void 0,this.sortFeaturesByY=(f==="viewport-y"||f==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(p=>No[p]),this.stateDependentLayerIds=this.layers.filter(p=>p.isStateDependent()).map(p=>p.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new Bw(new Ro(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new Bw(new Ro(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new Em,this.lineVertexArray=new My,this.symbolInstances=new Ay}calculateGlyphDependencies(e,n,s,c,f){for(let p of e){let y=p.codePointAt(0);if(y===void 0)break;if(n[y]=!0,c&&f&&y<=65535){let x=Zm[p];x&&(n[x.charCodeAt(0)]=!0)}}}updateFootprints(e,n){}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let s=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Ky(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}populate(e,n,s,c){let f=this.layers[0],p=f.layout,y=this.projection.name==="globe",x=p.get("text-font"),w=p.get("text-field"),I=p.get("icon-image"),[S,D]=p.get("icon-size-scale-range"),P=ne(n.scaleFactor||1,S,D),O=(w.value.kind!=="constant"||w.value.value instanceof Br&&!w.value.value.isEmpty()||w.value.value.toString().length>0)&&(x.value.kind!=="constant"||x.value.value.length>0),F=I.value.kind!=="constant"||!!I.value.value||Object.keys(I.parameters).length>0,B=p.get("symbol-sort-key");if(this.features=[],!O&&!F)return;let H=n.iconDependencies,X=n.glyphDependencies,Z=n.availableImages,K=new Un(this.zoom,{worldview:this.worldview});for(let{feature:de,id:ae,index:ce,sourceLayerIndex:ge}of e){let ye=f._featureFilter.needGeometry,ke=Pe(de,ye);if(!f._featureFilter.filter(K,ke,s))continue;if(ye||(ke.geometry=pe(de,s,c)),y&&de.type!==1&&s.z<=5){let We=ke.geometry,Je=.98078528056,Oe=(Ze,we)=>Fi(Am(Ze.x,Ze.y,s,1),Am(we.x,we.y,s,1))<Je;for(let Ze=0;Ze<We.length;Ze++)We[Ze]=Ce(We[Ze],Oe)}let be,ze;if(O){let We=f.getValueAndResolveTokens("text-field",ke,s,Z),Je=Br.factory(We);_N(Je)&&(this.hasRTLText=!0),(!this.hasRTLText||om()==="unavailable"||this.hasRTLText&&bs.isParsed())&&(be=RF(Je,f,ke))}if(F){let We=f.getValueAndResolveTokens("icon-image",ke,s,Z);ze=typeof We=="string"?to.build(We):We}if(!be&&!ze)continue;let et=this.sortFeaturesByKey?B.evaluate(ke,{},s):void 0,Ve={id:ae,text:be,icon:ze,index:ce,sourceLayerIndex:ge,geometry:ke.geometry,properties:de.properties,type:mN[de.type],sortKey:et};if(this.features.push(Ve),ze){let We=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Je,iconSecondary:Oe}=SC(ze,this.iconSizeData,We["icon-size"],s,this.zoom,Ve,this.pixelRatio,P,this.worldview),Ze=Je.id.toString();if(H.has(Ze)?H.get(Ze).push(Je):H.set(Ze,[Je]),Oe){this.hasAnySecondaryIcon=!0;let we=Oe.id.toString();H.has(we)?H.get(we).push(Oe):H.set(we,[Oe])}}if(be){let We=x.evaluate(ke,{},s).join(","),Je=p.get("text-rotation-alignment")==="map"&&p.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(No.vertical)>=0;for(let Oe of be.sections)if(Oe.image){let Ze=Oe.image.getPrimary().scaleSelf(this.pixelRatio),we=Ze.id.toString(),Le=H.get(we)||[];Le.push(Ze),H.set(we,Le)}else{let Ze=tm(be.toString()),we=Oe.fontStack||We,Le=X[we]=X[we]||{};this.calculateGlyphDependencies(Oe.text,Le,Je,this.allowVerticalPlacement,Ze)}}}if(p.get("symbol-placement")==="line"&&(this.features=function(de){let ae={},ce={},ge=[],ye=0;function ke(Ve){ge.push(de[Ve]),ye++}function be(Ve,We,Je){let Oe=ce[Ve];return delete ce[Ve],ce[We]=Oe,ge[Oe].geometry[0].pop(),ge[Oe].geometry[0]=ge[Oe].geometry[0].concat(Je[0]),Oe}function ze(Ve,We,Je){let Oe=ae[We];return delete ae[We],ae[Ve]=Oe,ge[Oe].geometry[0].shift(),ge[Oe].geometry[0]=Je[0].concat(ge[Oe].geometry[0]),Oe}function et(Ve,We,Je){let Oe=Je?We[0][We[0].length-1]:We[0][0];return`${Ve}:${Oe.x}:${Oe.y}`}for(let Ve=0;Ve<de.length;Ve++){let We=de[Ve],Je=We.geometry,Oe=We.text?We.text.toString():null;if(!Oe){ke(Ve);continue}let Ze=et(Oe,Je),we=et(Oe,Je,!0);if(Ze in ce&&we in ae&&ce[Ze]!==ae[we]){let Le=ze(Ze,we,Je),it=be(Ze,we,ge[Le].geometry);delete ae[Ze],delete ce[we],ce[et(Oe,ge[it].geometry,!0)]=it,ge[Le].geometry=null}else Ze in ce?be(Ze,we,Je):we in ae?ze(Ze,we,Je):(ke(Ve),ae[Ze]=ye-1,ce[we]=ye-1)}return ge.filter(Ve=>Ve.geometry)}(this.features)),p.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",n.elevationFeatures){!this.elevationFeatures&&n.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(let de of n.elevationFeatures)this.elevationFeatureIdToIndex.set(de.id,this.elevationFeatures.length),this.elevationFeatures.push(de)}}else p.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((de,ae)=>de.sortKey-ae.sortKey)}update(e,n,s,c,f,p,y){this.text.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let n=!1,s=oe(e),c=1/s,f=!1,p=!1;for(let y=0;y<this.symbolInstances.length;y++){let x=this.symbolInstances.get(y),w=Wi(1,0,0),I=Wi(0,1,0),{numHorizontalGlyphVertices:S,numVerticalGlyphVertices:D,numIconVertices:P,numVerticalIconVertices:O}=x,F=S>0||D>0,B=P>0,H=this.elevationFeatures[x.elevationFeatureIndex];if(H){let X=new Xe(x.tileAnchorX,x.tileAnchorY),Z=.075+H.pointElevation(X);x.zOffset!==Z&&(n=!0,x.zOffset=Z);let K=H.computeSlopeNormal(X,c),de=jl(Ls(),Wi(0,0,1),K);ca(w,w,de),ca(I,I,de),w[2]*=s,I[2]*=s,w[0]===1&&w[1]===0&&w[2]===0&&I[0]===0&&I[1]===1&&I[2]===0||(f=f||F,p=p||B)}if(F&&(bv(this.text.orientationVertexArray,S,w,I),bv(this.text.orientationVertexArray,D,w,I)),B){let{placedIconSymbolIndex:X,verticalPlacedIconSymbolIndex:Z}=x;X>=0&&bv(this.icon.orientationVertexArray,P,w,I),Z>=0&&bv(this.icon.orientationVertexArray,O,w,I)}}f||(this.text.orientationVertexArray=void 0),p||(this.icon.orientationVertexArray=void 0),n&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let e=(f,p,y)=>{s+=p,s>f.length&&f.resize(s);for(let x=-p;x<0;x++)f.emplace(x+s,y)},n=(f,p,y)=>{c+=p,c>f.length&&f.resize(c);for(let x=-p;x<0;x++)f.emplace(x+c,y)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,c=0;for(let f=0;f<this.symbolInstances.length;f++){let p=this.symbolInstances.get(f),{numHorizontalGlyphVertices:y,numVerticalGlyphVertices:x,numIconVertices:w}=p,I=p.zOffset,S=w>0;if((y>0||x>0)&&(e(this.text.zOffsetVertexArray,y,I),e(this.text.zOffsetVertexArray,x,I)),S){let{placedIconSymbolIndex:D,verticalPlacedIconSymbolIndex:P}=p;D>=0&&n(this.icon.zOffsetVertexArray,w,I),P>=0&&n(this.icon.zOffsetVertexArray,p.numVerticalIconVertices,I)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=FC(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,n){let s=this.lineVertexArray.length;if(e.segment!==void 0)for(let{x:c,y:f}of n)this.lineVertexArray.emplaceBack(c,f);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,n,s,c,f,p,y,x,w,I,S,D,P,O,F,B){let H=e.indexArray,X=e.layoutVertexArray,Z=e.globeExtVertexArray,K=e.segments.prepareSegment(4*n.length,X,H,this.canOverlap?p.sortKey:void 0),de=this.glyphOffsetArray.length,ae=K.vertexLength,ce=this.allowVerticalPlacement&&y===No.vertical?Math.PI/2:0,ge=p.text&&p.text.sections;for(let ke=0;ke<n.length;ke++){let{tl:be,tr:ze,bl:et,br:Ve,texPrimary:We,texSecondary:Je,pixelOffsetTL:Oe,pixelOffsetBR:Ze,minFontScaleX:we,minFontScaleY:Le,glyphOffset:it,isSDF:Ye,sectionIndex:Et}=n[ke],_t=K.vertexLength,Ge=it[1];if(yv(X,w.x,w.y,be.x,Ge+be.y,We.x,We.y,s,Ye,Oe.x,Oe.y,we,Le),yv(X,w.x,w.y,ze.x,Ge+ze.y,We.x+We.w,We.y,s,Ye,Ze.x,Oe.y,we,Le),yv(X,w.x,w.y,et.x,Ge+et.y,We.x,We.y+We.h,s,Ye,Oe.x,Ze.y,we,Le),yv(X,w.x,w.y,Ve.x,Ge+Ve.y,We.x+We.w,We.y+We.h,s,Ye,Ze.x,Ze.y,we,Le),x){let{x:Ke,y:vt,z:ht}=x.anchor,[at,ft,Mt]=x.up;xv(Z,Ke,vt,ht,at,ft,Mt),xv(Z,Ke,vt,ht,at,ft,Mt),xv(Z,Ke,vt,ht,at,ft,Mt),xv(Z,Ke,vt,ht,at,ft,Mt),wv(e.dynamicLayoutVertexArray,Ke,vt,ht,ce)}else wv(e.dynamicLayoutVertexArray,w.x,w.y,w.z,ce);if(B){let Ke=Je||We;vv(e.iconTransitioningVertexArray,Ke.x,Ke.y),vv(e.iconTransitioningVertexArray,Ke.x+Ke.w,Ke.y),vv(e.iconTransitioningVertexArray,Ke.x,Ke.y+Ke.h),vv(e.iconTransitioningVertexArray,Ke.x+Ke.w,Ke.y+Ke.h)}H.emplaceBack(_t,_t+1,_t+2),H.emplaceBack(_t+1,_t+2,_t+3),K.vertexLength+=4,K.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(it[0]),ke!==n.length-1&&Et===n[ke+1].sectionIndex||e.programConfigurations.populatePaintArrays(X.length,p,p.index,{},P,O,F,ge&&ge[Et],this.worldview)}let ye=x?x.anchor:w;e.placedSymbolArray.emplaceBack(ye.x,ye.y,ye.z,w.x,w.y,de,this.glyphOffsetArray.length-de,ae,I,S,w.segment,s?s[0]:0,s?s[1]:0,c[0],c[1],y,0,0,0,D,0)}_commitLayoutVertex(e,n,s,c,f,p,y){e.emplaceBack(n,s,c,f,p,Math.round(y.x),Math.round(y.y))}_addCollisionDebugVertices(e,n,s,c,f,p,y){let x=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),w=x.vertexLength,I=y.tileAnchorX,S=y.tileAnchorY;for(let P=0;P<4;P++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,n,e.padding,y.zOffset),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x1,e.y2)),x.vertexLength+=4;let D=s.indexArray;D.emplaceBack(w,w+1),D.emplaceBack(w+1,w+2),D.emplaceBack(w+2,w+3),D.emplaceBack(w+3,w),x.primitiveLength+=4}_addTextDebugCollisionBoxes(e,n,s,c,f,p){for(let y=c;y<f;y++){let x=s.get(y),w=this.getSymbolInstanceTextSize(e,p,n,y);this._addCollisionDebugVertices(x,w,this.textCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,p)}}_addIconDebugCollisionBoxes(e,n,s,c,f,p){for(let y=c;y<f;y++){let x=s.get(y),w=this.getSymbolInstanceIconSize(e,n,p.placedIconSymbolIndex);this._addCollisionDebugVertices(x,w,this.iconCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,p)}}generateCollisionDebugBuffers(e,n,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Vw(Hh,YD.members,Es),this.iconCollisionBox=new Vw(Hh,YD.members,Es);let c=Ym(this.iconSizeData,e),f=Ym(this.textSizeData,e,s);for(let p=0;p<this.symbolInstances.length;p++){let y=this.symbolInstances.get(p);this._addTextDebugCollisionBoxes(f,e,n,y.textBoxStartIndex,y.textBoxEndIndex,y),this._addTextDebugCollisionBoxes(f,e,n,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y),this._addIconDebugCollisionBoxes(c,e,n,y.iconBoxStartIndex,y.iconBoxEndIndex,y),this._addIconDebugCollisionBoxes(c,e,n,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y)}}getSymbolInstanceTextSize(e,n,s,c){let f=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:c),p=Pw(this.textSizeData,e,f)/gr;return this.tilePixelRatio*p}getSymbolInstanceIconSize(e,n,s){let c=this.icon.placedSymbolArray.get(s),f=Pw(this.iconSizeData,e,c);return this.tilePixelRatio*f}_commitDebugCollisionVertexUpdate(e,n,s,c){e.emplaceBack(n,-s,-s,c),e.emplaceBack(n,s,-s,c),e.emplaceBack(n,s,s,c),e.emplaceBack(n,-s,s,c)}_updateTextDebugCollisionBoxes(e,n,s,c,f,p,y){for(let x=c;x<f;x++){let w=s.get(x),I=this.getSymbolInstanceTextSize(e,p,n,x);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,w.padding,p.zOffset)}}_updateIconDebugCollisionBoxes(e,n,s,c,f,p,y){for(let x=c;x<f;x++){let w=s.get(x),I=this.getSymbolInstanceIconSize(e,n,p.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,w.padding,p.zOffset)}}updateCollisionDebugBuffers(e,n,s,c){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let f=Ym(this.iconSizeData,e,c),p=Ym(this.textSizeData,e,s);for(let y=0;y<this.symbolInstances.length;y++){let x=this.symbolInstances.get(y);this._updateTextDebugCollisionBoxes(p,e,n,x.textBoxStartIndex,x.textBoxEndIndex,x,s),this._updateTextDebugCollisionBoxes(p,e,n,x.verticalTextBoxStartIndex,x.verticalTextBoxEndIndex,x,s),this._updateIconDebugCollisionBoxes(f,e,n,x.iconBoxStartIndex,x.iconBoxEndIndex,x,c),this._updateIconDebugCollisionBoxes(f,e,n,x.verticalIconBoxStartIndex,x.verticalIconBoxEndIndex,x,c)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,n,s,c,f,p,y,x,w){let I={};if(n<s){let{x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K,featureIndex:de}=e.get(n);I.textBox={x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K},I.textFeatureIndex=de}if(c<f){let{x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K,featureIndex:de}=e.get(c);I.verticalTextBox={x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K},I.verticalTextFeatureIndex=de}if(p<y){let{x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K,featureIndex:de}=e.get(p);I.iconBox={x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K},I.iconFeatureIndex=de}if(x<w){let{x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K,featureIndex:de}=e.get(x);I.verticalIconBox={x1:S,y1:D,x2:P,y2:O,padding:F,projectedAnchorX:B,projectedAnchorY:H,projectedAnchorZ:X,tileAnchorX:Z,tileAnchorY:K},I.verticalIconFeatureIndex=de}return I}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){let s=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,n){let s=e.placedSymbolArray.get(n),c=s.vertexStartIndex+4*s.numGlyphs;for(let f=s.vertexStartIndex;f<c;f+=4)e.indexArray.emplaceBack(f,f+1,f+2),e.indexArray.emplaceBack(f+1,f+2,f+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let n=Math.sin(e),s=Math.cos(e),c=[],f=[],p=[];for(let y=0;y<this.symbolInstances.length;++y){p.push(y);let x=this.symbolInstances.get(y);c.push(0|Math.round(n*x.tileAnchorX+s*x.tileAnchorY)),f.push(x.featureIndex)}return p.sort((y,x)=>c[y]-c[x]||f[x]-f[y]),p}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,n){let s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===n?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let n of this.symbolInstanceIndexes){let s=this.symbolInstances.get(n);this.featureSortOrder.push(s.featureIndex);let{rightJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:f,leftJustifiedTextSymbolIndex:p,verticalPlacedTextSymbolIndex:y,placedIconSymbolIndex:x,verticalPlacedIconSymbolIndex:w}=s;c>=0&&this.addIndicesForPlacedSymbol(this.text,c),f>=0&&f!==c&&this.addIndicesForPlacedSymbol(this.text,f),p>=0&&p!==f&&p!==c&&this.addIndicesForPlacedSymbol(this.text,p),y>=0&&this.addIndicesForPlacedSymbol(this.text,y),x>=0&&this.addIndicesForPlacedSymbol(this.icon,x),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let NC,zC,jw;gt(Ev,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Ev.addDynamicAttributes=wv;class BC{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Yl,this.defaultValue=e}evaluate(e){if(e.formattedSection){let n=this.defaultValue.property.overrides;if(n&&n.hasOverride(e.formattedSection))return n.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}gt(BC,"FormatSectionOverride",{omit:["defaultValue"]});let Uw=()=>jw||(jw={layout:NC||(NC=new Mi({"symbol-placement":new tt(xe.layout_symbol["symbol-placement"]),"symbol-spacing":new tt(xe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new tt(xe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ut(xe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new tt(xe.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new tt(xe.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new tt(xe.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new tt(xe.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new tt(xe.layout_symbol["icon-ignore-placement"]),"icon-optional":new tt(xe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new tt(xe.layout_symbol["icon-rotation-alignment"]),"icon-size":new ut(xe.layout_symbol["icon-size"]),"icon-size-scale-range":new tt(xe.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new ut(xe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ut(xe.layout_symbol["icon-text-fit-padding"]),"icon-image":new ut(xe.layout_symbol["icon-image"]),"icon-rotate":new ut(xe.layout_symbol["icon-rotate"]),"icon-padding":new tt(xe.layout_symbol["icon-padding"]),"icon-keep-upright":new tt(xe.layout_symbol["icon-keep-upright"]),"icon-offset":new ut(xe.layout_symbol["icon-offset"]),"icon-anchor":new ut(xe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new tt(xe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new tt(xe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new tt(xe.layout_symbol["text-rotation-alignment"]),"text-field":new ut(xe.layout_symbol["text-field"]),"text-font":new ut(xe.layout_symbol["text-font"]),"text-size":new ut(xe.layout_symbol["text-size"]),"text-size-scale-range":new tt(xe.layout_symbol["text-size-scale-range"]),"text-max-width":new ut(xe.layout_symbol["text-max-width"]),"text-line-height":new ut(xe.layout_symbol["text-line-height"]),"text-letter-spacing":new ut(xe.layout_symbol["text-letter-spacing"]),"text-justify":new ut(xe.layout_symbol["text-justify"]),"text-radial-offset":new ut(xe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new tt(xe.layout_symbol["text-variable-anchor"]),"text-anchor":new ut(xe.layout_symbol["text-anchor"]),"text-max-angle":new tt(xe.layout_symbol["text-max-angle"]),"text-writing-mode":new tt(xe.layout_symbol["text-writing-mode"]),"text-rotate":new ut(xe.layout_symbol["text-rotate"]),"text-padding":new tt(xe.layout_symbol["text-padding"]),"text-keep-upright":new tt(xe.layout_symbol["text-keep-upright"]),"text-transform":new ut(xe.layout_symbol["text-transform"]),"text-offset":new ut(xe.layout_symbol["text-offset"]),"text-allow-overlap":new tt(xe.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new tt(xe.layout_symbol["text-ignore-placement"]),"text-optional":new tt(xe.layout_symbol["text-optional"]),visibility:new tt(xe.layout_symbol.visibility)})),paint:zC||(zC=new Mi({"icon-opacity":new ut(xe.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new ut(xe.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new ut(xe.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new ut(xe.paint_symbol["text-emissive-strength"]),"icon-color":new ut(xe.paint_symbol["icon-color"]),"icon-halo-color":new ut(xe.paint_symbol["icon-halo-color"]),"icon-halo-width":new ut(xe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ut(xe.paint_symbol["icon-halo-blur"]),"icon-translate":new tt(xe.paint_symbol["icon-translate"]),"icon-translate-anchor":new tt(xe.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new tt(xe.paint_symbol["icon-image-cross-fade"]),"text-opacity":new ut(xe.paint_symbol["text-opacity"]),"text-occlusion-opacity":new ut(xe.paint_symbol["text-occlusion-opacity"]),"text-color":new ut(xe.paint_symbol["text-color"],{runtimeType:ho,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new ut(xe.paint_symbol["text-halo-color"]),"text-halo-width":new ut(xe.paint_symbol["text-halo-width"]),"text-halo-blur":new ut(xe.paint_symbol["text-halo-blur"]),"text-translate":new tt(xe.paint_symbol["text-translate"]),"text-translate-anchor":new tt(xe.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new tt(xe.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new tt(xe.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new tt(xe.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new tt(xe.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new ut(xe.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},jw);class Tv extends Lr{constructor(e,n,s,c){super(e,Uw(),n,s,c),this._colorAdjustmentMatrix=Fe([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,n){super.recalculate(e,n),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let s=this.layout.get("text-writing-mode");if(s){let c=[];for(let f of s)c.indexOf(f)<0&&c.push(f);this.layout._values["text-writing-mode"]=c}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,n,s,c){return this._saturation===e&&this._contrast===n&&this._brightnessMin===s&&this._brightnessMax===c||(this._colorAdjustmentMatrix=function(f,p,y,x){f=Rr(f),p=Qr(p);let w=bt(),I=f/3,S=1-2*I,D=[S,I,I,0,I,S,I,0,I,I,S,0,0,0,0,1],P=.5-.5*p,O=x-y;return Vt(w,[O,0,0,0,0,O,0,0,0,0,O,0,y,y,y,1],[p,0,0,0,0,p,0,0,0,0,p,0,P,P,P,1]),Vt(w,w,D),w}(e,n,s,c),this._saturation=e,this._contrast=n,this._brightnessMin=s,this._brightnessMax=c),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,n,s,c){let f=this.layout.get(e).evaluate(n,{},s,c),p=this._unevaluatedLayout._values[e];return p.isDataDriven()||Kp(p.value)||!f?f:function(y,x){return x.replace(/{([^{}]+)}/g,(w,I)=>I in y?String(y[I]):"")}(n.properties,f)}createBucket(e){return new Ev(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let e of Uw().paint.overridableProperties){if(!Tv.hasPaintOverride(this.layout,e))continue;let n=this.paint.get(e),s=new BC(n),c=new Yp(s,n.property.specification,this.scope,this.options),f=null;f=n.value.kind==="constant"||n.value.kind==="source"?new Mh("source",c):new Sa("composite",c,n.value.zoomStops,n.value.interpolationType),this.paint._values[e]=new pl(n.property,f,n.parameters)}}_handleOverridablePaintPropertyUpdate(e,n,s){return!(!this.layout||n.isDataDriven()||s.isDataDriven())&&Tv.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,n){let s=e.get("text-field"),c=Uw().paint.properties[n],f=!1,p=y=>{for(let x of y)if(c.overrides&&c.overrides.hasOverride(x))return void(f=!0)};if(s.value.kind==="constant"&&s.value.value instanceof Br)p(s.value.value.sections);else if(s.value.kind==="source"){let y=w=>{f||(w instanceof Lt&&pt(w.value)===Su?p(w.value.sections):w instanceof Jl?p(w.sections):w.eachChild(y))},x=s.value;x._styleExpression&&y(x._styleExpression.expression)}return f}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,n,s){return{config:new Ur(this,{zoom:n,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let VC,jC,UC,HC;var Hw=gn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Iv(i,e,n,s,c,f,p,y){let x=[i,e,1,n,s,1,c,f,1],w=[p,y,1],I=Me([],x),[S,D,P]=la(w,w,I);return Ue(x,x,[S,0,0,0,D,0,0,0,P])}function $C(i,e,n,s,c,f,p,y){let x=function(w,I,S,D,P,O,F,B){let H=Iv(0,0,1,0,1,1,0,1),X=Iv(w,I,S,D,P,O,F,B);return Ue(X,X,Me([],H))}(i,e,n,s,c,f,p,y);return[x[2]/x[8]/st,x[5]/x[8]/st]}function Sv(i){return[i[0],Math.min(Math.max(i[1],-ie),ie)]}class GC extends il{constructor(e,n,s,c){super(),this.id=e,this.dispatcher=s,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(c),this.options=n,this._dirty=!1}load(e,n){if(this._loaded=n||!1,this.fire(new js("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=wu(this.map._requestManager.transformRequest(this.url,vu.Image),(s,c)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new So(s)):c&&(this.image=c instanceof HTMLImageElement?rs.getImageData(c):c,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Gm(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new js("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Gm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=e[0][1],s=e[0][1];for(let f of e)f[1]>s&&(s=f[1]),f[1]<n&&(n=f[1]);let c=(s+n)/2;if(c>ie?this.onNorthPole=!0:c<-ie&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let f=e.map(se.fromLngLat);this.tileID=function(p){let y=1/0,x=1/0,w=-1/0,I=-1/0;for(let F of p)y=Math.min(y,F.x),x=Math.min(x,F.y),w=Math.max(w,F.x),I=Math.max(I,F.y);let S=Math.max(w-y,I-x),D=Math.max(0,Math.floor(-Math.log(S)/Math.LN2)),P=Math.pow(2,D),O=Math.floor((y+w)/2*P);return O>1&&(O-=1),new Lo(D,O,Math.floor((x+I)/2*P))}(f),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new js("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Gm||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(let H in this.tiles){let X=this.tiles[H];X.state!=="loaded"&&(X.state="loaded",X.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let n=eg(new Lo(0,0,0),this.map.transform.projection),s=[n.projection.project(this.coordinates[0][0],this.coordinates[0][1]),n.projection.project(this.coordinates[1][0],this.coordinates[1][1]),n.projection.project(this.coordinates[2][0],this.coordinates[2][1]),n.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(H){let X=H[1].x-H[0].x,Z=H[1].y-H[0].y,K=H[2].x-H[1].x,de=H[2].y-H[1].y,ae=H[3].x-H[2].x,ce=H[3].y-H[2].y,ge=H[0].x-H[3].x,ye=H[0].y-H[3].y,ke=X*de-K*Z,be=K*ce-ae*de,ze=ae*ye-ge*ce,et=ge*Z-X*ye;return ke>0&&be>0&&ze>0&&et>0||ke<0&&be<0&&ze<0&&et<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let c=eg(this.tileID,this.map.transform.projection),[f,p,y,x]=this.coordinates.map(H=>{let X=c.projection.project(H[0],H[1]);return RC(c,X)._round()});this.perspectiveTransform=$C(f.x,f.y,p.x,p.y,y.x,y.y,x.x,x.y);let w=this._boundsArray=new gc;w.emplaceBack(f.x,f.y,0,0),w.emplaceBack(p.x,p.y,st,0),w.emplaceBack(x.x,x.y,0,st),w.emplaceBack(y.x,y.y,st,st),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(w,Hw.members),this.boundsSegments=gi.simpleSegment(0,0,4,2);let I=[],S=[Sv((D=this.coordinates)[0]),Sv(D[1]),Sv(D[2]),Sv(D[3])];var D;let[P,O,F,B]=function(H){let X=H[0][0],Z=X,K=H[0][1],de=K;for(let ae=1;ae<H.length;ae++)H[ae][0]<X?X=H[ae][0]:H[ae][0]>Z&&(Z=H[ae][0]),H[ae][1]<K?K=H[ae][1]:H[ae][1]>de&&(de=H[ae][1]);return[X,K,Z-X,de-K]}(S);{let H=new gc,[X,Z,K,de]=function(Oe){let Ze=Oe[0].x,we=Ze,Le=Oe[0].y,it=Le;for(let Ye=1;Ye<Oe.length;Ye++)Oe[Ye].x<Ze?Ze=Oe[Ye].x:Oe[Ye].x>we&&(we=Oe[Ye].x),Oe[Ye].y<Le?Le=Oe[Ye].y:Oe[Ye].y>it&&(it=Oe[Ye].y);return[Ze,Le,we-Ze,it-Le]}(s),ae=Oe=>[(Oe.x-X)/K,(Oe.y-Z)/de],[ce,ge,ye,ke]=s.map(ae),be=function(Oe,Ze,we,Le,it,Ye,Et,_t){let Ge=Iv(0,0,1,0,1,1,0,1);return Ue(Ge,Ge,Me([],Iv(Oe,Ze,we,Le,it,Ye,Et,_t)))}(ce[0],ce[1],ge[0],ge[1],ye[0],ye[1],ke[0],ke[1]);this.elevatedGlobePerspectiveTransform=$C(ce[0],ce[1],ge[0],ge[1],ye[0],ye[1],ke[0],ke[1]);let ze=(Oe,Ze)=>{I.push(Oe.lng);let we=Math.round((Oe.lng-P)/F*st),Le=Math.round((Oe.lat-O)/B*st),it=ae(Ze),Ye=la([],[it[0],it[1],1],be),Et=Math.round(Ye[0]/Ye[2]*st),_t=Math.round(Ye[1]/Ye[2]*st);H.emplaceBack(we,Le,Et,_t)},et=s[3].x-s[0].x,Ve=s[3].y-s[0].y,We=s[2].x-s[1].x,Je=s[2].y-s[1].y;for(let Oe=0;Oe<65;Oe++){let Ze=Oe/64,we=[s[0].x+Ze*et,s[0].y+Ze*Ve],Le=[s[1].x+Ze*We,s[1].y+Ze*Je],it=Le[0]-we[0],Ye=Le[1]-we[1];for(let Et=0;Et<65;Et++){let _t=Et/64,Ge={x:we[0]+it*_t,y:we[1]+Ye*_t};ze(n.projection.unproject(Ge.x,Ge.y),Ge)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(H,Hw.members)}{this.maxLongitudeTriangleSize=0;let H=[],X=new di,Z=(K,de,ae)=>{X.emplaceBack(K,de,ae);let ce=I[K],ge=I[de],ye=I[ae],ke=Math.min(Math.min(ce,ge),ye),be=Math.max(Math.max(ce,ge),ye)-ke;be>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=be),H.push(ke+be/2)};for(let K=0;K<64;K++)for(let de=0;de<64;de++){let ae=65*K+de,ce=ae+1,ge=ae+65,ye=ge+1;Z(ae,ge,ce),Z(ce,ge,ye)}[H,X]=function(K,de){let ae=Array.from({length:K.length},(ye,ke)=>ke);ae.sort((ye,ke)=>K[ye]-K[ke]);let ce=[],ge=new di;for(let ye=0;ye<ae.length;ye++){let ke=ae[ye];ce.push(K[ke]);let be=3*ke,ze=be+1;ge.emplaceBack(de.uint16[be],de.uint16[ze],de.uint16[ze+1])}return[ce,ge]}(H,X),this.elevatedGlobeTrianglesCenterLongitudes=H,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(X)}this.elevatedGlobeSegments=gi.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,F/st,0,B/st,0,0,O,P,0])}prepare(){let e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;let n=this.map.painter.context,s=n.gl;!this._dirty||this.texture instanceof Gm||(this.texture?this.texture.update(this.image):(this.texture=new yw(n,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(n)}loadTile(e,n){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},n(null)):(e.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){let n=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!n)return null;let s=this.elevatedGlobeTrianglesCenterLongitudes,c=(f=e+180)+360*Math.round((s[0]-f)/360);var f;let p=new gi,y=(S,D)=>{p.segments.push({vertexOffset:0,primitiveOffset:S,vertexLength:n.segments[0].vertexLength,primitiveLength:D,sortKey:void 0,vaos:{}})},x=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-c)<=x){let S=hr(s,0,s.length,c+x);return S===s.length||y(S,mi(s,S+1,s.length,c+360-x)-S),p}c<s[0]&&(c+=360);let w=mi(s,0,s.length,c-x);if(w===s.length)return y(0,s.length),p;y(0,w-0);let I=hr(s,w+1,s.length,c+x);return I!==s.length&&y(I,s.length-I),p}}let yN=(Math.pow(256,2)-1)/16907520;class qC extends Lr{constructor(e,n,s,c){super(e,{layout:UC||(UC=new Mi({visibility:new tt(xe.layout_raster.visibility)})),paint:HC||(HC=new Mi({"raster-opacity":new tt(xe.paint_raster["raster-opacity"]),"raster-color":new dc(xe.paint_raster["raster-color"]),"raster-color-mix":new tt(xe.paint_raster["raster-color-mix"]),"raster-color-range":new tt(xe.paint_raster["raster-color-range"]),"raster-hue-rotate":new tt(xe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new tt(xe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new tt(xe.paint_raster["raster-brightness-max"]),"raster-saturation":new tt(xe.paint_raster["raster-saturation"]),"raster-contrast":new tt(xe.paint_raster["raster-contrast"]),"raster-resampling":new tt(xe.paint_raster["raster-resampling"]),"raster-fade-duration":new tt(xe.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new tt(xe.paint_raster["raster-emissive-strength"]),"raster-array-band":new tt(xe.paint_raster["raster-array-band"]),"raster-elevation":new tt(xe.paint_raster["raster-elevation"]),"raster-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},n,s,c),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof GC&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;let n=this._transitionablePaint._values["raster-color"].value.expression,[s,c]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(c)||s===this._curRampRange[0]&&c===this._curRampRange[1]||(this.colorRamp=Mm({expression:n,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:c}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,c])}}let WC,ZC,XC,YC,KC;class JC extends Lr{constructor(e,n,s,c){super(e,{layout:WC||(WC=new Mi({visibility:new tt(xe["layout_raster-particle"].visibility)})),paint:ZC||(ZC=new Mi({"raster-particle-array-band":new tt(xe["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new tt(xe["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new dc(xe["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new tt(xe["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new tt(xe["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new tt(xe["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new tt(xe["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new tt(xe["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},n,s,c),this._updateColorRamp(),this.lastInvalidatedAt=rs.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let e=this._transitionablePaint._values["raster-particle-color"].value.expression,n=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Mm({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:n}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=rs.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class vN extends Lr{constructor(e,n){super(e,{},n,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function $w(i,e,n){let s=[0,0,1],c=ks([]);return Vl(c,c,n?-Sn(i)+Math.PI:Sn(i)),Ka(c,c,-Sn(e)),ca(s,s,c),ci(s,s)}let QC={None:0,Model:1,Symbol:2,FillExtrusion:4};class Dv{constructor(e,n,s,c){this.message=(e?`${e}: `:"")+s,c&&(this.identifier=c),n!=null&&n.__line__&&(this.line=n.__line__)}}function Gw(i,e){let n=i.indexOf("://")===-1;try{return new URL(i,n&&e?"http://example.com":void 0),!0}catch{return!1}}class eA{constructor(e,n){this.feature=e,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class tA{constructor(){this.instancedDataArray=new $h,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class qw{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,n){}populate(e,n,s,c){this.tileToMeter=oe(s);let f=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:p,id:y,index:x,sourceLayerIndex:w}of e){let I=y??(p.properties&&p.properties.hasOwnProperty("id")?p.properties.id:void 0),S=Pe(p,f);if(!this.layers[0]._featureFilter.filter(new Un(this.zoom,{worldview:this.worldview}),S,s))continue;let D={id:I,sourceLayerIndex:w,index:x,geometry:f?S.geometry:pe(p,s,c),properties:p.properties,type:p.type,patterns:{}},P=this.addFeature(D,D.geometry,S);P&&n.featureIndex.insert(p,D.geometry,x,w,this.index,this.instancesPerModel[P].instancedDataArray.length,st/32)}this.lookup=null}update(e,n,s,c){for(let f in this.instancesPerModel){let p=this.instancesPerModel[f];for(let y in e)p.idToFeaturesIndex.hasOwnProperty(y)&&(this.evaluate(p.features[p.idToFeaturesIndex[y]],e[y],p,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];for(let c of s.features){let f=this.layers[0],p=c.feature,y=this.canonical,x=f.paint.get("model-rotation").evaluate(p,{},y),w=f.paint.get("model-scale").evaluate(p,{},y),I=f.paint.get("model-translation").evaluate(p,{},y);Go(c.rotation,x)&&Go(c.scale,w)&&Go(c.translation,I)||(this.evaluate(c,c.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,n,s,c){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let f=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Ky(this.activeReplacements,f))return!1;this.activeReplacements=f;let p=!1;for(let y in this.instancesPerModel){let x=this.instancesPerModel[y],w=x.instancedDataArray;for(let I of x.features){let S=I.instancedDataOffset,D=I.instancedDataCount;for(let P=0;P<D;P++){let O=16*(P+S),F=w.float32[O+0],B=F>st;F=B?F-st:F;let H=Math.floor(F),X=w.float32[O+1],Z=!1;for(let K of this.activeReplacements)if(!US(K,s,QC.Model,c)&&!(K.min.x>H||H>K.max.x||K.min.y>X||X>K.max.y)&&(Z=sw(qS(H,X,e.canonical,K.footprintTileId.canonical),K.footprint),Z))break;w.float32[O]=Z?F+st:F,p=p||Z!==B}}}return p}isEmpty(){for(let e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,Jk.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}let e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(let n of this.modelUris)e.removeModel(n,"",!0)}addFeature(e,n,s){let c=this.layers[0],f=c.layout.get("model-id").evaluate(s,{},this.canonical);if(!f)return fn(`modelId is not evaluated for layer ${c.id} and it is not going to get rendered.`),f;(Gw(f,!1)||this.styleDefinedModelURLs[f]!==void 0)&&(this.modelUris.includes(f)||this.modelUris.push(f)),this.instancesPerModel[f]||(this.instancesPerModel[f]=new tA);let p=this.instancesPerModel[f],y=p.instancedDataArray,x=new eA(s,y.length);for(let w of n)for(let I of w){if(I.x<0||I.x>=st||I.y<0||I.y>=st)continue;let S=(this.lookupDim-1)/st,D=this.lookupDim*(I.y*S|0)+I.x*S|0;if(this.lookup){if(this.lookup[D]!==0)continue;this.lookup[D]=1}this.instanceCount++;let P=y.length;y.resize(P+1),p.instancesEvaluatedElevation.push(0),y.float32[16*P]=I.x,y.float32[16*P+1]=I.y}return x.instancedDataCount=p.instancedDataArray.length-x.instancedDataOffset,x.instancedDataCount>0&&(e.id&&(p.idToFeaturesIndex[e.id]=p.features.length),p.features.push(x),this.evaluate(x,{},p,!1)),f}getModelUris(){return this.modelUris}evaluate(e,n,s,c){let f=this.layers[0],p=e.feature,y=this.canonical,x=e.rotation=f.paint.get("model-rotation").evaluate(p,n,y),w=e.scale=f.paint.get("model-scale").evaluate(p,n,y),I=e.translation=f.paint.get("model-translation").evaluate(p,n,y),S=f.paint.get("model-color").evaluate(p,n,y);S.a=f.paint.get("model-color-mix-intensity").evaluate(p,n,y);let D=[];this.maxVerticalOffset<I[2]&&(this.maxVerticalOffset=I[2]),this.maxScale=Math.max(Math.max(this.maxScale,w[0]),Math.max(w[1],w[2])),DD(D,x,w);let P=Math.round(100*S.a)+S.b/1.05;for(let O=0;O<e.instancedDataCount;++O){let F=e.instancedDataOffset+O,B=16*F,H=s.instancedDataArray.float32,X=0;c&&(X=H[B+6]-s.instancesEvaluatedElevation[F]);let Z=0|H[B+1];H[B]=(0|H[B])+S.r/1.05,H[B+1]=Z+S.g/1.05,H[B+2]=P,H[B+3]=1/(y.z>10?this.tileToMeter:oe(y,Z)),H[B+4]=I[0],H[B+5]=I[1],H[B+6]=I[2]+X,H[B+7]=D[0],H[B+8]=D[1],H[B+9]=D[2],H[B+10]=D[4],H[B+11]=D[5],H[B+12]=D[6],H[B+13]=D[8],H[B+14]=D[9],H[B+15]=D[10],s.instancesEvaluatedElevation[F]=I[2]}}}let nA,iA;gt(qw,"ModelBucket",{omit:["layers"]}),gt(tA,"PerModelAttributes"),gt(eA,"ModelFeature");class cf{constructor(e,n,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=n,this._offset=s}static create(e,n,s){let c=s||e.findDEMTileFor(n);if(!c||!c.dem)return;let f=c.dem,p=c.tileID,y=1<<n.canonical.z-p.canonical.z;return new cf(c,f.dim/st/y,[(n.canonical.x/y-p.canonical.x)*f.dim,(n.canonical.y/y-p.canonical.y)*f.dim])}tileCoordToPixel(e,n){let s=n*this._scale+this._offset[1];return new Xe(Math.floor(e*this._scale+this._offset[0]),Math.floor(s))}getElevationAt(e,n,s,c){let f=e*this._scale+this._offset[0],p=n*this._scale+this._offset[1],y=Math.floor(f),x=Math.floor(p),w=this._dem;return c=!!c,s?Ct(Ct(w.get(y,x,c),w.get(y,x+1,c),p-x),Ct(w.get(y+1,x,c),w.get(y+1,x+1,c),p-x),f-y):w.get(y,x,c)}getElevationAtPixel(e,n,s){return this._dem.get(e,n,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*j(1,e)*this._dem.stride}}let Ww=new Float32Array(262144),ad=new Uint8Array(262144);function rA(i){let e=0;if(i.meshes)for(let n of i.meshes)e=Math.max(e,n.aabb.max[2]);if(i.children)for(let n of i.children)e=Math.max(e,rA(n));return e}function oA(i,e,n){if(i.meshes)for(let s of i.meshes){if(s.aabb.min[0]===1/0)continue;let c=sn.applyTransform(s.aabb,i.matrix);n.insert(e,c.min[0],c.min[1],c.max[0],c.max[1])}if(i.children)for(let s of i.children)oA(s,e,n)}let sA=["","wall","door","roof","window","lamp","logo"];class aA{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:rA(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0,n=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=sn.applyTransformFast(s.aabb,this.node.matrix),n.encapsulate(s.transformedAabb)),e++;this.aabb=n}return this.aabb}}class Cv{constructor(e,n,s,c,f,p,y,x){this.id=s,this.layers=e,this.layerIds=this.layers.map(w=>w.fqid),this.stateDependentLayerIds=this.layers.filter(w=>w.isStateDependent()).map(w=>w.id),this.modelTraits|=nf.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,c&&(this.modelTraits|=nf.HasMapboxMeshFeatures),f&&(this.modelTraits|=nf.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=p,this.worldview=x,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(let w of n)this.nodesInfo.push(new aA(w)),oA(w,y.featureIndexArray.length,y.grid),y.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,y.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,n){for(let s of this.getNodesInfo()){let c=s.node;c.footprint&&n.push({footprint:c.footprint,id:e})}}update(e){let n=Object.keys(e).length!==0;if(n&&!this.stateDependentLayers.length)return;let s=n?this.stateDependentLayers:this.layers;if(!zs(e,this.states))for(let c of s)this.evaluate(c,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;let n=this.getNodesInfo();for(let s of n){let c=s.node;this.uploaded?this.updatePbrBuffer(c):bw(c,e,!0)}for(let s of n)lv(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let n=!1;if(!e.meshes)return n;for(let s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),n=!0);return n}needsReEvaluation(e,n,s){let c=e.transform.projectionOptions,f=e.style.getBrightness(),p=this.brightness!==f;if(!this.uploaded||this.dirty||c.name!==this.projection.name||og(s.paint.get("model-color").value,p)||og(s.paint.get("model-color-mix-intensity").value,p)||og(s.paint.get("model-roughness").value,p)||og(s.paint.get("model-emissive-strength").value,p)||og(s.paint.get("model-height-based-emissive-strength-multiplier").value,p)){this.projection=c,this.brightness=f;let y=this.getNodesInfo();for(let x of y)x.state=null;return!0}return!1}evaluateTransform(e,n){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;let s=this.getNodesInfo(),c=this.id.canonical;for(let f of s){let p=f.feature;f.evaluatedTranslation=n.paint.get("model-translation").evaluate(p,{},c),f.evaluatedScale=n.paint.get("model-scale").evaluate(p,{},c)}}evaluate(e,n){let s=this.getNodesInfo();for(let c of s){if(!c.node.meshes)continue;let f=c.feature,p=n&&n[f.id];if(zs(p,c.state))continue;c.state=structuredClone(p);let y=c.node.meshes&&c.node.meshes[0].featureData,x=c.evaluatedColor[2],w=c.evaluatedRMEA[2],I=this.id.canonical;if(c.hasTranslucentParts=!1,y){for(let S=0;S<sA.length;S++){let D=sA[S];D.length&&(f.properties.part=D);let P=e.paint.get("model-color").evaluate(f,p,I).toPremultipliedRenderColor(null),O=e.paint.get("model-color-mix-intensity").evaluate(f,p,I);c.evaluatedColor[S]=[P.r,P.g,P.b,O],c.evaluatedRMEA[S][0]=e.paint.get("model-roughness").evaluate(f,p,I),c.evaluatedRMEA[S][2]=e.paint.get("model-emissive-strength").evaluate(f,p,I),c.evaluatedRMEA[S][3]=P.a,c.emissionHeightBasedParams[S]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(f,p,I),!c.hasTranslucentParts&&P.a<1&&(c.hasTranslucentParts=!0)}delete f.properties.part,bN(c,x!==c.evaluatedColor[2]||w!==c.evaluatedRMEA[2],this.modelTraits)}else c.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(f,p,I);c.evaluatedTranslation=e.paint.get("model-translation").evaluate(f,p,I),c.evaluatedScale=e.paint.get("model-scale").evaluate(f,p,I),this.updatePbrBuffer(c.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,n,s,c){let f=e.findDEMTileFor(s);if(f&&(f.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(f.dem&&f.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=f.tileID.overscaledZ;let p=cf.create(e,s,f);if(!p)return;this.modelTraits&nf.HasMapboxMeshFeatures&&this.updateDEM(e,p,s,c);for(let y of this.getNodesInfo()){let x=y.node;if(!x.footprint||!x.footprint.vertices||!x.footprint.vertices.length)continue;let w=x.footprint.vertices,I=p.getElevationAt(w[0].x,w[0].y,!0,!0);for(let S=1;S<w.length;S++)I=Math.min(I,p.getElevationAt(w[S].x,w[S].y,!0,!0));x.elevation=I}}this.terrainTile=f.tileID.canonical,this.terrainExaggeration=n}}updateDEM(e,n,s,c){let f=n._dem._modifiedForSources[c];if(f===void 0&&(n._dem._modifiedForSources[c]=[],f=n._dem._modifiedForSources[c]),f.includes(s.canonical))return;let p=n._dem.dim;f.push(s.canonical);let y=!1;for(let x of this.getNodesInfo()){let w=x.node;if(!w.footprint||!w.footprint.grid)continue;let I=w.footprint.grid,S=n.tileCoordToPixel(I.min.x,I.min.y),D=n.tileCoordToPixel(I.max.x,I.max.y),P=Math.min(Math.min(p-D.y,S.x),Math.min(S.y,p-D.x));if(P<0)continue;let O=ne(P,2,5),F=Math.max(0,S.x-O),B=Math.max(0,S.y-O),H=Math.min(D.x+O,p-1),X=Math.min(D.y+O,p-1);for(let ae=B;ae<=X;++ae)for(let ce=F;ce<=H;++ce)ad[ae*p+ce]=255;let Z=0,K=0;for(let ae=0;ae<I.cellsY;++ae)for(let ce=0;ce<I.cellsX;++ce){if(!I.cells[ae*I.cellsX+ce])continue;let ge=n.tileCoordToPixel(I.min.x+ce/I.xScale,I.min.y+ae/I.yScale),ye=n.tileCoordToPixel(I.min.x+(ce+1)/I.xScale,I.min.y+(ae+1)/I.yScale);for(let ke=ge.y;ke<=Math.min(ye.y+1,p-1);++ke)for(let be=ge.x;be<=Math.min(ye.x+1,p-1);++be)ad[ke*p+be]===255&&(ad[ke*p+be]=0,Z+=n.getElevationAtPixel(be,ke),K++)}let de=Z/K;F=Math.max(1,S.x-O),B=Math.max(1,S.y-O),H=Math.min(D.x+O,p-2),X=Math.min(D.y+O,p-2),y=!0;for(let ae=B;ae<=X;++ae)for(let ce=F;ce<=H;++ce)ad[ae*p+ce]===0&&(Ww[ae*p+ce]=n._dem.set(ce,ae,de));for(let ae=1;ae<O;++ae){F=Math.max(1,S.x-ae),B=Math.max(1,S.y-ae),H=Math.min(D.x+ae,p-2),X=Math.min(D.y+ae,p-2);for(let ce=B;ce<=X;++ce)for(let ge=F;ge<=H;++ge){let ye=ce*p+ge;if(ad[ye]===255){let ke=0,be=0,ze=-1,et=-1;for(let Ve=-1;Ve<=1;++Ve)for(let We=-1;We<=1;++We){let Je=(ce+Ve)*p+ge+We;if(ad[Je]>=ae)continue;let Oe=Ww[Je],Ze=Math.abs(Oe);Ze>be&&(ke=Oe,be=Ze,ze=We,et=Ve)}if(be>.1){let Ve=1-(ae+.5*Math.abs(ze*et))/O,We=n._dem.get(ge,ce)+ke*Ve,Je=n._dem.get(ge+ze,ce+et),Oe=n._dem.get(ge-ze,ce-et,!0);(We-Je)*(We-Oe)>0&&(We=(Je+Oe)/2),Ww[ye]=n._dem.set(ge,ce,We),ad[ye]=ae}}}}}y&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=rs.now())}setFilter(e){this.filter=e?hc(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new Un(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){let e=this.getNodesInfo();for(let n of e)lv(n.node),ww(n.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let s=n.getReplacementRegionsForTile(e.toUnwrapped());for(let c of this.getNodesInfo()){let f=c.node.footprint;c.hiddenByReplacement=!!f&&!s.find(p=>p.footprint===f)}}getHeightAtTileCoord(e,n){let s=[],c=[0,0,0],f=Fe([]);for(let p of this.getNodesInfo()){let y=p.node.meshes[0],x=y.transformedAabb;if(e<x.min[0]||n<x.min[1]||e>x.max[0]||n>x.max[1])continue;if(p.node.hidden===!0)return{height:1/0,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};Pt(f,p.node.matrix),c[0]=e,c[1]=n,Ni(c,c,f);let w=(c[0]-y.aabb.min[0])/(y.aabb.max[0]-y.aabb.min[0])*rd|0,I=Math.min(63,(c[1]-y.aabb.min[1])/(y.aabb.max[1]-y.aabb.min[1])*rd|0)*rd+Math.min(63,w),S=y.heightmap[I];if(!(S<0&&p.node.footprint))return p.hiddenByReplacement?void 0:{height:S,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};if(p.node.footprint.grid.query(new Xe(e,n),new Xe(e,n),s),s.length>0)return{height:void 0,maxHeight:p.feature.properties.height,hidden:p.hiddenByReplacement,verticalScale:p.evaluatedScale[2]}}}}function og(i,e){return i instanceof Mh&&!i.isLightConstant&&e}function xN(i,e,n,s,c,f,p,y){let x=(61440&e|(61440&e)>>4)>>8,w=(3840&e|(3840&e)>>4)>>4,I=240&e|(240&e)>>4;n[3]>0&&(x=Ct(x,255*n[0],n[3]),w=Ct(w,255*n[1],n[3]),I=Ct(I,255*n[2],n[3]));let S=x<<8|w,D=I<<8|Math.floor(255*s[3]),P=function(ae){let ce=ne(ae,0,2);return Math.min(Math.round(.5*ce*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],O=ne(c[0],0,1),F=ne(c[1],0,1),B=ne(c[2],0,1),H=ne(c[3],0,1),X,Z,K,de;if(O!==F&&p!==f&&F!==O){let ae=p-f;Z=1/(ae*(F-O)),K=-(f+ae*O)/(ae*(F-O));let ce=ne(c[4],-1,1);de=Math.pow(10,ce),X=255*B<<8|255*H}else X=65535,Z=0,K=1,de=1;if(i.emplaceBack(S,D,P,X,Z,K,de),y){let ae=y.length;y.clear();for(let ce=0;ce<ae;ce++)y.emplaceBack(S,D,P,X,Z,K,de)}}function bN(i,e,n){let s=i.node,c=0,f=n&nf.HasMeshoptCompression;for(let p of s.meshes){if(s.lights&&s.lightMeshIndex===c||!p.featureData)continue;p.featureArray=new wc,p.featureArray.reserve(p.featureData.length);let y=e;for(let x of p.featureData){let w=f?65535&x:x>>16&65535,I=f?x>>16&65535:65535&x,S=(15&I)<8?15&I:0,D=i.evaluatedRMEA[S],P=i.evaluatedColor[S],O=i.emissionHeightBasedParams[S],F;if(y&&S===2&&s.lights&&(F=new wc,F.resize(10*s.lights.length)),xN(p.featureArray,w,P,D,O,p.aabb.min[2],p.aabb.max[2],F),F&&y){y=!1;let B=s.meshes[s.lightMeshIndex];B.featureArray=F,B.featureArray._trim()}}p.featureArray._trim(),c++}}function lA(i,e,n,s){let c=1<<i.z;e.lat=Y((s/st+i.y)/c),e.lng=W((n/st+i.x)/c)}function wN(i,e,n,s){let c=i.getNodesInfo()[e];if(!c||c.hiddenByReplacement||!c.node.meshes)return;let f=Number.MAX_VALUE,p=c.node,y=n.tile,x=s.calculatePosMatrix(y.tileID.toUnwrapped(),s.worldSize),w=c.evaluatedScale,I=0;s.elevation&&p.elevation&&(I=p.elevation*s.elevation.exaggeration()),jt(x,x,[(p.anchor?p.anchor[0]:0)*(w[0]-1),(p.anchor?p.anchor[1]:0)*(w[1]-1),I]),Nt(x,x,w);let S=n.queryGeometry,D=S.isPointQuery()?S.screenBounds:S.screenGeometry,P=function(F){let B=Vt([],x,F.matrix);Vt(B,s.expandedFarZProjMatrix,B);for(let H=0;H<F.meshes.length;++H){let X=F.meshes[H];if(H===F.lightMeshIndex)continue;let Z=CD(D,s,B,X.aabb);Z!=null&&(f=Math.min(Z,f))}if(F.children)for(let H of F.children)P(H)};if(P(p),f===Number.MAX_VALUE)return;let O=new A(0,0);return lA(y.tileID.canonical,O,c.node.anchor[0],c.node.anchor[1]),{intersectionZ:f,position:O,feature:c.feature}}gt(Cv,"Tiled3dModelBucket",{omit:["layers"]}),gt(aA,"Tiled3dModelFeature");let EN={circle:class extends Lr{constructor(i,e,n,s){super(i,{layout:Oa||(Oa=new Mi({"circle-sort-key":new ut(xe.layout_circle["circle-sort-key"]),"circle-elevation-reference":new tt(xe.layout_circle["circle-elevation-reference"]),visibility:new tt(xe.layout_circle.visibility)})),paint:Ic||(Ic=new Mi({"circle-radius":new ut(xe.paint_circle["circle-radius"]),"circle-color":new ut(xe.paint_circle["circle-color"]),"circle-blur":new ut(xe.paint_circle["circle-blur"]),"circle-opacity":new ut(xe.paint_circle["circle-opacity"]),"circle-translate":new tt(xe.paint_circle["circle-translate"]),"circle-translate-anchor":new tt(xe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new tt(xe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new tt(xe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ut(xe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ut(xe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ut(xe.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new tt(xe.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}createBucket(i){return new Rn(i)}queryRadius(i){let e=i;return mr("circle-radius",this,e)+mr("circle-stroke-width",this,e)+Li(this.paint.get("circle-translate"))}queryIntersectsFeature(i,e,n,s,c,f,p,y){let x=_l(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),w=this.paint.get("circle-radius").evaluate(e,n)+this.paint.get("circle-stroke-width").evaluate(e,n);return mS(i,s,f,p,y,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",x,w)}getProgramIds(){return["circle"]}getDefaultProgramParams(i,e,n){let s=pS(this);return{config:new Ur(this,{zoom:e,lut:n}),defines:s,overrideFog:!1}}is3D(i){return!i&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends Lr{createBucket(i){return new _S(i)}constructor(i,e,n,s){super(i,{layout:yS||(yS=new Mi({visibility:new tt(xe.layout_heatmap.visibility)})),paint:vS||(vS=new Mi({"heatmap-radius":new ut(xe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ut(xe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new tt(xe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new dc(xe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new tt(xe.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(i){i==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Mm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(i){return mr("heatmap-radius",this,i)}queryIntersectsFeature(i,e,n,s,c,f,p,y){let x=this.paint.get("heatmap-radius").evaluate(e,n);return mS(i,s,f,p,y,!0,!0,new Xe(0,0),x)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(i,e,n){return i==="heatmap"?{config:new Ur(this,{zoom:e,lut:n}),overrideFog:!1}:{}}},hillshade:class extends Lr{constructor(i,e,n,s){super(i,{layout:xS||(xS=new Mi({visibility:new tt(xe.layout_hillshade.visibility)})),paint:bS||(bS=new Mi({"hillshade-illumination-direction":new tt(xe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new tt(xe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new tt(xe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new tt(xe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new tt(xe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new tt(xe.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new tt(xe.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(i,e,n){return{overrideFog:!1}}},fill:class extends Lr{constructor(i,e,n,s){super(i,{layout:FS||(FS=new Mi({"fill-sort-key":new ut(xe.layout_fill["fill-sort-key"]),visibility:new tt(xe.layout_fill.visibility),"fill-elevation-reference":new tt(xe.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new ut(xe.layout_fill["fill-construct-bridge-guard-rail"])})),paint:NS||(NS=new Mi({"fill-antialias":new tt(xe.paint_fill["fill-antialias"]),"fill-opacity":new ut(xe.paint_fill["fill-opacity"]),"fill-color":new ut(xe.paint_fill["fill-color"]),"fill-outline-color":new ut(xe.paint_fill["fill-outline-color"]),"fill-translate":new tt(xe.paint_fill["fill-translate"]),"fill-translate-anchor":new tt(xe.paint_fill["fill-translate-anchor"]),"fill-pattern":new ut(xe.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new tt(xe.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new tt(xe.paint_fill["fill-emissive-strength"]),"fill-z-offset":new ut(xe.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new ut(xe.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new ut(xe.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}getProgramIds(){let i=this.paint.get("fill-pattern"),e=i&&i.constantOr(1),n=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(i,e,n){return{config:new Ur(this,{zoom:e,lut:n}),overrideFog:!1}}recalculate(i,e){super.recalculate(i,e);let n=this.paint._values["fill-outline-color"];n.value.kind==="constant"&&n.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(i){return new iw(i)}queryRadius(){return Li(this.paint.get("fill-translate"))}queryIntersectsFeature(i,e,n,s,c,f){return!i.queryGeometry.isAboveHorizon&&Bi(Oo(i.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(i){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;let e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return i!=null?e&&!i:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends Lr{constructor(i,e,n,s){super(i,{layout:sD||(sD=new Mi({visibility:new tt(xe["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new tt(xe["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:aD||(aD=new Mi({"fill-extrusion-opacity":new tt(xe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ut(xe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new tt(xe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new tt(xe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ut(xe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new tt(xe["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new ut(xe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ut(xe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new tt(xe["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new tt(xe["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new tt(xe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new tt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new tt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new ut(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new ut(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new tt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new tt(xe["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new tt(xe["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new tt(xe["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new ut(xe["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new ut(xe["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new tt(xe["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(i){return new Qy(i)}queryRadius(){return Li(this.paint.get("fill-extrusion-translate"))}is3D(i){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(i,e,n,s,c,f,p,y,x){let w=_l(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),I=this.paint.get("fill-extrusion-height").evaluate(e,n),S=this.paint.get("fill-extrusion-base").evaluate(e,n),D=[0,0],P=y&&f.elevation,O=f.elevation?f.elevation.exaggeration():1,F=i.tile.getBucket(this);if(P&&F instanceof Qy){let K=F.centroidVertexArray,de=x+1;de<K.length&&(D[0]=K.geta_centroid_pos0(de),D[1]=K.geta_centroid_pos1(de))}if(D[0]===0&&D[1]===1)return!1;f.projection.name==="globe"&&(s=oD([s],[new Xe(0,0),new Xe(st,st)],i.tileID.canonical).map(K=>K.polygon).flat());let B=P?y:null,[H,X]=function(K,de,ae,ce,ge,ye,ke,be,ze,et,Ve){return K.projection.name==="globe"?function(We,Je,Oe,Ze,we,Le,it,Ye,Et,_t,Ge){let Ke=[],vt=[],ht=We.projection.upVectorScale(Ge,We.center.lat,We.worldSize).metersToTile,at=[0,0,0,1],ft=[0,0,0,1],Mt=(Wt,$t,pn,nn)=>{Wt[0]=$t,Wt[1]=pn,Wt[2]=nn,Wt[3]=1},Bt=rD();Oe>0&&(Oe+=Bt),Ze+=Bt;for(let Wt of Je){let $t=[],pn=[];for(let nn of Wt){let ni=nn.x+we.x,Q=nn.y+we.y,ee=We.projection.projectTilePoint(ni,Q,Ge),Re=We.projection.upVector(Ge,nn.x,nn.y),rt=Oe,ct=Ze;if(it){let lt=fD(ni,Q,Oe,Ze,it,Ye,Et,_t);rt+=lt.base,ct+=lt.top}Oe!==0?Mt(at,ee.x+Re[0]*ht*rt,ee.y+Re[1]*ht*rt,ee.z+Re[2]*ht*rt):Mt(at,ee.x,ee.y,ee.z),Mt(ft,ee.x+Re[0]*ht*ct,ee.y+Re[1]*ht*ct,ee.z+Re[2]*ht*ct),Ni(at,at,Le),Ni(ft,ft,Le),$t.push(new id(at[0],at[1],at[2])),pn.push(new id(ft[0],ft[1],ft[2]))}Ke.push($t),vt.push(pn)}return[Ke,vt]}(K,de,ae,ce,ge,ye,ke,be,ze,et,Ve):ke?function(We,Je,Oe,Ze,we,Le,it,Ye,Et){let _t=[],Ge=[],Ke=[0,0,0,1];for(let vt of We){let ht=[],at=[];for(let ft of vt){let Mt=ft.x+Ze.x,Bt=ft.y+Ze.y,Wt=fD(Mt,Bt,Je,Oe,Le,it,Ye,Et);Ke[0]=Mt,Ke[1]=Bt,Ke[2]=Wt.base,Ke[3]=1,co(Ke,Ke,we),Ke[3]=Math.max(Ke[3],1e-5);let $t=new id(Ke[0]/Ke[3],Ke[1]/Ke[3],Ke[2]/Ke[3]);Ke[0]=Mt,Ke[1]=Bt,Ke[2]=Wt.top,Ke[3]=1,co(Ke,Ke,we),Ke[3]=Math.max(Ke[3],1e-5);let pn=new id(Ke[0]/Ke[3],Ke[1]/Ke[3],Ke[2]/Ke[3]);ht.push($t),at.push(pn)}_t.push(ht),Ge.push(at)}return[_t,Ge]}(de,ae,ce,ge,ye,ke,be,ze,et):function(We,Je,Oe,Ze,we){let Le=[],it=[],Ye=we[8]*Je,Et=we[9]*Je,_t=we[10]*Je,Ge=we[11]*Je,Ke=we[8]*Oe,vt=we[9]*Oe,ht=we[10]*Oe,at=we[11]*Oe;for(let ft of We){let Mt=[],Bt=[];for(let Wt of ft){let $t=Wt.x+Ze.x,pn=Wt.y+Ze.y,nn=we[0]*$t+we[4]*pn+we[12],ni=we[1]*$t+we[5]*pn+we[13],Q=we[2]*$t+we[6]*pn+we[14],ee=we[3]*$t+we[7]*pn+we[15],Re=nn+Ye,rt=ni+Et,ct=Q+_t,lt=Math.max(ee+Ge,1e-5),yt=nn+Ke,kt=ni+vt,ln=Q+ht,cn=Math.max(ee+at,1e-5);Mt.push(new id(Re/lt,rt/lt,ct/lt)),Bt.push(new id(yt/cn,kt/cn,ln/cn))}Le.push(Mt),it.push(Bt)}return[Le,it]}(de,ae,ce,ge,ye)}(f,s,S,I,w,p,B,D,O,f.center.lat,i.tileID.canonical),Z=i.queryGeometry;return function(K,de,ae){let ce=1/0;Bi(ae,de)&&(ce=hD(ae,de[0]));for(let ge=0;ge<de.length;ge++){let ye=de[ge],ke=K[ge];for(let be=0;be<ye.length-1;be++){let ze=ye[be],et=[ze,ye[be+1],ke[be+1],ke[be],ze];qn(ae,et)&&(ce=Math.min(ce,hD(ae,et)))}}return ce!==1/0&&ce}(H,X,Z.isPointQuery()?Z.screenBounds:Z.screenGeometry)}},building:class extends Lr{constructor(i,e,n,s){super(i,{layout:ND||(ND=new Mi({visibility:new tt(xe.layout_building.visibility),"building-facade":new ut(xe.layout_building["building-facade"]),"building-facade-floors":new ut(xe.layout_building["building-facade-floors"]),"building-facade-window":new ut(xe.layout_building["building-facade-window"]),"building-roof-shape":new ut(xe.layout_building["building-roof-shape"]),"building-height":new ut(xe.layout_building["building-height"]),"building-base":new ut(xe.layout_building["building-base"])})),paint:zD||(zD=new Mi({"building-opacity":new tt(xe.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new tt(xe.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new tt(xe.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new tt(xe.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new tt(xe.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new tt(xe.paint_building["building-vertical-scale"]),"building-cast-shadows":new tt(xe.paint_building["building-cast-shadows"]),"building-color":new ut(xe.paint_building["building-color"]),"building-emissive-strength":new ut(xe.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new tt(xe.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new tt(xe.paint_building["building-cutoff-fade-range"]),"building-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(i){return new FD(i)}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(i){return!0}},line:class extends Lr{constructor(i,e,n,s){let c=ZD();super(i,c,e,n,s),c.layout&&(this.layout=new as(c.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(i){if(i==="line-gradient"){let e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Fu,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(i,e){super.recalculate(i,e),this.paint._values["line-floorwidth"]=(()=>{if(Wm)return Wm;let n=ZD();return Wm=new bF(n.paint.properties["line-width"].specification),Wm.useIntegerZoom=!0,Wm})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,i)}createBucket(i){return new Iw(i)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(i,e,n){let s=qD(this);return{config:new Ur(this,{zoom:e,lut:n}),defines:s,overrideFog:!1}}queryRadius(i){let e=i,n=XD(mr("line-width",this,e),mr("line-gap-width",this,e)),s=mr("line-offset",this,e);return n/2+Math.abs(s)+Li(this.paint.get("line-translate"))}queryIntersectsFeature(i,e,n,s,c,f){if(i.queryGeometry.isAboveHorizon)return!1;let p=Oo(i.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),y=i.pixelToTileUnitsFactor/2*XD(this.paint.get("line-width").evaluate(e,n),this.paint.get("line-gap-width").evaluate(e,n)),x=this.paint.get("line-offset").evaluate(e,n);return x&&(s=function(w,I){let S=[],D=new Xe(0,0);for(let P=0;P<w.length;P++){let O=w[P],F=[];for(let B=0;B<O.length;B++){let H=O[B],X=O[B+1],Z=B===0?D:H.sub(O[B-1])._unit()._perp(),K=B===O.length-1?D:X.sub(H)._unit()._perp(),de=Z._add(K)._unit();de._mult(1/(de.x*K.x+de.y*K.y)),F.push(de._mult(I)._add(H))}S.push(F)}return S}(s,x*i.pixelToTileUnitsFactor)),function(w,I,S){for(let D=0;D<I.length;D++){let P=I[D];if(w.length>=3){for(let O=0;O<P.length;O++)if(Ir(w,P[O]))return!0}if(qi(w,P,S))return!0}return!1}(p,s,y)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(i){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:Tv,background:class extends Lr{constructor(i,e,n,s){super(i,{layout:VC||(VC=new Mi({visibility:new tt(xe.layout_background.visibility)})),paint:jC||(jC=new Mi({"background-pitch-alignment":new tt(xe.paint_background["background-pitch-alignment"]),"background-color":new tt(xe.paint_background["background-color"]),"background-pattern":new tt(xe.paint_background["background-pattern"]),"background-opacity":new tt(xe.paint_background["background-opacity"]),"background-emissive-strength":new tt(xe.paint_background["background-emissive-strength"]),"background-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(i,e,n){return{overrideFog:!1}}is3D(i){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:qC,"raster-particle":JC,sky:class extends Lr{constructor(i,e,n,s){super(i,{layout:XC||(XC=new Mi({visibility:new tt(xe.layout_sky.visibility)})),paint:YC||(YC=new Mi({"sky-type":new tt(xe.paint_sky["sky-type"]),"sky-atmosphere-sun":new tt(xe.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new tt(xe.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new tt(xe.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new tt(xe.paint_sky["sky-gradient-radius"]),"sky-gradient":new dc(xe.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new tt(xe.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new tt(xe.paint_sky["sky-atmosphere-color"]),"sky-opacity":new tt(xe.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(i){i==="sky-gradient"?this._updateColorRamp():i!=="sky-atmosphere-sun"&&i!=="sky-atmosphere-halo-color"&&i!=="sky-atmosphere-color"&&i!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Mm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(i){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let e=i.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(i,e){if(this.paint.get("sky-type")==="atmosphere"){let s=this.paint.get("sky-atmosphere-sun"),c=!s,f=i.style.light,p=f.properties.get("position");return c&&f.properties.get("anchor")==="viewport"&&fn("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),c?$w(p.azimuthal,90-p.polar,e):$w(s[0],90-s[1],e)}let n=this.paint.get("sky-gradient-center");return $w(n[0],90-n[1],e)}isSky(){return!0}markSkyboxValid(i){this._skyboxInvalidated=!1,this._lightPosition=i.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let i=this.paint.get("sky-type");return i==="atmosphere"?["skyboxCapture","skybox"]:i==="gradient"?["skyboxGradient"]:null}},slot:class extends Lr{constructor(i,e,n,s){super(i,{paint:KC||(KC=new Mi({}))},e,null)}},model:class extends Lr{constructor(i,e,n,s){super(i,{layout:nA||(nA=new Mi({visibility:new tt(xe.layout_model.visibility),"model-id":new ut(xe.layout_model["model-id"])})),paint:iA||(iA=new Mi({"model-opacity":new ut(xe.paint_model["model-opacity"]),"model-rotation":new ut(xe.paint_model["model-rotation"]),"model-scale":new ut(xe.paint_model["model-scale"]),"model-translation":new ut(xe.paint_model["model-translation"]),"model-color":new ut(xe.paint_model["model-color"]),"model-color-mix-intensity":new ut(xe.paint_model["model-color-mix-intensity"]),"model-type":new tt(xe.paint_model["model-type"]),"model-cast-shadows":new tt(xe.paint_model["model-cast-shadows"]),"model-receive-shadows":new tt(xe.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new tt(xe.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new ut(xe.paint_model["model-emissive-strength"]),"model-roughness":new ut(xe.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new ut(xe.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new tt(xe.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new tt(xe.paint_model["model-front-cutoff"]),"model-color-use-theme":new ut({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(i){return new qw(i)}getProgramIds(){return["model"]}is3D(i){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(i){return i instanceof Cv?st-1:0}queryIntersectsFeature(i,e,n,s,c,f){if(!this.modelManager)return!1;let p=this.modelManager,y=i.tile.getBucket(this);if(!(y&&y instanceof qw))return!1;for(let x in y.instancesPerModel){let w=y.instancesPerModel[x],I=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(w.idToFeaturesIndex.hasOwnProperty(I)){let S=w.features[w.idToFeaturesIndex[I]],D=p.getModel(x,this.scope);if(!D)return!1;let P=bt(),O=new A(0,0),F=y.canonical,B=Number.MAX_VALUE;for(let H=0;H<S.instancedDataCount;++H){let X=16*(S.instancedDataOffset+H),Z=w.instancedDataArray.float32,K=[Z[X+4],Z[X+5],Z[X+6]];lA(F,O,Z[X],0|Z[X+1]),AD(P,D,f,O,S.rotation,S.scale,K,!1,!1,!1),f.projection.name==="globe"&&(P=xw(P,f));let de=Vt([],f.projMatrix,P),ae=i.queryGeometry,ce=CD(ae.isPointQuery()?ae.screenBounds:ae.screenGeometry,f,de,D.aabb);ce!=null&&(B=Math.min(ce,B))}return B!==Number.MAX_VALUE&&B}}return!1}_handleOverridablePaintPropertyUpdate(i,e,n){return!(!this.layout||e.isDataDriven()||n.isDataDriven()||i!=="model-color"&&i!=="model-color-mix-intensity"&&i!=="model-rotation"&&i!=="model-scale"&&i!=="model-translation"&&i!=="model-emissive-strength")}_isPropertyZoomDependent(i){let e=this._transitionablePaint._values[i];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Sa}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Lr{constructor(i,e,n,s){super(i,{layout:zS||(zS=new Mi({"clip-layer-types":new tt(xe.layout_clip["clip-layer-types"]),"clip-layer-scope":new tt(xe.layout_clip["clip-layer-scope"])})),paint:BS||(BS=new Mi({}))},e,n,s)}recalculate(i,e){super.recalculate(i,e)}createBucket(i){return new VS(i)}is3D(i){return!0}}},Zw=new Ln(0,0,0),Xw={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Yw={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},Av={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},TN={PAINT_ORDER_FILL_AND_STROKE:1},sg={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},cA={MASK_TYPE_LUMINANCE:1};function IN(i,e,n){i===1&&e.icons.push(function(s,c){return function(f){if(f.usvg_tree.height||(f.usvg_tree.height=f.usvg_tree.width),!f.metadata)return f;let{metadata:p}=f;if(p.content_area){let{content_area:y}=p;y.top==null&&(y.top=y.left),y.width==null&&(y.width=f.usvg_tree.width),y.height==null&&(y.height=y.width)}return p.stretch_x&&p.stretch_x.length&&uA(p,"x"),p.stretch_y&&p.stretch_y.length&&uA(p,"y"),f}(s.readFields(SN,{name:void 0},c))}(n,n.readVarint()+n.pos))}function uA(i,e){let n=[],s=i[`stretch_${e}`],c=null;for(let f=0;f<s.length;f++)c===null?c=n.length===0?s[0]:n[n.length-1][1]+s[f]:(n.push([c,c+s[f]]),c=null);i[`stretch_${e}_areas`]=n}function SN(i,e,n){i===1?e.name=n.readString():i===2?e.metadata=function(s,c){return s.readFields(DN,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},c)}(n,n.readVarint()+n.pos):i===3&&(e.usvg_tree=function(s,c){return s.readFields(MN,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},c)}(n,n.readVarint()+n.pos),e.data="usvg_tree")}function DN(i,e,n){i===1?e.stretch_x=n.readPackedVarint():i===2?e.stretch_y=n.readPackedVarint():i===3?e.content_area=function(s,c){return s.readFields(CN,{left:0},c)}(n,n.readVarint()+n.pos):i===4&&e.variables.push(function(s,c){return s.readFields(AN,{name:void 0},c)}(n,n.readVarint()+n.pos))}function CN(i,e,n){i===1?e.left=n.readVarint():i===2?e.width=n.readVarint():i===3?e.top=n.readVarint():i===4&&(e.height=n.readVarint())}function AN(i,e,n){i===1?e.name=n.readString():i===2&&(e.rgb_color=Pv(n.readVarint()),e.value="rgb_color")}function MN(i,e,n){i===1?e.width=e.height=n.readVarint():i===2?e.height=n.readVarint():i===3?e.children.push(Mv(n,n.readVarint()+n.pos)):i===4?e.linear_gradients.push(function(s,c){return s.readFields(NN,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},c)}(n,n.readVarint()+n.pos)):i===5?e.radial_gradients.push(function(s,c){return s.readFields(BN,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},c)}(n,n.readVarint()+n.pos)):i===7?e.clip_paths.push(function(s,c){return s.readFields(VN,{children:[]},c)}(n,n.readVarint()+n.pos)):i===8&&e.masks.push(function(s,c){let f=s.readFields(jN,{left:0,width:20,mask_type:cA.MASK_TYPE_LUMINANCE,children:[]},c);return f.height==null&&(f.height=f.width),f.top==null&&(f.top=f.left),f}(n,n.readVarint()+n.pos))}function Mv(i,e){return i.readFields(RN,{},e)}function RN(i,e,n){i===1?(e.group=function(s,c){return s.readFields(PN,{opacity:255,children:[]},c)}(n,n.readVarint()+n.pos),e.node="group"):i===2&&(e.path=function(s,c){return s.readFields(LN,{paint_order:1,commands:[],step:1,diffs:[],rule:Xw.PATH_RULE_NON_ZERO},c)}(n,n.readVarint()+n.pos),e.node="path")}function PN(i,e,n){i===1?e.transform=Rv(n,n.readVarint()+n.pos):i===2?e.opacity=n.readVarint():i===5?e.clip_path_idx=n.readVarint():i===6?e.mask_idx=n.readVarint():i===7&&e.children.push(Mv(n,n.readVarint()+n.pos))}function Rv(i,e){return i.readFields(ON,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function ON(i,e,n){i===1?e.sx=n.readFloat():i===2?e.ky=n.readFloat():i===3?e.kx=n.readFloat():i===4?e.sy=n.readFloat():i===5?e.tx=n.readFloat():i===6&&(e.ty=n.readFloat())}function LN(i,e,n){i===1?e.fill=function(s,c){return s.readFields(kN,{rgb_color:Zw,paint:"rgb_color",opacity:255},c)}(n,n.readVarint()+n.pos):i===2?e.stroke=function(s,c){return s.readFields(FN,{rgb_color:Zw,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},c)}(n,n.readVarint()+n.pos):i===3?e.paint_order=n.readVarint():i===5?n.readPackedVarint(e.commands):i===6?e.step=n.readFloat():i===7?n.readPackedSVarint(e.diffs):i===8&&(e.rule=n.readVarint())}function kN(i,e,n){i===1?(e.rgb_color=Pv(n.readVarint()),e.paint="rgb_color"):i===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):i===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):i===5&&(e.opacity=n.readVarint())}function Pv(i){return new Ln((i>>16&255)/255,(i>>8&255)/255,(255&i)/255,1)}function FN(i,e,n){i===1?(e.rgb_color=Pv(n.readVarint()),e.paint="rgb_color"):i===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):i===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):i===5?n.readPackedFloat(e.dasharray):i===6?e.dashoffset=n.readFloat():i===7?e.miterlimit=n.readFloat():i===8?e.opacity=n.readVarint():i===9?e.width=n.readFloat():i===10?e.linecap=n.readVarint():i===11&&(e.linejoin=n.readVarint())}function NN(i,e,n){i===1?e.transform=Rv(n,n.readVarint()+n.pos):i===2?e.spread_method=n.readVarint():i===3?e.stops.push(dA(n,n.readVarint()+n.pos)):i===4?e.x1=n.readFloat():i===5?e.y1=n.readFloat():i===6?e.x2=n.readFloat():i===7&&(e.y2=n.readFloat())}function dA(i,e){return i.readFields(zN,{offset:0,opacity:255,rgb_color:Zw},e)}function zN(i,e,n){i===1?e.offset=n.readFloat():i===2?e.opacity=n.readVarint():i===3&&(e.rgb_color=Pv(n.readVarint()))}function BN(i,e,n){i===1?e.transform=Rv(n,n.readVarint()+n.pos):i===2?e.spread_method=n.readVarint():i===3?e.stops.push(dA(n,n.readVarint()+n.pos)):i===4?e.cx=n.readFloat():i===5?e.cy=n.readFloat():i===6?e.r=n.readFloat():i===7?e.fx=n.readFloat():i===8?e.fy=n.readFloat():i===9&&(e.fr=n.readFloat())}function VN(i,e,n){i===1?e.transform=Rv(n,n.readVarint()+n.pos):i===2?e.clip_path_idx=n.readVarint():i===3&&e.children.push(Mv(n,n.readVarint()+n.pos))}function jN(i,e,n){i===1?e.left=e.top=n.readFloat():i===2?e.width=e.height=n.readFloat():i===3?e.top=n.readFloat():i===4?e.height=n.readFloat():i===5?e.mask_type=n.readVarint():i===6?e.mask_idx=n.readVarint():i===7&&e.children.push(Mv(n,n.readVarint()+n.pos))}class UN{static calculate(e={},n=[]){let s=new Map,c=new Map;if(Object.keys(e).length===0)return s;n.forEach(f=>{c.set(f.name,f.rgb_color||new Ln(0,0,0))});for(let[f,p]of Object.entries(e))c.has(f)?s.set(c.get(f).toString(),p):console.warn(`Ignoring unknown image variable "${f}"`);return s}}function uf(i,e=255,n){let s=e/255,c=i.toString(),f=n.has(c)?n.get(c).clone():i.clone();return f.a*=s,f.toString()}function ag(i,e){if(!Kd()){let n=document.createElement("canvas");return n.width=i,n.height=e,n}return new OffscreenCanvas(i,e)}function HN(i,e){let n=UN.calculate(e.params,i.metadata?i.metadata.variables:[]),s=i.usvg_tree,c=s.width,f=s.height,p=e.transform?e.transform:new DOMMatrix,y=Math.max(1,Math.round(c*p.a)),x=Math.max(1,Math.round(f*p.d)),w=new DOMMatrix([y/c,0,0,x/f,0,0]),I=ag(y,x).getContext("2d");return Kw(I,w,s,s,n),I.getImageData(0,0,y,x)}function Kw(i,e,n,s,c){for(let f of s.children)hA(i,e,n,f,c)}function hA(i,e,n,s,c){s.group?(i.save(),function(f,p,y,x,w){let I=x.mask_idx!=null?y.masks[x.mask_idx]:null,S=x.clip_path_idx!=null?y.clip_paths[x.clip_path_idx]:null;if(x.transform&&(p=df(x.transform).preMultiplySelf(p)),!function(O,F,B){return O.opacity!==255||F||B}(x,S!=null,I!=null))return void Kw(f,p,y,x,w);let D=ag(f.canvas.width,f.canvas.height),P=D.getContext("2d");Kw(P,p,y,x,w),S&&vA(P,p,y,S),I&&xA(P,p,y,I,w),f.globalAlpha=x.opacity/255,f.drawImage(D,0,0)}(i,e,n,s.group,c),i.restore()):s.path&&(i.save(),function(f,p,y,x,w){f.setTransform(p),x.paint_order===TN.PAINT_ORDER_FILL_AND_STROKE?(fA(f,y,x,w),mA(f,y,x,w)):(mA(f,y,x,w),fA(f,y,x,w))}(i,e,n,s.path,c),i.restore())}function fA(i,e,n,s){let c=n.fill;if(!c)return;let f=c.opacity/255;switch(i.save(),i.beginPath(),bA(n,i),c.paint){case"rgb_color":i.fillStyle=uf(c.rgb_color,c.opacity,s);break;case"linear_gradient_idx":{let p=e.linear_gradients[c.linear_gradient_idx];p.transform&&i.setTransform(df(p.transform).preMultiplySelf(i.getTransform())),i.fillStyle=gA(i,p,f,s);break}case"radial_gradient_idx":{let p=e.radial_gradients[c.radial_gradient_idx];p.transform&&i.setTransform(df(p.transform).preMultiplySelf(i.getTransform())),i.fillStyle=_A(i,p,f,s)}}i.fill(pA(n)),i.restore()}function pA(i){return i.rule===Xw.PATH_RULE_NON_ZERO?"nonzero":i.rule===Xw.PATH_RULE_EVEN_ODD?"evenodd":void 0}function mA(i,e,n,s){let c=n.stroke;if(!c)return;let f=wA(n);i.lineWidth=c.width,i.miterLimit=c.miterlimit,i.setLineDash(c.dasharray),i.lineDashOffset=c.dashoffset;let p=c.opacity/255;switch(c.paint){case"rgb_color":i.strokeStyle=uf(c.rgb_color,c.opacity,s);break;case"linear_gradient_idx":i.strokeStyle=gA(i,e.linear_gradients[c.linear_gradient_idx],p,s,!0);break;case"radial_gradient_idx":i.strokeStyle=_A(i,e.radial_gradients[c.radial_gradient_idx],p,s,!0)}switch(c.linejoin){case Av.LINE_JOIN_MITER_CLIP:case Av.LINE_JOIN_MITER:i.lineJoin="miter";break;case Av.LINE_JOIN_ROUND:i.lineJoin="round";break;case Av.LINE_JOIN_BEVEL:i.lineJoin="bevel"}switch(c.linecap){case Yw.LINE_CAP_BUTT:i.lineCap="butt";break;case Yw.LINE_CAP_ROUND:i.lineCap="round";break;case Yw.LINE_CAP_SQUARE:i.lineCap="square"}i.stroke(f)}function gA(i,e,n,s,c=!1){if(e.stops.length===1){let D=e.stops[0];return uf(D.rgb_color,D.opacity*n,s)}let{x1:f,y1:p,x2:y,y2:x}=e,w=new DOMPoint(f,p),I=new DOMPoint(y,x);if(c){let D=df(e.transform);w=D.transformPoint(w),I=D.transformPoint(I)}let S=i.createLinearGradient(w.x,w.y,I.x,I.y);for(let D of e.stops)S.addColorStop(D.offset,uf(D.rgb_color,D.opacity*n,s));return S}function _A(i,e,n,s,c=!1){if(e.stops.length===1){let H=e.stops[0];return uf(H.rgb_color,H.opacity*n,s)}let f=df(e.transform),{fx:p,fy:y,fr:x,cx:w,cy:I,r:S}=e,D=new DOMPoint(p,y),P=new DOMPoint(w,I),O=x,F=S;if(c){D=f.transformPoint(D),P=f.transformPoint(P);let H=(f.a+f.d)/2;O=x*H,F=e.r*H}let B=i.createRadialGradient(D.x,D.y,O,P.x,P.y,F);for(let H of e.stops)B.addColorStop(H.offset,uf(H.rgb_color,H.opacity*n,s));return B}function yA(i,e,n,s){let c=s.transform?df(s.transform).preMultiplySelf(e):e,f=ag(i.canvas.width,i.canvas.height),p=f.getContext("2d");for(let x of s.children)if(x.group)yA(p,c,n,x.group);else if(x.path){let w=x.path,I=new Path2D;I.addPath(wA(w),c),p.fill(I,pA(w))}let y=s.clip_path_idx!=null?n.clip_paths[s.clip_path_idx]:null;y&&vA(p,c,n,y),i.globalCompositeOperation="source-over",i.drawImage(f,0,0)}function vA(i,e,n,s){let c=ag(i.canvas.width,i.canvas.height);yA(c.getContext("2d"),e,n,s),i.globalCompositeOperation="destination-in",i.drawImage(c,0,0)}function xA(i,e,n,s,c){if(s.children.length===0)return;let f=s.mask_idx!=null?n.masks[s.mask_idx]:null;f&&xA(i,e,n,f,c);let p=i.canvas.width,y=i.canvas.height,x=ag(p,y),w=x.getContext("2d"),I=s.width,S=s.height,D=s.left,P=s.top,O=new Path2D,F=new Path2D;F.rect(D,P,I,S),O.addPath(F,e),w.clip(O);for(let X of s.children)hA(w,e,n,X,c);let B=w.getImageData(0,0,p,y),H=B.data;if(s.mask_type===cA.MASK_TYPE_LUMINANCE)for(let X=0;X<H.length;X+=4)H[X+3]=H[X+3]/255*(.2126*H[X]+.7152*H[X+1]+.0722*H[X+2]);w.putImageData(B,0,0),i.globalCompositeOperation="destination-in",i.drawImage(x,0,0)}function df(i){return i?new DOMMatrix([i.sx,i.ky,i.kx,i.sy,i.tx,i.ty]):new DOMMatrix}function bA(i,e){let n=i.step,s=i.diffs[0]*n,c=i.diffs[1]*n;e.moveTo(s,c);for(let f=0,p=2;f<i.commands.length;f++)switch(i.commands[f]){case sg.PATH_COMMAND_MOVE:s+=i.diffs[p++]*n,c+=i.diffs[p++]*n,e.moveTo(s,c);break;case sg.PATH_COMMAND_LINE:s+=i.diffs[p++]*n,c+=i.diffs[p++]*n,e.lineTo(s,c);break;case sg.PATH_COMMAND_QUAD:{let y=s+i.diffs[p++]*n,x=c+i.diffs[p++]*n;s=y+i.diffs[p++]*n,c=x+i.diffs[p++]*n,e.quadraticCurveTo(y,x,s,c);break}case sg.PATH_COMMAND_CUBIC:{let y=s+i.diffs[p++]*n,x=c+i.diffs[p++]*n,w=y+i.diffs[p++]*n,I=x+i.diffs[p++]*n;s=w+i.diffs[p++]*n,c=I+i.diffs[p++]*n,e.bezierCurveTo(y,x,w,I,s,c);break}case sg.PATH_COMMAND_CLOSE:e.closePath()}return e}function wA(i){return bA(i,new Path2D)}class Ov{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let n=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,n),n}put(e,n){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,n)}delete(e){this.cache.delete(e)}}gt(Ov,"LRUCache");class Jw{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Sr(e,e.data)}getFromCache(e,n,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new Ov(150)),this.cacheMap.get(s).get(pc(e.toString(),n))}setInCache(e,n,s,c){this.cacheDependenciesMap.has(c)||this.cacheDependenciesMap.set(c,new Map),this.cacheMap.has(c)||this.cacheMap.set(c,new Ov(150));let f=this.cacheDependenciesMap.get(c),p=pc(e.id.toString(),s);f.get(p)||f.set(p,new Set);let y=this.cacheMap.get(c),x=e.toString();f.get(p).add(x),y.put(pc(e.toString(),s),n)}removeImagesFromCacheByIds(e,n,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;let c=this.cacheMap.get(s),f=this.cacheDependenciesMap.get(s);for(let p of e){let y=pc(p.toString(),n);if(f.has(y)){for(let x of f.get(y))c.delete(x);f.delete(y)}}}rasterize(e,n,s,c,f=HN){let p=this.getFromCache(e,s,c);if(p)return p.clone();let y=f(n.icon,e.options),x=Jw._getImage(y);return this.setInCache(e,x,s,c),x.clone()}}class EA{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,n){let s=this.toIdx(e,n);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,n){return this.leaves[this.toIdx(e,n)]}toIdx(e,n){return n*this.size+e}}function TA(i,e,n,s){let c=0,f=Number.MAX_VALUE;for(let p=0;p<3;p++)if(Math.abs(s[p])<1e-15){if(n[p]<i[p]||n[p]>e[p])return null}else{let y=1/s[p],x=(i[p]-n[p])*y,w=(e[p]-n[p])*y;if(x>w){let I=x;x=w,w=I}if(x>c&&(c=x),w<f&&(f=w),c>f)return null}return c}function IA(i,e,n,s,c,f,p,y,x,w,I){let S=s-i,D=c-e,P=f-n,O=p-i,F=y-e,B=x-n,H=I[1]*B-I[2]*F,X=I[2]*O-I[0]*B,Z=I[0]*F-I[1]*O,K=S*H+D*X+P*Z;if(Math.abs(K)<1e-15)return null;let de=1/K,ae=w[0]-i,ce=w[1]-e,ge=w[2]-n,ye=(ae*H+ce*X+ge*Z)*de;if(ye<0||ye>1)return null;let ke=ce*P-ge*D,be=ge*S-ae*P,ze=ae*D-ce*S,et=(I[0]*ke+I[1]*be+I[2]*ze)*de;return et<0||ye+et>1?null:(O*ke+F*be+B*ze)*de}function SA(i,e,n){return(i-e)/(n-e)}function DA(i,e,n,s,c,f,p,y,x){let w=1<<n,I=f-s,S=p-c,D=(i+1)/w*I+s,P=(e+0)/w*S+c,O=(e+1)/w*S+c;y[0]=(i+0)/w*I+s,y[1]=P,x[0]=D,x[1]=O}class CA{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let n=function(f){let p=Math.ceil(Math.log2(f.dim/8)),y=[],x=Math.ceil(Math.pow(2,p)),w=1/x,I=(P,O,F,B,H)=>{let X=B?1:0,Z=(P+1)*F-X,K=O*F,de=(O+1)*F-X;H[0]=P*F,H[1]=K,H[2]=Z,H[3]=de},S=new EA(x),D=[];for(let P=0;P<x*x;P++){I(P%x,Math.floor(P/x),w,!1,D);let O=Lc(D[0],D[1],f),F=Lc(D[2],D[1],f),B=Lc(D[2],D[3],f),H=Lc(D[0],D[3],f);S.minimums.push(Math.min(O,F,B,H)),S.maximums.push(Math.max(O,F,B,H)),S.leaves.push(1)}for(y.push(S),x/=2;x>=1;x/=2){let P=y[y.length-1];S=new EA(x);for(let O=0;O<x*x;O++){I(O%x,Math.floor(O/x),2,!0,D);let F=P.getElevation(D[0],D[1]),B=P.getElevation(D[2],D[1]),H=P.getElevation(D[2],D[3]),X=P.getElevation(D[0],D[3]),Z=P.isLeaf(D[0],D[1]),K=P.isLeaf(D[2],D[1]),de=P.isLeaf(D[2],D[3]),ae=P.isLeaf(D[0],D[3]),ce=Math.min(F.min,B.min,H.min,X.min),ge=Math.max(F.max,B.max,H.max,X.max),ye=Z&&K&&de&&ae;S.maximums.push(ge),S.minimums.push(ce),S.leaves.push(ge-ce<=5&&ye?1:0)}y.push(S)}return y}(this.dem),s=n.length-1,c=n[s];this._addNode(c.minimums[0],c.maximums[0],c.leaves[0]),this._construct(n,0,0,s,0)}raycastRoot(e,n,s,c,f,p,y=1){return TA([e,n,-100],[s,c,this.maximums[0]*y],f,p)}raycast(e,n,s,c,f,p,y=1){if(!this.nodeCount)return null;let x=this.raycastRoot(e,n,s,c,f,p,y);if(x==null)return null;let w=[],I=[],S=[],D=[],P=[{idx:0,t:x,nodex:0,nodey:0,depth:0}];for(;P.length>0;){let{idx:O,t:F,nodex:B,nodey:H,depth:X}=P.pop();if(this.leaves[O]){DA(B,H,X,e,n,s,c,S,D);let K=1<<X,de=(B+0)/K,ae=(B+1)/K,ce=(H+0)/K,ge=(H+1)/K,ye=Lc(de,ce,this.dem)*y,ke=Lc(ae,ce,this.dem)*y,be=Lc(ae,ge,this.dem)*y,ze=Lc(de,ge,this.dem)*y,et=IA(S[0],S[1],ye,D[0],S[1],ke,D[0],D[1],be,f,p),Ve=IA(D[0],D[1],be,S[0],D[1],ze,S[0],S[1],ye,f,p),We=Math.min(et!==null?et:Number.MAX_VALUE,Ve!==null?Ve:Number.MAX_VALUE);if(We!==Number.MAX_VALUE)return We;{let Je=zr([],f,p,F);if(AA(ye,ke,ze,be,SA(Je[0],S[0],D[0]),SA(Je[1],S[1],D[1]))>=Je[2])return F}continue}let Z=0;for(let K=0;K<this._siblingOffset.length;K++){DA((B<<1)+this._siblingOffset[K][0],(H<<1)+this._siblingOffset[K][1],X+1,e,n,s,c,S,D),S[2]=-100,D[2]=this.maximums[this.childOffsets[O]+K]*y;let de=TA(S,D,f,p);if(de!=null){let ae=de;w[K]=ae;let ce=!1;for(let ge=0;ge<Z&&!ce;ge++)ae>=w[I[ge]]&&(I.splice(ge,0,K),ce=!0);ce||(I[Z]=K),Z++}}for(let K=0;K<Z;K++){let de=I[K];P.push({idx:this.childOffsets[O]+de,t:w[de],nodex:(B<<1)+this._siblingOffset[de][0],nodey:(H<<1)+this._siblingOffset[de][1],depth:X+1})}}return null}_addNode(e,n,s){return this.minimums.push(e),this.maximums.push(n),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,n,s,c,f){if(e[c].isLeaf(n,s)===1)return;this.childOffsets[f]||(this.childOffsets[f]=this.nodeCount);let p=c-1,y=e[p],x=0,w=0;for(let I=0;I<this._siblingOffset.length;I++){let S=2*n+this._siblingOffset[I][0],D=2*s+this._siblingOffset[I][1],P=y.getElevation(S,D),O=y.isLeaf(S,D),F=this._addNode(P.min,P.max,O);O&&(x|=1<<I),w||(w=F)}for(let I=0;I<this._siblingOffset.length;I++)x&1<<I||this._construct(e,2*n+this._siblingOffset[I][0],2*s+this._siblingOffset[I][1],p,w+I)}}function AA(i,e,n,s,c,f){return Ct(Ct(i,n,f),Ct(e,s,f),c)}function Lc(i,e,n){let s=n.dim,c=ne(i*s-.5,0,s-1),f=ne(e*s-.5,0,s-1),p=Math.floor(c),y=Math.floor(f),x=Math.min(p+1,s-1),w=Math.min(y+1,s-1);return AA(n.get(p,y),n.get(x,y),n.get(p,w),n.get(x,w),c-p,f-y)}let $N={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function GN(i,e,n){return(256*i*256+256*e+n)/10-1e4}function qN(i,e,n){return 256*i+e+n/256-32768}class Lv{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,n,s,c=!1){if(this.uid=e,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void fn(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;let f=this.dim=n.height-2,p=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.floatView=new Float32Array(n.data.buffer),this.borderReady=c,this._modifiedForSources={},!c){for(let x=0;x<f;x++)p[this._idx(-1,x)]=p[this._idx(0,x)],p[this._idx(f,x)]=p[this._idx(f-1,x)],p[this._idx(x,-1)]=p[this._idx(x,0)],p[this._idx(x,f)]=p[this._idx(x,f-1)];p[this._idx(-1,-1)]=p[this._idx(0,0)],p[this._idx(f,-1)]=p[this._idx(f-1,0)],p[this._idx(-1,f)]=p[this._idx(0,f-1)],p[this._idx(f,f)]=p[this._idx(f-1,f-1)]}let y=s==="terrarium"?qN:GN;for(let x=0;x<p.length;++x){let w=4*x;this.floatView[x]=y(this.pixels[w],this.pixels[w+1],this.pixels[w+2])}this._timestamp=rs.now()}_buildQuadTree(){this._tree=new CA(this)}get(e,n,s=!1){s&&(e=ne(e,-1,this.dim),n=ne(n,-1,this.dim));let c=this._idx(e,n);return this.floatView[c]}set(e,n,s){let c=this._idx(e,n),f=this.floatView[c];return this.floatView[c]=s,s-f}static getUnpackVector(e){return $N[e]}_idx(e,n){if(e<-1||e>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(e+1)}static pack(e,n){let s=[0,0,0,0],c=Lv.getUnpackVector(n),f=Math.floor((e+c[3])/c[2]);return s[2]=f%256,f=Math.floor(f/256),s[1]=f%256,f=Math.floor(f/256),s[0]=f,s}getPixels(){return new TS({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,n,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let c=n*this.dim,f=n*this.dim+this.dim,p=s*this.dim,y=s*this.dim+this.dim;switch(n){case-1:c=f-1;break;case 1:f=c+1}switch(s){case-1:p=y-1;break;case 1:y=p+1}let x=-n*this.dim,w=-s*this.dim;for(let I=p;I<y;I++)for(let S=c;S<f;S++){let D=4*this._idx(S,I),P=4*this._idx(S+x,I+w);this.pixels[D+0]=e.pixels[P+0],this.pixels[D+1]=e.pixels[P+1],this.pixels[D+2]=e.pixels[P+2],this.pixels[D+3]=e.pixels[P+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function WN(i,e,n){i===1?e.headerLength=n.readFixed32():i===2?e.x=n.readVarint():i===3?e.y=n.readVarint():i===4?e.z=n.readVarint():i===5&&e.layers.push(function(s,c){return s.readFields(JN,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},c)}(n,n.readVarint()+n.pos))}function ZN(i,e,n){i===1?(e.delta_filter=function(s,c){return s.readFields(XN,{blockSize:0},c)}(n,n.readVarint()+n.pos),e.filter="delta_filter"):i===2?(n.readVarint(),e.filter="zigzag_filter"):i===3?(n.readVarint(),e.filter="bitshuffle_filter"):i===4&&(n.readVarint(),e.filter="byteshuffle_filter")}function XN(i,e,n){i===1&&(e.blockSize=n.readVarint())}function YN(i,e,n){i===1?(n.readVarint(),e.codec="gzip_data"):i===2?(n.readVarint(),e.codec="jpeg_image"):i===3?(n.readVarint(),e.codec="webp_image"):i===4&&(n.readVarint(),e.codec="png_image")}function KN(i,e,n){let s=0,c=0;i===1?e.firstByte=n.readFixed64():i===2?e.lastByte=n.readFixed64():i===3?e.filters.push(function(f,p){return f.readFields(ZN,{},p)}(n,n.readVarint()+n.pos)):i===4?e.codec=function(f,p){return f.readFields(YN,{},p)}(n,n.readVarint()+n.pos):i===5?c=n.readFloat():i===6?s=n.readFloat():i===7?e.bands.push(n.readString()):i===8?e.offset=n.readDouble():i===9&&(e.scale=n.readDouble()),e.offset===0&&(e.offset=c),e.scale===0&&(e.scale=s)}function JN(i,e,n){i===1?e.version=n.readVarint():i===2?e.name=n.readString():i===3?e.units=n.readString():i===4?e.tileSize=n.readVarint():i===5?e.buffer=n.readVarint():i===6?e.pixelFormat=n.readVarint():i===7&&e.dataIndex.push(function(s,c){return s.readFields(KN,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},c)}(n,n.readVarint()+n.pos))}function QN(i,e,n){if(i===2)(function(s,c,f){s.readFields(ez,f,c)})(n,n.readVarint()+n.pos,e);else if(i===3)throw new Error("Not implemented")}function ez(i,e,n){if(i===1){let s=0,c=n.readVarint()+n.pos;for(;n.pos<c;)e[s++]=n.readVarint()}}function tz(i,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let n=e[3];for(let s=2;s>=1;s--){let c=s===1?1:0,f=s===2?1:0;for(let p=0;p<e[0];p++){let y=e[1]*p;for(let x=c;x<e[1];x++){let w=e[2]*(x+y);for(let I=f;I<e[2];I++){let S=e[3]*(I+w);for(let D=0;D<e[3];D++){let P=S+D;i[P]+=i[P-n]}}}}n*=e[s]}return i}function nz(i){for(let e=0,n=i.length;e<n;e++)i[e]=i[e]>>>1^-(1&i[e]);return i}function iz(i,e){switch(e){case"uint32":return i;case"uint16":for(let n=0;n<i.length;n+=2){let s=i[n],c=i[n+1];i[n]=(240&s)>>4|(61440&s)>>8|(240&c)<<4|61440&c,i[n+1]=15&s|(3840&s)>>4|(15&c)<<8|(3840&c)<<4}return i;case"uint8":for(let n=0;n<i.length;n+=4){let s=i[n],c=i[n+1],f=i[n+2],p=i[n+3];i[n+0]=(192&s)>>6|(192&c)>>4|(192&f)>>2|192&p,i[n+1]=(48&s)>>4|(48&c)>>2|48&f|(48&p)<<2,i[n+2]=(12&s)>>2|12&c|(12&f)<<2|(12&p)<<4,i[n+3]=3&s|(3&c)<<2|(3&f)<<4|(3&p)<<6}return i;default:throw new Error(`Invalid pixel format, "${e}"`)}}gt(Lv,"DEMData"),gt(CA,"DemMinMaxQuadTree",{omit:["dem"]});var cs=Uint8Array,lg=Uint16Array,rz=Int32Array,MA=new cs([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),RA=new cs([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),oz=new cs([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),PA=function(i,e){for(var n=new lg(31),s=0;s<31;++s)n[s]=e+=1<<i[s-1];var c=new rz(n[30]);for(s=1;s<30;++s)for(var f=n[s];f<n[s+1];++f)c[f]=f-n[s]<<5|s;return{b:n,r:c}},OA=PA(MA,2),LA=OA.b,sz=OA.r;LA[28]=258,sz[258]=28;for(var az=PA(RA,0).b,kA=new lg(32768),rr=0;rr<32768;++rr){var hf=(43690&rr)>>1|(21845&rr)<<1;kA[rr]=((65280&(hf=(61680&(hf=(52428&hf)>>2|(13107&hf)<<2))>>4|(3855&hf)<<4))>>8|(255&hf)<<8)>>1}var cg=function(i,e,n){for(var s=i.length,c=0,f=new lg(e);c<s;++c)i[c]&&++f[i[c]-1];var p,y=new lg(e);for(c=1;c<e;++c)y[c]=y[c-1]+f[c-1]<<1;p=new lg(1<<e);var x=15-e;for(c=0;c<s;++c)if(i[c])for(var w=c<<4|i[c],I=e-i[c],S=y[i[c]-1]++<<I,D=S|(1<<I)-1;S<=D;++S)p[kA[S]>>x]=w;return p},ug=new cs(288);for(rr=0;rr<144;++rr)ug[rr]=8;for(rr=144;rr<256;++rr)ug[rr]=9;for(rr=256;rr<280;++rr)ug[rr]=7;for(rr=280;rr<288;++rr)ug[rr]=8;var FA=new cs(32);for(rr=0;rr<32;++rr)FA[rr]=5;var lz=cg(ug,9),cz=cg(FA,5),Qw=function(i){for(var e=i[0],n=1;n<i.length;++n)i[n]>e&&(e=i[n]);return e},Zs=function(i,e,n){var s=e/8|0;return(i[s]|i[s+1]<<8)>>(7&e)&n},e1=function(i,e){var n=e/8|0;return(i[n]|i[n+1]<<8|i[n+2]<<16)>>(7&e)},uz=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Xs=function(i,e,n){var s=new Error(e||uz[i]);if(s.code=i,Error.captureStackTrace&&Error.captureStackTrace(s,Xs),!n)throw s;return s},dz=new cs(0),hz=typeof TextDecoder<"u"&&new TextDecoder;try{hz.decode(dz,{stream:!0})}catch{}let fz={gzip_data:"gzip"};class Ss extends Error{constructor(e){super(e),this.name="MRTError"}}let pz={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},NA={uint32:1,uint16:2,uint8:4},mz={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},t1;class kv{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){let n=this.layers[e];if(!n)throw new Ss(`Layer '${e}' not found`);return n}getHeaderLength(e){let n=new Uint8Array(e),s=new DataView(e);if(n[0]!==13)throw new Ss("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){let n=new Uint8Array(e),s=this.getHeaderLength(e);if(n.length<s)throw new Ss(`Expected header with length >= ${s} but got buffer of length ${n.length}`);let c=new t1(n.subarray(0,s)).readFields(WN,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==c.x||this.y!==c.y||this.z!==c.z))throw new Ss(`Invalid attempt to parse header ${c.z}/${c.x}/${c.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=c.x,this.y=c.y,this.z=c.z;for(let f of c.layers)this.layers[f.name]=new zA(f,{cacheSize:this._cacheSize});return this}createDecodingTask(e){let n=[],s=this.getLayer(e.layerName);for(let c of e.blockIndices){let f=s.dataIndex[c],p=f.firstByte-e.firstByte,y=f.lastByte-e.firstByte;if(s._blocksInProgress.has(c))continue;let x={layerName:s.name,firstByte:p,lastByte:y,pixelFormat:s.pixelFormat,blockIndex:c,blockShape:[f.bands.length].concat(s.bandShape),buffer:s.buffer,codec:f.codec.codec,filters:f.filters.map(w=>w.filter)};s._blocksInProgress.add(c),n.push(x)}return new BA(n,()=>{n.forEach(c=>s._blocksInProgress.delete(c.blockIndex))},(c,f)=>{if(n.forEach(p=>s._blocksInProgress.delete(p.blockIndex)),c)throw c;f.forEach(p=>{this.getLayer(p.layerName).processDecodedData(p)})})}}class zA{constructor({version:e,name:n,units:s,tileSize:c,pixelFormat:f,buffer:p,dataIndex:y},x){if(this.version=e,this.version!==1)throw new Ss(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=n,this.units=s,this.tileSize=c,this.buffer=p,this.pixelFormat=pz[f],this.dataIndex=y,this.bandShape=[c+2*p,c+2*p,NA[this.pixelFormat]],this._decodedBlocks=new Ov(x?x.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return NA[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){let n=e.blockIndex.toString();this._decodedBlocks.get(n)||this._decodedBlocks.put(n,e.data)}getBlockForBand(e){let n=0;switch(typeof e){case"string":for(let[s,c]of this.dataIndex.entries()){for(let[f,p]of c.bands.entries())if(p===e)return{bandIndex:n+f,blockIndex:s,blockBandIndex:f};n+=c.bands.length}break;case"number":for(let[s,c]of this.dataIndex.entries()){if(e>=n&&e<n+c.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-n};n+=c.bands.length}break;default:throw new Ss(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let n=1/0,s=-1/0,c=[],f=new Set;for(let p of e){let{blockIndex:y}=this.getBlockForBand(p);if(y<0)throw new Ss(`Invalid band: ${JSON.stringify(p)}`);let x=this.dataIndex[y];c.includes(y)||c.push(y),f.add(y),n=Math.min(n,x.firstByte),s=Math.max(s,x.lastByte)}if(f.size>this.cacheSize)throw new Ss(`Number of blocks to decode (${f.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:n,lastByte:s,blockIndices:c}}hasBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0}hasDataForBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0&&!!this._decodedBlocks.get(n.toString())}getBandView(e){let{blockIndex:n,blockBandIndex:s}=this.getBlockForBand(e);if(n<0)throw new Ss(`Band not found: ${JSON.stringify(e)}`);let c=this._decodedBlocks.get(n.toString());if(!c)throw new Ss(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);let f=this.dataIndex[n],p=this.bandShape.reduce((w,I)=>w*I,1),y=s*p,x=c.subarray(y,y+p);return{data:x,bytes:new Uint8Array(x.buffer).subarray(x.byteOffset,x.byteOffset+x.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:f.offset,scale:f.scale}}}kv.setPbf=function(i){t1=i};class BA{constructor(e,n,s){this.tasks=e,this._onCancel=n,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,n){this._finalized||(this._onComplete(e,n),this._finalized=!0)}}kv.performDecoding=function(i,e){let n=new Uint8Array(i);return Promise.all(e.tasks.map(s=>{let{layerName:c,firstByte:f,lastByte:p,pixelFormat:y,blockShape:x,blockIndex:w,filters:I,codec:S}=s,D=n.subarray(f,p+1),P=new Uint32Array(x[0]*x[1]*x[2]),O;if(S!=="gzip_data")throw new Ss(`Unhandled codec: ${S}`);return O=function(F,B){if(!globalThis.DecompressionStream&&B==="gzip_data")return Promise.resolve(((K=function(ce){ce[0]==31&&ce[1]==139&&ce[2]==8||Xs(6,"invalid gzip data");var ge=ce[3],ye=10;4&ge&&(ye+=2+(ce[10]|ce[11]<<8));for(var ke=(ge>>3&1)+(ge>>4&1);ke>0;ke-=!ce[ye++]);return ye+(2&ge)}(Z=F))+8>Z.length&&Xs(6,"invalid gzip data"),function(ce,ge,ye,ke){var be=ce.length;if(!be||ge.f&&!ge.l)return ye||new cs(0);var ze=!ye,et=ze||ge.i!=2,Ve=ge.i;ze&&(ye=new cs(3*be));var We,Je,Oe=function(yi){var ii=ye.length;if(yi>ii){var ei=new cs(Math.max(2*ii,yi));ei.set(ye),ye=ei}},Ze=ge.f||0,we=ge.p||0,Le=ge.b||0,it=ge.l,Ye=ge.d,Et=ge.m,_t=ge.n,Ge=8*be;do{if(!it){Ze=Zs(ce,we,1);var Ke=Zs(ce,we+1,3);if(we+=3,!Ke){var vt=ce[(Q=4+((we+7)/8|0))-4]|ce[Q-3]<<8,ht=Q+vt;if(ht>be){Ve&&Xs(0);break}et&&Oe(Le+vt),ye.set(ce.subarray(Q,ht),Le),ge.b=Le+=vt,ge.p=we=8*ht,ge.f=Ze;continue}if(Ke==1)it=lz,Ye=cz,Et=9,_t=5;else if(Ke==2){var at=Zs(ce,we,31)+257,ft=Zs(ce,we+10,15)+4,Mt=at+Zs(ce,we+5,31)+1;we+=14;for(var Bt=new cs(Mt),Wt=new cs(19),$t=0;$t<ft;++$t)Wt[oz[$t]]=Zs(ce,we+3*$t,7);we+=3*ft;var pn=Qw(Wt),nn=(1<<pn)-1,ni=cg(Wt,pn);for($t=0;$t<Mt;){var Q,ee=ni[Zs(ce,we,nn)];if(we+=15&ee,(Q=ee>>4)<16)Bt[$t++]=Q;else{var Re=0,rt=0;for(Q==16?(rt=3+Zs(ce,we,3),we+=2,Re=Bt[$t-1]):Q==17?(rt=3+Zs(ce,we,7),we+=3):Q==18&&(rt=11+Zs(ce,we,127),we+=7);rt--;)Bt[$t++]=Re}}var ct=Bt.subarray(0,at),lt=Bt.subarray(at);Et=Qw(ct),_t=Qw(lt),it=cg(ct,Et),Ye=cg(lt,_t)}else Xs(1);if(we>Ge){Ve&&Xs(0);break}}et&&Oe(Le+131072);for(var yt=(1<<Et)-1,kt=(1<<_t)-1,ln=we;;ln=we){var cn=(Re=it[e1(ce,we)&yt])>>4;if((we+=15&Re)>Ge){Ve&&Xs(0);break}if(Re||Xs(2),cn<256)ye[Le++]=cn;else{if(cn==256){ln=we,it=null;break}var Jt=cn-254;cn>264&&(Jt=Zs(ce,we,(1<<(Zt=MA[$t=cn-257]))-1)+LA[$t],we+=Zt);var Hn=Ye[e1(ce,we)&kt],wi=Hn>>4;if(Hn||Xs(3),we+=15&Hn,lt=az[wi],wi>3){var Zt=RA[wi];lt+=e1(ce,we)&(1<<Zt)-1,we+=Zt}if(we>Ge){Ve&&Xs(0);break}et&&Oe(Le+131072);var ai=Le+Jt;if(Le<lt){var Qn=0-lt,Fn=Math.min(lt,ai);for(Qn+Le<0&&Xs(3);Le<Fn;++Le)ye[Le]=(void 0)[Qn+Le]}for(;Le<ai;++Le)ye[Le]=ye[Le-lt]}}ge.l=it,ge.p=ln,ge.b=Le,ge.f=Ze,it&&(Ze=1,ge.m=Et,ge.d=Ye,ge.n=_t)}while(!Ze);return Le!=ye.length&&ze?(We=ye,((Je=Le)==null||Je>We.length)&&(Je=We.length),new cs(We.subarray(0,Je))):ye.subarray(0,Le)}(Z.subarray(K,-8),{i:2},new cs(((H=Z)[(X=H.length)-4]|H[X-3]<<8|H[X-2]<<16|H[X-1]<<24)>>>0))));var H,X,Z,K;let de=fz[B];if(!de)throw new Error(`Unhandled codec: ${B}`);let ae=new globalThis.DecompressionStream(de);return new Response(new Blob([F]).stream().pipeThrough(ae)).arrayBuffer().then(ce=>new Uint8Array(ce))}(D,S).then(F=>(function(B,H){B.readFields(QN,H)}(new t1(F),P),new mz[y](P.buffer))),O.then(F=>{for(let B=I.length-1;B>=0;B--)switch(I[B]){case"delta_filter":tz(F,x);break;case"zigzag_filter":nz(F);break;case"bitshuffle_filter":iz(F,y);break;default:throw new Ss(`Unhandled filter "${I[B]}"`)}return{layerName:c,blockIndex:w,data:F}}).catch(F=>{throw F})}))},gt(BA,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),gt(kv,"MapboxRasterTile"),gt(zA,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class VA{constructor(e){this._stringToNumber={},this._numberToString=[];for(let n=0;n<e.length;n++){let s=e[n];this._stringToNumber[s]=n,this._numberToString[n]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}let gz=["id","tile","layer","source","sourceLayer","state"];class ff{constructor(e,n,s,c,f){this.type="Feature",this._vectorTileFeature=e,this._z=n,this._x=s,this._y=c,this.properties=e.properties,this.id=f}clone(){let e=new ff(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){let e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let n of gz)this[n]!==void 0&&(e[n]=this[n]);return e}}class jA{constructor(e,n){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Da(st,16,0),this.featureIndexArray=new Ry,this.promoteId=n,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,n,s,c,f,p=0,y=0){let x=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,c,f,p);let w=this.grid;for(let I=0;I<n.length;I++){let S=n[I],D=[1/0,1/0,-1/0,-1/0];for(let P=0;P<S.length;P++){let O=S[P];D[0]=Math.min(D[0],O.x),D[1]=Math.min(D[1],O.y),D[2]=Math.max(D[2],O.x),D[3]=Math.max(D[3],O.y)}y!==0&&(D[0]-=y,D[1]-=y,D[2]+=y,D[3]+=y),D[0]<st&&D[1]<st&&D[2]>=0&&D[3]>=0&&w.insert(x,D[0],D[1],D[2],D[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new xt(new cv(this.rawTileData)).layers,this.sourceLayerCoder=new VA(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,n){let{tilespaceGeometry:s,transform:c,tileTransform:f,pixelPosMatrix:p,availableImages:y,worldview:x}=n;this.loadVTLayers(),this.serializedLayersCache.clear();let w=s.bufferedTilespaceBounds,I=this.grid.query(w.min.x,w.min.y,w.max.x,w.max.y,(O,F,B,H)=>Oi(s.bufferedTilespaceGeometry,O,F,B,H));I.sort(_z);let S=null;c.elevation&&I.length>0&&(S=cf.create(c.elevation,this.tileID));let D={},P;for(let O=0;O<I.length;O++){let F=I[O];if(F===P)continue;P=F;let B=this.featureIndexArray.get(F),H=null;this.is3DTile?this.loadMatchingModelFeature(D,B,e,s,c,x):this.loadMatchingFeature(D,B,e,y,x,(X,Z,K,de=0)=>(H||(H=pe(X,this.tileID.canonical,f)),Z.queryIntersectsFeature(s,X,K,H,this.z,c,p,S,de)))}return D}loadMatchingFeature(e,n,s,c,f,p){let{featureIndex:y,bucketIndex:x,sourceLayerIndex:w,layoutVertexArrayOffset:I}=n,S=this.bucketLayerIDs[x],D=s.layers,P=Object.keys(D);if(P.length&&!hn(P,S))return;let O=s.sourceCache,F=this.sourceLayerCoder.decode(w),B=this.vtLayers[F].feature(y),H=this.getId(B,F);for(let X=0;X<S.length;X++){let Z=S[X];if(!D[Z])continue;let{styleLayer:K,targets:de}=D[Z],ae={};H!==void 0&&(ae=O.getFeatureState(K.sourceLayer,H));let ce=!p||p(B,K,ae,I);if(!ce)continue;let ge=new ff(B,this.z,this.x,this.y,H);ge.tile=this.tileID.canonical,ge.state=ae;let ye=this.serializedLayersCache.get(Z);ye||(ye=K.serialize(),ye.id=Z,this.serializedLayersCache.set(Z,ye)),ge.source=ye.source,ge.sourceLayer=ye["source-layer"],ge.layer=De({},ye),ge.layer.paint=UA(ye.paint,K.paint,B,ae,c),ge.layer.layout=UA(ye.layout,K.layout,B,ae,c);let ke=!1;for(let be of de){this.updateFeatureProperties(ge,be);let{filter:ze}=be;if(ze){if(B.properties=ge.properties,ze.needGeometry){let et=Pe(B,!0);if(!ze.filter(new Un(this.tileID.overscaledZ,{worldview:f}),et,this.tileID.canonical))continue}else if(!ze.filter(new Un(this.tileID.overscaledZ,{worldview:f}),B))continue}ke=!0,be.targetId&&this.addFeatureVariant(ge,be)}ke&&this.appendToResult(e,Z,y,ge,ce)}}loadMatchingModelFeature(e,n,s,c,f,p){let{featureIndex:y,bucketIndex:x}=n,w=this.bucketLayerIDs[x],I=s.layers,S=Object.keys(I);if(!S.length||hn(S,w))for(let D=0;D<w.length;D++){let P=w[D],{styleLayer:O,targets:F}=I[P];if(O.type!=="model")continue;let B=c.tile,H=B.getBucket(O);if(!(H&&H instanceof Cv))continue;let X=wN(H,y,c,f);if(!X)continue;let{z:Z,x:K,y:de}=B.tileID.canonical,{feature:ae,intersectionZ:ce,position:ge}=X,ye={};ae.id!==void 0&&(ye=s.sourceCache.getFeatureState(O.sourceLayer,ae.id));let ke=new ff({},Z,K,de,ae.id);ke.tile=this.tileID.canonical,ke.state=ye,ke.properties=ae.properties,ke.geometry={type:"Point",coordinates:[ge.lng,ge.lat]};let be=this.serializedLayersCache.get(P);be||(be=O.serialize(),be.id=P,this.serializedLayersCache.set(P,be)),ke.source=be.source,ke.sourceLayer=be["source-layer"],ke.layer=De({},be);let ze=!1;for(let et of F){this.updateFeatureProperties(ke,et);let{filter:Ve}=et;if(Ve){if(ae.properties=ke.properties,Ve.needGeometry){if(!Ve.filter(new Un(this.tileID.overscaledZ,{worldview:p}),ae,this.tileID.canonical))continue}else if(!Ve.filter(new Un(this.tileID.overscaledZ,{worldview:p}),ae))continue}ze=!0,et.targetId&&this.addFeatureVariant(ke,et)}ze&&this.appendToResult(e,P,y,ke,ce)}}updateFeatureProperties(e,n,s){if(n.properties){let c={};for(let f in n.properties){let p=n.properties[f].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);p!=null&&(c[f]=p)}e.properties=c}}addFeatureVariant(e,n,s){let c={target:n.target,namespace:n.namespace,uniqueFeatureID:n.uniqueFeatureID};n.properties&&(c.properties=e.properties),e.variants=e.variants||{},e.variants[n.targetId]=e.variants[n.targetId]||[],e.variants[n.targetId].push(c)}appendToResult(e,n,s,c,f){let p=e[n];p===void 0&&(p=e[n]=[]),p.push({featureIndex:s,feature:c,intersectionZ:f})}lookupSymbolFeatures(e,n,s,c,f,p){let y={};this.loadVTLayers();for(let x of e)this.loadMatchingFeature(y,{bucketIndex:n,sourceLayerIndex:s,featureIndex:x,layoutVertexArrayOffset:0},c,f,p);return y}loadFeature(e){let{featureIndex:n,sourceLayerIndex:s}=e;this.loadVTLayers();let c=this.sourceLayerCoder.decode(s),f=this.vtFeatures[c];if(f[n])return f[n];let p=this.vtLayers[c].feature(n);return f[n]=p,p}hasLayer(e){for(let n of this.bucketLayerIDs)for(let s of n)if(e===s)return!0;return!1}getId(e,n){let s=e.id;if(this.promoteId){let c=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[n];if(c!=null)if(Array.isArray(c)){if(!this.promoteIdExpression){let f=hl(c);if(f.result!=="success"){let p=f.value.map(y=>`${y.key}: ${y.message}`).join(", ");return void fn(`Failed to create expression for promoteId: ${p}`)}this.promoteIdExpression=f.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Ru),s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[c];typeof s=="boolean"&&(s=Number(s))}return s}}function UA(i,e,n,s,c){return Ut(i,(f,p)=>{let y=e instanceof as?e.get(p):null;return y&&y.evaluate?y.evaluate(n,s,void 0,c):y})}function _z(i,e){return e-i}gt(jA,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let HA=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class n1{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[n,s]=new Uint8Array(e,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");let c=s>>4;if(c!==1)throw new Error(`Got v${c} data when expected v1.`);let f=HA[15&s];if(!f)throw new Error("Unrecognized array type.");let[p]=new Uint16Array(e,2,1),[y]=new Uint32Array(e,4,1);return new n1(y,p,f,e)}constructor(e,n=64,s=Float64Array,c){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;let f=HA.indexOf(this.ArrayType),p=2*e*this.ArrayType.BYTES_PER_ELEMENT,y=e*this.IndexArrayType.BYTES_PER_ELEMENT,x=(8-y%8)%8;if(f<0)throw new Error(`Unexpected typed array class: ${s}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+x,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+p+y+x),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+x,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+f]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=e)}add(e,n){let s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=n,s}finish(){let e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return i1(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,n,s,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:f,coords:p,nodeSize:y}=this,x=[0,f.length-1,0],w=[];for(;x.length;){let I=x.pop()||0,S=x.pop()||0,D=x.pop()||0;if(S-D<=y){for(let B=D;B<=S;B++){let H=p[2*B],X=p[2*B+1];H>=e&&H<=s&&X>=n&&X<=c&&w.push(f[B])}continue}let P=D+S>>1,O=p[2*P],F=p[2*P+1];O>=e&&O<=s&&F>=n&&F<=c&&w.push(f[P]),(I===0?e<=O:n<=F)&&(x.push(D),x.push(P-1),x.push(1-I)),(I===0?s>=O:c>=F)&&(x.push(P+1),x.push(S),x.push(1-I))}return w}within(e,n,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:c,coords:f,nodeSize:p}=this,y=[0,c.length-1,0],x=[],w=s*s;for(;y.length;){let I=y.pop()||0,S=y.pop()||0,D=y.pop()||0;if(S-D<=p){for(let B=D;B<=S;B++)GA(f[2*B],f[2*B+1],e,n)<=w&&x.push(c[B]);continue}let P=D+S>>1,O=f[2*P],F=f[2*P+1];GA(O,F,e,n)<=w&&x.push(c[P]),(I===0?e-s<=O:n-s<=F)&&(y.push(D),y.push(P-1),y.push(1-I)),(I===0?e+s>=O:n+s>=F)&&(y.push(P+1),y.push(S),y.push(1-I))}return x}}function i1(i,e,n,s,c,f){if(c-s<=n)return;let p=s+c>>1;$A(i,e,p,s,c,f),i1(i,e,n,s,p-1,1-f),i1(i,e,n,p+1,c,1-f)}function $A(i,e,n,s,c,f){for(;c>s;){if(c-s>600){let w=c-s+1,I=n-s+1,S=Math.log(w),D=.5*Math.exp(2*S/3),P=.5*Math.sqrt(S*D*(w-D)/w)*(I-w/2<0?-1:1);$A(i,e,n,Math.max(s,Math.floor(n-I*D/w+P)),Math.min(c,Math.floor(n+(w-I)*D/w+P)),f)}let p=e[2*n+f],y=s,x=c;for(dg(i,e,s,n),e[2*c+f]>p&&dg(i,e,s,c);y<x;){for(dg(i,e,y,x),y++,x--;e[2*y+f]<p;)y++;for(;e[2*x+f]>p;)x--}e[2*s+f]===p?dg(i,e,s,x):(x++,dg(i,e,x,c)),x<=n&&(s=x+1),n<=x&&(c=x-1)}}function dg(i,e,n,s){r1(i,n,s),r1(e,2*n,2*s),r1(e,2*n+1,2*s+1)}function r1(i,e,n){let s=i[e];i[e]=i[n],i[n]=s}function GA(i,e,n,s){let c=i-n,f=e-s;return c*c+f*f}r.$=fr,r.A=js,r.B=Hs,r.C=pc,r.D=Jh,r.E=il,r.F=2,r.G=Km,r.H=_C,r.I=uo,r.J=_a,r.K=class extends Dv{},r.L=rl,r.M=Ty,r.N=Ch,r.O=Dh,r.P=Xe,r.Q=fy,r.R=vu,r.S=Kp,r.T=yw,r.U=$u,r.V=Dv,r.W=Jp,r.X=hl,r.Y=fh,r.Z=oc,r._=rc,r.a=function(i){return vr.API_CDN_URL_REGEX.test(i)},r.a$=je,r.a0=xp,r.a1=Gu,r.a2=Ah,r.a3=hy,r.a4=function(i){let e=i.value,n=[];if(!e)return n;let s=_a(e);return s!=="string"?(n=n.concat([new Dv(i.key,e,`string expected, "${s}" found`)]),n):(Gw(e,!0)||(n=n.concat([new Dv(i.key,e,`invalid url "${e}"`)])),n)},r.a5=xe,r.a6=Hu,r.a7=Mi,r.a8=tt,r.a9=class{constructor(i){this.specification=i}possiblyEvaluate(i,e){return Ki(i.expression.evaluate(e))}interpolate(i,e,n){return{x:Ct(i.x,e.x,n),y:Ct(i.y,e.y,n),z:Ct(i.z,e.z,n),azimuthal:Ct(i.azimuthal,e.azimuthal,n),polar:Ct(i.polar,e.polar,n)}}},r.aA=co,r.aB=kr,r.aC=Ir,r.aD=z,r.aE=me,r.aF=function(i,e){let n={};for(let s=0;s<e.length;s++){let c=e[s];c in i&&(n[c]=i[c])}return n},r.aG=L,r.aH=U,r.aI=class{constructor(i){this.entries={},this.scheduler=i}request(i,e,n,s){let c=this.entries[i]=this.entries[i]||{callbacks:[]};if(c.result){let[f,p]=c.result;return this.scheduler?this.scheduler.add(()=>{s(f,p)},e):s(f,p),()=>{}}return c.callbacks.push(s),c.cancel||(c.cancel=n((f,p)=>{c.result=[f,p];for(let y of c.callbacks)this.scheduler?this.scheduler.add(()=>{y(f,p)},e):y(f,p);setTimeout(()=>delete this.entries[i],3e3)})),()=>{c.result||(c.callbacks=c.callbacks.filter(f=>f!==s),c.callbacks.length||(c.cancel(),delete this.entries[i]))}}},r.aJ=function(i,e,n){let s=JSON.stringify(i.request);return i.data&&(this.deduped.entries[s]={result:[null,i.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:i.isSymbolTile,zoom:i.tileZoom},c=>{let f=xu(i.request,(p,y,x,w)=>{p?c(p):y&&c(null,{vectorTile:n?void 0:new xt(new cv(y)),rawData:y,cacheControl:x,expires:w})});return()=>{f.cancel(),c()}},e)},r.aK=function(i){mp++,mp>Vs&&(i.getActor().send("enforceCacheSizeLimit",os),mp=0)},r.aL=function(i){return i<=1?1:Math.pow(2,Math.floor(Math.log(i)/Math.LN2))},r.aM=er,r.aN=qC,r.aO=JC,r.aP=GC,r.aQ=function(i,e){let n=document.createElement("video");n.muted=!0,n.onloadstart=function(){e(null,n)};for(let s=0;s<i.length;s++){let c=document.createElement("source");db(i[s])||(n.crossOrigin="Anonymous"),c.src=i[s],n.appendChild(c)}return{cancel:()=>{}}},r.aR=Gm,r.aS=function(i){return fetch(i).then(e=>e.arrayBuffer()).then(e=>ED(e,0,i))},r.aT=RD,r.aU=class{constructor(i,e,n,s){this.id=i,this.position=e!=null?new A(e[0],e[1]):new A(0,0),this.orientation=n??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(i,e){if(Vt(i.matrix,e,i.matrix),i.meshes)for(let n of i.meshes){let s=sn.applyTransformFast(n.aabb,i.matrix);this.aabb.encapsulate(s)}if(i.children)for(let n of i.children)this._applyTransformations(n,i.matrix)}computeBoundsAndApplyParent(){let i=Fe([]);for(let e of this.nodes)this._applyTransformations(e,i)}computeModelMatrix(i,e,n,s,c,f,p=!1){AD(this.matrix,this,i.transform,this.position,e,n,s,c,f,p)}upload(i){if(!this.uploaded){for(let e of this.nodes)bw(e,i);for(let e of this.nodes)lv(e);this.uploaded=!0}}destroy(){for(let i of this.nodes)ww(i)}},r.aV=Ft,r.aW=eg,r.aX=W,r.aY=Y,r.aZ=gc,r.a_=di,r.aa=Un,r.ab=Sa,r.ac=se,r.ad=Ni,r.ae=Er,r.af=_e,r.ag=as,r.ah=Dc,r.ai=Ct,r.aj=st,r.ak=j_,r.al=Sn,r.am=Ln,r.an=class{constructor(i){this.specification=i}possiblyEvaluate(i,e){return function([n,s]){let c=Ki([1,n,s]);return{x:c.x,y:c.y,z:c.z}}(i.expression.evaluate(e))}interpolate(i,e,n){return{x:Ct(i.x,e.x,n),y:Ct(i.y,e.y,n),z:Ct(i.z,e.z,n)}}},r.ao=function(i,e,n=0,s=!0){let c=new Xe(n,n),f=i.sub(c),p=e.add(c),y=[f,new Xe(p.x,f.y),p,new Xe(f.x,p.y)];return s&&y.push(f.clone()),y},r.ap=function(i,e){let n=[];for(let s=0;s<i.length;s++){let c=Ae(s-1,-1,i.length-1),f=Ae(s+1,-1,i.length-1),p=i[s],y=i[f],x=i[c].sub(p).unit(),w=y.sub(p).unit(),I=w.angleWithSep(x.x,x.y),S=x.add(w).unit().mult(-1*e/Math.sin(I/2));n.push(p.add(S))}return n},r.aq=RC,r.ar=Oi,r.as=function(i,e,n=0){return Wi(((e.x-n)*i.scale-i.x)*st,(e.y*i.scale-i.y)*st,J(e.z,e.y))},r.at=zi,r.au=ci,r.av=wn,r.aw=UD,r.ax=function(i){let e=1/0,n=1/0,s=-1/0,c=-1/0;for(let f of i)e=Math.min(e,f.x),n=Math.min(n,f.y),s=Math.max(s,f.x),c=Math.max(c,f.y);return{min:new Xe(e,n),max:new Xe(s,c)}},r.ay=ne,r.az=Vt,r.b=function(i){return vr.API_FONTS_REGEX.test(i)},r.b$=Fw,r.b0=Cy,r.b1=Ev,r.b2=function(){bs.isLoading()||bs.isLoaded()||om()!=="deferred"||by()},r.b3=hc,r.b4=Pe,r.b5=ff,r.b6=An,r.b7=Iw,r.b8=iw,r.b9=pe,r.bA=function(i,e){let{x:n,y:s}=i.point,c=dS(n,s,i.worldSize/i._pixelsPerMercatorPixel,0,0);return Vt(c,c,Wb(La(e)))},r.bB=G,r.bC=ou,r.bD=function(i,e){return Math.hypot(e[0]-i[0],e[1]-i[1],e[2]-i[2])},r.bE=zr,r.bF=Zi,r.bG=Fi,r.bH=Ym,r.bI=No,r.bJ=Pw,r.bK=function(i,e,n,s,c){let f=5*e+2;i.float32[f+0]=n,i.float32[f+1]=s,i.float32[f+2]=c},r.bL=wv,r.bM=Eo,r.bN=ha,r.bO=da,r.bP=To,r.bQ=Ae,r.bR=function(i,e,n,s){var c=new N(4);return c[0]=i,c[1]=e,c[2]=n,c[3]=s,c},r.bS=ev,r.bT=qn,r.bU=gr,r.bV=US,r.bW=QC,r.bX=qS,r.bY=sw,r.bZ=Rw,r.b_=TC,r.ba=ro,r.bb=vm,r.bc=oS,r.bd=gi,r.be=Yh,r.bf=Hw,r.bg=function(i,e){let n=Dc(e.zoom);if(n===0)return La(i);let s=Hy(i),c=qb(s),f=z(s.getWest())*e.worldSize,p=z(s.getEast())*e.worldSize,y=U(s.getNorth())*e.worldSize,x=U(s.getSouth())*e.worldSize,w=[f,y,0],I=[p,y,0],S=[f,x,0],D=[p,x,0],P=Pt([],e.globeMatrix);return Ni(w,w,P),Ni(I,I,P),Ni(S,S,P),Ni(D,D,P),c[0]=vl(c[0],S,n),c[1]=vl(c[1],D,n),c[2]=vl(c[2],I,n),c[3]=vl(c[3],w,n),sn.fromPoints(c)},r.bh=Gy,r.bi=Pt,r.bj=Am,r.bk=vl,r.bl=mc,r.bm=XL,r.bn=_s,r.bo=jt,r.bp=kv,r.bq=cv,r.br=xu,r.bs=function(i,e){let n=[];for(let s in i)s in e||n.push(s);return n},r.bt=ve,r.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],r.bv=zs,r.bw=function(i){var e=new N(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e},r.bx=Fe,r.by=Ri,r.bz=bt,r.c=Zd,r.c$=45,r.c0=n1,r.c1=hi,r.c2=ua,r.c3=ks,r.c4=function(i,e,n){n*=.5;var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x+c*y,i[1]=c*x-s*y,i[2]=f*x+p*y,i[3]=p*x-f*y,i},r.c5=Ka,r.c6=bi,r.c7=function(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i[3]=e[3],i},r.c8=ys,r.c9=function(i,e,n,s,c){var f,p=1/Math.tan(e/2);return i[0]=p/n,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=p,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,c!=null&&c!==1/0?(i[10]=(c+s)*(f=1/(s-c)),i[14]=2*c*s*f):(i[10]=-1,i[14]=-2*s),i},r.cA=Lo,r.cB=lS,r.cC=function(i,e,n,s,c,f,p,y,x){if(x.name==="globe")return lS(i,e,new Lo(n,s,c),!1);let w=eg({z:n,x:s,y:c},x);return new sn([(f+w.x/w.scale)*e,e*(w.y/w.scale),p],[(f+w.x2/w.scale)*e,e*(w.y2/w.scale),y])},r.cD=function(i,e,n){return i[0]=Math.min(e[0],n[0]),i[1]=Math.min(e[1],n[1]),i[2]=Math.min(e[2],n[2]),i[3]=Math.min(e[3],n[3]),i},r.cE=function(i,e,n){return i[0]=Math.max(e[0],n[0]),i[1]=Math.max(e[1],n[1]),i[2]=Math.max(e[2],n[2]),i[3]=Math.max(e[3],n[3]),i},r.cF=function(i){let e=Math.round((i+45+360)%360/90)%4;return $[e]},r.cG=ie,r.cH=Os,r.cI=u,r.cJ=function(i){let e=Fe(new Float64Array(16));Vt(e,i.pixelMatrix,i.globeMatrix);let n=[0,g,0],s=[0,_,0];return Ni(n,n,e),Ni(s,s,e),[n[0]>0&&n[0]<=i.width&&n[1]>0&&n[1]<=i.height&&!Xb(i,new A(i.center.lat,90)),s[0]>0&&s[0]<=i.width&&s[1]>0&&s[1]<=i.height&&!Xb(i,new A(i.center.lat,-90))]},r.cK=function(i,e){let{scale:n}=i.tileTransform,s=n*st/(i.tileSize*Math.pow(2,e.zoom-i.tileID.overscaledZ+i.tileID.canonical.z));return function(c,f,p){var y=f[1],x=f[2],w=f[3],I=p[0],S=p[1];return c[0]=f[0]*I,c[1]=y*I,c[2]=x*S,c[3]=w*S,c}(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},r.cL=sv,r.cM=qd,r.cN=TD,r.cO=function(i){let e=TD(i,!0);return G([],[e[0],e[1],e[4],e[5]])},r.cP=Nt,r.cQ=Dn,r.cR=ar,r.cS=function(i){let{x:e,y:n}=i.point,{lng:s,lat:c}=i._center;return dS(e,n,i.worldSize,s,c)},r.cT=ru,r.cU=Se,r.cV=ko,r.cW=Si,r.cX=Vy,r.cY=function(i,e,n){let s=0;for(let c=0;c<2;++c)i[c]>0&&(s+=(i[c]-0)*(i[c]-0)),e[c]<0&&(s+=(0-e[c])*(0-e[c]));return s},r.cZ=function(i){return i*i*i*i*i},r.c_=V,r.ca=function(i,e,n,s,c,f,p){var y=1/(e-n),x=1/(s-c),w=1/(f-p);return i[0]=-2*y,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*x,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*w,i[11]=0,i[12]=(e+n)*y,i[13]=(c+s)*x,i[14]=(p+f)*w,i[15]=1,i},r.cb=j,r.cc=function(i,e,n){i[4*e+0]=n[0],i[4*e+1]=n[1],i[4*e+2]=n[2],i[4*e+3]=n[3]},r.cd=Xh,r.ce=Ec,r.cf=Hi,r.cg=Ts,r.ch=Qu,r.ci=A,r.cj=FC,r.ck=function(){var i=new N(4);return N!=Float32Array&&(i[1]=0,i[2]=0),i[0]=1,i[3]=1,i},r.cl=function(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x+f*y,i[1]=c*x+p*y,i[2]=s*-y+f*x,i[3]=c*-y+p*x,i},r.cm=function(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]&&i[3]===e[3]},r.cn=Go,r.co=function(i){return Math.hypot(i[0],i[1],i[2],i[3])},r.cp=Fs,r.cq=ca,r.cr=Is,r.cs=3,r.ct=2,r.cu=7,r.cv=6,r.cw=Yr,r.cx=Nn,r.cy=Mn,r.cz=ID,r.d=function(i){return vr.API_TILEJSON_REGEX.test(i)},r.d$=(i,e,n,s,c,f,p,y,x,w)=>{let I=i.transform,S=I.calculatePixelsToTileUnitsMatrix(e),D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none",P=I.pitch<15?HD(.07,.7,ne((14-I.zoom)/5,0,1)):.07;return{u_matrix:GD(i,e,n,s),u_pixels_to_tile_units:S,u_device_pixel_ratio:f,u_width_scale:p,u_floor_width_scale:y,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:c,u_texsize:WD(n)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:$D(e,i.transform),u_alpha_discard_threshold:0,u_trim_offset:x,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:P,u_tile_to_meter:oe(e.tileID.canonical,0),u_ground_shadow_factor:w}},r.d0=Ju,r.d1=function(i,e,n){let s=Math.sqrt(i*i+e*e+n*n),c=s>0?Math.acos(n/s)*du:0,f=i!==0||e!==0?Math.atan2(-e,-i)*du+90:0;return f<0&&(f+=360),[s,f,c]},r.d2=Wi,r.d3=Ki,r.d4=oe,r.d5=pi,r.d6=sn,r.d7=lo,r.d8=function(i){return[Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)]},r.d9=Gw,r.dA=Hy,r.dB=function(i){let e=ie-5;i=ne(i,-e,e)/e*90;let n=Math.pow(Math.abs(Math.sin(Sn(i))),3);return Math.round(n*(h.length-1))},r.dC=function(i,e,n,s){let c=e.getNorth(),f=e.getSouth(),p=e.getWest(),y=e.getEast(),x=1<<i.z,w=y-p,I=c-f,S=w/o,D=-I/h[n],P=[0,S,0,D,0,0,c,p,0];if(i.z>0){let O=180/s;Ue(P,P,[O/w+1,0,0,0,O/I+1,0,-.5*O/S,.5*O/D,1])}return P[2]=x,P[5]=i.x,P[8]=i.y,P},r.dD=La,r.dE=function(i,e,n){let s=Fe(new Float64Array(16)),c=(e/(1<<i)-.5)*Math.PI*2;return lr(s,n.globeMatrix,c),Float32Array.from(s)},r.dF=class{isDataAvailableAtPoint(i){let e=this._source();if(this.isUsingMockSource()||!e||i.y<0||i.y>1)return!1;let n=e.getSource().maxzoom,s=1<<n,c=Math.floor(i.x),f=Math.floor((i.x-c)*s),p=Math.floor(i.y*s),y=this.findDEMTileFor(new er(n,c,n,f,p));return!(!y||!y.dem)}getAtPointOrZero(i,e=0){return this.getAtPoint(i,e)||0}getAtPoint(i,e,n=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);let s=this._source();if(!s||i.y<0||i.y>1)return e;let c=s.getSource().maxzoom,f=1<<c,p=Math.floor(i.x),y=i.x-p,x=new er(c,p,c,Math.floor(y*f),Math.floor(i.y*f)),w=this.findDEMTileFor(x);if(!w||!w.dem)return e;let I=w.dem,S=1<<w.tileID.canonical.z,D=(y*S-w.tileID.canonical.x)*I.dim,P=(i.y*S-w.tileID.canonical.y)*I.dim,O=Math.floor(D),F=Math.floor(P);return(n?this.exaggeration():1)*Ct(Ct(I.get(O,F),I.get(O,F+1),P-F),Ct(I.get(O+1,F),I.get(O+1,F+1),P-F),D-O)}getAtTileOffset(i,e,n){let s=1<<i.canonical.z;return this.getAtPointOrZero(new se(i.wrap+(i.canonical.x+e/st)/s,(i.canonical.y+n/st)/s))}getAtTileOffsetFunc(i,e,n,s){return c=>{let f=this.getAtTileOffset(i,c.x,c.y),p=s.upVector(i.canonical,c.x,c.y);return hi(p,p,f*s.upVectorScale(i.canonical,e,n).metersToTile),p}}getForTilePoints(i,e,n,s){if(this.isUsingMockSource())return!1;let c=cf.create(this,i,s);return!!c&&(e.forEach(f=>{f[2]=this.exaggeration()*c.getElevationAt(f[0],f[1],n)}),!0)}getMinMaxForTile(i){if(this.isUsingMockSource())return null;let e=this.findDEMTileFor(i);if(!e||!e.dem)return null;let n=e.dem.tree,s=e.tileID,c=1<<i.canonical.z-s.canonical.z,f=i.canonical.x/c-s.canonical.x,p=i.canonical.y/c-s.canonical.y,y=0;for(let x=0;x<i.canonical.z-s.canonical.z&&!n.leaves[y];x++){f*=2,p*=2;let w=2*Math.floor(p)+Math.floor(f);y=n.childOffsets[y]+w,f%=1,p%=1}return{min:this.exaggeration()*n.minimums[y],max:this.exaggeration()*n.maximums[y]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(i,e,n){throw new Error("Pure virtual method called.")}pointCoordinate(i){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(i){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let i=this.visibleDemTiles;if(i.length===0)return null;let e=!1,n=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let c of i){let f=this.getMinMaxForTile(c.tileID);f&&(n=Math.min(n,f.min),s=Math.max(s,f.max),e=!0)}return e?{min:n,max:s}:null}},r.dG=TS,r.dH=Uy,r.dI=function(i,e){return[Math.pow(i[0],2.2)*e,Math.pow(i[1],2.2)*e,Math.pow(i[2],2.2)*e]},r.dJ=fe,r.dK=function(i,e){var n=Math.sin(e),s=Math.cos(e);return i[0]=s,i[1]=n,i[2]=0,i[3]=-n,i[4]=s,i[5]=0,i[6]=0,i[7]=0,i[8]=1,i},r.dL=la,r.dM=uS,r.dN=Qr,r.dO=Rr,r.dP=256,r.dQ=function(i,e){let n=[0,0,0];return Ni(n,n,Gy(La(e.canonical))),Ni(n,n,i),n},r.dR=i=>({u_matrix:new Qu(i),u_texsize:new Ts(i),u_pixels_to_tile_units:new Dm(i),u_device_pixel_ratio:new Hi(i),u_width_scale:new Hi(i),u_floor_width_scale:new Hi(i),u_image:new Xh(i),u_units_to_pixels:new Ts(i),u_tile_units_to_pixels:new Hi(i),u_alpha_discard_threshold:new Hi(i),u_trim_offset:new Ts(i),u_trim_fade_range:new Ts(i),u_trim_color:new Ju(i),u_emissive_strength:new Hi(i),u_zbias_factor:new Hi(i),u_tile_to_meter:new Hi(i),u_ground_shadow_factor:new Ec(i),u_pattern_transition:new Hi(i)}),r.dS=i=>({u_matrix:new Qu(i),u_pixels_to_tile_units:new Dm(i),u_device_pixel_ratio:new Hi(i),u_width_scale:new Hi(i),u_floor_width_scale:new Hi(i),u_units_to_pixels:new Ts(i),u_dash_image:new Xh(i),u_gradient_image:new Xh(i),u_image_height:new Hi(i),u_texsize:new Ts(i),u_tile_units_to_pixels:new Hi(i),u_alpha_discard_threshold:new Hi(i),u_trim_offset:new Ts(i),u_trim_fade_range:new Ts(i),u_trim_color:new Ju(i),u_emissive_strength:new Hi(i),u_zbias_factor:new Hi(i),u_tile_to_meter:new Hi(i),u_ground_shadow_factor:new Ec(i)}),r.dT=i=>({u_camera_to_center_distance:new Hi(i),u_extrude_scale:new Dm(i),u_device_pixel_ratio:new Hi(i),u_matrix:new Qu(i),u_inv_rot_matrix:new Qu(i),u_merc_center:new Ts(i),u_tile_id:new Ec(i),u_zoom_transition:new Hi(i),u_up_dir:new Ec(i),u_emissive_strength:new Hi(i)}),r.dU=vc,r.dV=MF,r.dW=pS,r.dX=(i,e,n,s,c,f)=>{let p=i.transform,y=p.projection.name==="globe",x;if(f.paint.get("circle-pitch-alignment")==="map")if(y){let I=uS(p.zoom,e.canonical)*p._pixelsPerMercatorPixel;x=Float32Array.from([I,0,0,I])}else x=p.calculatePixelsToTileUnitsMatrix(n);else x=new Float32Array([p.pixelsToGLUnits[0],0,0,p.pixelsToGLUnits[1]]);let w={u_camera_to_center_distance:i.transform.getCameraToCenterDistance(p.projection),u_matrix:i.translatePosMatrix(e.projMatrix,n,f.paint.get("circle-translate"),f.paint.get("circle-translate-anchor")),u_device_pixel_ratio:rs.devicePixelRatio,u_extrude_scale:x,u_inv_rot_matrix:ek,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:f.paint.get("circle-emissive-strength")};if(y){w.u_inv_rot_matrix=s,w.u_merc_center=c,w.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],w.u_zoom_transition=Dc(p.zoom);let I=c[0]*st,S=c[1]*st;w.u_up_dir=p.projection.upVector(new Lo(0,0,0),I,S)}return w},r.dY=qD,r.dZ=to,r.d_=(i,e,n,s,c,f,p,y,x,w)=>{let I=i.transform,S=I.pitch<15?HD(.07,.7,ne((14-I.zoom)/5,0,1)):.07,D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:GD(i,e,n,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:I.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:c,u_width_scale:f,u_floor_width_scale:p,u_image:0,u_tile_units_to_pixels:$D(e,I),u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:y,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:S,u_tile_to_meter:oe(e.tileID.canonical,0),u_ground_shadow_factor:x,u_pattern_transition:w}},r.da=function(i,e){return i.readFields(IN,{icons:[]},e)},r.db=nv,r.dc=sf,r.dd=Lw,r.de=Jd,r.df=xy,r.dg=qo,r.dh=Zl,r.di=rn,r.dj=function(i){let e=i.indexOf(qu);return e>=0?i.slice(0,e):i},r.dk=function(i){return i.indexOf(qu)>=0},r.dl=function(i){let e=i.lastIndexOf(qu);return e>=0?i.slice(e+1):""},r.dm=function(i){let e=[],n=i.id;return n===void 0&&e.push({message:`layers.${n}: missing required property "id"`}),i.render===void 0&&e.push({message:`layers.${n}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&e.push({message:`layers.${n}: property "renderingMode" must be either "2d" or "3d"`}),e},r.dn=function(i,e,n,s){return i.type==="custom"?new vN(i,e):new EN[i.type](i,e,n,s)},r.dp=dn,r.dq=function(i){let e=i.indexOf(qu);return e>=0?i.slice(e+1):""},r.dr=class extends ff{constructor(i,e){super(i._vectorTileFeature,i._z,i._x,i._y,i.id),i.state&&(this.state=Object.assign({},i.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=i.source,this.sourceLayer=i.sourceLayer,this.layer=i.layer)}toJSON(){let i=super.toJSON();return i.target=this.target,i.namespace=this.namespace,i}},r.ds=rm,r.dt=ql,r.du=function(i){return i({pluginStatus:jr,pluginURL:Ca}),rm.on("pluginStateChange",i),i},r.dv=Sm,r.dw=class extends Ko{constructor(i){super(i),this.current=Vb}set(i,e,n){if(this.fetchUniformLocation(i,e)){for(let s=0;s<9;s++)if(n[s]!==this.current[s]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}},r.dx=q,r.dy=function(i,e,n){let s=Dc(n.zoom),c=i.style.map._antialias,f=i.terrain&&i.terrain.exaggeration()>0;return s===0&&!c&&!f},r.dz=function(i){let e=i.pixelsPerMeter,n=e/j(1,i.center.lat),s=Fe(new Float64Array(16));return jt(s,s,[i.point.x,i.point.y,0]),Nt(s,s,[n,n,e]),Float32Array.from(s)},r.e=vr,r.e$=om,r.e0=Dt,r.e1=Mm,r.e2=J,r.e3=yl,r.e4=Qy,r.e5=rD,r.e6=Ac,r.e7=450,r.e8=7,r.e9=ue,r.eA=function(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,F){var B=new N(16);return B[0]=i,B[1]=e,B[2]=n,B[3]=s,B[4]=c,B[5]=f,B[6]=p,B[7]=y,B[8]=x,B[9]=w,B[10]=I,B[11]=S,B[12]=D,B[13]=P,B[14]=O,B[15]=F,B},r.eB=T,r.eC=_m,r.eD=Zu,r.eE=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Xe(1/0,1/0),max:new Xe(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(i,e=!1){let n=$S(new Xe(0,0),new Xe(st,st),i),s=[];if(e&&!rw(n,this._globalClipBounds))return s;for(let c of this._activeRegions){if(c.hiddenByOverlap||!rw(n,c))continue;let f=Ck(c.min,c.max,i);s.push({min:f.min,max:f.max,sourceId:this._sourceIds[c.priority],footprint:c.footprint,footprintTileId:c.tileId,order:c.order,clipMask:c.clipMask,clipScope:c.clipScope})}return s}setSources(i){this._setSources(i.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{let n=[];for(let s of e.cache.getVisibleCoordinates()){let c=e.cache.getTile(s).buckets[e.layer];c&&c.updateFootprints(s.toUnwrapped(),n)}return n},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(i){let e=i.getFootprints();if(e.length===0)return;let n=i.getOrder(),s=i.getClipMask(),c=i.getClipScope();for(let f of e){if(!f.footprint)continue;let p=$S(f.footprint.min,f.footprint.max,f.id);this._activeRegions.push({min:p.min,max:p.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:f.id,footprint:f.footprint,order:n,clipMask:s,clipScope:c})}this._sourceIds.push(i.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,n)=>e.priority-n.priority||Yy(e.min,n.min)||Yy(e.max,n.max)||e.order-n.order||e.clipMask-n.clipMask||function(s,c){let f=(p,y)=>p+y;return s.length-c.length||s.reduce(f,"").localeCompare(c.reduce(f,""))}(e.clipScope,n.clipScope));let i=this._activeRegions.length!==this._prevRegions.length;if(!i){let e=0;for(;!i&&e!==this._activeRegions.length;){let n=this._activeRegions[e],s=this._prevRegions[e];i=n.priority!==s.priority||!HS(n,s)||n.order!==s.order||n.clipMask!==s.clipMask||!zs(n.clipScope,s.clipScope),++e}}if(i){++this._updateTime;for(let n of this._activeRegions)n.order!==Fm&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,n.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,n.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,n.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,n.max.y));let e=n=>{let s=this._activeRegions;if(n>=s.length)return n;let c=s[n].priority;for(;n<s.length&&s[n].priority===c;)++n;return n};if(this._sourceIds.length>1){let n=0,s=e(n);for(;n!==s;){let c=n,f=n;for(;c!==s;){let p=this._activeRegions[c];p.hiddenByOverlap=!1;for(let y=0;y<f;y++){let x=this._activeRegions[y];if(!x.hiddenByOverlap&&p.order===Fm&&rw(p,x)&&(p.hiddenByOverlap=GS(p.footprint,p.tileId,x.footprint,x.tileId),p.hiddenByOverlap))break}++c}n=s,s=e(n)}}}}_setSources(i){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=i.length-1;e>=0;e--)this._addSource(i[e]);this._computeReplacement()}},r.eF=Fm,r.eG=class{constructor(i){this._createGrid(i),this._createPoles(i)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let i of this._poleSegments)i.destroy();for(let i of this._gridSegments)i.withSkirts.destroy(),i.withoutSkirts.destroy()}_fillGridMeshWithLods(i,e){let n=new ro,s=new di,c=[],f=i+1+2,p=e[0]+1,y=e[0]+1+(1+e.length),x=(w,I,S)=>{let D=w===f-1?w-2:w===0?w:w-1;return D+=S?24575:0,[D,I]};for(let w=0;w<f;++w)n.emplaceBack(...x(w,0,!0));for(let w=0;w<p;++w)for(let I=0;I<f;++I)n.emplaceBack(...x(I,w,(I===0||I===f-1)&&!0));for(let w=0;w<e.length;++w){let I=e[w];for(let S=0;S<f;++S)n.emplaceBack(...x(S,I,!0))}for(let w=0;w<e.length;++w){let I=s.length,S=e[w]+1+2,D=new di;for(let F=0;F<S-1;F++){let B=F===S-2,H=B?f*(y-e.length+w-F):f;for(let X=0;X<f-1;X++){let Z=F*f+X;F===0||B||X===0||X===f-2?(D.emplaceBack(Z+1,Z,Z+H),D.emplaceBack(Z+H,Z+H+1,Z+1)):(s.emplaceBack(Z+1,Z,Z+H),s.emplaceBack(Z+H,Z+H+1,Z+1))}}let P=gi.simpleSegment(0,I,n.length,s.length-I);for(let F=0;F<D.uint16.length;F+=3)s.emplaceBack(D.uint16[F],D.uint16[F+1],D.uint16[F+2]);let O=gi.simpleSegment(0,I,n.length,s.length-I);c.push({withoutSkirts:P,withSkirts:O})}return{vertices:n,indices:s,segments:c}}_createGrid(i){let e=this._fillGridMeshWithLods(o,h);this._gridSegments=e.segments,this._gridBuffer=i.createVertexBuffer(e.vertices,oS.members),this._gridIndexBuffer=i.createIndexBuffer(e.indices,!0)}_createPoles(i){let e=new di;for(let p=0;p<=o;p++)e.emplaceBack(0,p+1,p+2);this._poleIndexBuffer=i.createIndexBuffer(e,!0);let n=new gl,s=new gl,c=new gl,f=new gl;this._poleSegments=[];for(let p=0,y=0;p<Vy;p++){let x=360/(1<<p);n.emplaceBack(0,-kr,0,.5,0),s.emplaceBack(0,-kr,0,.5,1),c.emplaceBack(0,-kr,0,.5,.5),f.emplaceBack(0,-kr,0,.5,.5);for(let w=0;w<=o;w++){let I=w/o,S=0,D=Ct(0,x,I),[P,O,F]=v(JL,QL,D,kr);n.emplaceBack(P,O,F,I,S),s.emplaceBack(P,O,F,I,1-S);let B=Sn(D);I=.5+.5*Math.sin(B),S=.5+.5*Math.cos(B),c.emplaceBack(P,O,F,I,S),f.emplaceBack(P,O,F,I,1-S)}this._poleSegments.push(gi.simpleSegment(y,0,66,64)),y+=66}this._poleNorthVertexBuffer=i.createVertexBuffer(n,jy,!1),this._poleSouthVertexBuffer=i.createVertexBuffer(s,jy,!1),this._texturedPoleNorthVertexBuffer=i.createVertexBuffer(c,jy,!1),this._texturedPoleSouthVertexBuffer=i.createVertexBuffer(f,jy,!1)}getGridBuffers(i,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[i].withSkirts:this._gridSegments[i].withoutSkirts]}getPoleBuffers(i,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[i]]}},r.eH=jS,r.eI=te,r.eJ=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},r.eK=he,r.eL=re,r.eM=function(i,e,n){return i[0]=e[0]/n[0],i[1]=e[1]/n[1],i[2]=e[2]/n[2],i},r.eN=Kr,r.eO=E,r.eP=Wd,r.eQ=Ui,r.eR=function([i,e,n]){let s=Math.hypot(i,e,n),c=Math.atan2(i,n),f=.5*Math.PI-Math.acos(-e/s);return new A(Se(c),Se(f))},r.eS=bo,r.eT=vw,r.eU=function(i){let e=i.navigator?i.navigator.userAgent:null;return!!function(n){if(Ai==null){let s=n.navigator?n.navigator.userAgent:null;Ai=!!n.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Ai}(i)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},r.eV=function(i,e){os=i,Vs=e},r.eW=Xb,r.eX=hS,r.eY=function(i){let e=[0,0,0],n=Fe(new Float64Array(16));return Vt(n,i.pixelMatrix,i.globeMatrix),Ni(e,e,n),new Xe(e[0],e[1])},r.eZ=function(){let i=Um;i&&(i.isPreloaded()&&i.numActive()===1?(i.release(dw),Um=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},r.e_=function(){nv().acquire(dw)},r.ea=function(i,e){if(i===e){var n=e[1],s=e[2],c=e[3],f=e[6],p=e[7],y=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=n,i[6]=e[9],i[7]=e[13],i[8]=s,i[9]=f,i[11]=e[14],i[12]=c,i[13]=p,i[14]=y}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i},r.eb=yN,r.ec=gn,r.ed=xm,r.ee=256,r.ef=Wb,r.eg=Ao,r.eh=lr,r.ei=function(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[4],i[4]=e[5],i[5]=e[6],i[6]=e[8],i[7]=e[9],i[8]=e[10],i},r.ej=gl,r.ek=gm,r.el=cy,r.em=function(i,e,n,s,c){return ne((i-e)/(n-e)*(c-s)+s,s,c)},r.en=Vl,r.eo=function(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=e[4],y=e[5],x=e[6],w=e[7],I=e[8],S=I*p-y*w,D=-I*f+y*x,P=w*f-p*x,O=n*S+s*D+c*P;return O?(i[0]=S*(O=1/O),i[1]=(-I*s+c*w)*O,i[2]=(y*s-c*p)*O,i[3]=D*O,i[4]=(I*n-c*x)*O,i[5]=(-y*n+c*f)*O,i[6]=P*O,i[7]=(-w*n+s*x)*O,i[8]=(p*n-s*f)*O,i):null},r.ep=2,r.eq=aa,r.er=xw,r.es=[1,1,1],r.et=class{constructor(i,e,n,s){this.context=i,this.format=s,this.size=n,this.texture=i.gl.createTexture();let[c,f,p]=this.size,{gl:y}=i;y.bindTexture(y.TEXTURE_3D,this.texture),i.pixelStoreUnpackFlipY.set(!1),i.pixelStoreUnpack.set(1),i.pixelStoreUnpackPremultiplyAlpha.set(!1),y.texImage3D(y.TEXTURE_3D,0,this.format,c,f,p,0,gw(this.format),_w(this.format),e.data)}bind(i,e){let{context:n}=this,{gl:s}=n;s.bindTexture(s.TEXTURE_3D,this.texture),i!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,i),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,i),this.minFilter=i),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){let{gl:i}=this.context;i.deleteTexture(this.texture),this.texture=null}},r.eu=cf,r.ev=su,r.ew=function(i,e,n,s){var c=e[0],f=e[1],p=e[2],y=e[3];return i[0]=c+s*(n[0]-c),i[1]=f+s*(n[1]-f),i[2]=p+s*(n[2]-p),i[3]=y+s*(n[3]-y),i},r.ex=nf,r.ey=Es,r.ez=Pa,r.f=function(i){return btoa(encodeURIComponent(i).replace(/%([0-9A-F]{2})/g,(e,n)=>String.fromCharCode(+("0x"+n))))},r.f0=function(i,e,n=!1){if(jr===fo.deferred||jr===fo.loading||jr===fo.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ca=rs.resolveURL(i),jr=fo.deferred,nm=e,im(),n||by()},r.f1=function(i){Qh=rs.resolveURL(i),ef||(ef=new Jh(nv(),new il)),ef.broadcast("setMeshoptUrl",Qh)},r.f2=_D,r.f3=function(i){fw=rs.resolveURL(i),ef||(ef=new Jh(nv(),new il)),ef.broadcast("setDracoUrl",fw)},r.f4=gD,r.f5=jm,r.f6=function(i){let e=Qa();if(!e)return;let n=e.delete(Bs);i&&n.then(()=>i()).catch(i)},r.f7=tv,r.f8=gt,r.f9=Cc,r.fa=Ws,r.fb=VA,r.fc=jA,r.fd=BD,r.fe=dt,r.ff="hd_road_elevation",r.fg=_i,r.fh=Ut,r.fi=nd,r.fj=Ow,r.fk=sd,r.fl=function(i,e,n,s,c,f,p,y=1,x,w,I){i.createArrays(),i.tilePixelRatio=st/(512*i.overscaling),i.compareText={},i.iconsNeedLinear=!1;let S=i.layers[0].layout,D=i.layers[0]._unevaluatedLayout._values,P={};P.scaleFactor=y,P.textSizeScaleRange=S.get("text-size-scale-range"),P.iconSizeScaleRange=S.get("icon-size-scale-range");let[O,F]=P.textSizeScaleRange,[B,H]=P.iconSizeScaleRange;P.textScaleFactor=ne(P.scaleFactor,O,F),P.iconScaleFactor=ne(P.scaleFactor,B,H);let X=D["text-size"],Z=D["icon-size"];if(i.textSizeData.kind==="composite"){let{minZoom:ye,maxZoom:ke}=i.textSizeData;P.compositeTextSizes=[X.possiblyEvaluate(new Un(ye,{worldview:I}),f),X.possiblyEvaluate(new Un(ke,{worldview:I}),f)]}if(i.iconSizeData.kind==="composite"){let{minZoom:ye,maxZoom:ke}=i.iconSizeData;P.compositeIconSizes=[Z.possiblyEvaluate(new Un(ye,{worldview:I}),f),Z.possiblyEvaluate(new Un(ke,{worldview:I}),f)]}P.layoutTextSize=X.possiblyEvaluate(new Un(p+1,{worldview:I}),f),P.layoutIconSize=Z.possiblyEvaluate(new Un(p+1,{worldview:I}),f),P.textMaxSize=X.possiblyEvaluate(new Un(18,{worldview:I}),f);let K=S.get("symbol-placement"),de=S.get("text-rotation-alignment")==="map"&&K!=="point",ae=S.get("text-size"),ce=!1,ge=[];for(let ye of i.features){let ke=S.get("text-font").evaluate(ye,{},f).join(","),be=ae.evaluate(ye,{},f)*P.textScaleFactor,ze=P.layoutTextSize.evaluate(ye,{},f)*P.textScaleFactor,et=P.layoutIconSize.evaluate(ye,{},f)*P.iconScaleFactor,Ve={horizontal:{},vertical:void 0},We=ye.text,Je,Oe=[0,0];if(We){let ft=We.toString(),Mt=S.get("text-letter-spacing").evaluate(ye,{},f)*gr,Bt=S.get("text-line-height").evaluate(ye,{},f)*gr,Wt=Ab(ft)?Mt:0,$t=S.get("text-anchor").evaluate(ye,{},f),pn=S.get("text-variable-anchor");if(!pn){let Re=S.get("text-radial-offset").evaluate(ye,{},f);if(Re)Oe=TC($t,[Re*gr,kw]);else{let rt=S.get("text-offset").evaluate(ye,{},f);Oe=[rt[0]*gr,rt[1]*gr]}}let nn=de?"center":S.get("text-justify").evaluate(ye,{},f),ni=K==="point",Q=ni?S.get("text-max-width").evaluate(ye,{},f)*gr:1/0,ee=Re=>{i.allowVerticalPlacement&&tm(ft)&&(Ve.vertical=Mw(We,e,n,c,ke,Q,Bt,$t,Re,Wt,Oe,No.vertical,!0,ze,be,x))};if(!de&&pn){let Re=nn==="auto"?pn.map(ct=>Fw(ct)):[nn],rt=!1;for(let ct=0;ct<Re.length;ct++){let lt=Re[ct];if(!Ve.horizontal[lt])if(rt)Ve.horizontal[lt]=Ve.horizontal[0];else{let yt=Mw(We,e,n,c,ke,Q,Bt,"center",lt,Wt,Oe,No.horizontal,!1,ze,be,x);yt&&(Ve.horizontal[lt]=yt,rt=yt.positionedLines.length===1)}}ee("left")}else{if(nn==="auto"&&(nn=Fw($t)),ni||S.get("text-writing-mode").indexOf("horizontal")>=0||!tm(ft)){let Re=Mw(We,e,n,c,ke,Q,Bt,$t,nn,Wt,Oe,No.horizontal,!1,ze,be,x);Re&&(Ve.horizontal[nn]=Re)}ee(ni?"left":nn)}}let Ze,we,Le,it,Ye,Et,_t=!1,Ge=S.get("icon-text-fit").evaluate(ye,{},f);if(ye.icon&&ye.icon.hasPrimary()){let ft=SC(ye.icon,i.iconSizeData,D["icon-size"],f,i.zoom,ye,x,P.iconScaleFactor,I);Ze=ft.iconPrimary,Le=ft.iconSecondary;let Mt=Ze.toString();if(we=s.get(Mt),we&&(Ye=S.get("icon-offset").evaluate(ye,{},f),Et=S.get("icon-anchor").evaluate(ye,{},f),Je=ZF(c.get(Mt),Le?c.get(Le.toString()):void 0,Ye,Et),_t=we.sdf,i.sdfIcons===void 0?i.sdfIcons=we.sdf:i.sdfIcons!==we.sdf&&fn("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(we.pixelRatio!==i.pixelRatio||S.get("icon-rotate").constantOr(1)!==0)&&(i.iconsNeedLinear=!0)),Le){let Bt=Le.toString();it=s.get(Bt)}}ce=ce||!(!ye.icon||!ye.icon.hasSecondary());let Ke=Nw(Ve.horizontal)||Ve.vertical;i.iconsInText||(i.iconsInText=!!Ke&&Ke.iconsInText);let vt=ze*P.textScaleFactor/gr,{defaultShapedIcon:ht,verticallyShapedIcon:at}=rN(i,Je,S,ye,f,Ve,vt,Ye,Ge);Ge!=="none"&&Je&&(lC(Je)||cC(Je))&&(pv(0,we,Ze,Je,ht,Ge,w,s,c),pv(0,it,Le,Je,ht,Ge,w,s,c),at&&(pv(0,we,Ze,Je,at,Ge,w,s,c),pv(0,it,Le,Je,at,Ge,w,s,c))),Je=ht,ge.push({feature:ye,shapedTextOrientations:Ve,shapedText:Ke,shapedIcon:Je,iconPrimary:Ze,iconSecondary:Le,iconOffset:Ye,iconAnchor:Et,verticallyShapedIcon:at,layoutTextSize:ze,layoutIconSize:et,textOffset:Oe,isSDFIcon:_t,iconTextFit:Ge})}return{featureData:ge,sizes:P,hasAnySecondaryIcon:ce,textAlongLine:de,symbolPlacement:K}},r.fm=yC,r.fn=function(i,e,n,s,c,f,p,y,x,w){let{featureData:I,hasAnySecondaryIcon:S,sizes:D,textAlongLine:P,symbolPlacement:O}=e;for(let F of I){let{shapedIcon:B,verticallyShapedIcon:H,feature:X,shapedTextOrientations:Z,shapedText:K,layoutTextSize:de,textOffset:ae,isSDFIcon:ce,iconPrimary:ge,iconSecondary:ye,iconTextFit:ke,iconOffset:be}=F;DC(B,w.iconPositions,ge,ye),DC(H,w.iconPositions,ge,ye),iN(Z,w.iconPositions),nN(ge,ye,w.iconPositions),(K||B)&&oN(i,X,Z,B,H,x,D,de,0,ae,ce,s,c,p,y,S,ke,be,P,O)}n&&i.generateCollisionDebugBuffers(f,i.collisionBoxArray,D.textScaleFactor)},r.fo=xt,r.fp=Lv,r.fq=Ie,r.fr=function(i){let e=0;if(new Uint32Array(i,0,1)[0]!==vD){let n=new Uint32Array(i,0,7),[,,s,c,f,p]=n;e=n.byteLength+c+f+p+f,(s!==i.byteLength||e>=i.byteLength)&&fn("Invalid b3dm header information.")}return ED(i,e)},r.fs=function(i,e){let n=RD(i);for(let s of n){for(let c of s.meshes)oF(c);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(sF(s.lights,e)))}return n},r.ft=Cv,r.fu=Gn,r.fv=pD,r.fw=bs,r.fx=fo,r.fy=function(i){$l(),vs?.then(e=>{e.keys().then(n=>{for(let s=0;s<n.length-i;s++)e.delete(n[s]).catch(c=>fn(c.message))}).catch(n=>fn(n.message))}).catch(e=>fn(e.message))},r.g=function(i,e){return ql(De(i,{method:"GET"}),e)},r.h=De,r.i=function(i){return vr.API_STYLE_REGEX.test(i)&&!Zd(i)},r.j=function(i){return i.indexOf("mapbox:")===0},r.k=pa,r.l=gp,r.m=function(i){return decodeURIComponent(atob(i).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},r.n=function(i,e){return ql(De(i,{type:"json"}),e)},r.o=wu,r.p=function(i,e){return ql(De(i,{method:"POST"}),e)},r.q=rs,r.r=Sr,r.s=function(i){try{let e=self[i];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},r.t=Kd,r.u=function(){return function i(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,i)}()},r.v=function(i){return!!i&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(i)},r.w=fn,r.x=function(){return hw||(hw=new tv),hw},r.y=Jw,r.z=So}),m(["./shared"],function(r){function M(Se){let $=Se?Se.url.toString():void 0;return $?performance.getEntriesByName($):[]}function N(Se){if(typeof Se=="number"||typeof Se=="boolean"||typeof Se=="string"||Se==null)return JSON.stringify(Se);if(Array.isArray(Se)){let q="[";for(let te of Se)q+=`${N(te)},`;return`${q}]`}let $="{";for(let q of Object.keys(Se).sort())$+=`${q}:${N(Se[q])},`;return`${$}}`}function G(Se){let $="";for(let q of r.bu)$+=`/${N(Se[q])}`;return $}class fe{constructor($){this.keyCache={},this._layers={},this._layerConfigs={},$&&this.replace($)}replace($,q){this._layerConfigs={},this._layers={},this.update($,[],q)}update($,q,te){this._options=te;for(let ne of $)this._layerConfigs[ne.id]=ne,(this._layers[ne.id]=r.dn(ne,this.scope,null,this._options)).compileFilter(te),this.keyCache[ne.id]&&delete this.keyCache[ne.id];for(let ne of q)delete this.keyCache[ne],delete this._layerConfigs[ne],delete this._layers[ne];this.familiesBySource={};let he=function(ne,_e){let Ae={};for(let De=0;De<ne.length;De++){let nt=ne[De],je=_e&&_e[nt.id];je||(nt.type==="symbol"?je=nt.id:(je=G(nt),nt.type==="line"&&nt.paint&&function Ft(Ut){return typeof Ut=="string"&&Ut==="line-progress"||(Array.isArray(Ut)?Ut.some(Ft):!(!Ut||typeof Ut!="object")&&Object.values(Ut).some(Ft))}(nt.paint["line-width"])&&(je+=`/${N(nt.paint["line-width"])}`))),_e&&(_e[nt.id]=je);let Dt=Ae[je];Dt||(Dt=Ae[je]=[]),Dt.push(nt)}let ve=[];for(let De in Ae)ve.push(Ae[De]);return ve}(Object.values(this._layerConfigs),this.keyCache);for(let ne of he){let _e=ne.map(Dt=>this._layers[Dt.id]),Ae=_e[0];if(Ae.visibility==="none")continue;let ve=Ae.source||"",De=this.familiesBySource[ve];De||(De=this.familiesBySource[ve]={});let nt=Ae.sourceLayer||"_geojsonTileLayer",je=De[nt];je||(je=De[nt]=[]),je.push(_e)}}}let Me=1*r.fa;class Ue{constructor($){let q={},te=[];for(let Ae in $){let ve=$[Ae],De=q[Ae]={};for(let nt in ve.glyphs){let je=ve.glyphs[+nt];if(!je||je.bitmap.width===0||je.bitmap.height===0)continue;let Dt=je.metrics.localGlyph?Me:1,Ft={x:0,y:0,w:je.bitmap.width+2*Dt,h:je.bitmap.height+2*Dt};te.push(Ft),De[nt]=Ft}}let{w:he,h:ne}=r.H(te),_e=new r.f9({width:he||1,height:ne||1});for(let Ae in $){let ve=$[Ae];for(let De in ve.glyphs){let nt=ve.glyphs[+De];if(!nt||nt.bitmap.width===0||nt.bitmap.height===0)continue;let je=q[Ae][De],Dt=nt.metrics.localGlyph?Me:1;r.f9.copy(nt.bitmap,_e,{x:0,y:0},{x:je.x+Dt,y:je.y+Dt},nt.bitmap)}}this.image=_e,this.positions=q}}r.f8(Ue,"GlyphAtlas");class bt{constructor($){this.tileID=new r.aM($.tileID.overscaledZ,$.tileID.wrap,$.tileID.canonical.z,$.tileID.canonical.x,$.tileID.canonical.y),this.tileZoom=$.tileZoom,this.uid=$.uid,this.zoom=$.zoom,this.lut=$.lut,this.canonical=$.tileID.canonical,this.pixelRatio=$.pixelRatio,this.tileSize=$.tileSize,this.source=$.source,this.scope=$.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=$.showCollisionBoxes,this.collectResourceTiming=!!$.request&&$.request.collectResourceTiming,this.promoteId=$.promoteId,this.isSymbolTile=$.isSymbolTile,this.tileTransform=r.aW($.tileID.canonical,$.projection),this.projection=$.projection,this.worldview=$.worldview,this.localizableLayerIds=$.localizableLayerIds,this.brightness=$.brightness,this.extraShadowCaster=!!$.extraShadowCaster,this.tessellationStep=$.tessellationStep,this.scaleFactor=$.scaleFactor,this.worldview=$.worldview}parse($,q,te,he,ne,_e){this.status="parsing",this.data=$,this.collisionBoxArray=new r.b0;let Ae=new r.fb(Object.keys($.layers).sort()),ve=new r.fc(this.tileID,this.promoteId);ve.bucketLayerIDs=[];let De={},nt=new r.fd(256,256),je={featureIndex:ve,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:nt,availableImages:te,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Dt=[],Ft=q.familiesBySource[this.source];for(let dn in Ft){let rn=$.layers[dn];if(!rn)continue;let hn=!1,Kn=!1,fn=!1;for(let Gn of Ft[dn])Gn[0].type==="symbol"?hn=!0:Kn=!0,Gn[0].is3D()&&Gn[0].type!=="model"&&(fn=!0);if(this.extraShadowCaster&&!fn||this.isSymbolTile===!0&&!hn||this.isSymbolTile===!1&&!Kn)continue;rn.version===1&&r.w(`Vector tile source "${this.source}" layer "${dn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let Pi=Ae.encode(dn),ir=[],Ki=!1;for(let Gn=0,An=0;Gn<rn.length;Gn++){let Ai=rn.feature(Gn),bi=ve.getId(Ai,dn);if(this.localizableLayerIds&&this.localizableLayerIds.has(dn)){let mi=Ai.properties?Ai.properties.worldview:null;if(this.worldview&&typeof mi=="string")if(mi==="all")Ai.properties.$localized=!0;else{if(!mi.split(",").includes(this.worldview))continue;Ai.properties.$localized=!0,Ai.properties.worldview=this.worldview}}!Ki&&Ai.properties&&Ai.properties.hasOwnProperty(r.fe)&&(Ki=!0),ir.push({feature:Ai,id:bi,index:An,sourceLayerIndex:Pi}),An++}Ki&&!je.elevationFeatures&&$.layers.hasOwnProperty(r.ff)&&(je.elevationFeatures=r.fg.parseFrom($.layers[r.ff],this.canonical));for(let Gn of Ft[dn]){let An=Gn[0];if(this.extraShadowCaster&&(!An.is3D()||An.type==="model")||this.isSymbolTile!==void 0&&An.type==="symbol"!==this.isSymbolTile||An.minzoom&&this.zoom<Math.floor(An.minzoom)||An.maxzoom&&this.zoom>=An.maxzoom||An.visibility==="none")continue;Fe(Gn,this.zoom,je.brightness,te,this.worldview);let Ai=De[An.id]=An.createBucket({index:ve.bucketLayerIDs.length,layers:Gn,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Pi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:he,worldview:this.worldview});ve.bucketLayerIDs.push(Gn.map(mi=>r.C(mi.id,mi.scope)));let bi=Ai.prepare?Ai.prepare():null;bi!=null?(bi=bi.then(()=>Ai.populate(ir,je,this.tileID.canonical,this.tileTransform)),Dt.push(bi)):Ai.populate(ir,je,this.tileID.canonical,this.tileTransform)}}let Ut=()=>{let dn,rn,hn,Kn,fn,Pi;nt.trim();let ir={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Ki=()=>{if(dn)return this.status="done",_e(dn);if(this.extraShadowCaster)this.status="done",_e(null,{buckets:Object.values(De).filter(An=>!An.isEmpty()),featureIndex:ve,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:je.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(rn&&hn&&Kn){let An=new Ue(rn),Ai=new Map;for(let[hr,Qr]of hn.entries()){let{imagePosition:Rr}=r.fj(hr,Qr,r.fk);Ai.set(hr,Rr)}let bi={};for(let hr in De){let Qr=De[hr];Qr instanceof r.b1&&(Fe(Qr.layers,this.zoom,je.brightness,te,this.worldview),bi[hr]=r.fl(Qr,rn,An.positions,hn,Ai,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,fn,this.worldview))}let mi={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(ne,hn,fn,()=>{mi.iconsPending=!1,Gn(bi,An,mi)}),this.rasterizeIfNeeded(ne,Kn,Pi,()=>{mi.patternsPending=!1,Gn(bi,An,mi)})}},Gn=(An,Ai,bi,mi)=>{if(bi.iconsPending||bi.patternsPending)return;let hr=new r.fm(hn,Kn,this.lut);for(let Qr in De){let Rr=De[Qr];if(Qr in An)r.fn(Rr,An[Qr],this.showCollisionBoxes,te,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,hn,hr);else if(Rr.hasPattern&&(Rr instanceof r.b7||Rr instanceof r.b8||Rr instanceof r.e4)){Fe(Rr.layers,this.zoom,je.brightness,te,this.worldview);let hu=Object.fromEntries(hr.patternPositions);Rr.addFeatures(je,this.tileID.canonical,hu,te,this.tileTransform,this.brightness)}}this.status="done",_e(null,{buckets:Object.values(De).filter(Qr=>!Qr.isEmpty()),featureIndex:ve,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ai.image,lineAtlas:nt,imageAtlas:hr,brightness:je.brightness})};if(!this.extraShadowCaster){let An=r.fh(je.glyphDependencies,mi=>Object.keys(mi).map(Number));Object.keys(An).length?ne.send("getGlyphs",{uid:this.uid,stacks:An},(mi,hr)=>{dn||(dn=mi,rn=hr,Ki())},void 0,!1,ir):rn={};let Ai=Array.from(je.iconDependencies.keys()).map(mi=>r.I.parse(mi));Ai.length?ne.send("getImages",{images:Ai,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(mi,hr)=>{dn||(dn=mi,hn=new Map,fn=this.updateImageMapAndGetImageTaskQueue(hn,hr,je.iconDependencies),Ki())},void 0,!1,ir):(hn=new Map,fn=new Map);let bi=Array.from(je.patternDependencies.keys()).map(mi=>r.I.parse(mi));bi.length?ne.send("getImages",{images:bi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(mi,hr)=>{dn||(dn=mi,Kn=new Map,Pi=this.updateImageMapAndGetImageTaskQueue(Kn,hr,je.patternDependencies),Ki())},void 0,!1,ir):(Kn=new Map,Pi=new Map)}if(je.elevationFeatures&&je.elevationFeatures.length>0){let An=[];for(let bi of Object.values(De))if(bi instanceof r.b8){let mi=bi.getUnevaluatedPortalGraph();mi&&An.push(mi)}let Ai=r.fi.evaluate(An);for(let bi of Object.values(De))if(bi instanceof r.b8){let mi=$.layers[Ae.decode(bi.sourceLayerIndex)];bi.setEvaluatedPortalGraph(Ai,mi,this.tileID.canonical,je.availableImages,je.brightness)}}Ki()};Dt.length>0?Promise.allSettled(Dt).then(Ut).catch(_e):Ut()}rasterizeIfNeeded($,q,te,he){Array.from(q.values()).some(ne=>ne.usvg)?this.rasterize($,q,te,he):he()}updateImageMapAndGetImageTaskQueue($,q,te){let he=new Map;for(let ne of q.keys()){let _e=te.get(ne)||[];for(let Ae of _e){let ve=Ae.toString(),De=q.get(Ae.id.toString());De.usvg?he.has(ve)||(he.set(ve,Ae),$.set(ve,Object.assign({},De))):$.set(ve,De)}}return he}rasterize($,q,te,he){this.rasterizeTask=$.send("rasterizeImages",{scope:this.scope,tasks:te},(ne,_e)=>{if(!ne)for(let[Ae,ve]of _e.entries()){let De=Object.assign(q.get(Ae),{data:ve});q.set(Ae,De)}he()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function Fe(Se,$,q,te,he){let ne=new r.aa($,{brightness:q,worldview:he});for(let _e of Se)_e.recalculate(ne,te)}class Pt extends r.E{constructor($,q,te,he,ne,_e,Ae){super(),this.actor=$,this.layerIndex=q,this.availableImages=te,this.availableModels=he,this.loadVectorData=_e||r.aJ,this.loading={},this.loaded={},this.deduped=new r.aI($.scheduler),this.isSpriteLoaded=ne,this.scheduler=$.scheduler,this.brightness=Ae}loadTile($,q){let te=$.uid,he=$&&$.request,ne=he&&he.collectResourceTiming,_e=this.loading[te]=new bt($);_e.abort=this.loadVectorData($,(Ae,ve)=>{let De=!this.loading[te];if(delete this.loading[te],_e.cancelRasterize(),De||Ae||!ve)return _e.status="done",De||(this.loaded[te]=_e),q(Ae);let nt=ve.rawData,je={};ve.expires&&(je.expires=ve.expires),ve.cacheControl&&(je.cacheControl=ve.cacheControl),_e.vectorTile=ve.vectorTile||new r.fo(new r.bq(nt));let Dt=()=>{_e.parse(_e.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Ft,Ut)=>{if(Ft||!Ut)return q(Ft);let dn={};if(ne){let rn=M(he);rn.length>0&&(dn.resourceTiming=JSON.parse(JSON.stringify(rn)))}q(null,r.h({rawTileData:nt.slice(0)},Ut,je,dn))})};this.isSpriteLoaded?Dt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Dt,{type:"parseTile",isSymbolTile:$.isSymbolTile,zoom:$.tileZoom}):Dt()}),this.loaded=this.loaded||{},this.loaded[te]=_e})}reloadTile($,q){let te=this.loaded,he=$.uid;if(te&&te[he]){let ne=te[he];ne.scaleFactor=$.scaleFactor,ne.showCollisionBoxes=$.showCollisionBoxes,ne.projection=$.projection,ne.brightness=$.brightness,ne.tileTransform=r.aW($.tileID.canonical,$.projection),ne.extraShadowCaster=$.extraShadowCaster,ne.lut=$.lut,ne.worldview=$.worldview;let _e=(Ae,ve)=>{let De=ne.reloadCallback;De&&(delete ne.reloadCallback,ne.parse(ne.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,De)),q(Ae,ve)};ne.status==="parsing"?ne.reloadCallback=_e:ne.status==="done"&&(ne.vectorTile?ne.parse(ne.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,_e):_e())}else q(null,void 0)}abortTile($,q){let te=$.uid,he=this.loading[te];he&&(he.abort&&he.abort(),delete this.loading[te]),q()}removeTile($,q){let te=this.loaded,he=$.uid;te&&te[he]&&delete te[he],q()}}class Vt{loadTile($,q){let{uid:te,encoding:he,rawImageData:ne,padding:_e}=$,Ae=ImageBitmap&&ne instanceof ImageBitmap?this.getImageData(ne,_e):ne;q(null,new r.fp(te,Ae,he,_e<1))}reloadTile($,q){q(null,null)}abortTile($,q){q()}removeTile($,q){q()}getImageData($,q){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas($.width,$.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=$.width,this.offscreenCanvas.height=$.height,this.offscreenCanvasContext.drawImage($,0,0,$.width,$.height);let te=this.offscreenCanvasContext.getImageData(-q,-q,$.width+2*q,$.height+2*q);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),te}}r.bp.setPbf(r.bq);class jt{constructor($){this._mrt=new r.bp($.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=$.uid,this.tileID=$.tileID,this.source=$.source}parse($,q){let te=this._mrt;this.status="parsing",this._entireBuffer=$;try{te.parseHeader($),this._isHeaderLoaded=!0;let he=[];for(let ne in te.layers){let _e=te.getLayer(ne),Ae=_e.getDataRange(_e.getBandList()),ve=te.createDecodingTask(Ae),De=$.slice(Ae.firstByte,Ae.lastByte+1),nt=r.bp.performDecoding(De,ve).then(je=>ve.complete(null,je)).catch(je=>ve.complete(je,null));he.push(nt)}Promise.allSettled(he).then(()=>q(null,te)).catch(ne=>q(ne))}catch(he){q(he)}}}class Nt{constructor($){this.actor=$,this.loading={},this.loaded={}}loadTile($,q){let te=$.uid,he=$.request,ne=this.loading[te]=new jt($),{cancel:_e}=r.br(he,(Ae,ve,De,nt)=>{let je=!this.loading[te];if(delete this.loading[te],je||Ae||!ve)return ne.status="done",je||(this.loaded[te]=ne),q(Ae);ne.parse(ve,(Dt,Ft)=>{if(Dt||!Ft)return q(Dt);q(null,Ft,De,nt)}),this.loaded[te]=ne});ne.abort=_e}reloadTile($,q){q(null,void 0)}abortTile($,q){let te=$.uid,he=this.loading[te];he&&(he.abort&&he.abort(),delete this.loading[te]),q()}removeTile($,q){let te=$.uid;this.loaded[te]&&delete this.loaded[te],q()}decodeRasterArray($,q){r.bp.performDecoding($.buffer,$.task).then(te=>q(null,te)).catch(te=>q(te))}}let ar=r.fq.prototype.toGeoJSON;class lr{constructor($){this._feature=$,this.extent=r.aj,this.type=$.type,this.properties=$.tags,"id"in $&&!isNaN($.id)&&(this.id=parseInt($.id,10))}loadGeometry(){if(this._feature.type===1){let $=[];for(let q of this._feature.geometry)$.push([new r.P(q[0],q[1])]);return $}{let $=[];for(let q of this._feature.geometry){let te=[];for(let he of q)te.push(new r.P(he[0],he[1]));$.push(te)}return $}}toGeoJSON($,q,te){return ar.call(this,$,q,te)}}class Ri{constructor($,q){this.name=$,this.extent=r.aj,this.length=q.length,this._jsonFeatures=q}feature($){return new lr(this._jsonFeatures[$])}}class _s{constructor($){this.layers={},this.extent=r.aj;for(let q of Object.keys($))this.layers[q]=new Ri(q,$[q])}}let xo=64/4096,ys=128;class qd{constructor(){this.features=new Map}clear(){this.features.clear()}load($=[],q){for(let te of $){let he=te.id;if(he==null)continue;let ne=this.features.get(he);ne&&this.updateCache(ne,q),te.geometry?(ne=zl(te),this.updateCache(ne,q),this.features.set(he,ne)):this.features.delete(he),this.updateCache(ne,q)}}updateCache($,q){for(let{canonical:te,uid:he}of Object.values(q)){let{z:ne,x:_e,y:Ae}=te;Nn($,Math.pow(2,ne),_e,Ae)&&delete q[he]}}getTile($,q,te){let he=Math.pow(2,$),ne=[];for(let _e of this.features.values())Nn(_e,he,q,te)&&ne.push(pi(_e,he,q,te));return{features:ne}}getFeatures(){return[...this.features.values()]}}function Nn({minX:Se,minY:$,maxX:q,maxY:te},he,ne,_e){return Se<(ne+1+xo)/he&&$<(_e+1+xo)/he&&q>(ne-xo)/he&&te>(_e-xo)/he}function zl(Se){let{id:$,geometry:q,properties:te}=Se;if(!q)return;if(q.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:he,coordinates:ne}=q,_e={id:$,type:1,geometry:[],tags:te,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Ae=_e.geometry;if(he==="Point")Er(ne,Ae,_e);else if(he==="MultiPoint")for(let ve of ne)Er(ve,Ae,_e);else if(he==="LineString")_e.type=2,Wi(ne,Ae,_e);else if(he==="MultiLineString")_e.type=2,Ui(ne,Ae,_e);else if(he==="Polygon")_e.type=3,Ui(ne,Ae,_e,!0);else{if(he!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");_e.type=3;for(let ve of ne)Ui(ve,Ae,_e,!0)}return _e}function Er([Se,$],q,te){let he=r.aD(Se),ne=r.aH($);ne=ne<0?0:ne>1?1:ne,q.push(he,ne),te.minX=Math.min(te.minX,he),te.minY=Math.min(te.minY,ne),te.maxX=Math.max(te.maxX,he),te.maxY=Math.max(te.maxY,ne)}function Wi(Se,$,q,te=!1,he=!1){let ne=[];for(let _e of Se)Er(_e,ne,q);$.push(ne),te&&function(_e,Ae){let ve=0;for(let De=0,nt=_e.length,je=nt-2;De<nt;je=De,De+=2)ve+=(_e[De]-_e[je])*(_e[De+1]+_e[je+1]);if(ve>0===Ae)for(let De=0,nt=_e.length;De<nt/2;De+=2){let je=_e[De],Dt=_e[De+1];_e[De]=_e[nt-2-De],_e[De+1]=_e[nt-1-De],_e[nt-2-De]=je,_e[nt-1-De]=Dt}}(ne,he)}function Ui(Se,$,q,te=!1){for(let he=0;he<Se.length;he++)Wi(Se[he],$,q,te,he===0)}function pi(Se,$,q,te){let{id:he,type:ne,geometry:_e,tags:Ae}=Se,ve=[];if(ne===1)(function(De,nt,je,Dt,Ft){for(let Ut=0;Ut<De.length;Ut+=2){let dn=Math.round(r.aj*(De[Ut+0]*nt-je)),rn=Math.round(r.aj*(De[Ut+1]*nt-Dt));Ft.push([dn,rn])}})(_e,$,q,te,ve);else for(let De of _e)lo(De,$,q,te,ve);return{id:he,type:ne,geometry:ve,tags:Ae}}function lo(Se,$,q,te,he){let ne=-ys,_e=r.aj+ys,Ae;for(let ve=0;ve<Se.length-2;ve+=2){let De=Math.round(r.aj*(Se[ve+0]*$-q)),nt=Math.round(r.aj*(Se[ve+1]*$-te)),je=Math.round(r.aj*(Se[ve+2]*$-q)),Dt=Math.round(r.aj*(Se[ve+3]*$-te)),Ft=je-De,Ut=Dt-nt;De<ne&&je<ne||(De<ne?(nt+=Math.round(Ut*((ne-De)/Ft)),De=ne):je<ne&&(Dt=nt+Math.round(Ut*((ne-De)/Ft)),je=ne),nt<ne&&Dt<ne||(nt<ne?(De+=Math.round(Ft*((ne-nt)/Ut)),nt=ne):Dt<ne&&(je=De+Math.round(Ft*((ne-nt)/Ut)),Dt=ne),De>=_e&&je>=_e||(De>=_e?(nt+=Math.round(Ut*((_e-De)/Ft)),De=_e):je>=_e&&(Dt=nt+Math.round(Ut*((_e-De)/Ft)),je=_e),nt>=_e&&Dt>=_e||(nt>=_e?(De+=Math.round(Ft*((_e-nt)/Ut)),nt=_e):Dt>=_e&&(je=De+Math.round(Ft*((_e-nt)/Ut)),Dt=_e),Ae&&De===Ae[Ae.length-1][0]&&nt===Ae[Ae.length-1][1]||(Ae=[[De,nt]],he.push(Ae)),Ae.push([je,Dt])))))}}function ru({name:Se,features:$},q){q.writeStringField(1,Se),q.writeVarintField(5,r.aj);let te=new Map,he=new Map,ne={keys:te,values:he,feature:null};for(let _e of $)ne.feature=_e,q.writeMessage(2,Ps,ne);for(let _e of te.keys())q.writeStringField(3,_e);for(let _e of he.keys())q.writeMessage(4,Wd,_e)}function Ps(Se,$){let q=Se.feature;q.id===void 0||isNaN(+q.id)||$.writeVarintField(1,+q.id),q.tags&&$.writeMessage(2,$o,Se),$.writeVarintField(3,q.type),$.writeMessage(4,Bl,q)}function $o({keys:Se,values:$,feature:q},te){for(let he of Object.keys(q.tags)){let ne=q.tags[he];if(ne===null)continue;let _e=Se.get(he);_e===void 0&&(_e=Se.size,Se.set(he,_e)),te.writeVarint(_e);let Ae=typeof ne;Ae!=="string"&&Ae!=="boolean"&&Ae!=="number"&&(ne=JSON.stringify(ne));let ve=$.get(ne);ve===void 0&&(ve=$.size,$.set(ne,ve)),te.writeVarint(ve)}}function hi(Se,$){return($<<3)+(7&Se)}function zr(Se){return Se<<1^Se>>31}function Bl(Se,$){let{geometry:q,type:te}=Se,he=0,ne=0;if(te===1){$.writeVarint(hi(1,q.length));for(let _e of q){let Ae=_e[0]-he,ve=_e[1]-ne;$.writeVarint(zr(Ae)),$.writeVarint(zr(ve)),he+=Ae,ne+=ve}}else for(let _e of q){$.writeVarint(hi(1,1));let Ae=_e.length-(te===3?1:0);for(let ve=0;ve<Ae;ve++){ve===1&&$.writeVarint(hi(2,Ae-1));let De=_e[ve][0]-he,nt=_e[ve][1]-ne;$.writeVarint(zr(De)),$.writeVarint(zr(nt)),he+=De,ne+=nt}te===3&&$.writeVarint(hi(7,1))}}function Wd(Se,$){let q=typeof Se;q==="string"?$.writeStringField(1,Se):q==="boolean"?$.writeBooleanField(7,Se):q==="number"&&(Se%1!=0?$.writeDoubleField(3,Se):Se<0?$.writeSVarintField(6,Se):$.writeVarintField(5,Se))}let aa={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Se=>Se},ci=Math.fround||(Fi=new Float32Array(1),Se=>(Fi[0]=+Se,Fi[0]));var Fi;let Zi=3,Yr=5,Ni=6;class la{constructor($){this.options=Object.assign(Object.create(aa),$),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load($){let{log:q,minZoom:te,maxZoom:he}=this.options;q&&console.time("total time");let ne=`prepare ${$.length} points`;q&&console.time(ne),this.points=$;let _e=[];for(let ve=0;ve<$.length;ve++){let De=$[ve];if(!De.geometry)continue;let[nt,je]=De.geometry.coordinates,Dt=ci(Go(nt)),Ft=ci(zi(je));_e.push(Dt,Ft,1/0,ve,-1,1),this.options.reduce&&_e.push(0)}let Ae=this.trees[he+1]=this._createTree(_e);q&&console.timeEnd(ne);for(let ve=he;ve>=te;ve--){let De=+Date.now();Ae=this.trees[ve]=this._createTree(this._cluster(Ae,ve)),q&&console.log("z%d: %d clusters in %dms",ve,Ae.numItems,+Date.now()-De)}return q&&console.timeEnd("total time"),this}getClusters($,q){let te=(($[0]+180)%360+360)%360-180,he=Math.max(-90,Math.min(90,$[1])),ne=$[2]===180?180:(($[2]+180)%360+360)%360-180,_e=Math.max(-90,Math.min(90,$[3]));if($[2]-$[0]>=360)te=-180,ne=180;else if(te>ne){let je=this.getClusters([te,he,180,_e],q),Dt=this.getClusters([-180,he,ne,_e],q);return je.concat(Dt)}let Ae=this.trees[this._limitZoom(q)],ve=Ae.range(Go(te),zi(_e),Go(ne),zi(he)),De=Ae.data,nt=[];for(let je of ve){let Dt=this.stride*je;nt.push(De[Dt+Yr]>1?ca(De,Dt,this.clusterProps):this.points[De[Dt+Zi]])}return nt}getChildren($){let q=this._getOriginId($),te=this._getOriginZoom($),he="No cluster with the specified id.",ne=this.trees[te];if(!ne)throw new Error(he);let _e=ne.data;if(q*this.stride>=_e.length)throw new Error(he);let Ae=this.options.radius/(this.options.extent*Math.pow(2,te-1)),ve=ne.within(_e[q*this.stride],_e[q*this.stride+1],Ae),De=[];for(let nt of ve){let je=nt*this.stride;_e[je+4]===$&&De.push(_e[je+Yr]>1?ca(_e,je,this.clusterProps):this.points[_e[je+Zi]])}if(De.length===0)throw new Error(he);return De}getLeaves($,q,te){let he=[];return this._appendLeaves(he,$,q=q||10,te=te||0,0),he}getTile($,q,te){let he=this.trees[this._limitZoom($)],ne=Math.pow(2,$),{extent:_e,radius:Ae}=this.options,ve=Ae/_e,De=(te-ve)/ne,nt=(te+1+ve)/ne,je={features:[]};return this._addTileFeatures(he.range((q-ve)/ne,De,(q+1+ve)/ne,nt),he.data,q,te,ne,je),q===0&&this._addTileFeatures(he.range(1-ve/ne,De,1,nt),he.data,ne,te,ne,je),q===ne-1&&this._addTileFeatures(he.range(0,De,ve/ne,nt),he.data,-1,te,ne,je),je.features.length?je:null}getClusterExpansionZoom($){let q=this._getOriginZoom($)-1;for(;q<=this.options.maxZoom;){let te=this.getChildren($);if(q++,te.length!==1)break;$=te[0].properties.cluster_id}return q}_appendLeaves($,q,te,he,ne){let _e=this.getChildren(q);for(let Ae of _e){let ve=Ae.properties;if(ve&&ve.cluster?ne+ve.point_count<=he?ne+=ve.point_count:ne=this._appendLeaves($,ve.cluster_id,te,he,ne):ne<he?ne++:$.push(Ae),$.length===te)break}return ne}_createTree($){let q=new r.c0($.length/this.stride|0,this.options.nodeSize,Float32Array);for(let te=0;te<$.length;te+=this.stride)q.add($[te],$[te+1]);return q.finish(),q.data=$,q}_addTileFeatures($,q,te,he,ne,_e){for(let Ae of $){let ve=Ae*this.stride,De=q[ve+Yr]>1,nt,je,Dt;if(De)nt=ou(q,ve,this.clusterProps),je=q[ve],Dt=q[ve+1];else{let dn=this.points[q[ve+Zi]];nt=dn.properties;let[rn,hn]=dn.geometry.coordinates;je=Go(rn),Dt=zi(hn)}let Ft={type:1,geometry:[[Math.round(this.options.extent*(je*ne-te)),Math.round(this.options.extent*(Dt*ne-he))]],tags:nt},Ut;Ut=De||this.options.generateId?q[ve+Zi]:this.points[q[ve+Zi]].id,Ut!==void 0&&(Ft.id=Ut),_e.features.push(Ft)}}_limitZoom($){return Math.max(this.options.minZoom,Math.min(Math.floor(+$),this.options.maxZoom+1))}_cluster($,q){let{radius:te,extent:he,reduce:ne,minPoints:_e}=this.options,Ae=te/(he*Math.pow(2,q)),ve=$.data,De=[],nt=this.stride;for(let je=0;je<ve.length;je+=nt){if(ve[je+2]<=q)continue;ve[je+2]=q;let Dt=ve[je],Ft=ve[je+1],Ut=$.within(ve[je],ve[je+1],Ae),dn=ve[je+Yr],rn=dn;for(let hn of Ut){let Kn=hn*nt;ve[Kn+2]>q&&(rn+=ve[Kn+Yr])}if(rn>dn&&rn>=_e){let hn,Kn=Dt*dn,fn=Ft*dn,Pi=-1,ir=(je/nt<<5)+(q+1)+this.points.length;for(let Ki of Ut){let Gn=Ki*nt;if(ve[Gn+2]<=q)continue;ve[Gn+2]=q;let An=ve[Gn+Yr];Kn+=ve[Gn]*An,fn+=ve[Gn+1]*An,ve[Gn+4]=ir,ne&&(hn||(hn=this._map(ve,je,!0),Pi=this.clusterProps.length,this.clusterProps.push(hn)),ne(hn,this._map(ve,Gn)))}ve[je+4]=ir,De.push(Kn/rn,fn/rn,1/0,ir,-1,rn),ne&&De.push(Pi)}else{for(let hn=0;hn<nt;hn++)De.push(ve[je+hn]);if(rn>1)for(let hn of Ut){let Kn=hn*nt;if(!(ve[Kn+2]<=q)){ve[Kn+2]=q;for(let fn=0;fn<nt;fn++)De.push(ve[Kn+fn])}}}}return De}_getOriginId($){return $-this.points.length>>5}_getOriginZoom($){return($-this.points.length)%32}_map($,q,te){if($[q+Yr]>1){let _e=this.clusterProps[$[q+Ni]];return te?Object.assign({},_e):_e}let he=this.points[$[q+Zi]].properties,ne=this.options.map(he);return te&&ne===he?Object.assign({},ne):ne}}function ca(Se,$,q){return{type:"Feature",id:Se[$+Zi],properties:ou(Se,$,q),geometry:{type:"Point",coordinates:[(te=Se[$],360*(te-.5)),Kr(Se[$+1])]}};var te}function ou(Se,$,q){let te=Se[$+Yr],he=te>=1e4?`${Math.round(te/1e3)}k`:te>=1e3?Math.round(te/100)/10+"k":te,ne=Se[$+Ni],_e=ne===-1?{}:Object.assign({},q[ne]);return Object.assign(_e,{cluster:!0,cluster_id:Se[$+Zi],point_count:te,point_count_abbreviated:he})}function Go(Se){return Se/360+.5}function zi(Se){let $=Math.sin(Se*Math.PI/180),q=.5-.25*Math.log((1+$)/(1-$))/Math.PI;return q<0?0:q>1?1:q}function Kr(Se){let $=(180-360*Se)*Math.PI/180;return 360*Math.atan(Math.exp($))/Math.PI-90}function ua(Se,$,q,te){let he=te,ne=$+(q-$>>1),_e,Ae=q-$,ve=Se[$],De=Se[$+1],nt=Se[q],je=Se[q+1];for(let Dt=$+3;Dt<q;Dt+=3){let Ft=su(Se[Dt],Se[Dt+1],ve,De,nt,je);if(Ft>he)_e=Dt,he=Ft;else if(Ft===he){let Ut=Math.abs(Dt-ne);Ut<Ae&&(_e=Dt,Ae=Ut)}}he>te&&(_e-$>3&&ua(Se,$,_e,te),Se[_e+2]=he,q-_e>3&&ua(Se,_e,q,te))}function su(Se,$,q,te,he,ne){let _e=he-q,Ae=ne-te;if(_e!==0||Ae!==0){let ve=((Se-q)*_e+($-te)*Ae)/(_e*_e+Ae*Ae);ve>1?(q=he,te=ne):ve>0&&(q+=_e*ve,te+=Ae*ve)}return _e=Se-q,Ae=$-te,_e*_e+Ae*Ae}function Os(Se,$,q,te){let he={id:Se??null,type:$,geometry:q,tags:te,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if($==="Point"||$==="MultiPoint"||$==="LineString")bo(he,q);else if($==="Polygon")bo(he,q[0]);else if($==="MultiLineString")for(let ne of q)bo(he,ne);else if($==="MultiPolygon")for(let ne of q)bo(he,ne[0]);return he}function bo(Se,$){for(let q=0;q<$.length;q+=3)Se.minX=Math.min(Se.minX,$[q]),Se.minY=Math.min(Se.minY,$[q+1]),Se.maxX=Math.max(Se.maxX,$[q]),Se.maxY=Math.max(Se.maxY,$[q+1])}function co(Se,$,q,te){if(!$.geometry)return;let he=$.geometry.coordinates;if(he&&he.length===0)return;let ne=$.geometry.type,_e=Math.pow(q.tolerance/((1<<q.maxZoom)*q.extent),2),Ae=[],ve=$.id;if(q.promoteId?ve=$.properties[q.promoteId]:q.generateId&&(ve=te||0),ne==="Point")Ls(he,Ae);else if(ne==="MultiPoint")for(let De of he)Ls(De,Ae);else if(ne==="LineString")ks(he,Ae,_e,!1);else if(ne==="MultiLineString"){if(q.lineMetrics){for(let De of he)Ae=[],ks(De,Ae,_e,!1),Se.push(Os(ve,"LineString",Ae,$.properties));return}Ka(he,Ae,_e,!1)}else if(ne==="Polygon")Ka(he,Ae,_e,!0);else{if(ne!=="MultiPolygon"){if(ne==="GeometryCollection"){for(let De of $.geometry.geometries)co(Se,{id:ve,geometry:De,properties:$.properties},q,te);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let De of he){let nt=[];Ka(De,nt,_e,!0),Ae.push(nt)}}Se.push(Os(ve,ne,Ae,$.properties))}function Ls(Se,$){$.push(Vl(Se[0]),Jr(Se[1]),0)}function ks(Se,$,q,te){let he,ne,_e=0;for(let ve=0;ve<Se.length;ve++){let De=Vl(Se[ve][0]),nt=Jr(Se[ve][1]);$.push(De,nt,0),ve>0&&(_e+=te?(he*nt-De*ne)/2:Math.sqrt(Math.pow(De-he,2)+Math.pow(nt-ne,2))),he=De,ne=nt}let Ae=$.length-3;$[2]=1,ua($,0,Ae,q),$[Ae+2]=1,$.size=Math.abs(_e),$.start=0,$.end=$.size}function Ka(Se,$,q,te){for(let he=0;he<Se.length;he++){let ne=[];ks(Se[he],ne,q,te),$.push(ne)}}function Vl(Se){return Se/360+.5}function Jr(Se){let $=Math.sin(Se*Math.PI/180),q=.5-.25*Math.log((1+$)/(1-$))/Math.PI;return q<0?0:q>1?1:q}function wo(Se,$,q,te,he,ne,_e,Ae){if(te/=$,ne>=(q/=$)&&_e<te)return Se;if(_e<q||ne>=te)return null;let ve=[];for(let De of Se){let nt=De.geometry,je=De.type,Dt=he===0?De.minX:De.minY,Ft=he===0?De.maxX:De.maxY;if(Dt>=q&&Ft<te){ve.push(De);continue}if(Ft<q||Dt>=te)continue;let Ut=[];if(je==="Point"||je==="MultiPoint")au(nt,Ut,q,te,he);else if(je==="LineString")Fs(nt,Ut,q,te,he,!1,Ae.lineMetrics);else if(je==="MultiLineString")Mr(nt,Ut,q,te,he,!1);else if(je==="Polygon")Mr(nt,Ut,q,te,he,!0);else if(je==="MultiPolygon")for(let dn of nt){let rn=[];Mr(dn,rn,q,te,he,!0),rn.length&&Ut.push(rn)}if(Ut.length){if(Ae.lineMetrics&&je==="LineString"){for(let dn of Ut)ve.push(Os(De.id,je,dn,De.tags));continue}je!=="LineString"&&je!=="MultiLineString"||(Ut.length===1?(je="LineString",Ut=Ut[0]):je="MultiLineString"),je!=="Point"&&je!=="MultiPoint"||(je=Ut.length===3?"Point":"MultiPoint"),ve.push(Os(De.id,je,Ut,De.tags))}}return ve.length?ve:null}function au(Se,$,q,te,he){for(let ne=0;ne<Se.length;ne+=3){let _e=Se[ne+he];_e>=q&&_e<=te&&Eo($,Se[ne],Se[ne+1],Se[ne+2])}}function Fs(Se,$,q,te,he,ne,_e){let Ae=jl(Se),ve=he===0?da:Ns,De,nt,je=Se.start;for(let rn=0;rn<Se.length-3;rn+=3){let hn=Se[rn],Kn=Se[rn+1],fn=Se[rn+2],Pi=Se[rn+3],ir=Se[rn+4],Ki=he===0?hn:Kn,Gn=he===0?Pi:ir,An=!1;_e&&(De=Math.sqrt(Math.pow(hn-Pi,2)+Math.pow(Kn-ir,2))),Ki<q?Gn>q&&(nt=ve(Ae,hn,Kn,Pi,ir,q),_e&&(Ae.start=je+De*nt)):Ki>te?Gn<te&&(nt=ve(Ae,hn,Kn,Pi,ir,te),_e&&(Ae.start=je+De*nt)):Eo(Ae,hn,Kn,fn),Gn<q&&Ki>=q&&(nt=ve(Ae,hn,Kn,Pi,ir,q),An=!0),Gn>te&&Ki<=te&&(nt=ve(Ae,hn,Kn,Pi,ir,te),An=!0),!ne&&An&&(_e&&(Ae.end=je+De*nt),$.push(Ae),Ae=jl(Se)),_e&&(je+=De)}let Dt=Se.length-3,Ft=Se[Dt],Ut=Se[Dt+1],dn=he===0?Ft:Ut;dn>=q&&dn<=te&&Eo(Ae,Ft,Ut,Se[Dt+2]),Dt=Ae.length-3,ne&&Dt>=3&&(Ae[Dt]!==Ae[0]||Ae[Dt+1]!==Ae[1])&&Eo(Ae,Ae[0],Ae[1],Ae[2]),Ae.length&&$.push(Ae)}function jl(Se){let $=[];return $.size=Se.size,$.start=Se.start,$.end=Se.end,$}function Mr(Se,$,q,te,he,ne){for(let _e of Se)Fs(_e,$,q,te,he,ne,!1)}function Eo(Se,$,q,te){Se.push($,q,te)}function da(Se,$,q,te,he,ne){let _e=(ne-$)/(te-$);return Eo(Se,ne,q+(he-q)*_e,1),_e}function Ns(Se,$,q,te,he,ne){let _e=(ne-q)/(he-q);return Eo(Se,$+(te-$)*_e,ne,1),_e}function ha(Se,$){let q=[];for(let te=0;te<Se.length;te++){let he=Se[te],ne=he.type,_e;if(ne==="Point"||ne==="MultiPoint"||ne==="LineString")_e=fa(he.geometry,$);else if(ne==="MultiLineString"||ne==="Polygon"){_e=[];for(let Ae of he.geometry)_e.push(fa(Ae,$))}else if(ne==="MultiPolygon"){_e=[];for(let Ae of he.geometry){let ve=[];for(let De of Ae)ve.push(fa(De,$));_e.push(ve)}}q.push(Os(he.id,ne,_e,he.tags))}return q}function fa(Se,$){let q=[];q.size=Se.size,Se.start!==void 0&&(q.start=Se.start,q.end=Se.end);for(let te=0;te<Se.length;te+=3)q.push(Se[te]+$,Se[te+1],Se[te+2]);return q}function Ul(Se,$){if(Se.transformed)return Se;let q=1<<Se.z,te=Se.x,he=Se.y;for(let ne of Se.features){let _e=ne.geometry,Ae=ne.type;if(ne.geometry=[],Ae===1)for(let ve=0;ve<_e.length;ve+=2)ne.geometry.push(ui(_e[ve],_e[ve+1],$,q,te,he));else for(let ve=0;ve<_e.length;ve++){let De=[];for(let nt=0;nt<_e[ve].length;nt+=2)De.push(ui(_e[ve][nt],_e[ve][nt+1],$,q,te,he));ne.geometry.push(De)}}return Se.transformed=!0,Se}function ui(Se,$,q,te,he,ne){return[Math.round(q*(Se*te-he)),Math.round(q*($*te-ne))]}function lu(Se,$,q,te,he){let ne=$===he.maxZoom?0:he.tolerance/((1<<$)*he.extent),_e={features:[],numPoints:0,numSimplified:0,numFeatures:Se.length,source:null,x:q,y:te,z:$,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let Ae of Se)cu(_e,Ae,ne,he);return _e}function cu(Se,$,q,te){let he=$.geometry,ne=$.type,_e=[];if(Se.minX=Math.min(Se.minX,$.minX),Se.minY=Math.min(Se.minY,$.minY),Se.maxX=Math.max(Se.maxX,$.maxX),Se.maxY=Math.max(Se.maxY,$.maxY),ne==="Point"||ne==="MultiPoint")for(let Ae=0;Ae<he.length;Ae+=3)_e.push(he[Ae],he[Ae+1]),Se.numPoints++,Se.numSimplified++;else if(ne==="LineString")To(_e,he,Se,q,!1,!1);else if(ne==="MultiLineString"||ne==="Polygon")for(let Ae=0;Ae<he.length;Ae++)To(_e,he[Ae],Se,q,ne==="Polygon",Ae===0);else if(ne==="MultiPolygon")for(let Ae=0;Ae<he.length;Ae++){let ve=he[Ae];for(let De=0;De<ve.length;De++)To(_e,ve[De],Se,q,!0,De===0)}if(_e.length){let Ae=$.tags||null;if(ne==="LineString"&&te.lineMetrics){Ae={};for(let De in $.tags)Ae[De]=$.tags[De];Ae.mapbox_clip_start=he.start/he.size,Ae.mapbox_clip_end=he.end/he.size}let ve={geometry:_e,type:ne==="Polygon"||ne==="MultiPolygon"?3:ne==="LineString"||ne==="MultiLineString"?2:1,tags:Ae};$.id!==null&&(ve.id=$.id),Se.features.push(ve)}}function To(Se,$,q,te,he,ne){let _e=te*te;if(te>0&&$.size<(he?_e:te))return void(q.numPoints+=$.length/3);let Ae=[];for(let ve=0;ve<$.length;ve+=3)(te===0||$[ve+2]>_e)&&(q.numSimplified++,Ae.push($[ve],$[ve+1])),q.numPoints++;he&&function(ve,De){let nt=0;for(let je=0,Dt=ve.length,Ft=Dt-2;je<Dt;Ft=je,je+=2)nt+=(ve[je]-ve[Ft])*(ve[je+1]+ve[Ft+1]);if(nt>0===De)for(let je=0,Dt=ve.length;je<Dt/2;je+=2){let Ft=ve[je],Ut=ve[je+1];ve[je]=ve[Dt-2-je],ve[je+1]=ve[Dt-1-je],ve[Dt-2-je]=Ft,ve[Dt-1-je]=Ut}}(Ae,ne),Se.push(Ae)}let uu={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class fp{constructor($,q){let te=(q=this.options=function(ne,_e){for(let Ae in _e)ne[Ae]=_e[Ae];return ne}(Object.create(uu),q)).debug;if(te&&console.time("preprocess data"),q.maxZoom<0||q.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(q.promoteId&&q.generateId)throw new Error("promoteId and generateId cannot be used together.");let he=function(ne,_e){let Ae=[];if(ne.type==="FeatureCollection")for(let ve=0;ve<ne.features.length;ve++)co(Ae,ne.features[ve],_e,ve);else co(Ae,ne.type==="Feature"?ne:{geometry:ne},_e);return Ae}($,q);this.tiles={},this.tileCoords=[],te&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",q.indexMaxZoom,q.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),he=function(ne,_e){let Ae=_e.buffer/_e.extent,ve=ne,De=wo(ne,1,-1-Ae,Ae,0,-1,2,_e),nt=wo(ne,1,1-Ae,2+Ae,0,-1,2,_e);return(De||nt)&&(ve=wo(ne,1,-Ae,1+Ae,0,-1,2,_e)||[],De&&(ve=ha(De,1).concat(ve)),nt&&(ve=ve.concat(ha(nt,-1)))),ve}(he,q),he.length&&this.splitTile(he,0,0,0),te&&(he.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile($,q,te,he,ne,_e,Ae){let ve=[$,q,te,he],De=this.options,nt=De.debug;for(;ve.length;){he=ve.pop(),te=ve.pop(),q=ve.pop(),$=ve.pop();let je=1<<q,Dt=Hl(q,te,he),Ft=this.tiles[Dt];if(!Ft&&(nt>1&&console.time("creation"),Ft=this.tiles[Dt]=lu($,q,te,he,De),this.tileCoords.push({z:q,x:te,y:he}),nt)){nt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",q,te,he,Ft.numFeatures,Ft.numPoints,Ft.numSimplified),console.timeEnd("creation"));let An=`z${q}`;this.stats[An]=(this.stats[An]||0)+1,this.total++}if(Ft.source=$,ne==null){if(q===De.indexMaxZoom||Ft.numPoints<=De.indexMaxPoints)continue}else{if(q===De.maxZoom||q===ne)continue;if(ne!=null){let An=ne-q;if(te!==_e>>An||he!==Ae>>An)continue}}if(Ft.source=null,$.length===0)continue;nt>1&&console.time("clipping");let Ut=.5*De.buffer/De.extent,dn=.5-Ut,rn=.5+Ut,hn=1+Ut,Kn=null,fn=null,Pi=null,ir=null,Ki=wo($,je,te-Ut,te+rn,0,Ft.minX,Ft.maxX,De),Gn=wo($,je,te+dn,te+hn,0,Ft.minX,Ft.maxX,De);$=null,Ki&&(Kn=wo(Ki,je,he-Ut,he+rn,1,Ft.minY,Ft.maxY,De),fn=wo(Ki,je,he+dn,he+hn,1,Ft.minY,Ft.maxY,De),Ki=null),Gn&&(Pi=wo(Gn,je,he-Ut,he+rn,1,Ft.minY,Ft.maxY,De),ir=wo(Gn,je,he+dn,he+hn,1,Ft.minY,Ft.maxY,De),Gn=null),nt>1&&console.timeEnd("clipping"),ve.push(Kn||[],q+1,2*te,2*he),ve.push(fn||[],q+1,2*te,2*he+1),ve.push(Pi||[],q+1,2*te+1,2*he),ve.push(ir||[],q+1,2*te+1,2*he+1)}}getTile($,q,te){$=+$,q=+q,te=+te;let he=this.options,{extent:ne,debug:_e}=he;if($<0||$>24)return null;let Ae=1<<$,ve=Hl($,q=q+Ae&Ae-1,te);if(this.tiles[ve])return Ul(this.tiles[ve],ne);_e>1&&console.log("drilling down to z%d-%d-%d",$,q,te);let De,nt=$,je=q,Dt=te;for(;!De&&nt>0;)nt--,je>>=1,Dt>>=1,De=this.tiles[Hl(nt,je,Dt)];return De&&De.source?(_e>1&&(console.log("found parent tile z%d-%d-%d",nt,je,Dt),console.time("drilling down")),this.splitTile(De.source,nt,je,Dt,$,q,te),_e>1&&console.timeEnd("drilling down"),this.tiles[ve]?Ul(this.tiles[ve],ne):null):null}}function Hl(Se,$,q){return 32*((1<<Se)*q+$)+Se}function Xe(Se,$){let q=Se.tileID.canonical;if(!this._geoJSONIndex)return void $(null,null);let te=this._geoJSONIndex.getTile(q.z,q.x,q.y);if(!te)return void $(null,null);let he=De=>De.tags&&"3d_elevation_id"in De.tags&&"source"in De.tags&&De.tags.source==="elevation",ne=te.features.filter(De=>he(De)),_e={_geojsonTileLayer:te.features};ne.length>0&&(_e={_geojsonTileLayer:te.features.filter(De=>!he(De)),hd_road_elevation:ne});let Ae=new _s(_e),ve=function(De){let nt=new r.bq;for(let je of Object.keys(De))nt.writeMessage(3,ru,{name:je,features:De[je]});return nt.finish()}(_e).buffer;$(null,{vectorTile:Ae,rawData:ve})}class zs extends Pt{constructor($,q,te,he,ne,_e,Ae){super($,q,te,he,ne,Xe,Ae),_e&&(this.loadGeoJSON=_e),this._dynamicIndex=new qd}loadData($,q){let te=$&&$.request,he=te&&te.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON($,(ne,_e)=>{if(ne||!_e)return q(ne);if(typeof _e!="object")return q(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`));{try{if($.filter){let ve=r.X($.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ve.result==="error")throw new Error(ve.value.map(De=>`${De.key}: ${De.message}`).join(", "));_e.features=_e.features.filter(De=>ve.value.evaluate({zoom:0},De))}$.dynamic?(_e.type==="Feature"&&(_e={type:"FeatureCollection",features:[_e]}),$.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(_e.features,this.loaded),$.cluster&&(_e.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=$.cluster?new la(function({superclusterOptions:ve,clusterProperties:De}){if(!De||!ve)return ve;let nt={},je={},Dt={accumulated:null,zoom:0},Ft={properties:null},Ut=Object.keys(De);for(let dn of Ut){let[rn,hn]=De[dn],Kn=r.X(hn),fn=r.X(typeof rn=="string"?[rn,["accumulated"],["get",dn]]:rn);nt[dn]=Kn.value,je[dn]=fn.value}return ve.map=dn=>{Ft.properties=dn;let rn={};for(let hn of Ut)rn[hn]=nt[hn].evaluate(Dt,Ft);return rn},ve.reduce=(dn,rn)=>{Ft.properties=rn;for(let hn of Ut)Dt.accumulated=dn[hn],dn[hn]=je[hn].evaluate(Dt,Ft)},ve}($)).load(_e.features):$.dynamic?this._dynamicIndex:function(ve,De){return new fp(ve,De)}(_e,$.geojsonVtOptions)}catch(ve){return q(ve)}let Ae={};if(he){let ve=M(te);ve&&(Ae.resourceTiming={},Ae.resourceTiming[$.source]=JSON.parse(JSON.stringify(ve)))}q(null,Ae)}})}reloadTile($,q){let te=this.loaded;return te&&te[$.uid]?$.partial?q(null,void 0):super.reloadTile($,q):this.loadTile($,q)}loadGeoJSON($,q){if($.request)r.n($.request,q);else{if(typeof $.data!="string")return q(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return q(null,JSON.parse($.data))}catch{return q(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom($,q){try{q(null,this._geoJSONIndex.getClusterExpansionZoom($.clusterId))}catch(te){q(te)}}getClusterChildren($,q){try{q(null,this._geoJSONIndex.getChildren($.clusterId))}catch(te){q(te)}}getClusterLeaves($,q){try{q(null,this._geoJSONIndex.getLeaves($.clusterId,$.limit,$.offset))}catch(te){q(te)}}}class pp{constructor($,q,te){this.tileID=new r.aM($.tileID.overscaledZ,$.tileID.wrap,$.tileID.canonical.z,$.tileID.canonical.x,$.tileID.canonical.y),this.tileZoom=$.tileZoom,this.uid=$.uid,this.zoom=$.zoom,this.canonical=$.tileID.canonical,this.pixelRatio=$.pixelRatio,this.tileSize=$.tileSize,this.source=$.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=$.projection,this.brightness=q,this.worldview=te}parse($,q,te,he){this.status="parsing";let ne=new r.aM(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),_e=[],Ae=q.familiesBySource[te.source],ve=new r.fc(ne,te.promoteId);ve.bucketLayerIDs=[],ve.is3DTile=!0,r.fr($).then(De=>{if(!De)return he(new Error("Could not parse tile"));let nt=De.json.extensionsUsed&&De.json.extensionsUsed.includes("MAPBOX_mesh_features")||De.json.asset.extras&&De.json.asset.extras.MAPBOX_mesh_features,je=De.json.extensionsUsed&&De.json.extensionsUsed.includes("EXT_meshopt_compression"),Dt=new r.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(let Ft in Ae)for(let Ut of Ae[Ft]){let dn=Ut[0];ve.bucketLayerIDs.push(Ut.map(Kn=>r.C(Kn.id,Kn.scope))),dn.recalculate(Dt,[]);let rn=r.fs(De,1/r.d4(te.tileID.canonical)),hn=new r.ft(Ut,rn,ne,nt,je,this.brightness,ve,this.worldview);nt||(hn.needsUpload=!0),_e.push(hn),hn.evaluate(dn)}this.status="done",he(null,{buckets:_e,featureIndex:ve,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(De=>he(new Error(De.message)))}}class du{constructor($,q,te,he,ne,_e,Ae,ve){this.actor=$,this.layerIndex=q,this.availableImages=te,this.availableModels=he,this.brightness=Ae,this.loading={},this.loaded={},this.worldview=ve}loadTile($,q){let te=$.uid,he=this.loading[te]=new pp($,this.brightness,this.worldview);r.br($.request,(ne,_e)=>{let Ae=!this.loading[te];return delete this.loading[te],Ae||ne?(he.status="done",Ae||(this.loaded[te]=he),q(ne)):_e&&_e.byteLength!==0?void he.parse(_e,this.layerIndex,$,(ve,De)=>{he.status="done",this.loaded=this.loaded||{},this.loaded[te]=he,ve||!De?q(ve):q(null,De)}):(he.status="done",this.loaded[te]=he,q())})}reloadTile($,q){let te=this.loaded,he=$.uid;if(te&&te[he]){let ne=te[he];ne.projection=$.projection,ne.brightness=$.brightness;let _e=(Ae,ve)=>{ne.reloadCallback&&(delete ne.reloadCallback,this.loadTile($,q)),q(Ae,ve)};ne.status==="parsing"?ne.reloadCallback=_e:ne.status==="done"&&this.loadTile($,q)}}abortTile($,q){let te=$.uid;this.loading[te]&&delete this.loading[te],q()}removeTile($,q){let te=this.loaded,he=$.uid;te&&te[he]&&delete te[he],q()}}class Sn{constructor($){this.self=$,this.actor=new r.fv($,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new r.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=r.cj({name:"mercator"}),this.workerSourceTypes={vector:Pt,geojson:zs,"raster-dem":Vt,"raster-array":Nt,"batched-model":du},this.workerSources={},this.self.registerWorkerSource=(q,te)=>{if(this.workerSourceTypes[q])throw new Error(`Worker source with name "${q}" already registered.`);this.workerSourceTypes[q]=te},this.self.registerRTLTextPlugin=q=>{if(r.fw.isParsed())throw new Error("RTL text plugin already registered.");r.fw.setState({pluginStatus:r.fx.parsed,pluginURL:r.fw.getPluginURL()}),r.fw.applyArabicShaping=q.applyArabicShaping,r.fw.processBidirectionalText=q.processBidirectionalText,r.fw.processStyledBidirectionalText=q.processStyledBidirectionalText;for(let te of this.rtlPluginParsingListeners)te(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches($,q,te){delete this.layerIndexes[$],delete this.availableImages[$],delete this.availableModels[$],delete this.workerSources[$],te()}checkIfReady($,q,te){te()}setReferrer($,q){this.referrer=q}spriteLoaded($,q){this.isSpriteLoaded[$]||(this.isSpriteLoaded[$]={});let{scope:te,isLoaded:he}=q;if(this.isSpriteLoaded[$][te]=he,this.workerSources[$]&&this.workerSources[$][te])for(let ne in this.workerSources[$][te]){let _e=this.workerSources[$][te][ne];for(let Ae in _e){let ve=_e[Ae];ve instanceof Pt&&(ve.isSpriteLoaded=he,ve.fire(new r.A("isSpriteLoaded")))}}}setImages($,q,te){this.availableImages[$]||(this.availableImages[$]={});let{scope:he,images:ne}=q;if(this.availableImages[$][he]=ne,this.workerSources[$]&&this.workerSources[$][he]){for(let _e in this.workerSources[$][he]){let Ae=this.workerSources[$][he][_e];for(let ve in Ae)Ae[ve].availableImages=ne}te()}else te()}setModels($,{scope:q,models:te},he){if(this.availableModels[$]||(this.availableModels[$]={}),this.availableModels[$][q]=te,this.workerSources[$]&&this.workerSources[$][q]){for(let ne in this.workerSources[$][q]){let _e=this.workerSources[$][q][ne];for(let Ae in _e)_e[Ae].availableModels=te}he()}else he()}setProjection($,q){this.projections[$]=r.cj(q)}setBrightness($,q,te){this.brightness=q,te()}setWorldview($,q,te){this.worldview=q,te()}setLayers($,q,te){this.getLayerIndex($,q.scope).replace(q.layers,q.options),te()}updateLayers($,q,te){this.getLayerIndex($,q.scope).update(q.layers,q.removedIds,q.options),te()}loadTile($,q,te){q.projection=this.projections[$]||this.defaultProjection,this.getWorkerSource($,q.type,q.source,q.scope).loadTile(q,te)}decodeRasterArray($,q,te){this.getWorkerSource($,q.type,q.source,q.scope).decodeRasterArray(q,te)}reloadTile($,q,te){q.projection=this.projections[$]||this.defaultProjection,this.getWorkerSource($,q.type,q.source,q.scope).reloadTile(q,te)}abortTile($,q,te){this.getWorkerSource($,q.type,q.source,q.scope).abortTile(q,te)}removeTile($,q,te){this.getWorkerSource($,q.type,q.source,q.scope).removeTile(q,te)}removeSource($,q,te){if(!(this.workerSources[$]&&this.workerSources[$][q.scope]&&this.workerSources[$][q.scope][q.type]&&this.workerSources[$][q.scope][q.type][q.source]))return;let he=this.workerSources[$][q.scope][q.type][q.source];delete this.workerSources[$][q.scope][q.type][q.source],he.removeSource!==void 0?he.removeSource(q,te):te()}loadWorkerSource($,q,te){try{this.self.importScripts(q.url),te()}catch(he){te(he.toString())}}syncRTLPluginState($,q,te){if(r.fw.isParsed())te(null,!0);else if(r.fw.isParsing())this.rtlPluginParsingListeners.push(te);else try{r.fw.setState(q);let he=r.fw.getPluginURL();!r.fw.isLoaded()||r.fw.isParsed()||r.fw.isParsing()||he==null||(r.fw.setState({pluginStatus:r.fx.parsing,pluginURL:r.fw.getPluginURL()}),this.self.importScripts(he),r.fw.isParsed()?te(null,!0):this.rtlPluginParsingListeners.push(te))}catch(he){te(he.toString())}}setDracoUrl($,q){this.dracoUrl=q}getAvailableImages($,q){this.availableImages[$]||(this.availableImages[$]={});let te=this.availableImages[$][q];return te||(te=[]),te}getAvailableModels($,q){this.availableModels[$]||(this.availableModels[$]={});let te=this.availableModels[$][q];return te||(te={}),te}getLayerIndex($,q){this.layerIndexes[$]||(this.layerIndexes[$]={});let te=this.layerIndexes[$][q];return te||(te=this.layerIndexes[$][q]=new fe,te.scope=q),te}getWorkerSource($,q,te,he){let ne=this.workerSources;return ne[$]||(ne[$]={}),ne[$][he]||(ne[$][he]={}),ne[$][he][q]||(ne[$][he][q]={}),this.isSpriteLoaded[$]||(this.isSpriteLoaded[$]={}),ne[$][he][q][te]||(ne[$][he][q][te]=new this.workerSourceTypes[q]({send:(_e,Ae,ve,De,nt,je)=>this.actor.send(_e,Ae,ve,$,nt,je),scheduler:this.actor.scheduler},this.getLayerIndex($,he),this.getAvailableImages($,he),this.getAvailableModels($,he),this.isSpriteLoaded[$][he],void 0,this.brightness,this.worldview)),ne[$][he][q][te]}rasterizeImagesWorker($,q,te){let he=new Map;for(let[ne,{image:_e,imageVariant:Ae}]of q.tasks.entries()){let ve=this.imageRasterizer.rasterize(Ae,_e,q.scope,$);he.set(ne,ve)}te(void 0,he)}removeRasterizedImages($,q,te){this.imageRasterizer.removeImagesFromCacheByIds(q.imageIds,q.scope,$),te()}enforceCacheSizeLimit($,q){r.fy(q)}getWorkerPerformanceMetrics($,q,te){te(void 0,void 0)}}return r.fu(self)&&(self.worker=new Sn(self)),Sn}),m(["./shared"],function(r){var M="3.14.0";let N={create:"create",load:"load",fullLoad:"fullLoad"},G={mark(u){performance.mark(u)},measure(u,t,o){performance.measure(u,t,o)}};function fe(u){let t=u.name.split("?")[0];return r.a(t)&&t.includes("mapbox-gl.js")?"javascript":r.a(t)&&t.includes("mapbox-gl.css")?"css":r.b(t)?"fontRange":r.c(t)?"sprite":r.i(t)?"style":r.d(t)?"tilejson":"other"}var Me,Ue={},bt=function(){if(Me)return Ue;function u(h){return!t(h)}function t(h){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var _,v,E=new Blob([""],{type:"text/javascript"}),T=URL.createObjectURL(E);try{v=new Worker(T),_=!0}catch{_=!1}return v&&v.terminate(),URL.revokeObjectURL(T),_}()?function(){var _=document.createElement("canvas");_.width=_.height=1;var v=_.getContext("2d");if(!v)return!1;var E=v.getImageData(0,0,1,1);return E&&E.width===_.width}()?(o[g=h&&h.failIfMajorPerformanceCaveat]===void 0&&(o[g]=function(_){var v,E=function(T){var C=document.createElement("canvas"),A=Object.create(u.webGLContextAttributes);return A.failIfMajorPerformanceCaveat=T,C.getContext("webgl2",A)}(_);if(!E)return!1;try{v=E.createShader(E.VERTEX_SHADER)}catch{return!1}return!(!v||E.isContextLost())&&(E.shaderSource(v,"void main() {}"),E.compileShader(v),E.getShaderParameter(v,E.COMPILE_STATUS)===!0)}(g)),o[g]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var g}Me=1,Ue.supported=u,Ue.notSupportedReason=t;var o={};return u.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Ue}();function Fe(u,t,o){let h=document.createElement(u);return t!=null&&(h.className=t),o&&o.appendChild(h),h}function Pt(u,t,o){let h=document.createElementNS("http://www.w3.org/2000/svg",u);for(let g of Object.keys(t))h.setAttributeNS(null,g,String(t[g]));return o&&o.appendChild(h),h}let Vt=typeof document<"u"?document.documentElement&&document.documentElement.style:null,jt=Vt&&Vt.userSelect!==void 0?"userSelect":"WebkitUserSelect",Nt;function ar(){Vt&&jt&&(Nt=Vt[jt],Vt[jt]="none")}function lr(){Vt&&jt&&(Vt[jt]=Nt)}function Ri(u){u.preventDefault(),u.stopPropagation(),window.removeEventListener("click",Ri,!0)}function _s(){window.addEventListener("click",Ri,!0),window.setTimeout(()=>{window.removeEventListener("click",Ri,!0)},0)}function xo(u,t){let o=u.getBoundingClientRect();return Nn(u,o,t)}function ys(u,t){let o=u.getBoundingClientRect(),h=[];for(let g=0;g<t.length;g++)h.push(Nn(u,o,t[g]));return h}function qd(u){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&u.button===2&&u.ctrlKey?0:u.button}function Nn(u,t,o){let h=u.offsetWidth===t.width?1:u.offsetWidth/t.width;return new r.P((o.clientX-t.left)*h,(o.clientY-t.top)*h)}let zl="01",Er="NO_ACCESS_TOKEN";class Wi{constructor(t,o,h){this._transformRequestFn=t,this._customAccessToken=o,this._silenceAuthErrors=!!h,this._createSkuToken()}_createSkuToken(){let t=function(){let o="";for(let h=0;h<10;h++)o+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",zl,o].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,o){return this._transformRequestFn&&this._transformRequestFn(t,o)||{url:t}}normalizeStyleURL(t,o){if(!r.j(t))return t;let h=pi(t);return h.params.push(`sdk=js-${M}`),h.path=`/styles/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeGlyphsURL(t,o){if(!r.j(t))return t;let h=pi(t);return h.path=`/fonts/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeModelURL(t,o){if(!r.j(t))return t;let h=pi(t);return h.path=`/models/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeSourceURL(t,o,h,g){if(!r.j(t))return t;let _=pi(t);return _.path=`/v4/${_.authority}.json`,_.params.push("secure"),h&&_.params.push(`language=${h}`),g&&_.params.push(`worldview=${g}`),this._makeAPIURL(_,this._customAccessToken||o)}normalizeIconsetURL(t,o){let h=pi(t);return r.j(t)?(h.path=`/styles/v1${h.path}/iconset.pbf`,this._makeAPIURL(h,this._customAccessToken||o)):lo(h)}normalizeSpriteURL(t,o,h,g){let _=pi(t);return r.j(t)?(_.path=`/styles/v1${_.path}/sprite${o}${h}`,this._makeAPIURL(_,this._customAccessToken||g)):(_.path+=`${o}${h}`,lo(_))}normalizeTileURL(t,o,h){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!r.j(t))return t;let g=pi(t);g.path=g.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${o||h&&g.authority!=="raster"&&h===512?"@2x":""}${r.l.supported?".webp":"$1"}`),g.authority==="raster"?g.path=`/${r.e.RASTER_URL_PREFIX}${g.path}`:g.authority==="rasterarrays"?g.path=`/${r.e.RASTERARRAYS_URL_PREFIX}${g.path}`:g.authority==="3dtiles"?g.path=`/${r.e.TILES3D_URL_PREFIX}${g.path}`:(g.path=g.path.replace(/^.+\/v4\//,"/"),g.path=`/${r.e.TILE_URL_VERSION}${g.path}`);let _=this._customAccessToken||function(v){for(let E of v){let T=E.match(/^access_token=(.*)$/);if(T)return T[1]}return null}(g.params)||r.e.ACCESS_TOKEN;return r.e.REQUIRE_ACCESS_TOKEN&&_&&this._skuToken&&g.params.push(`sku=${this._skuToken}`),this._makeAPIURL(g,_)}canonicalizeTileURL(t,o){let h=pi(t);if(!h.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!h.path.match(/\.[\w]+$/))return t;let g="mapbox://";h.path.match(/^\/raster\/v1\//)?g+=`raster/${h.path.replace(`/${r.e.RASTER_URL_PREFIX}/`,"")}`:h.path.match(/^\/rasterarrays\/v1\//)?g+=`rasterarrays/${h.path.replace(`/${r.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:g+=`tiles/${h.path.replace(`/${r.e.TILE_URL_VERSION}/`,"")}`;let _=h.params;return o&&(_=_.filter(v=>!v.match(/^access_token=/))),_.length&&(g+=`?${_.join("&")}`),g}canonicalizeTileset(t,o){let h=!!o&&r.j(o),g=[];for(let _ of t.tiles||[])r.k(_)?g.push(this.canonicalizeTileURL(_,h)):g.push(_);return g}_makeAPIURL(t,o){let h="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",g=pi(r.e.API_URL);if(t.protocol=g.protocol,t.authority=g.authority,t.protocol==="http"){let _=t.params.indexOf("secure");_>=0&&t.params.splice(_,1)}if(g.path!=="/"&&(t.path=`${g.path}${t.path}`),!r.e.REQUIRE_ACCESS_TOKEN)return lo(t);if(o=o||r.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!o)throw new Error(`An API access token is required to use Mapbox GL. ${h}`);if(o[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${h}`)}return t.params=t.params.filter(_=>_.indexOf("access_token")===-1),t.params.push(`access_token=${o||""}`),lo(t)}}let Ui=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function pi(u){let t=u.match(Ui);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function lo(u){let t=u.params.length?`?${u.params.join("&")}`:"";return`${u.protocol}://${u.authority}${u.path}${t}`}let ru="mapbox.eventData";function Ps(u){if(!u)return null;let t=u.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(r.m(t[1]))}catch{return null}}class $o{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){let o=Ps(r.e.ACCESS_TOKEN),h="";return h=o&&o.u?r.f(o.u):r.e.ACCESS_TOKEN||"",t?`${ru}.${t}:${h}`:`${ru}:${h}`}fetchEventData(){let t=r.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid");if(t)try{let g=localStorage.getItem(o);g&&(this.eventData=JSON.parse(g));let _=localStorage.getItem(h);_&&(this.anonId=_)}catch{r.w("Unable to read from LocalStorage")}}saveEventData(){let t=r.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid"),g=this.anonId;if(t&&g)try{localStorage.setItem(h,g),Object.keys(this.eventData).length>=1&&localStorage.setItem(o,JSON.stringify(this.eventData))}catch{r.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,o,h,g){if(!r.e.EVENTS_URL)return;let _=pi(r.e.EVENTS_URL);_.params.push(`access_token=${g||r.e.ACCESS_TOKEN||""}`);let v={event:this.type,created:new Date(t).toISOString()},E=o?r.h(v,o):v,T={url:lo(_),headers:{"Content-Type":"text/plain"},body:JSON.stringify([E])};this.pendingRequest=r.p(T,C=>{this.pendingRequest=null,h(C),this.saveEventData(),this.processRequests(g)})}queueRequest(t,o){this.queue.push(t),this.processRequests(o)}}let hi=new class extends $o{constructor(u){super("appUserTurnstile"),this._customAccessToken=u}postTurnstileEvent(u,t){r.e.EVENTS_URL&&r.e.ACCESS_TOKEN&&Array.isArray(u)&&u.some(o=>r.j(o)||r.k(o))&&this.queueRequest(Date.now(),t)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let t=Ps(r.e.ACCESS_TOKEN),o=t?t.u:r.e.ACCESS_TOKEN,h=o!==this.eventData.tokenU;r.v(this.anonId)||(this.anonId=r.u(),h=!0);let g=this.queue.shift();if(this.eventData.lastSuccess){let _=new Date(this.eventData.lastSuccess),v=new Date(g),E=(g-this.eventData.lastSuccess)/864e5;h=h||E>=1||E<-1||_.getDate()!==v.getDate()}else h=!0;h?this.postEvent(g,{sdkIdentifier:"mapbox-gl-js",sdkVersion:M,skuId:zl,"enabled.telemetry":!1,userId:this.anonId},_=>{_||(this.eventData.lastSuccess=g,this.eventData.tokenU=o)},u):this.processRequests()}},zr=hi.postTurnstileEvent.bind(hi),Bl=new class extends $o{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(u,t,o,h){this.skuToken=t,this.errorCb=h,r.e.EVENTS_URL&&(o||r.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},o):this.errorCb(new Error(Er)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),r.v(this.anonId)||(this.anonId=r.u()),this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:M,skuId:zl,skuToken:this.skuToken,userId:this.anonId},h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},u))}remove(){this.errorCb=null}},Wd=Bl.postMapLoadEvent.bind(Bl),aa=new class extends $o{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(u){let t=this.mapInstanceIdMap.get(u);return t||(t=r.u(),this.mapInstanceIdMap.set(u,t)),t}getEventId(u){let t=this.eventIdPerMapInstanceMap.get(u)||0;return this.eventIdPerMapInstanceMap.set(u,t+1),t}postStyleLoadEvent(u,t){let{map:o,style:h,importedStyles:g}=t;if(!r.e.EVENTS_URL||!u&&!r.e.ACCESS_TOKEN)return;let _=this.getMapInstanceId(o),v={mapInstanceId:_,eventId:this.getEventId(_),style:h};g.length&&(v.importedStyles=g),this.queueRequest({timestamp:Date.now(),payload:v},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,payload:o}=this.queue.shift();this.postEvent(t,o,()=>{},u)}},ci=aa.postStyleLoadEvent.bind(aa),Fi=new class extends $o{constructor(){super("gljs.performance")}postPerformanceEvent(u,t){r.e.EVENTS_URL&&(u||r.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,performanceData:o}=this.queue.shift(),h=function(g){let _=performance.getEntriesByType("resource"),v=performance.getEntriesByType("mark"),E=function(k){let V={};if(k){for(let z in k)if(z!=="other")for(let U of k[z]){let j=`${z}ResolveRangeMin`,W=`${z}ResolveRangeMax`,Y=`${z}RequestCount`,J=`${z}RequestCachedCount`;V[j]=Math.min(V[j]||1/0,U.startTime),V[W]=Math.max(V[W]||-1/0,U.responseEnd);let ie=le=>{V[le]===void 0&&(V[le]=0),++V[le]};U.transferSize!==void 0&&U.transferSize===0&&ie(J),ie(Y)}}return V}(function(k,V){let z={};if(k)for(let U of k){let j=V(U);z[j]===void 0&&(z[j]=[]),z[j].push(U)}return z}(_,fe)),T=window.devicePixelRatio,C=navigator.connection||navigator.mozConnection||navigator.webkitConnection,A=C?C.effectiveType:void 0,L={counters:[],metadata:[],attributes:[]},R=(k,V,z)=>{z!=null&&k.push({name:V,value:z.toString()})};for(let k in E)R(L.counters,k,E[k]);if(g.interactionRange[0]!==1/0&&g.interactionRange[1]!==-1/0&&(R(L.counters,"interactionRangeMin",g.interactionRange[0]),R(L.counters,"interactionRangeMax",g.interactionRange[1])),v)for(let k of Object.keys(N)){let V=N[k],z=v.find(U=>U.name===V);z&&R(L.counters,V,z.startTime)}return R(L.counters,"visibilityHidden",g.visibilityHidden),R(L.attributes,"style",function(k){if(k)for(let V of k){let z=V.name.split("?")[0];if(r.i(z)){let U=z.split("/").slice(-2);if(U.length===2)return`mapbox://styles/${U[0]}/${U[1]}`}}}(_)),R(L.attributes,"terrainEnabled",g.terrainEnabled?"true":"false"),R(L.attributes,"fogEnabled",g.fogEnabled?"true":"false"),R(L.attributes,"projection",g.projection),R(L.attributes,"zoom",g.zoom),R(L.metadata,"devicePixelRatio",T),R(L.metadata,"connectionEffectiveType",A),R(L.metadata,"navigatorUserAgent",navigator.userAgent),R(L.metadata,"screenWidth",window.screen.width),R(L.metadata,"screenHeight",window.screen.height),R(L.metadata,"windowWidth",window.innerWidth),R(L.metadata,"windowHeight",window.innerHeight),R(L.metadata,"mapWidth",g.width/T),R(L.metadata,"mapHeight",g.height/T),R(L.metadata,"webglRenderer",g.renderer),R(L.metadata,"webglVendor",g.vendor),R(L.metadata,"sdkVersion",M),R(L.metadata,"sdkIdentifier","mapbox-gl-js"),L}(o);for(let g of h.metadata);for(let g of h.counters);for(let g of h.attributes);this.postEvent(t,h,()=>{},u)}},Zi=Fi.postPerformanceEvent.bind(Fi),Yr=new class extends $o{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(u,t,o,h){if(!r.e.API_URL||!r.e.SESSION_PATH)return;let g=pi(r.e.API_URL+r.e.SESSION_PATH);g.params.push(`sku=${t||""}`),g.params.push(`access_token=${h||r.e.ACCESS_TOKEN||""}`);let _={url:lo(g),headers:{"Content-Type":"text/plain"}};this.pendingRequest=r.g(_,v=>{this.pendingRequest=null,o(v),this.saveEventData(),this.processRequests(h)})}getSessionAPI(u,t,o,h){this.skuToken=t,this.errorCb=h,r.e.SESSION_PATH&&r.e.API_URL&&(o||r.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},o):this.errorCb(new Error(Er)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||this.getSession(o,this.skuToken,h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},u)}remove(){this.errorCb=null}},Ni=Yr.getSessionAPI.bind(Yr),la=new Set;function ca(u,t){t?la.add(u):la.delete(u)}class ou{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,o){this._updatedSourceCaches[t]=o,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){let o=t.scope;this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._updatedLayers[o].add(t.id),this.setDirty()}removeLayer(t){let o=t.scope;this._removedLayers[o]=this._removedLayers[o]||{},this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._removedLayers[o][t.id]=t,this._updatedLayers[o].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){let t={};for(let o in this._updatedLayers)t[o]=t[o]||{},t[o].updatedIds=Array.from(this._updatedLayers[o].values());for(let o in this._removedLayers)t[o]=t[o]||{},t[o].removedIds=Object.keys(this._removedLayers[o]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,o){this._updatedImages[o]=this._updatedImages[o]||new Set,this._updatedImages[o].add(r.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Go(u){let{userImage:t}=u;return!!(t&&t.render&&t.render())&&(u.data.replace(new Uint8Array(t.data.buffer)),!0)}class zi extends r.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&r.t()&&(this.imageRasterizerDispatcher=new r.D(r.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new r.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);let o=this.atlasTexture.get(t);o&&(o.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,o){this.imageProviders.has(o)||this.imageProviders.set(o,new Map),this.imageProviders.get(o).set(t.id,t)}removeImageProvider(t,o){this.imageProviders.has(o)&&this.imageProviders.get(o).delete(t)}getPendingImageProviders(){let t=[];for(let o of this.imageProviders.values())for(let h of o.values())h.hasPendingRequests()&&t.push(h);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new r.y),this._imageRasterizer}isLoaded(){for(let t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,o){if(this.loaded.get(o)!==t&&(this.loaded.set(o,t),t)){for(let{ids:h,callback:g}of this.requestors)this._notify(h,o,g);this.requestors=[]}}hasImage(t,o){return!!this.getImage(t,o)}getImage(t,o){return this.images.get(o).get(t.toString())}addImage(t,o,h){this._validate(t,h)&&this.images.get(o).set(t.toString(),h)}_validate(t,o){let h=!0;return this._validateStretch(o.stretchX,o.data&&o.data.width)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),h=!1),this._validateStretch(o.stretchY,o.data&&o.data.height)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),h=!1),this._validateContent(o.content,o)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "content" value`))),h=!1),h}_validateStretch(t,o){if(!t)return!0;let h=0;for(let g of t){if(g[0]<h||g[1]<g[0]||o<g[1])return!1;h=g[1]}return!0}_validateContent(t,o){return t?t.length!==4||!o.usvg&&(t[0]<0||o.data.width<t[0]||t[1]<0||o.data.height<t[1]||t[2]<0||o.data.width<t[2]||t[3]<0||o.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,o,h){let g=this.images.get(o).get(t.toString());h.version=g.version+1,this.images.get(o).set(t.toString(),h),this.updatedImages.get(o).add(t),this.removeFromImageRasterizerCache(t,o)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,o){this.spriteFormat!=="raster"&&(r.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:o}):this.imageRasterizer.removeImagesFromCacheByIds([t],o))}removeImage(t,o){let h=this.images.get(o),g=h.get(t.toString());h.delete(t.toString()),this.patterns.get(o).delete(t.toString()),this.removeFromImageRasterizerCache(t,o),g.userImage&&g.userImage.onRemove&&g.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(o=>r.I.from(o))}getImages(t,o,h){let g=[],_=[],v=this.imageProviders.get(o);for(let A of t){if(!A.iconsetId){g.push(A);continue}let L=v.get(A.iconsetId);L&&(this.getImage(A,o)?_.push(A):L.addPendingRequest(A))}if(g.length===0)return void this._notify(_,o,h);let E=!0,T=!!this.loaded.get(o),C=this.images.get(o);if(!T)for(let A of g)C.has(A.toString())||(E=!1);T||E?this._notify(g,o,h):this.requestors.push({ids:g,scope:o,callback:h})}rasterizeImages(t,o){let h=new Map,{tasks:g,scope:_}=t;for(let[v,E]of g.entries()){let T=this.getImage(E.id,_);T&&h.set(v,{image:T,imageVariant:E})}this._rasterizeImages(_,h,o)}_rasterizeImages(t,o,h){if(r.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:o,scope:t},h);else{let g=new Map;for(let[_,{image:v,imageVariant:E}]of o.entries())g.set(_,this.imageRasterizer.rasterize(E,v,t,0));h(void 0,g)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,o,h){let g=this.images.get(o),_=new Map;for(let v of t){if(!g.get(v.toString())){if(v.iconsetId)continue;this.fire(new r.A("styleimagemissing",{id:v.name}))}let E=g.get(v.toString());if(!E){r.w(`Image "${v.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}let T={data:E.usvg?null:E.data.clone(),pixelRatio:E.pixelRatio,sdf:E.sdf,usvg:E.usvg,version:E.version,stretchX:E.stretchX,stretchY:E.stretchY,content:E.content,hasRenderCallback:!!(E.userImage&&E.userImage.render)};E.usvg&&Object.assign(T,{width:E.icon.usvg_tree.width,height:E.icon.usvg_tree.height}),_.set(r.I.toString(v),T)}h(null,_)}getPixelSize(t){let{width:o,height:h}=this.atlasImage.get(t);return{width:o,height:h}}getPattern(t,o,h){let g=t.toString(),_=this.patterns.get(o),v=_.get(g),E=this.getImage(t,o);if(!E)return null;if(v){if(v.position.version===E.version)return v.position;v.position.version=E.version}else{if(E.usvg&&!E.data){let T=this.getPatternInFlightId(g,o);if(this.patternsInFlight.has(T))return null;this.patternsInFlight.add(T);let C=new r.B(t).scaleSelf(r.q.devicePixelRatio),A=new Map([[C.toString(),{image:E,imageVariant:C}]]);return this._rasterizeImages(o,A,(L,R)=>this.storePatternImage(C,o,E,h,R)),null}this.storePattern(t,o,E)}return this._updatePatternAtlas(o,h),_.get(g).position}getPatternInFlightId(t,o){return r.C(t,o)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,o,h,g,_){let v=t.toString(),E=_?_.get(v):void 0;E&&(h.data=E,this.storePattern(t.id,o,h),this._updatePatternAtlas(o,g),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),o)))}storePattern(t,o,h){let g={w:h.data.width+2*r.F,h:h.data.height+2*r.F,x:0,y:0},_=new r.G(g,h,r.F);this.patterns.get(o).set(t.toString(),{bin:g,position:_})}destroyAtlasTextures(){for(let t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,o){let h=t.gl,g=this.atlasTexture.get(o);g?this.dirty&&(g.update(this.atlasImage.get(o)),this.dirty=!1):(g=new r.T(t,this.atlasImage.get(o),h.RGBA8),this.atlasTexture.set(o,g)),g.bind(h.LINEAR,h.CLAMP_TO_EDGE)}_updatePatternAtlas(t,o){let h=this.patterns.get(t),g=Array.from(h.values()).map(({bin:C})=>C),{w:_,h:v}=r.H(g),E=this.atlasImage.get(t);E.resize({width:_||1,height:v||1});let T=this.images.get(t);for(let[C,{bin:A,position:L}]of h.entries()){let R=L.padding,k=A.x+R,V=A.y+R,z=T.get(C).data,U=z.width,j=z.height;R=R>1?R-1:R,r.r.copy(z,E,{x:0,y:0},{x:k,y:V},{width:U,height:j},o),r.r.copy(z,E,{x:0,y:j-R},{x:k,y:V-R},{width:U,height:R},o),r.r.copy(z,E,{x:0,y:0},{x:k,y:V+j},{width:U,height:R},o),r.r.copy(z,E,{x:U-R,y:0},{x:k-R,y:V},{width:R,height:j},o),r.r.copy(z,E,{x:0,y:0},{x:k+U,y:V},{width:R,height:j},o),r.r.copy(z,E,{x:U-R,y:j-R},{x:k-R,y:V-R},{width:R,height:R},o),r.r.copy(z,E,{x:0,y:j-R},{x:k+U,y:V-R},{width:R,height:R},o),r.r.copy(z,E,{x:0,y:0},{x:k+U,y:V+j},{width:R,height:R},o),r.r.copy(z,E,{x:U-R,y:0},{x:k-R,y:V+j},{width:R,height:R},o)}this.dirty=!0}beginFrame(){for(let t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,o){let h=this.images.get(o);for(let g of t){if(this.callbackDispatchedThisFrame.get(o).has(g.toString()))continue;this.callbackDispatchedThisFrame.get(o).add(g.toString());let _=h.get(g.toString());Go(_)&&this.updateImage(g,o,_)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Kr(u){let t=u.key,o=u.value,h=u.valueSpec||{},g=u.objectElementValidators||{},_=u.style,v=u.styleSpec,E=[],T=r.J(o);if(T!=="object")return[new r.V(t,o,`object expected, ${T} found`)];for(let C in o){let A=C.split(".")[0],L;g[A]?L=g[A]:h[A]?L=ui:g["*"]?L=g["*"]:h["*"]&&(L=ui),L?E=E.concat(L({key:(t&&`${t}.`)+C,value:o[C],valueSpec:h[A]||h["*"],style:_,styleSpec:v,object:o,objectKey:C},o)):E.push(new r.K(t,o[C],`unknown property "${C}"`))}for(let C in h)g[C]||h[C].required&&h[C].default===void 0&&o[C]===void 0&&E.push(new r.V(t,o,`missing required property "${C}"`));return E}function ua(u){let t=u.value,o=u.valueSpec,h=u.style,g=u.styleSpec,_=u.key,v=u.arrayElementValidator||ui;if(r.J(t)!=="array")return[new r.V(_,t,`array expected, ${r.J(t)} found`)];if(o.length&&t.length!==o.length)return[new r.V(_,t,`array length ${o.length} expected, length ${t.length} found`)];if(o["min-length"]&&t.length<o["min-length"])return[new r.V(_,t,`array length at least ${o["min-length"]} expected, length ${t.length} found`)];let E={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};g.$version<7&&(E.function=o.function),r.J(o.value)==="object"&&(E=o.value);let T=[];for(let C=0;C<t.length;C++)T=T.concat(v({array:t,arrayIndex:C,value:t[C],valueSpec:E,style:h,styleSpec:g,key:`${_}[${C}]`},!0));return T}function su(u){let t=u.key,o=u.value,h=u.valueSpec,g=r.J(o);if(g==="number"&&o!=o&&(g="NaN"),g!=="number")return[new r.V(t,o,`number expected, ${g} found`)];if("minimum"in h){let _=h.minimum;if(r.J(h.minimum)==="array"&&(_=h.minimum[u.arrayIndex]),o<_)return[new r.V(t,o,`${o} is less than the minimum value ${_}`)]}if("maximum"in h){let _=h.maximum;if(r.J(h.maximum)==="array"&&(_=h.maximum[u.arrayIndex]),o>_)return[new r.V(t,o,`${o} is greater than the maximum value ${_}`)]}return[]}function Os(u){let t=u.valueSpec,o=r.M(u.value.type),h,g,_,v={},E=o!=="categorical"&&u.value.property===void 0,T=!E,C=r.J(u.value.stops)==="array"&&r.J(u.value.stops[0])==="array"&&r.J(u.value.stops[0][0])==="object",A=Kr({key:u.key,value:u.value,valueSpec:u.styleSpec.function,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{stops:function(k){if(o==="identity")return[new r.V(k.key,k.value,'identity function may not have a "stops" property')];let V=[],z=k.value;return V=V.concat(ua({key:k.key,value:z,valueSpec:k.valueSpec,style:k.style,styleSpec:k.styleSpec,arrayElementValidator:L})),r.J(z)==="array"&&z.length===0&&V.push(new r.V(k.key,z,"array must have at least one stop")),V},default:function(k){return ui({key:k.key,value:k.value,valueSpec:t,style:k.style,styleSpec:k.styleSpec})}}});return o==="identity"&&E&&A.push(new r.V(u.key,u.value,'missing required property "property"')),o==="identity"||u.value.stops||A.push(new r.V(u.key,u.value,'missing required property "stops"')),o==="exponential"&&u.valueSpec.expression&&!r.N(u.valueSpec)&&A.push(new r.V(u.key,u.value,"exponential functions not supported")),u.styleSpec.$version>=8&&(T&&!r.O(u.valueSpec)?A.push(new r.V(u.key,u.value,"property functions not supported")):E&&!r.Q(u.valueSpec)&&A.push(new r.V(u.key,u.value,"zoom functions not supported"))),o!=="categorical"&&!C||u.value.property!==void 0||A.push(new r.V(u.key,u.value,'"property" property is required')),A;function L(k){let V=[],z=k.value,U=k.key;if(r.J(z)!=="array")return[new r.V(U,z,`array expected, ${r.J(z)} found`)];if(z.length!==2)return[new r.V(U,z,`array length 2 expected, length ${z.length} found`)];if(C){if(r.J(z[0])!=="object")return[new r.V(U,z,`object expected, ${r.J(z[0])} found`)];if(z[0].zoom===void 0)return[new r.V(U,z,"object stop key must have zoom")];if(z[0].value===void 0)return[new r.V(U,z,"object stop key must have value")];let j=r.M(z[0].zoom);if(typeof j!="number")return[new r.V(U,z[0].zoom,"stop zoom values must be numbers")];if(_&&_>j)return[new r.V(U,z[0].zoom,"stop zoom values must appear in ascending order")];j!==_&&(_=j,g=void 0,v={}),V=V.concat(Kr({key:`${U}[0]`,value:z[0],valueSpec:{zoom:{}},style:k.style,styleSpec:k.styleSpec,objectElementValidators:{zoom:su,value:R}}))}else V=V.concat(R({key:`${U}[0]`,value:z[0],style:k.style,styleSpec:k.styleSpec},z));return r.S(r.U(z[1]))?V.concat([new r.V(`${U}[1]`,z[1],"expressions are not allowed in function stops.")]):V.concat(ui({key:`${U}[1]`,value:z[1],valueSpec:t,style:k.style,styleSpec:k.styleSpec}))}function R(k,V){let z=r.J(k.value),U=r.M(k.value),j=k.value!==null?k.value:V;if(h){if(z!==h)return[new r.V(k.key,j,`${z} stop domain type must match previous stop domain type ${h}`)]}else h=z;if(z!=="number"&&z!=="string"&&z!=="boolean"&&typeof U!="number"&&typeof U!="string"&&typeof U!="boolean")return[new r.V(k.key,j,"stop domain value must be a number, string, or boolean")];if(z!=="number"&&o!=="categorical"){let W=`number expected, ${z} found`;return r.O(t)&&o===void 0&&(W+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new r.V(k.key,j,W)]}return o!=="categorical"||z!=="number"||typeof U=="number"&&isFinite(U)&&Math.floor(U)===U?o!=="categorical"&&z==="number"&&typeof U=="number"&&typeof g=="number"&&g!==void 0&&U<g?[new r.V(k.key,j,"stop domain values must appear in ascending order")]:(g=U,o==="categorical"&&U in v?[new r.V(k.key,j,"stop domain values must be unique")]:(v[U]=!0,[])):[new r.V(k.key,j,`integer expected, found ${String(U)}`)]}}function bo(u){let t=(u.expressionContext==="property"?r.W:r.X)(r.U(u.value),u.valueSpec);if(t.result==="error")return t.value.map(h=>new r.V(`${u.key}${h.key}`,u.value,h.message));let o=t.value.expression||t.value._styleExpression.expression;if(u.expressionContext==="property"&&u.propertyKey==="text-font"&&!o.outputDefined())return[new r.V(u.key,u.value,`Invalid data expression for "${u.propertyKey}". Output values must be contained as literals within the expression.`)];if(u.expressionContext==="property"&&u.propertyType==="layout"&&!r.Y(o))return[new r.V(u.key,u.value,'"feature-state" data expressions are not supported with layout properties.')];if(u.expressionContext==="filter")return co(o,u);if(u.expressionContext&&u.expressionContext.indexOf("cluster")===0){if(!r.Z(o,["zoom","feature-state"]))return[new r.V(u.key,u.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(u.expressionContext==="cluster-initial"&&!r._(o))return[new r.V(u.key,u.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function co(u,t){let o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(let g of t.valueSpec.expression.parameters)o.delete(g);if(o.size===0)return[];let h=[];return u instanceof r.$&&o.has(u.name)?[new r.V(t.key,t.value,`["${u.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(u.eachChild(g=>{h.push(...co(g,t))}),h)}function Ls(u){let t=u.key,o=u.value,h=u.valueSpec,g=[];return Array.isArray(h.values)?h.values.indexOf(r.M(o))===-1&&g.push(new r.V(t,o,`expected one of [${h.values.join(", ")}], ${JSON.stringify(o)} found`)):Object.keys(h.values).indexOf(r.M(o))===-1&&g.push(new r.V(t,o,`expected one of [${Object.keys(h.values).join(", ")}], ${JSON.stringify(o)} found`)),g}function ks(u){return r.a1(r.U(u.value))?bo(r.L({},u,{expressionContext:"filter",valueSpec:u.styleSpec[`filter_${u.layerType||"fill"}`]})):Ka(u)}function Ka(u){let t=u.value,o=u.key;if(r.J(t)!=="array")return[new r.V(o,t,`array expected, ${r.J(t)} found`)];let h=u.styleSpec,g,_=[];if(t.length<1)return[new r.V(o,t,"filter array must have at least 1 element")];switch(_=_.concat(Ls({key:`${o}[0]`,value:t[0],valueSpec:h.filter_operator,style:u.style,styleSpec:u.styleSpec})),r.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&r.M(t[1])==="$type"&&_.push(new r.V(o,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&_.push(new r.V(o,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(g=r.J(t[1]),g!=="string"&&_.push(new r.V(`${o}[1]`,t[1],`string expected, ${g} found`)));for(let v=2;v<t.length;v++)g=r.J(t[v]),r.M(t[1])==="$type"?_=_.concat(Ls({key:`${o}[${v}]`,value:t[v],valueSpec:h.geometry_type,style:u.style,styleSpec:u.styleSpec})):g!=="string"&&g!=="number"&&g!=="boolean"&&_.push(new r.V(`${o}[${v}]`,t[v],`string, number, or boolean expected, ${g} found`));break;case"any":case"all":case"none":for(let v=1;v<t.length;v++)_=_.concat(Ka({key:`${o}[${v}]`,value:t[v],style:u.style,styleSpec:u.styleSpec}));break;case"has":case"!has":g=r.J(t[1]),t.length!==2?_.push(new r.V(o,t,`filter array for "${t[0]}" operator must have 2 elements`)):g!=="string"&&_.push(new r.V(`${o}[1]`,t[1],`string expected, ${g} found`))}return _}function Vl(u,t){let o=u.key,h=u.style,g=u.layer,_=u.styleSpec,v=u.value,E=u.objectKey,T=_[`${t}_${u.layerType}`];if(!T)return[];let C=E.match(/^(.*)-use-theme$/);if(t==="paint"&&C&&T[C[1]])return r.S(v)?[].concat(ui({key:u.key,value:v,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:h,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:E})):ui({key:o,value:v,valueSpec:{type:"string"},style:h,styleSpec:_});let A=E.match(/^(.*)-transition$/);if(t==="paint"&&A&&T[A[1]]&&T[A[1]].transition)return ui({key:o,value:v,valueSpec:_.transition,style:h,styleSpec:_});let L=u.valueSpec||T[E];if(!L)return[new r.K(o,v,`unknown property "${E}"`)];let R;if(r.J(v)==="string"&&r.O(L)&&!L.tokens&&(R=/^{([^}]+)}$/.exec(v))){let V=`\`{ "type": "identity", "property": ${R?JSON.stringify(R[1]):'"_"'} }\``;return[new r.V(o,v,`"${E}" does not support interpolation syntax
Use an identity property function instead: ${V}.`)]}let k=[];if(u.layerType==="symbol")E!=="text-field"||!h||h.glyphs||h.imports||k.push(new r.V(o,v,'use of "text-field" requires a style "glyphs" property')),E==="text-font"&&r.a2(r.U(v))&&r.M(v.type)==="identity"&&k.push(new r.V(o,v,'"text-font" does not support identity functions'));else if(u.layerType==="model"&&t==="paint"&&g&&g.layout&&g.layout.hasOwnProperty("model-id")&&r.O(L)&&(r.a3(L)||r.Q(L))){let V=r.W(r.U(v),L),z=V.value.expression||V.value._styleExpression.expression;z&&!r.Z(z,["measure-light"])&&(E==="model-emissive-strength"&&r._(z)&&r.Y(z)||k.push(new r.V(o,v,`${E} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return k.concat(ui({key:u.key,value:v,valueSpec:L,style:h,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:E}))}function Jr(u){return Vl(u,"paint")}function wo(u){return Vl(u,"layout")}function au(u){let t=[],o=u.value,h=u.key,g=u.style,_=u.styleSpec;o.type||o.ref||t.push(new r.V(h,o,'either "type" or "ref" is required'));let v=r.M(o.type),E=r.M(o.ref);if(o.id){let T=r.M(o.id);for(let C=0;C<u.arrayIndex;C++){let A=g.layers[C];r.M(A.id)===T&&t.push(new r.V(h,o.id,`duplicate layer id "${o.id}", previously used at line ${A.id.__line__}`))}}if("ref"in o){let T;["type","source","source-layer","filter","layout"].forEach(C=>{C in o&&t.push(new r.V(h,o[C],`"${C}" is prohibited for ref layers`))}),g.layers.forEach(C=>{r.M(C.id)===E&&(T=C)}),T?T.ref?t.push(new r.V(h,o.ref,"ref cannot reference another ref layer")):v=r.M(T.type):typeof E=="string"&&t.push(new r.V(h,o.ref,`ref layer "${E}" not found`))}else if(v!=="background"&&v!=="sky"&&v!=="slot")if(o.source){let T=g.sources&&g.sources[o.source],C=T&&r.M(T.type);T?C==="vector"&&v==="raster"?t.push(new r.V(h,o.source,`layer "${o.id}" requires a raster source`)):C==="raster"&&v!=="raster"?t.push(new r.V(h,o.source,`layer "${o.id}" requires a vector source`)):C!=="vector"||o["source-layer"]?C==="raster-dem"&&v!=="hillshade"?t.push(new r.V(h,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):C!=="raster-array"||["raster","raster-particle"].includes(v)?v==="line"&&o.paint&&(o.paint["line-gradient"]||o.paint["line-trim-offset"])&&C==="geojson"&&!T.lineMetrics?t.push(new r.V(h,o,`layer "${o.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):v==="raster-particle"&&C!=="raster-array"&&t.push(new r.V(h,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):t.push(new r.V(h,o.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new r.V(h,o,`layer "${o.id}" must specify a "source-layer"`)):t.push(new r.V(h,o.source,`source "${o.source}" not found`))}else t.push(new r.V(h,o,'missing required property "source"'));return t=t.concat(Kr({key:h,value:o,valueSpec:_.layer,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ui({key:`${h}.type`,value:o.type,valueSpec:_.layer.type,style:u.style,styleSpec:u.styleSpec,object:o,objectKey:"type"}),filter:T=>ks(r.L({layerType:v},T)),layout:T=>Kr({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":C=>wo(r.L({layerType:v},C))}}),paint:T=>Kr({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":C=>Jr(r.L({layerType:v,layer:o},C))}})}})),t}function Fs(u){let t=u.value,o=u.key,h=r.J(t);return h!=="string"?[new r.V(o,t,`string expected, ${h} found`)]:[]}let jl={promoteId:function u({key:t,value:o}){if(r.J(o)==="string")return Fs({key:t,value:o});if(Array.isArray(o)){let h=[],g=r.U(o),_=r.X(g);return _.result==="error"&&_.value.forEach(v=>{h.push(new r.V(`${t}${v.key}`,null,`${v.message}`))}),r.Z(_.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||h.push(new r.V(`${t}`,null,"promoteId expression should be only feature dependent")),h}{let h=[];for(let g in o)h.push(...u({key:`${t}.${g}`,value:o[g]}));return h}}};function Mr(u){let t=u.value,o=u.key,h=u.styleSpec,g=u.style;if(!t.type)return[new r.V(o,t,'"type" is required')];let _=r.M(t.type),v=[];switch(["vector","raster","raster-dem","raster-array"].includes(_)&&(t.url||t.tiles||v.push(new r.K(o,t,'Either "url" or "tiles" is required.'))),_){case"vector":case"raster":case"raster-dem":case"raster-array":return v=v.concat(Kr({key:o,value:t,valueSpec:h[`source_${_.replace("-","_")}`],style:u.style,styleSpec:h,objectElementValidators:jl})),v;case"geojson":if(v=Kr({key:o,value:t,valueSpec:h.source_geojson,style:g,styleSpec:h,objectElementValidators:jl}),t.cluster)for(let E in t.clusterProperties){let[T,C]=t.clusterProperties[E],A=typeof T=="string"?[T,["accumulated"],["get",E]]:T;v.push(...bo({key:`${o}.${E}.map`,value:C,expressionContext:"cluster-map"})),v.push(...bo({key:`${o}.${E}.reduce`,value:A,expressionContext:"cluster-reduce"}))}return v;case"video":return Kr({key:o,value:t,valueSpec:h.source_video,style:g,styleSpec:h});case"image":return Kr({key:o,value:t,valueSpec:h.source_image,style:g,styleSpec:h});case"canvas":return[new r.V(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Ls({key:`${o}.type`,value:t.type,valueSpec:{values:Eo(h)}})}}function Eo(u){return u.source.reduce((t,o)=>{let h=u[o];return h.type.type==="enum"&&(t=t.concat(Object.keys(h.type.values))),t},[])}function da(u){let t=u.value,o=u.styleSpec,h=o.light,g=u.style,_=[],v=r.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new r.V("light",t,`object expected, ${v} found`)]),_;for(let E in t){let T=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);_=_.concat(C&&h[C[1]]?ui({key:E,value:t[E],valueSpec:{type:"string"},style:g,styleSpec:o}):T&&h[T[1]]&&h[T[1]].transition?ui({key:E,value:t[E],valueSpec:o.transition,style:g,styleSpec:o}):h[E]?ui({key:E,value:t[E],valueSpec:h[E],style:g,styleSpec:o}):[new r.V(E,t[E],`unknown property "${E}"`)])}return _}function Ns(u){let t=u.value,o=[];if(!t)return o;let h=r.J(t);if(h!=="object")return o=o.concat([new r.V("light-3d",t,`object expected, ${h} found`)]),o;let g=u.styleSpec,_=g["light-3d"],v=u.key,E=u.style,T=u.style.lights;for(let L of["type","id"])if(!(L in t))return o=o.concat([new r.V("light-3d",t,`missing property ${L} on light`)]),o;if(t.type&&T)for(let L=0;L<u.arrayIndex;L++){let R=r.M(t.type),k=T[L];r.M(k.type)===R&&o.push(new r.V(v,t.id,`duplicate light type "${t.type}", previously defined at line ${k.id.__line__}`))}let C=`properties_light_${t.type}`;if(!(C in g))return o=o.concat([new r.V("light-3d",t,`Invalid light type ${t.type}`)]),o;let A=g[C];for(let L in t)if(L==="properties"){let R=t[L],k=r.J(R);if(k!=="object")return o=o.concat([new r.V("properties",R,`object expected, ${k} found`)]),o;for(let V in R){let z=V.match(/^(.*)-transition$/),U=V.match(/^(.*)-use-theme$/);o=o.concat(U&&A[U[1]]?ui({key:L,value:R[V],valueSpec:{type:"string"},style:E,styleSpec:g}):z&&A[z[1]]&&A[z[1]].transition?ui({key:L,value:t[L],valueSpec:g.transition,style:E,styleSpec:g}):A[V]?ui({key:V,value:R[V],valueSpec:A[V],style:E,styleSpec:g}):[new r.K(u.key,R[V],`unknown property "${V}"`)])}}else o=o.concat(_[L]?ui({key:L,value:t[L],valueSpec:_[L],style:E,styleSpec:g}):[new r.K(L,t[L],`unknown property "${L}"`)]);return o}function ha(u){let t=u.value,o=u.key,h=u.style,g=u.styleSpec,_=g.terrain,v=[],E=r.J(t);if(t===void 0||E==="null")return v;if(E!=="object")return v=v.concat([new r.V("terrain",t,`object expected, ${E} found`)]),v;for(let T in t){let C=T.match(/^(.*)-transition$/),A=T.match(/^(.*)-use-theme$/);v=v.concat(A&&_[A[1]]?ui({key:T,value:t[T],valueSpec:{type:"string"},style:h,styleSpec:g}):C&&_[C[1]]&&_[C[1]].transition?ui({key:T,value:t[T],valueSpec:g.transition,style:h,styleSpec:g}):_[T]?ui({key:T,value:t[T],valueSpec:_[T],style:h,styleSpec:g}):[new r.K(T,t[T],`unknown property "${T}"`)])}if(t.source){let T=h.sources&&h.sources[t.source],C=T&&r.M(T.type);T?C!=="raster-dem"&&v.push(new r.V(o,t.source,`terrain cannot be used with a source of type ${String(C)}, it only be used with a "raster-dem" source type`)):v.push(new r.V(o,t.source,`source "${t.source}" not found`))}else v.push(new r.V(o,t,'terrain is missing required property "source"'));return v}function fa(u){let t=u.value,o=u.style,h=u.styleSpec,g=h.fog,_=[],v=r.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new r.V("fog",t,`object expected, ${v} found`)]),_;for(let E in t){let T=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);_=_.concat(C&&g[C[1]]?ui({key:E,value:t[E],valueSpec:{type:"string"},style:o,styleSpec:h}):T&&g[T[1]]&&g[T[1]].transition?ui({key:E,value:t[E],valueSpec:h.transition,style:o,styleSpec:h}):g[E]?ui({key:E,value:t[E],valueSpec:g[E],style:o,styleSpec:h}):[new r.K(E,t[E],`unknown property "${E}"`)])}return _}let Ul={"*":()=>[],array:ua,boolean:function(u){let t=u.value,o=u.key,h=r.J(t);return h!=="boolean"?[new r.V(o,t,`boolean expected, ${h} found`)]:[]},number:su,color:function(u){let t=u.key,o=u.value,h=r.J(o);return h!=="string"?[new r.V(t,o,`color expected, ${h} found`)]:r.a0.parseCSSColor(o)===null?[new r.V(t,o,`color expected, "${o}" found`)]:[]},enum:Ls,filter:ks,function:Os,layer:au,object:Kr,source:Mr,model:r.a4,light:da,"light-3d":Ns,terrain:ha,fog:fa,string:Fs,formatted:function(u){return Fs(u).length===0?[]:bo(u)},resolvedImage:function(u){return Fs(u).length===0?[]:bo(u)},projection:function(u){let t=u.value,o=u.styleSpec,h=o.projection,g=u.style,_=[],v=r.J(t);if(v==="object")for(let E in t)_=_.concat(ui({key:E,value:t[E],valueSpec:h[E],style:g,styleSpec:o}));else v!=="string"&&(_=_.concat([new r.V("projection",t,`object or string expected, ${v} found`)]));return _},import:function(u){let{value:t,styleSpec:o}=u,v=t,{data:h}=v,g=Nv(v,["data"]);Object.defineProperty(g,"__line__",{value:t.__line__,enumerable:!1});let _=Kr(r.L({},u,{value:g,valueSpec:o.import}));return r.M(g.id)===""&&_.push(new r.V(`${u.key}.id`,g,"import id can't be an empty string")),h&&(_=_.concat(cu(h,o,{key:`${u.key}.data`}))),_},iconset:function(u){let t=u.value,o=u.key,h=u.styleSpec,g=u.style;if(!t.type)return[new r.V(o,t,'"type" is required')];let _=r.M(t.type),v=[];if(v=v.concat(Kr({key:o,value:t,valueSpec:h[`iconset_${_}`],style:g,styleSpec:h})),_==="source"&&t.source){let E=g.sources&&g.sources[t.source],T=E&&r.M(E.type);E?T!=="raster-array"&&v.push(new r.V(o,t.source,`iconset cannot be used with a source of type ${String(T)}, it only be used with a "raster-array" source type`)):v.push(new r.V(o,t.source,`source "${t.source}" not found`))}return v}};function ui(u,t=!1){let o=u.value,h=u.valueSpec,g=u.styleSpec;if(h.expression&&r.a2(r.M(o)))return Os(u);if(h.expression&&r.S(r.U(o)))return bo(u);if(h.type&&Ul[h.type]){let _=Ul[h.type](u);return t===!0&&_.length>0&&r.J(u.value)==="array"?bo(u):_}return Kr(r.L({},u,{valueSpec:h.type?g[h.type]:h}))}function lu(u){let t=u.value,o=u.key,h=Fs(u);return h.length||(t.indexOf("{fontstack}")===-1&&h.push(new r.V(o,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&h.push(new r.V(o,t,'"glyphs" url must include a "{range}" token'))),h}function cu(u,t=r.a5,o={}){return ui({key:o.key||"",value:u,valueSpec:t.$root,styleSpec:t,style:u,objectElementValidators:{glyphs:lu,"*":()=>[]}})}function To(u,t=r.a5){return he(cu(u,t))}let uu=u=>he(Mr(u)),fp=u=>he(da(u)),Hl=u=>he(Ns(u)),Xe=u=>he(ha(u)),zs=u=>he(fa(u)),pp=u=>he(function(t){let o=t.value,h=t.style,g=t.styleSpec,_=g.snow,v=[],E=r.J(o);if(o===void 0)return v;if(E!=="object")return v=v.concat([new r.V("snow",o,`object expected, ${E} found`)]),v;for(let T in o){let C=T.match(/^(.*)-transition$/);v=v.concat(C&&_[C[1]]&&_[C[1]].transition?ui({key:T,value:o[T],valueSpec:g.transition,style:h,styleSpec:g}):_[T]?ui({key:T,value:o[T],valueSpec:_[T],style:h,styleSpec:g}):[new r.K(T,o[T],`unknown property "${T}"`)])}return v}(u)),du=u=>he(function(t){let o=t.value,h=t.style,g=t.styleSpec,_=g.rain,v=[],E=r.J(o);if(o===void 0)return v;if(E!=="object")return v=v.concat([new r.V("rain",o,`object expected, ${E} found`)]),v;for(let T in o){let C=T.match(/^(.*)-transition$/);v=v.concat(C&&_[C[1]]&&_[C[1]].transition?ui({key:T,value:o[T],valueSpec:g.transition,style:h,styleSpec:g}):_[T]?ui({key:T,value:o[T],valueSpec:_[T],style:h,styleSpec:g}):[new r.K(T,o[T],`unknown property "${T}"`)])}return v}(u)),Sn=u=>he(au(u)),Se=u=>he(ks(u)),$=u=>he(Jr(u)),q=u=>he(wo(u)),te=u=>he(r.a4(u));function he(u){return u.slice().sort((t,o)=>t.line&&o.line?t.line-o.line:0)}function ne(u,t){let o=!1;if(t&&t.length)for(let h of t)h instanceof r.K?r.w(h.message):(u.fire(new r.z(new Error(h.message))),o=!0);return o}let _e;class Ae extends r.E{constructor(t,o="flat"){super(),this._transitionable=new r.a6(_e||(_e=new r.a7({anchor:new r.a8(r.a5.light.anchor),position:new r.a9(r.a5.light.position),color:new r.a8(r.a5.light.color),intensity:new r.a8(r.a5.light.intensity)}))),this.setLight(t,o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,o,h={}){this._validate(fp,t,h)||(this._transitionable.setTransitionOrValue(t),this.id=o)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&ne(this,t.call(To,r.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}}let ve=class extends r.E{constructor(u,t,o,h,g){super(),this.scope=o,this._transitionable=new r.a6(new r.a7({source:new r.a8(r.a5.terrain.source),exaggeration:new r.a8(r.a5.terrain.exaggeration)}),o,h),this._transitionable.setTransitionOrValue(u,h),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=g}get(){return this._transitionable.serialize()}set(u,t){this._transitionable.setTransitionOrValue(u,t)}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}getExaggeration(u){return this._transitioning.possiblyEvaluate(new r.aa(u,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let u=this._transitionable._values.exaggeration;if(!u)return null;let t=u.value.expression;if(!t)return null;let o=-1,h=-1,g=1;for(let _ of t.zoomStops)g=t.evaluate(new r.aa(_,{worldview:this.worldview})),g>.01?(o=_,h=-1):h=_;return g<.01&&o>0&&h>o?[o,h]:null}isZoomDependent(){let u=this._transitionable._values.exaggeration;return u!=null&&u.value!=null&&u.value.expression!=null&&u.value.expression instanceof r.ab}},De=45,nt=65,je=.05;function Dt(u,t,o,h){let g=r.af(De,nt,o),[_,v]=Ft(u,h),E=1-Math.min(1,Math.exp((t-_)/(v-_)*-6));return E*=E*E,E=Math.min(1,1.00747*E),E*g*u.alpha}function Ft(u,t){let o=.5/Math.tan(.5*t);return[u.range[0]+o,u.range[1]+o]}function Ut(u,t,o,h,g){let _=r.ad([],[t,o,h],g.mercatorFogMatrix);return Dt(u,r.ae(_),g.pitch,g._fov)}function dn(u,t,o,h,g,_,v){let E=[[o,h,0],[g,h,0],[g,_,0],[o,_,0]],T=Number.MAX_VALUE,C=-Number.MAX_VALUE;for(let A of E){let L=r.ad([],A,t),R=r.ae(L);T=Math.min(T,R),C=Math.max(C,R)}return[Dt(u,T,v.pitch,v._fov),Dt(u,C,v.pitch,v._fov)]}class rn extends r.E{constructor(t,o,h,g){super();let _=new r.a7({range:new r.a8(r.a5.fog.range),color:new r.a8(r.a5.fog.color),"color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new r.a8(r.a5.fog["high-color"]),"high-color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new r.a8(r.a5.fog["space-color"]),"space-color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new r.a8(r.a5.fog["horizon-blend"]),"star-intensity":new r.a8(r.a5.fog["star-intensity"]),"vertical-range":new r.a8(r.a5.fog["vertical-range"])});this._transitionable=new r.a6(_,h,new Map(g)),this.set(t,g),this._transitioning=this._transitionable.untransitioned(),this._transform=o,this.properties=new r.ag(_),this.scope=h}get state(){let t=this._transform,o=t.projection.name==="globe",h=r.ah(t.zoom),g=this.properties.get("range"),_=[.5,3];return{range:o?[r.ai(_[0],g[0],h),r.ai(_[1],g[1],h)]:g,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,o,h={}){if(this._validate(zs,t,h))return;let g=r.h({},t);for(let _ of Object.keys(r.a5.fog))g[_]===void 0&&(g[_]=r.a5.fog[_].default);this._options=g,this._transitionable.setTransitionOrValue(this._options,o)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;let o=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:r.af(De,nt,t))*o.a}getOpacityAtLatLng(t,o){return this._transform.projection.supportsFog?function(h,g,_){let v=r.ac.fromLngLat(g),E=_.elevation?_.elevation.getAtPointOrZero(v):0;return Ut(h,v.x,v.y,E,_)}(this.state,t,o):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];let o=this._transform.calculateFogTileMatrix(t.toUnwrapped());return dn(this.state,o,0,0,r.aj,r.aj,this._transform)}getOpacityForBounds(t,o,h,g,_){return this._transform.projection.supportsFog?dn(this.state,t,o,h,g,_,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?Ft(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;let o=[4,5,6,7];for(let h of o){let g=t.points[h],_;if(g[2]>=0)_=g;else{let v=t.points[h-4];_=r.ak(v,g,v[2]/(v[2]-g[2]))}if(Ut(this.state,_[0],_[1],0,this._transform)>=je)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&ne(this,t.call(To,r.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}}let hn,Kn,fn,Pi,ir=class extends r.E{constructor(u,t,o,h){super();let g=hn||(hn=new r.a7({density:new r.a8(r.a5.snow.density),intensity:new r.a8(r.a5.snow.intensity),color:new r.a8(r.a5.snow.color),opacity:new r.a8(r.a5.snow.opacity),vignette:new r.a8(r.a5.snow.vignette),"vignette-color":new r.a8(r.a5.snow["vignette-color"]),"center-thinning":new r.a8(r.a5.snow["center-thinning"]),direction:new r.a8(r.a5.snow.direction),"flake-size":new r.a8(r.a5.snow["flake-size"])}));this._transitionable=new r.a6(g,o,new Map(h)),this.set(u,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new r.ag(g),this.scope=o}get state(){let u=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=r.al(o[0]),g=-Math.max(r.al(o[1]),.01),_=[Math.cos(h)*Math.cos(g),Math.sin(h)*Math.cos(g),Math.sin(g)],v=this.properties.get("vignette"),E=this.properties.get("vignette-color");return E.a=v,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new r.am(t.r,t.g,t.b,t.a*u),direction:_,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:E}}get(){return this._transitionable.serialize()}set(u,t,o={}){if(this._validate(pp,u,o))return;let h=r.h({},u);for(let g of Object.keys(r.a5.snow))h[g]===void 0&&(h[g]=r.a5.snow[g].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,o){return(!o||o.validate!==!1)&&ne(this,u.call(To,r.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}},Ki=class extends r.E{constructor(u,t,o,h){super();let g=Kn||(Kn=new r.a7({density:new r.a8(r.a5.rain.density),intensity:new r.a8(r.a5.rain.intensity),color:new r.a8(r.a5.rain.color),opacity:new r.a8(r.a5.rain.opacity),vignette:new r.a8(r.a5.rain.vignette),"vignette-color":new r.a8(r.a5.rain["vignette-color"]),"center-thinning":new r.a8(r.a5.rain["center-thinning"]),direction:new r.a8(r.a5.rain.direction),"droplet-size":new r.a8(r.a5.rain["droplet-size"]),"distortion-strength":new r.a8(r.a5.rain["distortion-strength"])}));this._transitionable=new r.a6(g,o,new Map(h)),this.set(u,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new r.ag(g),this.scope=o}get state(){let u=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=r.al(o[0]),g=-Math.max(r.al(o[1]),.01),_=[Math.cos(h)*Math.cos(g),Math.sin(h)*Math.cos(g),Math.sin(g)],v=this.properties.get("vignette-color");return v.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new r.am(t.r,t.g,t.b,t.a*u),direction:_,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:v}}get(){return this._transitionable.serialize()}set(u,t,o={}){if(this._validate(du,u,o))return;let h=r.h({},u);for(let g of Object.keys(r.a5.rain))h[g]===void 0&&(h[g]=r.a5.rain[g].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,o){return(!o||o.validate!==!1)&&ne(this,u.call(To,r.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}};class Gn extends r.E{constructor(t,o,h,g){super(),this.scope=h,this._options=t,this.properties=new r.ag(o),this._transitionable=new r.a6(o,h,new Map(g)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,o){this._options=t,this._transitionable.setTransitionOrValue(t.properties,o)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class An{constructor(t,o,h){this.screenBounds=t,this.cameraPoint=h.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=o,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,h)}static createFromScreenPoints(t,o){let h,g;if(t instanceof r.P||typeof t[0]=="number"){let _=r.P.convert(t);h=[_],g=o.isPointAboveHorizon(_)}else{let _=r.P.convert(t[0]),v=r.P.convert(t[1]),E=_.add(v)._div(2);h=[_,v],g=r.ao(_,v).every(T=>o.isPointAboveHorizon(T))&&o.isPointAboveHorizon(E)}return new An(h,g,o)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return r.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],g=r.ao(o,h,0,!1);return this.cameraPoint.y>h.y&&(this.cameraPoint.x>o.x&&this.cameraPoint.x<h.x?g.splice(3,0,this.cameraPoint):this.cameraPoint.x>=h.x?g[2]=this.cameraPoint:this.cameraPoint.x<=o.x&&(g[3]=this.cameraPoint)),r.ap(g,t)}bufferedCameraGeometryGlobe(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],g=r.ao(o,h,t),_=this.cameraPoint.clone();switch(3*((_.y>o.y)+(_.y>h.y))+((_.x>o.x)+(_.x>h.x))){case 0:g[0]=_,g[4]=_.clone();break;case 1:g.splice(1,0,_);break;case 2:g[1]=_;break;case 3:g.splice(4,0,_);break;case 5:g.splice(2,0,_);break;case 6:g[3]=_;break;case 7:g.splice(3,0,_);break;case 8:g[2]=_}return g}containsTile(t,o,h,g=0){let _=t.queryPadding/o._pixelsPerMercatorPixel+1,v=h?this._bufferedCameraMercator(_,o):this._bufferedScreenMercator(_,o),E=t.tileID.wrap+(v.unwrapped?g:0),T=v.polygon.map(U=>r.aq(t.tileTransform,U,E));if(!r.ar(T,0,0,r.aj,r.aj))return;E=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?g:0);let C=this.screenGeometryMercator.polygon.map(U=>r.as(t.tileTransform,U,E)),A=C.map(U=>new r.P(U[0],U[1])),L=o.getFreeCameraOptions().position||new r.ac(0,0,0),R=r.as(t.tileTransform,L,E),k=C.map(U=>{let j=r.at(U,U,R);return r.au(j,j),new r.av(R,j)}),V=r.aw(t,1,o.zoom)*o._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:A,tilespaceRays:k,bufferedTilespaceGeometry:T,bufferedTilespaceBounds:(z=r.ax(T),z.min.x=r.ay(z.min.x,0,r.aj),z.min.y=r.ay(z.min.y,0,r.aj),z.max.x=r.ay(z.max.x,0,r.aj),z.max.y=r.ay(z.max.y,0,r.aj),z),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:V};var z}_bufferedScreenMercator(t,o){let h=mi(t);if(this._screenRaycastCache[h])return this._screenRaycastCache[h];{let g;return g=o.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),o):{polygon:this.bufferedScreenGeometry(t).map(_=>o.pointCoordinate3D(_)),unwrapped:!0},this._screenRaycastCache[h]=g,g}}_bufferedCameraMercator(t,o){let h=mi(t);if(this._cameraRaycastCache[h])return this._cameraRaycastCache[h];{let g;return g=o.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),o):{polygon:this.bufferedCameraGeometry(t).map(_=>o.pointCoordinate3D(_)),unwrapped:!0},this._cameraRaycastCache[h]=g,g}}_projectAndResample(t,o){let h=function(_,v){let E=r.az([],v.pixelMatrix,v.globeMatrix),T=[0,-r.aB,0,1],C=[0,r.aB,0,1],A=[0,0,0,1];r.aA(T,T,E),r.aA(C,C,E),r.aA(A,A,E);let L=new r.P(T[0]/T[3],T[1]/T[3]),R=new r.P(C[0]/C[3],C[1]/C[3]),k=r.aC(_,L)&&T[3]<A[3],V=r.aC(_,R)&&C[3]<A[3];if(!k&&!V)return null;let z=function(ue,re,oe){for(let se=1;se<ue.length;se++){let Ee=bi(re.pointCoordinate3D(ue[se-1]).x),me=bi(re.pointCoordinate3D(ue[se]).x);if(oe<0){if(Ee<me)return{idx:se,t:-Ee/(me-1-Ee)}}else if(me<Ee)return{idx:se,t:(1-Ee)/(me+1-Ee)}}return null}(_,v,k?-1:1);if(!z)return null;let{idx:U,t:j}=z,W=U>1?Ai(_.slice(0,U),v):[],Y=U<_.length?Ai(_.slice(U),v):[];W=W.map(ue=>new r.P(bi(ue.x),ue.y)),Y=Y.map(ue=>new r.P(bi(ue.x),ue.y));let J=[...W];J.length===0&&J.push(Y[Y.length-1]);let ie=r.ai(J[J.length-1].y,(Y.length===0?W[0]:Y[0]).y,j),le;return le=k?[new r.P(0,ie),new r.P(0,0),new r.P(1,0),new r.P(1,ie)]:[new r.P(1,ie),new r.P(1,1),new r.P(0,1),new r.P(0,ie)],J.push(...le),Y.length===0?J.push(W[0]):J.push(...Y),{polygon:J.map(ue=>new r.ac(ue.x,ue.y)),unwrapped:!1}}(t,o);if(h)return h;let g=function(_,v){let E=!1,T=-1/0,C=0;for(let L=0;L<_.length-1;L++)_[L].x>T&&(T=_[L].x,C=L);for(let L=0;L<_.length-1;L++){let R=(C+L)%(_.length-1),k=_[R],V=_[R+1];Math.abs(k.x-V.x)>.5&&(k.x<V.x?(k.x+=1,R===0&&(_[_.length-1].x+=1)):(V.x+=1,R+1===_.length-1&&(_[0].x+=1)),E=!0)}let A=r.aD(v.center.lng);return E&&A<Math.abs(A-1)&&_.forEach(L=>{L.x-=1}),{polygon:_,unwrapped:E}}(Ai(t,o).map(_=>new r.P(bi(_.x),_.y)),o);return{polygon:g.polygon.map(_=>new r.ac(_.x,_.y)),unwrapped:g.unwrapped}}}function Ai(u,t){return r.aE(u,o=>{let h=t.pointCoordinate3D(o);o.x=h.x,o.y=h.y},1/256)}function bi(u){return u<0?1+u%1:u%1}function mi(u){return 100*u|0}function hr(u,t,o,h,g){let _=function(E,T){if(E)return g(E);if(T){if(u.url&&T.tiles&&u.tiles&&delete u.tiles,T.variants){if(!Array.isArray(T.variants))return g(new Error("variants must be an array"));for(let A of T.variants){if(A==null||typeof A!="object"||A.constructor!==Object)return g(new Error("variant must be an object"));if(!Array.isArray(A.capabilities))return g(new Error("capabilities must be an array"));if(A.capabilities.length===1&&A.capabilities[0]==="meshopt"){T=r.h(T,A);break}}}let C=r.aF(r.h({},T,u),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);C.tiles=t.canonicalizeTileset(C,u.url),g(null,C)}},v=function(E,T,C){if(!E)return null;if(!T&&!C)return E;C=C||E.worldview_default;let A=Object.values(E.language||{});if(A.length===0)return null;let L=Object.values(E.worldview||{});if(L.length===0)return null;let R=A.every(V=>V===T),k=L.every(V=>V===C);return R&&k?E:T in(E.language_options||{})||C in(E.worldview_options||{})?null:E.language_options&&E.worldview_options?E:null}(u.data,o,h);return v?r.q.frame(()=>_(null,v)):u.url?r.n(t.transformRequest(t.normalizeSourceURL(u.url,null,o,h),r.R.Source),_):r.q.frame(()=>{let C=u,{data:E}=C,T=Nv(C,["data"]);_(null,T)})}function Qr(u,t){let o=Math.pow(2,t.z),h=Math.floor(r.aD(u.getWest())*o),g=Math.floor(r.aH(u.getNorth())*o),_=Math.ceil(r.aD(u.getEast())*o),v=Math.ceil(r.aH(u.getSouth())*o);return t.x>=h&&t.x<_&&t.y>=g&&t.y<v}class Rr{constructor(t,o,h){this.bounds=t?r.aG.convert(this.validateBounds(t)):null,this.minzoom=o||0,this.maxzoom=h||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(let o of t)this.extraBounds.push(r.aG.convert(this.validateBounds(o)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!Qr(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(let o of this.extraBounds)if(Qr(o,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;let o=new Rr(t.bounds,t.minzoom,t.maxzoom);return o.addExtraBounds(t.extra_bounds),o}}class hu extends r.E{constructor(t,o,h,g){if(super(),this.id=t,this.dispatcher=h,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,r.h(this,r.aF(o,["url","scheme","tileSize","promoteId"])),this._options=r.h({type:"vector"},o),this._collectResourceTiming=!!o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g),this._tileWorkers={},this._deduped=new r.aI}load(t){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));let o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,h=this.map.getWorldview();this._tileJSONRequest=hr(this._options,this.map._requestManager,o,h,(g,_)=>{if(this._tileJSONRequest=null,this._loaded=!0,g)o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),h&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${h}`),this.fire(new r.z(g));else if(_){if(r.h(this,_),this.hasWorldviews=!!_.worldview_options,_.worldview_default&&(this.worldviewDefault=_.worldview_default),_.vector_layers){this.vectorLayers=_.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(let v of _.vector_layers)this.vectorLayerIds.push(v.id),_.worldview&&_.worldview[v.source]&&this.localizableLayerIds.add(v.id)}this.tileBounds=Rr.fromTileJSON(_),zr(_.tiles,this.map._requestManager._customAccessToken),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(g)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return r.h({},this._options)}loadTile(t,o){let h=t.tileID.canonical.url(this.tiles,this.scheme),g=this.map._requestManager.normalizeTileURL(h),_=this.map._requestManager.transformRequest(g,r.R.Tile),v=this.map.style?this.map.style.getLut(this.scope):null,E=v?{image:v.image.clone()}:null,T={request:_,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:E,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:r.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&r.j(h)&&(T.localizableLayerIds=this.localizableLayerIds),T.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=o:t.request=t.actor.send("reloadTile",T,C.bind(this));else if(t.actor=this._tileWorkers[g]=this._tileWorkers[g]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",T,C.bind(this),void 0,!0);else{let A=r.aJ.call({deduped:this._deduped},T,(L,R)=>{L||!R?C.call(this,L):(T.data={cacheControl:R.cacheControl,expires:R.expires,rawData:R.rawData.slice(0)},t.actor&&t.actor.send("loadTile",T,C.bind(this),void 0,!0))},!0);t.request={cancel:A}}function C(A,L){return delete t.request,t.aborted?o(null):A&&A.status!==404?o(A):(L&&L.resourceTiming&&(t.resourceTiming=L.resourceTiming),this.map._refreshExpiredTiles&&L&&t.setExpiryData(L),t.loadVectorData(L,this.map.painter),r.aK(this.dispatcher),o(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class vr extends r.E{constructor(t,o,h,g){super(),this.id=t,this.dispatcher=h,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=r.h({type:"raster"},o),r.h(this,r.aF(o,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));let o=this.map.getWorldview();this._tileJSONRequest=hr(this._options,this.map._requestManager,null,o,(h,g)=>{this._tileJSONRequest=null,this._loaded=!0,h?this.fire(new r.z(h)):g&&(r.h(this,g),g.raster_layers&&(this.rasterLayers=g.raster_layers,this.rasterLayerIds=this.rasterLayers.map(_=>_.id)),this.tileBounds=Rr.fromTileJSON(g),zr(g.tiles),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(h)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return r.h({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,o){let h=r.q.devicePixelRatio>=2,g=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),h,this.tileSize);t.request=r.o(this.map._requestManager.transformRequest(g,r.R.Tile),(_,v,E,T)=>(delete t.request,t.aborted?(t.state="unloaded",o(null)):_?(t.state="errored",o(_)):v?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:E,expires:T}),t.setTexture(v,this.map.painter),t.state="loaded",r.aK(this.dispatcher),void o(null)):o(null)))}abortTile(t,o){t.request&&(t.request.cancel(),delete t.request),o&&o()}unloadTile(t,o){t.texture&&t.texture instanceof r.T?(t.destroy(!0),t.texture&&t.texture instanceof r.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),o&&o()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class pa extends vr{constructor(t,o,h,g){super(t,o,h,g),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=r.h({type:"raster-array"},o)}triggerRepaint(t){let o=this.map.painter._terrain,h=this.map.style.getSourceCache(this.id);o&&o.enabled&&h&&o._clearRenderCacheForTile(h.id,t.tileID),this.map.triggerRepaint()}loadTile(t,o){let h=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),g=this.map._requestManager.transformRequest(h,r.R.Tile),_={request:g,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=g,t.actor||(t.actor=this.dispatcher.getActor());let v=(E,T,C,A)=>{if(delete t.request,t.aborted)return t.state="unloaded",o(null);if(E)return E.name==="AbortError"?void 0:(t.state="errored",o(E));if(this.map._refreshExpiredTiles&&T&&t.setExpiryData({cacheControl:C,expires:A}),this.partial)t.state="empty";else{if(!T)return o(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=T}o(null)};t.request=this.partial?t.fetchHeader(void 0,v.bind(this)):t.actor.send("loadTile",_,v.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){let h=t.texturePerLayer;if(t.flushAllQueues(),h.size){t.destroy(!0);for(let g of h.values())this.map.painter.saveTileTexture(g)}else t.destroy()}prepareTile(t,o,h,g){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(o,h,g,(_,v)=>{if(_)return t.state="errored",this.fire(new r.z(_)),void this.triggerRepaint(t);v&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(h,v,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;let o=this.rasterLayers.find(({id:_})=>_===t),h=o&&o.fields,g=h&&h.bands&&h.bands;return g?g[0]:0}getTextureDescriptor(t,o,h){if(!t)return;let g=o.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!g)return;let _=null;o instanceof r.aN?_=o.paint.get("raster-array-band"):o instanceof r.aO&&(_=o.paint.get("raster-particle-array-band"));let v=_||this.getInitialBand(g);if(v==null)return;if(!t.textureDescriptorPerLayer.get(o.id))return void this.prepareTile(t,g,o.id,v);if(t.updateNeeded(o.id,v)&&!h)return;let E=t.textureDescriptorPerLayer.get(o.id);return Object.assign({},E,{texture:t.texturePerLayer.get(o.id)})}getImages(t,o){let h=new Map;for(let g of t)for(let _ of o){let[v,E]=_.split("/"),T=g.getLayer(v);if(!T||!T.hasBand(E)||!T.hasDataForBand(E))continue;let{bytes:C,tileSize:A,buffer:L}=T.getBandView(E),R=A+2*L,k={data:new r.r({width:R,height:R},C),pixelRatio:2,sdf:!1,usvg:!1,version:0};h.set(_,k)}return h}}let Zd={vector:hu,raster:vr,"raster-dem":class extends vr{constructor(u,t,o,h){super(u,t,o,h),this.type="raster-dem",this.maxzoom=22,this._options=r.h({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(u,t){let o=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function h(g,_){g&&(u.state="errored",t(g)),_&&(u.dem=_,u.dem.onDeserialize(),u.needsHillshadePrepare=!0,u.needsDEMTextureUpload=!0,u.state="loaded",t(null))}u.request=r.o(this.map._requestManager.transformRequest(o,r.R.Tile),(function(g,_,v,E){if(delete u.request,u.aborted)u.state="unloaded",t(null);else if(g)u.state="errored",t(g);else if(_){this.map._refreshExpiredTiles&&u.setExpiryData({cacheControl:v,expires:E});let T=ImageBitmap&&_ instanceof ImageBitmap&&r.t(),C=1-(_.width-r.aL(_.width))/2;C<1||u.neighboringTiles||(u.neighboringTiles=this._getNeighboringTiles(u.tileID));let A=T?_:r.q.getImageData(_,C),L={uid:u.uid,tileID:u.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:A,encoding:this.encoding,padding:C};u.actor&&u.state!=="expired"||(u.actor=this.dispatcher.getActor(),u.actor.send("loadTile",L,h.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(u){let t=u.canonical,o=Math.pow(2,t.z),h=(t.x-1+o)%o,g=t.x===0?u.wrap-1:u.wrap,_=(t.x+1+o)%o,v=t.x+1===o?u.wrap+1:u.wrap,E={};return E[new r.aM(u.overscaledZ,g,t.z,h,t.y).key]={backfilled:!1},E[new r.aM(u.overscaledZ,v,t.z,_,t.y).key]={backfilled:!1},t.y>0&&(E[new r.aM(u.overscaledZ,g,t.z,h,t.y-1).key]={backfilled:!1},E[new r.aM(u.overscaledZ,u.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},E[new r.aM(u.overscaledZ,v,t.z,_,t.y-1).key]={backfilled:!1}),t.y+1<o&&(E[new r.aM(u.overscaledZ,g,t.z,h,t.y+1).key]={backfilled:!1},E[new r.aM(u.overscaledZ,u.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},E[new r.aM(u.overscaledZ,v,t.z,_,t.y+1).key]={backfilled:!1}),E}},"raster-array":pa,geojson:class extends r.E{constructor(u,t,o,h){super(),this.id=u,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(h),this._data=t.data,this._options=r.h({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;let g=r.aj/this.tileSize;this.workerOptions=r.h({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*g,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*g,extent:r.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:r.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*g,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(u){this.map=u,this.setData(this._data)}setData(u){return this._data=u,this._updateWorkerData(),this}updateData(u){if(!this._options.dynamic)return this.fire(new r.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof u!="string"&&(u.type==="Feature"&&(u={type:"FeatureCollection",features:[u]}),u.type!=="FeatureCollection"))return this.fire(new r.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof u!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let t=new Map;for(let o of this._data.features)t.set(o.id,o);for(let o of u.features)t.set(o.id,o);this._data.features=[...t.values()]}else this._data=u;return this._updateWorkerData(!0),this}getClusterExpansionZoom(u,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterChildren(u,t){return this.actor.send("geojson.getClusterChildren",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterLeaves(u,t,o,h){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:u,limit:t,offset:o},h),this}_updateWorkerData(u=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new r.A("dataloading",{dataType:"source"})),this._loaded=!1;let t=r.h({append:u},this.workerOptions);t.scope=this.scope;let o=this._data;typeof o=="string"?(t.request=this.map._requestManager.transformRequest(r.q.resolveURL(o),r.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(h,g)=>{if(this._loaded=!0,this._pendingLoad=null,h)this.fire(new r.z(h));else{let _={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&g&&g.resourceTiming&&g.resourceTiming[this.id]&&(_.resourceTiming=g.resourceTiming[this.id]),u&&(this._partialReload=!0),this.fire(new r.A("data",_)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(u),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let u=r.C(this.id,this.scope);this.map.style.clearSource(u),this._updateWorkerData()}loadTile(u,t){let o=u.actor?"reloadTile":"loadTile";u.actor=this.actor;let h=this.map.style?this.map.style.getLut(this.scope):null,g=h?{image:h.image.clone()}:null,_=this._partialReload,v={type:this.type,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:g,scope:this.scope,pixelRatio:r.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:u.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:_,worldview:this.map.getWorldview()};u.request=this.actor.send(o,v,(E,T)=>_&&!T?(u.state="loaded",t(null)):(delete u.request,u.destroy(),u.aborted?t(null):E?t(E):(u.loadVectorData(T,this.map.painter,o==="reloadTile"),t(null))),void 0,o==="loadTile")}abortTile(u){u.request&&(u.request.cancel(),delete u.request),u.aborted=!0}unloadTile(u,t){this.actor.send("removeTile",{uid:u.uid,type:this.type,source:this.id,scope:this.scope}),u.destroy()}onRemove(u){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return r.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends r.aP{constructor(u,t,o,h){super(u,t,o,h),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;let u=this.options;this.urls=[];for(let t of u.urls)this.urls.push(this.map._requestManager.transformRequest(t,r.R.Source).url);r.aQ(this.urls,(t,o)=>{this._loaded=!0,t?this.fire(new r.z(t)):o&&(this.video=o,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(u){if(this.video){let t=this.video.seekable;u<t.start(0)||u>t.end(0)?this.fire(new r.z(new r.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=u}}getVideo(){return this.video}onAdd(u){this.map||(this.map=u,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let u=this.map.painter.context,t=u.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new r.T(u,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(u)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:r.aP,model:class extends r.E{constructor(u,t,o,h){super(),this.id=u,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){let u=[];for(let t in this._options.models){let o=this._options.models[t],h=r.aS(this.map._requestManager.transformRequest(o.uri,r.R.Model).url).then(g=>{if(!g)return;let _=r.aT(g),v=new r.aU(t,o.position,o.orientation,_);v.computeBoundsAndApplyParent(),this.models.push(v)}).catch(g=>{this.fire(new r.z(new Error(`Could not load model ${t} from ${o.uri}: ${g.message}`)))});u.push(h)}Promise.allSettled(u).then(()=>{this._loaded=!0,this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new r.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(u){this.map=u,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(u,t){}serialize(){return this._options}},"batched-model":class extends r.E{constructor(u,t,o,h){super(),this.type="batched-model",this.id=u,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=o,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(h)}onAdd(u){this.map=u,this.load()}reload(){this.cancelTileJSONRequest();let u=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(u))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(u){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));let t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=hr(this._options,this.map._requestManager,t,o,(h,g)=>{this._tileJSONRequest=null,this._loaded=!0,h?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),o&&o.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new r.z(h))):g&&(r.h(this,g),g.bounds&&(this.tileBounds=new Rr(g.bounds,this.minzoom,this.maxzoom)),zr(g.tiles,this.map._requestManager._customAccessToken),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))),u&&u(h)})}hasTransition(){return!1}hasTile(u){return!this.tileBounds||this.tileBounds.contains(u.canonical)}loaded(){return this._loaded}loadTile(u,t){let o=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme)),h={request:this.map._requestManager.transformRequest(o,r.R.Tile),data:void 0,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,tileSize:this.tileSize*u.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:u.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:r.q.devicePixelRatio,promoteId:this.promoteId};if(u.actor&&u.state!=="expired")if(u.state==="loading")u.reloadCallback=t;else{if(u.buckets){let _=Object.values(u.buckets);for(let v of _)v.dirty=!0;return void(u.state="loaded")}u.request=u.actor.send("reloadTile",h,g.bind(this))}else u.actor=this.dispatcher.getActor(),u.request=u.actor.send("loadTile",h,g.bind(this),void 0,!0);function g(_,v){return u.aborted?t(null):_&&_.status!==404?t(_):(this.map._refreshExpiredTiles&&v&&u.setExpiryData(v),u.loadModelData(v,this.map.painter),u.state="loaded",void t(null))}}serialize(){return r.h({},this._options)}},canvas:class extends r.aP{constructor(u,t,o,h){super(u,t,o,h),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(g=>!Array.isArray(g)||g.length!==2||g.some(_=>typeof _!="number"))||this.fire(new r.z(new r.V(`sources.${u}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new r.z(new r.V(`sources.${u}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new r.z(new r.V(`sources.${u}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new r.z(new r.V(`sources.${u}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new r.z(new r.V(`sources.${u}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new r.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(u){this.map=u,this.load(),this.canvas&&this.animate&&this.play()}onRemove(u){this.pause()}prepare(){let u=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,u=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,u=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let t=this.map.painter.context;this.texture?!u&&!this._playing||this.texture instanceof r.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new r.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let u of[this.canvas.width,this.canvas.height])if(isNaN(u)||u<=0)return!0;return!1}},custom:class extends r.E{constructor(u,t,o,h){super(),this.id=u,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=t,this.setEventedParent(h),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new r.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new r.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Rr(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),r.h(this,r.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return r.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(u){this.map=u,this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(u),this.load()}onRemove(u){this._implementation.onRemove&&this._implementation.onRemove(u)}hasTile(u){if(this._implementation.hasTile){let{x:t,y:o,z:h}=u.canonical;return this._implementation.hasTile({x:t,y:o,z:h})}return!this.tileBounds||this.tileBounds.contains(u.canonical)}loadTile(u,t){let{x:o,y:h,z:g}=u.tileID.canonical,_=new AbortController;u.request=Promise.resolve(this._implementation.loadTile({x:o,y:h,z:g},{signal:_.signal})).then((function(v){return delete u.request,u.aborted?(u.state="unloaded",t(null)):v===void 0?(u.state="errored",t(null)):v===null?(this.loadTileData(u,{width:this.tileSize,height:this.tileSize,data:null}),u.state="loaded",t(null)):function(E){return E instanceof ImageData||E instanceof HTMLCanvasElement||E instanceof ImageBitmap||E instanceof HTMLImageElement}(v)?(this.loadTileData(u,v),u.state="loaded",void t(null)):(u.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(v=>{v.name!=="AbortError"&&(u.state="errored",t(v))}),u.request.cancel=()=>_.abort()}loadTileData(u,t){u.setTexture(t,this.map.painter)}unloadTile(u,t){if(u.texture&&u.texture instanceof r.T?(u.destroy(!0),u.texture&&u.texture instanceof r.T&&this.map.painter.saveTileTexture(u.texture)):u.destroy(),this._implementation.unloadTile){let{x:o,y:h,z:g}=u.tileID.canonical;this._implementation.unloadTile({x:o,y:h,z:g})}t&&t()}abortTile(u,t){u.request&&u.request.cancel&&(u.request.cancel(),delete u.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(u=>({x:u.canonical.x,y:u.canonical.y,z:u.canonical.z}))}_clearTiles(){let u=r.C(this.id,this.scope);this.map.style.clearSource(u)}_update(){this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}}},fu=function(u,t,o,h){let g=new Zd[t.type](u,t,o,h);if(g.id!==u)throw new Error(`Expected Source id to be ${u} instead of ${g.id}`);return r.aV(["load","abort","unload","serialize","prepare"],g),g};function pu(u,t,o=""){return`${o}:${t.id||""}:${t.layer.id}:${function(h){if("layerId"in h)return`layer:${h.layerId}`;{let{featuresetId:g,importId:_}=h;return`featureset:${g}${_?`:import:${_}`:""}`}}(u.target)}`}function Xd(u,t,o,h=""){if(u.uniqueFeatureID){let g=pu(u,t,h);if(o.has(g))return!0;o.add(g)}return!1}function Yd(u,t,o,h,g=!1){let _=t.sourceCache.transform,v=t.sourceCache.tilesIn(u,t.has3DLayers,g);v.sort(Kd);let E=[];for(let T of v){let C=T.tile.queryRenderedFeatures(t,T,o,h,_,g);Object.keys(C).length&&E.push({wrappedTileID:T.tile.tileID.wrapped().key,queryResults:C})}return E.length===0?{}:function(T){let C={},A={};for(let L of T){let R=L.queryResults,k=L.wrappedTileID,V=A[k]=A[k]||{};for(let z in R){let U=R[z],j=V[z]=V[z]||{},W=C[z]=C[z]||[];for(let Y of U)j[Y.featureIndex]||(j[Y.featureIndex]=!0,W.push(Y))}}return C}(E)}function Ja(u,t,o,h,g,_){let v={},E=h.queryRenderedSymbols(u),T=[];for(let C of Object.keys(E).map(Number))T.push(g[C]);T.sort(Kd);for(let C of T){let A=C.featureIndex.lookupSymbolFeatures(E[C.bucketInstanceId],C.bucketIndex,C.sourceLayerIndex,t,o,_);for(let L in A){let R=v[L]=v[L]||[],k=A[L];k.sort((V,z)=>{let U=C.featureSortOrder;if(U){let j=U.indexOf(V.featureIndex);return U.indexOf(z.featureIndex)-j}return z.featureIndex-V.featureIndex});for(let V of k)R.push(V)}}return v}function mu(u,t){let o=u.getRenderableIds().map(_=>u.getTileByID(_)),h=[],g={};for(let _=0;_<o.length;_++){let v=o[_],E=v.tileID.canonical.key;g[E]||(g[E]=!0,v.querySourceFeatures(h,t))}return h}function Kd(u,t){let o=u.tileID,h=t.tileID;return o.overscaledZ-h.overscaledZ||o.canonical.y-h.canonical.y||o.wrap-h.wrap||o.canonical.x-h.canonical.x}function rs(u,t){let o={};if(!t)return o;for(let h of u){let g=h.layerIds.map(_=>t.getLayer(_)).filter(Boolean);if(g.length!==0){h.layers=g,h.stateDependentLayerIds&&(h.stateDependentLayers=h.stateDependentLayerIds.map(_=>g.filter(v=>v.id===_)[0]));for(let _ of g)o[_.fqid]=h}}return o}let Io=32,qo=33,Bs=new Uint16Array(8184);for(let u=0;u<2046;u++){let t=u+2,o=0,h=0,g=0,_=0,v=0,E=0;for(1&t?g=_=v=Io:o=h=E=Io;(t>>=1)>1;){let C=o+g>>1,A=h+_>>1;1&t?(g=o,_=h,o=v,h=E):(o=g,h=_,g=v,_=E),v=C,E=A}let T=4*u;Bs[T+0]=o,Bs[T+1]=h,Bs[T+2]=g,Bs[T+3]=_}let os=new Uint16Array(2178),Vs=new Uint8Array(1089),gu=new Uint16Array(1089);function vs(u){return u===0?-.03125:u===32?.03125:0}let _u={type:2,extent:r.aj,loadGeometry:()=>[[new r.P(0,0),new r.P(r.aj+1,0),new r.P(r.aj+1,r.aj+1),new r.P(0,r.aj+1),new r.P(0,0)]]};class Qa{constructor(t,o,h,g,_,v){this.tileID=t,this.uid=r.a$(),this.uses=0,this.tileSize=o,this.tileZoom=h,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=_,g&&g.style&&(this._lastUpdatedBrightness=g.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",g&&g.transform&&(this.projection=g.transform.projection),this.worldview=v}registerFadeDuration(t){let o=t+this.timeAdded;o<r.q.now()||this.fadeEndTime&&o<this.fadeEndTime||(this.fadeEndTime=o)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=r.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,o,h){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=rs(t.buckets,o.style),this.hasSymbolBuckets=!1;for(let g in this.buckets){let _=this.buckets[g];if(_ instanceof r.b1){if(this.hasSymbolBuckets=!0,!h)break;_.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let g in this.buckets){let _=this.buckets[g];if(_ instanceof r.b1&&_.hasRTLText){this.hasRTLText=!0,r.b2();break}}this.queryPadding=0;for(let g in this.buckets){let _=this.buckets[g],v=o.style.getOwnLayer(g);if(!v)continue;let E=v.queryRadius(_);this.queryPadding=Math.max(this.queryPadding,E)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new r.b0}unloadVectorData(){if(this.hasData()){for(let t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,o,h){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,rs(t.buckets,o.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(let g in this.buckets){let _=this.buckets[g];_.uploadPending()&&_.upload(t)}let o=t.gl,h=this.imageAtlas;h&&!h.uploaded&&(this.imageAtlasTexture=new r.T(t,h.image,o.RGBA8,{useMipmap:!!h.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new r.T(t,this.glyphAtlasImage,o.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new r.T(t,this.lineAtlas.image,o.R8),this.lineAtlas.uploaded=!0)}prepare(t,o,h){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,h),!o||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let g=o.style.getBrightness();(this._lastUpdatedBrightness||g)&&(this._lastUpdatedBrightness&&g&&Math.abs(this._lastUpdatedBrightness-g)<.001||(this.updateBuckets(o,this._lastUpdatedBrightness!==g),this._lastUpdatedBrightness=g))}queryRenderedFeatures(t,o,h,g,_,v){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let E=function(T,C){let A=r.bn([],[.5*T.width,.5*-T.height,1]);return r.bo(A,A,[1,-1,0]),r.az(A,A,T.calculateProjMatrix(C.toUnwrapped())),Float32Array.from(A)}(_,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:o,pixelPosMatrix:E,transform:g,availableImages:h,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,o){let h=this.latestFeatureIndex;if(!h||!h.rawTileData)return;let g=h.loadVTLayers(),_=o?o.sourceLayer:"",v=g._geojsonTileLayer||g[_];if(!v)return;let E=r.b3(o&&o.filter),{z:T,x:C,y:A}=this.tileID.canonical,L={z:T,x:C,y:A};for(let R=0;R<v.length;R++){let k=v.feature(R);if(E.needGeometry){let U=r.b4(k,!0);if(!E.filter(new r.aa(this.tileID.overscaledZ,{worldview:this.worldview}),U,this.tileID.canonical))continue}else if(!E.filter(new r.aa(this.tileID.overscaledZ,{worldview:this.worldview}),k))continue;let V=h.getId(k,_),z=new r.b5(k,T,C,A,V);z.tile=L,t.push(z)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){let o=this.expirationTime;if(t.cacheControl){let h=r.b6(t.cacheControl);h["max-age"]&&(this.expirationTime=Date.now()+1e3*h["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){let h=Date.now(),g=!1;if(this.expirationTime>h)g=!1;else if(o)if(this.expirationTime<o)g=!0;else{let _=this.expirationTime-o;_?this.expirationTime=h+Math.max(_,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,o){if(!this.latestFeatureIndex||!t.style)return;let h=this.latestFeatureIndex.loadVTLayers(),g=t.style.listImages(),_=t.style.getBrightness();for(let v in this.buckets){if(!t.style.hasLayer(v))continue;let E=this.buckets[v],T=E.layers[0],C=T.sourceLayer||"_geojsonTileLayer",A=h[C],L=t.style.getLayerSourceCache(T),R={};L&&(R=L._state.getState(C,void 0));let k=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},V=Object.keys(R).length>0&&!o;V&&!E.stateDependentLayers.length&&!o||E.update(R,A,g,k,V?E.stateDependentLayers:E.layers,o,_),(E instanceof r.b7||E instanceof r.b8)&&t._terrain&&t._terrain.enabled&&L&&E.uploadPending()&&t._terrain._clearRenderCacheForTile(L.id,this.tileID);let z=t&&t.style&&t.style.getOwnLayer(v);z&&(this.queryPadding=Math.max(this.queryPadding,z.queryRadius(E)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<r.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=r.q.now()+t}setTexture(t,o){let h=o.context,g=h.gl;this.texture=this.texture||o.getTileTexture(t.width),this.texture&&this.texture instanceof r.T?this.texture.update(t):(this.texture=new r.T(h,t,g.RGBA8,{useMipmap:!0}),this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE))}setDependencies(t,o){let h={};for(let g of o)h[g]=!0;this.dependencies[t]=h}hasDependency(t,o){for(let h of t){let g=this.dependencies[h];if(g){for(let _ of o)if(g[_])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,o){if(!o||o.name==="mercator"||this._tileDebugBuffer)return;let h=r.b9(_u,this.tileID.canonical,this.tileTransform)[0],g=new r.ba,_=new r.bb;for(let v=0;v<h.length;v++){let{x:E,y:T}=h[v];g.emplaceBack(E,T),_.emplaceBack(v)}_.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(_),this._tileDebugBuffer=t.createVertexBuffer(g,r.bc.members),this._tileDebugSegments=r.bd.simpleSegment(0,0,g.length,_.length)}_makeTileBoundsBuffers(t,o){if(this._tileBoundsBuffer||!o||o.name==="mercator")return;let h=r.b9(_u,this.tileID.canonical,this.tileTransform)[0],g,_;if(this.isRaster){let v=function(E,T){let C=r.aW(E,T),A=Math.pow(2,E.z);for(let U=0;U<qo;U++)for(let j=0;j<qo;j++){let W=r.aX((E.x+(j+vs(j))/Io)/A),Y=r.aY((E.y+(U+vs(U))/Io)/A),J=T.project(W,Y),ie=U*qo+j;os[2*ie+0]=Math.round((J.x*C.scale-C.x)*r.aj),os[2*ie+1]=Math.round((J.y*C.scale-C.y)*r.aj)}Vs.fill(0),gu.fill(0);for(let U=2045;U>=0;U--){let j=4*U,W=Bs[j+0],Y=Bs[j+1],J=Bs[j+2],ie=Bs[j+3],le=W+J>>1,ue=Y+ie>>1,re=le+ue-Y,oe=ue+W-le,se=Y*qo+W,Ee=ie*qo+J,me=ue*qo+le,Ne=Math.hypot((os[2*se+0]+os[2*Ee+0])/2-os[2*me+0],(os[2*se+1]+os[2*Ee+1])/2-os[2*me+1])>=16;Vs[me]=Vs[me]||(Ne?1:0),U<1022&&(Vs[me]=Vs[me]||Vs[(Y+oe>>1)*qo+(W+re>>1)]||Vs[(ie+oe>>1)*qo+(J+re>>1)])}let L=new r.aZ,R=new r.a_,k=0;function V(U,j){let W=j*qo+U;return gu[W]===0&&(L.emplaceBack(os[2*W+0],os[2*W+1],U*r.aj/Io,j*r.aj/Io),gu[W]=++k),gu[W]-1}function z(U,j,W,Y,J,ie){let le=U+W>>1,ue=j+Y>>1;if(Math.abs(U-J)+Math.abs(j-ie)>1&&Vs[ue*qo+le])z(J,ie,U,j,le,ue),z(W,Y,J,ie,le,ue);else{let re=V(U,j),oe=V(W,Y),se=V(J,ie);R.emplaceBack(re,oe,se)}}return z(0,0,Io,Io,Io,0),z(Io,Io,0,0,0,Io),{vertices:L,indices:R}}(this.tileID.canonical,o);g=v.vertices,_=v.indices}else{g=new r.aZ,_=new r.a_;for(let{x:E,y:T}of h)g.emplaceBack(E,T,0,0);let v=r.be(g.int16.subarray(0,4*g.length),void 0,4);for(let E=0;E<v.length;E+=3)_.emplaceBack(v[E],v[E+1],v[E+2])}this._tileBoundsBuffer=t.createVertexBuffer(g,r.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(_),this._tileBoundsSegments=r.bd.simpleSegment(0,0,g.length,_.length)}_makeGlobeTileDebugBuffers(t,o){let h=o.projection;if(!h||h.name!=="globe"||o.freezeTileCoverage)return;let g=this.tileID.canonical,_=r.bg(g,o),v=r.bh(_),E=r.ah(o.zoom),T;E>0&&(T=r.bi(new Float64Array(16),o.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,g,o,v,T,E),this._makeGlobeTileDebugTextBuffer(t,g,o,v,T,E)}_globePoint(t,o,h,g,_,v,E){let T=r.bj(t,o,h);if(v){let C=1<<h.z,A=r.aD(g.center.lng),L=r.aH(g.center.lat),R=(h.x+.5)/C-A,k=0;R>.5?k=-1:R<-.5&&(k=1);let V=(t/r.aj+h.x)/C+k,z=(o/r.aj+h.y)/C;V=(V-A)*g._pixelsPerMercatorPixel+A,z=(z-L)*g._pixelsPerMercatorPixel+L;let U=[V*g.worldSize,z*g.worldSize,0];r.ad(U,U,v),T=r.bk(T,U,E)}return r.ad(T,T,_)}_makeGlobeTileDebugBorderBuffer(t,o,h,g,_,v){let E=new r.ba,T=new r.bb,C=new r.bl,A=(R,k,V,z,U)=>{let j=(V-R)/(U-1),W=(z-k)/(U-1),Y=E.length;for(let J=0;J<U;J++){let ie=R+J*j,le=k+J*W;E.emplaceBack(ie,le);let ue=this._globePoint(ie,le,o,h,g,_,v);C.emplaceBack(ue[0],ue[1],ue[2]),T.emplaceBack(Y+J)}},L=r.aj;A(0,0,L,0,16),A(L,0,L,L,16),A(L,L,0,L,16),A(0,L,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(T),this._tileDebugBuffer=t.createVertexBuffer(E,r.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(C,r.bm.members),this._tileDebugSegments=r.bd.simpleSegment(0,0,E.length,T.length)}_makeGlobeTileDebugTextBuffer(t,o,h,g,_,v){let E=r.aj/4,T=new r.ba,C=new r.a_,A=new r.bl,L=25;C.reserve(32),T.reserve(L),A.reserve(L);let R=(k,V)=>L*k+V;for(let k=0;k<L;k++){let V=k*E;for(let z=0;z<L;z++){let U=z*E;T.emplaceBack(U,V);let j=this._globePoint(U,V,o,h,g,_,v);A.emplaceBack(j[0],j[1],j[2])}}for(let k=0;k<4;k++)for(let V=0;V<4;V++){let z=R(k,V),U=R(k,V+1),j=R(k+1,V),W=R(k+1,V+1);C.emplaceBack(z,U,j),C.emplaceBack(j,U,W)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(C),this._tileDebugTextBuffer=t.createVertexBuffer(T,r.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(A,r.bm.members),this._tileDebugTextSegments=r.bd.simpleSegment(0,0,L,32)}destroy(t=!1){for(let o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof r.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}r.bp.setPbf(r.bq);class $l extends Qa{constructor(t,o,h,g,_){super(t,o,h,g,_),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,o,h){let g=h.context,_=g.gl,v=this.texturePerLayer.get(t)||h.getTileTexture(o.width);v&&v instanceof r.T?v.update(o,{premultiply:!1}):v=new r.T(g,o,_.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,v)}flushQueues(t){let o=this._workQueuePerLayer.get(t)||[],h=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()();for(;h.length;)h.pop()()}flushAllQueues(){for(let t of this._workQueuePerLayer.keys()){let o=this._workQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}for(let t of this._fetchQueuePerLayer.keys()){let o=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}}fetchHeader(t=16384,o){let h=this._mrt=new r.bp(30),g=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=r.br(g,(_,v,E,T)=>{if(_)o(_);else try{let C=h.getHeaderLength(v);if(C>t)return void(this.request=this.fetchHeader(C,o));h.parseHeader(v),this._isHeaderLoaded=!0;let A=0;for(let L of Object.values(h.layers))A=Math.max(A,L.dataIndex[L.dataIndex.length-1].lastByte);v.byteLength>=A&&(this.entireBuffer=v),o(null,this.entireBuffer||v,E,T)}catch(C){o(C)}}),this.request}fetchBand(t,o,h,g){let _=this._mrt;if(!this._isHeaderLoaded||!_)return void g(new Error("Tile header is not ready"));let v=this.actor;if(!v)return void g(new Error("Can't fetch tile band without an actor"));let E,T=(R,k)=>{if(E.complete(R,k),R)return void g(R);this.updateTextureDescriptor(t,o,h);let V=this.textureDescriptorPerLayer.get(o);g(null,V&&V.img)},C=(R,k)=>{if(R)return g(R);let V=v.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:k,task:E},T,void 0,!0),z=this._workQueuePerLayer.get(o)||[];z.push(()=>{V&&V.cancel(),E.cancel()}),this._workQueuePerLayer.has(o)||this._workQueuePerLayer.set(o,z)},A=_.getLayer(t);if(!A)return void g(new Error(`Unknown sourceLayer "${t}"`));if(A.hasDataForBand(h)){this.updateTextureDescriptor(t,o,h);let R=this.textureDescriptorPerLayer.get(o);return void g(null,R?R.img:null)}let L=A.getDataRange([h]);if(E=_.createDecodingTask(L),!E||E.tasks.length)if(this.flushQueues(o),this.entireBuffer)C(null,this.entireBuffer.slice(L.firstByte,L.lastByte+1));else{let R=Object.assign({},this.requestParams,{headers:{Range:`bytes=${L.firstByte}-${L.lastByte}`}}),k=r.br(R,C),V=this._fetchQueuePerLayer.get(o)||[];V.push(()=>{k.cancel(),E.cancel()}),this._fetchQueuePerLayer.has(o)||this._fetchQueuePerLayer.set(o,V)}else g(null)}updateNeeded(t,o){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==o)&&this.state!=="errored"}updateTextureDescriptor(t,o,h){if(!this._mrt)return;let g=this._mrt.getLayer(t);if(!g||!g.hasBand(h)||!g.hasDataForBand(h))return;let{bytes:_,tileSize:v,buffer:E,offset:T,scale:C}=g.getBandView(h),A=v+2*E,L=new r.r({width:A,height:A},_),R=this.texturePerLayer.get(o);R&&R instanceof r.T&&R.update(L,{premultiply:!1}),this.textureDescriptorPerLayer.set(o,{layer:t,band:h,img:L,buffer:E,offset:T,tileSize:v,format:g.pixelFormat,mix:[C,256*C,65536*C,16777216*C]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(let o of this.texturePerLayer.values())o&&o instanceof r.T&&o.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class mp{constructor(t,o){this.max=t,this.onRemove=o,this.reset()}reset(){for(let t in this.data)for(let o of this.data[t])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(t,o,h){let g=t.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);let _={value:o,timeout:void 0};if(h!==void 0&&(_.timeout=setTimeout(()=>{this.remove(t,_)},h)),this.data[g].push(_),this.order.push(g),this.order.length>this.max){let v=this._getAndRemoveByKey(this.order[0]);v&&this.onRemove(v)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){let o=this.data[t].shift();return o.timeout&&clearTimeout(o.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),o.value}getByKey(t){let o=this.data[t];return o?o[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,o){if(!this.has(t))return this;let h=t.wrapped().key,g=o===void 0?0:this.data[h].indexOf(o),_=this.data[h][g];return this.data[h].splice(g,1),_.timeout&&clearTimeout(_.timeout),this.data[h].length===0&&delete this.data[h],this.onRemove(_.value),this.order.splice(this.order.indexOf(h),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){let o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(t){let o=[];for(let h in this.data)for(let g of this.data[h])t(g.value)||o.push(g);for(let h of o)this.remove(h.value.tileID,h)}}class gp{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,o,h){let g=String(o);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][g]=this.stateChanges[t][g]||{},r.h(this.stateChanges[t][g],h),this.deletedStates[t]===null){this.deletedStates[t]={};for(let _ in this.state[t])_!==g&&(this.deletedStates[t][_]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][g]===null){this.deletedStates[t][g]={};for(let _ in this.state[t][g])h[_]||(this.deletedStates[t][g][_]=null)}else for(let _ in h)this.deletedStates[t]&&this.deletedStates[t][g]&&this.deletedStates[t][g][_]===null&&delete this.deletedStates[t][g][_]}removeFeatureState(t,o,h){if(this.deletedStates[t]===null)return;let g=String(o);if(this.deletedStates[t]=this.deletedStates[t]||{},h&&o!==void 0)this.deletedStates[t][g]!==null&&(this.deletedStates[t][g]=this.deletedStates[t][g]||{},this.deletedStates[t][g][h]=null);else if(o!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][g])for(h in this.deletedStates[t][g]={},this.stateChanges[t][g])this.deletedStates[t][g][h]=null;else this.deletedStates[t][g]=null;else this.deletedStates[t]=null}getState(t,o){let h=this.state[t]||{},g=this.stateChanges[t]||{},_=this.deletedStates[t];if(_===null)return{};if(o!==void 0){let E=String(o),T=r.h({},h[E],g[E]);if(_){let C=_[o];if(C===null)return{};for(let A in C)delete T[A]}return T}let v=r.h({},h,g);if(_)for(let E in _)delete v[E];return v}initializeTileState(t,o){t.refreshFeatureState(o)}coalesceChanges(t,o){let h={};for(let g in this.stateChanges){this.state[g]=this.state[g]||{};let _={};for(let v in this.stateChanges[g])this.state[g][v]||(this.state[g][v]={}),r.h(this.state[g][v],this.stateChanges[g][v]),_[v]=this.state[g][v];h[g]=_}for(let g in this.deletedStates){this.state[g]=this.state[g]||{};let _={};if(this.deletedStates[g]===null)for(let v in this.state[g])_[v]={},this.state[g][v]={};else for(let v in this.deletedStates[g]){if(this.deletedStates[g][v]===null)this.state[g][v]={};else if(this.state[g][v])for(let E of Object.keys(this.deletedStates[g][v]))delete this.state[g][v][E];_[v]=this.state[g][v]}h[g]=h[g]||{},r.h(h[g],_)}if(this.stateChanges={},this.deletedStates={},Object.keys(h).length!==0)for(let g in t)t[g].refreshFeatureState(o)}}class eo extends r.E{constructor(t,o,h){super(),this.id=t,this._onlySymbols=h,o.on("data",g=>{g.dataType==="source"&&g.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&g.dataType==="source"&&g.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),o.on("error",()=>{this._sourceErrored=!0}),this._source=o,this._tiles={},this._cache=new mp(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=o.minTileCacheSize,this._maxTileCacheSize=o.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new gp,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,o){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,o)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let o in this._tiles){let h=this._tiles[o];h.upload(t),h.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(el).map(t=>t.key)}getRenderableIds(t,o){let h=[];for(let g in this._tiles)this._isIdRenderable(+g,t,o)&&h.push(this._tiles[g]);return t?h.sort((g,_)=>{let v=g.tileID,E=_.tileID,T=new r.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle),C=new r.P(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return v.overscaledZ-E.overscaledZ||C.y-T.y||C.x-T.x}).map(g=>g.tileID.key):h.map(g=>g.tileID).sort(el).map(g=>g.key)}hasRenderableParent(t){let o=this.findLoadedParent(t,0);return!!o&&this._isIdRenderable(o.tileID.key)}_isIdRenderable(t,o,h){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(o||!this._tiles[t].holdingForFade())&&(h||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,o){let h=this._tiles[t];h&&(h.state!=="loading"&&(h.state=o),this._loadTile(h,this._tileLoaded.bind(this,h,t,o)))}_tileLoaded(t,o,h,g){if(g)if(t.state="errored",g.status!==404)this._source.fire(new r.z(g,{tile:t}));else{if(this._source.fire(new r.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let _=this.map.painter.terrain;this.update(this.transform,_.getScaledDemTileSize(),!0),_.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=r.q.now(),h==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(o,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new r.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){let o=this.getRenderableIds();for(let g=0;g<o.length;g++){let _=o[g];if(t.neighboringTiles&&t.neighboringTiles[_]){let v=this.getTileByID(_);h(t,v),h(v,t)}}function h(g,_){if(!g.dem||g.dem.borderReady)return;g.needsHillshadePrepare=!0,g.needsDEMTextureUpload=!0;let v=_.tileID.canonical.x-g.tileID.canonical.x,E=_.tileID.canonical.y-g.tileID.canonical.y,T=Math.pow(2,g.tileID.canonical.z),C=_.tileID.key;v===0&&E===0||Math.abs(E)>1||(Math.abs(v)>1&&(Math.abs(v+T)===1?v+=T:Math.abs(v-T)===1&&(v-=T)),_.dem&&g.dem&&(g.dem.backfillBorder(_.dem,v,E),g.neighboringTiles&&g.neighboringTiles[C]&&(g.neighboringTiles[C].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,o,h,g){for(let _ in this._tiles){let v=this._tiles[_];if(g[_]||!v.hasData()||v.tileID.overscaledZ<=o||v.tileID.overscaledZ>h)continue;let E=v.tileID;for(;v&&v.tileID.overscaledZ>o+1;){let C=v.tileID.scaledTo(v.tileID.overscaledZ-1);v=this._tiles[C.key],v&&v.hasData()&&(E=C)}let T=E;for(;T.overscaledZ>o;)if(T=T.scaledTo(T.overscaledZ-1),t[T.key]){g[E.key]=E;break}}}findLoadedParent(t,o){if(t.key in this._loadedParentTiles){let h=this._loadedParentTiles[t.key];return h&&h.tileID.overscaledZ>=o?h:null}for(let h=t.overscaledZ-1;h>=o;h--){let g=t.scaledTo(h),_=this._getLoadedTile(g);if(_)return _}}_getLoadedTile(t){let o=this._tiles[t.key];return o&&o.hasData()?o:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,o){o=o||this._source.tileSize;let h=Math.ceil(t.width/o)+1,g=Math.ceil(t.height/o)+1,_=Math.floor(h*g*5),v=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,_):_,E=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,v):v;this._cache.setMaxSize(E)}handleWrapJump(t){let o=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,o){let h={};for(let g in this._tiles){let _=this._tiles[g];_.tileID=_.tileID.unwrapTo(_.tileID.wrap+o),h[_.tileID.key]=_}this._tiles=h;for(let g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(let g in this._tiles)this._setTileReloadTimer(+g,this._tiles[g])}}update(t,o,h,g,_){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!h)return;this.updateCacheSize(t,o),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let v=this._source.type==="batched-model",E,T=this._source.maxzoom,C=this.map&&this.map.painter?this.map.painter._terrain:null;if(C&&C.sourceCache===this&&C.attenuationRange()){let R=C.attenuationRange()[0],k=Math.floor(R)-Math.log2(C.getDemUpscale());T>k&&(T=k)}if(this.used||this.usedForTerrain){if(this._source.tileID)E=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(R=>new r.aM(R.canonical.z,R.wrap,R.canonical.z,R.canonical.x,R.canonical.y));else if(this.tileCoverLift!==0){let R=t.clone();R.tileCoverLift=this.tileCoverLift,E=R.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.minzoom<=1&&t.projection.name==="globe"&&(E.push(new r.aM(1,0,1,0,0)),E.push(new r.aM(1,0,1,1,0)),E.push(new r.aM(1,0,1,0,1)),E.push(new r.aM(1,0,1,1,1)))}else if(E=t.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.hasTile){let R=this._source.hasTile.bind(this._source);E=E.filter(k=>R(k))}}else E=[];if(E.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!yu(this._source.type)){let R=t.coveringZoomLevel({tileSize:o||this._source.tileSize,roundZoom:this._source.roundZoom&&!h}),k=Math.min(R,this._source.maxzoom);if(v){let V=t.extendTileCover(E,k);for(let z of V)E.push(z)}else if(_){let V=t.extendTileCoverToNearPlane(E,this.transform.getFrustum(k),k);for(let z of V)E.push(z)}else if(this.castsShadows&&g){let V=t.extendTileCover(E,k,g);for(let z of V)this._shadowCasterTiles[z.key]=!0,E.push(z)}}let A=this._updateRetainedTiles(E);if(yu(this._source.type)&&E.length!==0){let R={},k={},V=Object.keys(A);for(let U of V){let j=A[U],W=this._tiles[U];if(!W||W.fadeEndTime&&W.fadeEndTime<=r.q.now())continue;let Y=this.findLoadedParent(j,Math.max(j.overscaledZ-eo.maxOverzooming,this._source.minzoom));Y&&(this._addTile(Y.tileID),R[Y.tileID.key]=Y.tileID),k[U]=j}let z=E[E.length-1].overscaledZ;for(let U in this._tiles){let j=this._tiles[U];if(A[U]||!j.hasData())continue;let W=j.tileID;for(;W.overscaledZ>z;){W=W.scaledTo(W.overscaledZ-1);let Y=this._tiles[W.key];if(Y&&Y.hasData()&&k[W.key]){A[U]=j.tileID;break}}}for(let U in R)A[U]||(this._coveredTiles[U]=!0,A[U]=R[U])}for(let R in A)this._tiles[R].clearFadeHold();let L=r.bs(this._tiles,A);for(let R of L){let k=this._tiles[R];k.hasSymbolBuckets&&!k.holdingForFade()?k.setHoldDuration(this.map._fadeDuration):k.hasSymbolBuckets&&!k.symbolFadeFinished()||this._removeTile(+R)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){let o={};if(t.length===0)return o;let h={},g=t.reduce((C,A)=>Math.min(C,A.overscaledZ),1/0),_=t[0].overscaledZ,v=Math.max(_-eo.maxOverzooming,this._source.minzoom),E=Math.max(_+eo.maxUnderzooming,this._source.minzoom),T={};for(let C of t){let A=this._addTile(C);o[C.key]=C,A.hasData()||g<this._source.maxzoom&&(T[C.key]=C)}this._retainLoadedChildren(T,g,E,o);for(let C of t){let A=this._tiles[C.key];if(A.hasData())continue;if(C.canonical.z>=this._source.maxzoom){let R=C.children(this._source.maxzoom)[0],k=this.getTile(R);if(k&&k.hasData()){o[R.key]=R;continue}}else{let R=C.children(this._source.maxzoom);if(o[R[0].key]&&o[R[1].key]&&o[R[2].key]&&o[R[3].key])continue}let L=A.wasRequested();for(let R=C.overscaledZ-1;R>=v;--R){let k=C.scaledTo(R);if(h[k.key]||(h[k.key]=!0,A=this.getTile(k),!A&&L&&(A=this._addTile(k)),A&&(o[k.key]=k,L=A.wasRequested(),A.hasData())))break}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let t in this._tiles){let o=[],h,g=this._tiles[t].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){h=this._loadedParentTiles[g.key];break}o.push(g.key);let _=g.scaledTo(g.overscaledZ-1);if(h=this._getLoadedTile(_),h)break;g=_}for(let _ of o)this._loadedParentTiles[_]=h}}_addTile(t){let o=this._tiles[t.key];if(o)return o.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),o;o=this._cache.getAndRemove(t),o&&(this._setTileReloadTimer(t.key,o),o.tileID=t,this._state.initializeTileState(o,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,o)));let h=!!o;if(!h){let g=this.map?this.map.painter:null,_=this._source.tileSize*t.overscaleFactor();o=this._source.type==="raster-array"?new $l(t,_,this.transform.tileZoom,g,this._isRaster):new Qa(t,_,this.transform.tileZoom,g,this._isRaster,this._source.worldview),this._loadTile(o,this._tileLoaded.bind(this,o,t.key,o.state))}return o.uses++,this._tiles[t.key]=o,h||this._source.fire(new r.A("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o}_setTileReloadTimer(t,o){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);let h=o.getExpiryTimeout();h&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},h))}_removeTile(t){let o=this._tiles[t];o&&(o.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),o.uses>0||(o.hasData()&&o.state!=="reloading"||o.state==="empty"?this._cache.add(o.tileID,o,o.getExpiryTimeout()):(o.aborted=!0,this._abortTile(o),this._unloadTile(o))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,o,h){let g=[],_=this.transform;if(!_)return g;let v=_.projection.name==="globe",E=r.aD(_.center.lng);for(let T in this._tiles){let C=this._tiles[T];if(h&&C.clearQueryDebugViz(),C.holdingForFade())continue;let A;if(v){let L=C.tileID.canonical;if(L.z===0){let R=[Math.abs(r.ay(E,...Gl(L,-1))-E),Math.abs(r.ay(E,...Gl(L,1))-E)];A=[0,2*R.indexOf(Math.min(...R))-1]}else{let R=[Math.abs(r.ay(E,...Gl(L,-1))-E),Math.abs(r.ay(E,...Gl(L,0))-E),Math.abs(r.ay(E,...Gl(L,1))-E)];A=[R.indexOf(Math.min(...R))-1]}}else A=[0];for(let L of A){let R=t.containsTile(C,_,o,L);R&&g.push(R)}}return g}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,o){let h=this.getRenderableIds(t,o).map(_=>this._tiles[_].tileID),g=this.transform.projection.name==="globe";for(let _ of h)_.projMatrix=this.transform.calculateProjMatrix(_.toUnwrapped()),_.expandedProjMatrix=g?this.transform.calculateProjMatrix(_.toUnwrapped(),!1,!0):_.projMatrix;return h}sortCoordinatesByDistance(t){let o=t.slice(),h=this.transform._camera.position,g=this.transform._camera.forward(),_={};for(let v of o){let E=1/(1<<v.canonical.z);_[v.key]=((v.canonical.x+.5)*E+v.wrap-h[0])*g[0]+((v.canonical.y+.5)*E-h[1])*g[1]-h[2]*g[2]}return o.sort((v,E)=>_[v.key]-_[E.key]),o}hasTransition(){if(this._source.hasTransition())return!0;if(yu(this._source.type))for(let t in this._tiles){let o=this._tiles[t];if(o.fadeEndTime!==void 0&&o.fadeEndTime>=r.q.now())return!0}return!1}setFeatureState(t,o,h){this._state.updateState(t=t||"_geojsonTileLayer",o,h)}removeFeatureState(t,o,h){this._state.removeFeatureState(t=t||"_geojsonTileLayer",o,h)}getFeatureState(t,o){return this._state.getState(t=t||"_geojsonTileLayer",o)}setDependencies(t,o,h){let g=this._tiles[t];g&&g.setDependencies(o,h)}reloadTilesForDependencies(t,o){for(let h in this._tiles)this._tiles[h].hasDependency(t,o)&&this._reloadTile(+h,"reloading");this._cache.filter(h=>!h.hasDependency(t,o))}_preloadTiles(t,o){if(!this._sourceLoaded){let T=()=>{this._sourceLoaded&&(this._source.off("data",T),this._preloadTiles(t,o))};return void this._source.on("data",T)}let h=new Map,g=Array.isArray(t)?t:[t],_=this.map.painter.terrain,v=this.usedForTerrain&&_?_.getScaledDemTileSize():this._source.tileSize;for(let T of g){let C=T.coveringTiles({tileSize:v,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let A of C)h.set(A.key,A);this.usedForTerrain&&T.updateElevation(!1)}let E=Array.from(h.values());r.bt(E,(T,C)=>{let A=new Qa(T,this._source.tileSize*T.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(A,L=>{this._source.type==="raster-dem"&&A.dem&&this._backfillDEM(A),C(L,A)})},o)}}function el(u,t){let o=Math.abs(2*u.wrap)-+(u.wrap<0),h=Math.abs(2*t.wrap)-+(t.wrap<0);return u.overscaledZ-t.overscaledZ||h-o||t.canonical.y-u.canonical.y||t.canonical.x-u.canonical.x}function yu(u){return u==="raster"||u==="image"||u==="video"||u==="custom"}function Gl(u,t){let o=1<<u.z;return[u.x/o+t,(u.x+1)/o+t]}eo.maxOverzooming=10,eo.maxUnderzooming=3;class k_{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let t=!1,o=!1;for(let h in this.style._mergedLayers){let g=this.style._mergedLayers[h];if(g.type==="fill-extrusion"||g.type==="building")this.layers.push({layer:g,visible:t,visibilityChanged:o});else if(g.type==="model"){let _=this.style.getLayerSource(g);_&&_.type==="batched-model"&&this.layers.push({layer:g,visible:t,visibilityChanged:o})}}}onNewFrame(t){this.layersGotHidden=!1;for(let o of this.layers){let h=o.layer,g=!1;h.type==="fill-extrusion"?g=!h.isHidden(t)&&h.paint.get("fill-extrusion-opacity")>0:h.type==="building"?g=!h.isHidden(t)&&h.paint.get("building-opacity")>0:h.type==="model"&&(g=!h.isHidden(t)&&h.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!g&&o.visible,o.visible=g}}updateZOffset(t,o){this.currentBuildingBuckets=[];for(let g of this.layers){let _=g.layer,v=this.style.getLayerSourceCache(_),E=1;_.type==="fill-extrusion"?E=g.visible?_.paint.get("fill-extrusion-vertical-scale"):0:_.type==="building"&&(E=g.visible?_.paint.get("building-vertical-scale"):0);let T=v?v.getTile(o):null;if(!T&&v)for(let C in v._tiles){let A=v._tiles[C];if(o.canonical.isChildOf(A.tileID.canonical)){T=A;break}}this.currentBuildingBuckets.push({bucket:T?T.getBucket(_):null,tileID:T?T.tileID:o,verticalScale:E})}t.hasAnyZOffset=!1;let h=!1;for(let g=0;g<t.symbolInstances.length;g++){let _=t.symbolInstances.get(g),v=_.zOffset,E=this._getHeightAtTileOffset(o,_.tileAnchorX,_.tileAnchorY);_.zOffset=E!==Number.NEGATIVE_INFINITY?E:v,h||v===_.zOffset||(h=!0),t.hasAnyZOffset||_.zOffset===0||(t.hasAnyZOffset=!0)}h&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,o,h,g){let _=o,v=h;if(t.canonical.z!==g.canonical.z){let E=g.canonical,T=1/(1<<t.canonical.z-E.z);_=(o+t.canonical.x*r.aj)*T-E.x*r.aj|0,v=(h+t.canonical.y*r.aj)*T-E.y*r.aj|0}return{tileX:_,tileY:v}}_getHeightAtTileOffset(t,o,h){let g,_;for(let v=0;v<this.layers.length;++v){let E=this.layers[v].layer;if(E.type!=="fill-extrusion"&&E.type!=="building")continue;let{bucket:T,tileID:C,verticalScale:A}=this.currentBuildingBuckets[v];if(!T)continue;let{tileX:L,tileY:R}=this._mapCoordToOverlappingTile(t,o,h,C),k=T.getHeightAtTileCoord(L,R);k&&k.height!==void 0&&(k.hidden?g=k.height:_=Math.max(k.height*A,_||0))}if(_!==void 0)return _;for(let v=0;v<this.layers.length;++v){let E=this.layers[v];if(E.layer.type!=="model"||!E.visible)continue;let{bucket:T,tileID:C}=this.currentBuildingBuckets[v];if(!T)continue;let{tileX:A,tileY:L}=this._mapCoordToOverlappingTile(t,o,h,C),R=T.getHeightAtTileCoord(A,L);if(R&&!R.hidden)return R.height===void 0&&g!==void 0?Math.min(R.maxHeight,g)*R.verticalScale:R.height?R.height*R.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function F_(u,t){let o={};for(let h in u)h!=="ref"&&(o[h]=u[h]);return r.bu.forEach(h=>{h in t&&(o[h]=t[h])}),o}function vu(u){u=u.slice();let t=Object.create(null);for(let o=0;o<u.length;o++)t[u[o].id]=u[o];for(let o=0;o<u.length;o++)"ref"in u[o]&&(u[o]=F_(u[o],t[u[o].ref]));return u}let xn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Jd(u,t,o){o.push({command:xn.addSource,args:[u,t[u]]})}function ql(u,t,o){t.push({command:xn.removeSource,args:[u]}),o[u]=!0}function xu(u,t,o,h){ql(u,o,h),Jd(u,t,o)}function db(u,t,o){let h;for(h in u[o])if(u[o].hasOwnProperty(h)&&h!=="data"&&!r.bv(u[o][h],t[o][h]))return!1;for(h in t[o])if(t[o].hasOwnProperty(h)&&h!=="data"&&!r.bv(u[o][h],t[o][h]))return!1;return!0}function bu(u,t,o,h,g,_){let v;for(v in t=t||{},u=u||{})u.hasOwnProperty(v)&&(r.bv(u[v],t[v])||o.push({command:_,args:[h,v,t[v],g]}));for(v in t)t.hasOwnProperty(v)&&!u.hasOwnProperty(v)&&(r.bv(u[v],t[v])||o.push({command:_,args:[h,v,t[v],g]}))}function tl(u){return u.id}function ma(u,t){return u[t.id]=t,u}function wu(u,t,o){let h=t.createTileMatrix(u,u.worldSize,o.toUnwrapped());return r.az(new Float32Array(16),u.projMatrix,h)}function N_(u,t,o){if(t.projection.name===o.projection.name)return u.projMatrix;let h=o.clone();return h.setProjection(t.projection),wu(h,t.getProjection(),u)}function Qd(u,t,o){return t.name===o.projection.name?u.projMatrix:wu(o,t,u)}class z_{constructor(t,o){this.reset(t,o)}reset(t,o){this.points=t||[],this._distances=[0];for(let h=1;h<this.points.length;h++)this._distances[h]=this._distances[h-1]+this.points[h].dist(this.points[h-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(o||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=r.ay(t,0,1);let o=1,h=this._distances[o],g=t*this.paddedLength+this.padding;for(;h<g&&o<this._distances.length;)h=this._distances[++o];let _=o-1,v=this._distances[_],E=h-v,T=E>0?(g-v)/E:0;return this.points[_].mult(1-T).add(this.points[o].mult(T))}}class Wl{constructor(t,o,h){let g=this.boxCells=[],_=this.circleCells=[];this.xCellCount=Math.ceil(t/h),this.yCellCount=Math.ceil(o/h);for(let v=0;v<this.xCellCount*this.yCellCount;v++)g.push([]),_.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=o,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/o,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,o,h,g,_){this._forEachCell(o,h,g,_,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(o),this.bboxes.push(h),this.bboxes.push(g),this.bboxes.push(_)}insertCircle(t,o,h,g){this._forEachCell(o-g,h-g,o+g,h+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(o),this.circles.push(h),this.circles.push(g)}_insertBoxCell(t,o,h,g,_,v){this.boxCells[_].push(v)}_insertCircleCell(t,o,h,g,_,v){this.circleCells[_].push(v)}_query(t,o,h,g,_,v){if(h<0||t>this.width||g<0||o>this.height)return!_&&[];let E=[];if(t<=0&&o<=0&&this.width<=h&&this.height<=g){if(_)return!0;for(let T=0;T<this.boxKeys.length;T++)E.push({key:this.boxKeys[T],x1:this.bboxes[4*T],y1:this.bboxes[4*T+1],x2:this.bboxes[4*T+2],y2:this.bboxes[4*T+3]});for(let T=0;T<this.circleKeys.length;T++){let C=this.circles[3*T],A=this.circles[3*T+1],L=this.circles[3*T+2];E.push({key:this.circleKeys[T],x1:C-L,y1:A-L,x2:C+L,y2:A+L})}return v?E.filter(v):E}return this._forEachCell(t,o,h,g,this._queryCell,E,{hitTest:_,seenUids:{box:{},circle:{}}},v),_?E.length>0:E}_queryCircle(t,o,h,g,_){let v=t-h,E=t+h,T=o-h,C=o+h;if(E<0||v>this.width||C<0||T>this.height)return!g&&[];let A=[];return this._forEachCell(v,T,E,C,this._queryCellCircle,A,{hitTest:g,circle:{x:t,y:o,radius:h},seenUids:{box:{},circle:{}}},_),g?A.length>0:A}query(t,o,h,g,_){return this._query(t,o,h,g,!1,_)}hitTest(t,o,h,g,_){return this._query(t,o,h,g,!0,_)}hitTestCircle(t,o,h,g){return this._queryCircle(t,o,h,!0,g)}_queryCell(t,o,h,g,_,v,E,T){let C=E.seenUids,A=this.boxCells[_];if(A!==null){let R=this.bboxes;for(let k of A)if(!C.box[k]){C.box[k]=!0;let V=4*k;if(t<=R[V+2]&&o<=R[V+3]&&h>=R[V+0]&&g>=R[V+1]&&(!T||T(this.boxKeys[k]))){if(E.hitTest)return v.push(!0),!0;v.push({key:this.boxKeys[k],x1:R[V],y1:R[V+1],x2:R[V+2],y2:R[V+3]})}}}let L=this.circleCells[_];if(L!==null){let R=this.circles;for(let k of L)if(!C.circle[k]){C.circle[k]=!0;let V=3*k;if(this._circleAndRectCollide(R[V],R[V+1],R[V+2],t,o,h,g)&&(!T||T(this.circleKeys[k]))){if(E.hitTest)return v.push(!0),!0;{let z=R[V],U=R[V+1],j=R[V+2];v.push({key:this.circleKeys[k],x1:z-j,y1:U-j,x2:z+j,y2:U+j})}}}}}_queryCellCircle(t,o,h,g,_,v,E,T){let C=E.circle,A=E.seenUids,L=this.boxCells[_];if(L!==null){let k=this.bboxes;for(let V of L)if(!A.box[V]){A.box[V]=!0;let z=4*V;if(this._circleAndRectCollide(C.x,C.y,C.radius,k[z+0],k[z+1],k[z+2],k[z+3])&&(!T||T(this.boxKeys[V])))return v.push(!0),!0}}let R=this.circleCells[_];if(R!==null){let k=this.circles;for(let V of R)if(!A.circle[V]){A.circle[V]=!0;let z=3*V;if(this._circlesCollide(k[z],k[z+1],k[z+2],C.x,C.y,C.radius)&&(!T||T(this.circleKeys[V])))return v.push(!0),!0}}}_forEachCell(t,o,h,g,_,v,E,T){let C=this._convertToXCellCoord(t),A=this._convertToYCellCoord(o),L=this._convertToXCellCoord(h),R=this._convertToYCellCoord(g);for(let k=C;k<=L;k++)for(let V=A;V<=R;V++)if(_.call(this,t,o,h,g,this.xCellCount*V+k,v,E,T))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,o,h,g,_,v){let E=g-t,T=_-o,C=h+v;return C*C>E*E+T*T}_circleAndRectCollide(t,o,h,g,_,v,E){let T=(v-g)/2,C=Math.abs(t-(g+T));if(C>T+h)return!1;let A=(E-_)/2,L=Math.abs(o-(_+A));if(L>A+h)return!1;if(C<=T||L<=A)return!0;let R=C-T,k=L-A;return R*R+k*k<=h*h}}let nl={unknown:0,flipRequired:1,flipNotRequired:2},B_=Math.tan(85*Math.PI/180);function Eu(u,t,o,h,g,_,v){let E=r.bz();if(o)if(_.name==="globe"){let T=r.bA(g,t);r.az(E,E,T)}else{let T=r.bB([],v);E[0]=T[0],E[1]=T[1],E[4]=T[2],E[5]=T[3],h||r.by(E,E,g.angle)}else r.az(E,g.labelPlaneMatrix,u);return E}function Zl(u,t,o,h,g,_,v){let E=Eu(u,t,o,h,g,_,v);return _.name==="globe"&&o||(E[2]=E[6]=E[10]=E[14]=0),E}function js(u,t,o,h,g,_,v){if(o){if(_.name==="globe"){let E=Eu(u,t,o,h,g,_,v);return r.bi(E,E),r.az(E,u,E),E}{let E=r.bw(u),T=r.bx([]);return T[0]=v[0],T[1]=v[1],T[4]=v[2],T[5]=v[3],r.az(E,E,T),h||r.by(E,E,-g.angle),E}}return g.glCoordMatrix}function So(u,t,o,h){let g=[u,t,o,1];o?r.aA(g,g,h):V_(g,g,h);let _=g[3];return g[0]/=_,g[1]/=_,g[2]/=_,g}function _p(u,t){return Math.min(.5+u/t*.5,1.5)}function yp(u,t){let o=u[0]/u[3],h=u[1]/u[3];return o>=-t[0]&&o<=t[0]&&h>=-t[1]&&h<=t[1]}function il(u,t,o,h,g,_,v,E,T,C){let A=o.transform,L=h?u.textSizeData:u.iconSizeData,R=r.bH(L,o.transform.zoom),k=A.projection.name==="globe",V=[256/o.width*2+1,256/o.height*2+1],z=h?u.text.dynamicLayoutVertexArray:u.icon.dynamicLayoutVertexArray;z.clear();let U=null;k&&(U=h?u.text.globeExtVertexArray:u.icon.globeExtVertexArray);let j=u.lineVertexArray,W=h?u.text.placedSymbolArray:u.icon.placedSymbolArray,Y=o.transform.width/o.transform.height,J,ie=!1;for(let le=0;le<W.length;le++){let ue=W.get(le),{numGlyphs:re,writingMode:oe}=ue;if(oe!==r.bI.vertical||ie||J===r.bI.horizontal||(ie=!0),J=oe,(ue.hidden||oe===r.bI.vertical)&&!ie){Xl(re,z);continue}ie=!1;let se=new r.P(ue.tileAnchorX,ue.tileAnchorY),{x:Ee,y:me,z:Ne}=A.projection.projectTilePoint(se.x,se.y,C.canonical);if(T){let[xt,St,dt]=T(se);Ee+=xt,me+=St,Ne+=dt}let Ce=[Ee,me,Ne,1];if(r.aA(Ce,Ce,t),!yp(Ce,V)){Xl(re,z);continue}let Be=Ce[3],Qe=_p(o.transform.getCameraToCenterDistance(A.projection),Be),Te=r.bJ(L,R,ue),pe=v?Te/Qe:Te*Qe,Pe=So(Ee,me,Ne,g);if(Pe[3]<=0){Xl(re,z);continue}let Ie={},He=r.al(u.layers[0].layout.get("text-max-angle")),$e=Math.cos(He),qe=v?null:T,ot=eh(ue,pe,!1,E,t,g,_,u.glyphOffsetArray,j,z,U,Pe,se,Ie,Y,qe,A.projection,C,v,$e);ie=ot.useVertical,qe&&ot.needsFlipping&&(Ie={}),(ot.notEnoughRoom||ie||ot.needsFlipping&&eh(ue,pe,!0,E,t,g,_,u.glyphOffsetArray,j,z,U,Pe,se,Ie,Y,qe,A.projection,C,v,$e).notEnoughRoom)&&Xl(re,z)}h?(u.text.dynamicLayoutVertexBuffer.updateData(z),U&&u.text.globeExtVertexBuffer&&u.text.globeExtVertexBuffer.updateData(U)):(u.icon.dynamicLayoutVertexBuffer.updateData(z),U&&u.icon.globeExtVertexBuffer&&u.icon.globeExtVertexBuffer.updateData(U))}function uo(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U){let{lineStartIndex:j,glyphStartIndex:W,segment:Y}=E,J=W+E.numGlyphs,ie=j+E.lineLength,le=t.getoffsetX(W),ue=t.getoffsetX(J-1),re=Tu(u*le,o,h,g,_,v,Y,j,ie,T,C,A,L,R,!0,k,V,z,U);if(!re)return null;let oe=Tu(u*ue,o,h,g,_,v,Y,j,ie,T,C,A,L,R,!0,k,V,z,U);return oe?{first:re,last:oe}:null}function vp(u,t,o,h){return u===r.bI.horizontal&&Math.abs(h)>Math.abs(o)?{useVertical:!0}:u===r.bI.vertical?h>0?{needsFlipping:!0}:null:t!==nl.unknown&&function(g,_){return g===0||Math.abs(_/g)>B_}(o,h)?t===nl.flipRequired?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function eh(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j,W,Y){let J=t/24,ie=u.lineOffsetX*J,le=u.lineOffsetY*J,{lineStartIndex:ue,glyphStartIndex:re,numGlyphs:oe,segment:se,writingMode:Ee,flipState:me}=u,Ne=ue+u.lineLength,Ce=Be=>{if(A){let[Pe,Ie,He]=Be.up,$e=C.length;r.bK(A,$e+0,Pe,Ie,He),r.bK(A,$e+1,Pe,Ie,He),r.bK(A,$e+2,Pe,Ie,He),r.bK(A,$e+3,Pe,Ie,He)}let[Qe,Te,pe]=Be.point;r.bL(C,Qe,Te,pe,Be.angle)};if(oe>1){let Be=uo(J,E,ie,le,o,L,R,u,T,_,k,z,!1,U,j,W,Y);if(!Be)return{notEnoughRoom:!0};if(h&&!o){let[Qe,Te,pe]=Be.first.point,[Pe,Ie,He]=Be.last.point;[Qe,Te]=So(Qe,Te,pe,v),[Pe,Ie]=So(Pe,Ie,He,v);let $e=vp(Ee,me,(Pe-Qe)*V,Ie-Te);if(u.flipState=$e&&$e.needsFlipping?nl.flipRequired:nl.flipNotRequired,$e)return $e}Ce(Be.first);for(let Qe=re+1;Qe<re+oe-1;Qe++){let Te=Tu(J*E.getoffsetX(Qe),ie,le,o,L,R,se,ue,Ne,T,_,k,z,!1,!1,U,j,W,Y);if(!Te)return C.length-=4*(Qe-re),{notEnoughRoom:!0};Ce(Te)}Ce(Be.last)}else{if(h&&!o){let Qe=So(R.x,R.y,0,g),Te=ue+se+1,pe=new r.P(T.getx(Te),T.gety(Te)),Pe=So(pe.x,pe.y,0,g),Ie=Pe[3]>0?Pe:Ln(R,pe,Qe,1,g,void 0,U,j.canonical),He=vp(Ee,me,(Ie[0]-Qe[0])*V,Ie[1]-Qe[1]);if(u.flipState=He&&He.needsFlipping?nl.flipRequired:nl.flipNotRequired,He)return He}let Be=Tu(J*E.getoffsetX(re),ie,le,o,L,R,se,ue,Ne,T,_,k,z,!1,!1,U,j,W,Y);if(!Be)return{notEnoughRoom:!0};Ce(Be)}return{}}function xp(u,t,o,h,g){let{x:_,y:v,z:E}=h.projectTilePoint(u.x,u.y,t);if(!g)return So(_,v,E,o);let[T,C,A]=g(u);return So(_+T,v+C,E+A,o)}function Ln(u,t,o,h,g,_,v,E){let T=xp(u.sub(t)._unit()._add(u),E,g,v,_);return r.at(T,o,T),r.au(T,T),r.bE(T,o,T,h)}function Tu(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j,W){let Y=h?u-t:u+t,J=Y>0?1:-1,ie=0;h&&(J*=-1,ie=Math.PI),J<0&&(ie+=Math.PI);let le=E+v+(J>0?0:1)|0,ue=g,re=g,oe=0,se=0,Ee=Math.abs(Y),me=[],Ne=[],Ce=_,Be=Ce,Qe=r.bC([]),Te=()=>Ln(Be,Ce,re,Ee-oe+1,A,R,z,U.canonical);for(;oe+se<=Ee;){if(le+=J,le<E||le>=T)return null;if(re=ue,Be=Ce,me.push(re),k&&Ne.push(Be),Ce=new r.P(C.getx(le),C.gety(le)),ue=L[le],!ue){let dt=xp(Ce,U.canonical,A,z,R);ue=dt[3]>0?L[le]=dt:Te()}oe+=se;let xt=r.at([],ue,re),St=r.bD(re,ue);if(o&&St>0&&se>0&&r.bG(Qe,xt)/(se*St)<W)return null;se=St,Qe=xt}V&&R&&(L[le]&&(ue=Te(),se=r.bD(re,ue),Qe=r.at([],ue,re)),L[le]=ue);let pe=(Ee-oe)/se,Pe=Ce.sub(Be)._mult(pe)._add(Be),Ie=r.bE([],re,Qe,pe),He=[0,0,1],$e=Qe[0],qe=Qe[1];if(j&&(He=z.upVector(U.canonical,Pe.x,Pe.y),He[0]!==0||He[1]!==0||He[2]!==1)){let xt=[He[2],0,-He[0]],St=r.bF([],He,xt);r.au(xt,xt),r.au(St,St),$e=r.bG(Qe,xt),qe=r.bG(Qe,St)}if(o){let xt=r.bF([],He,Qe);r.au(xt,xt),r.bE(Ie,Ie,xt,o*J)}let ot=ie+Math.atan2(qe,$e);return me.push(Ie),k&&Ne.push(Pe),{point:Ie,angle:ot,path:me,tilePath:Ne,up:He}}function Xl(u,t){let o=t.length,h=o+4*u;t.resize(h),t.float32.fill(-1/0,4*o,4*h)}function V_(u,t,o){let h=t[0],g=t[1];return u[0]=o[0]*h+o[4]*g+o[12],u[1]=o[1]*h+o[5]*g+o[13],u[3]=o[3]*h+o[7]*g+o[15],u}let Ct=100;class j_{constructor(t,o,h=new Wl(t.width+200,t.height+200,25),g=new Wl(t.width+200,t.height+200,25)){this.transform=t,this.grid=h,this.ignoredGrid=g,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Ct,this.screenBottomBoundary=t.height+Ct,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=o}placeCollisionBox(t,o,h,g,_,v,E,T,C,A,L){let R=h.projectedAnchorX,k=h.projectedAnchorY,V=h.projectedAnchorZ,z=h.tileAnchorX,U=h.tileAnchorY,j=h.elevation,W=h.tileID,Y=t.getProjection();if(j&&W){let[Ne,Ce,Be]=Y.upVector(W.canonical,h.tileAnchorX,h.tileAnchorY),Qe=Y.upVectorScale(W.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;R+=Ne*j*Qe,k+=Ce*j*Qe,V+=Be*j*Qe}let J=t.projection.name==="globe",ie=t.projection.name==="globe"?r.ah(this.transform.zoom):0;if(W&&J&&ie<1&&!v){let Ne=1<<W.canonical.z,Ce=r.bM(z,U);r.bN(Ce,Ce,1/r.aj),r.bO(Ce,Ce,r.bM(W.canonical.x,W.canonical.y)),r.bN(Ce,Ce,1/Ne),r.bP(Ce,Ce,r.bM(g[0],g[1])),Ce[0]=r.bQ(Ce[0],-.5,.5),r.bN(Ce,Ce,r.aj);let Be=r.bR(Ce[0],Ce[1],r.aj/(2*Math.PI),1);r.aA(Be,Be,_),R=r.ai(R,Be[0],ie),k=r.ai(k,Be[1],ie),V=r.ai(V,Be[2],ie)}let le=this.projectAndGetPerspectiveRatio(A,R,k,V,h.tileID,Y.name==="globe"||!!j||this.transform.pitch>0,Y),ue=C*le.perspectiveRatio,re=(h.x1*o+E.x-h.padding)*ue+le.point.x,oe=(h.y1*o+E.y-h.padding)*ue+le.point.y,se=(h.x2*o+E.x+h.padding)*ue+le.point.x,Ee=(h.y2*o+E.y+h.padding)*ue+le.point.y,me=le.perspectiveRatio<=.55||le.occluded;return!this.isInsideGrid(re,oe,se,Ee)||!T&&this.grid.hitTest(re,oe,se,Ee,L)||me?{box:[],offscreen:!1,occluded:le.occluded}:{box:[re,oe,se,Ee],offscreen:this.isOffscreen(re,oe,se,Ee),occluded:!1}}placeCollisionCircles(t,o,h,g,_,v,E,T,C,A,L,R,k,V,z){let U=[],j=this.transform.elevation,W=t.getProjection(),Y=j?j.getAtTileOffsetFunc(z,this.transform.center.lat,this.transform.worldSize,W):null,J=new r.P(h.tileAnchorX,h.tileAnchorY),{x:ie,y:le,z:ue}=W.projectTilePoint(J.x,J.y,z.canonical);if(Y){let[He,$e,qe]=Y(J);ie+=He,le+=$e,ue+=qe}let re=W.name==="globe",oe=this.projectAndGetPerspectiveRatio(E,ie,le,ue,z,re||!!j||this.transform.pitch>0,W),{perspectiveRatio:se}=oe,Ee=(L?v/se:v*se)/r.bU,me=So(ie,le,ue,T),Ne=h.lineOffsetX*Ee,Ce=h.lineOffsetY*Ee,Be=r.al(t.layers[0].layout.get("text-max-angle")),Qe=Math.cos(Be),Te=oe.signedDistanceFromCamera>0?uo(Ee,_,Ne,Ce,!1,me,J,h,g,T,{},j&&!L?Y:null,L&&!!j,W,z,L,Qe):null,pe=!1,Pe=!1,Ie=!0;if(Te&&!oe.occluded){let He=.5*k*se+V,$e=new r.P(-100,-100),qe=new r.P(this.screenRightBoundary,this.screenBottomBoundary),ot=new z_,{first:xt,last:St}=Te,dt=xt.path.length,Tt=[];for(let qt=dt-1;qt>=1;qt--)Tt.push(xt.path[qt]);for(let qt=1;qt<St.path.length;qt++)Tt.push(St.path[qt]);let wt=2.5*He;C&&(Tt=Tt.map(([qt,on,bn],Ht)=>(Y&&!re&&(bn=Y(Ht<dt-1?xt.tilePath[dt-1-Ht]:St.tilePath[Ht-dt+2])[2]),So(qt,on,bn,C))),Tt.some(qt=>qt[3]<=0)&&(Tt=[]));let zt=[];if(Tt.length>0){let qt=1/0,on=-1/0,bn=1/0,Ht=-1/0;for(let wn of Tt)qt=Math.min(qt,wn[0]),bn=Math.min(bn,wn[1]),on=Math.max(on,wn[0]),Ht=Math.max(Ht,wn[1]);on>=$e.x&&qt<=qe.x&&Ht>=$e.y&&bn<=qe.y&&(zt=[Tt.map(wn=>new r.P(wn[0],wn[1]))],(qt<$e.x||on>qe.x||bn<$e.y||Ht>qe.y)&&(zt=r.bS(zt,$e.x,$e.y,qe.x,qe.y)))}for(let qt of zt){ot.reset(qt,.25*He);let on=0;on=ot.length<=.5*He?1:Math.ceil(ot.paddedLength/wt)+1;for(let bn=0;bn<on;bn++){let Ht=bn/Math.max(on-1,1),wn=ot.lerp(Ht),Dn=wn.x+Ct,Xn=wn.y+Ct;U.push(Dn,Xn,He,0);let tn=Dn-He,En=Xn-He,Tn=Dn+He,Mn=Xn+He;if(Ie=Ie&&this.isOffscreen(tn,En,Tn,Mn),Pe=Pe||this.isInsideGrid(tn,En,Tn,Mn),!o&&this.grid.hitTestCircle(Dn,Xn,He,R)&&(pe=!0,!A))return{circles:[],offscreen:!1,collisionDetected:pe,occluded:!1}}}}return{circles:!A&&pe||!Pe?[]:U,offscreen:Ie,collisionDetected:pe,occluded:oe.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let o=[],h=1/0,g=1/0,_=-1/0,v=-1/0;for(let A of t){let L=new r.P(A.x+Ct,A.y+Ct);h=Math.min(h,L.x),g=Math.min(g,L.y),_=Math.max(_,L.x),v=Math.max(v,L.y),o.push(L)}let E=this.grid.query(h,g,_,v).concat(this.ignoredGrid.query(h,g,_,v)),T={},C={};for(let A of E){let L=A.key;if(T[L.bucketInstanceId]===void 0&&(T[L.bucketInstanceId]={}),T[L.bucketInstanceId][L.featureIndex])continue;let R=[new r.P(A.x1,A.y1),new r.P(A.x2,A.y1),new r.P(A.x2,A.y2),new r.P(A.x1,A.y2)];r.bT(o,R)&&(T[L.bucketInstanceId][L.featureIndex]=!0,C[L.bucketInstanceId]===void 0&&(C[L.bucketInstanceId]=[]),C[L.bucketInstanceId].push(L.featureIndex))}return C}insertCollisionBox(t,o,h,g,_){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:h,featureIndex:g,collisionGroupID:_},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,o,h,g,_){let v=o?this.ignoredGrid:this.grid,E={bucketInstanceId:h,featureIndex:g,collisionGroupID:_};for(let T=0;T<t.length;T+=4)v.insertCircle(E,t[T],t[T+1],t[T+2])}projectAndGetPerspectiveRatio(t,o,h,g,_,v,E){let T=[o,h,g,1],C=!1;g||this.transform.pitch>0?(r.aA(T,T,t),this.fogState&&_&&E.name!=="globe"&&(C=function(R,k,V,z,U,j){let W=j.calculateFogTileMatrix(U),Y=[k,V,z];return r.ad(Y,Y,W),Dt(R,r.ae(Y),j.pitch,j._fov)}(this.fogState,o,h,g,_.toUnwrapped(),this.transform)>.9)):V_(T,T,t);let A=T[3];return{point:new r.P((T[0]/A+1)/2*this.transform.width+Ct,(-T[1]/A+1)/2*this.transform.height+Ct),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(E)/A*.5,1.5),signedDistanceFromCamera:A,occluded:v&&T[2]>A||C}}isOffscreen(t,o,h,g){return h<Ct||t>=this.screenRightBoundary||g<Ct||o>this.screenBottomBoundary}isInsideGrid(t,o,h,g){return h>=0&&t<this.gridRightBoundary&&g>=0&&o<this.gridBottomBoundary}getViewportMatrix(){let t=r.bx([]);return r.bo(t,t,[-100,-100,0]),t}}class Iu{constructor(t,o,h,g){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?o:-o))):g&&h?1:0,this.placed=h}isHidden(){return this.opacity===0&&!this.placed}}class rl{constructor(t,o,h,g,_,v=!1){this.text=new Iu(t?t.text:null,o,h,_),this.icon=new Iu(t?t.icon:null,o,g,_),this.clipped=v}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Do{constructor(t,o,h,g=!1){this.text=t,this.icon=o,this.skipFade=h,this.clipped=g}}class bp{constructor(){this.invProjMatrix=r.bz(),this.viewportMatrix=r.bz(),this.circles=[]}}class Yl{constructor(t,o,h,g,_){this.bucketInstanceId=t,this.featureIndex=o,this.sourceLayerIndex=h,this.bucketIndex=g,this.tileID=_}}class It{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){let o=++this.maxGroupID;this.collisionGroups[t]={ID:o,predicate:h=>h.collisionGroupID===o}}return this.collisionGroups[t]}}function Pn(u,t,o,h,g){let{horizontalAlign:_,verticalAlign:v}=r.bZ(u),E=-(_-.5)*t,T=-(v-.5)*o,C=r.b_(u,h);return new r.P(E+C[0]*g,T+C[1]*g)}function On(u,t,o,h,g){let _=new r.P(u,t);return o&&_._rotate(h?g:-g),_}class ho{constructor(t,o,h,g,_,v){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new j_(this.transform,_),this.buildingIndex=v,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new It(h),this.collisionCircleArrays={},this.prevPlacement=g,g&&(g.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,o,h,g,_=1){let v=h.getBucket(o),E=h.latestFeatureIndex;if(!v||!E||o.fqid!==v.layerIds[0])return;let T=v.layers[0].layout,C=v.layers[0].paint,A=h.collisionBoxArray,L=Math.pow(2,this.transform.zoom-h.tileID.overscaledZ),R=h.tileSize/r.aj,k=h.tileID.toUnwrapped();this.transform.setProjection(v.projection);let V=(z=h.tileID,U=v.getProjection(),j=this.transform,U.name===this.projection?j.calculateProjMatrix(z.toUnwrapped()):wu(j,U,z));var z,U,j;let W=T.get("text-pitch-alignment")==="map",Y=T.get("text-rotation-alignment")==="map";o.compileFilter(o.options);let J=o.dynamicFilter(),ie=o.dynamicFilterNeedsFeature(),le=this.transform.calculatePixelsToTileUnitsMatrix(h),ue=Zl(V,h.tileID.canonical,W,Y,this.transform,v.getProjection(),le),re=null,oe=v.getProjection().createInversionMatrix(this.transform,h.tileID.canonical);if(W){let pe=js(V,h.tileID.canonical,W,Y,this.transform,v.getProjection(),le);re=r.az([],this.transform.labelPlaneMatrix,pe)}let se=null;J&&h.latestFeatureIndex&&(se={unwrappedTileID:k,dynamicFilter:J,dynamicFilterNeedsFeature:ie}),this.retainedQueryData[v.bucketInstanceId]=new Yl(v.bucketInstanceId,E,v.sourceLayerIndex,v.index,h.tileID);let[Ee,me]=v.layers[0].layout.get("text-size-scale-range"),Ne=r.ay(_,Ee,me),[Ce,Be]=T.get("icon-size-scale-range"),Qe=r.ay(_,Ce,Be),Te={bucket:v,layout:T,paint:C,posMatrix:V,invMatrix:oe,mercatorCenter:[r.aD(this.transform.center.lng),r.aH(this.transform.center.lat)],textLabelPlaneMatrix:ue,labelToScreenMatrix:re,clippingData:se,scale:L,textPixelRatio:R,holdingForFade:h.holdingForFade(),collisionBoxArray:A,partiallyEvaluatedTextSize:r.bH(v.textSizeData,this.transform.zoom,Ne),partiallyEvaluatedIconSize:r.bH(v.iconSizeData,this.transform.zoom,Qe),collisionGroup:this.collisionGroups.get(v.sourceID),latestFeatureIndex:h.latestFeatureIndex};if(g)for(let pe of v.sortKeyRanges){let{sortKey:Pe,symbolInstanceStart:Ie,symbolInstanceEnd:He}=pe;t.push({sortKey:Pe,symbolInstanceStart:Ie,symbolInstanceEnd:He,parameters:Te})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:v.symbolInstances.length,parameters:Te})}attemptAnchorPlacement(t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j,W,Y,J,ie){let{textOffset0:le,textOffset1:ue,crossTileID:re}=z,oe=[le,ue],se=Pn(t,v,E,oe,T),Ee=this.collisionIndex.placeCollisionBox(j,T,o,h,g,_,On(se.x,se.y,C,A,this.transform.angle),V,L,R,k.predicate);if(Y){let me=j.getSymbolInstanceIconSize(ie,this.transform.zoom,z.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(j,me,Y,h,g,_,On(se.x,se.y,C,A,this.transform.angle),V,L,R,k.predicate).box.length===0)return}if(Ee.box.length>0){let me;return this.prevPlacement&&this.prevPlacement.variableOffsets[re]&&this.prevPlacement.placements[re]&&this.prevPlacement.placements[re].text&&(me=this.prevPlacement.variableOffsets[re].anchor),this.variableOffsets[re]={textOffset:oe,width:v,height:E,anchor:t,textScale:T,prevAnchor:me},this.markUsedJustification(j,t,z,W),j.allowVerticalPlacement&&(this.markUsedOrientation(j,W,z),this.placedOrientations[re]=W),{shift:se,placedGlyphBoxes:Ee}}}placeLayerBucketPart(t,o,h,g,_=1){let{bucket:v,layout:E,paint:T,posMatrix:C,textLabelPlaneMatrix:A,labelToScreenMatrix:L,clippingData:R,textPixelRatio:k,mercatorCenter:V,invMatrix:z,holdingForFade:U,collisionBoxArray:j,partiallyEvaluatedTextSize:W,partiallyEvaluatedIconSize:Y,collisionGroup:J,latestFeatureIndex:ie}=t.parameters,le=E.get("text-optional"),ue=E.get("icon-optional"),re=E.get("text-allow-overlap"),oe=E.get("icon-allow-overlap"),se=E.get("text-rotation-alignment")==="map",Ee=E.get("icon-rotation-alignment")==="map",me=E.get("text-pitch-alignment")==="map",Ne=T.get("symbol-z-offset"),Ce=E.get("symbol-elevation-reference")==="sea",Be=E.get("symbol-placement"),[Qe,Te]=E.get("text-size-scale-range"),[pe,Pe]=E.get("icon-size-scale-range"),Ie=r.ay(_,Qe,Te),He=r.ay(_,pe,Pe),$e=E.get("text-variable-anchor"),qe=se&&Be!=="point",ot=Ee&&Be!=="point",xt=$e&&v.hasTextData(),St=v.hasIconTextFit()&&xt&&v.hasIconData();this.transform.setProjection(v.projection);let dt=xt||qe,Tt=ot||St,wt=re&&(oe||!v.hasIconData()||ue),zt=oe&&(re||!v.hasTextData()||le),qt=!Ne.isConstant();!v.collisionArrays&&j&&v.deserializeCollisionBoxes(j),h&&g&&v.updateCollisionDebugBuffers(this.transform.zoom,j,Ie,He);let on=(Ht,wn,Dn)=>{let{crossTileID:Xn,numVerticalGlyphVertices:tn}=Ht,En=null;if(R&&R.dynamicFilterNeedsFeature||qt){let Oi=this.retainedQueryData[v.bucketInstanceId];En=ie.loadFeature({featureIndex:Ht.featureIndex,bucketIndex:Oi.bucketIndex,sourceLayerIndex:Oi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(R&&!(0,R.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},En,this.retainedQueryData[v.bucketInstanceId].tileID.canonical,new r.P(Ht.tileAnchorX,Ht.tileAnchorY),this.transform.calculateDistanceTileData(R.unwrappedTileID)))return this.placements[Xn]=new Do(!1,!1,!1,!0),void o.add(Xn);let Tn=Ne.evaluate(En,{});if(o.has(Xn))return;if(U)return void(this.placements[Xn]=new Do(!1,!1,!1));let Mn=!1,sn=!1,zn=!0,Cn=!1,_i=!1,yn=null,Rn={box:null,offscreen:null,occluded:null},qn={box:null},$i=null,Bi=null,qi=null,pr=0,ls=0,Hr=0;Dn.textFeatureIndex?pr=Dn.textFeatureIndex:Ht.useRuntimeCollisionCircles&&(pr=Ht.featureIndex),Dn.verticalTextFeatureIndex&&(ls=Dn.verticalTextFeatureIndex);let po=Oi=>{Oi.tileID=this.retainedQueryData[v.bucketInstanceId].tileID;let Si=this.transform.elevation;Oi.elevation=Ce?Tn:Tn+(Si?Si.getAtTileOffset(Oi.tileID,Oi.tileAnchorX,Oi.tileAnchorY):0),Oi.elevation+=Ht.zOffset},Tr=Dn.textBox;if(Tr){po(Tr);let Oi=Jn=>{let Qi=r.bI.horizontal;if(v.allowVerticalPlacement&&!Jn&&this.prevPlacement){let mr=this.prevPlacement.placedOrientations[Xn];mr&&(this.placedOrientations[Xn]=mr,Qi=mr,this.markUsedOrientation(v,Qi,Ht))}return Qi},Si=(Jn,Qi)=>{if(v.allowVerticalPlacement&&tn>0&&Dn.verticalTextBox){for(let mr of v.writingModes)if(mr===r.bI.vertical?(Rn=Qi(),qn=Rn):Rn=Jn(),Rn&&Rn.box&&Rn.box.length)break}else Rn=Jn()};if($e){let Jn=$e;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Xn]){let Li=this.prevPlacement.variableOffsets[Xn];Jn.indexOf(Li.anchor)>0&&(Jn=Jn.filter(Oo=>Oo!==Li.anchor),Jn.unshift(Li.anchor))}let Qi=(Li,Oo,_l)=>{let Oa=v.getSymbolInstanceTextSize(W,Ht,this.transform.zoom,wn),Ic=(Li.x2-Li.x1)*Oa+2*Li.padding,Sc=(Li.y2-Li.y1)*Oa+2*Li.padding,Lo=Ht.hasIconTextFit&&!oe?Oo:null;Lo&&po(Lo);let Is={box:[],offscreen:!1,occluded:!1},er=re?2*Jn.length:Jn.length;for(let ko=0;ko<er;++ko){let yl=this.attemptAnchorPlacement(Jn[ko%Jn.length],Li,V,z,dt,Ic,Sc,Oa,se,me,k,C,J,ko>=Jn.length,Ht,wn,v,_l,Lo,W,Y);if(yl&&(Is=yl.placedGlyphBoxes,Is&&Is.box&&Is.box.length)){Mn=!0,yn=yl.shift;break}}return Is};Si(()=>Qi(Tr,Dn.iconBox,r.bI.horizontal),()=>{let Li=Dn.verticalTextBox;return Li&&po(Li),v.allowVerticalPlacement&&!(Rn&&Rn.box&&Rn.box.length)&&tn>0&&Li?Qi(Li,Dn.verticalIconBox,r.bI.vertical):{box:null,offscreen:null,occluded:null}}),Rn&&(Mn=Rn.box,zn=Rn.offscreen,Cn=Rn.occluded);let mr=Oi(!(!Rn||!Rn.box));if(!Mn&&this.prevPlacement){let Li=this.prevPlacement.variableOffsets[Xn];Li&&(this.variableOffsets[Xn]=Li,this.markUsedJustification(v,Li.anchor,Ht,mr))}}else{let Jn=(Qi,mr)=>{let Li=v.getSymbolInstanceTextSize(W,Ht,this.transform.zoom,wn,_),Oo=this.collisionIndex.placeCollisionBox(v,Li,Qi,V,z,dt,new r.P(0,0),re,k,C,J.predicate);return Oo&&Oo.box&&Oo.box.length&&(this.markUsedOrientation(v,mr,Ht),this.placedOrientations[Xn]=mr),Oo};Si(()=>Jn(Tr,r.bI.horizontal),()=>{let Qi=Dn.verticalTextBox;return v.allowVerticalPlacement&&tn>0&&Qi?(po(Qi),Jn(Qi,r.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Oi(!!(Rn&&Rn.box&&Rn.box.length))}}if($i=Rn,Mn=$i&&$i.box&&$i.box.length>0,zn=$i&&$i.offscreen,Cn=$i&&$i.occluded,Ht.useRuntimeCollisionCircles){let Oi=v.text.placedSymbolArray.get(Ht.centerJustifiedTextSymbolIndex>=0?Ht.centerJustifiedTextSymbolIndex:Ht.verticalPlacedTextSymbolIndex),Si=r.bJ(v.textSizeData,W,Oi),Jn=E.get("text-padding");Bi=this.collisionIndex.placeCollisionCircles(v,re,Oi,v.lineVertexArray,v.glyphOffsetArray,Si,C,A,L,h,me,J.predicate,Ht.collisionCircleDiameter*Si/r.bU,Jn,this.retainedQueryData[v.bucketInstanceId].tileID),Mn=re||Bi.circles.length>0&&!Bi.collisionDetected,zn=zn&&Bi.offscreen,Cn=Bi.occluded}if(Dn.iconFeatureIndex&&(Hr=Dn.iconFeatureIndex),Dn.iconBox){let Oi=Si=>{po(Si);let Jn=Ht.hasIconTextFit&&yn?On(yn.x,yn.y,se,me,this.transform.angle):new r.P(0,0),Qi=v.getSymbolInstanceIconSize(Y,this.transform.zoom,Ht.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(v,Qi,Si,V,z,Tt,Jn,oe,k,C,J.predicate)};qn&&qn.box&&qn.box.length&&Dn.verticalIconBox?(qi=Oi(Dn.verticalIconBox),sn=qi.box.length>0):(qi=Oi(Dn.iconBox),sn=qi.box.length>0),zn=zn&&qi.offscreen,_i=qi.occluded}let Po=le||Ht.numHorizontalGlyphVertices===0&&tn===0,Qo=ue||Ht.numIconVertices===0;if(Po||Qo?Qo?Po||(sn=sn&&Mn):Mn=sn&&Mn:sn=Mn=sn&&Mn,Mn&&$i&&$i.box&&this.collisionIndex.insertCollisionBox($i.box,E.get("text-ignore-placement"),v.bucketInstanceId,qn&&qn.box&&ls?ls:pr,J.ID),sn&&qi&&this.collisionIndex.insertCollisionBox(qi.box,E.get("icon-ignore-placement"),v.bucketInstanceId,Hr,J.ID),Bi&&(Mn&&this.collisionIndex.insertCollisionCircles(Bi.circles,E.get("text-ignore-placement"),v.bucketInstanceId,pr,J.ID),h)){let Oi=v.bucketInstanceId,Si=this.collisionCircleArrays[Oi];Si===void 0&&(Si=this.collisionCircleArrays[Oi]=new bp);for(let Jn=0;Jn<Bi.circles.length;Jn+=4)Si.circles.push(Bi.circles[Jn+0]),Si.circles.push(Bi.circles[Jn+1]),Si.circles.push(Bi.circles[Jn+2]),Si.circles.push(Bi.collisionDetected?1:0)}let Ir=v.projection.name!=="globe";wt=wt&&(Ir||!Cn),zt=zt&&(Ir||!_i),this.placements[Xn]=new Do(Mn||wt,sn||zt,zn||v.justReloaded),o.add(Xn)},bn=this.retainedQueryData[v.bucketInstanceId].tileID;if(v.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(v,bn),v.elevationType==="road"&&v.updateRoadElevation(bn.canonical),v.updateZOffset(),v.sortFeaturesByY){let Ht=v.getSortedSymbolIndexes(this.transform.angle);for(let wn=Ht.length-1;wn>=0;--wn){let Dn=Ht[wn];on(v.symbolInstances.get(Dn),Dn,v.collisionArrays[Dn])}v.hasAnyZOffset&&r.w(`${v.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(v.hasAnyZOffset){let Ht=v.getSortedIndexesByZOffset();for(let wn=0;wn<Ht.length;++wn){let Dn=Ht[wn];on(v.symbolInstances.get(Dn),Dn,v.collisionArrays[Dn])}}else for(let Ht=t.symbolInstanceStart;Ht<t.symbolInstanceEnd;Ht++)on(v.symbolInstances.get(Ht),Ht,v.collisionArrays[Ht]);if(h&&v.bucketInstanceId in this.collisionCircleArrays){let Ht=this.collisionCircleArrays[v.bucketInstanceId];r.bi(Ht.invProjMatrix,C),Ht.viewportMatrix=this.collisionIndex.getViewportMatrix()}v.justReloaded=!1}markUsedJustification(t,o,h,g){let{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:v,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:T,crossTileID:C}=h,A=r.b$(o),L=g===r.bI.vertical?T:A==="left"?_:A==="center"?v:A==="right"?E:-1;_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=L>=0&&_!==L?0:C),v>=0&&(t.text.placedSymbolArray.get(v).crossTileID=L>=0&&v!==L?0:C),E>=0&&(t.text.placedSymbolArray.get(E).crossTileID=L>=0&&E!==L?0:C),T>=0&&(t.text.placedSymbolArray.get(T).crossTileID=L>=0&&T!==L?0:C)}markUsedOrientation(t,o,h){let g=o===r.bI.horizontal||o===r.bI.horizontalOnly?o:0,_=o===r.bI.vertical?o:0,{leftJustifiedTextSymbolIndex:v,centerJustifiedTextSymbolIndex:E,rightJustifiedTextSymbolIndex:T,verticalPlacedTextSymbolIndex:C}=h,A=t.text.placedSymbolArray;v>=0&&(A.get(v).placedOrientation=g),E>=0&&(A.get(E).placedOrientation=g),T>=0&&(A.get(T).placedOrientation=g),C>=0&&(A.get(C).placedOrientation=_)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;let o=this.prevPlacement,h=!1;this.prevZoomAdjustment=o?o.zoomAdjustment(this.transform.zoom):0;let g=o?o.symbolFadeChange(t):1,_=o?o.opacities:{},v=o?o.variableOffsets:{},E=o?o.placedOrientations:{};for(let T in this.placements){let C=this.placements[T],A=_[T];A?(this.opacities[T]=new rl(A,g,C.text,C.icon,null,C.clipped),h=h||C.text!==A.text.placed||C.icon!==A.icon.placed):(this.opacities[T]=new rl(null,g,C.text,C.icon,C.skipFade,C.clipped),h=h||C.text||C.icon)}for(let T in _){let C=_[T];if(!this.opacities[T]){let A=new rl(C,g,!1,!1);A.isHidden()||(this.opacities[T]=A,h=h||C.text.placed||C.icon.placed)}}for(let T in v)this.variableOffsets[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.variableOffsets[T]=v[T]);for(let T in E)this.placedOrientations[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.placedOrientations[T]=E[T]);h?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=o?o.lastPlacementChangeTime:t)}updateLayerOpacities(t,o,h,g){let _=new Set;for(let v of o){let E=v.getBucket(t);E&&v.latestFeatureIndex&&t.fqid===E.layerIds[0]&&(this.updateBucketOpacities(E,_,v,v.collisionBoxArray,h,g,v.tileID,t.scope),E.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(E,v.tileID),E.elevationType==="road"&&E.updateRoadElevation(v.tileID.canonical),E.updateZOffset())}}updateBucketOpacities(t,o,h,g,_,v,E,T){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();let C=t.layers[0].layout,A=t.layers[0].paint,L=!!t.layers[0].dynamicFilter(),R=new rl(null,0,!1,!1,!0),k=C.get("text-allow-overlap"),V=C.get("icon-allow-overlap"),z=C.get("text-variable-anchor"),U=C.get("text-rotation-alignment")==="map",j=C.get("text-pitch-alignment")==="map",W=A.get("symbol-z-offset"),Y=C.get("symbol-elevation-reference")==="sea",J=!W.isConstant(),ie=new rl(null,0,k&&(V||!t.hasIconData()||C.get("icon-optional")),V&&(k||!t.hasTextData()||C.get("text-optional")),!0);!t.collisionArrays&&g&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(g);let le=(re,oe,se)=>{for(let Ee=0;Ee<oe/4;Ee++)re.opacityVertexArray.emplaceBack(se)},ue=0;v&&t.updateReplacement(E,v);for(let re=0;re<t.symbolInstances.length;re++){let oe=t.symbolInstances.get(re),{numHorizontalGlyphVertices:se,numVerticalGlyphVertices:Ee,crossTileID:me,numIconVertices:Ne,tileAnchorX:Ce,tileAnchorY:Be}=oe,Qe=null,Te=this.retainedQueryData[t.bucketInstanceId];J&&oe&&Te&&(Qe=h.latestFeatureIndex.loadFeature({featureIndex:oe.featureIndex,bucketIndex:Te.bucketIndex,sourceLayerIndex:Te.sourceLayerIndex,layoutVertexArrayOffset:0}));let pe=W.evaluate(Qe,{}),Pe=o.has(me),Ie=this.opacities[me];Pe?Ie=R:Ie||(Ie=ie,this.opacities[me]=Ie),o.add(me);let He=se>0||Ee>0,$e=Ne>0,qe=this.placedOrientations[me],ot=qe===r.bI.vertical,xt=qe===r.bI.horizontal||qe===r.bI.horizontalOnly;!He&&!$e||Ie.isHidden()||ue++;let St=!1;if((He||$e)&&v)for(let dt of t.activeReplacements){if(r.bV(dt,_,r.bW.Symbol,T)||dt.min.x>Ce||Ce>dt.max.x||dt.min.y>Be||Be>dt.max.y)continue;let Tt=r.bX(Ce,Be,E.canonical,dt.footprintTileId.canonical);if(St=r.bY(Tt,dt.footprint),St)break}if(He){let dt=St?ga:Kl(Ie.text);le(t.text,se,ot?ga:dt),le(t.text,Ee,xt?ga:dt);let Tt=Ie.text.isHidden(),{leftJustifiedTextSymbolIndex:wt,centerJustifiedTextSymbolIndex:zt,rightJustifiedTextSymbolIndex:qt,verticalPlacedTextSymbolIndex:on}=oe,bn=t.text.placedSymbolArray,Ht=Tt||ot?1:0;wt>=0&&(bn.get(wt).hidden=Ht),zt>=0&&(bn.get(zt).hidden=Ht),qt>=0&&(bn.get(qt).hidden=Ht),on>=0&&(bn.get(on).hidden=Tt||xt?1:0);let wn=this.variableOffsets[me];wn&&this.markUsedJustification(t,wn.anchor,oe,qe);let Dn=this.placedOrientations[me];Dn&&(this.markUsedJustification(t,"left",oe,Dn),this.markUsedOrientation(t,Dn,oe))}if($e){let dt=St?ga:Kl(Ie.icon),{placedIconSymbolIndex:Tt,verticalPlacedIconSymbolIndex:wt}=oe,zt=t.icon.placedSymbolArray,qt=Ie.icon.isHidden()?1:0;Tt>=0&&(le(t.icon,Ne,ot?ga:dt),zt.get(Tt).hidden=qt),wt>=0&&(le(t.icon,oe.numVerticalIconVertices,xt?ga:dt),zt.get(wt).hidden=qt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){let dt=t.collisionArrays[re];if(dt){let Tt=new r.P(0,0),wt=!0;if(dt.textBox||dt.verticalTextBox){if(z){let qt=this.variableOffsets[me];qt?(Tt=Pn(qt.anchor,qt.width,qt.height,qt.textOffset,qt.textScale),U&&Tt._rotate(j?this.transform.angle:-this.transform.angle)):wt=!1}L&&(wt=!Ie.clipped),dt.textBox&&Us(t.textCollisionBox.collisionVertexArray,Ie.text.placed,!wt||ot,pe,Y,Tt.x,Tt.y),dt.verticalTextBox&&Us(t.textCollisionBox.collisionVertexArray,Ie.text.placed,!wt||xt,pe,Y,Tt.x,Tt.y)}let zt=wt&&!!(!xt&&dt.verticalIconBox);dt.iconBox&&Us(t.iconCollisionBox.collisionVertexArray,Ie.icon.placed,zt,pe,Y,oe.hasIconTextFit?Tt.x:0,oe.hasIconTextFit?Tt.y:0),dt.verticalIconBox&&Us(t.iconCollisionBox.collisionVertexArray,Ie.icon.placed,!zt,pe,Y,oe.hasIconTextFit?Tt.x:0,oe.hasIconTextFit?Tt.y:0)}}}if(t.fullyClipped=ue===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){let re=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=re.invProjMatrix,t.placementViewportMatrix=re.viewportMatrix,t.collisionCircleArray=re.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,o){let h=this.zoomAtLastRecencyCheck===o?1-this.zoomAdjustment(o):1;return this.zoomAtLastRecencyCheck=o,this.commitTime+this.fadeDuration*h>t}setStale(){this.stale=!0}}function Us(u,t,o,h,g,_,v){u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0),u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0),u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0),u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0)}let kn=Math.pow(2,25),th=Math.pow(2,24),Su=Math.pow(2,17),Du=Math.pow(2,16),Pr=Math.pow(2,9),Ji=Math.pow(2,8),hb=Math.pow(2,1);function Kl(u){if(u.opacity===0&&!u.placed)return 0;if(u.opacity===1&&u.placed)return 4294967295;let t=u.placed?1:0,o=Math.floor(127*u.opacity);return o*kn+t*th+o*Su+t*Du+o*Pr+t*Ji+o*hb+t}let ga=0;class Cu{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,o,h,g,_,v){let E=this._bucketParts;for(;this._currentTileIndex<t.length;)if(o.getBucketParts(E,g,t[this._currentTileIndex],this._sortAcrossTiles,v),this._currentTileIndex++,_())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((T,C)=>T.sortKey-C.sortKey));this._currentPartIndex<E.length;){let T=E[this._currentPartIndex];if(o.placeLayerBucketPart(T,this._seenCrossTileIDs,h,T.symbolInstanceStart===0,v),this._currentPartIndex++,_())return!0}return!1}}class nh{constructor(t,o,h,g,_,v,E,T,C){this.placement=new ho(t,_,v,E,T,C),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=h,this._showCollisionBoxes=g,this._done=!1}isDone(){return this._done}continuePlacement(t,o,h,g,_){let v=r.q.now(),E=()=>{let T=r.q.now()-v;return!this._forceFullPlacement&&T>2};for(;this._currentPlacementIndex>=0;){let T=o[t[this._currentPlacementIndex]],C=this.placement.collisionIndex.transform.zoom;if(T.type==="symbol"&&(!T.minzoom||T.minzoom<=C)&&(!T.maxzoom||T.maxzoom>C)){let A=T,L=A.layout.get("symbol-z-elevate"),R=A.layout.get("symbol-sort-key").constantOr(1)!==void 0,k=A.layout.get("symbol-z-order"),V=k==="viewport-y"||k==="auto"&&!(k!=="viewport-y"&&R),z=A.layout.get("text-allow-overlap")||A.layout.get("icon-allow-overlap")||A.layout.get("text-ignore-placement")||A.layout.get("icon-ignore-placement"),U=V&&z,j=this._inProgressLayer=this._inProgressLayer||new Cu(A),W=r.C(T.source,T.scope);if(j.continuePlacement(L||U?g[W]:h[W],this.placement,this._showCollisionBoxes,T,E,_))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}let Au=512/r.aj/2;class ih{constructor(t,o,h){this.tileID=t,this.bucketInstanceId=h,this.index=new r.c0(o.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let g=t.canonical.x*r.aj,_=t.canonical.y*r.aj;for(let v=0;v<o.length;v++){let{key:E,crossTileID:T,tileAnchorX:C,tileAnchorY:A}=o.get(v),L=Math.floor((g+C)*Au),R=Math.floor((_+A)*Au);this.index.add(L,R),this.keys.push(E),this.crossTileIDs.push(T)}this.index.finish()}findMatches(t,o,h){let g=this.tileID.canonical.z<o.canonical.z?1:Math.pow(2,this.tileID.canonical.z-o.canonical.z),_=Au/Math.pow(2,o.canonical.z-this.tileID.canonical.z),v=o.canonical.x*r.aj,E=o.canonical.y*r.aj;for(let T=0;T<t.length;T++){let C=t.get(T);if(C.crossTileID)continue;let{key:A,tileAnchorX:L,tileAnchorY:R}=C,k=Math.floor((v+L)*_),V=Math.floor((E+R)*_),z=this.index.range(k-g,V-g,k+g,V+g).sort((U,j)=>U-j);for(let U of z){let j=this.crossTileIDs[U];if(this.keys[U]===A&&!h.has(j)){h.add(j),C.crossTileID=j;break}}}}}class Br{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Hs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){let o=Math.round((t-this.lng)/360);if(o!==0)for(let h in this.indexes){let g=this.indexes[h],_={};for(let v in g){let E=g[v];E.tileID=E.tileID.unwrapTo(E.tileID.wrap+o),_[E.tileID.key]=E}this.indexes[h]=_}this.lng=t}addBucket(t,o,h){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===o.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let _=0;_<o.symbolInstances.length;_++)o.symbolInstances.get(_).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);let g=this.usedCrossTileIDs[t.overscaledZ];for(let _ in this.indexes){let v=this.indexes[_];if(Number(_)>t.overscaledZ)for(let E in v){let T=v[E];T.tileID.isChildOf(t)&&T.findMatches(o.symbolInstances,t,g)}else{let E=v[t.scaledTo(Number(_)).key];E&&E.findMatches(o.symbolInstances,t,g)}}for(let _=0;_<o.symbolInstances.length;_++){let v=o.symbolInstances.get(_);v.crossTileID||(v.crossTileID=h.generate(),g.add(v.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new ih(t,o.symbolInstances,o.bucketInstanceId),!0}removeBucketCrossTileIDs(t,o){for(let h of o.crossTileIDs)this.usedCrossTileIDs[t].delete(h)}removeStaleBuckets(t){let o=!1;for(let h in this.indexes){let g=this.indexes[h];for(let _ in g)t[g[_].bucketInstanceId]||(this.removeBucketCrossTileIDs(h,g[_]),delete g[_],o=!0)}return o}}class to{constructor(){this.layerIndexes={},this.crossTileIDs=new Br,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,o,h,g){let _=this.layerIndexes[t.fqid];_===void 0&&(_=this.layerIndexes[t.fqid]=new Hs);let v=!1,E={};g.name!=="globe"&&_.handleWrapJump(h);for(let T of o){let C=T.getBucket(t);C&&t.fqid===C.layerIds[0]&&(C.bucketInstanceId||(C.bucketInstanceId=++this.maxBucketInstanceId),_.addBucket(T.tileID,C,this.crossTileIDs)&&(v=!0),E[C.bucketInstanceId]=!0)}return _.removeStaleBuckets(E)&&(v=!0),v}pruneUnusedLayers(t){let o={};t.forEach(h=>{o[h]=!0});for(let h in this.layerIndexes)o[h]||delete this.layerIndexes[h]}}let ol=771;class Yt{constructor(t,o,h,g){this.blendFunction=t,this.blendColor=o.toNonPremultipliedRenderColor(null),this.mask=h,this.blendEquation=g}}Yt.Replace=[1,0,1,0],Yt.disabled=new Yt(Yt.Replace,r.am.transparent,[!1,!1,!1,!1]),Yt.unblended=new Yt(Yt.Replace,r.am.transparent,[!0,!0,!0,!0]),Yt.alphaBlended=new Yt([1,ol,1,ol],r.am.transparent,[!0,!0,!0,!0]),Yt.alphaBlendedNonPremultiplied=new Yt([770,ol,770,ol],r.am.transparent,[!0,!0,!0,!0]),Yt.multiply=new Yt([774,0,774,0],r.am.transparent,[!0,!0,!0,!0]);class pt{constructor(t,o,h){this.func=t,this.mask=o,this.range=h}}pt.ReadOnly=!1,pt.ReadWrite=!0,pt.disabled=new pt(519,pt.ReadOnly,[0,1]);let Wo=7680;class Lt{constructor(t,o,h,g,_,v){this.test=t,this.ref=o,this.mask=h,this.fail=g,this.depthFail=_,this.pass=v}}Lt.disabled=new Lt({func:519,mask:0},0,0,Wo,Wo,Wo);let Xi=1029,Mu=2305;class At{constructor(t,o,h){this.enable=t,this.mode=o,this.frontFace=h}}function Jl(u,t){let o=r.c6(u,3);r.c8(u,t),r.cc(u,3,o)}function Ql(u,t){let o=r.c3([]);return r.c4(o,o,-t),r.c5(o,o,-u),o}function _a(u,t){let o=[u[0],u[1],0],h=[t[0],t[1],0];if(r.ae(o)>=1e-15){let v=r.au([],o);r.c1(h,v,r.bG(h,v)),t[0]=h[0],t[1]=h[1]}let g=r.bF([],t,u);if(r.c2(g)<1e-15)return null;let _=Math.atan2(-g[1],g[0]);return Ql(Math.atan2(Math.sqrt(u[0]*u[0]+u[1]*u[1]),-u[2]),_)}At.disabled=new At(!1,Xi,Mu),At.backCCW=new At(!0,Xi,Mu),At.backCW=new At(!0,Xi,2304),At.frontCW=new At(!0,1028,2304),At.frontCCW=new At(!0,1028,Mu);class U_{constructor(t,o){this.position=t,this.orientation=o}get position(){return this._position}set position(t){if(t){let o=t instanceof r.ac?t:new r.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(o.x=r.bQ(o.x,0,1)),this._position=o}else this._position=null}lookAtPoint(t,o){if(this.orientation=null,!this.position)return;let h=this.position,g=this._elevation?this._elevation.getAtPointOrZero(r.ac.fromLngLat(t)):0,_=r.ac.fromLngLat(t,g),v=[_.x-h.x,_.y-h.y,_.z-h.z];o||(o=[0,0,1]),o[2]=Math.abs(o[2]),this.orientation=_a(v,o)}setPitchBearing(t,o){this.orientation=Ql(r.al(t),r.al(-o))}}class Zo{constructor(t,o){this._transform=r.bx([]),this.orientation=o,this.position=t}get mercatorPosition(){let t=this.position;return new r.ac(t[0],t[1],t[2])}get position(){let t=r.c6(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var o;t&&r.cc(this._transform,3,[(o=t)[0],o[1],o[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||r.c3([]),t&&Jl(this._transform,this._orientation)}getPitchBearing(){let t=this.forward(),o=this.right();return{bearing:Math.atan2(-o[1],o[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,o){this._orientation=Ql(t,o),Jl(this._transform,this._orientation)}forward(){let t=r.c6(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){let t=r.c6(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){let t=r.c6(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,o){let h=new Float64Array(16);return r.bi(h,this.getWorldToCamera(t,o)),h}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,o,h){let g=this.position;r.c1(g,g,-t);let _=new Float64Array(16);return r.bn(_,[h,h,h]),r.bo(_,_,g),_[10]*=o,_}getWorldToCamera(t,o){let h=new Float64Array(16),g=new Float64Array(4),_=this.position;return r.c7(g,this._orientation),r.c1(_,_,-t),r.c8(h,g),r.bo(h,h,_),h[1]*=-1,h[5]*=-1,h[9]*=-1,h[13]*=-1,h[8]*=o,h[9]*=o,h[10]*=o,h[11]*=o,h}getCameraToClipPerspective(t,o,h,g){let _=new Float64Array(16);return r.c9(_,t,o,h,g),_}getCameraToClipOrthographic(t,o,h,g,_,v){let E=new Float64Array(16);return r.ca(E,t,o,h,g,_,v),E}getDistanceToElevation(t,o=!1){let h=t===0?0:r.cb(t,o?r.aY(this.position[1]):this.position[1]),g=this.forward();return(h-this.position[2])/g[2]}clone(){return new Zo([...this.position],[...this.orientation])}}let Vr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Ru{constructor(t=0,o=0,h=0,g=0){if(isNaN(t)||t<0||isNaN(o)||o<0||isNaN(h)||h<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=o,this.left=h,this.right=g}interpolate(t,o,h){return o.top!=null&&t.top!=null&&(this.top=r.ai(t.top,o.top,h)),o.bottom!=null&&t.bottom!=null&&(this.bottom=r.ai(t.bottom,o.bottom,h)),o.left!=null&&t.left!=null&&(this.left=r.ai(t.left,o.left,h)),o.right!=null&&t.right!=null&&(this.right=r.ai(t.right,o.right,h)),this}getCenter(t,o){let h=r.ay((this.left+t-this.right)/2,0,t),g=r.ay((this.top+o-this.bottom)/2,0,o);return new r.P(h,g)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Ru(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let fr=15;class wp{constructor(t,o,h,g,_,v,E){this.tileSize=512,this._renderWorldCopies=_===void 0||_,this._minZoom=t||0,this._maxZoom=o||22,this._minPitch=h??0,this._maxPitch=g??60,this.setProjection(v),this.setMaxBounds(E),this.width=0,this.height=0,this._center=new r.ci(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ru,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Zo,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let t=new wp(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<fr}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,o=!1){let h=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||h)&&this._updateCameraOnTerrain(),(t||h)&&this._constrainCamera(o),this._calcMatrices()}getProjection(){return r.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};let o=this.projection?this.getProjection():void 0;this.projection=r.cj(this.projectionOptions);let h=this.getProjection(),g=!r.bv(o,h);return g&&this._calcMatrices(),this.mercatorFromTransition=!1,g}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){let t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=r.cj({name:"mercator"});let o=t!==this.projection.name;return o&&this._calcMatrices(),o}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return r.cb(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new r.P(this.width,this.height)}get bearing(){return r.bQ(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){let o=-t*Math.PI/180;this.angle!==o&&(this._unmodified=!1,this.angle=o,this._calcMatrices(),this.rotationMatrix=r.ck(),r.cl(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){let o=r.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==o&&(this._unmodified=!1,this._pitch=o,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=r.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){let o=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==o&&(this._unmodified=!1,this._setZoom(o),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){let t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,o=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!o||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let h=this._elevation;o||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&h.exaggeration()&&this._centerAltitudeValidForExaggeration!==h.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*h.exaggeration(),this._centerAltitudeValidForExaggeration=h.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=h.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;let t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;let t=this._elevation,o=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],h=this.horizonLineFromTop(),g=0,_=0;for(let v=0;v<o.length;v++){let E=new r.P(o[v][0]*this.width,h+o[v][1]*(this.height-h)),T=t.pointCoordinate(E);if(!T)continue;let C=1/Math.hypot(T[0]-this._camera.position[0],T[1]-this._camera.position[1]);g+=T[3]*C,_+=C}return _===0?NaN:g/_}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let t=this._seaLevelZoom,o=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),h=this.pixelsPerMeter/this.worldSize*o,g=this._mercatorZfromZoom(t),_=this._mercatorZfromZoom(this._maxZoom),v=Math.max(g-h,_);this._setZoom(this._zoomFromMercatorZ(v))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){let o=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude())),h;h=t.z<this._camera.position[2]?[o.x,o.y,o.z]:[t.x,t.y,t.z];let g=r.ae(r.at([],this._camera.position,h));return r.ay(this._zoomFromMercatorZ(g),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let o=!1;if(t.orientation&&!r.cm(t.orientation,this._camera.orientation)&&(o=this._setCameraOrientation(t.orientation)),t.position){let h=[t.position.x,t.position.y,t.position.z];r.cn(h,this._camera.position)||(this._setCameraPosition(h),o=!0)}o&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let t=this._camera.position,o=new U_;return o.position=new r.ac(t[0],t[1],t[2]),o.orientation=this._camera.orientation,o._elevation=this.elevation,o._renderWorldCopies=this.renderWorldCopies,o}_setCameraOrientation(t){if(!r.co(t))return!1;r.cp(t,t);let o=r.cq([],[0,0,-1],t),h=r.cq([],[0,-1,0],t);if(h[2]<0)return!1;let g=_a(o,h);return!!g&&(this._camera.orientation=g,!0)}_setCameraPosition(t){let o=this.zoomScale(this.minZoom)*this.tileSize,h=this.zoomScale(this.maxZoom)*this.tileSize,g=this.cameraToCenterDistance;t[2]=r.ay(t[2],g/h,g/o),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,o,h){this._unmodified=!1,this._edgeInsets.interpolate(t,o,h),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){let o=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,o)}getVisibleUnwrappedCoordinates(t){let o=[new r.cr(0,t)];if(this.renderWorldCopies){let h=this.pointCoordinate(new r.P(0,0)),g=this.pointCoordinate(new r.P(this.width,0)),_=this.pointCoordinate(new r.P(this.width,this.height)),v=this.pointCoordinate(new r.P(0,this.height)),E=Math.floor(Math.min(h.x,g.x,_.x,v.x)),T=Math.floor(Math.max(h.x,g.x,_.x,v.x)),C=1;for(let A=E-C;A<=T+C;A++)A!==0&&o.push(new r.cr(A,t))}return o}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,o,h){let g=[],_=h!=null,v=!_;if(v&&this.zoom<o||_&&h[0]===0&&h[1]===0)return g;let E=new Set,T=(A,L,R,k,V)=>{let z=r.cV(L,A,R,k,V);E.has(z)||(g.push(new r.aM(A,L,R,k,V)),E.add(z))};for(let A=0;A<t.length;A++){let L=t[A];if(v&&L.canonical.z!==o)continue;let R=L.canonical,k=L.overscaledZ,V=L.wrap,z=1<<R.z,U=R.x+1<z,j=R.x>0,W=R.y+1<z,Y=R.y>0,J=L.wrap-(j?0:1),ie=L.wrap+(U?0:1),le=j?R.x-1:z-1,ue=U?R.x+1:0;if(_)h[0]<0?(T(k,ie,R.z,ue,R.y),h[1]<0&&W&&(T(k,V,R.z,R.x,R.y+1),T(k,ie,R.z,ue,R.y+1)),h[1]>0&&Y&&(T(k,V,R.z,R.x,R.y-1),T(k,ie,R.z,ue,R.y-1))):h[0]>0?(T(k,J,R.z,le,R.y),h[1]<0&&W&&(T(k,V,R.z,R.x,R.y+1),T(k,J,R.z,le,R.y+1)),h[1]>0&&Y&&(T(k,V,R.z,R.x,R.y-1),T(k,J,R.z,le,R.y-1))):h[1]<0&&W?T(k,V,R.z,R.x,R.y+1):Y&&T(k,V,R.z,R.x,R.y-1);else{let re=L.visibleQuadrants;1&re&&(T(k,J,R.z,le,R.y),Y&&(T(k,V,R.z,R.x,R.y-1),T(k,J,R.z,le,R.y-1))),2&re&&(T(k,ie,R.z,ue,R.y),Y&&(T(k,V,R.z,R.x,R.y-1),T(k,ie,R.z,ue,R.y-1))),4&re&&(T(k,J,R.z,le,R.y),W&&(T(k,V,R.z,R.x,R.y+1),T(k,J,R.z,le,R.y+1))),8&re&&(T(k,ie,R.z,ue,R.y),W&&(T(k,V,R.z,R.x,R.y+1),T(k,ie,R.z,ue,R.y+1)))}}let C=[];for(let A of g)g.some(L=>A.isChildOf(L))||C.push(A);if(g=C.filter(A=>!t.some(L=>!!(A.overscaledZ<o&&L.isChildOf(A))||A.equals(L)||A.isChildOf(L))),v){let A=1<<o,L=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),R=[A*L.x,A*L.y],k=4,V=k*k;g=g.filter(z=>{let U=z.canonical.x+.5-R[0],j=z.canonical.y+.5-R[1];return U*U+j*j<V})}return g}extendTileCoverToNearPlane(t,o,h){let g=[],_=new Set;for(let W of t)_.add(W.key);let v=(W,Y,J,ie,le)=>{let ue=r.cV(Y,W,J,ie,le);_.has(ue)||(g.push(new r.aM(W,Y,J,ie,le)),_.add(ue))},E=t.reduce((W,Y)=>Math.max(W,Y.overscaledZ),h),T=1<<h,C=[new r.P(0,0),new r.P(r.aj,0),new r.P(r.aj,r.aj),new r.P(0,r.aj)],A=new r.P(0,0),L=new r.P(0,0),R=(W,Y)=>{let J=Math.floor(W[0]),ie=Math.floor(W[1]),le=(W[0]-J)*r.aj,ue=(W[1]-ie)*r.aj,re=Math.floor(Y[0]),oe=Math.floor(Y[1]),se=(Y[0]-re)*r.aj,Ee=(Y[1]-oe)*r.aj;for(let me=-1;me<=1;me++){let Ne=J+me;if(!(Ne<0||Ne>=T)){A.x=le-me*r.aj,L.x=se-(Ne-re)*r.aj;for(let Ce=-1;Ce<=1;Ce++){let Be=ie+Ce;A.y=ue-Ce*r.aj,L.y=Ee-(Be-oe)*r.aj,r.cW(A,L,C)&&v(E,0,h,Ne,Be)}}}},k=o.points,V=k[r.cs],z=k[r.ct],U=this._projectToGround(V,k[r.cu]),j=this._projectToGround(z,k[r.cv]);return R(V,U),R(z,j),g}_projectToGround(t,o){return r.cw(r.cx(),t,o,t[2]/(t[2]-o[2]))}coveringTiles(t){let o=this.coveringZoomLevel(t),h=o,g=this.elevation&&this.elevation.exaggeration(),_=g&&!t.isTerrainDEM,v=this.projection.name==="mercator";if(t.minzoom!==void 0&&o<t.minzoom)return[];t.maxzoom!==void 0&&o>t.maxzoom&&(o=t.maxzoom);let E=this.locationCoordinate(this.center),T=this.center.lat,C=1<<o,A=[C*E.x,C*E.y,0],L=this.projection.name==="globe",R=!L,k=r.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,R),V=L?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),z=C*r.cb(1,this.center.lat),U=this._camera.position[2]/r.cb(1,this.center.lat),j=[C*V.x,C*V.y,U*(R?1:z)],W=L||g,Y=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),J=this.isLODDisabled(!0)?o:0,ie;if(this._elevation&&t.isTerrainDEM)ie=1e4*this._elevation.exaggeration();else if(this._elevation){let pe=this._elevation.getMinMaxForVisibleTiles();ie=pe?pe.max:this._centerAltitude}else ie=this._centerAltitude;let le=t.isTerrainDEM?-ie:this._elevation?this._elevation.getMinElevationBelowMSL():0,ue=this.projection.isReprojectedInTileSpace?r.cz(this):1,re=pe=>{let Ie=new r.ac(pe.x+25e-6,pe.y,pe.z),He=new r.ac(pe.x,pe.y+25e-6,pe.z),$e=pe.toLngLat(),qe=Ie.toLngLat(),ot=He.toLngLat(),xt=this.locationCoordinate($e),St=this.locationCoordinate(qe),dt=this.locationCoordinate(ot),Tt=Math.hypot(St.x-xt.x,St.y-xt.y),wt=Math.hypot(dt.x-xt.x,dt.y-xt.y);return Math.sqrt(Tt*wt)*ue/25e-6},oe=pe=>{let Pe=ie,Ie=le;return{aabb:r.cC(this,C,0,0,0,pe,Ie,Pe,this.projection),zoom:0,x:0,y:0,minZ:Ie,maxZ:Pe,wrap:pe,fullyVisible:!1}},se=[],Ee=[],me=o,Ne=t.reparseOverscaled?h:o,Ce=(U-this._centerAltitude)*z,Be=pe=>{if(!this._elevation||!pe.tileID||!v)return;let Pe=this._elevation.getMinMaxForTile(pe.tileID),Ie=pe.aabb;Pe?(Ie.min[2]=Pe.min,Ie.max[2]=Pe.max,Ie.center[2]=(Ie.min[2]+Ie.max[2])/2):(pe.shouldSplit=Te(pe),pe.shouldSplit||(Ie.min[2]=Ie.max[2]=Ie.center[2]=this._centerAltitude))},Qe=(pe,Pe)=>{if(.707*Pe<pe)return 1;let Ie=Pe/pe;return Ie/(1.4144271570014144+(Math.pow(1.1,Ie-1.4144271570014144+1)-1)/(1.1-1)-1)},Te=pe=>{if(pe.zoom<J)return!0;if(pe.zoom===me)return!1;if(pe.shouldSplit!=null)return pe.shouldSplit;let Pe=pe.aabb.distanceX(j),Ie=pe.aabb.distanceY(j),He=Ce,$e=1;if(L){He=pe.aabb.distanceZ(j);let wt=Math.pow(2,pe.zoom),zt=r.aY((pe.y+1)/wt),qt=r.aY(pe.y/wt),on=Math.min(Math.max(T,zt),qt),bn=r.c_(on)/r.c_(T);if($e=on===T?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,bn/this._mercatorScaleRatio),this.zoom<=r.cX&&pe.zoom===me-1&&bn>=.9)return!0}else if(_&&(He=pe.aabb.distanceZ(j)*z),this.projection.isReprojectedInTileSpace&&h<=5){let wt=Math.pow(2,pe.zoom),zt=re(new r.ac((pe.x+.5)/wt,(pe.y+.5)/wt));$e=zt>.85?1:zt}if(!v){let wt=Math.sqrt(Pe*Pe+Ie*Ie+He*He),zt=(1<<me-pe.zoom)*Y*$e;return zt*=Qe(Math.max(He,Ce),wt),wt<zt}let qe=Number.MAX_VALUE,ot=0,xt=pe.aabb.getCorners(),St=[];for(let wt of xt){r.at(St,wt,j),L||(_?St[2]*=z:St[2]=Ce);let zt=r.bG(St,this._camera.forward());zt<qe&&(qe=zt,ot=Math.abs(St[2]))}let dt=(1<<me-pe.zoom)*Y*$e;if(dt*=Qe(Math.max(ot,Ce),qe),qe<dt)return!0;let Tt=pe.aabb.closestPoint(A);return Tt[0]===A[0]&&Tt[1]===A[1]};if(this.renderWorldCopies)for(let pe=1;pe<=3;pe++)se.push(oe(-pe)),se.push(oe(pe));for(se.push(oe(0));se.length>0;){let pe=se.pop(),Pe=pe.x,Ie=pe.y,He=pe.fullyVisible,$e=()=>this.projection.name==="globe"&&(pe.y===0||pe.y===(1<<pe.zoom)-1);if(!He){let qe=W?pe.aabb.intersects(k):pe.aabb.intersectsFlat(k);if(qe===0&&$e()){let ot=new r.cA(pe.zoom,Pe,Ie);qe=r.cB(this,C,ot,!0).intersects(k)}if(qe===0)continue;He=qe===2}if(pe.zoom!==me&&Te(pe))for(let qe=0;qe<4;qe++){let ot=(Pe<<1)+qe%2,xt=(Ie<<1)+(qe>>1),St={aabb:v?pe.aabb.quadrant(qe):r.cC(this,C,pe.zoom+1,ot,xt,pe.wrap,pe.minZ,pe.maxZ,this.projection),zoom:pe.zoom+1,x:ot,y:xt,wrap:pe.wrap,fullyVisible:He,tileID:void 0,shouldSplit:void 0,minZ:pe.minZ,maxZ:pe.maxZ};_&&!L&&(St.tileID=new r.aM(pe.zoom+1===me?Ne:pe.zoom+1,pe.wrap,pe.zoom+1,ot,xt),Be(St)),se.push(St)}else{let qe=pe.zoom===me?Ne:pe.zoom;if(t.minzoom&&t.minzoom>qe)continue;let ot=0;if(!He){let Tt=W?pe.aabb.intersectsPrecise(k):pe.aabb.intersectsPreciseFlat(k);if(Tt===0&&$e()){let wt=new r.cA(pe.zoom,Pe,Ie);Tt=r.cB(this,C,wt,!0).intersectsPrecise(k)}if(Tt===0)continue;if(t.calculateQuadrantVisibility)if(k.containsPoint(pe.aabb.center))ot=15;else for(let wt=0;wt<4;wt++)pe.aabb.quadrant(wt).intersects(k)!==0&&(ot|=1<<wt)}let xt=A[0]-(.5+Pe+(pe.wrap<<pe.zoom))*(1<<o-pe.zoom),St=A[1]-.5-Ie,dt=pe.tileID?pe.tileID:new r.aM(qe,pe.wrap,pe.zoom,Pe,Ie);t.calculateQuadrantVisibility&&(dt.visibleQuadrants=ot),Ee.push({tileID:dt,distanceSq:xt*xt+St*St})}}if(this.fogCullDistSq){let pe=this.fogCullDistSq,Pe=this.horizonLineFromTop();Ee=Ee.filter(Ie=>{let He=[0,0,0,1],$e=[r.aj,r.aj,0,1],qe=this.calculateFogTileMatrix(Ie.tileID.toUnwrapped());r.aA(He,He,qe),r.aA($e,$e,qe);let ot=r.cD([],He,$e),xt=r.cE([],He,$e),St=r.cY(ot,xt);if(St===0)return!0;let dt=!1,Tt=this._elevation;if(Tt&&St>pe&&Pe!==0){let wt=this.calculateProjMatrix(Ie.tileID.toUnwrapped()),zt;t.isTerrainDEM||(zt=Tt.getMinMaxForTile(Ie.tileID)),zt||(zt={min:le,max:ie});let qt=r.cF(this.rotation),on=[qt[0]*r.aj,qt[1]*r.aj,zt.max];r.ad(on,on,wt),dt=(1-on[1])*this.height*.5<Pe}return St<pe||dt})}return Ee.sort((pe,Pe)=>pe.distanceSq-Pe.distanceSq).map(pe=>pe.tileID)}resize(t,o){this.width=t,this.height=o,this.pixelsToGLUnits=[2/t,-2/o],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){let o=r.ay(t.lat,-r.cG,r.cG),h=this.projection.project(t.lng,o);return new r.P(h.x*this.worldSize,h.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/r.cb(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,o){let h,g,_=this.centerPoint;if(this.projection.name==="globe"){let E=this.worldSize;h=(o.x-_.x)/E,g=(o.y-_.y)/E}else{let E=this.pointCoordinate(o),T=this.pointCoordinate(_);h=E.x-T.x,g=E.y-T.y}let v=this.locationCoordinate(t);this.setLocation(new r.ac(v.x-h,v.y-g))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,o){return this.projection.locationPoint(this,t,o)}locationPoint3D(t,o){return this.projection.locationPoint(this,t,o,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,o){return this.coordinateLocation(this.pointCoordinate3D(t,o))}locationCoordinate(t,o){let h=o?r.cb(o,t.lat):void 0,g=this.projection.project(t.lng,t.lat);return new r.ac(g.x,g.y,h)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,o){let h=o??this._centerAltitude,g=[t.x,t.y,0,1],_=[t.x,t.y,1,1];r.aA(g,g,this.pixelMatrixInverse),r.aA(_,_,this.pixelMatrixInverse);let v=_[3];r.cH(g,g,1/g[3]),r.cH(_,_,1/v);let E=g[2],T=_[2];return{p0:g,p1:_,t:E===T?0:(h-E)/(T-E)}}screenPointToMercatorRay(t){let o=[t.x,t.y,0,1],h=[t.x,t.y,1,1];return r.aA(o,o,this.pixelMatrixInverse),r.aA(h,h,this.pixelMatrixInverse),r.cH(o,o,1/o[3]),r.cH(h,h,1/h[3]),o[2]=r.cb(o[2],this._center.lat)*this.worldSize,h[2]=r.cb(h[2],this._center.lat)*this.worldSize,r.cH(o,o,1/this.worldSize),r.cH(h,h,1/this.worldSize),new r.av([o[0],o[1],o[2]],r.au([],r.at([],h,o)))}rayIntersectionCoordinate(t){let{p0:o,p1:h,t:g}=t,_=r.cb(o[2],this._center.lat),v=r.cb(h[2],this._center.lat);return new r.ac(r.ai(o[0],h[0],g)/this.worldSize,r.ai(o[1],h[1],g)/this.worldSize,r.ai(_,v,g))}pointCoordinate(t,o=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,o)}pointCoordinate3D(t,o){if(!this.elevation)return this.pointCoordinate(t,o);let h=this.projection.pointCoordinate3D(this,t.x,t.y);if(h)return new r.ac(h[0],h[1],h[2]);let g=0,_=this.horizonLineFromTop();if(t.y>_)return this.pointCoordinate(t,o);let v=.02*_,E=t.clone();for(let T=0;T<10&&_-g>v;T++){E.y=r.ai(g,_,.66);let C=this.projection.pointCoordinate3D(this,E.x,E.y);C?(_=E.y,h=C):g=E.y}return h?new r.ac(h[0],h[1],h[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=r.cI)return!this.isPointAboveHorizon(t);let o=this.pointCoordinate(t);return o.y>=0&&o.y<=1}_coordinatePoint(t,o){let h=o&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,g=[t.x*this.worldSize,t.y*this.worldSize,h+t.toAltitude(),1];return r.aA(g,g,this.pixelMatrix),g[3]>0?new r.P(g[0]/g[3],g[1]/g[3]):new r.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:t,left:o}=this._edgeInsets,h=this.height-this._edgeInsets.bottom,g=this.width-this._edgeInsets.right,_=this.pointLocation3D(new r.P(o,t)),v=this.pointLocation3D(new r.P(g,t)),E=this.pointLocation3D(new r.P(g,h)),T=this.pointLocation3D(new r.P(o,h)),C=Math.min(_.lng,v.lng,E.lng,T.lng),A=Math.max(_.lng,v.lng,E.lng,T.lng),L=Math.min(_.lat,v.lat,E.lat,T.lat),R=Math.max(_.lat,v.lat,E.lat,T.lat),k=Math.pow(2,-this.zoom)/16*270,V=this.projection.name==="globe"?1:4,z=(U,j,W,Y,J)=>{let ie=(U+W)/2,le=(j+Y)/2,ue=new r.P(ie,le),{lng:re,lat:oe}=this.pointLocation3D(ue),se=Math.max(0,C-re,L-oe,re-A,oe-R);C=Math.min(C,re),A=Math.max(A,re),L=Math.min(L,oe),R=Math.max(R,oe),(J<V||se>k)&&(z(U,j,ie,le,J+1),z(ie,le,W,Y,J+1))};if(z(o,t,g,t,1),z(g,t,g,h,1),z(g,h,o,h,1),z(o,h,o,t,1),this.projection.name==="globe"){let[U,j]=r.cJ(this);U?(R=90,A=180,C=-180):j&&(L=-90,A=180,C=-180)}return new r.aG(new r.ci(C,L),new r.ci(A,R))}_getBoundsRectangular(t,o){let{top:h,left:g}=this._edgeInsets,_=this.height-this._edgeInsets.bottom,v=this.width-this._edgeInsets.right,E=new r.P(g,h),T=new r.P(v,h),C=new r.P(v,_),A=new r.P(g,_),L=this.pointCoordinate(E,t),R=this.pointCoordinate(T,t),k=this.pointCoordinate(C,o),V=this.pointCoordinate(A,o),z=(U,j)=>(j.y-U.y)/(j.x-U.x);return L.y>1&&R.y>=0?L=new r.ac((1-V.y)/z(V,L)+V.x,1):L.y<0&&R.y<=1&&(L=new r.ac(-V.y/z(V,L)+V.x,0)),R.y>1&&L.y>=0?R=new r.ac((1-k.y)/z(k,R)+k.x,1):R.y<0&&L.y<=1&&(R=new r.ac(-k.y/z(k,R)+k.x,0)),new r.aG().extend(this.coordinateLocation(L)).extend(this.coordinateLocation(R)).extend(this.coordinateLocation(V)).extend(this.coordinateLocation(k))}_getBoundsRectangularTerrain(){let t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);let o=t.visibleDemTiles.reduce((h,g)=>{if(g.dem){let _=g.dem.tree;h.min=Math.min(h.min,_.minimums[0]),h.max=Math.max(h.max,_.maximums[0])}return h},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(o.min*t.exaggeration(),o.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){let o=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,h=this.height/2-o*(1-this._horizonShift);return t?Math.max(0,h):h}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-r.cG,this.maxLat=r.cG,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=r.aD(this.minLng)*this.tileSize,this.worldMaxX=r.aD(this.maxLng)*this.tileSize,this.worldMinY=r.aH(this.maxLat)*this.tileSize,this.worldMaxY=r.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,o){return this.projection.createTileMatrix(this,o,t)}calculateDistanceTileData(t){let o=t.key,h=this._distanceTileDataCache;if(h[o])return h[o];let g=t.canonical,_=1/this.height,v=this.cameraWorldSize,E=v/this.zoomScale(g.z),T=(g.x+Math.pow(2,g.z)*t.wrap)*E,C=g.y*E,A=this.point;A.x*=v/this.worldSize,A.y*=v/this.worldSize;let L=this.angle,R=Math.sin(-L),k=-Math.cos(-L);return h[o]={bearing:[R,k],center:[(A.x-T)*_,(A.y-C)*_],scale:E/r.aj*_},h[o]}calculateFogTileMatrix(t){let o=t.key,h=this._fogTileMatrixCache;if(h[o])return h[o];let g=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return r.az(g,this.worldToFogMatrix,g),h[o]=new Float32Array(g),h[o]}calculateProjMatrix(t,o=!1,h=!1){let g=t.key,_;if(_=h?this._expandedProjMatrixCache:o?this._alignedProjMatrixCache:this._projMatrixCache,_[g])return _[g];let v=this.calculatePosMatrix(t,this.worldSize),E;return E=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:h?this.expandedFarZProjMatrix:o?this.alignedProjMatrix:this.projMatrix,r.az(v,E,v),_[g]=new Float32Array(v),_[g]}calculatePixelsToTileUnitsMatrix(t){let o=t.tileID.key,h=this._pixelsToTileUnitsCache;if(h[o])return h[o];let g=r.cK(t,this);return h[o]=g,h[o]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let t=1/this.worldSize,o=r.bn([],[t,t,t]);return r.az(o,o,this.globeMatrix),o}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let t=this._elevation;this._updateCameraState();let o=r.cb(1,this._center.lat)*this.worldSize,h=this._computeCameraPosition(o),g=this._camera.forward(),_=r.cb(1,this._center.lat);h[2]/=_,g[2]/=_,r.au(g,g);let v=t.raycast(h,g,t.exaggeration());if(v){let E=r.bE([],h,g,v),T=new r.ac(E[0],E[1],r.cb(E[2],r.aY(E[1]))),C=(T.z+r.ae([T.x-h[0],T.y-h[1],T.z-h[2]*_]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(C),this._centerAltitude=T.toAltitude(),this._center=this.coordinateLocation(T),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;let o=this._elevation,h=r.cb(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(h),_=o.getAtPointOrZero(new r.ac(...g)),v=this.pixelsPerMeter/this.worldSize*_,E=this._minimumHeightOverTerrain(),T=g[2]-v;if(T<=E)if(T<0||t){let C=this.locationCoordinate(this._center,this._centerAltitude),A=[g[0],g[1],C.z-g[2]],L=r.ae(A);A[2]-=(E-T)/this._pixelsPerMercatorPixel;let R=r.ae(A);if(R===0)return;r.c1(A,A,L/R*this._pixelsPerMercatorPixel),this._camera.position=[g[0],g[1],C.z*this._pixelsPerMercatorPixel-A[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){let R=this.center;return R.lat=r.ay(R.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(R.lng=r.ay(R.lng,this.minLng,this.maxLng)),this.center=R,void(this._constraining=!1)}let o=this._unmodified,{x:h,y:g}=this.point,_=0,v=h,E=g,T=this.width/2,C=this.height/2,A=this.worldMinY*this.scale,L=this.worldMaxY*this.scale;if(g-C<A&&(E=A+C),g+C>L&&(E=L-C),L-A<this.height&&(_=Math.max(_,this.height/(L-A)),E=(L+A)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let R=this.worldMinX*this.scale,k=this.worldMaxX*this.scale,V=this.worldSize/2-(R+k)/2;v=(h+V+this.worldSize)%this.worldSize-V,v-T<R&&(v=R+T),v+T>k&&(v=k-T),k-R<this.width&&(_=Math.max(_,this.width/(k-R)),v=(k+R)/2)}v===h&&E===g||this._allowWorldUnderZoom||(this.center=this.unproject(new r.P(v,E))),_&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(_)),this._constrainCamera(),this._unmodified=o,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let t=this.centerOffset,o=this.projection.name==="globe",h=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=r.cb(1,this.center.lat)/r.cb(1,r.c$));let g=r.cL(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,g),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let _=this.projection.zAxisUnit==="meters"?h:1,v=this._camera.getWorldToCamera(this.worldSize,_),E,T=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(T[8]=2*-t.x/this.width,T[9]=2*t.y/this.height,this.isOrthographic){let oe=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),se=oe*this.aspect,Ee=-se,me=-oe;se-=t.x,Ee-=t.x,oe+=t.y,me+=t.y,E=this._camera.getCameraToClipOrthographic(Ee,se,me,oe,this._nearZ,this._farZ),((Ne,Ce,Be,Qe)=>{for(let Te=0;Te<16;Te++)Ne[Te]=r.ai(Ce[Te],Be[Te],Qe)})(E,E,T,r.cZ(this.pitch>=fr?1:this.pitch/fr))}else E=T;let C=r.cM([],T,v),A=r.cM([],E,v);if(this.projection.isReprojectedInTileSpace){let oe=this.locationCoordinate(this.center),se=r.bx([]);r.bo(se,se,[oe.x*this.worldSize,oe.y*this.worldSize,0]),r.az(se,se,r.cN(this)),r.bo(se,se,[-oe.x*this.worldSize,-oe.y*this.worldSize,0]),r.az(A,A,se),r.az(C,C,se),this.inverseAdjustmentMatrix=r.cO(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=r.cP([],A,[this.worldSize,this.worldSize,this.worldSize/_,1]),this.projMatrix=A,this.invProjMatrix=r.bi(new Float64Array(16),this.projMatrix),o){let oe=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);oe[8]=2*-t.x/this.width,oe[9]=2*t.y/this.height,this.expandedFarZProjMatrix=r.cM([],oe,v)}else this.expandedFarZProjMatrix=this.projMatrix;let L=r.bi([],E);this.frustumCorners=r.cQ.fromInvProjectionMatrix(L,this.horizonLineFromTop(),this.height),this.cameraFrustum=r.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!o);let R=new Float32Array(16);r.bx(R),r.cP(R,R,[1,-1,1]),r.cR(R,R,this._pitch),r.by(R,R,this.angle);let k=r.c9(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=r.bw(k);let V=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;k[8]=2*-t.x/this.width,k[9]=2*(t.y+V)/this.height,this.skyboxMatrix=r.az(R,k,R);let z=this.point,U=z.x,j=z.y,W=this.width%2/2,Y=this.height%2/2,J=Math.cos(this.angle),ie=Math.sin(this.angle),le=U-Math.round(U)+J*W+ie*Y,ue=j-Math.round(j)+J*Y+ie*W,re=new Float64Array(A);if(r.bo(re,re,[le>.5?le-1:le,ue>.5?ue-1:ue,0]),this.alignedProjMatrix=re,A=r.bz(),r.cP(A,A,[this.width/2,-this.height/2,1]),r.bo(A,A,[1,-1,0]),this.labelPlaneMatrix=A,A=r.bz(),r.cP(A,A,[1,-1,1]),r.bo(A,A,[-1,-1,0]),r.cP(A,A,[2/this.width,2/this.height,1]),this.glCoordMatrix=A,this.pixelMatrix=r.az(new Float64Array(16),this.labelPlaneMatrix,C),this._calcFogMatrices(),this._distanceTileDataCache={},A=r.bi(new Float64Array(16),this.pixelMatrix),!A)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=A,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=r.cS(this);let oe=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=r.ad(oe,oe,v),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=A;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let t=this.cameraWorldSizeForFog,o=this.cameraPixelsPerMeter,h=this._camera.position,g=1/this.height/this._pixelsPerMercatorPixel,_=[t,t,o];r.c1(_,_,g),r.c1(h,h,-1),r.cT(h,h,_);let v=r.bz();r.bo(v,v,h),r.cP(v,v,_),this.mercatorFogMatrix=v,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,o,g)}_computeCameraPosition(t){let o=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,h=this._camera.forward(),g=this.point,_=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*o-t/this.worldSize*this._centerAltitude;return[g.x/this.worldSize-h[0]*_,g.y/this.worldSize-h[1]*_,t/this.worldSize*this._centerAltitude-h[2]*_]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){let o=this._maxCameraBoundsDistance()*Math.cos(this._pitch),h=this._camera.position[2],g=t[2],_=1;this.projection.wrap&&(this.center=this.center.wrap()),g>0&&(_=Math.min((o-h)/g,1)),this._camera.position=r.bE([],this._camera.position,t,_),this._updateStateFromCamera()}_updateStateFromCamera(){let t=this._camera.position,o=this._camera.forward(),{pitch:h,bearing:g}=this._camera.getPitchBearing(),_=r.cb(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,v=this._mercatorZfromZoom(this._maxZoom)*Math.cos(r.al(this._maxPitch)),E=Math.max((t[2]-_)/Math.cos(h),v),T=this._zoomFromMercatorZ(E);r.bE(t,t,o,E),this._pitch=r.ay(h,r.al(this.minPitch),r.al(this.maxPitch)),this.angle=r.bQ(g,-Math.PI,Math.PI),this._setZoom(r.ay(T,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new r.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){let t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let o=0,h=r.cI,g=0,_=1/0;for(;h-o>1e-6&&h>o;){let v=o+.5*(h-o),E=this.tileSize*Math.pow(2,v),T=this.getCameraToCenterDistance(this.projection,v,E),C=this.scaleZoom(T/(Math.max(0,t)*this.tileSize)),A=Math.abs(v-C);A<_&&(_=A,g=v),v<C?o=v:h=v}return g}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(r.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,o){let h=Math.min(t.x,o.x),g=Math.max(t.x,o.x),_=Math.min(t.y,o.y),v=Math.max(t.y,o.y);if(_<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let E=[new r.P(h,_),new r.P(g,v),new r.P(h,v),new r.P(g,_)],T=this.renderWorldCopies?-3:0,C=this.renderWorldCopies?4:1;for(let A of E){let L=this.pointRayIntersection(A);if(L.t<0)return!0;let R=this.rayIntersectionCoordinate(L);if(R.x<T||R.y<0||R.x>C||R.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+r.cU(this.fovAboveCenter)>88||this.anyCornerOffEdge(new r.P(0,0),new r.P(this.width,this.height))}zoomDeltaToMovement(t,o){let h=r.ae(r.at([],this._camera.position,t)),g=this._zoomFromMercatorZ(h)+o;return h-this._mercatorZfromZoom(g)}getCameraPoint(){if(this.projection.name==="globe"){let t=function([o,h,g],_){let v=[o,h,g,1];r.aA(v,v,_);let E=v[3]=Math.max(v[3],1e-6);return v[0]/=E,v[1]/=E,v[2]/=E,v}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new r.P(t[0],t[1])}{let t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new r.P(0,t))}}getCameraToCenterDistance(t,o=this.zoom,h=this.worldSize){let g=r.cL(t,o,this.width,this.height,1024),_=t.pixelSpaceConversion(this.center.lat,h,g),v=.5/Math.tan(.5*this._fov)*this.height*_;return this.isOrthographic&&(v=r.ai(1,v,r.cZ(this.pitch>=fr?1:this.pitch/fr))),v}getWorldToCameraMatrix(){let t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&r.az(t,t,this.globeMatrix),t}getFrustum(t){return r.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}let xs=(u,t)=>{if(t>0&&u.terrain&&r.w("Cutoff is currently disabled on terrain"),t<=0||u.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let o=u.transform,h=Math.max(Math.abs(o._zoom-(u.minCutoffZoom-1)),1),g=o.isLODDisabled(!1)?r.af(60,45,o.pitch):r.af(30,15,o.pitch),_=o._farZ-o._nearZ,v=t*o.height,E=((1-(T=g))*o.cameraToCenterDistance+T*(o._farZ+v))*h;var T;return{shouldRenderCutoff:g<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(E-o._nearZ)/_,(E-v-o._nearZ)/_]}}},Or={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Pu{constructor(t,o){this.aabb=t,this.lastCascade=o}}class fb{add(t,o){let h=this.receivers[t.key];h!==void 0?(h.aabb.min[0]=Math.min(h.aabb.min[0],o.min[0]),h.aabb.min[1]=Math.min(h.aabb.min[1],o.min[1]),h.aabb.min[2]=Math.min(h.aabb.min[2],o.min[2]),h.aabb.max[0]=Math.max(h.aabb.max[0],o.max[0]),h.aabb.max[1]=Math.max(h.aabb.max[1],o.max[1]),h.aabb.max[2]=Math.max(h.aabb.max[2],o.max[2])):this.receivers[t.key]=new Pu(o,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,o,h){let g=r.d6.fromPoints(t.points),_=0;for(let v in this.receivers){let E=this.receivers[v];if(!E||!g.intersectsAabb(E.aabb))continue;E.aabb.min=g.closestPoint(E.aabb.min),E.aabb.max=g.closestPoint(E.aabb.max);let T=E.aabb.getCorners();for(let C=0;C<h.length;C++){let A=!0;for(let L of T){let R=[L[0]*o,L[1]*o,L[2]];if(r.ad(R,R,h[C].matrix),R[0]<-1||R[0]>1||R[1]<-1||R[1]>1){A=!1;break}}if(E.lastCascade=C,_=Math.max(_,C),A)break}}return _+1}}class pb{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new fb,this._depthMode=new pt(t.context.gl.LEQUAL,pt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(Or,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(Or,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(Or,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,o){let h=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!o||!o.properties)return;let g=o.properties.get("shadow-intensity");if(!o.shadowsEnabled()||g<=0||(this._shadowLayerCount=h.style.order.reduce((V,z)=>{let U=h.style._mergedLayers[z];return V+(U.hasShadowPass()&&!U.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let _=h.context,v=Or.shadowMapResolution,E=Or.shadowMapResolution;if(this._cascades.length===0||Or.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let V=0;V<Or.cascadeCount;++V){let z=h._shadowMapDebug,U=_.gl,j=_.createFramebuffer(v,E,z,"texture"),W=new r.T(_,{width:v,height:E,data:null},U.DEPTH_COMPONENT16);if(j.depthAttachment.set(W.texture),z){let Y=new r.T(_,{width:v,height:E,data:null},U.RGBA8);j.colorAttachment.set(Y.texture)}this._cascades.push({framebuffer:j,texture:W,matrix:[],far:0,boundingSphereRadius:0,frustum:new r.cy,scale:0})}}this.shadowDirection=ec(o);let T=0;if(t.elevation){let V=t.elevation,z=[1e4,-1e4];V.visibleDemTiles.filter(U=>U.dem).forEach(U=>{let j=U.dem.tree;z[0]=Math.min(z[0],j.minimums[0]),z[1]=Math.max(z[1],j.maximums[0])}),z[0]!==1e4&&(T=(z[1]-z[0])*V.exaggeration())}let C=1.5*t.cameraToCenterDistance,A=3*C,L=new Float64Array(16);for(let V=0;V<this._cascades.length;++V){let z=this._cascades[V],U=t.height/50,j=1;Or.cascadeCount===1?j=A:V===0?j=C:(U=C,j=A);let[W,Y]=tc(t,this.shadowDirection,U,j,Or.shadowMapResolution,T);z.scale=t.scale,z.matrix=W,z.boundingSphereRadius=Y,r.bi(L,z.matrix),z.frustum=r.cy.fromInvProjectionMatrix(L,1,0,!0),z.far=j}let R=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[R].far,this._cascades[R].far],this._uniformValues.u_shadow_intensity=g,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Or.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Or.shadowMapResolution,this._uniformValues.u_shadowmap_0=Vr.ShadowMap0,this._uniformValues.u_shadowmap_1=Vr.ShadowMap0+1,this._groundShadowTiles=h.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let k=h.transform.elevation;for(let V of this._groundShadowTiles){let z={min:0,max:0};if(k){let U=k.getMinMaxForTile(V);U&&(z=U)}this.addShadowReceiver(V.toUnwrapped(),z.min,z.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,o){if(!this.enabled)return;let h=this.painter,g=h.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(h.transform.getFrustum(0),h.transform.worldSize,this._cascades),g.viewport.set([0,0,Or.shadowMapResolution,Or.shadowMapResolution]);for(let _=0;_<this._numCascadesToRender;++_){h.currentShadowCascade=_,g.bindFramebuffer.set(this._cascades[_].framebuffer.framebuffer),g.clear({color:r.am.white,depth:1});for(let v of t.order){let E=t._mergedLayers[v];if(!E.hasShadowPass()||E.isHidden(h.transform.zoom))continue;let T=t.getLayerSourceCache(E),C=T?o[T.id]:void 0;(E.type==="model"||C&&C.length)&&h.renderLayer(h,T,E,C)}}h.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let t=this.painter,o=t.style,h=t.context,g=h.gl,_=o.directionalLight,v=o.ambientLight;if(!_||!v)return;let E=[],T=xs(t,t.longestCutoffRange);T.shouldRenderCutoff&&E.push("RENDER_CUTOFF"),E.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&E.push("NORMAL_OFFSET");let C=sl(o,_,v),A=new pt(g.LEQUAL,pt.ReadOnly,t.depthRangeFor3D),L=new Lt({func:g.EQUAL,mask:255},0,255,g.KEEP,g.KEEP,g.KEEP);for(let R of this._groundShadowTiles){let k=R.toUnwrapped(),V=t.isTileAffectedByFog(R),z=t.getOrCreateProgram("groundShadow",{defines:E,overrideFog:V});this.setupShadows(k,z),t.uploadCommonUniforms(h,z,k,null,T);let U={u_matrix:t.transform.calculateProjMatrix(k),u_ground_shadow_factor:C};z.draw(t,g.TRIANGLES,A,L,Yt.multiply,At.disabled,U,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Yt.unblended:Yt.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){let o=this.painter.transform,h=o.calculatePosMatrix(t,o.worldSize);return r.az(h,this._cascades[this.painter.currentShadowCascade].matrix,h),Float32Array.from(h)}calculateShadowPassMatrixFromMatrix(t){return r.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,o,h){if(!this.enabled)return;let g=this.painter.transform,_=this.painter.context,v=_.gl,E=this._uniformValues,T=new Float64Array(16),C=g.calculatePosMatrix(t,g.worldSize);for(let A=0;A<this._cascades.length;A++)r.az(T,this._cascades[A].matrix,C),E[A===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(T),_.activeTexture.set(v.TEXTURE0+Vr.ShadowMap0+A),this._cascades[A].texture.bindExtraParam(v.LINEAR,v.LINEAR,v.CLAMP_TO_EDGE,v.CLAMP_TO_EDGE,v.GREATER);if(this.useNormalOffset=!!h,this.useNormalOffset){let A=r.d4(t.canonical),L=2/g.tileSize*r.aj/Or.shadowMapResolution,R=L*this._cascades[0].boundingSphereRadius,k=L*this._cascades[this._cascades.length-1].boundingSphereRadius,V=(h==="vector-tile"?1:3)*function(z,U,j,W,Y){let J=r.ay((z-22)/-22,0,1);return .125*(1-J)+4*J}(g.zoom);E.u_shadow_normal_offset=[A,R*V,k*V],E.u_shadow_bias=[1e-4,.0012,.012]}else E.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(_,E)}setupShadowsFromMatrix(t,o,h=!1){if(!this.enabled)return;let g=this.painter.context,_=g.gl,v=this._uniformValues,E=new Float64Array(16);for(let T=0;T<Or.cascadeCount;T++)r.az(E,this._cascades[T].matrix,t),v[T===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(E),g.activeTexture.set(_.TEXTURE0+Vr.ShadowMap0+T),this._cascades[T].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=h,h){let T=Or.normalOffset;v.u_shadow_normal_offset=[1,T,T],v.u_shadow_bias=[6e-5,.0012,.012]}else v.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(g,v)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,o,h,g){if(g[2]>=0)return{};let _=function(T,C,A){let L=A/(1<<T.canonical.z);return new r.d6([T.canonical.x*L+T.wrap*A,T.canonical.y*L+T.wrap*A,0],[(T.canonical.x+1)*L+T.wrap*A,(T.canonical.y+1)*L+T.wrap*A,C])}(t,o,h).getCorners(),v=o/-g[2];g[0]<0?(r.d5(_[0],_[0],[g[0]*v,0,0]),r.d5(_[3],_[3],[g[0]*v,0,0])):g[0]>0&&(r.d5(_[1],_[1],[g[0]*v,0,0]),r.d5(_[2],_[2],[g[0]*v,0,0])),g[1]<0?(r.d5(_[0],_[0],[0,g[1]*v,0]),r.d5(_[1],_[1],[0,g[1]*v,0])):g[1]>0&&(r.d5(_[2],_[2],[0,g[1]*v,0]),r.d5(_[3],_[3],[0,g[1]*v,0]));let E={};return E.vertices=_,E.planes=[ya(_[1],_[0],_[4]),ya(_[2],_[1],_[5]),ya(_[3],_[2],_[6]),ya(_[0],_[3],_[7])],E}addShadowReceiver(t,o,h){this._receivers.add(t,r.d6.fromTileIdAndHeight(t,o,h))}getMaxCascadeForTile(t){let o=this._receivers.get(t);return o&&o.lastCascade?o.lastCascade:0}}function ya(u,t,o){let h=r.at([],o,t),g=r.at([],u,t),_=r.bF([],h,g),v=r.ae(_);return v===0?[0,0,1,0]:(r.c1(_,_,1/v),[_[0],_[1],_[2],-r.bG(_,t)])}function ec(u){let t=u.properties.get("direction"),o=r.d1(t.x,t.y,t.z);o[2]=r.ay(o[2],0,75);let h=r.d3([o[0],o[1],o[2]]);return r.d2(h.x,h.y,h.z)}function sl(u,t,o){let h=t.properties.get("color-use-theme")==="none",g=t.properties.get("color"),_=t.properties.get("intensity"),v=t.properties.get("direction"),E=[v.x,v.y,v.z],T=o.properties.get("color-use-theme")==="none",C=o.properties.get("color"),A=o.properties.get("intensity"),L=Math.max(r.bG([0,0,1],E),0),R=[0,0,0];r.c1(R,C.toPremultipliedRenderColor(T?null:u.getLut(t.scope)).toArray01Linear().slice(0,3),A);let k=[0,0,0];return r.c1(k,g.toPremultipliedRenderColor(h?null:u.getLut(o.scope)).toArray01Linear().slice(0,3),L*_),r.d8([R[0]>0?R[0]/(R[0]+k[0]):0,R[1]>0?R[1]/(R[1]+k[1]):0,R[2]>0?R[2]/(R[2]+k[2]):0])}function tc(u,t,o,h,g,_){let v=u.zoom,E=u.scale,T=u.worldSize,C=1/T,A=u.aspect,L=Math.sqrt(1+A*A)*Math.tan(.5*u.fovX),R=L*L,k=h-o,V=h+o,z,U;R>k/V?(z=h,U=h*L):(z=.5*V*(1+R),U=.5*Math.sqrt(k*k+2*(h*h+o*o)*R+V*V*R*R));let j=u.projection.pixelsPerMeter(u.center.lat,T),W=u._camera.getCameraToWorldMercator(),Y=[0,0,-z*C];r.ad(Y,Y,W);let J=U*C,ie=u._edgeInsets;if(!(ie.left===0&&ie.top===0&&ie.right===0&&ie.bottom===0||ie.left===ie.right&&ie.top===ie.bottom)){let He=u._camera.getWorldToCamera(u.worldSize,u.projection.zAxisUnit==="meters"?j:1),$e=u._camera.getCameraToClipPerspective(u._fov,u.width/u.height,o,h);$e[8]=2*-u.centerOffset.x/u.width,$e[9]=2*u.centerOffset.y/u.height;let qe=new Float64Array(16);r.cM(qe,$e,He);let ot=new Float64Array(16);r.bi(ot,qe);let xt=r.cy.fromInvProjectionMatrix(ot,T,v,!0);for(let St of xt.points){let dt=((le=St)[0]/=E,le[1]/=E,le[2]=r.cb(le[2],u._center.lat),le);J=Math.max(J,r.c2(r.d7([],Y,dt)))}}var le;J*=g/(g-1);let ue=Math.acos(t[2]),re=Math.atan2(-t[0],-t[1]),oe=new Zo;oe.position=Y,oe.setPitchBearing(ue,re);let se=oe.getWorldToCamera(T,j),Ee=J*T,me=Math.min(u._mercatorZfromZoom(17)*T*-2,-2*Ee),Ne=oe.getCameraToClipOrthographic(-Ee,Ee,-Ee,Ee,me,(Ee+_*j)/t[2]),Ce=new Float64Array(16);r.az(Ce,Ne,se);let Be=r.d2(Math.floor(1e6*Y[0])/1e6*T,Math.floor(1e6*Y[1])/1e6*T,0),Qe=.5*g,Te=[0,0,0];r.ad(Te,Be,Ce),r.c1(Te,Te,Qe);let pe=[Math.floor(Te[0]),Math.floor(Te[1]),Math.floor(Te[2])],Pe=[0,0,0];r.at(Pe,Te,pe),r.c1(Pe,Pe,-1/Qe);let Ie=new Float64Array(16);return r.bx(Ie),r.bo(Ie,Ie,Pe),r.az(Ce,Ie,Ce),[Ce,Ee]}class H_ extends r.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,o){return r.aS(this.requestManager.transformRequest(o,r.R.Model).url).then(h=>{if(!h)return;let g=r.aT(h),_=new r.aU(t,void 0,void 0,g);return _.computeBoundsAndApplyParent(),_}).catch(h=>{if(h&&h.status===404)return null;this.fire(new r.z(new Error(`Could not load model ${t} from ${o}: ${h.message}`)))})}load(t,o,h={forceReload:!1}){this.models[o]||(this.models[o]={});let g=Object.keys(t),_=[],v=[];for(let E of g){let T=t[E];this.hasURLBeenRequested(T)&&!h.forceReload||(this.modelByURL[T]={modelId:E,scope:o},_.push(this.loadModel(E,T)),v.push(E)),this.models[o][E]||(this.models[o][E]={model:null,numReferences:1})}this.numModelsLoading[o]=(this.numModelsLoading[o]||0)+v.length,Promise.allSettled(_).then(E=>{for(let T=0;T<E.length;T++){let{status:C}=E[T];if(C==="rejected")continue;let{value:A}=E[T];this.models[o][v[T]]||(this.models[o][v[T]]={model:null,numReferences:1}),this.models[o][v[T]].model=A}this.numModelsLoading[o]-=v.length,this.fire(new r.A("data",{dataType:"style"}))}).catch(E=>{this.fire(new r.z(new Error(`Could not load models: ${E.message}`)))})}isLoaded(){for(let t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,o,h={exactIdMatch:!1}){return!!(h.exactIdMatch?this.getModel(t,o):this.getModelByURL(this.modelUris[o][t]))}getModel(t,o){return this.models[o]||(this.models[o]={}),this.models[o][t]?this.models[o][t].model:void 0}getModelByURL(t){if(!t)return null;let o=this.modelByURL[t];return o?this.models[o.scope][o.modelId].model:null}hasModelBeenAdded(t,o){return this.models[o]&&this.models[o][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,o,h){this.models[h]||(this.models[h]={}),this.modelUris[h]||(this.modelUris[h]={});let g=this.requestManager.normalizeModelURL(o);if((this.hasModel(t,h,{exactIdMatch:!0})||this.hasModelBeenAdded(t,h))&&this.modelUris[h][t]===g)this.models[h][t].numReferences++;else if(this.hasURLBeenRequested(g)){let{scope:_,modelId:v}=this.modelByURL[g];this.models[_][v].numReferences++}else this.modelUris[h][t]=g,this.load({[t]:this.modelUris[h][t]},h)}addModelURLs(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h=this.modelUris[o];for(let g in t)h[g]=this.requestManager.normalizeModelURL(t[g])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h={};for(let g of t)this.hasModel(g,o,{exactIdMatch:!0})||this.hasURLBeenRequested(g)?this.models[o][g].numReferences++:this.modelUris[o][g]&&!this.hasURLBeenRequested(g)?h[g]=this.modelUris[o][g]:!this.hasURLBeenRequested(g)&&r.d9(g,!1)&&(this.modelUris[o][g]=this.requestManager.normalizeModelURL(g),h[g]=this.modelUris[o][g]);this.load(h,o)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,o,h=!1,g=!1){if(this.models[o]&&this.models[o][t]&&(this.models[o][t].numReferences--,this.models[o][t].numReferences===0||g)){let _=this.modelUris[o][t];h||delete this.modelUris[o][t],delete this.modelByURL[_];let v=this.models[o][t].model;if(!v)return;delete this.models[o][t],v.destroy()}}destroy(){for(let t of Object.keys(this.models))for(let o of Object.keys(this.models[t])){let h=this.models[t][o].model;delete this.models[t][o],h&&h.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,o){this.models[o]||(this.models[o]={});for(let h in this.models[o])this.models[o][h].model&&this.models[o][h].model.upload(t.context)}}let rh=new r.a7({data:new r.a8(r.a5.colorTheme.data)});class Ep{constructor(t){this._scope=t,this._buildingQueryParams={target:{featuresetId:"building-outline",importId:this._scope}},this._floorQueryParams={target:{featuresetId:"floor-outline",importId:this._scope}}}execute(t){let o=this._makeBuildingsQueryArea(t),h=this._makeFloorsQueryArea(t),g=t.queryRenderedFeatures(o,this._buildingQueryParams).filter(E=>E.properties.shape_type==="building").reduce((E,T)=>{let C=T.properties.id;return T.properties.shape_type!=="building"||E.some(A=>A.properties.id===C)||E.push(T),E},[]),_=t.queryRenderedFeatures(h,this._floorQueryParams).filter(E=>E.properties.shape_type==="floor").reduce((E,T)=>{let C=T.properties.id;return T.properties.shape_type!=="floor"||E.some(A=>A.properties.id===C)||E.push(T),E},[]),v=[t.getCenter().lng,t.getCenter().lat];return{floors:_,building:this._findBuildingAtCenter(v,g)||(g.length>0?g[0]:null)}}_makeBuildingsQueryArea(t){let o=t.transform.width,h=t.transform.height,g=Math.min(o,h),_=g*(1/8),v=g*(1/8),E=.5*(o-_),T=.5*(h-v);return[new r.P(E,T),new r.P(E+_,T+v)]}_makeFloorsQueryArea(t){let o=t.transform.width,h=t.transform.height,g=o*(2/3),_=h*(2/3),v=.5*(o-g),E=.5*(h-_);return[new r.P(v,E),new r.P(v+g,E+_)]}_findBuildingAtCenter(t,o){for(let h of o)if(h.geometry.type==="Polygon"&&this._pointInPolygon(t,h.geometry.coordinates[0]))return h;return null}_pointInPolygon(t,o){let h=!1;for(let g=0,_=o.length-1;g<o.length;_=g++){let v=o[g][0],E=o[g][1],T=o[_][1];E>t[1]!=T>t[1]&&t[0]<(o[_][0]-v)*(t[1]-E)/(T-E)+v&&(h=!h)}return h}}class va{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}setBuildingId(t){this._selectedBuildingId=t}setFloors(t){if(this._floors=t.filter(o=>o.properties.building_id===this._selectedBuildingId),!this._selectedFloorId||!this._floors.map(o=>o.properties.id).includes(this._selectedFloorId)){let o=this._floors.map(h=>({id:h.properties.id,level:h.properties.floor_level})).reduce((h,g)=>{let _=Math.abs(h.level-1),v=Math.abs(g.level-1);return v<_||v===_&&g.level>h.level?g:h});this._selectedFloorId=o.id}}setFloorId(t){this._selectedFloorId=t}getSelectedFloorId(){return this._selectedFloorId}getCurrentBuildingFloors(){return this._floors}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}}let mb={"mbx-indoor-level-selected":{default:["literal",[]]}};function $_(u){return u=u||{},Object.assign(u,mb)}class gb extends r.E{constructor(t){super(),r.aV(["_onLoad","_onMove"],this),this._map=t,this._floorSelectionState=new va,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=null,this._floorSelectionState=null}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new r.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=t.scope,this._indoorDataQuery=new Ep(this._scope)))}),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<16)return void this._clearIndoorData();let t=this._indoorDataQuery.execute(this._map);t&&t.floors.length!==0?(this._floorSelectionState.getSelectedFloorId()||this._map._addIndoorControl(),this._selectFloors(t)):this._clearIndoorData()}_selectFloors(t){if(t.building)this._floorSelectionState.setBuildingId(t.building.properties.id),this._floorSelectionState.setFloors(t.floors),this._updateUI();else{let o=this._floorSelectionState.getSelectedFloorId();if(o&&t.floors.some(h=>h.properties.id===o))return;this._clearIndoorData()}}_clearIndoorData(){this._floorSelectionState.reset(),this._map._removeIndoorControl(),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[]])}_updateUI(){let t=this._floorSelectionState.getCurrentBuildingFloors().map(h=>({id:h.properties.id,name:h.properties.name,shortName:h.properties.floor_level,levelOrder:h.properties.floor_level})),o=this._floorSelectionState.getSelectedFloorId();o?(this._updateIndoorConfig(),this.fire(new r.A("indoorupdate",{selectedFloorId:o,floors:t}))):console.warn("IndoorManager: Selected floor is not set")}_updateIndoorConfig(){let t=this._floorSelectionState.getSelectedFloorId();t?this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[t]]):console.warn("IndoorManager: Selected floor is not set")}selectFloor(t){this._floorSelectionState.setFloorId(t),this._updateIndoorConfig()}}function G_(u){if(!u.metadata||!u.metadata.content_area)return;let t=r.q.devicePixelRatio,{left:o,top:h,width:g,height:_}=u.metadata.content_area,v=o*t,E=h*t;return[v,E,v+g*t,E+_*t]}function q_(u){if(u)return u.map(([t,o])=>[t*r.q.devicePixelRatio,o*r.q.devicePixelRatio])}class Tp{constructor(t,o,h){this.id=t,this.scope=o,this.sourceCache=h,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){let t=new Map;if(!this.sourceCache.loaded())return t;let o=this.sourceCache.getVisibleCoordinates();if(o.length===0)return t;let h=this.sourceCache.getSource();if(!(h instanceof pa))return t;let g=o.map(v=>this.sourceCache.getTile(v)),_=h.getImages(g,Array.from(this.pendingRequests));for(let[v,E]of _)t.set(r.I.from({name:v,iconsetId:this.id}),E),this.pendingRequests.delete(v);for(let v of this.pendingRequests)this.missingRequests.add(v);return this.pendingRequests.clear(),t}}let xa=(u,t)=>ne(u,t&&t.filter(o=>o.identifier!=="source.canvas")),W_=r.aF(xn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),Z_=r.aF(xn,["setCenter","setZoom","setBearing","setPitch"]),oh=new Set(["background","sky","slot","custom"]),ba={version:8,layers:[],sources:{}},Ou={duration:300,delay:0};class Xo extends r.E{constructor(t,o={}){super(),this.map=t,this.scope=o.scope||"",this.globalId=null,this.fragments=[],this.importDepth=o.importDepth||0,this.importsCache=o.importsCache||new Map,this.resolvedImports=o.resolvedImports||new Set,this.transition=r.h({},Ou),this._buildingIndex=new k_(this),this.crossTileSymbolIndex=new to,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=o.styleChanges||new ou,this.dispatcher=o.dispatcher?o.dispatcher:new r.D(r.db(),this),o.imageManager?this.imageManager=o.imageManager:(this.imageManager=new zi(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=o.glyphManager?o.glyphManager:new r.dc(t._requestManager,o.localFontFamily?r.dd.all:o.localIdeographFontFamily?r.dd.ideographs:r.dd.none,o.localFontFamily||o.localIdeographFontFamily),o.modelManager?this.modelManager=o.modelManager:(this.modelManager=new H_(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=o.configOptions?o.configOptions:new Map,this._configDependentLayers=o.configDependentLayers?o.configDependentLayers:new Set,this._config=o.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:o.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=o.initialConfig,this.dispatcher.broadcast("setReferrer",r.de());let h=this;this._rtlTextPluginCallback=Xo.registerForPluginStateChange(g=>{h.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:g.pluginStatus,pluginURL:g.pluginURL},(_,v)=>{if(r.df(_),v&&v.every(E=>E))for(let E in h._sourceCaches){let T=h._sourceCaches[E],C=T.getSource().type;C!=="vector"&&C!=="geojson"||T.reload()}})}),this.on("data",g=>{if(g.dataType!=="source"||g.sourceDataType!=="metadata")return;let _=this.getOwnSource(g.sourceId);if(_&&_.vectorLayerIds)for(let v in this._layers){let E=this._layers[v];E.source===_.id&&this._validateLayer(E)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(r.j(t))return t;let o=r.dg(t);if(!o.startsWith("http"))try{return new URL(o,location.href).toString()}catch{return o}return o}return`json://${r.dh(JSON.stringify(t))}`}_diffStyle(t,o,h){this.globalId=this._getGlobalId(t);let g=(_,v)=>{try{v(null,this.setState(_,h))}catch(E){v(E,!1)}};if(typeof t=="string"){let _=this.map._requestManager.normalizeStyleURL(t),v=this.map._requestManager.transformRequest(_,r.R.Style);r.n(v,(E,T)=>{E?this.fire(new r.z(E)):T&&g(T,o)})}else typeof t=="object"&&g(t,o)}loadURL(t,o={}){this.fire(new r.A("dataloading",{dataType:"style"}));let h=typeof o.validate=="boolean"?o.validate:!r.j(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,o.accessToken),this.resolvedImports.add(t);let g=this.importsCache.get(t);if(g)return this._load(g,h);let _=this.map._requestManager.transformRequest(t,r.R.Style);this._request=r.n(_,(v,E)=>{if(this._request=null,v)this.fire(new r.z(v));else if(E)return this.importsCache.set(t,E),this._load(E,h)})}loadJSON(t,o={}){this.fire(new r.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=r.q.frame(()=>{this._request=null,this._load(t,o.validate!==!1)})}loadEmpty(){this.fire(new r.A("dataloading",{dataType:"style"})),this._load(ba,!1)}_loadImports(t,o,h){if(this.importDepth>=4)return r.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let g=[];for(let _ of t){let v=this._createFragmentStyle(_),E=new Promise(A=>{v.once("style.import.load",A),v.once("error",A)}).then(()=>this.mergeAll());if(g.push(E),this.resolvedImports.has(_.url)){v.loadEmpty();continue}let T=_.data||this.importsCache.get(_.url);T?(v.loadJSON(T,{validate:o}),this._isInternalStyle(T)&&(v.globalId=null)):_.url?v.loadURL(_.url,{validate:o}):v.loadEmpty();let C={style:v,id:_.id,config:_.config};if(h){let A=this.fragments.findIndex(({id:L})=>L===h);this.fragments=this.fragments.slice(0,A).concat(C).concat(this.fragments.slice(A))}else this.fragments.push(C)}return Promise.allSettled(g)}getImportGlobalIds(t=this,o=new Set){for(let h of t.fragments)h.style.globalId&&o.add(h.style.globalId),this.getImportGlobalIds(h.style,o);return[...o.values()]}_createFragmentStyle(t){let o=this.scope?r.C(t.id,this.scope):t.id,h,g=this._initialConfig&&this._initialConfig[o];(t.config||g)&&(h=r.h({},t.config,g));let _=new Xo(this.map,{scope:o,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:h,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return _.setEventedParent(this.map,{style:_}),_}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,o){let h=t.indoor?$_(t.schema):t.schema;if(this._isInternalStyle(t)){let v=r.h({},ba,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(v,o)}if(this.updateConfig(this._config,h),o&&xa(this,To(t)))return;this._loaded=!0,this.stylesheet=r.di(t);let g=()=>{for(let C in t.sources)this.addSource(C,t.sources[C],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(let C in t.iconsets)this.addIconset(C,t.iconsets[C]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);let v=vu(this.stylesheet.layers);if(this._order=v.map(C=>C.id),this.stylesheet.light&&r.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let C=this.stylesheet.lights[0];this.light=new Ae(C.properties,C.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Ae(this.stylesheet.light)),this._layers={};for(let C of v){let A=r.dn(C,this.scope,this._styleColorTheme.lut,this.options);A.configDependencies.size!==0&&this._configDependentLayers.add(A.fqid),A.setEventedParent(this,{layer:{id:A.id}}),this._layers[A.id]=A;let L=this.getOwnLayerSourceCache(A),R=!!this.directionalLight&&this.directionalLight.shadowsEnabled();L&&A.canCastShadows()&&R&&(L.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);let E=this.stylesheet.terrain;E&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(E,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new r.A("data",{dataType:"style"}));let T=this.isRootStyle();t.imports?this._loadImports(t.imports,o).then(()=>{this._reloadImports(),this.fire(new r.A(T?"style.load":"style.import.load"))}).catch(C=>{this.fire(new r.z(new Error("Failed to load imports",C))),this.fire(new r.A(T?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new r.A(T?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let _=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(_){let v=this._evaluateColorThemeData(_);this._loadColorTheme(v).then(()=>{g()}).catch(E=>{r.w(`Couldn't load color theme from the stylesheet: ${E}`),g()})}else this._styleColorTheme.lut=null,g()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,o,h,g,_,v,E,T,C,A,L={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(R=>{if(R.stylesheet){if(R.light!=null&&(t=R.light),R.stylesheet.lights)for(let k of R.stylesheet.lights)k.type==="ambient"&&R.ambientLight!=null&&(o=R.ambientLight),k.type==="directional"&&R.directionalLight!=null&&(h=R.directionalLight);g=this._prioritizeTerrain(g,R.terrain,R.stylesheet.terrain),R.stylesheet.fog&&R.fog!=null&&(_=R.fog),R.stylesheet.snow&&R.snow!=null&&(v=R.snow),R.stylesheet.rain&&R.rain!=null&&(E=R.rain),R.stylesheet.camera!=null&&(A=R.stylesheet.camera),R.stylesheet.projection!=null&&(T=R.stylesheet.projection),R.stylesheet.transition!=null&&(C=R.stylesheet.transition),L[R.scope]=R._styleColorTheme}}),this.light=t,this.ambientLight=o,this.directionalLight=h,this.fog=_,this.snow=v,this.rain=E,this._styleColorThemeForScope=L,g===null?delete this.terrain:this.terrain=g,this.camera=A||{"camera-projection":"perspective"},this.projection=T||{name:"mercator"},this.transition=r.h({},Ou,C),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){let o=h=>{for(let g of h.fragments)o(g.style);t(h)};o(this)}_prioritizeTerrain(t,o,h){let g=t&&t.drapeRenderMode===0;return h===null?o&&o.drapeRenderMode===0?o:g?t:null:o!=null&&(!t||g||o&&o.drapeRenderMode===1)?o:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(o=>{t=this._prioritizeTerrain(t,o.terrain,o.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(o=>{o.stylesheet.projection!=null&&(t=o.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){let t={},o={},h={};this.forEachFragmentStyle(g=>{for(let _ in g._sourceCaches){let v=r.C(_,g.scope);t[v]=g._sourceCaches[_]}for(let _ in g._otherSourceCaches){let v=r.C(_,g.scope);o[v]=g._otherSourceCaches[_]}for(let _ in g._symbolSourceCaches){let v=r.C(_,g.scope);h[v]=g._symbolSourceCaches[_]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=o,this._mergedSymbolSourceCaches=h}mergeLayers(){let t={},o=[],h={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(_=>{for(let v of _._order){let E=_._layers[v];if(E.type==="slot"){let T=r.dj(v);if(t[T])continue;t[T]=[]}E.slot&&t[E.slot]?t[E.slot].push(E):o.push(E)}}),this._mergedOrder=[];let g=(_=[])=>{for(let v of _)if(v.type==="slot"){let E=r.dj(v.id);t[E]&&g(t[E]),this._mergedSlots.push(E)}else{let E=r.C(v.id,v.scope);this._mergedOrder.push(E),h[E]=v,v.is3D(!!this.terrain)&&(this._has3DLayers=!0),v.type==="circle"&&(this._hasCircleLayers=!0),v.type==="symbol"&&(this._hasSymbolLayers=!0),v.type==="clip"&&(this._clipLayerPresent=!0)}};g(o),this._mergedOrder.sort((_,v)=>{let E=h[_],T=h[v];return E.hasInitialOcclusionOpacityProperties?T.is3D(!!this.terrain)?1:0:E.is3D(!!this.terrain)&&T.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=h,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=r.h({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(o,h,g,_){let v=r.h({},h);for(let T of Object.keys(r.a5.colorTheme))v[T]===void 0&&(v[T]=r.a5.colorTheme[T].default);let E=new r.a6(rh,o,new Map(g));return E.setTransitionOrValue(v,g),E.untransitioned().possiblyEvaluate(new r.aa(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let o=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((h,g)=>{let _="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void h();let v=t;v.startsWith(_)||(v=_+v);let E=r.I.from("mapbox-reserved-lut"),T=new Image;T.src=v,T.onerror=()=>{this._styleColorTheme.lutLoading=!1,g(new Error("Failed to load image data"))},T.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==o)return void h();this._styleColorTheme.lutLoading=!1;let{width:C,height:A,data:L}=r.q.getImageData(T);if(A>32)return void g(new Error("The height of the image must be less than or equal to 32 pixels."));if(C!==A*A)return void g(new Error("The width of the image must be equal to the height squared."));this.getImage(E)&&this.removeImage(E),this.addImage(E,{data:new r.r({width:C,height:A},L),pixelRatio:1,sdf:!1,usvg:!1,version:0});let R=this.imageManager.getImage(E,this.scope);R?(this._styleColorTheme.lut={image:R.data,data:t},h()):g(new Error("Missing LUT image."))}})}getLut(t){let o=this._styleColorThemeForScope[t];return o?o.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(o,h,g){let _,v,E,T=r.q.devicePixelRatio>1?"@2x":"",C=r.n(h.transformRequest(h.normalizeSpriteURL(o,T,".json"),r.R.SpriteJSON),(R,k)=>{C=null,E||(E=R,_=k,L())}),A=r.o(h.transformRequest(h.normalizeSpriteURL(o,T,".png"),r.R.SpriteImage),(R,k)=>{A=null,E||(E=R,v=k,L())});function L(){if(E)g(E);else if(_&&v){let R=r.q.getImageData(v),k={};for(let V in _){let{width:z,height:U,x:j,y:W,sdf:Y,pixelRatio:J,stretchX:ie,stretchY:le,content:ue}=_[V],re=new r.r({width:z,height:U});r.r.copy(R,re,{x:j,y:W},{x:0,y:0},{width:z,height:U},null),k[V]={data:re,pixelRatio:J,sdf:Y,stretchX:ie,stretchY:le,content:ue,usvg:!1}}g(null,k)}}return{cancel(){C&&(C.cancel(),C=null),A&&(A.cancel(),A=null)}}}(t,this.map._requestManager,(o,h)=>{if(this._spriteRequest=null,o)this.fire(new r.z(o));else if(h){let g=new Map;for(let _ in h)g.set(r.I.from(_),h[_]);this.addImages(g)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new r.A("data",{dataType:"style"}))})}addIconset(t,o){if(o.type==="sprite")return void this._loadSprite(o.url);let h=this.getOwnSourceCache(o.source);if(!h)return void this.fire(new r.z(new Error(`Source "${o.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));let g=h.getSource();if(g.type!=="raster-array")return void this.fire(new r.z(new Error(`Source "${o.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));g.partial=!1;let _=new Tp(t,this.scope,h);this.imageManager.addImageProvider(_,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!r.j(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);let o=this.map._spriteFormat==="auto";var h,g;this._spriteRequest=(g=(_,v)=>{if(this._spriteRequest=null,_)o?this._loadSprite(t):this.fire(new r.z(_));else if(v){let E=new Map;for(let T in v)E.set(r.I.from(T),v[T]);this.addImages(E)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new r.A("data",{dataType:"style"}))},r.br((h=this.map._requestManager).transformRequest(h.normalizeIconsetURL(t),r.R.Iconset),(_,v)=>{if(_)return void g(_);let E={},T=r.da(new r.bq(v));for(let C of T.icons){let A={version:1,pixelRatio:r.q.devicePixelRatio,content:G_(C),stretchX:C.metadata?q_(C.metadata.stretch_x_areas):void 0,stretchY:C.metadata?q_(C.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:C};E[C.name]=A}g(null,E)}))}_validateLayer(t){let o=this.getOwnSource(t.source);if(!o)return;let h=t.sourceLayer;h&&(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(h)===-1)&&this.fire(new r.z(new Error(`Source layer "${h}" does not exist on source "${o.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,o)=>{let h=this.fragments[o];return h&&h.style&&(t.data=h.style.serialize()),t})}_serializeSources(){let t={};for(let o in this._sourceCaches){let h=this._sourceCaches[o].getSource();t[h.id]||(t[h.id]=h.serialize())}return t}_serializeLayers(t){let o=[];for(let h of t){let g=this._layers[h];g&&g.type!=="custom"&&o.push(g.serialize())}return o}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(let t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){let o=this.getOwnLayer(t);if(o)return o;this.fire(new r.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){let o=this.getOwnSource(t);if(o)return o;this.fire(new r.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,o){let h=this.map.painter;if(h)for(let g=t.minzoom||0;g<(t.maxzoom||25.5);g++){let _=t.getProgramIds();if(_)for(let v of _){let E=t.getDefaultProgramParams(v,o.zoom,this._styleColorTheme.lut);E&&(h.style=this,this.fog&&(h._fogVisible=!0,E.overrideFog=!0,h.getOrCreateProgram(v,E)),h._fogVisible=!1,E.overrideFog=!1,h.getOrCreateProgram(v,E),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(E.overrideRtt=!0,h.getOrCreateProgram(v,E)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);let o=this.calculateLightsBrightness();t.brightness=o||0,o!==this._brightness&&(this._brightness=o,this.dispatcher.broadcast("setBrightness",o)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));let h=this._changes.isDirty(),g=!1;if(this._changes.isDirty()){let E=this._changes.getLayerUpdatesByScope();for(let T in E){let{updatedIds:C,removedIds:A}=E[T];(C||A)&&(this._updateWorkerLayers(T,C,A),g=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}let _={};for(let E in this._mergedSourceCaches){let T=this._mergedSourceCaches[E];_[E]=T.used,T.used=!1,T.tileCoverLift=0}for(let E of this._mergedOrder){let T=this._mergedLayers[E];if(T.recalculate(t,this._availableImages),!T.isHidden(t.zoom)){let C=this.getLayerSourceCache(T);C&&(C.used=!0,C.tileCoverLift=Math.max(C.tileCoverLift,T.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(T,t)}):this.precompilePrograms(T,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&g&&this.mergeLayers();let v=this.imageManager.getPendingImageProviders();for(let E of v)E.sourceCache.used=!0;for(let E in _){let T=this._mergedSourceCaches[E];_[E]!==T.used&&T.getSource().fire(new r.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:T.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),h&&this.fire(new r.A("data",{dataType:"style"}))}updateImageProviders(){let t=this.imageManager.getPendingImageProviders();for(let o of t){let h=o.resolvePendingRequests(),g=this.getFragmentStyle(o.scope);g&&g.addImages(h)}}_updateTilesForChangedImages(){let t={};for(let o in this._mergedSourceCaches){let h=this._mergedSourceCaches[o].getSource().scope;t[h]=t[h]||this._changes.getUpdatedImages(h),t[h].length!==0&&this._mergedSourceCaches[o].reloadTilesForDependencies(["icons","patterns"],t[h])}for(let o in t)this._changes.resetUpdatedImages(o)}_updateWorkerLayers(t,o,h){let g=this.getFragmentStyle(t);g&&this.dispatcher.broadcast("updateLayers",{layers:o?g._serializeLayers(o):[],scope:t,removedIds:h||[],options:g.options})}setState(t,o){if(this._checkLoaded(),xa(this,To(t)))return!1;(t=r.di(t)).layers=vu(t.layers);let h=function(v,E){if(!v)return[{command:xn.setStyle,args:[E]}];let T=[];try{if(!r.bv(v.version,E.version))return[{command:xn.setStyle,args:[E]}];if(r.bv(v.center,E.center)||T.push({command:xn.setCenter,args:[E.center]}),r.bv(v.zoom,E.zoom)||T.push({command:xn.setZoom,args:[E.zoom]}),r.bv(v.bearing,E.bearing)||T.push({command:xn.setBearing,args:[E.bearing]}),r.bv(v.pitch,E.pitch)||T.push({command:xn.setPitch,args:[E.pitch]}),r.bv(v.sprite,E.sprite)||T.push({command:xn.setSprite,args:[E.sprite]}),r.bv(v.glyphs,E.glyphs)||T.push({command:xn.setGlyphs,args:[E.glyphs]}),r.bv(v.imports,E.imports)||function(k=[],V=[],z){V=V||[];let U=(k=k||[]).map(tl),j=V.map(tl),W=k.reduce(ma,{}),Y=V.reduce(ma,{}),J=U.slice(),ie,le,ue,re;for(ie=0,le=0;ie<U.length;ie++)ue=U[ie],Y.hasOwnProperty(ue)?le++:(z.push({command:xn.removeImport,args:[ue]}),J.splice(J.indexOf(ue,le),1));for(ie=0,le=0;ie<j.length;ie++)ue=j[j.length-1-ie],J[J.length-1-ie]!==ue&&(W.hasOwnProperty(ue)?(z.push({command:xn.removeImport,args:[ue]}),J.splice(J.lastIndexOf(ue,J.length-le),1)):le++,re=J[J.length-ie],z.push({command:xn.addImport,args:[Y[ue],re]}),J.splice(J.length-ie,0,ue));for(let oe of V){let se=W[oe.id];se&&(delete se.data,r.bv(se,oe)||z.push({command:xn.updateImport,args:[oe.id,oe]}))}}(v.imports,E.imports,T),r.bv(v.transition,E.transition)||T.push({command:xn.setTransition,args:[E.transition]}),r.bv(v.light,E.light)||T.push({command:xn.setLight,args:[E.light]}),r.bv(v.fog,E.fog)||T.push({command:xn.setFog,args:[E.fog]}),r.bv(v.snow,E.snow)||T.push({command:xn.setSnow,args:[E.snow]}),r.bv(v.rain,E.rain)||T.push({command:xn.setRain,args:[E.rain]}),r.bv(v.projection,E.projection)||T.push({command:xn.setProjection,args:[E.projection]}),r.bv(v.lights,E.lights)||T.push({command:xn.setLights,args:[E.lights]}),r.bv(v.camera,E.camera)||T.push({command:xn.setCamera,args:[E.camera]}),r.bv(v.iconsets,E.iconsets)||function(k,V,z){let U;for(U in V=V||{},k=k||{})k.hasOwnProperty(U)&&(V.hasOwnProperty(U)||z.push({command:xn.removeIconset,args:[U]}));for(U in V){if(!V.hasOwnProperty(U))continue;let j=V[U];k.hasOwnProperty(U)?r.bv(k[U],j)||(z.push({command:xn.removeIconset,args:[U]}),z.push({command:xn.addIconset,args:[U,j]})):z.push({command:xn.addIconset,args:[U,j]})}}(v.iconsets,E.iconsets,T),!r.bv(v["color-theme"],E["color-theme"]))return[{command:xn.setStyle,args:[E]}];let C={},A=[];(function(k,V,z,U){let j;for(j in V=V||{},k=k||{})k.hasOwnProperty(j)&&(V.hasOwnProperty(j)||ql(j,z,U));for(j in V){if(!V.hasOwnProperty(j))continue;let W=V[j];k.hasOwnProperty(j)?r.bv(k[j],W)||(k[j].type==="geojson"&&W.type==="geojson"&&db(k,V,j)?z.push({command:xn.setGeoJSONSourceData,args:[j,W.data]}):xu(j,V,z,U)):Jd(j,V,z)}})(v.sources,E.sources,A,C);let L=[];v.layers&&v.layers.forEach(k=>{k.source&&C[k.source]?T.push({command:xn.removeLayer,args:[k.id]}):L.push(k)});let R=v.terrain;R&&C[R.source]&&(T.push({command:xn.setTerrain,args:[void 0]}),R=void 0),T=T.concat(A),r.bv(R,E.terrain)||T.push({command:xn.setTerrain,args:[E.terrain]}),function(k,V,z){V=V||[];let U=(k=k||[]).map(tl),j=V.map(tl),W=k.reduce(ma,{}),Y=V.reduce(ma,{}),J=U.slice(),ie=Object.create(null),le,ue,re,oe,se,Ee,me;for(le=0,ue=0;le<U.length;le++)re=U[le],Y.hasOwnProperty(re)?ue++:(z.push({command:xn.removeLayer,args:[re]}),J.splice(J.indexOf(re,ue),1));for(le=0,ue=0;le<j.length;le++)re=j[j.length-1-le],J[J.length-1-le]!==re&&(W.hasOwnProperty(re)?(z.push({command:xn.removeLayer,args:[re]}),J.splice(J.lastIndexOf(re,J.length-ue),1)):ue++,Ee=J[J.length-le],z.push({command:xn.addLayer,args:[Y[re],Ee]}),J.splice(J.length-le,0,re),ie[re]=!0);for(le=0;le<j.length;le++)if(re=j[le],oe=W[re],se=Y[re],!ie[re]&&!r.bv(oe,se))if(r.bv(oe.source,se.source)&&r.bv(oe["source-layer"],se["source-layer"])&&r.bv(oe.type,se.type)){for(me in bu(oe.layout,se.layout,z,re,null,xn.setLayoutProperty),bu(oe.paint,se.paint,z,re,null,xn.setPaintProperty),r.bv(oe.slot,se.slot)||z.push({command:xn.setSlot,args:[re,se.slot]}),r.bv(oe.filter,se.filter)||z.push({command:xn.setFilter,args:[re,se.filter]}),r.bv(oe.minzoom,se.minzoom)&&r.bv(oe.maxzoom,se.maxzoom)||z.push({command:xn.setLayerZoomRange,args:[re,se.minzoom,se.maxzoom]}),oe)oe.hasOwnProperty(me)&&me!=="layout"&&me!=="paint"&&me!=="filter"&&me!=="metadata"&&me!=="minzoom"&&me!=="maxzoom"&&me!=="slot"&&(me.indexOf("paint.")===0?bu(oe[me],se[me],z,re,me.slice(6),xn.setPaintProperty):r.bv(oe[me],se[me])||z.push({command:xn.setLayerProperty,args:[re,me,se[me]]}));for(me in se)se.hasOwnProperty(me)&&!oe.hasOwnProperty(me)&&me!=="layout"&&me!=="paint"&&me!=="filter"&&me!=="metadata"&&me!=="minzoom"&&me!=="maxzoom"&&me!=="slot"&&(me.indexOf("paint.")===0?bu(oe[me],se[me],z,re,me.slice(6),xn.setPaintProperty):r.bv(oe[me],se[me])||z.push({command:xn.setLayerProperty,args:[re,me,se[me]]}))}else z.push({command:xn.removeLayer,args:[re]}),Ee=J[J.lastIndexOf(re)+1],z.push({command:xn.addLayer,args:[se,Ee]})}(L,E.layers,T)}catch(C){console.warn("Unable to compute style diff:",C),T=[{command:xn.setStyle,args:[E]}]}return T}(this.serialize(),t).filter(v=>!(v.command in Z_));if(h.length===0)return!1;let g=h.filter(v=>!(v.command in W_));if(g.length>0)throw new Error(`Unimplemented: ${g.map(v=>v.command).join(", ")}.`);let _=[];return h.forEach(v=>{_.push(this[v.command](...v.args))}),o&&Promise.all(_).then(o).catch(o),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(let[o,h]of t.entries()){if(this.getImage(o))return this.fire(new r.z(new Error(`An image with the name "${o.name}" already exists.`)));this.imageManager.addImage(o,this.scope,h),this._changes.updateImage(o,this.scope)}return this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this}addImage(t,o){return this.getImage(t)?this.fire(new r.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,o),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this)}updateImage(t,o,h=!1){this.imageManager.updateImage(t,this.scope,o),h&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this):this.fire(new r.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new r.A("data",{dataType:"style"})),this}addModel(t,o,h={}){return this._checkLoaded(),this._validate(te,`models.${t}`,o,null,h)||(this.modelManager.addModel(t,o,this.scope),this.fire(new r.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new r.A("data",{dataType:"style"})),this):this.fire(new r.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,o,h={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!o.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(o).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(o.type)>=0&&this._validate(uu,`sources.${t}`,o,null,h))return;this.map&&this.map._collectResourceTiming&&(o.collectResourceTiming=!0);let g=fu(t,o,this.dispatcher,this);g.scope=this.scope,g.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(g.id),source:g.serialize(),sourceId:g.id}));let _=v=>{let E=(v?"symbol:":"other:")+g.id,T=r.C(E,this.scope),C=this._sourceCaches[E]=new eo(T,g,v);(v?this._symbolSourceCaches:this._otherSourceCaches)[g.id]=C,C.onAdd(this.map)};_(!1),o.type!=="vector"&&o.type!=="geojson"||_(!0),g.onAdd&&g.onAdd(this.map),h.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();let o=this.getOwnSource(t);if(!o)throw new Error("There is no source with this ID");for(let g in this._layers)if(this._layers[g].source===t)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while layer "${g}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){let g=Object.entries(this.stylesheet.iconsets).find(([_,v])=>v.type==="source"&&v.source===t);if(g)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while iconset "${g[0]}" is using it.`)))}let h=this.getOwnSourceCaches(t);for(let g of h){let _=r.dj(g.id);delete this._sourceCaches[_],this._changes.discardSourceCacheUpdate(g.id),g.fire(new r.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:g.getSource().id})),g.setEventedParent(null),g.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),o.setEventedParent(null),o.onRemove&&o.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,o){this._checkLoaded(),this.getOwnSource(t).setData(o),this._changes.setDirty()}getOwnSource(t){let o=this.getOwnSourceCache(t);return o&&o.getSource()}getOwnSources(){let t=[];for(let o in this._otherSourceCaches){let h=this.getOwnSourceCache(o);h&&t.push(h.getSource())}return t}areTilesLoaded(){let t=this._mergedSourceCaches;for(let o in t){let h=t[o]._tiles;for(let g in h){let _=h[g];if(_.state!=="loaded"&&_.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;let o=this._getTransitionParameters();for(let _ of t){if(this._validate(Hl,"lights",_))return;switch(_.type){case"ambient":if(this.ambientLight){let v=this.ambientLight;v.set(_),v.updateTransitions(o)}else this.ambientLight=new Gn(_,fn||(fn=new r.a7({color:new r.a8(r.a5.properties_light_ambient.color),"color-use-theme":new r.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new r.a8(r.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let v=this.directionalLight;v.set(_),v.updateTransitions(o)}else this.directionalLight=new Gn(_,Pi||(Pi=new r.a7({direction:new r.an(r.a5.properties_light_directional.direction),color:new r.a8(r.a5.properties_light_directional.color),"color-use-theme":new r.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new r.a8(r.a5.properties_light_directional.intensity),"cast-shadows":new r.a8(r.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new r.a8(r.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new r.a8(r.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let h=Object.assign(o,{worldview:this.map.getWorldview()}),g=new r.aa(this.z||0,h);this.ambientLight&&this.ambientLight.recalculate(g),this.directionalLight&&this.directionalLight.recalculate(g),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let t=this.directionalLight,o=this.ambientLight;if(!t||!o)return;let h=R=>.2126*(R[0]<=.03928?R[0]/12.92:Math.pow((R[0]+.055)/1.055,2.4))+.7152*(R[1]<=.03928?R[1]/12.92:Math.pow((R[1]+.055)/1.055,2.4))+.0722*(R[2]<=.03928?R[2]/12.92:Math.pow((R[2]+.055)/1.055,2.4)),g=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),_=t.properties.get("intensity"),v=t.properties.get("direction"),E=1-r.d1(v.x,v.y,v.z)[2]/90,T=h(g)*_*E,C=o.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),A=o.properties.get("intensity"),L=h(C)*A;return Number(((T+L)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(r.dk(t)){let o=r.dl(t),h=this.fragments.find(({id:_})=>_===o);if(!h)return;let g=r.dj(t);return h.style.getFragmentStyle(g)}{let o=this.fragments.find(({id:h})=>h===t);return o?o.style:void 0}}setFeaturesetSelectors(t){if(!t)return;let o={},h=(g,_="")=>`${g}::${_}`;this._featuresetSelectors={};for(let g in t){let _=this._featuresetSelectors[g]=[];for(let v of t[g].selectors){if(v.featureNamespace){let T=this.getOwnLayer(v.layer);if(!T){r.w(`Layer is undefined for selector: ${v.layer}`);continue}let C=h(T.source,T.sourceLayer);if(C in o&&o[C]!==v.featureNamespace){r.w(`"featureNamespace ${v.featureNamespace} of featureset ${g}'s selector is not associated to the same source, skip this selector`);continue}o[C]=v.featureNamespace}let E;if(v.properties)for(let T in v.properties){let C=r.X(v.properties[T]);C.result==="success"&&(E=E||{},E[T]=C.value)}_.push({layerId:v.layer,namespace:v.featureNamespace,properties:E,uniqueFeatureID:v._uniqueFeatureID})}}}getFeaturesetDescriptors(t){let o=this.getFragmentStyle(t);if(!o||!o.stylesheet.featuresets)return[];let h=[];for(let g in o.stylesheet.featuresets)h.push({featuresetId:g,importId:o.scope?o.scope:void 0});return h}getFeaturesetLayers(t,o){let h=this.getFragmentStyle(o),g=h.stylesheet.featuresets;if(!g||!g[t])return this.fire(new r.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];let _=[];for(let v of g[t].selectors){let E=h.getOwnLayer(v.layer);E&&_.push(E)}return _}getConfigProperty(t,o){let h=this.getFragmentStyle(t);if(!h)return null;let g=r.C(o,h.scope),_=h.options.get(g),v=_?_.value||_.default:null;return v?v.serialize():null}setConfigProperty(t,o,h){let g=this.getFragmentStyle(t);if(!g)return;let _=g.stylesheet.indoor?$_(g.stylesheet.schema):g.stylesheet.schema;if(!_||!_[o])return;let v=r.X(h);if(v.result!=="success")return void xa(this,v.value);let E=v.value.expression,T=r.C(o,g.scope),C=g.options.get(T);if(!C)return;let A,{minValue:L,maxValue:R,stepValue:k,type:V,values:z}=_[o],U=r.X(_[o].default);U.result==="success"&&(A=U.value.expression),A?(this.options.set(T,Object.assign({},C,{value:E,default:A,minValue:L,maxValue:R,stepValue:k,type:V,values:z})),this.updateConfigDependencies(o)):this.fire(new r.z(new Error(`No schema defined for the config option "${o}" in the "${t}" fragment.`)))}getConfig(t){let o=this.getFragmentStyle(t);if(!o)return null;let h=o.stylesheet.schema;if(!h)return null;let g={};for(let _ in h){let v=r.C(_,o.scope),E=o.options.get(v),T=E?E.value||E.default:null;g[_]=T?T.serialize():null}return g}setConfig(t,o){let h=this.getFragmentStyle(t);h&&(h.updateConfig(o,h.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){let o=this.getFragmentStyle(t);return o?o.stylesheet.schema:null}setSchema(t,o){let h=this.getFragmentStyle(t);h&&(h.stylesheet.schema=o,h.updateConfig(h._config,o),this.updateConfigDependencies())}updateConfig(t,o){if(this._config=t,t||o)if(o)for(let h in o){let g,_,v=r.X(o[h].default);if(v.result==="success"&&(g=v.value.expression),t&&t[h]!==void 0){let R=r.X(t[h]);R.result==="success"&&(_=R.value.expression)}let{minValue:E,maxValue:T,stepValue:C,type:A,values:L}=o[h];if(g){let R=r.C(h,this.scope);this.options.set(R,{default:g,value:_,minValue:E,maxValue:T,stepValue:C,type:A,values:L})}else this.fire(new r.z(new Error(`No schema defined for config option "${h}".`)))}else this.fire(new r.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(let o of this._configDependentLayers){let h=this.getLayer(o);if(h){if(t&&!h.configDependencies.has(t))continue;h.possiblyEvaluateVisibility(),this._updateLayer(h)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(o=>{let h=o._styleColorTheme.colorThemeOverride?o._styleColorTheme.colorThemeOverride:o._styleColorTheme.colorTheme;if(h){let g=o._evaluateColorThemeData(h);(!o._styleColorTheme.lut&&g!==""||o._styleColorTheme.lut&&g!==o._styleColorTheme.lut.data)&&o.setColorTheme(h)}}),this._changes.setDirty()}addLayer(t,o,h={}){this._checkLoaded();let g=t.id;if(this._layers[g])return void this.fire(new r.z(new Error(`Layer with id "${g}" already exists on this map`)));let _;if(t.type==="custom"){if(xa(this,r.dm(t)))return;_=r.dn(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(g,t.source),t=r.di(t),t=r.h(t,{source:g})),this._validate(Sn,`layers.${g}`,t,{arrayIndex:-1},h))return;_=r.dn(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(_),_.setEventedParent(this,{layer:{id:g}})}_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid);let v=this._order.length;if(o){let A=this._order.indexOf(o);if(A===-1)return void this.fire(new r.z(new Error(`Layer with id "${o}" does not exist on this map.`)));_.slot===this._layers[o].slot?v=A:r.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,g),this._layerOrderChanged=!0,this._layers[g]=_;let E=this.getOwnLayerSourceCache(_),T=!!this.directionalLight&&this.directionalLight.shadowsEnabled();E&&_.canCastShadows()&&T&&(E.castsShadows=!0);let C=this._changes.getRemovedLayer(_);if(C&&_.source&&E&&_.type!=="custom"){this._changes.discardLayerRemoval(_);let A=r.C(_.source,_.scope);C.type!==_.type?this._changes.updateSourceCache(A,"clear"):(this._changes.updateSourceCache(A,"reload"),E.pause())}this._updateLayer(_),_.onAdd&&_.onAdd(this.map),_.scope=this.scope,this.mergeLayers()}moveLayer(t,o){this._checkLoaded();let h=this._checkLayer(t);if(!h||t===o)return;let g=this._order.indexOf(t);this._order.splice(g,1);let _=this._order.length;if(o){let v=this._order.indexOf(o);if(v===-1)return void this.fire(new r.z(new Error(`Layer with id "${o}" does not exist on this map.`)));h.slot===this._layers[o].slot?_=v:r.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();let o=this._checkLayer(t);if(!o)return;o.setEventedParent(null);let h=this._order.indexOf(t);this._order.splice(h,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(o.fqid),this._changes.removeLayer(o);let g=this.getOwnLayerSourceCache(o);if(g&&g.castsShadows){let _=!1;for(let v in this._layers)if(this._layers[v].source===o.source&&this._layers[v].canCastShadows()){_=!0;break}g.castsShadows=_}o.onRemove&&o.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(let o in this._layers)if(this._layers[o].type===t)return!0;return!1}setLayerZoomRange(t,o,h){this._checkLoaded();let g=this._checkLayer(t);g&&(g.minzoom===o&&g.maxzoom===h||(o!=null&&(g.minzoom=o),h!=null&&(g.maxzoom=h),this._updateLayer(g)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,o){this._checkLoaded();let h=this._checkLayer(t);h&&h.slot!==o&&(h.slot=o,this._updateLayer(h))}setFilter(t,o,h={}){this._checkLoaded();let g=this._checkLayer(t);if(g&&!r.bv(g.filter,o))return o==null?(g.filter=void 0,void this._updateLayer(g)):void(this._validate(Se,`layers.${g.id}.filter`,o,{layerType:g.type},h)||(g.filter=r.di(o),this._updateLayer(g)))}getFilter(t){let o=this._checkLayer(t);if(o)return r.di(o.filter)}setLayoutProperty(t,o,h,g={}){this._checkLoaded();let _=this._checkLayer(t);if(_&&!r.bv(_.getLayoutProperty(o),h)){if(h!=null&&(!g||g.validate!==!1)&&xa(_,q.call(To,{key:`layers.${t}.layout.${o}`,layerType:_.type,objectKey:o,value:h,styleSpec:r.a5,style:{glyphs:!0,sprite:!0}})))return;_.setLayoutProperty(o,h),_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),this._updateLayer(_)}}getLayoutProperty(t,o){let h=this._checkLayer(t);if(h)return h.getLayoutProperty(o)}setPaintProperty(t,o,h,g={}){this._checkLoaded();let _=this._checkLayer(t);if(!_||r.bv(_.getPaintProperty(o),h)||h!=null&&(!g||g.validate!==!1)&&xa(_,$.call(To,{key:`layers.${t}.paint.${o}`,layerType:_.type,objectKey:o,value:h,styleSpec:r.a5})))return;let v=_.setPaintProperty(o,h);_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),v&&this._updateLayer(_),this._changes.updatePaintProperties(_)}getPaintProperty(t,o){let h=this._checkLayer(t);if(h)return h.getPaintProperty(o)}setFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:C}=t.target,A=this.getFragmentStyle(C),L=A.getFeaturesetLayers(T);for(let{source:R,sourceLayer:k}of L)A.setFeatureState({id:t.id,source:R,sourceLayer:k},o)}else if("layerId"in t.target){let{layerId:T}=t.target,C=this.getLayer(T);this.setFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},o)}return}let h=t.source,g=t.sourceLayer,_=this._checkSource(h);if(!_)return;let v=_.type;if(v==="geojson"&&g)return void this.fire(new r.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(v==="vector"&&!g)return void this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new r.z(new Error("The feature id parameter must be provided.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.setFeatureState(g,t.id,o)}removeFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:C}=t.target,A=this.getFragmentStyle(C),L=A.getFeaturesetLayers(T);for(let{source:R,sourceLayer:k}of L)A.removeFeatureState({id:t.id,source:R,sourceLayer:k},o)}else if("layerId"in t.target){let{layerId:T}=t.target,C=this.getLayer(T);this.removeFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},o)}return}let h=t.source,g=this._checkSource(h);if(!g)return;let _=g.type,v=_==="vector"?t.sourceLayer:void 0;if(_==="vector"&&!v)return void this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(o&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new r.z(new Error("A feature id is required to remove its specific state property.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.removeFeatureState(v,t.id,o)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let _;if("featuresetId"in t.target){let{featuresetId:v,importId:E}=t.target,T=this.getFragmentStyle(E),C=T.getFeaturesetLayers(v);for(let{source:A,sourceLayer:L}of C){let R=T.getFeatureState({id:t.id,source:A,sourceLayer:L});if(R&&!_)_=R;else if(!r.bv(_,R))return void this.fire(new r.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){let{layerId:v}=t.target,E=this.getLayer(v);_=this.getFeatureState({id:t.id,source:E.source,sourceLayer:E.sourceLayer})}return _}let o=t.source,h=t.sourceLayer,g=this._checkSource(o);if(g){if(g.type!=="vector"||h)return t.id===void 0&&this.fire(new r.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(o)[0].getFeatureState(h,t.id);this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=r.h({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return r.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();let t=this.getTerrain(),o=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return r.dp({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:o,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},h=>h!==void 0)}_updateFilteredLayers(t){for(let o of Object.values(this._mergedLayers))t(o)&&this._updateLayer(o)}_updateLayer(t){this._changes.updateLayer(t);let o=this.getLayerSourceCache(t),h=r.C(t.source,t.scope),g=this._changes.getUpdatedSourceCaches();t.source&&!g[h]&&o&&o.getSource().type!=="raster"&&(this._changes.updateSourceCache(h,"reload"),o.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){let o=E=>this._mergedLayers[E].is3D(!!this.terrain),h=this.order,g={},_=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T)){g[T]=E;for(let C of t){let A=C[T];if(A)for(let L of A)_.push(L)}}}_.sort((E,T)=>T.intersectionZ-E.intersectionZ);let v=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T))for(let C=_.length-1;C>=0;C--){let A=_[C].feature;if(A.layer&&g[A.layer.id]<E)break;v.push(A),_.pop()}else for(let C of t){let A=C[T];if(A)for(let L of A)v.push(L.feature)}}return v}queryRenderedFeatures(t,o,h){let g;o&&!Array.isArray(o)&&o.filter&&(this._validate(Se,"queryRenderedFeatures.filter",o.filter,null,o),g=r.b3(o.filter));let _={},v=A=>{if(oh.has(A.type))return;let L=this.getOwnLayerSourceCache(A),R=_[L.id]=_[L.id]||{sourceCache:L,layers:{},has3DLayers:!1};A.is3D(!!this.terrain)&&(R.has3DLayers=!0),R.layers[A.fqid]=R.layers[A.fqid]||{styleLayer:A,targets:[]},R.layers[A.fqid].targets.push({filter:g})};if(o&&o.layers){if(!Array.isArray(o.layers))return this.fire(new r.z(new Error("parameters.layers must be an Array."))),[];for(let A of o.layers){let L=this._layers[A];if(!L)return this.fire(new r.z(new Error(`The layer '${A}' does not exist in the map's style and cannot be queried for features.`))),[];v(L)}}else for(let A in this._layers)v(this._layers[A]);let E=this._queryRenderedFeatures(t,_,h),T=this._flattenAndSortRenderedFeatures(E),C=[];for(let A of T)r.dq(A.layer.id)===this.scope&&C.push(A);return C}queryRenderedFeatureset(t,o,h){let g;o&&!Array.isArray(o)&&o.filter&&(this._validate(Se,"queryRenderedFeatures.filter",o.filter,null,o),g=r.b3(o.filter));let _="mock",v=[];if(o&&o.target)v.push(Object.assign({},o,{targetId:_,filter:g}));else{let A=this.getFeaturesetDescriptors();for(let L of A)v.push({targetId:_,filter:g,target:L});for(let{style:L}of this.fragments){let R=L.getFeaturesetDescriptors();for(let k of R)v.push({targetId:_,filter:g,target:k})}}let E=this.queryRenderedTargets(t,v,h),T=[],C=new Set;for(let A of E)for(let L of A.variants[_])Xd(L,A,C)||T.push(new r.dr(A,L));return T}queryRenderedTargets(t,o,h){let g={},_=(E,T,C,A)=>{let L=g[T.id]=g[T.id]||{sourceCache:T,layers:{},has3DLayers:!1};if(L.layers[E.fqid]=L.layers[E.fqid]||{styleLayer:E,targets:[]},E.is3D(!!this.terrain)&&(L.has3DLayers=!0),!A)return C.uniqueFeatureID=!1,void L.layers[E.fqid].targets.push(C);L.layers[E.fqid].targets.push(Object.assign({},C,{namespace:A.namespace,properties:A.properties,uniqueFeatureID:A.uniqueFeatureID}))};for(let E of o)if("featuresetId"in E.target){let{featuresetId:T,importId:C}=E.target,A=this.getFragmentStyle(C);if(!A||!A._featuresetSelectors)continue;let L=A._featuresetSelectors[T];if(!L){this.fire(new r.z(new Error(`The featureset '${T}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let R of L){let k=A.getOwnLayer(R.layerId);k&&!oh.has(k.type)&&_(k,A.getOwnLayerSourceCache(k),E,R)}}else if("layerId"in E.target){let{layerId:T}=E.target,C=this.getLayer(T);if(!C||oh.has(C.type))continue;_(C,this.getLayerSourceCache(C),E)}let v=this._queryRenderedFeatures(t,g,h);return this._flattenAndSortRenderedFeatures(v)}_queryRenderedFeatures(t,o,h){let g=[],_=!!this.map._showQueryGeometry,v=An.createFromScreenPoints(t,h);for(let E in o){let T=Yd(v,o[E],this._availableImages,h,_);Object.keys(T).length&&g.push(T)}if(this.placement)for(let E in o){if(!o[E].sourceCache._onlySymbols)continue;let T=Ja(v.screenGeometry,o[E],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(T).length&&g.push(T)}return g}querySourceFeatures(t,o){let h=o&&o.filter;h&&this._validate(Se,"querySourceFeatures.filter",h,null,o);let g=[],_=this.getOwnSourceCaches(t);for(let v of _)g=g.concat(mu(v,o));return g}addSourceType(t,o,h){return Xo.getSourceType(t)?h(new Error(`A source type called "${t}" already exists.`)):(Xo.setSourceType(t,o),o.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:o.workerSourceURL},h):h(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,o,h={}){this._checkLoaded();let g=this.light.getLight(),_=!1;for(let E in t)if(!r.bv(t[E],g[E])){_=!0;break}if(!_)return;let v=this._getTransitionParameters();this.light.setLight(t,o,h),this.light.updateTransitions(v)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=r.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&r.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,o=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),o===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let h=t,g=t.source==null;if(o===1){if(this.disableElevatedTerrain)return;if(typeof h.source=="object"){let E="terrain-dem-src";this.addSource(E,h.source),h=r.di(h),h=r.h(h,{source:E})}let _=r.h({},h),v={};if(this.terrain&&g){_.source=this.terrain.get().source;let E=this.terrain?this.getFragmentStyle(this.terrain.scope):null;E&&(v.style=E.serialize())}if(this._validate(Xe,"terrain",_,v))return}if(!this.terrain||this.terrain.scope!==this.scope&&!g||this.terrain&&o!==this.terrain.drapeRenderMode){if(!h)return;this._createTerrain(h,o),this.fire(new r.A("data",{dataType:"style"}))}else{let _=this.terrain,v=_.get();for(let E of Object.keys(r.a5.terrain))!h.hasOwnProperty(E)&&r.a5.terrain[E].default&&(h[E]=r.a5.terrain[E].default);for(let E in t)if(!r.bv(t[E],v[E])){_.set(t,this.options),this.stylesheet.terrain=t;let T=this._getTransitionParameters({duration:0});_.updateTransitions(T),this.fire(new r.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){let o=this.fog=new rn(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createSnow(t){let o=this.snow=new ir(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createRain(t){let o=this.rain=new Ki(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let o=this.fog;if(!r.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let o=this.snow;if(!r.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let o=this.rain;if(!r.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){let t=()=>{for(let g in this._layers)this._layers[g].lut=this._styleColorTheme.lut;for(let g in this._sourceCaches)this._sourceCaches[g].clearTiles()},o=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!o)return this._styleColorTheme.lut=null,void t();let h=this._evaluateColorThemeData(o);this._loadColorTheme(h).then(()=>{this.fire(new r.A("colorthemeset")),t()}).catch(g=>{r.w(`Couldn't set color theme: ${g}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&r.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,o){let h=this.getFragmentStyle(t);h&&(h._styleColorTheme.colorThemeOverride=o,h._reloadColorTheme())}_getTransitionParameters(t){return{now:r.q.now(),transition:r.h(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;let t=[],o=[];for(let h of this._mergedOrder)this.isLayerDraped(this._mergedLayers[h])?t.push(h):o.push(h);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...o)}_createTerrain(t,o){let h=this.terrain=new ve(t,o,this.scope,this.options,this.map.getWorldview());o===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let g=this._getTransitionParameters({duration:0});h.updateTransitions(g)}_force3DLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="fill-extrusion"&&this._updateLayer(o)}}_forceSymbolLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="symbol"&&this._updateLayer(o)}}_validate(t,o,h,g,_={}){if(_&&_.validate===!1)return!1;let v=r.h({},this.serialize());return xa(this,t.call(To,r.h({key:o,style:v,value:h,styleSpec:r.a5},g)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),r.ds.off("pluginStateChange",this._rtlTextPluginCallback);for(let t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){let o=this.getSourceCaches(t);for(let h of o)h.clearTiles()}clearSources(){for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(let t in this._mergedLayers){let o=this._mergedLayers[t];o._clear&&o._clear()}}reloadSource(t){let o=this.getSourceCaches(t);for(let h of o)h.resume(),h.reload()}reloadSources(){for(let t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let o;this.directionalLight&&(o=ec(this.directionalLight));let h=new Set;for(let g in this._mergedLayers){let _=this._mergedLayers[g];_.hasElevation()&&!h.has(_.source)&&h.add(_.source)}for(let g in this._mergedSourceCaches){let _=this._mergedSourceCaches[g],v=h.has(_._source.id);_.update(t,void 0,void 0,o,v)}}_generateCollisionBoxes(){for(let t in this._sourceCaches){let o=this._sourceCaches[t];o.resume(),o.reload()}}_updatePlacement(t,o,h,g,_,v,E=!1){let T=!1,C=!1,A={},L={};for(let R of this._mergedOrder){let k=this._mergedLayers[R];if(k.type!=="symbol")continue;let V=r.C(k.source,k.scope),z=A[V];if(!z){let j=this.getLayerSourceCache(k);if(!j)continue;let W=j.getRenderableIds(!0).map(Y=>j.getTileByID(Y));L[V]=W.slice(),z=A[V]=W.sort((Y,J)=>J.tileID.overscaledZ-Y.tileID.overscaledZ||(Y.tileID.isLessThan(J.tileID)?-1:1))}let U=this.crossTileSymbolIndex.addLayer(k,z,o.center.lng,o.projection);T=T||U}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),E=E||this._layerOrderChanged||g===0,this._layerOrderChanged&&this.fire(new r.A("neworder")),(E||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(r.q.now(),o.zoom))&&(this.pauseablePlacement=new nh(o,this._mergedOrder,E,h,g,_,this.placement,this.fog&&o.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,A,L,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(r.q.now()),C=!0),T&&this.pauseablePlacement.placement.setStale()),C||T){this._buildingIndex.onNewFrame(o.zoom);for(let R=0;R<this._mergedOrder.length;R++){let k=this._mergedLayers[this._mergedOrder[R]];if(k.type!=="symbol")continue;let V=this.isLayerClipped(k);this.placement.updateLayerOpacities(k,A[r.C(k.source,k.scope)],R,V?v:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(r.q.now())}}_releaseSymbolFadeTiles(){for(let t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,o){this._checkLoaded();let h=this.stylesheet.imports=this.stylesheet.imports||[];if(h.findIndex(({id:_})=>_===t.id)!==-1)return void this.fire(new r.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!o)return h.push(t),this._loadImports([t],!0);let g=h.findIndex(({id:_})=>_===o);return g===-1&&this.fire(new r.z(new Error(`Import with id "${o}" does not exist on this map.`))),this.stylesheet.imports=h.slice(0,g).concat(t).concat(h.slice(g)),this._loadImports([t],!0,o)}updateImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);return g===-1?this:typeof o=="string"?(this.setImportUrl(t,o),this):(o.url&&o.url!==h[g].url&&this.setImportUrl(t,o.url),r.bv(o.config,h[g].config)||this.setImportConfig(t,o.config,o.data.schema),r.bv(o.data,h[g].data)||this.setImportData(t,o.data),this)}moveImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);if(g===-1)return this;let _=this.getImportIndex(o);if(_===-1)return this;let v=h[g],E=this.fragments[g];return h=h.filter(({id:T})=>T!==t),this.fragments=this.fragments.filter(({id:T})=>T!==t),this.stylesheet.imports=h.slice(0,_).concat(v).concat(h.slice(_)),this.fragments=this.fragments.slice(0,_).concat(E).concat(this.fragments.slice(_)),this.mergeLayers(),this}setImportUrl(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);if(g===-1)return this;h[g].url=o;let _=this.fragments[g];return _.style=this._createFragmentStyle(h[g]),_.style.on("style.import.load",()=>this.mergeAll()),_.style.loadURL(o),this}setImportData(t,o){this._checkLoaded();let h=this.getImportIndex(t),g=this.stylesheet.imports||[];return h===-1?this:o?(this.fragments[h].style.setState(o),this._reloadImports(),this):(delete g[h].data,this.setImportUrl(t,g[h].url))}setImportConfig(t,o,h){this._checkLoaded();let g=this.getImportIndex(t),_=this.stylesheet.imports||[];if(g===-1)return this;o?_[g].config=o:delete _[g].config;let v=this.fragments[g];h&&v.style.stylesheet&&(v.style.stylesheet.schema=h);let E=v.style.stylesheet&&v.style.stylesheet.schema;return v.config=o,v.style.updateConfig(o,E),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();let o=this.stylesheet.imports||[],h=this.getImportIndex(t);h!==-1&&(o.splice(h,1),this.fragments[h].style._remove(),this.fragments.splice(h,1),this._reloadImports())}getImportIndex(t){let o=(this.stylesheet.imports||[]).findIndex(h=>h.id===t);return o===-1&&this.fire(new r.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),o}getLayer(t){return this._mergedLayers[t]}getSources(){let t=[];for(let o in this._mergedOtherSourceCaches){let h=this._mergedOtherSourceCaches[o];h&&t.push(h.getSource())}return t}getSource(t,o){let h=this.getSourceCache(t,o);return h&&h.getSource()}getLayerSource(t){let o=this.getLayerSourceCache(t);return o&&o.getSource()}getSourceCache(t,o){let h=r.C(t,o);return this._mergedOtherSourceCaches[h]}getLayerSourceCache(t){let o=r.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[o]:this._mergedOtherSourceCaches[o]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);let o=[];return this._mergedOtherSourceCaches[t]&&o.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&o.push(this._mergedSymbolSourceCaches[t]),o}updateSourceCaches(){let t=this._changes.getUpdatedSourceCaches();for(let o in t){let h=t[o];h==="reload"?this.reloadSource(o):h==="clear"&&this.clearSource(o)}}updateLayers(t){let o=this._changes.getUpdatedPaintProperties();for(let h of o){let g=this.getLayer(h);g&&g.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,o,h){this.imageManager.getImages(o.images,o.scope,h),this._updateTilesForChangedImages();let g=v=>{if(v){let E=o.images.map(T=>r.I.toString(T));v.setDependencies(o.tileID.key,o.type,E)}},_=r.C(o.source,o.scope);g(this._mergedOtherSourceCaches[_]),g(this._mergedSymbolSourceCaches[_]),o.images.some(v=>v.iconsetId)&&this.fire(new r.A("data",{dataType:"style"}))}rasterizeImages(t,o,h){this.imageManager.rasterizeImages(o,h)}getGlyphs(t,o,h){this.glyphManager.getGlyphs(o.stacks,h)}getResource(t,o,h){return r.dt(o,h)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){let o=[];return this._otherSourceCaches[t]&&o.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&o.push(this._symbolSourceCaches[t]),o}_isSourceCacheLoaded(t){let o=this.getOwnSourceCaches(t);return o.length===0?(this.fire(new r.z(new Error(`There is no source with ID '${t}'`))),!1):o.every(h=>h.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,o){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;let h=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),g=t.type==="building";if(t.is3D(!!this.terrain)){if(h||g||o&&o.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Xo.getSourceType=function(u){return Zd[u]},Xo.setSourceType=function(u,t){Zd[u]=t},Xo.registerForPluginStateChange=r.du;var Ip=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,nc=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,ic=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,Sp="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",sh=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Co=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,ah=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,st=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Dp=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,lh=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,ch=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let Lu=[];ss(Ip,Lu),ss(ic,Lu),ss(nc,Lu);let al={"_prelude_fog.vertex.glsl":Co,"_prelude_terrain.vertex.glsl":sh,"_prelude_shadow.vertex.glsl":lh,"_prelude_fog.fragment.glsl":ah,"_prelude_shadow.fragment.glsl":ch,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":st,"_prelude_raster_particle.glsl":Dp},Yo={};mn("",sh),mn(ah,Co),mn(ch,lh),mn(st,""),mn(Dp,"");let uh=mn(nc,ic),wa=Ip;var ku={background:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,base_color.rgb,emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color.rgb=linearTosRGB(color.rgb);color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:mn(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:mn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:mn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:mn(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:mn(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:mn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:mn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:mn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:mn(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:mn(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:mn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:mn(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:mn(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:mn(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:mn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:mn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:mn(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:mn(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:mn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:mn(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Sp),skyboxGradient:mn(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Sp),skyboxCapture:mn(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:mn(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:mn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:mn(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:mn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:mn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:mn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:mn("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function ss(u,t){let o=u.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let h of o)if(h=h.trim(),h[0]==="#"&&h.includes("if")&&!h.includes("endif")){h=h.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let g=h.split(" ");for(let _ of g)t.includes(_)||t.push(_)}}function mn(u,t){let o=/#include\s+"([^"]+)"/g,h=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,g=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);g&&(g=g.map(C=>{let A=C.split(" ");return A[A.length-1]}),g=[...new Set(g)]);let _={},v=[],E=[];if(u=u.replace(o,(C,A)=>(E.push(A),"")),(t=t.replace(o,(C,A)=>(v.push(A),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let T=[...Lu];ss(u,T),ss(t,T);for(let C of[...v,...E])al[C]||console.error(`Undefined include: ${C}`),Yo[C]||(Yo[C]=[],ss(al[C],Yo[C])),T=[...T,...Yo[C]];return{fragmentSource:u=u.replace(h,(C,A,L,R,k)=>(_[k]=!0,A==="define"?`
#ifndef HAS_UNIFORM_u_${k}
in ${L} ${R} ${k};
#else
uniform ${L} ${R} u_${k};
#endif
`:A==="initialize"?`
#ifdef HAS_UNIFORM_u_${k}
    ${L} ${R} ${k} = u_${k};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    in ${L} ${R} ${k};
#endif
`:A==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(h,(C,A,L,R,k)=>{let V=R==="float"?"vec2":R,z=k.match(/color/)?"color":V;return A==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${k}
in ${L} ${R} a_${k};
#endif
`:_[k]?A==="define"?`
#ifndef HAS_UNIFORM_u_${k}
uniform lowp float u_${k}_t;
in ${L} ${V} a_${k};
out ${L} ${R} ${k};
#else
uniform ${L} ${R} u_${k};
#endif
`:A==="initialize"?z==="vec4"?`
#ifndef HAS_UNIFORM_u_${k}
    ${k} = a_${k};
#else
    ${L} ${R} ${k} = u_${k};
#endif
`:`
#ifndef HAS_UNIFORM_u_${k}
    ${k} = unpack_mix_${z}(a_${k}, u_${k}_t);
#else
    ${L} ${R} ${k} = u_${k};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    in ${L} ${R} a_${k};
    out ${L} ${R} ${k};
#endif
`:A==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    ${k} = a_${k};
#endif
`:void 0:A==="define"?`
#ifndef HAS_UNIFORM_u_${k}
uniform lowp float u_${k}_t;
in ${L} ${V} a_${k};
#else
uniform ${L} ${R} u_${k};
#endif
`:A==="define-instanced"?z==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${k}0;
in vec4 a_${k}1;
in vec4 a_${k}2;
in vec4 a_${k}3;
#else
uniform ${L} ${R} u_${k};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${L} ${V} a_${k};
#else
uniform ${L} ${R} u_${k};
#endif
`:A==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    ${L} ${R} ${k} = a_${k};
#endif
`:z==="vec4"?`
#ifndef HAS_UNIFORM_u_${k}
    ${L} ${R} ${k} = a_${k};
#else
    ${L} ${R} ${k} = u_${k};
#endif
`:`
#ifndef HAS_UNIFORM_u_${k}
    ${L} ${R} ${k} = unpack_mix_${z}(a_${k}, u_${k}_t);
#else
    ${L} ${R} ${k} = u_${k};
#endif
`}),staticAttributes:g,usedDefines:T,vertexIncludes:v,fragmentIncludes:E}}class _b{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,o,h,g,_,v,E,T){this.context=t;let C=this.boundPaintVertexBuffers.length!==g.length;for(let L=0;!C&&L<g.length;L++)this.boundPaintVertexBuffers[L]!==g[L]&&(C=!0);let A=this.boundDynamicVertexBuffers.length!==E.length;for(let L=0;!A&&L<E.length;L++)this.boundDynamicVertexBuffers[L]!==E[L]&&(A=!0);if(!this.vao||this.boundProgram!==o||this.boundLayoutVertexBuffer!==h||C||A||this.boundIndexBuffer!==_||this.boundVertexOffset!==v)this.freshBind(o,h,g,_,v,E,T);else{t.bindVertexArrayOES.set(this.vao);for(let L of E)L&&(L.bind(),T&&L.instanceCount&&L.setVertexAttribDivisor(t.gl,o,T));_&&_.dynamicDraw&&_.bind()}}freshBind(t,o,h,g,_,v,E){let T=t.numAttributes,C=this.context,A=C.gl;this.vao&&this.destroy(),this.vao=C.gl.createVertexArray(),C.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=o,this.boundPaintVertexBuffers=h,this.boundIndexBuffer=g,this.boundVertexOffset=_,this.boundDynamicVertexBuffers=v,o.enableAttributes(A,t),o.bind(),o.setVertexAttribPointers(A,t,_);for(let L of h)L.enableAttributes(A,t),L.bind(),L.setVertexAttribPointers(A,t,_);for(let L of v)L&&(L.enableAttributes(A,t),L.bind(),L.setVertexAttribPointers(A,t,_),E&&L.instanceCount&&L.setVertexAttribDivisor(A,t,E));g&&g.bind(),C.currentNumAttributes=T}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Cp(u,t){let o=Math.pow(2,t.canonical.z),h=t.canonical.y;return[new r.ac(0,h/o).toLngLat().lat,new r.ac(0,(h+1)/o).toLngLat().lat]}function yb(u,t,o,h,g,_,v){let E=u.context,T=E.gl,C=o.hillshadeFBO;if(!C)return;u.prepareDrawTile();let A=u.isTileAffectedByFog(t),L=u.getOrCreateProgram("hillshade",{overrideFog:A});E.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,C.colorAttachment.get());let R=((U,j,W,Y)=>{let J=W.paint.get("hillshade-shadow-color"),ie=W.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",le=W.paint.get("hillshade-highlight-color"),ue=W.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",re=W.paint.get("hillshade-accent-color"),oe=W.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",se=W.paint.get("hillshade-emissive-strength"),Ee=r.al(W.paint.get("hillshade-illumination-direction"));if(W.paint.get("hillshade-illumination-anchor")==="viewport")Ee-=U.transform.angle;else if(U.style&&U.style.enable3dLights()&&U.style.directionalLight){let Ne=U.style.directionalLight.properties.get("direction"),Ce=r.d1(Ne.x,Ne.y,Ne.z);Ee=r.al(Ce[1])}let me=!U.options.moving;return{u_matrix:Y||U.transform.calculateProjMatrix(j.tileID.toUnwrapped(),me),u_image:0,u_latrange:Cp(0,j.tileID),u_light:[W.paint.get("hillshade-exaggeration"),Ee],u_shadow:J.toPremultipliedRenderColor(ie?null:W.lut),u_highlight:le.toPremultipliedRenderColor(ue?null:W.lut),u_emissive_strength:se,u_accent:re.toPremultipliedRenderColor(oe?null:W.lut)}})(u,o,h,u.terrain?t.projMatrix:null);u.uploadCommonUniforms(E,L,t.toUnwrapped());let{tileBoundsBuffer:k,tileBoundsIndexBuffer:V,tileBoundsSegments:z}=u.getTileBoundsBuffers(o);L.draw(u,T.TRIANGLES,g,_,v,At.disabled,R,h.id,k,V,z)}function Ap(u,t,o){if(!t.needsDEMTextureUpload)return;let h=u.context,g=h.gl;h.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||u.getTileTexture(o.stride);let _=o.getPixels();t.demTexture?t.demTexture.update(_,{premultiply:!1}):t.demTexture=new r.T(h,_,g.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function X_(u,t,o){let h=u.context,g=h.gl;if(!t.dem)return;let _=t.dem;if(h.activeTexture.set(g.TEXTURE1),Ap(u,t,_),!t.demTexture)return;t.demTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE);let v=_.dim;h.activeTexture.set(g.TEXTURE0);let E=t.hillshadeFBO;if(!E){let R=new r.T(h,{width:v,height:v,data:null},g.RGBA8);R.bind(g.LINEAR,g.CLAMP_TO_EDGE),E=t.hillshadeFBO=h.createFramebuffer(v,v,!0,"renderbuffer"),E.colorAttachment.set(R.texture)}h.bindFramebuffer.set(E.framebuffer),h.viewport.set([0,0,v,v]);let{tileBoundsBuffer:T,tileBoundsIndexBuffer:C,tileBoundsSegments:A}=u.getMercatorTileBoundsBuffers(),L=[];u.linearFloatFilteringSupported()&&L.push("TERRAIN_DEM_FLOAT_FORMAT"),u.getOrCreateProgram("hillshadePrepare",{defines:L}).draw(u,g.TRIANGLES,pt.disabled,Lt.disabled,Yt.unblended,At.disabled,((R,k)=>{let V=k.stride,z=r.bz();return r.ca(z,0,r.aj,-r.aj,0,0,1),r.bo(z,z,[0,-r.aj,0]),{u_matrix:z,u_image:1,u_dimension:[V,V],u_zoom:R.overscaledZ}})(t.tileID,_),o.id,T,C,A),t.needsHillshadePrepare=!1}class fi{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class vb extends fi{getDefault(){return r.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class xb extends fi{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class bb extends fi{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class wb extends fi{getDefault(){return[!0,!0,!0,!0]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Y_ extends fi{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Eb extends fi{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class dh extends fi{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){let o=this.current;(t.func!==o.func||t.ref!==o.ref||t.mask!==o.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Tb extends fi{getDefault(){let t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class K_ extends fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),this.current=t,this.dirty=!1}}class Mp extends fi{getDefault(){return[0,1]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class hh extends fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.current=t,this.dirty=!1}}class Rp extends fi{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class ll extends fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.BLEND):o.disable(o.BLEND),this.current=t,this.dirty=!1}}class rc extends fi{getDefault(){let t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class fh extends fi{getDefault(){return r.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class ph extends fi{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class oc extends fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.CULL_FACE):o.disable(o.CULL_FACE),this.current=t,this.dirty=!1}}class J_ extends fi{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Pp extends fi{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Q_=class extends fi{getDefault(){return null}set(u){(u!==this.current||this.dirty)&&(this.gl.useProgram(u),this.current=u,this.dirty=!1)}};class sc extends fi{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class mh extends fi{getDefault(){let t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class gh extends fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Op extends fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindRenderbuffer(o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class _h extends fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindTexture(o.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Fu extends fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class ey extends fi{getDefault(){return null}set(t){let o=this.gl;o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class ty extends fi{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class ny extends fi{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class ac extends fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class iy extends fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Lp extends fi{constructor(t,o){super(t),this.context=t,this.parent=o}getDefault(){return null}}class Ib extends Lp{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class ry extends Lp{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferRenderbuffer(o.FRAMEBUFFER,this.attachment(),o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class kp extends Lp{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,this.attachment(),o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Fp extends ry{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let Np=(u,t,o)=>({u_matrix:u,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:o}),yh=(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z)=>({u_proj_matrix:Float32Array.from(u),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(h),u_merc_matrix:o,u_zoom_transition:g,u_merc_center:_,u_image0:0,u_frustum_tl:v,u_frustum_tr:E,u_frustum_br:T,u_frustum_bl:C,u_globe_pos:A,u_globe_radius:L,u_viewport:R,u_grid_matrix:z?Float32Array.from(z):new Float32Array(9),u_skirt_height:k,u_far_z_cutoff:V});function zp(u,t){return u!=null&&t!=null&&!(!u.hasData()||!t.hasData())&&u.demTexture!=null&&t.demTexture!=null&&u.tileID.key!==t.tileID.key}let cl=new class{constructor(){this.operations={}}newMorphing(u,t,o,h,g){if(u in this.operations){let _=this.operations[u];_.to.tileID.key!==o.tileID.key&&(_.queued=o)}else this.operations[u]={startTime:h,phase:0,duration:g,from:t,to:o,queued:null}}getMorphValuesForProxy(u){if(!(u in this.operations))return null;let t=this.operations[u];return{from:t.from,to:t.to,phase:t.phase}}update(u){for(let t in this.operations){let o=this.operations[t];for(o.phase=(u-o.startTime)/o.duration;o.phase>=1||!this._validOp(o);)if(!this._nextOp(o,u)){delete this.operations[t];break}}}_nextOp(u,t){return!!u.queued&&(u.from=u.to,u.to=u.queued,u.queued=null,u.phase=0,u.startTime=t,!0)}_validOp(u){return u.from.hasData()&&u.to.hasData()}},oy={0:null,1:"TERRAIN_VERTEX_MORPHING"};function lc(u,t,o){if(t===0)return 0;let h=t<1&&o===514?.25/t:1;return 6*Math.pow(1.5,22-u)*Math.max(t,1)*h}function Nu(u,t){let o=1<<u.z;return!t&&(u.x===0||u.x===o-1)||u.y===0||u.y===o-1}let vh=u=>({u_matrix:u});function no(u,t,o,h,g){if(g>0){let _=r.q.now(),v=(_-u.timeAdded)/g,E=t?(_-t.timeAdded)/g:-1,T=o.getSource(),C=h.coveringZoomLevel({tileSize:T.tileSize,roundZoom:T.roundZoom}),A=!t||Math.abs(t.tileID.overscaledZ-C)>Math.abs(u.tileID.overscaledZ-C),L=A&&u.refreshedUponExpiration?1:r.ay(A?v:1-E,0,1);return u.refreshedUponExpiration&&v>=1&&(u.refreshedUponExpiration=!1),t?{opacity:1,mix:1-L}:{opacity:L,mix:0}}return{opacity:1,mix:0}}class Bp extends eo{constructor(t){let o=fu("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",o,!1),o.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,o){t.state="loaded",o(null)}}class xh extends eo{constructor(t){let o=fu("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",o,!1),o.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,o,h){if(t.freezeTileCoverage)return;this.transform=t;let g=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((_,v)=>{if(_[v.key]="",!this._tiles[v.key]){let E=new Qa(v,this._source.tileSize*v.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);E.state="loaded",this._tiles[v.key]=E}return _},{});for(let _ in this._tiles)_ in g||(this.freeFBO(_),this._tiles[_].unloadVectorData(),delete this._tiles[_])}freeFBO(t){let o=this.proxyCachedFBO[t];if(o!==void 0){let h=Object.values(o);this.renderCachePool.push(...h),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class zu extends r.aM{constructor(t,o,h){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=o,this.projMatrix=h}}class bh extends r.dF{constructor(t,o){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[h,g,_]=function(T){let C=new r.ba,A=new r.a_,L=131;C.reserve(17161),A.reserve(33800);let R=r.aj/128,k=r.aj+R/2,V=k+R;for(let U=-R;U<V;U+=R)for(let j=-R;j<V;j+=R){let W=j<0||j>k||U<0||U>k?24575:0,Y=r.ay(Math.round(j),0,r.aj),J=r.ay(Math.round(U),0,r.aj);C.emplaceBack(Y+W,J)}let z=(U,j)=>{let W=j*L+U;A.emplaceBack(W+1,W,W+L),A.emplaceBack(W+L,W+L+1,W+1)};for(let U=1;U<129;U++)for(let j=1;j<129;j++)z(j,U);return[0,129].forEach(U=>{for(let j=0;j<130;j++)z(j,U),z(U,j)}),[C,A,32768]}(),v=t.context;this.gridBuffer=v.createVertexBuffer(h,r.bc.members),this.gridIndexBuffer=v.createIndexBuffer(g),this.gridSegments=r.bd.simpleSegment(0,0,h.length,g.length),this.gridNoSkirtSegments=r.bd.simpleSegment(0,0,h.length,_),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new xh(o.map),this.orthoMatrix=r.bz(),r.ca(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,r.aj,0,r.aj,0,1);let E=v.gl;this._overlapStencilMode=new Lt({func:E.GEQUAL,mask:255},0,255,E.KEEP,E.KEEP,E.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=o,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Bp(o.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,o,h){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);let g=t.terrain.properties,_=t.terrain.drapeRenderMode===0,v=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=r.q.now();let E=t.terrain&&t.terrain.scope,T=g.get("source"),C=_?this._mockSourceCache:t.getSourceCache(T,E);if(!C)return void r.w(`Couldn't find terrain source "${T}".`);if(this.sourceCache=C,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=v?this.calculateExaggeration(o):g.get("exaggeration"),!o.projection.requiresDraping&&v&&this._exaggeration===0)return void this._disable();this.enabled=!0;let A=()=>{this.sourceCache.used&&r.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let L=this.getScaledDemTileSize();this.sourceCache.update(o,L,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,A(),this._initializing=!0),A(),o.updateElevation(!0,h),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(o),this._emptyDEMTextureDirty=!0,this._previousZoom=o.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);let o=this._previousCameraAltitude,h=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=h;let g=o!=null?h-o:Number.MAX_VALUE;if(Math.abs(g)<2)return this._exaggeration;let _=t.zoom,v=this._style.terrain;if(!this._previousUpdateTimestamp)return v.getExaggeration(_);let E=_-this._previousZoom,T=this._previousUpdateTimestamp,C=_;this._evaluationZoom!=null&&(C=this._evaluationZoom,Math.abs(_-C)>.5&&(E=.5*(_-C+E)),E*g<0&&(C+=E)),this._evaluationZoom=C;let A=v.getExaggeration(C),L=A===v.getExaggeration(Math.max(0,C-.1));if(L&&Math.abs(A-this._exaggeration)<.01)return A;let R=Math.min(.1,.00375*(this._updateTimestamp-T));return(L||A<.1||Math.abs(E)<1e-4)&&(R=Math.min(.2,4*R)),r.ai(this._exaggeration,A,R)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let o=this.proxySourceCache,h=this.painter.transform;this._initializing&&(this._initializing=h._centerAltitude===0&&this.getAtPointOrZero(r.ac.fromLngLat(h.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let g=this.proxyCoords=o.getIds().map(T=>{let C=o.getTileByID(T).tileID;return C.projMatrix=h.calculateProjMatrix(C.toUnwrapped()),C});(function(T,C){let A=C.transform.pointCoordinate(C.transform.getCameraPoint()),L=new r.P(A.x,A.y);T.sort((R,k)=>{if(k.overscaledZ-R.overscaledZ)return k.overscaledZ-R.overscaledZ;let V=new r.P(R.canonical.x+(1<<R.canonical.z)*R.wrap,R.canonical.y),z=new r.P(k.canonical.x+(1<<k.canonical.z)*k.wrap,k.canonical.y),U=L.mult(1<<R.canonical.z);return U.x-=.5,U.y-=.5,U.distSqr(V)-U.distSqr(z)})})(g,this.painter);let _=this.proxyToSource||{};this.proxyToSource={},g.forEach(T=>{this.proxyToSource[T.key]={}}),this.terrainTileForTile={};let v=this._style._mergedSourceCaches;for(let T in v){let C=v[T];if(!C.used||(C!==this.sourceCache&&this.resetTileLookupCache(C.id),this._setupProxiedCoordsForOrtho(C,t[T],_),C.usedForTerrain))continue;let A=t[T];C.getSource().reparseOverscaled&&this._assignTerrainTiles(A)}this.proxiedCoords[o.id]=g.map(T=>new zu(T,T.key,this.orthoMatrix)),this._assignTerrainTiles(g),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(_),this.renderingToTexture=!1;let E={};this._visibleDemTiles=[];for(let T of this.proxyCoords){let C=this.terrainTileForTile[T.key];if(!C)continue;let A=C.tileID.key;A in E||(this._visibleDemTiles.push(C),E[A]=A)}}_assignTerrainTiles(t){this._initializing||t.forEach(o=>{if(this.terrainTileForTile[o.key])return;let h=this._findTileCoveringTileID(o,this.sourceCache);h&&(this.terrainTileForTile[o.key]=h)})}_prepareDEMTextures(){let t=this.painter.context,o=t.gl;for(let h in this.terrainTileForTile){let g=this.terrainTileForTile[h],_=g.dem;!_||g.demTexture&&!g.needsDEMTextureUpload||(t.activeTexture.set(o.TEXTURE1),Ap(this.painter,g,_))}}_prepareDemTileUniforms(t,o,h,g){if(!o||o.demTexture==null)return!1;let _=t.tileID.canonical,v=Math.pow(2,o.tileID.canonical.z-_.z),E=g||"";return h[`u_dem_tl${E}`]=[_.x*v%1,_.y*v%1],h[`u_dem_scale${E}`]=v,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0,o=this._visibleDemTiles.reduce((h,g)=>{if(!g.dem)return h;let _=g.dem.tree.minimums[0];return _>0&&t++,h+_},0);return t?o/t:0}_updateEmptyDEMTexture(){let t=this.painter.context,o=t.gl;t.activeTexture.set(o.TEXTURE2);let h=this._getLoadedAreaMinimum(),g=new r.dG({width:1,height:1},new Float32Array([h]));this._emptyDEMTextureDirty=!1;let _=this._emptyDEMTexture;return _?_.update(g,{premultiply:!1}):_=this._emptyDEMTexture=new r.T(t,g,o.R32F,{premultiply:!1}),_}setupElevationDraw(t,o,h){let g=this.painter.context,_=g.gl,v={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};v.u_exaggeration=this.exaggeration();let E=null,T=null,C=1;if(h&&h.morphing&&this._useVertexMorphing){let k=h.morphing.srcDemTile,V=h.morphing.dstDemTile;C=h.morphing.phase,k&&V&&(this._prepareDemTileUniforms(t,k,v,"_prev")&&(T=k),this._prepareDemTileUniforms(t,V,v)&&(E=V))}let A=k=>k&&k.demTexture&&this.painter.linearFloatFilteringSupported()?_.LINEAR:_.NEAREST,L=null;var R;if(this.enabled?T&&E?(L=E.demTexture,g.activeTexture.set(_.TEXTURE4),T.demTexture.bind(A(T),_.CLAMP_TO_EDGE),v.u_dem_lerp=C):(E=this.terrainTileForTile[t.tileID.key],L=this._prepareDemTileUniforms(t,E,v)?E.demTexture:this.emptyDEMTexture):L=this.emptyDEMTexture,g.activeTexture.set(_.TEXTURE2),L&&(v.u_dem_size=(R=L).size[0]===1?1:R.size[0]-2,L.bind(A(E),_.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(h&&h.useDepthForOcclusion,o,v),h&&h.useMeterToDem&&E){let k=(1<<E.tileID.canonical.z)*r.cb(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;v.u_meter_to_dem=k}if(h&&h.labelPlaneMatrixInv&&(v.u_label_plane_matrix_inv=h.labelPlaneMatrixInv),o.setTerrainUniformValues(g,v),this.painter.transform.projection.name==="globe"){let k=this.globeUniformValues(this.painter.transform,t.tileID.canonical,h&&h.useDenormalizedUpVectorScale);o.setGlobeUniformValues(g,k)}}globeUniformValues(t,o,h){let g=t.projection;return{u_tile_tl_up:g.upVector(o,0,0),u_tile_tr_up:g.upVector(o,r.aj,0),u_tile_br_up:g.upVector(o,r.aj,r.aj),u_tile_bl_up:g.upVector(o,0,r.aj),u_tile_up_scale:h?r.dH(1):g.upVectorScale(o,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){let o=this.painter,h=this.painter.context;t.length!==0&&(h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),o.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(g,_,v,E,T){if(g.transform.projection.name==="globe")(function(C,A,L,R,k){let V=C.context,z=V.gl,U,j,W=C.transform,Y=r.dy(C,V,W),J=(Ne,Ce)=>{if(j===Ce)return;let Be=[oy[Ce],"PROJECTION_GLOBE_VIEW"];Y&&Be.push("CUSTOM_ANTIALIASING");let Qe=C.isTileAffectedByFog(Ne);U=C.getOrCreateProgram("globeRaster",{defines:Be,overrideFog:Qe}),j=Ce},ie=C.colorModeForRenderPass(),le=new pt(z.LEQUAL,pt.ReadWrite,C.depthRangeFor3D);cl.update(k);let ue=r.dz(W),re=[r.aD(W.center.lng),r.aH(W.center.lat)],oe=C.globeSharedBuffers,se=[W.width*r.q.devicePixelRatio,W.height*r.q.devicePixelRatio],Ee=Float32Array.from(W.globeMatrix),me={useDenormalizedUpVectorScale:!0};{let Ne=C.transform,Ce=lc(Ne.zoom,A.exaggeration(),A.sourceCache._source.tileSize);j=-1;let Be=z.TRIANGLES;for(let Qe of R){let Te=L.getTile(Qe),pe=Lt.disabled,Pe=A.prevTerrainTileForTile[Qe.key],Ie=A.terrainTileForTile[Qe.key];zp(Pe,Ie)&&cl.newMorphing(Qe.key,Pe,Ie,k,250),V.activeTexture.set(z.TEXTURE0),Te.texture&&Te.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);let He=cl.getMorphValuesForProxy(Qe.key),$e=He?1:0;He&&r.L(me,{morphing:{srcDemTile:He.from,dstDemTile:He.to,phase:r.dx(He.phase)}});let qe=r.dA(Qe.canonical),ot=r.dB(qe.getCenter().lat),xt=r.dC(Qe.canonical,qe,ot,Ne.worldSize/Ne._pixelsPerMercatorPixel),St=r.bh(r.dD(Qe.canonical)),dt=yh(Ne.expandedFarZProjMatrix,Ee,ue,St,r.ah(Ne.zoom),re,Ne.frustumCorners.TL,Ne.frustumCorners.TR,Ne.frustumCorners.BR,Ne.frustumCorners.BL,Ne.globeCenterInViewSpace,Ne.globeRadius,se,Ce,Ne._farZ,xt);if(J(Qe,$e),U&&(A.setupElevationDraw(Te,U,me),C.uploadCommonUniforms(V,U,Qe.toUnwrapped()),oe)){let[Tt,wt,zt]=oe.getGridBuffers(ot,Ce!==0);U.draw(C,Be,le,pe,ie,At.backCCW,dt,"globe_raster",Tt,wt,zt)}}}if(oe&&(C.renderDefaultNorthPole||C.renderDefaultSouthPole)){let Ne=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Y&&Ne.push("CUSTOM_ANTIALIASING"),U=C.getOrCreateProgram("globeRaster",{defines:Ne});for(let Ce of R){let{x:Be,y:Qe,z:Te}=Ce.canonical,pe=Qe===0,Pe=Qe===(1<<Te)-1,[Ie,He,$e,qe]=oe.getPoleBuffers(Te,!1);if(qe&&(pe||Pe)){let ot=L.getTile(Ce);V.activeTexture.set(z.TEXTURE0),ot.texture&&ot.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);let xt=r.dE(Te,Be,W),St=r.bh(r.dD(Ce.canonical)),dt=(Tt,wt)=>Tt.draw(C,z.TRIANGLES,le,Lt.disabled,ie,At.disabled,yh(W.expandedFarZProjMatrix,xt,xt,St,0,re,W.frustumCorners.TL,W.frustumCorners.TR,W.frustumCorners.BR,W.frustumCorners.BL,W.globeCenterInViewSpace,W.globeRadius,se,0,W._farZ),"globe_pole_raster",wt,$e,qe);A.setupElevationDraw(ot,U,me),C.uploadCommonUniforms(V,U,Ce.toUnwrapped()),pe&&C.renderDefaultNorthPole&&dt(U,Ie),Pe&&C.renderDefaultSouthPole&&(xt=r.cP(r.bz(),xt,[1,-1,1]),dt(U,He))}}}})(g,_,v,E,T);else{let C=g.context,A=C.gl,L,R,k=g.shadowRenderer,V=xs(g,g.longestCutoffRange),z=ie=>{if(R===ie)return;let le=[];le.push(oy[ie]),V.shouldRenderCutoff&&le.push("RENDER_CUTOFF"),k&&(le.push("RENDER_SHADOWS","DEPTH_TEXTURE"),k.useNormalOffset&&le.push("NORMAL_OFFSET")),L=g.getOrCreateProgram("terrainRaster",{defines:le}),R=ie},U=g.colorModeForRenderPass(),j=new pt(A.LEQUAL,pt.ReadWrite,g.depthRangeFor3D);cl.update(T);let W=g.transform,Y=lc(W.zoom,_.exaggeration(),_.sourceCache._source.tileSize),J=[0,0,0];if(k){let ie=g.style.directionalLight,le=g.style.ambientLight;ie&&le&&(J=sl(g.style,ie,le))}{R=-1;let ie=A.TRIANGLES,[le,ue]=[_.gridIndexBuffer,_.gridSegments];for(let re of E){let oe=v.getTile(re),se=Lt.disabled,Ee=_.prevTerrainTileForTile[re.key],me=_.terrainTileForTile[re.key];zp(Ee,me)&&cl.newMorphing(re.key,Ee,me,T,250),C.activeTexture.set(A.TEXTURE0),oe.texture&&oe.texture.bind(A.LINEAR,A.CLAMP_TO_EDGE);let Ne=cl.getMorphValuesForProxy(re.key),Ce=Ne?1:0,Be;Ne&&(Be={morphing:{srcDemTile:Ne.from,dstDemTile:Ne.to,phase:r.dx(Ne.phase)}});let Qe=Np(re.projMatrix,Nu(re.canonical,W.renderWorldCopies)?Y/10:Y,J);if(z(Ce),!L)continue;_.setupElevationDraw(oe,L,Be);let Te=re.toUnwrapped();k&&k.setupShadows(Te,L),g.uploadCommonUniforms(C,L,Te,null,V),L.draw(g,ie,j,se,U,At.backCCW,Qe,"terrain_raster",_.gridBuffer,le,ue)}}}}(o,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,o.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;let o=this.painter,h=this.painter.context,g=this.proxySourceCache,_=this.proxiedCoords[g.id],v=this._drapedRenderBatches.shift(),E=o.style.order,T=[],C=0;for(let A of _){let L=g.getTileByID(A.proxyTileKey),R=g.proxyCachedFBO[A.key]?g.proxyCachedFBO[A.key][t]:void 0,k=R!==void 0?g.renderCache[R]:this.pool[C++],V=R!==void 0;if(L.texture=k.tex,V&&!k.dirty){T.push(L.tileID);continue}let z;h.bindFramebuffer.set(k.fb.framebuffer),this.renderedToTile=!1,k.dirty&&(h.clear({color:r.am.transparent,stencil:0}),k.dirty=!1);for(let U=v.start;U<=v.end;++U){let j=o.style._mergedLayers[E[U]];if(j.isHidden(o.transform.zoom))continue;let W=o.style.getLayerSourceCache(j),Y=W?this.proxyToSource[A.key][W.id]:[A];if(!Y)continue;let J=Y;h.viewport.set([0,0,k.fb.width,k.fb.height]),z!==(W?W.id:null)&&(this._setupStencil(k,Y,j,W),z=W?W.id:null),o.renderLayer(o,W,j,J)}if(this._drapedRenderBatches.length===0)for(let U of this._pendingGroundEffectLayers){let j=o.style._mergedLayers[E[U]];if(j.isHidden(o.transform.zoom))continue;let W=o.style.getLayerSourceCache(j),Y=W?this.proxyToSource[A.key][W.id]:[A];if(!Y)continue;let J=Y;h.viewport.set([0,0,k.fb.width,k.fb.height]),z!==(W?W.id:null)&&(this._setupStencil(k,Y,j,W),z=W?W.id:null),o.renderLayer(o,W,j,J)}this.renderedToTile?(k.dirty=!0,T.push(L.tileID)):V||--C,C===5&&(C=0,this.renderToBackBuffer(T))}return this.renderToBackBuffer(T),this.renderingToTexture=!1,h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),v.end+1}postRender(){}isLayerOrderingCorrect(t){let o=t.order.length,h=-1,g=o;for(let _=0;_<o;++_)this._style.isLayerDraped(t._mergedLayers[t.order[_]])?h=Math.max(h,_):g=Math.min(g,_);return g>h}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(o=>o.dem).forEach(o=>{t=Math.min(t,o.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,o,h){if(!this._visibleDemTiles)return null;let g=this._visibleDemTiles.filter(_=>_.dem).map(_=>{let v=_.tileID,E=1<<v.overscaledZ,{x:T,y:C}=v.canonical,A=T/E,L=(T+1)/E,R=C/E,k=(C+1)/E;return{minx:A,miny:R,maxx:L,maxy:k,t:_.dem.tree.raycastRoot(A,R,L,k,t,o,h),tile:_}});g.sort((_,v)=>(_.t!==null?_.t:Number.MAX_VALUE)-(v.t!==null?v.t:Number.MAX_VALUE));for(let _ of g){if(_.t==null)return null;let v=_.tile.dem.tree.raycast(_.minx,_.miny,_.maxx,_.maxy,t,o,h);if(v!=null)return v}return null}_createFBO(){let t=this.painter.context,o=t.gl,h=this.drapeBufferSize;t.activeTexture.set(o.TEXTURE0);let g=new r.T(t,{width:h[0],height:h[1],data:null},o.RGBA8);g.bind(o.LINEAR,o.CLAMP_TO_EDGE);let _=t.createFramebuffer(h[0],h[1],!0,null);return _.colorAttachment.set(g.texture),_.depthAttachment=new Fp(t,_.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,h[0],h[1]),this._stencilRef=0,_.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):_.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:_,tex:g,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{let o=this._style._mergedLayers[t],h=o.isHidden(this.painter.transform.zoom);return o.type==="hillshade"||o.type==="custom"?!h&&o.shouldRedrape():!h&&o.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(let h of this._style.getSources())if(h instanceof hu){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let g=this._style._mergedLayers[this._style.order[h]],_=this._style.getLayerSourceCache(g);if(_&&!o[_.id]&&!g.isHidden(this.painter.transform.zoom)&&g.type==="line"&&g.widthExpression()instanceof r.ab){o[_.id]=!0;for(let v of this.proxyCoords){let E=this.proxyToSource[v.key][_.id];if(E)for(let T of E)this._clearRenderCacheForTile(_.id,T)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(let h in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[h]._source instanceof vr){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let g=this._style._mergedLayers[this._style.order[h]],_=this._style.getLayerSourceCache(g);if(!_||o[_.id]||g.isHidden(this.painter.transform.zoom)||g.type!=="raster")continue;let v=g.paint.get("raster-fade-duration");for(let E of this.proxyCoords){let T=this.proxyToSource[E.key][_.id];if(T)for(let C of T){let A=no(_.getTile(C),_.findLoadedParent(C,0),_,this.painter.transform,v);(A.opacity!==1||A.mix!==0)&&this._clearRenderCacheForTile(_.id,C)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let t=this._style.order,o=t.length;if(o===0)return;let h=[];this._pendingGroundEffectLayers=[];let g,_=0,v=this._style._mergedLayers[t[_]];for(;!this._style.isLayerDraped(v)&&v.isHidden(this.painter.transform.zoom)&&++_<o;)v=this._style._mergedLayers[t[_]];for(;_<o;++_){let E=this._style._mergedLayers[t[_]];E.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(E)?g===void 0&&(g=_):(E.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(_),g!==void 0&&(h.push({start:g,end:_-1}),g=void 0)))}if(g!==void 0&&h.push({start:g,end:_-1}),h.length!==0){let E=h[h.length-1];this._pendingGroundEffectLayers.every(T=>T>E.end)||r.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=h}_setupRenderCache(t){let o=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,o.renderCache.length>o.renderCachePool.length){let v=Object.values(o.proxyCachedFBO);o.proxyCachedFBO={};for(let E=0;E<v.length;++E){let T=Object.values(v[E]);o.renderCachePool.push(...T)}}return}this._clearRasterLayersFromRenderCache();let h=this.proxyCoords,g=this._tilesDirty;for(let v=h.length-1;v>=0;v--){let E=h[v];if(o.getTileByID(E.key),o.proxyCachedFBO[E.key]!==void 0){let T=t[E.key],C=this.proxyToSource[E.key],A=0;for(let L in C){let R=C[L],k=T[L];if(!k||k.length!==R.length||R.some((V,z)=>V!==k[z]||g[L]&&g[L].hasOwnProperty(V.key))){A=-1;break}++A}for(let L in o.proxyCachedFBO[E.key])o.renderCache[o.proxyCachedFBO[E.key][L]].dirty=A<0||A!==Object.values(T).length}}let _=[...this._drapedRenderBatches];_.sort((v,E)=>E.end-E.start-(v.end-v.start));for(let v of _)for(let E of h){if(o.proxyCachedFBO[E.key])continue;let T=o.renderCachePool.pop();T===void 0&&o.renderCache.length<50&&(T=o.renderCache.length,o.renderCache.push(this._createFBO())),T!==void 0&&(o.proxyCachedFBO[E.key]={},o.proxyCachedFBO[E.key][v.start]=T,o.renderCache[T].dirty=!0)}this._tilesDirty={}}_setupStencil(t,o,h,g){if(!g||!this._sourceTilesOverlap[g.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let _=this.painter.context,v=_.gl;if(o.length<=1)return void(this._overlapStencilType=!1);let E;if(h.isTileClipped())E=o.length,this._overlapStencilMode.test={func:v.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(o[0].overscaledZ>o[o.length-1].overscaledZ))return void(this._overlapStencilType=!1);E=1,this._overlapStencilMode.test={func:v.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+E>255&&(_.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=E,this._overlapStencilMode.ref=this._stencilRef,h.isTileClipped()&&this._renderTileClippingMasks(o,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Lt.disabled}_renderTileClippingMasks(t,o){let h=this.painter,g=this.painter.context,_=g.gl;h._tileClippingMaskIDs={},g.setColorMode(Yt.disabled),g.setDepthMode(pt.disabled);let v=h.getOrCreateProgram("clippingMask");for(let E of t){let T=h._tileClippingMaskIDs[E.key]=--o;v.draw(h,_.TRIANGLES,pt.disabled,new Lt({func:_.ALWAYS,mask:0},T,255,_.KEEP,_.KEEP,_.REPLACE),Yt.disabled,At.disabled,vh(E.projMatrix),"$clipping",h.tileExtentBuffer,h.quadTriangleIndexBuffer,h.tileExtentSegments)}}pointCoordinate(t){let o=this.painter.transform;if(t.x<0||t.x>o.width||t.y<0||t.y>o.height)return null;let h=[t.x,t.y,1,1];r.aA(h,h,o.pixelMatrixInverse),r.cH(h,h,1/h[3]),h[0]/=o.worldSize,h[1]/=o.worldSize;let g=o._camera.position,_=r.cb(1,o.center.lat),v=[g[0],g[1],g[2]/_,0],E=r.d7([],h.slice(0,3),v);r.au(E,E);let T=this.raycast(v,E,this._exaggeration);return T!==null&&T?(r.bE(v,v,E,T),v[3]=v[2],v[2]*=_,v):null}_setupProxiedCoordsForOrtho(t,o,h){if(t.getSource()instanceof r.aP)return this._setupProxiedCoordsForImageSource(t,o,h);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};let g=this.proxiedCoords[t.id]=[],_=this.proxyCoords;for(let T=0;T<_.length;T++){let C=_[T],A=this._findTileCoveringTileID(C,t);if(A){let L=this._createProxiedId(C,A,h[C.key]&&h[C.key][t.id]);g.push(L),this.proxyToSource[C.key][t.id]=[L]}}let v=!1,E=new Set;for(let T=0;T<o.length;T++){let C=t.getTile(o[T]);if(!C||!C.hasData())continue;let A=this._findTileCoveringTileID(C.tileID,this.proxySourceCache);if(A&&A.tileID.canonical.z!==C.tileID.canonical.z){let L=this.proxyToSource[A.tileID.key][t.id],R=this._createProxiedId(A.tileID,C,h[A.tileID.key]&&h[A.tileID.key][t.id]);L?L.splice(L.length-1,0,R):this.proxyToSource[A.tileID.key][t.id]=[R];let k=this.proxyToSource[A.tileID.key][t.id];E.has(k)||E.add(k),g.push(R),v=!0}}if(this._sourceTilesOverlap[t.id]=v,v&&this._debugParams.sortTilesHiZFirst)for(let T of E)T.sort((C,A)=>A.overscaledZ-C.overscaledZ)}_setupProxiedCoordsForImageSource(t,o,h){if(!t.getSource().loaded())return;let g=this.proxiedCoords[t.id]=[],_=this.proxyCoords,v=t.getSource(),E=v.tileID;if(!E)return;let T=new r.P(E.x,E.y)._div(1<<E.z),C=v.coordinates.map(r.ac.fromLngLat).reduce((L,R)=>(L.min.x=Math.min(L.min.x,R.x-T.x),L.min.y=Math.min(L.min.y,R.y-T.y),L.max.x=Math.max(L.max.x,R.x-T.x),L.max.y=Math.max(L.max.y,R.y-T.y),L),{min:new r.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new r.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),A=(L,R)=>{let k=L.wrap+L.canonical.x/(1<<L.canonical.z),V=L.canonical.y/(1<<L.canonical.z),z=r.aj/(1<<L.canonical.z),U=R.wrap+R.canonical.x/(1<<R.canonical.z),j=R.canonical.y/(1<<R.canonical.z);return k+z<U+C.min.x||k>U+C.max.x||V+z<j+C.min.y||V>j+C.max.y};for(let L=0;L<_.length;L++){let R=_[L];for(let k=0;k<o.length;k++){let V=t.getTile(o[k]);if(!V||!V.hasData()||A(R,V.tileID))continue;let z=this._createProxiedId(R,V,h[R.key]&&h[R.key][t.id]),U=this.proxyToSource[R.key][t.id];U?U.push(z):this.proxyToSource[R.key][t.id]=[z],g.push(z)}}}_createProxiedId(t,o,h){let g=this.orthoMatrix;if(h){let _=h.find(v=>v.key===o.tileID.key);if(_)return _}if(o.tileID.key!==t.key){let _=t.canonical.z-o.tileID.canonical.z,v,E,T;g=r.bz();let C=o.tileID.wrap-t.wrap<<t.overscaledZ;_>0?(v=r.aj>>_,E=v*((o.tileID.canonical.x<<_)-t.canonical.x+C),T=v*((o.tileID.canonical.y<<_)-t.canonical.y)):(v=r.aj<<-_,E=r.aj*(o.tileID.canonical.x-(t.canonical.x+C<<-_)),T=r.aj*(o.tileID.canonical.y-(t.canonical.y<<-_))),r.ca(g,0,v,0,v,0,1),r.bo(g,g,[E,T,0])}return new zu(o.tileID,t.key,g)}_findTileCoveringTileID(t,o){let h=o.getTile(t);if(h&&h.hasData())return h;let g=this._findCoveringTileCache[o.id],_=g[t.key];if(h=_?o.getTileByID(_):null,h&&h.hasData()||_===null)return h;let v=h?h.tileID:t,E=v.overscaledZ,T=o.getSource().minzoom,C=[];if(!_){let L=o.getSource().maxzoom;if(t.canonical.z>=L){let R=t.canonical.z-L;o.getSource().reparseOverscaled?(E=Math.max(t.canonical.z+2,o.transform.tileZoom),v=new r.aM(E,t.wrap,L,t.canonical.x>>R,t.canonical.y>>R)):R!==0&&(E=L,v=new r.aM(E,t.wrap,L,t.canonical.x>>R,t.canonical.y>>R))}v.key!==t.key&&(C.push(v.key),h=o.getTile(v))}let A=L=>{C.forEach(R=>{g[R]=L}),C.length=0};for(E-=1;E>=T&&(!h||!h.hasData());E--){h&&A(h.tileID.key);let L=v.calculateScaledKey(E);if(h=o.getTileByID(L),h&&h.hasData())break;let R=g[L];if(R===null)break;R===void 0?C.push(L):h=o.getTileByID(R)}return A(h?h.tileID.key:null),h&&h.hasData()?h:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,o){let h=this._tilesDirty[t];h||(h=this._tilesDirty[t]={}),h[o.key]=!0}}function Vp(u,t,o){let h=function(E,T,C){let A=r.bG(T,E),L=r.bG(C,[.2126,.7152,.0722]),R=(V,z,U)=>(1-U)*V+U*z,k=R(1-.3*Math.min(L,1),1,Math.min(A+1,1));return R(.92,1,Math.asin(r.ay(T[2],-1,1))/Math.PI+.5)*k}(u,[0,0,1],t),g=[0,0,0];r.c1(g,o.slice(0,3),h);let _=[0,0,0];r.c1(_,t.slice(0,3),u[2]);let v=[0,0,0];return r.d5(v,g,_),r.d8(v)}let jp=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],wh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Eh{static cacheKey(t,o,h,g){let _=`${o}${g?g.cacheKey:""}`;for(let v of h)t.usedDefines.includes(v)&&(_+=`/${v}`);return _}constructor(t,o,h,g,_,v){let E=t.gl;this.program=E.createProgram(),this.configuration=g,this.name=o,this.fixedDefines=[...v];let T=g?g.getBinderAttributes():[],C=(h.staticAttributes||[]).concat(T),A=g?g.defines():[];A=A.concat(v.map(U=>`#define ${U}`));let L=`#version 300 es
`,R=L+A.concat("precision mediump float;",wa,uh.fragmentSource).join(`
`);for(let U of h.fragmentIncludes)R+=`
${al[U]}`;R+=`
${h.fragmentSource}`;let k=L+A.concat("precision highp float;",wa,uh.vertexSource).join(`
`);for(let U of h.vertexIncludes)k+=`
${al[U]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&h.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(k+=`
uniform int u_instanceID;
`),k+=`
${h.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(k=k.replaceAll("gl_InstanceID","u_instanceID"));let V=E.createShader(E.FRAGMENT_SHADER);if(E.isContextLost())return void(this.failedToCreate=!0);E.shaderSource(V,R),E.compileShader(V),E.attachShader(this.program,V);let z=E.createShader(E.VERTEX_SHADER);if(E.isContextLost())this.failedToCreate=!0;else{E.shaderSource(z,k),E.compileShader(z),E.attachShader(this.program,z),this.attributes={},this.numAttributes=C.length;for(let U=0;U<this.numAttributes;U++)if(C[U]){let j=C[U].startsWith("a_")?C[U]:`a_${C[U]}`;E.bindAttribLocation(this.program,U,j),this.attributes[j]=U}E.linkProgram(this.program),E.deleteShader(z),E.deleteShader(V),this.fixedUniforms=_(t),this.binderUniforms=g?g.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(U=>({u_instanceID:new r.cd(U)}))(t)),(v.includes("TERRAIN")||o.indexOf("symbol")!==-1||o.indexOf("circle")!==-1)&&(this.terrainUniforms=(U=>({u_dem:new r.cd(U),u_dem_prev:new r.cd(U),u_dem_tl:new r.cg(U),u_dem_scale:new r.cf(U),u_dem_tl_prev:new r.cg(U),u_dem_scale_prev:new r.cf(U),u_dem_size:new r.cf(U),u_dem_lerp:new r.cf(U),u_exaggeration:new r.cf(U),u_depth:new r.cd(U),u_depth_size_inv:new r.cg(U),u_depth_range_unpack:new r.cg(U),u_occluder_half_size:new r.cf(U),u_occlusion_depth_offset:new r.cf(U),u_meter_to_dem:new r.cf(U),u_label_plane_matrix_inv:new r.ch(U)}))(t)),v.includes("GLOBE")&&(this.globeUniforms=(U=>({u_tile_tl_up:new r.ce(U),u_tile_tr_up:new r.ce(U),u_tile_br_up:new r.ce(U),u_tile_bl_up:new r.ce(U),u_tile_up_scale:new r.cf(U)}))(t)),v.includes("FOG")&&(this.fogUniforms=(U=>({u_fog_matrix:new r.ch(U),u_fog_range:new r.cg(U),u_fog_color:new r.d0(U),u_fog_horizon_blend:new r.cf(U),u_fog_vertical_limit:new r.cg(U),u_fog_temporal_offset:new r.cf(U),u_frustum_tl:new r.ce(U),u_frustum_tr:new r.ce(U),u_frustum_br:new r.ce(U),u_frustum_bl:new r.ce(U),u_globe_pos:new r.ce(U),u_globe_radius:new r.cf(U),u_globe_transition:new r.cf(U),u_is_globe:new r.cd(U),u_viewport:new r.cg(U)}))(t)),v.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(U=>({u_cutoff_params:new r.d0(U)}))(t)),v.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(U=>({u_lighting_ambient_color:new r.ce(U),u_lighting_directional_dir:new r.ce(U),u_lighting_directional_color:new r.ce(U),u_ground_radiance:new r.ce(U)}))(t)),v.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(U=>({u_light_matrix_0:new r.ch(U),u_light_matrix_1:new r.ch(U),u_fade_range:new r.cg(U),u_shadow_normal_offset:new r.ce(U),u_shadow_intensity:new r.cf(U),u_shadow_texel_size:new r.cf(U),u_shadow_map_resolution:new r.cf(U),u_shadow_direction:new r.ce(U),u_shadow_bias:new r.ce(U),u_shadowmap_0:new r.cd(U),u_shadowmap_1:new r.cd(U)}))(t))}}setTerrainUniformValues(t,o){if(!this.terrainUniforms)return;let h=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g]&&h[g].set(this.program,g,o[g])}}setGlobeUniformValues(t,o){if(!this.globeUniforms)return;let h=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g]&&h[g].set(this.program,g,o[g])}}setFogUniformValues(t,o){if(!this.fogUniforms)return;let h=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setCutoffUniformValues(t,o){if(!this.cutoffUniforms)return;let h=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setLightsUniformValues(t,o){if(!this.lightsUniforms)return;let h=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setShadowUniformValues(t,o){if(this.failedToCreate||!this.shadowUniforms)return;let h=this.shadowUniforms;t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}_drawDebugWireframe(t,o,h,g,_,v,E,T,C,A){let L=t.options.wireframe;if(L.terrain===!1&&L.layers2D===!1&&L.layers3D===!1)return;let R=t.context;if(!(!(!L.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!L.layers2D||t._terrain&&t._terrain.renderingToTexture||!jp.includes(this.name))||!(!L.layers3D||!wh.includes(this.name))))return;let k=R.gl,V=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,_,R);if(!V)return;let z=[...this.fixedDefines];z.push("DEBUG_WIREFRAME");let U=t.getOrCreateProgram(this.name,{config:this.configuration,defines:z});R.program.set(U.program);let j=(J,ie,le)=>{if(ie[J]&&le[J])for(let ue in ie[J])le[J][ue]&&le[J][ue].set(le.program,ue,ie[J][ue].current)};C&&C.setUniforms(U.program,R,U.binderUniforms,E,{zoom:T}),j("fixedUniforms",this,U),j("terrainUniforms",this,U),j("globeUniforms",this,U),j("fogUniforms",this,U),j("lightsUniforms",this,U),j("shadowUniforms",this,U),V.bind(),R.setColorMode(new Yt([k.ONE,k.ONE_MINUS_SRC_ALPHA,k.ZERO,k.ONE],r.am.transparent,[!0,!0,!0,!1])),R.setDepthMode(new pt(o.func===k.LESS?k.LEQUAL:o.func,pt.ReadOnly,o.range)),R.setStencilMode(Lt.disabled);let W=3*v.primitiveLength*2,Y=3*v.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){let J=A||1;for(let ie=0;ie<J;++ie)U.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ie),k.drawElements(k.LINES,W,k.UNSIGNED_SHORT,Y)}else A&&A>1?k.drawElementsInstanced(k.LINES,W,k.UNSIGNED_SHORT,Y,A):k.drawElements(k.LINES,W,k.UNSIGNED_SHORT,Y);_.bind(),R.program.set(this.program),R.setDepthMode(o),R.setStencilMode(h),R.setColorMode(g)}checkUniforms(t,o,h){if(this.fixedDefines.includes(o)){for(let g of Object.keys(h))if(!h[g].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${g} not set but required by ${o} being defined`)}}draw(t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U){let j=t.context,W=j.gl;if(this.failedToCreate)return;j.program.set(this.program),j.setDepthMode(h),j.setStencilMode(g),j.setColorMode(_),j.setCullFace(v);for(let ie of Object.keys(this.fixedUniforms))this.fixedUniforms[ie].set(this.program,ie,E[ie]);V&&V.setUniforms(this.program,j,this.binderUniforms,R,{zoom:k});let Y={[W.POINTS]:1,[W.LINES]:2,[W.TRIANGLES]:3,[W.LINE_STRIP]:1}[o];this.checkUniforms(T,"RENDER_SHADOWS",this.shadowUniforms);let J=U&&U>0?1:void 0;for(let ie of L.get()){let le=ie.vaos||(ie.vaos={});if((le[T]||(le[T]=new _b)).bind(j,this,C,V?V.getPaintVertexBuffers():[],A,ie.vertexOffset,z||[],J),this.forceManualRenderingForInstanceIDShaders){let ue=U||1;for(let re=0;re<ue;++re)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",re),A?W.drawElements(o,ie.primitiveLength*Y,W.UNSIGNED_SHORT,ie.primitiveOffset*Y*2):W.drawArrays(o,ie.vertexOffset,ie.vertexLength)}else U&&U>1?W.drawElementsInstanced(o,ie.primitiveLength*Y,W.UNSIGNED_SHORT,ie.primitiveOffset*Y*2,U):A?W.drawElements(o,ie.primitiveLength*Y,W.UNSIGNED_SHORT,ie.primitiveOffset*Y*2):W.drawArrays(o,ie.vertexOffset,ie.vertexLength);o===W.TRIANGLES&&A&&this._drawDebugWireframe(t,h,g,_,A,ie,R,k,V,U)}}}function Th(u,t,o=0){let h=Math.pow(2,t.tileID.overscaledZ),g=t.tileSize*Math.pow(2,u.transform.tileZoom)/h,_=g*(t.tileID.canonical.x+t.tileID.wrap*h),v=g*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/r.aw(t,1,u.transform.tileZoom),u_pixel_coord_upper:[_>>16,v>>16],u_pixel_coord_lower:[65535&_,65535&v],u_pattern_transition:o}}let ul={terrain:0,flat:1},Up=r.bz(),Hp=(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j)=>{let W=t.style.light,Y=W.properties.get("position"),J=[Y.x,Y.y,Y.z],ie=r.dJ();W.properties.get("anchor")==="viewport"&&(r.dK(ie,-t.transform.angle),r.dL(J,J,ie));let le=W.properties.get("color").toPremultipliedRenderColor(null),ue=t.transform,re={u_matrix:u,u_lightpos:J,u_lightintensity:W.properties.get("intensity"),u_lightcolor:[le.r,le.g,le.b],u_vertical_gradient:+o,u_opacity:h,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Up,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:ul[C],u_base_type:ul[A],u_ao:g,u_edge_radius:_,u_width_scale:v,u_flood_light_color:V,u_vertical_scale:z,u_flood_light_intensity:U,u_ground_shadow_factor:j};return ue.projection.name==="globe"&&(re.u_tile_id=[E.canonical.x,E.canonical.y,1<<E.canonical.z],re.u_zoom_transition=L,re.u_inv_rot_matrix=k,re.u_merc_center=R,re.u_up_dir=ue.projection.upVector(new r.cA(0,0,0),R[0]*r.aj,R[1]*r.aj),re.u_height_lift=T),re},sy=(u,t,o,h,g,_)=>({u_matrix:u,u_edge_radius:t,u_width_scale:o,u_vertical_scale:h,u_height_type:ul[g],u_base_type:ul[_]}),cc=(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j)=>{let W=Hp(u,t,o,h,g,_,v,E,C,A,L,R,k,V,z,U,1,[0,0,0]),Y={u_height_factor:-Math.pow(2,E.overscaledZ)/T.tileSize/8};return r.h(W,Th(t,T,j),Y)},ay=(u,t,o)=>({u_matrix:u,u_emissive_strength:t,u_ground_shadow_factor:o}),ly=(u,t,o,h,g,_=0)=>r.h(ay(u,t,g),Th(o,h,_)),Sb=(u,t,o,h)=>({u_matrix:u,u_world:o,u_emissive_strength:t,u_ground_shadow_factor:h}),Db=(u,t,o,h,g,_,v=0)=>r.h(ly(u,t,o,h,_,v),{u_world:g}),Cb=(u,t)=>({u_matrix:u,u_ground_shadow_factor:t}),Ih=(u,t,o,h,g)=>({u_matrix:u,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:o,u_height_scale:h,u_reset_depth:g}),$p=(u,t)=>({u_matrix:u,u_normal_matrix:t,u_opacity:1}),Gp=u=>({u_matrix:u}),cy=u=>({u_matrix:u}),uc=(u,t,o,h,g,_,v,E)=>{let T=r.aj/_.tileSize;return{u_matrix:u,u_inv_rot_matrix:t,u_camera_to_center_distance:o.getCameraToCenterDistance(E),u_extrude_scale:[o.pixelsToGLUnits[0]/T,o.pixelsToGLUnits[1]/T],u_zoom_transition:h,u_tile_id:v,u_merc_center:g}},qp=(u,t,o=1)=>({u_matrix:u,u_color:t,u_overlay:0,u_overlay_scale:o}),uy=r.bz(),dy=(u,t,o,h,g,_,v)=>{let E=u.transform,T=E.projection.name==="globe",C=T?r.dM(E.zoom,t.canonical)*E._pixelsPerMercatorPixel:r.aw(o,1,_),A={u_matrix:t.projMatrix,u_extrude_scale:C,u_intensity:v,u_inv_rot_matrix:uy,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(T){A.u_inv_rot_matrix=h,A.u_merc_center=g,A.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],A.u_zoom_transition=r.ah(E.zoom);let L=g[0]*r.aj,R=g[1]*r.aj;A.u_up_dir=E.projection.upVector(new r.cA(0,0,0),L,R)}return A};function Sh(u,[t,o,h,g],[_,v]){if(_===v)return[0,0,0,0];let E=255*(u-1)/(u*(v-_));return[t*E,o*E,h*E,g*E]}function Ea(u,t,[o,h]){return o===h?0:.5/u+(t-o)*(u-1)/(u*(h-o))}let Wp=(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j,W,Y,J)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:g,u_tl_parent:_,u_scale_parent:C,u_fade_t:A.mix,u_opacity:A.opacity*L.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:L.paint.get("raster-brightness-min"),u_brightness_high:L.paint.get("raster-brightness-max"),u_saturation_factor:r.dO(L.paint.get("raster-saturation")),u_contrast_factor:r.dN(L.paint.get("raster-contrast")),u_spin_weights:Ta(L.paint.get("raster-hue-rotate")),u_perspective_transform:R,u_raster_elevation:k,u_zoom_transition:v,u_merc_center:E,u_cutoff_params:T,u_colorization_mix:Sh(r.dP,z,j),u_colorization_offset:Ea(r.dP,U,j),u_color_ramp:V,u_texture_offset:[Y/(W+2*Y),W/(W+2*Y)],u_texture_res:[W+2*Y,W+2*Y],u_emissive_strength:J});function Ta(u){u*=Math.PI/180;let t=Math.sin(u),o=Math.cos(u);return[(2*o+1)/3,(-Math.sqrt(3)*t-o+1)/3,(Math.sqrt(3)*t-o+1)/3]}let Ia=.05,Dh=(u,t,o,h,g,_,v,E,T,C,A,L)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:g,u_tl_parent:_,u_scale_parent:C,u_fade_t:A.mix,u_opacity:A.opacity,u_image0:0,u_image1:1,u_raster_elevation:L,u_zoom_transition:v,u_merc_center:E,u_cutoff_params:T}),hy=(u,t,o,h,g,_,v,E,T,C)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_tile_offset:o,u_velocity:h,u_color_ramp:_,u_velocity_res:g,u_max_speed:v,u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ia,Ia]}),fy=(u,t,o,h,g,_,v,E,T,C)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_velocity:o,u_velocity_res:h,u_max_speed:g,u_speed_factor:_,u_reset_rate:v,u_rand_seed:Math.random(),u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ia,Ia]}),Ch=r.bz(),Ah=(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j,W,Y,J,ie,le,ue)=>{let re=g.transform,oe={u_is_size_zoom_constant:+(u==="constant"||u==="source"),u_is_size_feature_constant:+(u==="constant"||u==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:re.getCameraToCenterDistance(W),u_rotate_symbol:+o,u_aspect_ratio:re.width/re.height,u_fade_change:g.options.fadeDuration?g.symbolFadeChange:1,u_matrix:_,u_label_plane_matrix:v,u_coord_matrix:E,u_is_text:+C,u_elevation_from_sea:T?1:0,u_pitch_with_map:+h,u_texsize:A,u_texsize_icon:L,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Ch,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Ch,u_up_vector:[0,-1,0],u_color_adj_mat:ie,u_icon_transition:le||0,u_gamma_scale:h?g.transform.getCameraToCenterDistance(W)*Math.cos(g.terrain?0:g.transform._pitch):1,u_device_pixel_ratio:r.q.devicePixelRatio,u_is_halo:1,u_scale_factor:ue||1,u_ground_shadow_factor:Y,u_inv_matrix:r.bi(r.bz(),v),u_normal_scale:J};return W.name==="globe"&&(oe.u_tile_id=[k.canonical.x,k.canonical.y,1<<k.canonical.z],oe.u_zoom_transition=V,oe.u_inv_rot_matrix=U,oe.u_merc_center=z,oe.u_camera_forward=re._camera.forward(),oe.u_ecef_origin=r.dQ(re.globeMatrix,k.toUnwrapped()),oe.u_tile_matrix=Float32Array.from(re.globeMatrix),oe.u_up_vector=j),oe},py=(u,t,o,h)=>({u_matrix:u,u_emissive_strength:t,u_opacity:o,u_color:h}),Zp=(u,t,o,h,g,_,v,E,T)=>r.h(function(C,A,L,R,k,V){let{width:z,height:U}=R.imageManager.getPixelSize(A),j=Math.pow(2,V.tileID.overscaledZ),W=V.tileSize*Math.pow(2,R.transform.tileZoom)/j,Y=W*(V.tileID.canonical.x+V.tileID.wrap*j),J=W*V.tileID.canonical.y;return{u_image:0,u_pattern_tl:L.tl,u_pattern_br:L.br,u_texsize:[z,U],u_pattern_size:L.displaySize,u_pattern_units_to_pixels:k?[R.transform.width,-1*R.transform.height]:[1/r.aw(V,1,R.transform.tileZoom),1/r.aw(V,1,R.transform.tileZoom)],u_pixel_coord_upper:[Y>>16,J>>16],u_pixel_coord_lower:[65535&Y,65535&J]}}(0,_,v,h,E,T),{u_matrix:u,u_emissive_strength:t,u_opacity:o}),dl=new Float32Array(r.bx([])),Xp=(u,t,o,h,g,_,v,E,T,C,A,L,R,k=[0,0,0],V)=>{let z=g.style.light,U=z.properties.get("position"),j=[-U.x,-U.y,U.z],W=r.dJ();z.properties.get("anchor")==="viewport"&&(r.dK(W,-g.transform.angle),r.dL(j,j,W));let Y=A.alphaMode==="MASK",J=z.properties.get("color").toNonPremultipliedRenderColor(null),ie=R.paint.get("model-ambient-occlusion-intensity"),le=R.paint.get("model-color").constantOr(r.am.white).toNonPremultipliedRenderColor(null);return le.a=R.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:u,u_lighting_matrix:t,u_normal_matrix:o,u_node_matrix:h||dl,u_lightpos:j,u_lightintensity:z.properties.get("intensity"),u_lightcolor:[J.r,J.g,J.b],u_camera_pos:k,u_opacity:_,u_baseTextureIsAlpha:0,u_alphaMask:+Y,u_alphaCutoff:A.alphaCutoff,u_baseColorFactor:v.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:E.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:T,u_roughnessFactor:C,u_baseColorTexture:Vr.BaseColor,u_metallicRoughnessTexture:Vr.MetallicRoughness,u_normalTexture:Vr.Normal,u_occlusionTexture:Vr.Occlusion,u_emissionTexture:Vr.Emission,u_lutTexture:Vr.LUT,u_color_mix:le.toArray01(),u_aoIntensity:ie,u_emissive_strength:L,u_occlusionTextureTransform:V||[0,0,0,0]}},my=(u,t=dl,o=dl)=>({u_matrix:u,u_instance:t,u_node_matrix:o}),gy={fillExtrusion:u=>({u_matrix:new r.ch(u),u_lightpos:new r.ce(u),u_lightintensity:new r.cf(u),u_lightcolor:new r.ce(u),u_vertical_gradient:new r.cf(u),u_opacity:new r.cf(u),u_edge_radius:new r.cf(u),u_width_scale:new r.cf(u),u_ao:new r.cg(u),u_height_type:new r.cd(u),u_base_type:new r.cd(u),u_tile_id:new r.ce(u),u_zoom_transition:new r.cf(u),u_inv_rot_matrix:new r.ch(u),u_merc_center:new r.cg(u),u_up_dir:new r.ce(u),u_height_lift:new r.cf(u),u_flood_light_color:new r.ce(u),u_vertical_scale:new r.cf(u),u_flood_light_intensity:new r.cf(u),u_ground_shadow_factor:new r.ce(u)}),fillExtrusionDepth:u=>({u_matrix:new r.ch(u),u_edge_radius:new r.cf(u),u_width_scale:new r.cf(u),u_vertical_scale:new r.cf(u),u_height_type:new r.cd(u),u_base_type:new r.cd(u)}),fillExtrusionPattern:u=>({u_matrix:new r.ch(u),u_lightpos:new r.ce(u),u_lightintensity:new r.cf(u),u_lightcolor:new r.ce(u),u_vertical_gradient:new r.cf(u),u_height_factor:new r.cf(u),u_edge_radius:new r.cf(u),u_width_scale:new r.cf(u),u_ao:new r.cg(u),u_height_type:new r.cd(u),u_base_type:new r.cd(u),u_tile_id:new r.ce(u),u_zoom_transition:new r.cf(u),u_inv_rot_matrix:new r.ch(u),u_merc_center:new r.cg(u),u_up_dir:new r.ce(u),u_height_lift:new r.cf(u),u_image:new r.cd(u),u_texsize:new r.cg(u),u_pixel_coord_upper:new r.cg(u),u_pixel_coord_lower:new r.cg(u),u_tile_units_to_pixels:new r.cf(u),u_opacity:new r.cf(u),u_pattern_transition:new r.cf(u)}),fillExtrusionGroundEffect:u=>({u_matrix:new r.ch(u),u_opacity:new r.cf(u),u_ao_pass:new r.cf(u),u_meter_to_tile:new r.cf(u),u_ao:new r.cg(u),u_flood_light_intensity:new r.cf(u),u_flood_light_color:new r.ce(u),u_attenuation:new r.cf(u),u_edge_radius:new r.cf(u),u_fb:new r.cd(u),u_fb_size:new r.cf(u),u_dynamic_offset:new r.cf(u)}),fill:u=>({u_matrix:new r.ch(u),u_emissive_strength:new r.cf(u),u_ground_shadow_factor:new r.ce(u)}),fillPattern:u=>({u_matrix:new r.ch(u),u_emissive_strength:new r.cf(u),u_image:new r.cd(u),u_texsize:new r.cg(u),u_pixel_coord_upper:new r.cg(u),u_pixel_coord_lower:new r.cg(u),u_tile_units_to_pixels:new r.cf(u),u_ground_shadow_factor:new r.ce(u),u_pattern_transition:new r.cf(u)}),fillOutline:u=>({u_matrix:new r.ch(u),u_emissive_strength:new r.cf(u),u_world:new r.cg(u),u_ground_shadow_factor:new r.ce(u)}),fillOutlinePattern:u=>({u_matrix:new r.ch(u),u_emissive_strength:new r.cf(u),u_world:new r.cg(u),u_image:new r.cd(u),u_texsize:new r.cg(u),u_pixel_coord_upper:new r.cg(u),u_pixel_coord_lower:new r.cg(u),u_tile_units_to_pixels:new r.cf(u),u_ground_shadow_factor:new r.ce(u),u_pattern_transition:new r.cf(u)}),building:u=>({u_matrix:new r.ch(u),u_normal_matrix:new r.ch(u),u_opacity:new r.cf(u)}),buildingBloom:u=>({u_matrix:new r.ch(u)}),buildingDepth:u=>({u_matrix:new r.ch(u)}),elevatedStructuresDepth:u=>({u_matrix:new r.ch(u),u_depth_bias:new r.cf(u)}),elevatedStructures:u=>({u_matrix:new r.ch(u),u_ground_shadow_factor:new r.ce(u)}),elevatedStructuresDepthReconstruct:u=>({u_matrix:new r.ch(u),u_camera_pos:new r.ce(u),u_depth_bias:new r.cf(u),u_height_scale:new r.cf(u),u_reset_depth:new r.cf(u)}),circle:r.dT,collisionBox:u=>({u_matrix:new r.ch(u),u_inv_rot_matrix:new r.ch(u),u_camera_to_center_distance:new r.cf(u),u_extrude_scale:new r.cg(u),u_zoom_transition:new r.cf(u),u_merc_center:new r.cg(u),u_tile_id:new r.ce(u)}),collisionCircle:u=>({u_matrix:new r.ch(u),u_inv_matrix:new r.ch(u),u_camera_to_center_distance:new r.cf(u),u_viewport_size:new r.cg(u)}),debug:u=>({u_color:new r.dv(u),u_matrix:new r.ch(u),u_overlay:new r.cd(u),u_overlay_scale:new r.cf(u)}),clippingMask:u=>({u_matrix:new r.ch(u)}),heatmap:u=>({u_extrude_scale:new r.cf(u),u_intensity:new r.cf(u),u_matrix:new r.ch(u),u_inv_rot_matrix:new r.ch(u),u_merc_center:new r.cg(u),u_tile_id:new r.ce(u),u_zoom_transition:new r.cf(u),u_up_dir:new r.ce(u)}),heatmapTexture:u=>({u_image:new r.cd(u),u_color_ramp:new r.cd(u),u_opacity:new r.cf(u)}),hillshade:u=>({u_matrix:new r.ch(u),u_image:new r.cd(u),u_latrange:new r.cg(u),u_light:new r.cg(u),u_shadow:new r.dv(u),u_highlight:new r.dv(u),u_emissive_strength:new r.cf(u),u_accent:new r.dv(u)}),hillshadePrepare:u=>({u_matrix:new r.ch(u),u_image:new r.cd(u),u_dimension:new r.cg(u),u_zoom:new r.cf(u)}),line:r.dS,linePattern:r.dR,raster:u=>({u_matrix:new r.ch(u),u_normalize_matrix:new r.ch(u),u_globe_matrix:new r.ch(u),u_merc_matrix:new r.ch(u),u_grid_matrix:new r.dw(u),u_tl_parent:new r.cg(u),u_scale_parent:new r.cf(u),u_fade_t:new r.cf(u),u_opacity:new r.cf(u),u_image0:new r.cd(u),u_image1:new r.cd(u),u_brightness_low:new r.cf(u),u_brightness_high:new r.cf(u),u_saturation_factor:new r.cf(u),u_contrast_factor:new r.cf(u),u_spin_weights:new r.ce(u),u_perspective_transform:new r.cg(u),u_raster_elevation:new r.cf(u),u_zoom_transition:new r.cf(u),u_merc_center:new r.cg(u),u_cutoff_params:new r.d0(u),u_colorization_mix:new r.d0(u),u_colorization_offset:new r.cf(u),u_color_ramp:new r.cd(u),u_texture_offset:new r.cg(u),u_texture_res:new r.cg(u),u_emissive_strength:new r.cf(u)}),rasterParticle:u=>({u_matrix:new r.ch(u),u_normalize_matrix:new r.ch(u),u_globe_matrix:new r.ch(u),u_merc_matrix:new r.ch(u),u_grid_matrix:new r.dw(u),u_tl_parent:new r.cg(u),u_scale_parent:new r.cf(u),u_fade_t:new r.cf(u),u_opacity:new r.cf(u),u_image0:new r.cd(u),u_image1:new r.cd(u),u_raster_elevation:new r.cf(u),u_zoom_transition:new r.cf(u),u_merc_center:new r.cg(u),u_cutoff_params:new r.d0(u)}),rasterParticleTexture:u=>({u_texture:new r.cd(u),u_opacity:new r.cf(u)}),rasterParticleDraw:u=>({u_particle_texture:new r.cd(u),u_particle_texture_side_len:new r.cf(u),u_tile_offset:new r.cg(u),u_velocity:new r.cd(u),u_color_ramp:new r.cd(u),u_velocity_res:new r.cg(u),u_max_speed:new r.cf(u),u_uv_offset:new r.cg(u),u_data_scale:new r.cg(u),u_data_offset:new r.cf(u),u_particle_pos_scale:new r.cf(u),u_particle_pos_offset:new r.cg(u)}),rasterParticleUpdate:u=>({u_particle_texture:new r.cd(u),u_particle_texture_side_len:new r.cf(u),u_velocity:new r.cd(u),u_velocity_res:new r.cg(u),u_max_speed:new r.cf(u),u_speed_factor:new r.cf(u),u_reset_rate:new r.cf(u),u_rand_seed:new r.cf(u),u_uv_offset:new r.cg(u),u_data_scale:new r.cg(u),u_data_offset:new r.cf(u),u_particle_pos_scale:new r.cf(u),u_particle_pos_offset:new r.cg(u)}),symbol:u=>({u_is_size_zoom_constant:new r.cd(u),u_is_size_feature_constant:new r.cd(u),u_size_t:new r.cf(u),u_size:new r.cf(u),u_camera_to_center_distance:new r.cf(u),u_rotate_symbol:new r.cd(u),u_aspect_ratio:new r.cf(u),u_fade_change:new r.cf(u),u_matrix:new r.ch(u),u_label_plane_matrix:new r.ch(u),u_coord_matrix:new r.ch(u),u_is_text:new r.cd(u),u_elevation_from_sea:new r.cd(u),u_pitch_with_map:new r.cd(u),u_texsize:new r.cg(u),u_texsize_icon:new r.cg(u),u_texture:new r.cd(u),u_texture_icon:new r.cd(u),u_gamma_scale:new r.cf(u),u_device_pixel_ratio:new r.cf(u),u_tile_id:new r.ce(u),u_zoom_transition:new r.cf(u),u_inv_rot_matrix:new r.ch(u),u_merc_center:new r.cg(u),u_camera_forward:new r.ce(u),u_tile_matrix:new r.ch(u),u_up_vector:new r.ce(u),u_ecef_origin:new r.ce(u),u_is_halo:new r.cd(u),u_icon_transition:new r.cf(u),u_color_adj_mat:new r.ch(u),u_scale_factor:new r.cf(u),u_ground_shadow_factor:new r.ce(u),u_inv_matrix:new r.ch(u),u_normal_scale:new r.cf(u)}),background:u=>({u_matrix:new r.ch(u),u_emissive_strength:new r.cf(u),u_opacity:new r.cf(u),u_color:new r.dv(u)}),backgroundPattern:u=>({u_matrix:new r.ch(u),u_emissive_strength:new r.cf(u),u_opacity:new r.cf(u),u_image:new r.cd(u),u_pattern_tl:new r.cg(u),u_pattern_br:new r.cg(u),u_texsize:new r.cg(u),u_pattern_size:new r.cg(u),u_pixel_coord_upper:new r.cg(u),u_pixel_coord_lower:new r.cg(u),u_pattern_units_to_pixels:new r.cg(u)}),terrainRaster:u=>({u_matrix:new r.ch(u),u_image0:new r.cd(u),u_skirt_height:new r.cf(u),u_ground_shadow_factor:new r.ce(u)}),skybox:u=>({u_matrix:new r.ch(u),u_sun_direction:new r.ce(u),u_cubemap:new r.cd(u),u_opacity:new r.cf(u),u_temporal_offset:new r.cf(u)}),skyboxGradient:u=>({u_matrix:new r.ch(u),u_color_ramp:new r.cd(u),u_center_direction:new r.ce(u),u_radius:new r.cf(u),u_opacity:new r.cf(u),u_temporal_offset:new r.cf(u)}),skyboxCapture:u=>({u_matrix_3f:new r.dw(u),u_sun_direction:new r.ce(u),u_sun_intensity:new r.cf(u),u_color_tint_r:new r.d0(u),u_color_tint_m:new r.d0(u),u_luminance:new r.cf(u)}),globeRaster:u=>({u_proj_matrix:new r.ch(u),u_globe_matrix:new r.ch(u),u_normalize_matrix:new r.ch(u),u_merc_matrix:new r.ch(u),u_zoom_transition:new r.cf(u),u_merc_center:new r.cg(u),u_image0:new r.cd(u),u_grid_matrix:new r.dw(u),u_skirt_height:new r.cf(u),u_far_z_cutoff:new r.cf(u),u_frustum_tl:new r.ce(u),u_frustum_tr:new r.ce(u),u_frustum_br:new r.ce(u),u_frustum_bl:new r.ce(u),u_globe_pos:new r.ce(u),u_globe_radius:new r.cf(u),u_viewport:new r.cg(u)}),globeAtmosphere:u=>({u_frustum_tl:new r.ce(u),u_frustum_tr:new r.ce(u),u_frustum_br:new r.ce(u),u_frustum_bl:new r.ce(u),u_horizon:new r.cf(u),u_transition:new r.cf(u),u_fadeout_range:new r.cf(u),u_color:new r.d0(u),u_high_color:new r.d0(u),u_space_color:new r.d0(u),u_temporal_offset:new r.cf(u),u_horizon_angle:new r.cf(u)}),model:u=>({u_matrix:new r.ch(u),u_lighting_matrix:new r.ch(u),u_normal_matrix:new r.ch(u),u_node_matrix:new r.ch(u),u_lightpos:new r.ce(u),u_lightintensity:new r.cf(u),u_lightcolor:new r.ce(u),u_camera_pos:new r.ce(u),u_opacity:new r.cf(u),u_baseColorFactor:new r.d0(u),u_emissiveFactor:new r.d0(u),u_metallicFactor:new r.cf(u),u_roughnessFactor:new r.cf(u),u_baseTextureIsAlpha:new r.cd(u),u_alphaMask:new r.cd(u),u_alphaCutoff:new r.cf(u),u_baseColorTexture:new r.cd(u),u_metallicRoughnessTexture:new r.cd(u),u_normalTexture:new r.cd(u),u_occlusionTexture:new r.cd(u),u_emissionTexture:new r.cd(u),u_lutTexture:new r.cd(u),u_color_mix:new r.d0(u),u_aoIntensity:new r.cf(u),u_emissive_strength:new r.cf(u),u_occlusionTextureTransform:new r.d0(u)}),modelDepth:u=>({u_matrix:new r.ch(u),u_instance:new r.ch(u),u_node_matrix:new r.ch(u)}),groundShadow:u=>({u_matrix:new r.ch(u),u_ground_shadow_factor:new r.ce(u)}),stars:u=>({u_matrix:new r.ch(u),u_up:new r.ce(u),u_right:new r.ce(u),u_intensity_multiplier:new r.cf(u)}),snowParticle:u=>({u_modelview:new r.ch(u),u_projection:new r.ch(u),u_time:new r.cf(u),u_cam_pos:new r.ce(u),u_velocityConeAperture:new r.cf(u),u_velocity:new r.cf(u),u_horizontalOscillationRadius:new r.cf(u),u_horizontalOscillationRate:new r.cf(u),u_boxSize:new r.cf(u),u_billboardSize:new r.cf(u),u_simpleShapeParameters:new r.cg(u),u_screenSize:new r.cg(u),u_thinningCenterPos:new r.cg(u),u_thinningShape:new r.ce(u),u_thinningAffectedRatio:new r.cf(u),u_thinningParticleOffset:new r.cf(u),u_particleColor:new r.d0(u),u_direction:new r.ce(u)}),rainParticle:u=>({u_modelview:new r.ch(u),u_projection:new r.ch(u),u_time:new r.cf(u),u_cam_pos:new r.ce(u),u_texScreen:new r.cd(u),u_velocityConeAperture:new r.cf(u),u_velocity:new r.cf(u),u_boxSize:new r.cf(u),u_rainDropletSize:new r.cg(u),u_distortionStrength:new r.cf(u),u_rainDirection:new r.ce(u),u_color:new r.d0(u),u_screenSize:new r.cg(u),u_thinningCenterPos:new r.cg(u),u_thinningShape:new r.ce(u),u_thinningAffectedRatio:new r.cf(u),u_thinningParticleOffset:new r.cf(u),u_shapeDirectionalPower:new r.cf(u),u_shapeNormalPower:new r.cf(u),u_mode:new r.cf(u)}),vignette:u=>({u_vignetteShape:new r.ce(u),u_vignetteColor:new r.d0(u)}),occlusion:u=>({u_matrix:new r.ch(u),u_anchorPos:new r.ce(u),u_screenSizePx:new r.cg(u),u_occluderSizePx:new r.cg(u),u_color:new r.d0(u)})},_y=(()=>{class u{constructor(o,h,g,_){this.id=u.uniqueIdxCounter,u.uniqueIdxCounter++,this.context=o;let v=o.gl;this.buffer=v.createBuffer(),this.dynamicDraw=!!g,this.context.unbindVAO(),o.bindElementBuffer.set(this.buffer),v.bufferData(v.ELEMENT_ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?v.DYNAMIC_DRAW:v.STATIC_DRAW),this.dynamicDraw||_||h.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(o){this.id=u.uniqueIdxCounter,u.uniqueIdxCounter++;let h=this.context.gl;this.context.unbindVAO(),this.bind(),h.bufferSubData(h.ELEMENT_ARRAY_BUFFER,0,o.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return u.uniqueIdxCounter=0,u})(),Yp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Kp{constructor(t,o,h,g,_,v){this.length=o.length,this.attributes=h,this.itemSize=o.bytesPerElement,this.dynamicDraw=g,this.instanceCount=v,this.context=t;let E=t.gl;this.buffer=E.createBuffer(),t.bindVertexBuffer.set(this.buffer),E.bufferData(E.ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?E.DYNAMIC_DRAW:E.STATIC_DRAW),this.dynamicDraw||_||o.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){let o=this.context.gl;this.bind(),o.bufferSubData(o.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,o){for(let h=0;h<this.attributes.length;h++){let g=o.attributes[this.attributes[h].name];g!==void 0&&t.enableVertexAttribArray(g)}}setVertexAttribPointers(t,o,h){for(let g=0;g<this.attributes.length;g++){let _=this.attributes[g],v=o.attributes[_.name];v!==void 0&&t.vertexAttribPointer(v,_.components,t[Yp[_.type]],!1,this.itemSize,_.offset+this.itemSize*(h||0))}}setVertexAttribDivisor(t,o,h){for(let g=0;g<this.attributes.length;g++){let _=o.attributes[this.attributes[g].name];_!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(_,h)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class hl{constructor(t,o,h,g,_){this.context=t,this.width=o,this.height=h;let v=this.framebuffer=t.gl.createFramebuffer();g&&(this.colorAttachment=new Ib(t,v)),_&&(this.depthAttachmentType=_,this.depthAttachment=_==="renderbuffer"?new ry(t,v):new kp(t,v))}destroy(){let t=this.context.gl;if(this.colorAttachment){let o=this.colorAttachment.get();o&&t.deleteTexture(o)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let o=this.depthAttachment.get();o&&t.deleteRenderbuffer(o)}else{let o=this.depthAttachment.get();o&&t.deleteTexture(o)}t.deleteFramebuffer(this.framebuffer)}}class Mh{constructor(t,o){this.gl=t,this.clearColor=new vb(this),this.clearDepth=new xb(this),this.clearStencil=new bb(this),this.colorMask=new wb(this),this.depthMask=new Y_(this),this.stencilMask=new Eb(this),this.stencilFunc=new dh(this),this.stencilOp=new Tb(this),this.stencilTest=new K_(this),this.depthRange=new Mp(this),this.depthTest=new hh(this),this.depthFunc=new Rp(this),this.blend=new ll(this),this.blendFunc=new rc(this),this.blendColor=new fh(this),this.blendEquation=new ph(this),this.cullFace=new oc(this),this.cullFaceSide=new J_(this),this.frontFace=new Pp(this),this.program=new Q_(this),this.activeTexture=new sc(this),this.viewport=new mh(this),this.bindFramebuffer=new gh(this),this.bindRenderbuffer=new Op(this),this.bindTexture=new _h(this),this.bindVertexBuffer=new Fu(this),this.bindElementBuffer=new ey(this),this.bindVertexArrayOES=new ty(this),this.pixelStoreUnpack=new ny(this),this.pixelStoreUnpackPremultiplyAlpha=new ac(this),this.pixelStoreUnpackFlipY=new iy(this),this.options=o?Object.assign({},o):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=o&&!!o.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,o,h){return new _y(this,t,o,h)}createVertexBuffer(t,o,h,g,_){return new Kp(this,t,o,h,g,_)}createRenderbuffer(t,o,h){let g=this.gl,_=g.createRenderbuffer();return this.bindRenderbuffer.set(_),g.renderbufferStorage(g.RENDERBUFFER,t,o,h),this.bindRenderbuffer.set(null),_}createFramebuffer(t,o,h,g){return new hl(this,t,o,h,g)}clear({color:t,depth:o,stencil:h,colorMask:g}){let _=this.gl,v=0;t&&(v|=_.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(g||[!0,!0,!0,!0])),o!==void 0&&(v|=_.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(o),this.depthMask.set(!0)),h!==void 0&&(v|=_.STENCIL_BUFFER_BIT,this.clearStencil.set(h),this.stencilMask.set(255)),_.clear(v)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){r.bv(t.blendFunction,Yt.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Sa;function Jp(u,t,o,h,g,_,v){let E=u.context,T=E.gl,C=u.transform,A=[r.aD(C.center.lng),r.aH(C.center.lat)],L=o.layout.get("symbol-placement"),R=o.layout.get("text-variable-anchor"),k=o.layout.get("icon-rotation-alignment")==="map",V=o.layout.get("text-rotation-alignment")==="map",z=L!=="point",U=[],j=0,W=0;for(let oe=0;oe<h.length;oe++){let se=h[oe],Ee=t.getTile(se),me=Ee.getBucket(o);if(!me)continue;let Ne=me.getProjection().createInversionMatrix(C,se.canonical),Ce=[],Be=N_(se,me,C),Qe=!v&&k&&z,Te=v&&V&&z,pe=R&&me.hasTextData(),Pe=me.hasIconTextFit()&&pe&&me.hasIconData(),Ie=Qe||Te||v&&pe||Pe,He=me.projection.name==="globe",$e=He?r.ah(C.zoom):0;He&&(Ce.push("PROJECTION_GLOBE_VIEW"),Ie&&Ce.push("PROJECTED_POS_ON_VIEWPORT"));let qe=u.getOrCreateProgram("collisionBox",{defines:Ce}),ot=Be;g[0]===0&&g[1]===0||(ot=u.translatePosMatrix(Be,Ee,g,_));let xt=v?me.textCollisionBox:me.iconCollisionBox,St=me.collisionCircleArray;if(St.length>0){let Tt=r.bz(),wt=ot;r.cM(Tt,me.placementInvProjMatrix,C.glCoordMatrix),r.cM(Tt,Tt,me.placementViewportMatrix),U.push({circleArray:St,circleOffset:W,transform:wt,invTransform:Tt,projection:me.getProjection()}),j+=St.length/4,W=j}if(!xt)continue;u.terrain&&u.terrain.setupElevationDraw(Ee,qe);let dt=He?[se.canonical.x,se.canonical.y,1<<se.canonical.z]:[0,0,0];qe.draw(u,T.LINES,pt.disabled,Lt.disabled,u.colorModeForRenderPass(),At.disabled,uc(ot,Ne,C,$e,A,Ee,dt,me.getProjection()),o.id,xt.layoutVertexBuffer,xt.indexBuffer,xt.segments,null,C.zoom,null,[xt.collisionVertexBuffer,xt.collisionVertexBufferExt])}if(!v||!U.length)return;let Y=u.getOrCreateProgram("collisionCircle"),J=new r.dU;J.resize(4*j),J._trim();let ie=0;for(let oe of U)for(let se=0;se<oe.circleArray.length/4;se++){let Ee=4*se,me=oe.circleArray[Ee+0],Ne=oe.circleArray[Ee+1],Ce=oe.circleArray[Ee+2],Be=oe.circleArray[Ee+3];J.emplace(ie++,me,Ne,Ce,Be,0),J.emplace(ie++,me,Ne,Ce,Be,1),J.emplace(ie++,me,Ne,Ce,Be,2),J.emplace(ie++,me,Ne,Ce,Be,3)}(!Sa||Sa.length<2*j)&&(Sa=function(oe){let se=2*oe,Ee=new r.a_;Ee.resize(se),Ee._trim();for(let me=0;me<se;me++){let Ne=6*me;Ee.uint16[Ne+0]=4*me+0,Ee.uint16[Ne+1]=4*me+1,Ee.uint16[Ne+2]=4*me+2,Ee.uint16[Ne+3]=4*me+2,Ee.uint16[Ne+4]=4*me+3,Ee.uint16[Ne+5]=4*me+0}return Ee}(j));let le=E.createIndexBuffer(Sa,!0),ue=E.createVertexBuffer(J,r.dV.members,!0);for(let oe of U){let se={u_matrix:oe.transform,u_inv_matrix:oe.invTransform,u_camera_to_center_distance:(re=C).getCameraToCenterDistance(oe.projection),u_viewport_size:[re.width,re.height]};Y.draw(u,T.TRIANGLES,pt.disabled,Lt.disabled,u.colorModeForRenderPass(),At.disabled,se,o.id,ue,le,r.bd.simpleSegment(0,2*oe.circleOffset,oe.circleArray.length,oe.circleArray.length/2),null,C.zoom)}var re;ue.destroy(),le.destroy()}let fl=r.bz();function Bu(u){let t=u._camera.getWorldToCamera(u.worldSize,1),o=r.az([],t,u.globeMatrix);r.bi(o,o);let h=[0,0,0],g=[0,1,0,0];return r.aA(g,g,o),h[0]=g[0],h[1]=g[1],h[2]=g[2],r.au(h,h),h}function Qp({width:u,height:t,anchor:o,textOffset:h,textScale:g},_){let{horizontalAlign:v,verticalAlign:E}=r.bZ(o),T=-(v-.5)*u,C=-(E-.5)*t,A=r.b_(o,h);return new r.P((T/g+A[0])*_,(C/g+A[1])*_)}function yy(u,t,o,h,g,_,v,E,T,C){let A=u.text.placedSymbolArray,L=u.text.dynamicLayoutVertexArray,R=u.icon.dynamicLayoutVertexArray,k={},V=u.getProjection(),z=Qd(v,V,g),U=g.elevation,j=V.upVectorScale(v.canonical,g.center.lat,g.worldSize).metersToTile;L.clear();for(let W=0;W<A.length;W++){let Y=A.get(W),{tileAnchorX:J,tileAnchorY:ie,numGlyphs:le}=Y,ue=Y.hidden||!Y.crossTileID||u.allowVerticalPlacement&&!Y.placedOrientation?null:h[Y.crossTileID];if(ue){let re=0,oe=0,se=0;if(U){let Pe=U?U.getAtTileOffset(v,J,ie):0,[Ie,He,$e]=V.upVector(v.canonical,J,ie);re=Pe*Ie*j,oe=Pe*He*j,se=Pe*$e*j}let[Ee,me,Ne,Ce]=So(Y.projectedAnchorX+re,Y.projectedAnchorY+oe,Y.projectedAnchorZ+se,o?z:_),Be=_p(g.getCameraToCenterDistance(V),Ce),Qe=r.bJ(u.textSizeData,T,Y)*Be/r.bU;o&&(Qe*=u.tilePixelRatio/E);let Te=Qp(ue,Qe);o?({x:Ee,y:me,z:Ne}=V.projectTilePoint(J+Te.x,ie+Te.y,v.canonical),[Ee,me,Ne]=So(Ee+re,me+oe,Ne+se,_)):(t&&Te._rotate(-g.angle),Ee+=Te.x,me+=Te.y,Ne=0);let pe=u.allowVerticalPlacement&&Y.placedOrientation===r.bI.vertical?Math.PI/2:0;for(let Pe=0;Pe<le;Pe++)r.bL(L,Ee,me,Ne,pe);C&&Y.associatedIconIndex>=0&&(k[Y.associatedIconIndex]={x:Ee,y:me,z:Ne,angle:pe})}else Xl(le,L)}if(C){R.clear();let W=u.icon.placedSymbolArray;for(let Y=0;Y<W.length;Y++){let J=W.get(Y),{numGlyphs:ie}=J,le=k[Y];if(J.hidden||!le)Xl(ie,R);else{let{x:ue,y:re,z:oe,angle:se}=le;for(let Ee=0;Ee<ie;Ee++)r.bL(R,ue,re,oe,se)}}u.icon.dynamicLayoutVertexBuffer.updateData(R)}u.text.dynamicLayoutVertexBuffer.updateData(L)}function em(u,t,o,h,g,_,v={}){let E=o.paint.get("icon-translate"),T=o.paint.get("text-translate"),C=o.paint.get("icon-translate-anchor"),A=o.paint.get("text-translate-anchor"),L=o.layout.get("icon-rotation-alignment"),R=o.layout.get("text-rotation-alignment"),k=o.layout.get("icon-pitch-alignment"),V=o.layout.get("text-pitch-alignment"),z=o.layout.get("icon-keep-upright"),U=o.layout.get("text-keep-upright"),j=o.paint.get("icon-color-saturation"),W=o.paint.get("icon-color-contrast"),Y=o.paint.get("icon-color-brightness-min"),J=o.paint.get("icon-color-brightness-max"),ie=o.layout.get("symbol-elevation-reference")==="sea",le=u.context,ue=le.gl,re=u.transform,oe=L==="map",se=R==="map",Ee=k==="map",me=V==="map",Ne=o.layout.get("symbol-sort-key").constantOr(1)!==void 0,Ce=!1,Be=u.depthModeForSublayer(0,pt.ReadOnly),Qe=new pt(u.context.gl.LEQUAL,pt.ReadOnly,u.depthRangeFor3D),Te=[r.aD(re.center.lng),r.aH(re.center.lat)],pe=o.layout.get("text-variable-anchor"),Pe=re.projection.name==="globe",Ie=[],He=[0,-1,0];for(let $e of h){let qe=t.getTile($e),ot=qe.getBucket(o);if(!ot||ot.projection.name==="mercator"&&Pe||ot.fullyClipped)continue;let xt=ot.projection.name==="globe",St=xt?r.ah(re.zoom):0,dt=Qd($e,ot.getProjection(),re),Tt=re.calculatePixelsToTileUnitsMatrix(qe),wt=pe&&ot.hasTextData(),zt=ot.hasIconTextFit()&&wt&&ot.hasIconData(),qt=ot.getProjection().createInversionMatrix(re,$e.canonical),on=(1<<qe.tileID.canonical.z)*r.aj/u.transform.worldSize,bn=zn=>{let Cn=[0,0,0];if(zn){let _i=u.style.directionalLight,yn=u.style.ambientLight;_i&&yn&&(Cn=sl(u.style,_i,yn))}return Cn},Ht=zn=>{re.depthOcclusionForSymbolsAndCircles&&(o.hasInitialOcclusionOpacityProperties||u.terrain)&&(zn.push("DEPTH_D24"),zn.push("DEPTH_OCCLUSION"))},wn=()=>{let zn=oe&&o.layout.get("symbol-placement")!=="point",Cn=[];Ht(Cn);let _i=zn||zt,yn=ot.elevationType==="road",Rn=u.shadowRenderer,qn=yn&&Ee&&!!Rn&&Rn.enabled,$i=bn(qn),Bi=yn&&Ee&&!u.terrain?Qe:Be,qi=o.paint.get("icon-image-cross-fade");u.terrainRenderModeElevated()&&Ee&&Cn.push("PITCH_WITH_MAP_TERRAIN"),xt&&(Cn.push("PROJECTION_GLOBE_VIEW"),_i&&Cn.push("PROJECTED_POS_ON_VIEWPORT")),qi>0&&ot.hasAnySecondaryIcon&&Cn.push("ICON_TRANSITION"),!ot.icon.zOffsetVertexBuffer||yn&&u.terrain||Cn.push("Z_OFFSET"),j===0&&W===0&&Y===0&&J===1||Cn.push("COLOR_ADJUSTMENT"),ot.sdfIcons&&Cn.push("RENDER_SDF"),qn&&Cn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),yn&&Ee&&!u.terrain&&ot.icon.orientationVertexBuffer&&Cn.push("ELEVATED_ROADS");let pr=ot.icon.programConfigurations.get(o.id),ls=u.getOrCreateProgram("symbol",{config:pr,defines:Cn}),Hr=qe.imageAtlasTexture?qe.imageAtlasTexture.size:[0,0],po=ot.iconSizeData,Tr=r.bH(po,re.zoom),Po=Ee||!re.isOrthographic,Qo=Eu(dt,qe.tileID.canonical,Ee,oe,re,ot.getProjection(),Tt),Ir=js(dt,qe.tileID.canonical,Ee,oe,re,ot.getProjection(),Tt),Oi=u.translatePosMatrix(Ir,qe,E,C,!0),Si=u.translatePosMatrix(dt,qe,E,C),Jn=_i?fl:Qo,Qi=oe&&!Ee&&!zn,mr=He;!Pe&&!re.mercatorFromTransition||oe||(mr=Bu(re));let Li=xt?mr:He,Oo=o.getColorAdjustmentMatrix(j,W,Y,J),_l=Ah(po.kind,Tr,Qi,Ee,u,Si,Jn,Oi,ie,!1,Hr,[0,0],0,$e,St,Te,qt,Li,ot.getProjection(),$i,on,Oo,qi,null),Oa=qe.imageAtlasTexture?qe.imageAtlasTexture:null,Ic=o.layout.get("icon-size").constantOr(0)!==1||ot.iconsNeedLinear,Sc=ot.sdfIcons||u.options.rotating||u.options.zooming||Ic||Po?ue.LINEAR:ue.NEAREST,Lo=ot.sdfIcons&&o.paint.get("icon-halo-width").constantOr(1)!==0,Is=u.terrain&&Ee&&zn?r.bi(r.bz(),Qo):fl;if(zn&&ot.icon){let er=re.elevation,ko=er?er.getAtTileOffsetFunc($e,re.center.lat,re.worldSize,ot.getProjection()):null,yl=Zl(dt,qe.tileID.canonical,Ee,oe,re,ot.getProjection(),Tt);il(ot,dt,u,!1,yl,Ir,Ee,z,ko,$e)}return{program:ls,buffers:ot.icon,uniformValues:_l,atlasTexture:Oa,atlasTextureIcon:null,atlasInterpolation:Sc,atlasInterpolationIcon:null,isSDF:ot.sdfIcons,hasHalo:Lo,depthMode:Bi,tile:qe,renderWithShadows:qn,labelPlaneMatrixInv:Is}},Dn=()=>{let zn=se&&o.layout.get("symbol-placement")!=="point",Cn=[],_i=zn||pe||zt,yn=ot.elevationType==="road",Rn=u.shadowRenderer,qn=yn&&me&&!!Rn&&Rn.enabled,$i=bn(qn),Bi=yn&&me&&!u.terrain?Qe:Be;u.terrainRenderModeElevated()&&me&&Cn.push("PITCH_WITH_MAP_TERRAIN"),xt&&(Cn.push("PROJECTION_GLOBE_VIEW"),_i&&Cn.push("PROJECTED_POS_ON_VIEWPORT")),!ot.text.zOffsetVertexBuffer||yn&&u.terrain||Cn.push("Z_OFFSET"),ot.iconsInText&&Cn.push("RENDER_TEXT_AND_SYMBOL"),Cn.push("RENDER_SDF"),qn&&Cn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),yn&&me&&!u.terrain&&ot.text.orientationVertexBuffer&&Cn.push("ELEVATED_ROADS"),Ht(Cn);let qi=ot.text.programConfigurations.get(o.id),pr=u.getOrCreateProgram("symbol",{config:qi,defines:Cn}),ls,Hr=[0,0],po=null,Tr=ot.textSizeData;ot.iconsInText&&(Hr=qe.imageAtlasTexture?qe.imageAtlasTexture.size:[0,0],po=qe.imageAtlasTexture?qe.imageAtlasTexture:null,ls=me||!re.isOrthographic||u.options.rotating||u.options.zooming||Tr.kind==="composite"||Tr.kind==="camera"?ue.LINEAR:ue.NEAREST);let Po=qe.glyphAtlasTexture?qe.glyphAtlasTexture.size:[0,0],Qo=o.layout.get("text-size-scale-range"),Ir=r.ay(u.scaleFactor,Qo[0],Qo[1]),Oi=r.bH(Tr,re.zoom,Ir),Si=Eu(dt,qe.tileID.canonical,me,se,re,ot.getProjection(),Tt),Jn=js(dt,qe.tileID.canonical,me,se,re,ot.getProjection(),Tt),Qi=u.translatePosMatrix(Jn,qe,T,A,!0),mr=u.translatePosMatrix(dt,qe,T,A),Li=_i?fl:Si,Oo=se&&!me&&!zn,_l=He;!Pe&&!re.mercatorFromTransition||se||(_l=Bu(re));let Oa=Ah(Tr.kind,Oi,Oo,me,u,mr,Li,Qi,ie,!0,Po,Hr,0,$e,St,Te,qt,xt?_l:He,ot.getProjection(),$i,on,null,null,Ir),Ic=qe.glyphAtlasTexture?qe.glyphAtlasTexture:null,Sc=ue.LINEAR,Lo=o.paint.get("text-halo-width").constantOr(1)!==0,Is=u.terrain&&me&&zn?r.bi(r.bz(),Si):fl;if(zn&&ot.text){let er=re.elevation,ko=er?er.getAtTileOffsetFunc($e,re.center.lat,re.worldSize,ot.getProjection()):null,yl=Zl(dt,qe.tileID.canonical,me,se,re,ot.getProjection(),Tt);il(ot,dt,u,!0,yl,Jn,me,U,ko,$e)}return{program:pr,buffers:ot.text,uniformValues:Oa,atlasTexture:Ic,atlasTextureIcon:po,atlasInterpolation:Sc,atlasInterpolationIcon:ls,isSDF:!0,hasHalo:Lo,depthMode:Bi,tile:qe,renderWithShadows:qn,labelPlaneMatrixInv:Is}},Xn=ot.icon.segments.get().length,tn=ot.text.segments.get().length,En=Xn&&!v.onlyText?wn():null,Tn=tn&&!v.onlyIcons?Dn():null,Mn=o.paint.get("icon-opacity").constantOr(1),sn=o.paint.get("text-opacity").constantOr(1);if(Ne&&ot.canOverlap){Ce=!0;let zn=Mn&&!v.onlyText?ot.icon.segments.get():[],Cn=sn&&!v.onlyIcons?ot.text.segments.get():[];for(let _i of zn)Ie.push({segments:new r.bd([_i]),sortKey:_i.sortKey,state:En});for(let _i of Cn)Ie.push({segments:new r.bd([_i]),sortKey:_i.sortKey,state:Tn})}else v.onlyText||Ie.push({segments:Mn?ot.icon.segments:new r.bd([]),sortKey:0,state:En}),v.onlyIcons||Ie.push({segments:sn?ot.text.segments:new r.bd([]),sortKey:0,state:Tn})}Ce&&Ie.sort(($e,qe)=>$e.sortKey-qe.sortKey);for(let $e of Ie){let qe=$e.state;if(qe)if(u.terrain?u.terrain.setupElevationDraw(qe.tile,qe.program,{useDepthForOcclusion:re.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:qe.labelPlaneMatrixInv}):u.setupDepthForOcclusion(re.depthOcclusionForSymbolsAndCircles,qe.program),le.activeTexture.set(ue.TEXTURE0),qe.atlasTexture&&qe.atlasTexture.bind(qe.atlasInterpolation,ue.CLAMP_TO_EDGE,!0),qe.atlasTextureIcon&&(le.activeTexture.set(ue.TEXTURE1),qe.atlasTextureIcon&&qe.atlasTextureIcon.bind(qe.atlasInterpolationIcon,ue.CLAMP_TO_EDGE,!0)),qe.renderWithShadows&&u.shadowRenderer.setupShadows(qe.tile.tileID.toUnwrapped(),qe.program,"vector-tile"),u.uploadCommonLightUniforms(u.context,qe.program),qe.hasHalo){let ot=qe.uniformValues;ot.u_is_halo=1,Da(qe.buffers,$e.segments,o,u,qe.program,qe.depthMode,g,_,ot,2),ot.u_is_halo=0}else{if(qe.isSDF){let ot=qe.uniformValues;qe.hasHalo&&(ot.u_is_halo=1,Da(qe.buffers,$e.segments,o,u,qe.program,qe.depthMode,g,_,ot,1)),ot.u_is_halo=0}Da(qe.buffers,$e.segments,o,u,qe.program,qe.depthMode,g,_,qe.uniformValues,1)}}}function Da(u,t,o,h,g,_,v,E,T,C){let A=[u.dynamicLayoutVertexBuffer,u.opacityVertexBuffer,u.iconTransitioningVertexBuffer,u.globeExtVertexBuffer,u.zOffsetVertexBuffer,u.orientationVertexBuffer];g.draw(h,h.context.gl.TRIANGLES,_,v,E,At.disabled,T,o.id,u.layoutVertexBuffer,u.indexBuffer,t,o.paint,h.transform.zoom,u.programConfigurations.get(o.id),A,C)}function Vu(u,t){let o=1<<u.canonical.z,h=(t.x*o-u.canonical.x-u.wrap*o)*r.aj,g=(t.y*o-u.canonical.y)*r.aj,_=r.e2(t.z,t.y);return r.d2(h,g,_)}function gt(u,t,o,h,g){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let _=u.context.gl,v=new pt(u.context.gl.LEQUAL,pt.ReadWrite,u.depthRangeFor3D),E=new pt(u.context.gl.GREATER,pt.ReadWrite,u.depthRangeFor3D),T=function(k){let V=r.cU(k.pitch),z=.01;return k.isOrthographic&&(z=r.ai(1e-4,z,r.cZ(V>=fr?1:V/fr))),2*z}(u.transform),C=u.transform.getFreeCameraOptions().position,A="elevatedStructuresDepthReconstruct",L=u.getOrCreateProgram(A,{defines:["DEPTH_RECONSTRUCTION"]}),R=u.getOrCreateProgram(A);for(let k of h){let V=t.getTile(k),z=V.getBucket(o);if(!z)continue;let U=z.elevatedStructures;if(!U)continue;let j=z.elevationBufferData.heightRange,W=Vu(k.toUnwrapped(),C),Y=u.translatePosMatrix(k.projMatrix,V,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),J,ie,le,ue;if(g==="initialize"){if(!j||j.min>=1||U.depthSegments.segments[0].primitiveLength===0)continue;J=Ih(Y,W,T,1,0),ie=v,le=U.depthSegments,ue=L}else if(g==="reset"){if(!j||j.min>=0||U.maskSegments.segments[0].primitiveLength===0)continue;J=Ih(Y,W,0,0,1),ie=E,le=U.maskSegments,ue=L}else if(g==="geometry"){if(U.depthSegments.segments[0].primitiveLength===0)continue;J=Ih(Y,W,T,1,0),ie=v,le=U.depthSegments,ue=R}ue.draw(u,_.TRIANGLES,ie,Lt.disabled,Yt.disabled,At.disabled,J,o.id,U.vertexBuffer,U.indexBuffer,le,o.paint,u.transform.zoom)}}function Rh(u,t,o){let{painter:h,sourceCache:g,layer:_,coords:v,colorMode:E,elevationType:T,terrainEnabled:C,pass:A}=u,L=h.context.gl,R=_.paint.get("fill-pattern"),k=_.paint.get("fill-pattern-cross-fade"),V=R.constantOr(null),z=T;T!=="road"||t&&!C||(z="none");let U=z==="road",j=u.painter.shadowRenderer,W=U&&!!j&&j.enabled,Y=new pt(h.context.gl.LEQUAL,pt.ReadOnly,h.depthRangeFor3D),J=[0,0,0];if(W){let ue=h.style.directionalLight,re=h.style.ambientLight;ue&&re&&(J=sl(h.style,ue,re))}let ie=R&&R.constantOr(1),le=(ue,re)=>{let oe,se,Ee,me,Ne;re?(oe=ie&&!_.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Ee=L.LINES):(oe=ie?"fillPattern":"fill",Ee=L.TRIANGLES);for(let Ce of v){let Be=g.getTile(Ce);if(ie&&!Be.patternsLoaded())continue;let Qe=Be.getBucket(_);if(!Qe)continue;let Te=t?Qe.elevationBufferData:Qe.bufferData;if(Te.isEmpty())continue;h.prepareDrawTile();let pe=Te.programConfigurations.get(_.id),Pe=h.isTileAffectedByFog(Ce),Ie=[],He=[];U&&(Ie.push("ELEVATED_ROADS"),He.push(Te.elevatedLayoutVertexBuffer)),W&&Ie.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ie&&(h.context.activeTexture.set(L.TEXTURE0),Be.imageAtlasTexture&&Be.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),pe.updatePaintBuffers());let $e=!1;if(V&&Be.imageAtlas){let dt=Be.imageAtlas,Tt=r.dZ.from(V),wt=Tt.getPrimary().scaleSelf(r.q.devicePixelRatio).toString(),zt=Tt.getSecondary(),qt=dt.patternPositions.get(wt),on=zt?dt.patternPositions.get(zt.scaleSelf(r.q.devicePixelRatio).toString()):null;$e=!!qt&&!!on,qt&&pe.setConstantPatternPositions(qt,on)}k>0&&($e||pe.getPatternTransitionVertexBuffer("fill-pattern"))&&Ie.push("FILL_PATTERN_TRANSITION");let qe=h.getOrCreateProgram(oe,{config:pe,overrideFog:Pe,defines:Ie}),ot=h.translatePosMatrix(Ce.projMatrix,Be,_.paint.get("fill-translate"),_.paint.get("fill-translate-anchor"));W&&j.setupShadows(Be.tileID.toUnwrapped(),qe,"vector-tile");let xt=_.paint.get("fill-emissive-strength");if(re){me=Te.lineIndexBuffer,Ne=Te.lineSegments;let dt=h.terrain&&h.terrain.renderingToTexture?h.terrain.drapeBufferSize:[L.drawingBufferWidth,L.drawingBufferHeight];se=oe==="fillOutlinePattern"&&ie?Db(ot,xt,h,Be,dt,J,k):Sb(ot,xt,dt,J)}else me=Te.indexBuffer,Ne=Te.triangleSegments,se=ie?ly(ot,xt,h,Be,J,k):ay(ot,xt,J);h.uploadCommonUniforms(h.context,qe,Ce.toUnwrapped());let St=ue;(T==="road"&&!C||T==="offset")&&(St=Y),qe.draw(h,Ee,St,o||h.stencilModeForClipping(Ce),E,At.disabled,se,_.id,Te.layoutVertexBuffer,me,Ne,_.paint,h.transform.zoom,pe,He)}};h.renderPass===A&&le(h.depthModeForSublayer(1,h.renderPass==="opaque"?pt.ReadWrite:pt.ReadOnly),!1),z==="none"&&h.renderPass==="translucent"&&_.paint.get("fill-antialias")&&le(h.depthModeForSublayer(_.getPaintProperty("fill-outline-color")?2:0,pt.ReadOnly),!0)}function ju(u,t,o,h,g,_,v,E){o.resetLayerRenderingStats(u);let T=u.context,C=T.gl,A=u.transform,L=o.paint.get("fill-extrusion-pattern"),R=o.paint.get("fill-extrusion-pattern-cross-fade"),k=L.constantOr(null),V=L.constantOr(1),z=o.paint.get("fill-extrusion-opacity"),U=u.style.enable3dLights(),j=o.paint.get(U&&!V?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),W=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),j],Y=o.layout.get("fill-extrusion-edge-radius"),J=Y>0&&!o.paint.get("fill-extrusion-rounded-roof"),ie=J?0:Y,le=A.projection.name==="globe"?r.e5():0,ue=A.projection.name==="globe",re=ue?r.ah(A.zoom):0,oe=[r.aD(A.center.lng),r.aH(A.center.lat)],se=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Ee=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(se?null:o.lut).toArray01().slice(0,3),me=o.paint.get("fill-extrusion-flood-light-intensity"),Ne=o.paint.get("fill-extrusion-vertical-scale"),Ce=o.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Be=o.paint.get("fill-extrusion-height-alignment"),Qe=o.paint.get("fill-extrusion-base-alignment"),Te=xs(u,o.paint.get("fill-extrusion-cutoff-fade-range")),pe=[],Pe;ue&&pe.push("PROJECTION_GLOBE_VIEW"),W[0]>0&&pe.push("FAUX_AO"),J&&pe.push("ZERO_ROOF_RADIUS"),E&&pe.push("HAS_CENTROID"),me>0&&pe.push("FLOOD_LIGHT"),Te.shouldRenderCutoff&&pe.push("RENDER_CUTOFF"),Ce&&pe.push("RENDER_WALL_MODE");let Ie=u.renderPass==="shadow",He=u.shadowRenderer,$e=Ie&&!!He,qe=Ie?At.disabled:At.backCCW;u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!0);let ot=[0,0,0];if(He){let dt=u.style.directionalLight,Tt=u.style.ambientLight;dt&&Tt&&(ot=sl(u.style,dt,Tt)),Ie||(pe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),He.useNormalOffset&&pe.push("NORMAL_OFFSET")),Pe=pe.concat(["SHADOWS_SINGLE_CASCADE"])}let xt=$e?"fillExtrusionDepth":V?"fillExtrusionPattern":"fillExtrusion",St=o.getLayerRenderingStats();for(let dt of h){let Tt=t.getTile(dt),wt=Tt.getBucket(o);if(!wt||wt.projection.name!==A.projection.name)continue;let zt=!1;He&&(zt=He.getMaxCascadeForTile(dt.toUnwrapped())===0);let qt=u.isTileAffectedByFog(dt),on=wt.programConfigurations.get(o.id),bn=!1;if(k&&Tt.imageAtlas){let Tn=Tt.imageAtlas,Mn=r.dZ.from(k),sn=Mn.getPrimary().scaleSelf(r.q.devicePixelRatio).toString(),zn=Mn.getSecondary(),Cn=Tn.patternPositions.get(sn),_i=zn?Tn.patternPositions.get(zn.scaleSelf(r.q.devicePixelRatio).toString()):null;bn=!!Cn&&!!_i,Cn&&on.setConstantPatternPositions(Cn,_i)}R>0&&(bn||on.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&pe.push("FILL_EXTRUSION_PATTERN_TRANSITION");let Ht=u.getOrCreateProgram(xt,{config:on,defines:zt?Pe:pe,overrideFog:qt});if(u.terrain&&u.terrain.setupElevationDraw(Tt,Ht,{useMeterToDem:!0}),!wt.centroidVertexBuffer){let Tn=Ht.attributes.a_centroid_pos;Tn!==void 0&&C.vertexAttrib2f(Tn,0,0)}!Ie&&He&&He.setupShadows(Tt.tileID.toUnwrapped(),Ht,"vector-tile"),V&&(u.context.activeTexture.set(C.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),on.updatePaintBuffers());let wn=o.paint.get("fill-extrusion-vertical-gradient"),Dn=1/wt.tileToMeter,Xn;if(Ie&&He){if(Ph(Tt.tileID,wt.maxHeight,u))continue;let Tn=He.calculateShadowPassMatrixFromTile(Tt.tileID.toUnwrapped());Xn=sy(Tn,ie,Dn,Ne,Be,Qe)}else{let Tn=u.translatePosMatrix(dt.expandedProjMatrix,Tt,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),Mn=A.projection.createInversionMatrix(A,dt.canonical);Xn=V?cc(Tn,u,wn,z,W,ie,Dn,dt,Tt,le,Be,Qe,re,oe,Mn,Ee,Ne,R):Hp(Tn,u,wn,z,W,ie,Dn,dt,le,Be,Qe,re,oe,Mn,Ee,Ne,me,ot)}u.uploadCommonUniforms(T,Ht,dt.toUnwrapped(),null,Te);let tn=wt.segments;if(A.projection.name==="mercator"&&!Ie&&(tn=wt.getVisibleSegments(Tt.tileID,u.terrain,u.transform.getFrustum(0)),!tn.get().length))continue;if(St)if(Ie)for(let Tn of tn.get())St.numRenderedVerticesInShadowPass+=Tn.primitiveLength;else for(let Tn of tn.get())St.numRenderedVerticesInTransparentPass+=Tn.primitiveLength;let En=[];(u.terrain||E)&&En.push(wt.centroidVertexBuffer),ue&&En.push(wt.layoutVertexExtBuffer),Ce&&En.push(wt.wallVertexBuffer),Ht.draw(u,T.gl.TRIANGLES,g,_,v,qe,Xn,o.id,wt.layoutVertexBuffer,wt.indexBuffer,tn,o.paint,u.transform.zoom,on,En)}u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!1)}class $s{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function io(u,t,o,h,g,_,v,E,T,C,A,L,R,k,V,z,U,j,W,Y){let J=t.context,ie=J.gl,le=t.transform,ue=t.transform.zoom,re=[],oe=u.translate,se=u.translateAnchor,Ee=u.edgeRadius,me=xs(t,u.cutoffFadeRange);A==="clear"?(re.push("CLEAR_SUBPASS"),Y&&(re.push("CLEAR_FROM_TEXTURE"),J.activeTexture.set(ie.TEXTURE0),Y.bind(ie.LINEAR,ie.CLAMP_TO_EDGE))):A==="sdf"&&re.push("SDF_SUBPASS"),j&&re.push("HAS_CENTROID"),me.shouldRenderCutoff&&re.push("RENDER_CUTOFF");let Ne=(Ce,Be,Qe,Te,pe)=>{let Pe=Be.programConfigurations.get(h.id),Ie=t.isTileAffectedByFog(Ce),He=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:Pe,defines:re,overrideFog:Ie}),$e=((ot,xt,St,dt,Tt,wt,zt,qt,on,bn,Ht)=>({u_matrix:xt,u_opacity:St,u_ao_pass:dt?1:0,u_meter_to_tile:Tt,u_ao:wt,u_flood_light_intensity:zt,u_flood_light_color:qt,u_attenuation:on,u_edge_radius:bn,u_fb:0,u_fb_size:Ht,u_dynamic_offset:1}))(0,Te,L,C,pe,[R,k*pe],V,z,U,ue>=17?0:Ee*pe,Y?Y.size[0]:0),qe=[];j&&qe.push(Be.hiddenByLandmarkVertexBuffer),t.uploadCommonUniforms(J,He,Ce.toUnwrapped(),null,me),He.draw(t,J.gl.TRIANGLES,_,v,E,T,$e,h.id,Be.vertexBuffer,Be.indexBuffer,Qe,h.paint,ue,Pe,qe)};for(let Ce of g){let Be=o.getTile(Ce),Qe=Be.getBucket(h);if(!Qe||Qe.projection.name!==le.projection.name||!Qe.groundEffect||Qe.groundEffect&&!Qe.groundEffect.hasData())continue;let Te=Qe.groundEffect,pe=1/Qe.tileToMeter;{let Pe=t.translatePosMatrix(Ce.projMatrix,Be,oe,se),Ie=Te.getDefaultSegment();Ne(Ce,Te,Ie,Pe,pe)}if(W)for(let Pe=0;Pe<4;Pe++){let Ie=r.e3[Pe](Ce),He=o.getTile(Ie);if(!He)continue;let $e=He.getBucket(h);if(!$e||$e.projection.name!==le.projection.name||!$e.groundEffect||$e.groundEffect&&!$e.groundEffect.hasData())continue;let qe=$e.groundEffect,ot,xt;Pe===0?(ot=[-r.aj,0,0],xt=1):Pe===1?(ot=[r.aj,0,0],xt=0):Pe===2?(ot=[0,-r.aj,0],xt=3):(ot=[0,r.aj,0],xt=2);let St=qe.regionSegments[xt];if(!St)continue;let dt=new Float32Array(16);r.bo(dt,Ce.projMatrix,ot),Ne(Ce,qe,St,t.translatePosMatrix(dt,Be,oe,se),pe)}}}function Rt(u,t,o,h,g,_,v){h.centroidVertexArray.length===0&&h.createCentroidsBuffer();let E=_?_.findDEMTileFor(o):null;if(!(E&&E.dem||v))return;_&&E&&E.dem&&h.selfDEMTileTimestamp!==E.dem._timestamp&&(h.borderDoneWithNeighborZ=[-1,-1,-1,-1],h.selfDEMTileTimestamp=E.dem._timestamp);let T=j=>new r.P(Math.ceil((j+r.e7)*r.e8),0),C=j=>{let W=t.getSource().minzoom,Y=ie=>{let le=t.getTileByID(ie);if(le&&le.hasData())return le.getBucket(g)},J=[0,-1,1];for(let ie of J){if(j.overscaledZ+ie<W)continue;let le=Y(j.calculateScaledKey(j.overscaledZ+ie));if(le)return le}},A=[0,0,0],L=(j,W)=>(A[0]=Math.min(j.min.y,W.min.y),A[1]=Math.max(j.max.y,W.max.y),A[2]=r.aj-W.min.x>j.max.x?W.min.x-r.aj:j.max.x,A),R=(j,W)=>(A[0]=Math.min(j.min.x,W.min.x),A[1]=Math.max(j.max.x,W.max.x),A[2]=r.aj-W.min.y>j.max.y?W.min.y-r.aj:j.max.y,A),k=[(j,W)=>L(j,W),(j,W)=>L(W,j),(j,W)=>R(j,W),(j,W)=>R(W,j)],V=(j,W,Y,J,ie,le,ue)=>{if(!_)return 0;let re=[[le?Y:j,le?j:Y,0],[le?Y:W,le?W:Y,0]],oe=ue<0?r.aj+ue:ue,se=[le?oe:(j+W)/2,le?(j+W)/2:oe,0];return Y===0&&ue<0||Y!==0&&ue>0?_.getForTilePoints(ie,[se],!0,J):re.push(se),_.getForTilePoints(o,re,!0,E),Math.max(re[0][2],re[1][2],se[2])/_.exaggeration()};for(let j=0;j<4;j++){let W=h.borderFeatureIndices[j];if(W.length===0)continue;let Y=r.e3[j](o),J=C(Y);if(!(J&&J instanceof r.e4))continue;let ie=_?_.findDEMTileFor(Y):null;if(!(ie&&ie.dem||v)||(_&&ie&&ie.dem&&h.borderDEMTileTimestamp[j]!==ie.dem._timestamp&&(h.borderDoneWithNeighborZ[j]=-1,h.borderDEMTileTimestamp[j]=ie.dem._timestamp),h.borderDoneWithNeighborZ[j]===J.canonical.z))continue;J.centroidVertexArray.length===0&&J.createCentroidsBuffer();let le=(j<2?1:5)-j,ue=J.borderDoneWithNeighborZ[le]!==h.canonical.z,re=J.borderFeatureIndices[le],oe=0;if(h.canonical.z!==J.canonical.z){for(let se of W)h.showCentroid(h.featuresOnBorder[se]);if(ue)for(let se of re)J.showCentroid(J.featuresOnBorder[se]);h.borderDoneWithNeighborZ[j]=J.canonical.z,J.borderDoneWithNeighborZ[le]=h.canonical.z}for(let se of W){let Ee=h.featuresOnBorder[se],me=h.centroidData[Ee.centroidDataIndex],Ne=Ee.borders[j],Ce;for(;oe<re.length;){Ce=J.featuresOnBorder[re[oe]];let Be=Ce.borders[le];if(Be[1]>Ne[0]+3||Be[0]>Ne[0]-3)break;J.showCentroid(Ce),oe++}if(Ce&&oe<re.length){let Be=oe,Qe=0;for(;!(Ce.borders[le][0]>Ne[1]-3)&&(Qe++,++oe!==re.length);)Ce=J.featuresOnBorder[re[oe]];Ce=J.featuresOnBorder[re[Be]];let Te=!1;if(Qe>=1){let Ie=Ce.borders[le];Math.abs(Ne[0]-Ie[0])<3&&Math.abs(Ne[1]-Ie[1])<3&&(Qe=1,Te=!0,oe=Be+1)}else if(Qe===0){h.showCentroid(Ee);continue}let pe=J.centroidData[Ce.centroidDataIndex];v&&Te&&(((z=me).flags|(U=pe).flags)&r.e6?(z.flags|=r.e6,U.flags|=r.e6):(z.flags&=~r.e6,U.flags&=~r.e6));let Pe=Ee.intersectsCount()>1||Ce.intersectsCount()>1;if(Qe>1)oe=Be,me.centroidXY=pe.centroidXY=new r.P(0,0);else if(ie&&ie.dem&&!Pe){let Ie=k[j](me,pe),He=j%2?r.aj-1:0,$e=V(Ie[0],Math.min(r.aj-1,Ie[1]),He,ie,Y,j<2,Ie[2]);me.centroidXY=pe.centroidXY=T($e)}else Pe?me.centroidXY=pe.centroidXY=new r.P(0,0):(me.centroidXY=h.encodeBorderCentroid(Ee),pe.centroidXY=J.encodeBorderCentroid(Ce));h.writeCentroidToBuffer(me),J.writeCentroidToBuffer(pe)}else h.showCentroid(Ee)}h.borderDoneWithNeighborZ[j]=J.canonical.z,J.borderDoneWithNeighborZ[le]=h.canonical.z}var z,U;(h.needsCentroidUpdate||!h.centroidVertexBuffer&&h.centroidVertexArray.length!==0)&&h.uploadCentroid(u)}let tm=[1,0,0],Ab=[0,1,0],Mb=[0,0,1];function Ph(u,t,o){let h=o.transform,g=o.shadowRenderer;if(!g)return!0;let _=u.toUnwrapped(),v=h.tileSize*g._cascades[o.currentShadowCascade].scale,E=t;if(h.elevation){let z=h.elevation.getMinMaxForTile(u);z&&(E+=z.max)}let T=[...g.shadowDirection];T[2]=-T[2];let C=g.computeSimplifiedTileShadowVolume(_,E,v,T);if(!C)return!1;let A=[tm,Ab,Mb,T,[T[0],0,T[2]],[0,T[1],T[2]]],L=h.projection.name==="globe",R=h.scaleZoom(v),k=r.cy.fromInvProjectionMatrix(h.invProjMatrix,h.worldSize,R,!L),V=g.getCurrentCascadeFrustum();return k.intersectsPrecise(C.vertices,C.planes,A)===0||V.intersectsPrecise(C.vertices,C.planes,A)===0}function Oh(u){let{painter:t,source:o,layer:h,coords:g}=u,_=u.defines,v=t.context,E=t.renderPass==="shadow",T=t.renderPass==="light-beam",C=t.shadowRenderer,A;C&&(A=_.concat(["SHADOWS_SINGLE_CASCADE"]));let L=r.e9(t.transform.center.lat,t.transform.zoom);for(let R of g){let k=o.getTile(R),V=k.getBucket(h);if(!V)continue;let z=!1;C&&(z=C.getMaxCascadeForTile(R.toUnwrapped())===0);let U=V.programConfigurations.get(h.id),j,W,Y=t.translatePosMatrix(R.expandedProjMatrix,k,[0,0],"map");if(Y=r.cP(r.bz(),Y,[1,1,u.verticalScale]),E&&C){if(Ph(k.tileID,V.maxHeight*L,t))continue;let J=C.calculateShadowPassMatrixFromTile(k.tileID.toUnwrapped());J=r.cP(r.bz(),J,[1,1,u.verticalScale]),W=cy(J),j=t.getOrCreateProgram("buildingDepth",{config:U,defines:z?A:_,overrideFog:!1})}else if(T)j=t.getOrCreateProgram("buildingBloom",{config:U,defines:z?A:_,overrideFog:!1}),W=Gp(Y);else{let J=t.transform.calculatePosMatrix(R.toUnwrapped(),t.transform.worldSize);r.cP(J,J,[1,1,u.verticalScale]);let ie=r.bz();r.cP(ie,J,[1,-1,1/L]),r.bi(ie,ie),r.ea(ie,ie),W=$p(Y,ie),j=t.getOrCreateProgram("building",{config:U,defines:z?A:_,overrideFog:!1}),C&&C.setupShadowsFromMatrix(J,j,!0)}if(t.uploadCommonUniforms(v,j,R.toUnwrapped(),null,null),T){let J=V.bloomGeometry;j.draw(t,v.gl.TRIANGLES,u.depthMode,Lt.disabled,u.blendMode,At.disabled,W,h.id,J.layoutVertexBuffer,J.indexBuffer,J.segmentsBucket,h.paint,t.transform.zoom,U,[J.layoutAttenuationBuffer,J.layoutColorBuffer])}else j.draw(t,v.gl.TRIANGLES,u.depthMode,Lt.disabled,u.blendMode,E?At.disabled:At.backCW,W,h.id,V.layoutVertexBuffer,V.indexBuffer,V.segments,h.paint,t.transform.zoom,U,[V.layoutNormalBuffer,V.layoutColorBuffer])}}function vy(u){return[u[0]*r.eb,u[1]*r.eb,u[2]*r.eb,0]}function Lh(u,t,o,h,g,_,v,E,T){let C=h.getSource(),A=o.globeSharedBuffers;if(!A)return;let L,R,k;if(t&&(L=h.getTile(t)),C instanceof r.aP?(R=C.texture,k=r.dE(0,0,o.transform)):L&&t&&(R=L.texture,k=r.dE(t.canonical.z,t.canonical.x,o.transform)),!R||!k)return;u||(k=r.cP(r.bz(),k,[1,-1,1]));let V=o.context,z=V.gl,U=g.paint.get("raster-resampling")==="nearest"?z.NEAREST:z.LINEAR,j=o.colorModeForDrapableLayerRenderPass(_),W=v.defines;W.push("GLOBE_POLES");let Y=new pt(z.LEQUAL,pt.ReadWrite,o.depthRangeFor3D),J=Float32Array.from(o.transform.expandedFarZProjMatrix),ie=Float32Array.from(r.bh(r.dD(new r.cA(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),V.activeTexture.set(z.TEXTURE0),R.bind(U,z.CLAMP_TO_EDGE),V.activeTexture.set(z.TEXTURE1),R.bind(U,z.CLAMP_TO_EDGE),"useMipmap"in R&&V.extTextureFilterAnisotropic&&o.transform.pitch>20&&z.texParameterf(z.TEXTURE_2D,V.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,V.extTextureFilterAnisotropicMax);let[le,ue,re,oe]=t?A.getPoleBuffers(t.canonical.z,!1):A.getPoleBuffers(0,!0),se=g.paint.get("raster-elevation"),Ee;u?(Ee=le,o.renderDefaultNorthPole=se!==0):(Ee=ue,o.renderDefaultSouthPole=se!==0);let me=vy(v.mix),Ne=((Be,Qe,Te,pe,Pe,Ie,He,$e,qe,ot,xt,St,dt)=>Wp(Be,Qe,Te,new Float32Array(16),new Float32Array(9),[0,0],pe,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Ie,[0,0],$e,2,ot,xt,St,1,0,dt))(J,ie,k,r.ah(o.transform.zoom),0,g,0,se,0,me,v.offset,v.range,_),Ce=o.getOrCreateProgram("raster",{defines:W});o.uploadCommonUniforms(V,Ce,null),Ce.draw(o,z.TRIANGLES,Y,T,j,E,Ne,g.id,Ee,re,oe)}function Rb(u){let t=u._nearZ,o=u.projection.farthestPixelDistance(u),h=o-t,g=.2*u.height,_=t+g;return[t,o,(_-g-t)/h,(_-t)/h]}function Pb(u,t,o,h){if(u)return t instanceof pa&&u instanceof $l?t.getTextureDescriptor(u,o,!0):{texture:u.texture,mix:vy(h.mix),offset:h.offset,buffer:0,tileSize:1}}var fo=r.ec([{name:"a_index",type:"Int16",components:1}]);class nm{constructor(t,o,h,g){let _={width:h[0],height:h[1],data:null},v=t.gl;this.targetColorTexture=new r.T(t,_,v.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new r.T(t,_,v.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(o,g),this.lastInvalidatedAt=0}updateParticleTexture(t,o){if(this.particleTextureDimension===o.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let h=this.context.gl,g=o.width*o.height;this.particleTexture0=new r.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new r.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1});let _=new r.ed;_.reserve(g);for(let v=0;v<g;v++)_.emplaceBack(v);this.particleIndexBuffer=this.context.createVertexBuffer(_,fo.members,!0),this.particleSegment=r.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=o.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=r.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function jr(u,t,o){if(!u)return null;let h=t.getTextureDescriptor(u,o,!0);if(!h)return null;let{texture:g,mix:_,offset:v,tileSize:E,buffer:T,format:C}=h;if(!g||!C)return null;let A=!1;return C==="uint32"&&(A=!0,_[3]=0,_=Sh(r.ee,_,[0,o.paint.get("raster-particle-max-speed")]),v=Ea(r.ee,v,[0,o.paint.get("raster-particle-max-speed")])),{texture:g,textureOffset:[T/(E+2*T),E/(E+2*T)],tileSize:E,scalarData:A,scale:_,offset:v,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[C]]}}function Ca(u){let t=u._nearZ,o=u.projection.farthestPixelDistance(u),h=o-t,g=.2*u.height,_=t+g;return[t,o,(_-g-t)/h,(_-t)/h]}let xy=new r.am(1,0,0,1),im=new r.am(0,1,0,1),rm=new r.am(0,0,1,1),om=new r.am(1,0,1,1),by=new r.am(0,1,1,1);function bs(u,t,o,h,g,_){for(let v=0;v<o.length;v++)if(g){let C=new r.am(h.r*.8,h.g*.8,h.b*.8,1);Un(u,t,o[v],h,-1,-1,_),Un(u,t,o[v],h,-1,1,_),Un(u,t,o[v],h,1,1,_),Un(u,t,o[v],h,1,-1,_),Un(u,t,o[v],C,0,0,_)}else Un(u,t,o[v],h,0,0,_)}function Un(u,t,o,h,g,_,v){let E=u.context,T=u.transform,C=E.gl,A=T.projection.name==="globe",L=A?["PROJECTION_GLOBE_VIEW"]:[],R=r.bw(o.projMatrix);if(A&&r.ah(T.zoom)>0){let me=r.bg(o.canonical,T),Ne=r.ef(me);R=r.az(new Float32Array(16),T.globeMatrix,Ne),r.az(R,T.projMatrix,R)}let k=r.bz();k[12]+=2*g/(r.q.devicePixelRatio*T.width),k[13]+=2*_/(r.q.devicePixelRatio*T.height),r.az(R,k,R);let V=u.getOrCreateProgram("debug",{defines:L}),z=t.getTileByID(o.key);u.terrain&&u.terrain.setupElevationDraw(z,V);let U=pt.disabled,j=Lt.disabled,W=u.colorModeForRenderPass(),Y="$debug";E.activeTexture.set(C.TEXTURE0),u.emptyTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),A?z._makeGlobeTileDebugBuffers(u.context,T):z._makeDebugTileBoundsBuffers(u.context,T.projection);let J=z._tileDebugBuffer||u.debugBuffer,ie=z._tileDebugIndexBuffer||u.debugIndexBuffer,le=z._tileDebugSegments||u.debugSegments;if(V.draw(u,C.LINE_STRIP,U,j,W,At.disabled,qp(R,h.toPremultipliedRenderColor(null)),Y,J,ie,le,null,null,null,[z._globeTileDebugBorderBuffer]),v){let me=z.latestRawTileData,Ne=Math.floor((me&&me.byteLength||0)/1024),Ce=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(Ce+=` => ${o.overscaledZ}`),Ce+=` ${z.state}`,Ce+=` ${Ne}kb`,function(Be,Qe){Be.initDebugOverlayCanvas();let Te=Be.debugOverlayCanvas,pe=Be.context.gl,Pe=Be.debugOverlayCanvas.getContext("2d");Pe.clearRect(0,0,Te.width,Te.height),Pe.shadowColor="white",Pe.shadowBlur=2,Pe.lineWidth=1.5,Pe.strokeStyle="white",Pe.textBaseline="top",Pe.font="bold 36px Open Sans, sans-serif",Pe.fillText(Qe,5,5),Pe.strokeText(Qe,5,5),Be.debugOverlayTexture.update(Te),Be.debugOverlayTexture.bind(pe.LINEAR,pe.CLAMP_TO_EDGE)}(u,Ce)}let ue=t.getTile(o).tileSize,re=512/Math.min(ue,512)*(o.overscaledZ/T.zoom)*.5,oe=z._tileDebugTextBuffer||u.debugBuffer,se=z._tileDebugTextIndexBuffer||u.quadTriangleIndexBuffer,Ee=z._tileDebugTextSegments||u.debugSegments;V.draw(u,C.TRIANGLES,U,j,Yt.alphaBlended,At.disabled,qp(R,r.am.transparent.toPremultipliedRenderColor(null),re),Y,oe,se,Ee,null,null,null,[z._globeTileDebugTextBuffer])}function Uu(u,t,o,h){Hu(u,0,t+o/2,u.transform.width,o,h)}function kh(u,t,o,h){Hu(u,t-o/2,0,o,u.transform.height,h)}function Hu(u,t,o,h,g,_){let v=u.context,E=v.gl;E.enable(E.SCISSOR_TEST),E.scissor(t*r.q.devicePixelRatio,o*r.q.devicePixelRatio,h*r.q.devicePixelRatio,g*r.q.devicePixelRatio),v.clear({color:_}),E.disable(E.SCISSOR_TEST)}let wy=r.ec([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Ey}=wy;function Aa(u,t,o,h){u.emplaceBack(t,o,h)}class pl{constructor(t){this.vertexArray=new r.eg,this.indices=new r.a_,Aa(this.vertexArray,-1,-1,1),Aa(this.vertexArray,1,-1,1),Aa(this.vertexArray,-1,1,1),Aa(this.vertexArray,1,1,1),Aa(this.vertexArray,-1,-1,-1),Aa(this.vertexArray,1,-1,-1),Aa(this.vertexArray,-1,1,-1),Aa(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Ey),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=r.bd.simpleSegment(0,0,36,12)}}function as(u,t,o,h,g,_){let v=u.context.gl,E=t.paint.get("sky-atmosphere-color"),T=t.paint.get("sky-atmosphere-halo-color"),C=t.paint.get("sky-atmosphere-sun-intensity"),A=((L,R,k,V,z)=>({u_matrix_3f:L,u_sun_direction:R,u_sun_intensity:k,u_color_tint_r:[V.r,V.g,V.b,V.a],u_color_tint_m:[z.r,z.g,z.b,z.a],u_luminance:5e-5}))(r.ei(r.dJ(),h),g,C,E.toPremultipliedRenderColor(null),T.toPremultipliedRenderColor(null));v.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,v.TEXTURE_CUBE_MAP_POSITIVE_X+_,t.skyboxTexture,0),o.draw(u,v.TRIANGLES,pt.disabled,Lt.disabled,Yt.unblended,At.frontCW,A,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}let tt=r.ec([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class ut{constructor(t){let o=new r.ej;o.emplaceBack(-1,1,1,0,0),o.emplaceBack(1,1,1,1,0),o.emplaceBack(1,-1,1,1,1),o.emplaceBack(-1,-1,1,0,1);let h=new r.a_;h.emplaceBack(0,1,2),h.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(o,tt.members),this.indexBuffer=t.createIndexBuffer(h),this.segments=r.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let dc=r.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Mi{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class xe{constructor(t){this.colorModeAlphaBlendedWriteRGB=new Yt([1,ol,1,ol],r.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Yt([1,0,1,0],r.am.transparent,[!1,!1,!1,!0]),this.params=new Mi,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){let o=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new ut(o);let h=this.params.sizeRange,g=this.params.intensityRange,_=function(A){let L=r.el(30),R=[];for(let k=0;k<A;++k){let V=2*Math.PI*L(),z=Math.acos(1-2*L())-.5*Math.PI;R.push(r.d2(Math.cos(z)*Math.cos(V),Math.cos(z)*Math.sin(V),Math.sin(z)))}return R}(this.params.starsCount),v=r.el(300),E=new r.ek,T=new r.a_,C=0;for(let A=0;A<_.length;++A){let L=r.c1([],_[A],200),R=Math.max(0,1+.01*h*(1*v()-.5)),k=Math.max(0,1+.01*g*(1*v()-.5));E.emplaceBack(L[0],L[1],L[2],-1,-1,R,k),E.emplaceBack(L[0],L[1],L[2],1,-1,R,k),E.emplaceBack(L[0],L[1],L[2],1,1,R,k),E.emplaceBack(L[0],L[1],L[2],-1,1,R,k),T.emplaceBack(C+0,C+1,C+2),T.emplaceBack(C+0,C+2,C+3),C+=4}this.starsVx=o.createVertexBuffer(E,dc.members),this.starsIdx=o.createIndexBuffer(T),this.starsSegments=r.bd.simpleSegment(0,0,E.length,T.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,o){let h=t.context,g=h.gl,_=t.transform,v=new pt(g.LEQUAL,pt.ReadOnly,[0,1]),E=r.ah(_.zoom),T=t.style.getLut(o.scope),C=o.properties.get("color-use-theme")==="none",A=o.properties.get("color").toNonPremultipliedRenderColor(C?null:T).toArray01(),L=o.properties.get("high-color-use-theme")==="none",R=o.properties.get("high-color").toNonPremultipliedRenderColor(L?null:T).toArray01(),k=o.properties.get("space-color-use-theme")==="none",V=o.properties.get("space-color").toNonPremultipliedRenderColor(k?null:T).toArray01(),z=5e-4,U=r.em(o.properties.get("horizon-blend"),0,1,z,.25),j=r.dy(t,h,_)&&U===z?_.worldSize/(2*Math.PI*1.025)-1:_.globeRadius,W=t.frameCounter/1e3%1,Y=r.ae(_.globeCenterInViewSpace),J=Math.sqrt(Math.pow(Y,2)-Math.pow(j,2)),ie=Math.acos(J/Y),le=ue=>{let re=_.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];ue&&re.push("ALPHA_PASS");let oe=t.getOrCreateProgram("globeAtmosphere",{defines:re}),se=((me,Ne,Ce,Be,Qe,Te,pe,Pe,Ie,He,$e,qe)=>({u_frustum_tl:me,u_frustum_tr:Ne,u_frustum_br:Ce,u_frustum_bl:Be,u_horizon:Qe,u_transition:Te,u_fadeout_range:pe,u_color:Pe,u_high_color:Ie,u_space_color:He,u_temporal_offset:$e,u_horizon_angle:qe}))(_.frustumCorners.TL,_.frustumCorners.TR,_.frustumCorners.BR,_.frustumCorners.BL,_.frustumCorners.horizon,E,U,A,R,V,W,ie);t.uploadCommonUniforms(h,oe);let Ee=this.atmosphereBuffer;Ee&&oe.draw(t,g.TRIANGLES,v,Lt.disabled,ue?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,At.backCW,se,ue?"atmosphere_glow_alpha":"atmosphere_glow",Ee.vertexBuffer,Ee.indexBuffer,Ee.segments)};le(!1),le(!0)}drawStars(t,o){let h=r.ay(o.properties.get("star-intensity"),0,1);if(h===0)return;let g=t.context,_=g.gl,v=t.transform,E=t.getOrCreateProgram("stars"),T=r.c3([]);r.c5(T,T,-v._pitch),r.c4(T,T,-v.angle),r.c5(T,T,r.al(v._center.lat)),r.en(T,T,-r.al(v._center.lng));let C=r.c8(new Float32Array(16),T),A=r.az([],v.starsProjMatrix,C),L=r.ei([],C),R=r.eo([],L),k=[0,1,0];r.dL(k,k,R),r.c1(k,k,this.params.sizeMultiplier);let V=[1,0,0];r.dL(V,V,R),r.c1(V,V,this.params.sizeMultiplier);let z=(U=k,j=V,W=h,{u_matrix:Float32Array.from(A),u_up:U,u_right:j,u_intensity_multiplier:W});var U,j,W;t.uploadCommonUniforms(g,E),this.starsVx&&this.starsIdx&&E.draw(t,_.TRIANGLES,pt.disabled,Lt.disabled,this.colorModeAlphaBlendedWriteRGB,At.disabled,z,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class Ty{constructor(){this.visibleTiles=[]}updateBorders(t,o){let h=[],g=[],_=t._getRenderableCoordinates(!1,!0);for(let T of _){let C=t.getTile(T);if(!C.hasData())continue;let A=C.getBucket(o);A&&(A.isEmpty()||(h.push(T.key),g.push({bucket:A,tileID:T.canonical})))}let v=h.length!==this.visibleTiles.length;if(!v){h.sort();for(let T=0;T<h.length;T++)if(h[T]!==this.visibleTiles[T]){v=!0;break}}if(!v)return;let E=new Set;this.visibleTiles=h,g.sort((T,C)=>T.tileID.z-C.tileID.z||T.tileID.x-C.tileID.x||T.tileID.y-C.tileID.y);for(let T of g){let C=new Array,A=new Array,L=T.bucket;for(let R of L.featuresOnBorder)E.has(R.featureId)?A.push(R.footprintIndex):(E.add(R.featureId),C.push(R.footprintIndex));L.updateFootprintHiddenFlags(C,r.ep,!1),L.updateFootprintHiddenFlags(A,r.ep,!0)}}}function $u(u,t){let o=[...u],h=t.cameraWorldSizeForFog/t.worldSize,g=r.bx([]);return r.cP(g,g,[h,h,1]),r.az(o,g,o),r.az(o,t.worldToFogMatrix,o),o}function Gu(u,t,o,h,g){let _=o.material,v=h.context,{baseColorTexture:E,metallicRoughnessTexture:T}=_.pbrMetallicRoughness,{normalTexture:C,occlusionTexture:A,emissionTexture:L}=_;function R(V,z,U){if(V&&(u.push(z),v.activeTexture.set(v.gl.TEXTURE0+U),V.gfxTexture)){let{minFilter:j,magFilter:W,wrapS:Y,wrapT:J}=V.sampler;V.gfxTexture.bindExtraParam(j,W,Y,J)}}R(E,"HAS_TEXTURE_u_baseColorTexture",Vr.BaseColor),R(T,"HAS_TEXTURE_u_metallicRoughnessTexture",Vr.MetallicRoughness),R(C,"HAS_TEXTURE_u_normalTexture",Vr.Normal),R(A,"HAS_TEXTURE_u_occlusionTexture",Vr.Occlusion),R(L,"HAS_TEXTURE_u_emissionTexture",Vr.Emission),g&&(g.texture||(g.texture=new r.et(h.context,g.image,[g.image.height,g.image.height,g.image.height],v.gl.RGBA8)),v.activeTexture.set(v.gl.TEXTURE0+Vr.LUT),g.texture&&g.texture.bind(v.gl.LINEAR,v.gl.CLAMP_TO_EDGE),u.push("APPLY_LUT_ON_GPU")),o.texcoordBuffer&&(u.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(o.texcoordBuffer)),o.colorBuffer&&(u.push(o.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(o.colorBuffer)),o.normalBuffer&&(u.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(o.normalBuffer)),o.pbrBuffer&&(u.push("HAS_ATTRIBUTE_a_pbr"),u.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(o.pbrBuffer)),_.alphaMode!=="OPAQUE"&&_.alphaMode!=="MASK"||u.push("UNPREMULT_TEXTURE_IN_SHADER"),_.defined||u.push("DIFFUSE_SHADED");let k=h.shadowRenderer;k&&(u.push("RENDER_SHADOWS","DEPTH_TEXTURE"),k.useNormalOffset&&u.push("NORMAL_OFFSET"))}function hc(u,t,o,h,g,_){let v=o.paint.get("model-opacity").constantOr(1),E=t.context,T=new pt(t.context.gl.LEQUAL,pt.ReadWrite,t.depthRangeFor3D),C=t.transform,A=u.mesh,L=A.material,R=L.pbrMetallicRoughness,k=t.style.fog,V;V=t.transform.projection.zAxisUnit==="pixels"?[...u.nodeModelMatrix]:r.az([],h.zScaleMatrix,u.nodeModelMatrix),r.az(V,h.negCameraPosMatrix,V);let z=r.bi([],V);r.ea(z,z);let U=o.paint.get("model-color-use-theme").constantOr("default")==="none",j=o.paint.get("model-emissive-strength").constantOr(0),W=Xp(new Float32Array(u.worldViewProjection),new Float32Array(V),new Float32Array(z),null,t,v,R.baseColorFactor,L.emissiveFactor,R.metallicFactor,R.roughnessFactor,L,j,o),Y={defines:[]},J=[],ie=t.shadowRenderer;ie&&(ie.useNormalOffset=!1),Gu(Y.defines,J,A,t,U?null:o.lut);let le=null;if(k){let oe=$u(u.nodeModelMatrix,t.transform);if(le=new Float32Array(oe),C.projection.name!=="globe"){let se=A.aabb.min,Ee=A.aabb.max,[me,Ne]=k.getOpacityForBounds(oe,se[0],se[1],Ee[0],Ee[1]);Y.overrideFog=me>=je||Ne>=je}}let ue=xs(t,o.paint.get("model-cutoff-fade-range"));ue.shouldRenderCutoff&&Y.defines.push("RENDER_CUTOFF");let re=t.getOrCreateProgram("model",Y);t.uploadCommonUniforms(E,re,null,le,ue),t.renderPass!=="shadow"&&ie&&ie.setupShadowsFromMatrix(u.nodeModelMatrix,re),re.draw(t,E.gl.TRIANGLES,T,g,_,A.material.doubleSided?At.disabled:At.backCCW,W,o.id,A.vertexBuffer,A.indexBuffer,A.segments,o.paint,t.transform.zoom,void 0,J)}function sm(u,t,o,h,g,_,v){let E;E=u.projection.name==="globe"?r.er(o,u):[...o],r.az(E,E,t.matrix);let T=r.az([],h,E);if(t.meshes)for(let C of t.meshes){if(C.material.alphaMode!=="BLEND"){v.push({mesh:C,depth:0,modelIndex:g,worldViewProjection:T,nodeModelMatrix:E});continue}let A=r.ad([],C.centroid,T);!u.isOrthographic&&A[2]<=0||_.push({mesh:C,depth:A[2],modelIndex:g,worldViewProjection:T,nodeModelMatrix:E})}if(t.children)for(let C of t.children)sm(u,C,o,h,g,_,v)}function Fh(u,t,o,h){let g=o.shadowRenderer;if(!g)return;let _=g.getShadowPassDepthMode(),v=g.getShadowPassColorMode(),E=g.calculateShadowPassMatrixFromMatrix(t),T=my(E);o.getOrCreateProgram("modelDepth",{defines:o._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(o,o.context.gl.TRIANGLES,_,Lt.disabled,v,At.backCCW,T,h.id,u.vertexBuffer,u.indexBuffer,u.segments,h.paint,o.transform.zoom,void 0,void 0)}function fc(u,t,o){let h=t.updateZoomBasedPaintProperties(),g=function(_,v,E){let T,C,A,L=_.terrain?_.terrain.exaggeration():0;if(_.terrain&&L>0){let R=_.terrain,k=R.findDEMTileFor(E);k&&k.dem?T=r.eu.create(R,E,k):L=0}if(L===0&&(v.terrainElevationMin=0,v.terrainElevationMax=0),L===v.validForExaggeration&&(L===0||T&&T._demTile&&T._demTile.tileID===v.validForDEMTile.id&&T._dem._timestamp===v.validForDEMTile.timestamp))return!1;for(let R in v.instancesPerModel){let k=v.instancesPerModel[R];for(let V=0;V<k.instancedDataArray.length;++V){let z=(T?L*T.getElevationAt(0|k.instancedDataArray.float32[16*V],0|k.instancedDataArray.float32[16*V+1],!0,!0):0)+k.instancesEvaluatedElevation[V];k.instancedDataArray.float32[16*V+6]=z,C=C?Math.min(v.terrainElevationMin,z):z,A=A?Math.max(v.terrainElevationMax,z):z}}return v.terrainElevationMin=C||0,v.terrainElevationMax=A||0,v.validForExaggeration=L,v.validForDEMTile=T&&T._demTile?{id:T._demTile.tileID,timestamp:T._dem._timestamp}:{id:void 0,timestamp:0},!0}(u,t,o);(h||g)&&(t.uploaded=!1,t.upload(u.context))}let ws={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new r.d6([0,0,0],[r.aj,r.aj,0])};function Ob(u,t){let o=1<<u.canonical.z,h=t.getFreeCameraOptions().position,g=t.elevation,_=u.canonical.x/o,v=(u.canonical.x+1)/o,E=u.canonical.y/o,T=(u.canonical.y+1)/o,C=t._centerAltitude;if(g){let k=g.getMinMaxForTile(u);k&&k.max>C&&(C=k.max)}let A=r.ay(h.x,_,v)-h.x,L=r.ay(h.y,E,T)-h.y,R=r.cb(C,t.center.lat)-h.z;return t._zoomFromMercatorZ(Math.sqrt(A*A+L*L+R*R))}function am(u,t,o,h,g,_,v){let E=u.context,T=u.renderPass==="shadow",C=u.shadowRenderer,A=T&&C?C.getShadowPassDepthMode():new pt(E.gl.LEQUAL,pt.ReadWrite,u.depthRangeFor3D),L=u.isTileAffectedByFog(_);if(o.meshes)for(let R of o.meshes){let k=["MODEL_POSITION_ON_GPU"],V=[],z,U,j;h.instancedDataArray.length>20&&k.push("INSTANCED_ARRAYS");let W=xs(u,t.paint.get("model-cutoff-fade-range"));if(W.shouldRenderCutoff&&k.push("RENDER_CUTOFF"),T&&C)z=u.getOrCreateProgram("modelDepth",{defines:k}),U=my(v.shadowTileMatrix,v.shadowTileMatrix,Float32Array.from(o.matrix)),j=C.getShadowPassColorMode();else{Gu(k,V,R,u,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),z=u.getOrCreateProgram("model",{defines:k,overrideFog:L});let J=R.material,ie=J.pbrMetallicRoughness,le=t.paint.get("model-opacity").constantOr(1),ue=t.paint.get("model-emissive-strength").constantOr(0);U=Xp(_.expandedProjMatrix,Float32Array.from(o.matrix),new Float32Array(16),null,u,le,ie.baseColorFactor,J.emissiveFactor,ie.metallicFactor,ie.roughnessFactor,J,ue,t,g),C&&(v.shadowUniformsInitialized?z.setShadowUniformValues(E,C.getShadowUniformValues()):(C.setupShadows(_.toUnwrapped(),z,"model-tile"),v.shadowUniformsInitialized=!0)),j=W.shouldRenderCutoff||le<1||J.alphaMode!=="OPAQUE"?Yt.alphaBlended:Yt.unblended}u.uploadCommonUniforms(E,z,_.toUnwrapped(),null,W);let Y=R.material.doubleSided?At.disabled:At.backCCW;if(h.instancedDataArray.length>20)V.push(h.instancedDataBuffer),z.draw(u,E.gl.TRIANGLES,A,Lt.disabled,j,Y,U,t.id,R.vertexBuffer,R.indexBuffer,R.segments,t.paint,u.transform.zoom,void 0,V,h.instancedDataArray.length);else{let J=T?"u_instance":"u_normal_matrix";for(let ie=0;ie<h.instancedDataArray.length;++ie)U[J]=new Float32Array(h.instancedDataArray.arrayBuffer,64*ie,16),z.draw(u,E.gl.TRIANGLES,A,Lt.disabled,j,Y,U,t.id,R.vertexBuffer,R.indexBuffer,R.segments,t.paint,u.transform.zoom,void 0,V)}}if(o.children)for(let R of o.children)am(u,t,R,h,g,_,v)}let Nh=[1,-1,1];function lm(u,t,o,h){if(!o.modelManager)return!0;let g=o.modelManager;if(!o.shadowRenderer)return!0;let _=o.shadowRenderer,v=t.aabb,E=!0,T=u.maxHeight;if(T===0){let A=0;for(let L in u.instancesPerModel){let R=g.getModel(L,h);R?A=Math.max(A,Math.max(Math.max(R.aabb.max[0],R.aabb.max[1]),R.aabb.max[2])):E=!1}T=u.maxScale*A*1.41+u.maxVerticalOffset,E&&(u.maxHeight=T)}v.max[2]=T,v.min[2]+=u.terrainElevationMin,v.max[2]+=u.terrainElevationMax,r.ad(v.min,v.min,t.tileMatrix),r.ad(v.max,v.max,t.tileMatrix);let C=v.intersects(_.getCurrentCascadeFrustum());return o.currentShadowCascade===0&&(u.isInsideFirstShadowMapFrustum=C===2),C===0}function Iy(u,t){let o=u.uniformValues.u_cutoff_params[0],h=u.uniformValues.u_cutoff_params[1],g=u.uniformValues.u_cutoff_params[2],_=u.uniformValues.u_cutoff_params[3];return h===o||_===g?1:r.ay(((t-o)/(h-o)-g)/(_-g),0,1)}function Sy(u,t,o,h){if(t.pitch<20)return 1;let g=t.getWorldToCameraMatrix();r.az(g,g,u);let _=r.bR(o.min[0],o.min[1],o.min[2],1),v=r.aA(r.ev(),_,g),E=v,T=v;_[1]=o.max[1],v=r.aA(r.ev(),_,g),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T,_[0]=o.max[0],v=r.aA(r.ev(),_,g),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T,_[1]=o.min[1],v=r.aA(r.ev(),_,g),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T;let C=r.ay(h[0],0,1),A=100*t.pixelsPerMeter*r.ay(h[1],0,1),L=r.ay(h[2],0,1),R=r.ew(r.ev(),E,T,C),k=Math.tan(.5*t.fovX),V=-R[2]*k;if(A===0)return R[1]<-Math.abs(V)?L:1;let z=(-Math.abs(V)-R[1])/A,U=(W,Y,J)=>(1-J)*W+J*Y,j=r.ay(U(1,L,z),L,1);return U(1,j,r.ay((t.pitch-20)/20,0,1))}class zh{}class qu{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,o,h){{let L=this._storage.get(o.id);if(L)return L.lastUsedFrameIdx=t,L.buf}let g=h.gl,_=g.getBufferParameter(g.ELEMENT_ARRAY_BUFFER,g.BUFFER_SIZE),v=new ArrayBuffer(_),E=new Int16Array(v);g.getBufferSubData(g.ELEMENT_ARRAY_BUFFER,0,new Int16Array(v));let T=new r.ey;for(let L=0;L<_/2;L+=3){let R=E[L],k=E[L+1],V=E[L+2];T.emplaceBack(R,k),T.emplaceBack(k,V),T.emplaceBack(V,R)}let C=h.bindVertexArrayOES.current,A=new zh;return A.buf=new _y(h,T),A.lastUsedFrameIdx=t,this._storage.set(o.id,A),h.bindVertexArrayOES.set(C),A.buf}update(t){for(let[o,h]of this._storage)t-h.lastUsedFrameIdx>30&&(h.buf.destroy(),this._storage.delete(o))}destroy(){for(let[t,o]of this._storage)o.buf.destroy(),this._storage.delete(t)}}class pc{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let Dy=r.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Lb{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Lr{constructor(t,o){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...o,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...o,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}let kb=r.ec([{type:"Float32",name:"a_pos_2f",components:2}]);class Wu{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,o){let h=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let v=new r.ez,E=new r.a_;v.emplaceBack(-1,-1),v.emplaceBack(1,-1),v.emplaceBack(1,1),v.emplaceBack(-1,1),E.emplaceBack(0,1,2),E.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(v,kb.members),this.vignetteIdx=t.context.createIndexBuffer(E)}let g=r.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,h);let v={u_vignetteShape:(_={vignetteShape:[o.start,o.range,Math.pow(10,o.fadePower)],vignetteColor:[o.color.r,o.color.g,o.color.b,o.color.a*o.strength]}).vignetteShape,u_vignetteColor:_.vignetteColor};h.draw(t,t.context.gl.TRIANGLES,pt.disabled,Lt.disabled,Yt.alphaBlended,At.disabled,v,"vignette",this.vignetteVx,this.vignetteIdx,g)}var _}}class si{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,o){let h=t.getFreeCameraOptions().position,g=h.toAltitude(),_=h.toLngLat(),v=r.al(_.lng),E=r.al(_.lat),T=t.pixelsPerMeter/o,C=v*r.eB,A=r.eB*Math.log(Math.tan(Math.PI/4+E/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let L=-this._offsetYPrev+A,R=-this._elevationPrev+g;this._accumulatedOffsetX+=(-this._offsetXPrev+C)*T,this._accumulatedOffsetY+=L*T,this._accumulatedElevation+=R*T,this._offsetXPrev=C,this._offsetYPrev=A,this._elevationPrev=g}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function gn(u,t){return[-(u[0]-Math.floor(u[0]/t)*t),-(u[1]-Math.floor(u[1]/t)*t),-(u[2]-Math.floor(u[2]/t)*t)]}function cm(u){let t=r.el(1323123451230),o=[];for(let h=0;h<u;++h){let g=2*t()-1,_=2*t()-1,v=2*t()-1;o.push(r.d2(g,_,v))}return o}function ro(u,t,o,h,g){let _=r.ay((g-o)/(h-o),0,1);return(1-_)*u+_*t}class mc{constructor(t){this._movement=new si,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Wu,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,o){let h=t.transform;this._movement.update(h,this._ppmScaleFactor);let g=h.starsProjMatrix,_=r.c3([]);r.c5(_,_,r.al(90)-h._pitch),r.c4(_,_,-h.angle);let v=r.c8(new Float32Array(16),_),E=r.eA(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),T=r.ea([],E),C=r.az([],T,v),A=Date.now()/1e3;return this._accumulatedTimeFromStart+=(A-this._prevTime)*o,this._prevTime=A,{projectionMatrix:g,modelviewMatrix:C}}}class gc extends mc{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Lr(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=cm(this.particlesCount),g=new r.eC,_=new r.a_,v=0,E=r.el(1323123451230);for(let T=0;T<h.length;++T){let C=h[T],A=[2*E()-1,E(),E(),E()];g.emplaceBack(C[0],C[1],C[2],-1,-1,...A),g.emplaceBack(C[0],C[1],C[2],1,-1,...A),g.emplaceBack(C[0],C[1],C[2],1,1,...A),g.emplaceBack(C[0],C[1],C[2],-1,1,...A),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=o.createVertexBuffer(g,Dy.members),this.particlesIdx=o.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;let o=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},h=t.transform.zoom;if(o.revealStart>h)return;let g=ro(0,1,o.revealStart,o.revealStart+o.revealRange,h);if(!this.particlesVx||!this.particlesIdx)return;let _=structuredClone(this._params),v=[-_.direction.x,_.direction.y,-100];r.au(v,v);let E=structuredClone(this._vignetteParams);E.strength*=g,_.overrideStyleParameters||(_.intensity=t.style.rain.state.density,_.timeFactor=t.style.rain.state.intensity,_.color=structuredClone(t.style.rain.state.color),v=structuredClone(t.style.rain.state.direction),_.screenThinning.intensity=t.style.rain.state.centerThinning,_.dropletSizeX=t.style.rain.state.dropletSize[0],_.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],_.distortionStrength=100*t.style.rain.state.distortionStrength,E.strength=1,E.color=structuredClone(t.style.rain.state.vignetteColor));let T=this.updateOnRender(t,_.timeFactor),C=t.context,A=C.gl,L=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new r.T(C,{width:t.width,height:t.height,data:null},A.RGBA8)),_.distortionStrength>0&&(C.activeTexture.set(A.TEXTURE0),this.screenTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),A.copyTexSubImage2D(A.TEXTURE_2D,0,0,0,0,0,t.width,t.height));let R=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(C,R),C.activeTexture.set(A.TEXTURE0),this.screenTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE);let k=[_.color.r,_.color.g,_.color.b,_.color.a],V=(z,U)=>{let j=gn(this._movement.getPosition(),z),W=_.dropletSizeX,Y=_.dropletSizeX*_.dropletSizeYScale,J=t.width/2,ie=t.height/2,le=ro(0,_.screenThinning.start,0,1,_.screenThinning.intensity),ue=ro(.001,_.screenThinning.range,0,1,_.screenThinning.intensity),re=ro(0,_.screenThinning.particleOffset,0,1,_.screenThinning.intensity),oe=(se={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:j,velocityConeAperture:_.velocityConeAperture,velocity:_.velocity,boxSize:z,rainDropletSize:[W,Y],distortionStrength:_.distortionStrength,rainDirection:v,color:k,screenSize:[L.width,L.height],thinningCenterPos:[J,ie],thinningShape:[le,ue,Math.pow(10,_.screenThinning.fadePower)],thinningAffectedRatio:_.screenThinning.affectedRatio,thinningParticleOffset:re,shapeDirectionalPower:_.shapeDirPower,shapeNormalPower:_.shapeNormalPower,mode:U?0:1},{u_modelview:Float32Array.from(se.modelview),u_projection:Float32Array.from(se.projection),u_time:se.time,u_cam_pos:se.camPos,u_texScreen:0,u_velocityConeAperture:se.velocityConeAperture,u_velocity:se.velocity,u_boxSize:se.boxSize,u_rainDropletSize:se.rainDropletSize,u_distortionStrength:se.distortionStrength,u_rainDirection:se.rainDirection,u_color:se.color,u_screenSize:se.screenSize,u_thinningCenterPos:se.thinningCenterPos,u_thinningShape:se.thinningShape,u_thinningAffectedRatio:se.thinningAffectedRatio,u_thinningParticleOffset:se.thinningParticleOffset,u_shapeDirectionalPower:se.shapeDirectionalPower,u_shapeNormalPower:se.shapeNormalPower,u_mode:se.mode});var se;let Ee=Math.round(_.intensity*this.particlesCount),me=r.bd.simpleSegment(0,0,4*Ee,2*Ee);R.draw(t,A.TRIANGLES,pt.disabled,Lt.disabled,Yt.alphaBlended,At.disabled,oe,"rain_particles",this.particlesVx,this.particlesIdx,me)};_.distortionStrength>0&&V(_.boxSize,!0),V(_.boxSize,!1),this._vignette.draw(t,E)}}let ml=r.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class um extends mc{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Lr(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=cm(this.particlesCount),g=new r.eD,_=new r.a_,v=0,E=r.el(1323123451230);for(let T=0;T<h.length;++T){let C=h[T],A=E(),L=E(),R=E(),k=[T/h.length,A,L,R],V=[E(),E()];g.emplaceBack(C[0],C[1],C[2],-1,-1,...k,...V),g.emplaceBack(C[0],C[1],C[2],1,-1,...k,...V),g.emplaceBack(C[0],C[1],C[2],1,1,...k,...V),g.emplaceBack(C[0],C[1],C[2],-1,1,...k,...V),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=o.createVertexBuffer(g,ml.members),this.particlesIdx=o.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;let o=structuredClone(this._params),h=[-o.direction.x,o.direction.y,-100];r.au(h,h);let g=structuredClone(this._vignetteParams),_=o.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},v=t.transform.zoom;if(_.revealStart>v)return;let E=ro(0,1,_.revealStart,_.revealStart+_.revealRange,v);g.strength*=E,o.overrideStyleParameters||(o.intensity=t.style.snow.state.density,o.timeFactor=t.style.snow.state.intensity,o.color=structuredClone(t.style.snow.state.color),h=structuredClone(t.style.snow.state.direction),o.screenThinning.intensity=t.style.snow.state.centerThinning,o.billboardSize=2.79*t.style.snow.state.flakeSize,g.strength=1,g.color=structuredClone(t.style.snow.state.vignetteColor));let T=this.updateOnRender(t,o.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let C=t.context,A=C.gl,L=t.transform,R=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(C,R),((k,V,z)=>{let U=gn(this._movement.getPosition(),k),j=L.width/2,W=L.height/2,Y=ro(0,z.screenThinning.start,0,1,z.screenThinning.intensity),J=ro(.001,z.screenThinning.range,0,1,z.screenThinning.intensity),ie=ro(0,z.screenThinning.particleOffset,0,1,z.screenThinning.intensity),le=(ue={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:U,velocityConeAperture:z.velocityConeAperture,velocity:z.velocity,horizontalOscillationRadius:z.horizontalOscillationRadius,horizontalOscillationRate:z.horizontalOscillationRate,boxSize:k,billboardSize:1*z.billboardSize,simpleShapeParameters:[z.shapeFadeStart,z.shapeFadePower],screenSize:[L.width,L.height],thinningCenterPos:[j,W],thinningShape:[Y,J,Math.pow(10,z.screenThinning.fadePower)],thinningAffectedRatio:z.screenThinning.affectedRatio,thinningParticleOffset:ie,color:[z.color.r,z.color.g,z.color.b,z.color.a],direction:h},{u_modelview:Float32Array.from(ue.modelview),u_projection:Float32Array.from(ue.projection),u_time:ue.time,u_cam_pos:ue.camPos,u_velocityConeAperture:ue.velocityConeAperture,u_velocity:ue.velocity,u_horizontalOscillationRadius:ue.horizontalOscillationRadius,u_horizontalOscillationRate:ue.horizontalOscillationRate,u_boxSize:ue.boxSize,u_billboardSize:ue.billboardSize,u_simpleShapeParameters:ue.simpleShapeParameters,u_screenSize:ue.screenSize,u_thinningCenterPos:ue.thinningCenterPos,u_thinningShape:ue.thinningShape,u_thinningAffectedRatio:ue.thinningAffectedRatio,u_thinningParticleOffset:ue.thinningParticleOffset,u_particleColor:ue.color,u_direction:ue.direction});var ue;let re=Math.round(z.intensity*this.particlesCount),oe=r.bd.simpleSegment(0,0,4*re,2*re);this.particlesVx&&this.particlesIdx&&R.draw(t,A.TRIANGLES,pt.disabled,Lt.disabled,Yt.alphaBlended,At.disabled,le,"snow_particles",this.particlesVx,this.particlesIdx,oe)})(o.boxSize,0,o),this._vignette.draw(t,g)}}let dm={symbol:function(u,t,o,h,g){if(u.renderPass!=="translucent")return;let _=Lt.disabled,v=u.colorModeForRenderPass(),E=o.layout.get("text-variable-anchor"),T=o.layout.get("text-size-scale-range"),C=r.ay(u.scaleFactor,T[0],T[1]);E&&function(R,k,V,z,U,j,W,Y){let J=k.transform,ie=U==="map",le=j==="map";for(let ue of R){let re=z.getTile(ue),oe=re.getBucket(V);if(!oe||!oe.text||!oe.text.segments.get().length)continue;let se=r.bH(oe.textSizeData,J.zoom,Y),Ee=Qd(ue,oe.getProjection(),J),me=J.calculatePixelsToTileUnitsMatrix(re),Ne=Eu(Ee,re.tileID.canonical,le,ie,J,oe.getProjection(),me),Ce=oe.hasIconTextFit()&&oe.hasIconData();se&&yy(oe,ie,le,W,J,Ne,ue,Math.pow(2,J.zoom-re.tileID.overscaledZ),se,Ce)}}(h,u,o,t,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),g,C);let A=o.paint.get("icon-opacity").constantOr(1)!==0,L=o.paint.get("text-opacity").constantOr(1)!==0;o.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(A||L)?em(u,t,o,h,_,v):(A&&em(u,t,o,h,_,v,{onlyIcons:!0}),L&&em(u,t,o,h,_,v,{onlyText:!0})),t.map.showCollisionBoxes&&(Jp(u,t,o,h,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),Jp(u,t,o,h,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(u,t,o,h){if(u.renderPass!=="translucent")return;let g=o.paint.get("circle-opacity"),_=o.paint.get("circle-stroke-width"),v=o.paint.get("circle-stroke-opacity"),E=o.layout.get("circle-sort-key").constantOr(1)!==void 0,T=o.paint.get("circle-emissive-strength");if(g.constantOr(1)===0&&(_.constantOr(1)===0||v.constantOr(1)===0))return;let C=u.context,A=C.gl,L=u.transform,R=!(!u.terrain||!u.terrain.enabled),k=o.layout.get("circle-elevation-reference"),V=u.depthModeForSublayer(0,pt.ReadOnly),z=new pt(u.context.gl.LEQUAL,pt.ReadOnly,u.depthRangeFor3D),U=k==="none"||R?V:z,j=Lt.disabled,W=u.colorModeForDrapableLayerRenderPass(T),Y=L.projection.name==="globe",J=[r.aD(L.center.lng),r.aH(L.center.lat)],ie=[];for(let ue=0;ue<h.length;ue++){let re=h[ue],oe=t.getTile(re),se=oe.getBucket(o);if(!se||se.projection.name!==L.projection.name)continue;let Ee=se.programConfigurations.get(o.id),me=se.layoutVertexBuffer,Ne=se.globeExtVertexBuffer,Ce=se.indexBuffer,Be=r.dW(o),Qe=[Ne],Te=u.isTileAffectedByFog(re);Y&&Be.push("PROJECTION_GLOBE_VIEW"),Be.push("DEPTH_D24"),u.terrain&&L.depthOcclusionForSymbolsAndCircles&&Be.push("DEPTH_OCCLUSION"),se.hasElevation&&!u.terrain&&(Be.push("ELEVATED_ROADS"),Qe.push(se.elevatedLayoutVertexBuffer));let pe=u.getOrCreateProgram("circle",{config:Ee,defines:Be,overrideFog:Te}),Pe=L.projection.createInversionMatrix(L,re.canonical),Ie={programConfiguration:Ee,program:pe,layoutVertexBuffer:me,dynamicBuffers:Qe,indexBuffer:Ce,uniformValues:r.dX(u,re,oe,Pe,J,o),tile:oe};if(E){let He=se.segments.get();for(let $e of He)ie.push({segments:new r.bd([$e]),sortKey:$e.sortKey,state:Ie})}else ie.push({segments:se.segments,sortKey:0,state:Ie})}E&&ie.sort((ue,re)=>ue.sortKey-re.sortKey);let le={useDepthForOcclusion:L.depthOcclusionForSymbolsAndCircles};for(let ue of ie){let{programConfiguration:re,program:oe,layoutVertexBuffer:se,dynamicBuffers:Ee,indexBuffer:me,uniformValues:Ne,tile:Ce}=ue.state,Be=ue.segments;u.terrain&&u.terrain.setupElevationDraw(Ce,oe,le),u.uploadCommonUniforms(C,oe,Ce.tileID.toUnwrapped()),oe.draw(u,A.TRIANGLES,U,j,W,At.disabled,Ne,o.id,se,me,Be,o.paint,L.zoom,re,Ee)}},heatmap:function(u,t,o,h){if(o.paint.get("heatmap-opacity")!==0)if(u.renderPass==="offscreen"){let g=u.context,_=g.gl,v=Lt.disabled,E=new Yt([_.ONE,_.ONE,_.ONE,_.ONE],r.am.transparent,[!0,!0,!0,!0]);(function(k,V,z,U){let j=k.gl,W=V.width*U,Y=V.height*U;k.activeTexture.set(j.TEXTURE1),k.viewport.set([0,0,W,Y]);let J=z.heatmapFbo;if(!J||J&&(J.width!==W||J.height!==Y)){J&&J.destroy();let ie=j.createTexture();j.bindTexture(j.TEXTURE_2D,ie),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MIN_FILTER,j.LINEAR),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MAG_FILTER,j.LINEAR),J=z.heatmapFbo=k.createFramebuffer(W,Y,!0,null),function(le,ue,re,oe,se,Ee){let me=le.gl;me.texImage2D(me.TEXTURE_2D,0,le.extRenderToTextureHalfFloat?me.RGBA16F:me.RGBA,se,Ee,0,me.RGBA,le.extRenderToTextureHalfFloat?me.HALF_FLOAT:me.UNSIGNED_BYTE,null),oe.colorAttachment.set(re)}(k,0,ie,J,W,Y)}else j.bindTexture(j.TEXTURE_2D,J.colorAttachment.get()),k.bindFramebuffer.set(J.framebuffer)})(g,u,o,u.transform.projection.name==="globe"?.5:.25),g.clear({color:r.am.transparent});let T=u.transform,C=T.projection.name==="globe",A=C?["PROJECTION_GLOBE_VIEW"]:[],L=C?At.frontCCW:At.disabled,R=[r.aD(T.center.lng),r.aH(T.center.lat)];for(let k=0;k<h.length;k++){let V=h[k];if(t.hasRenderableParent(V))continue;let z=t.getTile(V),U=z.getBucket(o);if(!U||U.projection.name!==T.projection.name)continue;let j=u.isTileAffectedByFog(V),W=U.programConfigurations.get(o.id),Y=u.getOrCreateProgram("heatmap",{config:W,defines:A,overrideFog:j}),{zoom:J}=u.transform;u.terrain&&u.terrain.setupElevationDraw(z,Y),u.uploadCommonUniforms(g,Y,V.toUnwrapped());let ie=T.projection.createInversionMatrix(T,V.canonical);Y.draw(u,_.TRIANGLES,pt.disabled,v,E,L,dy(u,V,z,ie,R,J,o.paint.get("heatmap-intensity")),o.id,U.layoutVertexBuffer,U.indexBuffer,U.segments,o.paint,u.transform.zoom,W,C?[U.globeExtVertexBuffer]:null)}g.viewport.set([0,0,u.width,u.height])}else u.renderPass==="translucent"&&(u.context.setColorMode(u.colorModeForRenderPass()),function(g,_){let v=g.context,E=v.gl,T=_.heatmapFbo;if(!T)return;v.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,T.colorAttachment.get()),v.activeTexture.set(E.TEXTURE1);let C=_.colorRampTexture;C||(C=_.colorRampTexture=new r.T(v,_.colorRamp,E.RGBA8)),C.bind(E.LINEAR,E.CLAMP_TO_EDGE),g.getOrCreateProgram("heatmapTexture").draw(g,E.TRIANGLES,pt.disabled,Lt.disabled,g.colorModeForRenderPass(),At.disabled,((A,L,R,k)=>({u_image:0,u_color_ramp:1,u_opacity:L.paint.get("heatmap-opacity")}))(0,_),_.id,g.viewportBuffer,g.quadTriangleIndexBuffer,g.viewportSegments,_.paint,g.transform.zoom)}(u,o))},line:function(u,t,o,h){if(u.renderPass!=="translucent")return;let g=o.paint.get("line-opacity"),_=o.paint.get("line-width");if(g.constantOr(1)===0||_.constantOr(1)===0)return;let v=o.paint.get("line-emissive-strength"),E=o.paint.get("line-occlusion-opacity"),T=o.layout.get("line-elevation-reference"),C=o.layout.get("line-width-unit")==="meters",A=T==="sea",L=!(!u.terrain||!u.terrain.enabled),R=u.context,k=R.gl;if(o.hasElevatedBuckets&&u.transform.projection.name==="globe")return;let V=o.layout.get("line-cross-slope"),z=V!==void 0,U=V<1,j=u.colorModeForDrapableLayerRenderPass(v),W=u.terrain&&u.terrain.renderingToTexture,Y=W?1:r.q.devicePixelRatio,J=o.paint.get("line-dasharray"),ie=J.constantOr(1),le=o.layout.get("line-cap"),ue=J.constantOr(null),re=le.constantOr(null),oe=o.paint.get("line-pattern"),se=oe.constantOr(1),Ee=o.paint.get("line-pattern-cross-fade"),me=oe.constantOr(null),Ne=o.paint.get("line-opacity").constantOr(1),Ce=!se&&Ne!==1||u.depthOcclusion&&E>0&&E<1,Be=o.paint.get("line-gradient"),Qe=se?"linePattern":"line",Te=r.dY(o),pe;if(W&&u.terrain&&u.terrain.clipOrMaskOverlapStencilType()&&(Ce=!1),E!==0&&u.depthOcclusion){let $e=o.paint._values["line-opacity"];$e&&$e.value&&$e.value.kind==="constant"?pe=$e.value:r.w(`Occlusion opacity for layer ${o.id} is supported only when line-opacity isn't data-driven.`)}_.value.kind!=="constant"&&_.value.isLineProgressConstant===!1&&Te.push("VARIABLE_LINE_WIDTH");let Pe=($e,qe,ot,xt,St,dt)=>{for(let Tt of $e){let wt=t.getTile(Tt);if(se&&!wt.patternsLoaded())continue;let zt=wt.getBucket(o);if(!zt||zt.elevationType!=="none"&&!St||zt.elevationType==="none"&&St)continue;u.prepareDrawTile();let qt=[...qe],on=u.shadowRenderer,bn=zt.elevationType==="road"&&!!on&&on.enabled,Ht=[0,0,0];if(bn){let yn=u.style.directionalLight,Rn=u.style.ambientLight;yn&&Rn&&(Ht=sl(u.style,yn,Rn)),qt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}let wn=zt.programConfigurations.get(o.id),Dn=!1;if(me&&wt.imageAtlas){let yn=r.dZ.from(me),Rn=yn.getPrimary().scaleSelf(Y).toString(),qn=wt.imageAtlas.patternPositions.get(Rn),$i=yn.getSecondary(),Bi=$i?wt.imageAtlas.patternPositions.get($i.scaleSelf(Y).toString()):null;Dn=!!qn&&!!Bi,qn&&wn.setConstantPatternPositions(qn,Bi)}Ee>0&&(Dn||wn.getPatternTransitionVertexBuffer("line-pattern"))&&qt.push("LINE_PATTERN_TRANSITION");let Xn=u.isTileAffectedByFog(Tt),tn=u.getOrCreateProgram(Qe,{config:wn,defines:qt,overrideFog:Xn});if(!se&&ue&&re&&wt.lineAtlas){let yn=wt.lineAtlas.getDash(ue,re);yn&&wn.setConstantPatternPositions(yn)}bn&&on.setupShadows(wt.tileID.toUnwrapped(),tn,"vector-tile");let[En,Tn]=o.paint.get("line-trim-offset");(re==="round"||re==="square")&&En!==Tn&&(En===0&&(En-=1),Tn===1&&(Tn+=1));let Mn=W?Tt.projMatrix:null,sn=C?1/zt.tileToMeter/r.aw(wt,1,u.transform.zoom):1,zn=C?1/zt.tileToMeter/r.aw(wt,1,Math.floor(u.transform.zoom)):1,Cn=se?r.d_(u,wt,o,Mn,Y,sn,zn,[En,Tn],Ht,Ee):r.d$(u,wt,o,Mn,zt.lineClipsArray.length,Y,sn,zn,[En,Tn],Ht);if(Be){let yn=zt.gradients[o.id],Rn=yn.texture;if(o.gradientVersion!==yn.version){let qn=256;if(o.stepInterpolant){let $i=t.getSource().maxzoom,Bi=Tt.canonical.z===$i?Math.ceil(1<<u.transform.maxZoom-Tt.canonical.z):1;qn=r.ay(r.e0(zt.maxLineLength/r.aj*1024*Bi),256,R.maxTextureSize)}yn.gradient=r.e1({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:qn,image:yn.gradient||void 0,clips:zt.lineClipsArray}),yn.texture?yn.texture.update(yn.gradient):yn.texture=new r.T(R,yn.gradient,k.RGBA8),yn.version=o.gradientVersion,Rn=yn.texture}R.activeTexture.set(k.TEXTURE1),Rn.bind(o.stepInterpolant?k.NEAREST:k.LINEAR,k.CLAMP_TO_EDGE)}ie&&(R.activeTexture.set(k.TEXTURE0),wt.lineAtlasTexture&&wt.lineAtlasTexture.bind(k.LINEAR,k.REPEAT),wn.updatePaintBuffers()),se&&(R.activeTexture.set(k.TEXTURE0),wt.imageAtlasTexture&&wt.imageAtlasTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),wn.updatePaintBuffers()),St&&!A&&u.terrain.setupElevationDraw(wt,tn),u.uploadCommonUniforms(R,tn,Tt.toUnwrapped());let _i=yn=>{pe!=null&&(pe.value=Ne*E),tn.draw(u,k.TRIANGLES,ot,yn,j,At.disabled,Cn,o.id,zt.layoutVertexBuffer,zt.indexBuffer,zt.segments,o.paint,u.transform.zoom,wn,[zt.layoutVertexBuffer2,zt.patternVertexBuffer,zt.zOffsetVertexBuffer]),pe!=null&&(pe.value=Ne)};if(Ce&&!St){let yn=u.stencilModeForClipping(Tt).ref;yn===0&&W&&R.clear({stencil:0});let Rn={func:k.EQUAL,mask:255};Cn.u_alpha_discard_threshold=.8,_i(new Lt(Rn,yn,255,k.KEEP,k.KEEP,k.INVERT)),Cn.u_alpha_discard_threshold=0,_i(new Lt(Rn,yn,255,k.KEEP,k.KEEP,k.KEEP))}else Cn.u_alpha_discard_threshold=Ce&&St&&dt?.8:0,_i(St?xt:u.stencilModeForClipping(Tt))}},Ie=u.depthModeForSublayer(0,pt.ReadOnly),He=new pt(u.depthOcclusion?k.GREATER:k.LEQUAL,pt.ReadOnly,u.depthRangeFor3D);if(o.hasNonElevatedBuckets){let $e=!W&&u.terrain;E!==0&&$e?r.w(`Occlusion opacity for layer ${o.id} is supported on terrain only if the layer has line-z-offset enabled.`):$e?r.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${o.id}.`):Pe(h,Te,Ie,Lt.disabled,!1,!0)}if(o.hasElevatedBuckets){T==="hd-road-markup"?L||(Ie=He,Te.push("ELEVATED_ROADS")):(Te.push("ELEVATED"),Ie=He,z&&Te.push(U?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),A&&Te.push("ELEVATION_REFERENCE_SEA"));let $e=Ce?u.stencilModeFor3D():Lt.disabled;u.forceTerrainMode=!0,Pe(h,Te,Ie,$e,!0,!0),Ce&&Pe(h,Te,Ie,$e,!0,!1),u.forceTerrainMode=!1}Ce&&(u.resetStencilClippingMasks(),W&&R.clear({stencil:0})),E===0||u.depthOcclusion||W||u.layersWithOcclusionOpacity.push(u.currentLayer)},fill:function(u,t,o,h){let g=o.paint.get("fill-color"),_=o.paint.get("fill-opacity");if(_.constantOr(1)===0)return;let v=o.paint.get("fill-emissive-strength"),E=u.colorModeForDrapableLayerRenderPass(v),T=o.paint.get("fill-pattern"),C=u.opaquePassEnabledForLayer()&&!T.constantOr(1)&&g.constantOr(r.am.transparent).a===1&&_.constantOr(0)===1?"opaque":"translucent",A="none";o.layout.get("fill-elevation-reference")!=="none"?A="road":o.paint.get("fill-z-offset").constantOr(1)!==0&&(A="offset");let L=!(!u.terrain||!u.terrain.enabled),R={painter:u,sourceCache:t,layer:o,coords:h,colorMode:E,elevationType:A,terrainEnabled:L,pass:C};if(u.renderPass!=="shadow")if(A!=="offset"){if(Rh(R,!1),A==="road"){let k=!L&&u.renderPass==="translucent";k&&gt(u,t,o,h,"geometry"),Rh(R,!0,Lt.disabled),k&&function(V){let{painter:z,sourceCache:U,layer:j,coords:W,colorMode:Y}=V,J=z.context.gl,ie=V.painter.shadowRenderer,le=!!ie&&ie.enabled,ue=new pt(z.context.gl.LEQUAL,pt.ReadOnly,z.depthRangeFor3D),re=[0,0,0];if(le){let se=z.style.directionalLight,Ee=z.style.ambientLight;se&&Ee&&(re=sl(z.style,se,Ee))}let oe=se=>{for(let Ee of W){let me=U.getTile(Ee),Ne=me.getBucket(j);if(!Ne)continue;let Ce=Ne.elevatedStructures;if(!Ce)continue;let Be,Qe;if(se?(Be=Ce.renderableBridgeSegments,Qe=Ce.bridgeProgramConfigurations.get(j.id)):(Be=Ce.renderableTunnelSegments,Qe=Ce.tunnelProgramConfigurations.get(j.id)),!Be||Be.segments[0].primitiveLength===0)continue;Qe.updatePaintBuffers(),z.prepareDrawTile();let Te=z.isTileAffectedByFog(Ee),pe=[];le&&pe.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let Pe=z.getOrCreateProgram("elevatedStructures",{config:Qe,overrideFog:Te,defines:pe}),Ie=z.translatePosMatrix(Ee.projMatrix,me,j.paint.get("fill-translate"),j.paint.get("fill-translate-anchor"));le&&ie.setupShadows(me.tileID.toUnwrapped(),Pe,"vector-tile");let He=Cb(Ie,re);z.uploadCommonUniforms(z.context,Pe,Ee.toUnwrapped()),Pe.draw(z,J.TRIANGLES,ue,Lt.disabled,Y,At.backCCW,He,j.id,Ce.vertexBuffer,Ce.indexBuffer,Be,j.paint,z.transform.zoom,Qe,[Ce.vertexBufferNormal])}};oe(!0),oe(!1)}(R)}}else Rh(R,!1,u.stencilModeFor3D());else u.shadowRenderer&&A==="road"&&!L&&function(k){let{painter:V,sourceCache:z,layer:U,coords:j}=k,W=V.context.gl,Y=k.painter.shadowRenderer;for(let J of j){let ie=z.getTile(J),le=ie.getBucket(U);if(!le)continue;let ue=le.elevatedStructures;if(!ue||!ue.shadowCasterSegments||ue.shadowCasterSegments.segments[0].primitiveLength===0)continue;V.prepareDrawTile();let re=le.bufferData.programConfigurations.get(U.id),oe=V.isTileAffectedByFog(J),se=V.getOrCreateProgram("elevatedStructuresDepth",{config:re,overrideFog:oe}),Ee=Y.calculateShadowPassMatrixFromTile(ie.tileID.toUnwrapped());V.uploadCommonUniforms(V.context,se,J.toUnwrapped());let me={u_matrix:Ee,u_depth_bias:0};se.draw(V,W.TRIANGLES,Y.getShadowPassDepthMode(),Lt.disabled,Y.getShadowPassColorMode(),At.disabled,me,U.id,ue.vertexBuffer,ue.indexBuffer,ue.shadowCasterSegments,U.paint,V.transform.zoom,re)}}(R)},"fill-extrusion":function(u,t,o,h){let g=o.paint.get("fill-extrusion-opacity"),_=u.context,v=_.gl,E=u.terrain,T=E&&E.renderingToTexture;if(g===0)return;let C=u.conflationActive&&u.style.isLayerClipped(o,t.getSource()),A=u.style.order.indexOf(o.fqid);if(C&&function(L,R,k,V,z){for(let U of V){let j=R.getTile(U).getBucket(k);j&&(j.updateReplacement(U,L.replacementSource,z),j.uploadCentroid(L.context))}}(u,t,o,h,A),E||C)for(let L of h){let R=t.getTile(L).getBucket(o);R&&Rt(u.context,t,L,R,o,E,C)}if(u.renderPass==="shadow"&&u.shadowRenderer){let L=u.shadowRenderer;if(E&&g<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof r.ab)return;let R=L.getShadowPassDepthMode(),k=L.getShadowPassColorMode();ju(u,t,o,h,R,Lt.disabled,k,C)}else if(u.renderPass==="translucent"){let L=!o.paint.get("fill-extrusion-pattern").constantOr(1),R=o.paint.get("fill-extrusion-color").constantOr(r.am.white);if(!T&&R.a!==0){let k=new pt(u.context.gl.LEQUAL,pt.ReadWrite,u.depthRangeFor3D);g===1&&L?ju(u,t,o,h,k,Lt.disabled,Yt.unblended,C):(ju(u,t,o,h,k,Lt.disabled,Yt.disabled,C),ju(u,t,o,h,k,u.stencilModeFor3D(),u.colorModeForRenderPass(),C),u.resetStencilClippingMasks())}if(u.style.enable3dLights()&&L&&(!E&&u.transform.projection.name!=="globe"||T)){let k=o.paint.get("fill-extrusion-opacity"),V=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),z=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),U=o.paint.get("fill-extrusion-flood-light-intensity"),j=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",W=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(j?null:o.lut).toArray01().slice(0,3),Y=V>0&&z>0,J=U>0,ie=(re,oe,se)=>(1-se)*re+se*oe,le=new $s;le.translate=o.paint.get("fill-extrusion-translate"),le.translateAnchor=o.paint.get("fill-extrusion-translate-anchor"),le.edgeRadius=o.layout.get("fill-extrusion-edge-radius"),le.cutoffFadeRange=o.paint.get("fill-extrusion-cutoff-fade-range");let ue=re=>{let oe=u.depthModeForSublayer(1,pt.ReadOnly,v.LEQUAL,!0),se=o.paint.get(re?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ee=ie(.1,3,se),me=u._showOverdrawInspector;if(!me){let Ne=new Lt({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),Ce=new Yt([v.ONE,v.ONE,v.ONE,v.ONE],r.am.transparent,[!1,!1,!1,!0],v.MIN);io(le,u,t,o,h,oe,Ne,Ce,At.disabled,re,"sdf",k,V,z,U,W,Ee,C,!1)}{let Ne=me?Lt.disabled:new Lt({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),Ce=me?u.colorModeForRenderPass():new Yt([v.ONE_MINUS_DST_ALPHA,v.DST_ALPHA,v.ONE,v.ONE],r.am.transparent,[!0,!0,!0,!0]);io(le,u,t,o,h,oe,Ne,Ce,At.disabled,re,"color",k,V,z,U,W,Ee,C,!1)}};if(T){let re=(oe,se,Ee)=>{let me=u.depthModeForSublayer(1,pt.ReadOnly,v.LEQUAL,!1),Ne=o.paint.get(oe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ce=ie(.1,3,Ne);{let Be=new Yt([v.ONE,v.ONE,v.ONE,v.ONE],r.am.transparent,[!1,!1,!1,!0]);io(le,u,t,o,h,me,Lt.disabled,Be,At.disabled,oe,"clear",k,V,z,U,W,Ce,C,se)}{let Be=new Lt({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),Qe=new Yt([v.ONE,v.ONE,v.ONE,v.ONE],r.am.transparent,[!1,!1,!1,!0],v.MIN);io(le,u,t,o,h,me,Be,Qe,At.disabled,oe,"sdf",k,V,z,U,W,Ce,C,se)}{let Be=oe?v.ZERO:v.ONE_MINUS_DST_ALPHA,Qe=new Lt({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),Te=new Yt([Be,v.DST_ALPHA,v.ONE_MINUS_DST_ALPHA,v.ZERO],r.am.transparent,[!0,!0,!0,!0]);io(le,u,t,o,h,me,Qe,Te,At.disabled,oe,"color",k,V,z,U,W,Ce,C,se)}{let Be=new Yt([v.ONE,v.ONE,v.ONE,oe?v.ZERO:v.ONE],r.am.transparent,[!1,!1,!1,!0],oe?v.FUNC_ADD:v.MAX);io(le,u,t,o,h,me,Lt.disabled,Be,At.disabled,oe,"clear",k,V,z,U,W,Ce,C,se,Ee)}};if(Y||J){let oe;if(u.prepareDrawTile(),E){let se=E.drapeBufferSize[0],Ee=E.drapeBufferSize[1];oe=E.framebufferCopyTexture,oe&&(!oe||oe.size[0]===se&&oe.size[1]===Ee)||(oe&&oe.destroy(),oe=E.framebufferCopyTexture=new r.T(_,new r.r({width:se,height:Ee}),v.RGBA8)),oe.bind(v.LINEAR,v.CLAMP_TO_EDGE),v.copyTexSubImage2D(v.TEXTURE_2D,0,0,0,0,0,se,Ee)}Y&&re(!0,!1,oe),J&&re(!1,!0,oe)}}else Y&&ue(!0),J&&ue(!1),(Y||J)&&u.resetStencilClippingMasks()}}},building:function(u,t,o,h){u.currentLayer<u.firstLightBeamLayer&&(u.firstLightBeamLayer=u.currentLayer);let g=o.paint.get("building-ambient-occlusion-ground-intensity"),_=o.paint.get("building-ambient-occlusion-ground-radius"),v=o.paint.get("building-ambient-occlusion-ground-attenuation"),E=g>0&&_>0,T=!0,C=o.paint.get("building-vertical-scale");C<1&&(T=!1);let A=u.conflationActive&&u.style.isLayerClipped(o,t.getSource()),L=u.style.order.indexOf(o.fqid);if(function(R,k,V,z,U,j){for(let W of j){let Y=k.getTile(W).getBucket(V);Y&&(U&&Y.updateReplacement(W,R.replacementSource,z),Y.uploadUpdatedIndexBuffer(R.context))}}(u,t,o,L,A,h),function(R,k,V,z){for(let U of z){let j=k.getTile(U).getBucket(V);j&&j.needsEvaluation(R,V)&&(j.evaluate(V),j.uploadUpdatedColorBuffer(R.context))}}(u,t,o,h),o.resetLayerRenderingStats(u),u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!0),u.renderPass==="shadow"&&u.shadowRenderer){let R=u.shadowRenderer,k=[],V=R.getShadowPassDepthMode();Oh({painter:u,source:t,layer:o,coords:h,defines:k,blendMode:R.getShadowPassColorMode(),depthMode:V,verticalScale:C})}else if(u.renderPass==="translucent"){E&&function(z,U,j,W,Y,J,ie,le,ue,re,oe,se,Ee){let me=z.context.gl,Ne=z.depthModeForSublayer(1,pt.ReadOnly,me.LEQUAL,!0),Ce=.1*(1-(Be=oe))+3*Be;var Be;let Qe=z._showOverdrawInspector,Te=se,pe=new $s;Qe||io(pe,z,U,j,W,Ne,new Lt({func:me.ALWAYS,mask:255},255,255,me.KEEP,me.KEEP,me.REPLACE),new Yt([me.ONE,me.ONE,me.ONE,me.ONE],r.am.transparent,[!1,!1,!1,!0],me.MIN),At.disabled,Y,"sdf",1,ie,le,0,re,Ce,Te,!1);{let Pe=Qe?Lt.disabled:new Lt({func:me.EQUAL,mask:255},255,255,me.KEEP,me.DECR,me.DECR),Ie=Qe?z.colorModeForRenderPass():new Yt([me.ONE_MINUS_DST_ALPHA,me.DST_ALPHA,me.ONE,me.ONE],r.am.transparent,[!0,!0,!0,!0]);io(pe,z,U,j,W,Ne,Pe,Ie,At.disabled,Y,"color",1,ie,le,0,re,Ce,Te,!1)}}(u,t,o,h,!0,0,g,_,0,[0,0,0],v,A);let R=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];T&&(R=R.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),u.shadowRenderer.useNormalOffset&&(R=R.concat("NORMAL_OFFSET"));let k=new pt(u.context.gl.LEQUAL,pt.ReadWrite,u.depthRangeFor3D),V=u.colorModeForRenderPass();Oh({painter:u,source:t,layer:o,coords:h,defines:R,blendMode:V,depthMode:k,verticalScale:C})}else if(u.renderPass==="light-beam"){let R=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],k=new pt(u.context.gl.LEQUAL,pt.ReadOnly,u.depthRangeFor3D);Oh({painter:u,source:t,layer:o,coords:h,defines:R,blendMode:Yt.alphaBlended,depthMode:k,verticalScale:C})}u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!1),u.resetStencilClippingMasks()},hillshade:function(u,t,o,h){if(u.renderPass!=="offscreen"&&u.renderPass!=="translucent"||u.style.disableElevatedTerrain)return;let g=u.context,_=u.terrain&&u.terrain.renderingToTexture,[v,E]=u.renderPass!=="translucent"||_?[{},h]:u.stencilConfigForOverlap(h);for(let T of E){let C=t.getTile(T);if(C.needsHillshadePrepare&&u.renderPass==="offscreen")X_(u,C,o);else if(u.renderPass==="translucent"){let A=u.depthModeForSublayer(0,pt.ReadOnly),L=o.paint.get("hillshade-emissive-strength"),R=u.colorModeForDrapableLayerRenderPass(L),k=_&&u.terrain?u.terrain.stencilModeForRTTOverlap(T):v[T.overscaledZ];yb(u,T,C,o,A,k,R)}}g.viewport.set([0,0,u.width,u.height]),u.resetStencilClippingMasks()},raster:function(u,t,o,h,g,_){if(u.renderPass!=="translucent"||o.paint.get("raster-opacity")===0)return;let v=u.transform.projection.name==="globe",E=o.paint.get("raster-elevation")!==0,T=E&&v;if(u.renderElevatedRasterBackface&&!T)return;let C=u.context,A=C.gl,L=t.getSource(),R=function(le,ue,re,oe){let se=ue.paint.get("raster-color"),Ee=le.type==="raster-array",me=[],Ne=ue.paint.get("raster-resampling"),Ce=ue.paint.get("raster-color-mix"),Be=ue.paint.get("raster-color-range"),Qe=[Ce[0],Ce[1],Ce[2],0],Te=Ce[3],pe=Ne==="nearest"?oe.NEAREST:oe.LINEAR;if(Ee&&(me.push("RASTER_ARRAY"),se||me.push("RASTER_COLOR"),Ne==="linear"&&me.push("RASTER_ARRAY_LINEAR"),pe=oe.NEAREST,!Be&&le.rasterLayers)){let Pe=le.rasterLayers.find(({id:Ie})=>Ie===ue.sourceLayer);Pe&&Pe.fields&&Pe.fields.range&&(Be=Pe.fields.range)}if(Be=Be||[0,1],se){me.push("RASTER_COLOR"),re.activeTexture.set(oe.TEXTURE2),ue.updateColorRamp(Be);let Pe=ue.colorRampTexture;Pe||(Pe=ue.colorRampTexture=new r.T(re,ue.colorRamp,oe.RGBA8)),Pe.bind(oe.LINEAR,oe.CLAMP_TO_EDGE)}return{mix:Qe,range:Be,offset:Te,defines:me,resampling:pe}}(L,o,C,A);if(L instanceof r.aP&&!h.length&&!v)return;let k=o.paint.get("raster-emissive-strength"),V=u.colorModeForDrapableLayerRenderPass(k),z=u.terrain&&u.terrain.renderingToTexture,U=!u.options.moving,j=o.paint.get("raster-resampling")==="nearest"?A.NEAREST:A.LINEAR;if(L instanceof r.aP&&!h.length&&(L.onNorthPole||L.onSouthPole)){let le=E?u.stencilModeFor3D():Lt.disabled;return void Lh(!!L.onNorthPole,null,u,t,o,k,R,At.disabled,le)}if(!h.length)return;let[W,Y]=L instanceof r.aP||z?[{},h]:u.stencilConfigForOverlap(h),J=Y[Y.length-1].overscaledZ;T&&R.defines.push("PROJECTION_GLOBE_VIEW"),E&&R.defines.push("RENDER_CUTOFF");let ie=(le,ue,re)=>{for(let oe of le){let se=oe.toUnwrapped(),Ee=t.getTile(oe);if(z&&(!Ee||!Ee.hasData()))continue;C.activeTexture.set(A.TEXTURE0);let me=Pb(Ee,L,o,R);if(!me||!me.texture)continue;let{texture:Ne,mix:Ce,offset:Be,tileSize:Qe,buffer:Te}=me,pe,Pe;z?(pe=pt.disabled,Pe=oe.projMatrix):E?(pe=new pt(A.LEQUAL,pt.ReadWrite,u.depthRangeFor3D),Pe=v?Float32Array.from(u.transform.expandedFarZProjMatrix):u.transform.calculateProjMatrix(se,U)):(pe=u.depthModeForSublayer(oe.overscaledZ-J,o.paint.get("raster-opacity")===1?pt.ReadWrite:pt.ReadOnly,A.LESS),Pe=u.transform.calculateProjMatrix(se,U));let Ie=u.terrain&&z?u.terrain.stencilModeForRTTOverlap(oe):W[oe.overscaledZ],He=_?0:o.paint.get("raster-fade-duration");Ee.registerFadeDuration(He);let $e=t.findLoadedParent(oe,0),qe=no(Ee,$e,t,u.transform,He),ot,xt;u.terrain&&u.terrain.prepareDrawTile(),C.activeTexture.set(A.TEXTURE0),Ne.bind(j,A.CLAMP_TO_EDGE),C.activeTexture.set(A.TEXTURE1),$e?($e.texture&&$e.texture.bind(j,A.CLAMP_TO_EDGE),ot=Math.pow(2,$e.tileID.overscaledZ-Ee.tileID.overscaledZ),xt=[Ee.tileID.canonical.x*ot%1,Ee.tileID.canonical.y*ot%1]):Ne.bind(j,A.CLAMP_TO_EDGE),"useMipmap"in Ne&&C.extTextureFilterAnisotropic&&u.transform.pitch>20&&A.texParameterf(A.TEXTURE_2D,C.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,C.extTextureFilterAnisotropicMax);let St=u.transform,dt,Tt=E?Rb(St):[0,0,0,0],wt,zt,qt,on,bn,Ht=0;if(T&&L instanceof r.aP&&L.coordinates.length>3)wt=Float32Array.from(r.bh(r.dD(new r.cA(0,0,0)))),zt=Float32Array.from(St.globeMatrix),qt=Float32Array.from(r.dz(St)),on=[r.aD(St.center.lng),r.aH(St.center.lat)],dt=L.elevatedGlobePerspectiveTransform,bn=L.elevatedGlobeGridMatrix||new Float32Array(9);else if(T){let tn=r.dA(oe.canonical);Ht=r.dB(tn.getCenter().lat),wt=Float32Array.from(r.bh(r.dD(oe.canonical))),zt=Float32Array.from(St.globeMatrix),qt=Float32Array.from(r.dz(St)),on=[r.aD(St.center.lng),r.aH(St.center.lat)],dt=[0,0],bn=Float32Array.from(r.dC(oe.canonical,tn,Ht,St.worldSize/St._pixelsPerMercatorPixel))}else dt=L instanceof r.aP?L.perspectiveTransform:[0,0],wt=new Float32Array(16),zt=new Float32Array(9),qt=new Float32Array(16),on=[0,0],bn=new Float32Array(9);let wn=Wp(Pe,wt,zt,qt,bn,xt||[0,0],r.ah(u.transform.zoom),on,Tt,ot||1,qe,o,dt,E?o.paint.get("raster-elevation"):0,2,Ce,Be,R.range,Qe,Te,k),Dn=u.isTileAffectedByFog(oe),Xn=u.getOrCreateProgram("raster",{defines:R.defines,overrideFog:Dn});if(u.uploadCommonUniforms(C,Xn,se),L instanceof r.aP){let tn=L.elevatedGlobeVertexBuffer,En=L.elevatedGlobeIndexBuffer;if(z||!v)L.boundsBuffer&&L.boundsSegments&&Xn.draw(u,A.TRIANGLES,pe,Lt.disabled,V,At.disabled,wn,o.id,L.boundsBuffer,u.quadTriangleIndexBuffer,L.boundsSegments);else if(tn&&En){let Tn=St.zoom<=r.cX?L.elevatedGlobeSegments:L.getSegmentsForLongitude(St.center.lng);Tn&&Xn.draw(u,A.TRIANGLES,pe,Lt.disabled,V,ue,wn,o.id,tn,En,Tn)}}else if(T){pe=new pt(A.LEQUAL,pt.ReadOnly,u.depthRangeFor3D);let tn=u.globeSharedBuffers;if(tn){let[En,Tn,Mn]=tn.getGridBuffers(Ht,!1);Xn.draw(u,A.TRIANGLES,pe,re||Ie,u.colorModeForRenderPass(),ue,wn,o.id,En,Tn,Mn)}}else{let{tileBoundsBuffer:tn,tileBoundsIndexBuffer:En,tileBoundsSegments:Tn}=u.getTileBoundsBuffers(Ee);Xn.draw(u,A.TRIANGLES,pe,Ie,V,At.disabled,wn,o.id,tn,En,Tn)}}if(!(L instanceof r.aP)&&T)for(let oe of le){let se=oe.canonical.y===(1<<oe.canonical.z)-1;oe.canonical.y===0&&Lh(!0,oe,u,t,o,k,R,ue,re||Lt.disabled),se&&Lh(!1,oe,u,t,o,k,R,ue===At.frontCW?At.backCW:At.frontCW,re||Lt.disabled)}};T?ie(Y,u.renderElevatedRasterBackface?At.backCW:At.frontCW,u.stencilModeFor3D()):ie(Y,At.disabled,void 0),u.resetStencilClippingMasks()},"raster-particle":function(u,t,o,h,g,_){u.renderPass==="offscreen"&&function(v,E,T,C){if(!C.length)return;let A=v.context,L=A.gl,R=E.getSource();if(!(R instanceof pa))return;let k=Math.ceil(Math.sqrt(T.paint.get("raster-particle-count"))),V=T.particlePositionRGBAImage;if(!V||V.width!==k){let Y=function(J){let ie=J*J,le=new Uint8Array(4*ie),ue=function(oe){return oe|=0,oe=Math.imul(2747636419^oe,2654435769),oe=Math.imul(oe^oe>>>16,2654435769),((oe=Math.imul(oe^oe>>>16,2654435769))>>>0)/4294967296},re=1/1.1;for(let oe=0;oe<ie;oe++){let se=re*(ue(2*oe+0)+Ia),Ee=re*(ue(2*oe+1)+Ia),me=255*se%1,Ne=255*Ee%1,Ce=me,Be=Ee-Ne/255,Qe=Ne;le[4*oe+0]=255*(se-me/255),le[4*oe+1]=255*Ce,le[4*oe+2]=255*Be,le[4*oe+3]=255*Qe}return le}(k);V=T.particlePositionRGBAImage=new r.r({width:k,height:k},Y)}let z=T.particleFramebuffer;z?z.width!==k&&(z.destroy(),z=T.particleFramebuffer=A.createFramebuffer(k,k,!0,null)):z=T.particleFramebuffer=A.createFramebuffer(k,k,!0,null);let U=[];for(let Y of C){let J=E.getTile(Y);if(!(J instanceof $l))continue;let ie=jr(J,R,T);if(!ie)continue;let le=[J.tileSize,J.tileSize],ue=T.tileFramebuffer;ue||(ue=T.tileFramebuffer=A.createFramebuffer(le[0],le[1],!0,null));let re=J.rasterParticleState;re||(re=J.rasterParticleState=new nm(A,Y,le,V));let oe=re.update(T.lastInvalidatedAt);re.particleTextureDimension!==k&&re.updateParticleTexture(Y,V);let se=re.targetColorTexture;re.targetColorTexture=re.backgroundColorTexture,re.backgroundColorTexture=se;let Ee=re.particleTexture0;re.particleTexture0=re.particleTexture1,re.particleTexture1=Ee,U.push([Y,ie,re,oe])}if(U.length===0)return;let j=r.q.now(),W=T.previousDrawTimestamp?.001*(j-T.previousDrawTimestamp):.0167;if(T.previousDrawTimestamp=j,T.hasColorMap()){A.activeTexture.set(L.TEXTURE0+2);let Y=T.colorRampTexture;Y||(Y=T.colorRampTexture=new r.T(A,T.colorRamp,L.RGBA8)),Y.bind(L.LINEAR,L.CLAMP_TO_EDGE)}A.bindFramebuffer.set(T.tileFramebuffer.framebuffer),function(Y,J,ie){let le=Y.context,ue=le.gl,re=J.tileFramebuffer;le.activeTexture.set(ue.TEXTURE0);let oe={u_texture:0,u_opacity:1.05*(Ee=J.paint.get("raster-particle-fade-opacity-factor"))/(Ee+.05)},se=Y.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Ee;for(let me of ie){let[,,Ne,Ce]=me;re.colorAttachment.set(Ne.targetColorTexture.texture),le.viewport.set([0,0,re.width,re.height]),le.clear({color:r.am.transparent}),Ce&&(Ne.backgroundColorTexture.bind(ue.NEAREST,ue.CLAMP_TO_EDGE),se.draw(Y,ue.TRIANGLES,pt.disabled,Lt.disabled,Yt.alphaBlended,At.disabled,oe,J.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments))}}(v,T,U),function(Y,J,ie,le){let ue=Y.context,re=ue.gl,oe=ie.tileFramebuffer,se=Y.transform.projection.name==="globe",Ee=ie.paint.get("raster-particle-max-speed");for(let me of le){let[Ne,Ce,Be]=me;ue.activeTexture.set(re.TEXTURE0+0),Ce.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE),oe.colorAttachment.set(Be.targetColorTexture.texture);let Qe=Y.getOrCreateProgram("rasterParticleDraw",{defines:Ce.defines,overrideFog:!1});ue.activeTexture.set(re.TEXTURE0+1);let Te=Ce.scalarData?[]:[0,1,2,3].map(Ie=>r.e3[Ie](Ne));Te.push(Ne);let pe=Ne.canonical.x,Pe=Ne.canonical.y;for(let Ie of Te){let He=J.getTile(se?Ie.wrapped():Ie);if(!He)continue;let $e=He.rasterParticleState;if(!$e)continue;let qe=Ie.canonical.x+(1<<Ie.canonical.z)*(Ie.wrap-Ne.wrap),ot=Ie.canonical.y;$e.particleTexture0.bind(re.NEAREST,re.CLAMP_TO_EDGE);let xt=hy(1,$e.particleTexture0.size[0],[qe-pe,ot-Pe],0,Ce.texture.size,2,Ee,Ce.textureOffset,Ce.scale,Ce.offset);Qe.draw(Y,re.POINTS,pt.disabled,Lt.disabled,Yt.alphaBlended,At.disabled,xt,ie.id,$e.particleIndexBuffer,void 0,$e.particleSegment)}}}(v,E,T,U),A.bindFramebuffer.set(T.particleFramebuffer.framebuffer),function(Y,J,ie,le){let ue=Y.context,re=ue.gl,oe=J.paint.get("raster-particle-max-speed"),se=le*J.paint.get("raster-particle-speed-factor")*.15,Ee=function(Ne){return Math.pow(Ne,6)}(.01+1*J.paint.get("raster-particle-reset-rate-factor")),me=J.particleFramebuffer;ue.viewport.set([0,0,me.width,me.height]);for(let Ne of ie){let[,Ce,Be]=Ne;ue.activeTexture.set(re.TEXTURE0+0),Ce.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE),ue.activeTexture.set(re.TEXTURE0+1);let Qe=Be.particleTexture0;Qe.bind(re.NEAREST,re.CLAMP_TO_EDGE);let Te=fy(1,Qe.size[0],0,Ce.texture.size,oe,se,Ee,Ce.textureOffset,Ce.scale,Ce.offset);me.colorAttachment.set(Be.particleTexture1.texture),ue.clear({color:r.am.transparent}),Y.getOrCreateProgram("rasterParticleUpdate",{defines:Ce.defines}).draw(Y,re.TRIANGLES,pt.disabled,Lt.disabled,Yt.unblended,At.disabled,Te,J.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments)}}(v,T,U,W)}(u,t,o,h),u.renderPass==="translucent"&&(function(v,E,T,C,A){let L=v.context,R=L.gl,k=E.getSource().tileSize,V=5*(1-r.af(r.cI,r.cI+1,v.transform.zoom))*k+T.paint.get("raster-particle-elevation"),z=!v.options.moving,U=v.transform.projection.name==="globe";if(!C.length)return;let[j,W]=v.stencilConfigForOverlap(C),Y=[];U&&Y.push("PROJECTION_GLOBE_VIEW");let J=v.stencilModeFor3D();for(let ie of W){let le=ie.toUnwrapped(),ue=E.getTile(ie);if(!ue.rasterParticleState)continue;let re=ue.rasterParticleState,oe=100;ue.registerFadeDuration(oe);let se=E.findLoadedParent(ie,0),Ee=no(ue,se,E,v.transform,oe),me,Ne;v.terrain&&v.terrain.prepareDrawTile(),L.activeTexture.set(R.TEXTURE0),re.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),L.activeTexture.set(R.TEXTURE1),se&&se.rasterParticleState?(se.rasterParticleState.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),me=Math.pow(2,se.tileID.overscaledZ-ue.tileID.overscaledZ),Ne=[ue.tileID.canonical.x*me%1,ue.tileID.canonical.y*me%1]):re.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE);let Ce=U?Float32Array.from(v.transform.expandedFarZProjMatrix):v.transform.calculateProjMatrix(le,z),Be=v.transform,Qe=Ca(Be),Te=r.dA(ie.canonical),pe=r.dB(Te.getCenter().lat),Pe,Ie,He,$e,qe;U?(Pe=Float32Array.from(r.bh(r.dD(ie.canonical))),Ie=Float32Array.from(Be.globeMatrix),He=Float32Array.from(r.dz(Be)),$e=[r.aD(Be.center.lng),r.aH(Be.center.lat)],qe=Float32Array.from(r.dC(ie.canonical,Te,pe,Be.worldSize/Be._pixelsPerMercatorPixel))):(Pe=new Float32Array(16),Ie=new Float32Array(9),He=new Float32Array(16),$e=[0,0],qe=new Float32Array(9));let ot=Dh(Ce,Pe,Ie,He,qe,Ne||[0,0],r.ah(v.transform.zoom),$e,Qe,me||1,Ee,V),xt=v.isTileAffectedByFog(ie),St=v.getOrCreateProgram("rasterParticle",{defines:Y,overrideFog:xt});if(v.uploadCommonUniforms(L,St,le),U){let dt=new pt(R.LEQUAL,pt.ReadOnly,v.depthRangeFor3D),Tt=0,wt=v.globeSharedBuffers;if(wt){let[zt,qt,on]=wt.getGridBuffers(pe,Tt!==0);St.draw(v,R.TRIANGLES,dt,J,Yt.alphaBlended,v.renderElevatedRasterBackface?At.frontCCW:At.backCCW,ot,T.id,zt,qt,on)}}else{let dt=v.depthModeForSublayer(0,pt.ReadOnly),Tt=j[ie.overscaledZ],{tileBoundsBuffer:wt,tileBoundsIndexBuffer:zt,tileBoundsSegments:qt}=v.getTileBoundsBuffers(ue);St.draw(v,R.TRIANGLES,dt,Tt,Yt.alphaBlended,At.disabled,ot,T.id,wt,zt,qt)}}v.resetStencilClippingMasks()}(u,t,o,h),u.style.map.triggerRepaint())},background:function(u,t,o,h){let g=o.paint.get("background-color"),_=o.paint.get("background-color-use-theme").constantOr("default")==="none",v=o.paint.get("background-opacity"),E=o.paint.get("background-emissive-strength"),T=o.paint.get("background-pitch-alignment")==="viewport";if(v===0)return;let C=u.context,A=C.gl,L=u.transform,R=L.tileSize,k=o.paint.get("background-pattern"),V;if(k!==void 0&&(k===null||(V=u.imageManager.getPattern(r.I.from(k.toString()),o.scope,u.style.getLut(o.scope)),!V)))return;let z=!k&&g.a===1&&v===1&&u.opaquePassEnabledForLayer()?"opaque":"translucent";if(u.renderPass!==z)return;let U=Lt.disabled,j=u.depthModeForSublayer(0,z==="opaque"?pt.ReadWrite:pt.ReadOnly),W=u.colorModeForDrapableLayerRenderPass(E),Y=k?"backgroundPattern":"background",J,ie=h;if(ie||(J=u.getBackgroundTiles(),ie=Object.values(J).map(le=>le.tileID)),k&&(C.activeTexture.set(A.TEXTURE0),u.imageManager.bind(u.context,o.scope)),T){let le=u.getOrCreateProgram(Y,{overrideFog:!1,overrideRtt:!0}),ue=new Float32Array(r.bx([])),re=new r.aM(0,0,0,0,0),oe=k?Zp(ue,E,v,u,0,o.scope,V,T,{tileID:re,tileSize:R}):py(ue,E,v,g.toPremultipliedRenderColor(_?null:o.lut));le.draw(u,A.TRIANGLES,j,U,W,At.disabled,oe,o.id,u.viewportBuffer,u.quadTriangleIndexBuffer,u.viewportSegments)}else for(let le of ie){let ue=u.isTileAffectedByFog(le),re=u.getOrCreateProgram(Y,{overrideFog:ue}),oe=le.toUnwrapped(),se=h?le.projMatrix:u.transform.calculateProjMatrix(oe);u.prepareDrawTile();let Ee=t?t.getTile(le):J?J[le.key]:new Qa(le,R,L.zoom,u),me=k?Zp(se,E,v,u,0,o.scope,V,T,{tileID:le,tileSize:R}):py(se,E,v,g.toPremultipliedRenderColor(_?null:o.lut));u.uploadCommonUniforms(C,re,oe);let{tileBoundsBuffer:Ne,tileBoundsIndexBuffer:Ce,tileBoundsSegments:Be}=u.getTileBoundsBuffers(Ee);re.draw(u,A.TRIANGLES,j,U,W,At.disabled,me,o.id,Ne,Ce,Be)}},sky:function(u,t,o){let h=u._atmosphere?r.ah(u.transform.zoom):1,g=o.paint.get("sky-opacity")*h;if(g===0)return;let _=u.context,v=o.paint.get("sky-type"),E=new pt(_.gl.LEQUAL,pt.ReadOnly,[0,1]),T=u.frameCounter/1e3%1;v==="atmosphere"?u.renderPass==="offscreen"?o.needsSkyboxCapture(u)&&(function(C,A,L,R){let k=C.context,V=k.gl,z=A.skyboxFbo;if(!z){z=A.skyboxFbo=k.createFramebuffer(32,32,!0,null),A.skyboxGeometry=new pl(k),A.skyboxTexture=k.gl.createTexture(),V.bindTexture(V.TEXTURE_CUBE_MAP,A.skyboxTexture),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_WRAP_S,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_WRAP_T,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_MIN_FILTER,V.LINEAR),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_MAG_FILTER,V.LINEAR);for(let Y=0;Y<6;++Y)V.texImage2D(V.TEXTURE_CUBE_MAP_POSITIVE_X+Y,0,V.RGBA,32,32,0,V.RGBA,V.UNSIGNED_BYTE,null)}k.bindFramebuffer.set(z.framebuffer),k.viewport.set([0,0,32,32]);let U=A.getCenter(C,!0),j=C.getOrCreateProgram("skyboxCapture"),W=new Float64Array(16);r.bx(W),r.eh(W,W,.5*-Math.PI),as(C,A,j,W,U,0),r.bx(W),r.eh(W,W,.5*Math.PI),as(C,A,j,W,U,1),r.bx(W),r.cR(W,W,.5*-Math.PI),as(C,A,j,W,U,2),r.bx(W),r.cR(W,W,.5*Math.PI),as(C,A,j,W,U,3),r.bx(W),as(C,A,j,W,U,4),r.bx(W),r.eh(W,W,Math.PI),as(C,A,j,W,U,5),k.viewport.set([0,0,C.width,C.height])}(u,o),o.markSkyboxValid(u)):u.renderPass==="sky"&&function(C,A,L,R,k){let V=C.context,z=V.gl,U=C.transform,j=C.getOrCreateProgram("skybox");V.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_CUBE_MAP,A.skyboxTexture);let W=((Y,J,ie,le,ue)=>({u_matrix:Y,u_sun_direction:J,u_cubemap:0,u_opacity:le,u_temporal_offset:ue}))(U.skyboxMatrix,A.getCenter(C,!1),0,R,k);C.uploadCommonUniforms(V,j),j.draw(C,z.TRIANGLES,L,Lt.disabled,C.colorModeForRenderPass(),At.backCW,W,"skybox",A.skyboxGeometry.vertexBuffer,A.skyboxGeometry.indexBuffer,A.skyboxGeometry.segment)}(u,o,E,g,T):v==="gradient"&&u.renderPass==="sky"&&function(C,A,L,R,k){let V=C.context,z=V.gl,U=C.transform,j=C.getOrCreateProgram("skyboxGradient");A.skyboxGeometry||(A.skyboxGeometry=new pl(V)),V.activeTexture.set(z.TEXTURE0);let W=A.colorRampTexture;W||(W=A.colorRampTexture=new r.T(V,A.colorRamp,z.RGBA8)),W.bind(z.LINEAR,z.CLAMP_TO_EDGE);let Y=((J,ie,le,ue,re)=>({u_matrix:J,u_color_ramp:0,u_center_direction:ie,u_radius:r.al(le),u_opacity:ue,u_temporal_offset:re}))(U.skyboxMatrix,A.getCenter(C,!1),A.paint.get("sky-gradient-radius"),R,k);C.uploadCommonUniforms(V,j),j.draw(C,z.TRIANGLES,L,Lt.disabled,C.colorModeForRenderPass(),At.backCW,Y,"skyboxGradient",A.skyboxGeometry.vertexBuffer,A.skyboxGeometry.indexBuffer,A.skyboxGeometry.segment)}(u,o,E,g,T)},custom:function(u,t,o,h){let g=u.context,_=o.implementation;if(!u.transform.projection.unsupportedLayers||!u.transform.projection.unsupportedLayers.includes("custom")||u.terrain&&(u.terrain.renderingToTexture||u.renderPass==="offscreen")&&o.isDraped(t)){if(u.renderPass==="offscreen"){let v=_.prerender;if(v){if(u.setCustomLayerDefaults(),g.setColorMode(u.colorModeForRenderPass()),u.transform.projection.name==="globe"){let E=u.transform.pointMerc;v.call(_,g.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),r.ah(u.transform.zoom),[E.x,E.y],u.transform.pixelsPerMeterRatio)}else v.call(_,g.gl,u.transform.customLayerMatrix());g.setDirty(),u.setBaseState()}}else if(u.renderPass==="translucent"){if(u.terrain&&u.terrain.renderingToTexture){let E=_.renderToTile;if(E){let T=h[0].canonical,C={x:T.x+h[0].wrap*(_.wrapTileId?0:1<<T.z),y:T.y,z:T.z};g.setDepthMode(pt.disabled),g.setStencilMode(Lt.disabled),g.setColorMode(u.colorModeForRenderPass()),u.setCustomLayerDefaults(),E.call(_,g.gl,C),g.setDirty(),u.setBaseState()}return}u.setCustomLayerDefaults(),g.setColorMode(u.colorModeForRenderPass()),g.setStencilMode(Lt.disabled);let v=_.renderingMode==="3d"?new pt(u.context.gl.LEQUAL,pt.ReadWrite,u.depthRangeFor3D):u.depthModeForSublayer(0,pt.ReadOnly);if(g.setDepthMode(v),u.transform.projection.name==="globe"){let E=u.transform.pointMerc;_.render(g.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),r.ah(u.transform.zoom),[E.x,E.y],u.transform.pixelsPerMeterRatio)}else _.render(g.gl,u.transform.customLayerMatrix());g.setDirty(),u.setBaseState(),g.bindFramebuffer.set(null)}}else r.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(u,t,o,h){if(u.renderPass==="opaque")return;let g=o.paint.get("model-opacity").constantOr(1);if(g===0)return;let _=o.paint.get("model-cast-shadows");if(u.renderPass==="shadow"&&(!_||u.terrain&&g<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof r.ab))return;let v=u.shadowRenderer,E=o.paint.get("model-receive-shadows");v&&(v.useNormalOffset=!0,E||(v.enabled=!1));let T=()=>{v&&(v.useNormalOffset=!0,E||(v.enabled=!0))},C=t.getSource();if(u.renderPass==="light-beam"&&C.type!=="batched-model")return;if(C.type==="vector"||C.type==="geojson")return function(j,W,Y,J,ie){let le=j.transform;if(le.projection.name!=="mercator")return void r.w(`Drawing 3D models for ${le.projection.name} projection is not yet implemented`);let ue=le.getFreeCameraOptions().position;if(!j.modelManager)return;let re=j.modelManager;Y.modelManager=re;let oe=j.shadowRenderer;if(!Y._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let se=Y._unevaluatedLayout._values["model-id"],Ee=Object.assign({},Y.layout.get("model-id").parameters),me=j.style.order.indexOf(Y.fqid);for(let Ne of J){let Ce=W.getTile(Ne).getBucket(Y);if(!Ce||Ce.projection.name!==le.projection.name)continue;let Be=Ce.getModelUris();Be&&!Ce.modelsRequested&&(re.addModelsFromBucket(Be,ie),Ce.modelsRequested=!0);let Qe=Ob(Ne,le);Ee.zoom=Qe;let Te=se.possiblyEvaluate(Ee);if(fc(j,Ce,Ne),ws.shadowUniformsInitialized=!1,ws.useSingleShadowCascade=!!oe&&oe.getMaxCascadeForTile(Ne.toUnwrapped())===0,j.renderPass==="shadow"&&oe){if(j.currentShadowCascade===1&&Ce.isInsideFirstShadowMapFrustum)continue;let Ie=le.calculatePosMatrix(Ne.toUnwrapped(),le.worldSize);if(ws.tileMatrix.set(Ie),ws.shadowTileMatrix=Float32Array.from(oe.calculateShadowPassMatrixFromMatrix(Ie)),ws.aabb.min.fill(0),ws.aabb.max[0]=ws.aabb.max[1]=r.aj,ws.aabb.max[2]=0,lm(Ce,ws,j,Y.scope))continue}let pe=1<<Ne.canonical.z,Pe=[((ue.x-Ne.wrap)*pe-Ne.canonical.x)*r.aj,(ue.y*pe-Ne.canonical.y)*r.aj,ue.z*pe*r.aj];j.conflationActive&&Object.keys(Ce.instancesPerModel).length>0&&j.style.isLayerClipped(Y,W.getSource())&&Ce.updateReplacement(Ne,j.replacementSource,me,ie)&&(Ce.uploaded=!1,Ce.upload(j.context));for(let Ie in Ce.instancesPerModel){let He=Ce.instancesPerModel[Ie];He.features.length>0&&(Ie=Te.evaluate(He.features[0].feature,{}));let $e=re.getModel(Ie,ie);if($e||re.hasURLBeenRequested(Ie)||Ce.modelUris.includes(Ie)||(Ce.modelUris.push(Ie),Ce.modelsRequested=!1),$e&&$e.uploaded)for(let qe of $e.nodes)am(j,Y,qe,He,Pe,Ne,ws)}}}(u,t,o,h,C.type==="vector"?o.scope:""),void T();if(!C.loaded())return;if(C.type==="batched-model")return function(j,W,Y,J){Y.resetLayerRenderingStats(j);let ie=j.context,le=j.transform,ue=j.style.fog,re=j.shadowRenderer;if(le.projection.name!=="mercator")return void r.w(`Drawing 3D landmark models for ${le.projection.name} projection is not yet implemented`);let oe=j.transform.getFreeCameraOptions().position,se=r.c1([],[oe.x,oe.y,oe.z],j.transform.worldSize),Ee=r.eq([],se),me=r.bx([]),Ne=r.e9(le.center.lat,le.zoom),Ce=r.bn([],[1,1,1/Ne]);r.bo(me,me,Ee);let Be=Y.paint.get("model-opacity").constantOr(1),Qe=new pt(ie.gl.LEQUAL,pt.ReadWrite,j.depthRangeFor3D),Te=new pt(ie.gl.LEQUAL,pt.ReadOnly,j.depthRangeFor3D),pe=new r.d6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Pe=j.renderPass==="shadow",Ie=Pe&&re?re.getCurrentCascadeFrustum():le.getFrustum(le.scaleZoom(le.worldSize)),He=Y.paint.get("model-front-cutoff"),$e=He[2]<1,qe=xs(j,Y.paint.get("model-cutoff-fade-range")),ot=Y.getLayerRenderingStats();(function(xt,St,dt,Tt){let wt=xt.terrain?xt.terrain.exaggeration():0,zt=xt.transform.zoom;for(let qt of Tt){let on=St.getTile(qt).getBucket(dt);on&&(on.setFilter(dt.filter),xt.conflationActive&&on.updateReplacement(qt,xt.replacementSource),on.evaluateTransform(xt,dt),xt.terrain&&wt>0&&on.elevationUpdate(xt.terrain,wt,qt,dt.source),on.needsReEvaluation(xt,zt,dt)&&on.evaluate(dt))}})(j,W,Y,J),function(){let xt,St,dt;$e?(xt=J.length-1,St=-1,dt=-1):(xt=0,St=J.length,dt=1);let Tt=new Float64Array(16),wt=r.cx(),zt=new r.P(0,0);for(let qt=xt;qt!==St;qt+=dt){let on=J[qt],bn=W.getTile(on).getBucket(Y);if(!bn||!bn.uploaded)continue;let Ht=!1;re&&(Ht=re.getMaxCascadeForTile(on.toUnwrapped())===0);let wn=le.calculatePosMatrix(on.toUnwrapped(),le.worldSize),Dn=bn.modelTraits;!Pe&&$e&&(r.bi(Tt,wn),r.ad(wt,se,Tt),zt.x=wt[0],zt.y=wt[1]);let Xn=[];bn.setFilter(Y.filter);for(let tn of bn.getNodesInfo()){if(tn.hiddenByReplacement||!tn.node.meshes)continue;let En=tn.node,Tn=0;j.terrain&&En.elevation&&(Tn=En.elevation*j.terrain.exaggeration());let Mn=(()=>{let pr=tn.aabb;return pe.min=[...pr.min],pe.max=[...pr.max],pe.min[2]+=Tn,pe.max[2]+=Tn,r.ad(pe.min,pe.min,wn),r.ad(pe.max,pe.max,wn),pe})(),sn=tn.evaluatedScale;if(sn[0]<=1&&sn[1]<=1&&sn[2]<=1&&Mn.intersects(Ie)===0)continue;if(!Pe&&$e){let pr=.16666666666666666;tn.cameraCollisionOpacity=se[0]>Mn.min[0]&&se[0]<Mn.max[0]&&se[1]>Mn.min[1]&&se[1]<Mn.max[1]&&se[2]*Ne<Mn.max[2]&&En.footprint&&r.bY(zt,En.footprint)?Math.max(tn.cameraCollisionOpacity-pr,0):Math.min(1,tn.cameraCollisionOpacity+pr)}let zn=[...wn],Cn=1/r.d4(on.canonical),_i=En.anchor?En.anchor[0]:0,yn=En.anchor?En.anchor[1]:0;r.bo(zn,zn,[_i*(sn[0]-1)+tn.evaluatedTranslation[0]*Cn,yn*(sn[1]-1)+tn.evaluatedTranslation[1]*Cn,Tn+tn.evaluatedTranslation[2]]),r.cn(sn,r.es)||r.cP(zn,zn,sn);let Rn=r.az([],zn,En.matrix),qn=r.az([],le.expandedFarZProjMatrix,Rn),$i=r.az([],le.expandedFarZProjMatrix,zn),Bi=r.aA([],[_i,yn,Tn,1],qn)[2];En.hidden=!1;let qi=Be;Pe||($e&&(qi*=tn.cameraCollisionOpacity,qi*=Sy(zn,le,tn.aabb,He)),qi*=Iy(qe,Bi)),qi!==0?Xn.push({nodeInfo:tn,depth:Bi,opacity:qi,wvpForNode:qn,wvpForTile:$i,nodeModelMatrix:Rn,tileModelMatrix:zn}):En.hidden=!0}Pe||Xn.sort((tn,En)=>!$e||tn.opacity===1&&En.opacity===1?tn.depth<En.depth?-1:1:tn.opacity===1?-1:En.opacity===1?1:tn.depth>En.depth?-1:1);for(let tn of Xn){let En=tn.nodeInfo,Tn=En.node,Mn=r.az([],Ce,tn.tileModelMatrix);r.az(Mn,me,Mn);let sn=r.bi([],Mn);r.ea(sn,sn),r.cP(sn,sn,Nh),Mn=r.az(Mn,Mn,Tn.matrix);let zn=j.renderPass==="light-beam",Cn=Y.paint.get("model-color-use-theme").constantOr("default")==="none",_i=Dn&r.ex.HasMapboxMeshFeatures,yn=_i?0:En.evaluatedRMEA[0][2];for(let Rn=0;Rn<Tn.meshes.length;++Rn){let qn=Tn.meshes[Rn],$i=Rn===Tn.lightMeshIndex,Bi=tn.wvpForNode;if($i){if(!zn&&!j.terrain&&j.shadowRenderer){j.currentLayer<j.firstLightBeamLayer&&(j.firstLightBeamLayer=j.currentLayer);continue}Bi=tn.wvpForTile}else if(zn)continue;let qi={defines:[]},pr=[];if(!Pe&&re&&(re.useNormalOffset=!!qn.normalBuffer),Gu(qi.defines,pr,qn,j,Cn?null:Y.lut),_i||qi.defines.push("DIFFUSE_SHADED"),Ht&&qi.defines.push("SHADOWS_SINGLE_CASCADE"),ot&&(Pe?ot.numRenderedVerticesInShadowPass+=qn.vertexArray.length:ot.numRenderedVerticesInTransparentPass+=qn.vertexArray.length),Pe){Fh(qn,tn.nodeModelMatrix,j,Y);continue}let ls=null;if(ue){let Ir=$u(tn.nodeModelMatrix,j.transform);if(ls=new Float32Array(Ir),le.projection.name!=="globe"){let Oi=qn.aabb.min,Si=qn.aabb.max,[Jn,Qi]=ue.getOpacityForBounds(Ir,Oi[0],Oi[1],Si[0],Si[1]);qi.overrideFog=Jn>=je||Qi>=je}}let Hr=qn.material,po;Hr.occlusionTexture&&Hr.occlusionTexture.offsetScale&&(po=Hr.occlusionTexture.offsetScale,qi.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let Tr=j.getOrCreateProgram("model",qi);!Pe&&re&&re.setupShadowsFromMatrix(tn.tileModelMatrix,Tr,re.useNormalOffset),j.uploadCommonUniforms(ie,Tr,null,ls);let Po=Hr.pbrMetallicRoughness;Po.metallicFactor=.9,Po.roughnessFactor=.5;let Qo=Xp(new Float32Array(Bi),new Float32Array(Mn),new Float32Array(sn),new Float32Array(Tn.matrix),j,tn.opacity,Po.baseColorFactor,Hr.emissiveFactor,Po.metallicFactor,Po.roughnessFactor,Hr,yn,Y,[0,0,0],po);!$i&&(En.hasTranslucentParts||tn.opacity<1)&&Tr.draw(j,ie.gl.TRIANGLES,Qe,Lt.disabled,Yt.disabled,At.backCCW,Qo,Y.id,qn.vertexBuffer,qn.indexBuffer,qn.segments,Y.paint,j.transform.zoom,void 0,pr),Tr.draw(j,ie.gl.TRIANGLES,$i?Te:Qe,Lt.disabled,$i||tn.opacity<1||En.hasTranslucentParts?Yt.alphaBlended:Yt.unblended,At.backCCW,Qo,Y.id,qn.vertexBuffer,qn.indexBuffer,qn.segments,Y.paint,j.transform.zoom,void 0,pr)}}}}()}(u,t,o,h),void T();if(C.type!=="model")return;let A=C.getModels(),L=[],R=u.transform.getFreeCameraOptions().position,k=r.c1([],[R.x,R.y,R.z],u.transform.worldSize);r.eq(k,k);let V=[],z=[],U=0;for(let j of A){let W=o.paint.get("model-rotation").constantOr(null),Y=o.paint.get("model-scale").constantOr(null),J=o.paint.get("model-translation").constantOr(null);j.computeModelMatrix(u,W,Y,J,!0,!0,!1);let ie=r.bx([]),le=r.e9(j.position.lat,u.transform.zoom),ue=r.bn([],[1,1,1/le]);r.bo(ie,ie,k),L.push({zScaleMatrix:ue,negCameraPosMatrix:ie});for(let re of j.nodes)sm(u.transform,re,j.matrix,u.transform.expandedFarZProjMatrix,U,V,z);U++}if(V.sort((j,W)=>W.depth-j.depth),u.renderPass!=="shadow"){if(g===1)for(let j of z)hc(j,u,o,L[j.modelIndex],Lt.disabled,u.colorModeForRenderPass());else{for(let j of z)hc(j,u,o,L[j.modelIndex],Lt.disabled,Yt.disabled);for(let j of z)hc(j,u,o,L[j.modelIndex],u.stencilModeFor3D(),u.colorModeForRenderPass());u.resetStencilClippingMasks()}for(let j of V)hc(j,u,o,L[j.modelIndex],Lt.disabled,u.colorModeForRenderPass());T()}else{for(let j of z)Fh(j.mesh,j.nodeModelMatrix,u,o);for(let j of V)Fh(j.mesh,j.nodeModelMatrix,u,o);T()}}},Bh={line:function(u,t,o){if(u.hasElevatedBuckets=!1,u.hasNonElevatedBuckets=!1,u._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||u._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){let h=t.getVisibleCoordinates();for(let g of h){let _=t.getTile(g).getBucket(u);if(_&&(_.elevationType!=="none"?u.hasElevatedBuckets=!0:u.hasNonElevatedBuckets=!0,u.hasElevatedBuckets&&u.hasNonElevatedBuckets))break}}}else u.hasNonElevatedBuckets=!0},model:function(u,t,o){let h=t.getSource();if(!h.loaded())return;if(h.type==="vector"||h.type==="geojson")return void(o.modelManager&&o.modelManager.upload(o,h.type==="vector"?u.scope:""));if(h.type==="batched-model"||h.type!=="model")return;let g=h.getModels();for(let _ of g)_.upload(o.context)},raster:function(u,t,o){let h=t.getSource();if(!(h instanceof pa&&h.loaded()))return;let g=u.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!g)return;let _=u.paint.get("raster-array-band")||h.getInitialBand(g);if(_==null)return;let v=t.getIds().map(E=>t.getTileByID(E));for(let E of v)E.updateNeeded(u.id,_)&&h.prepareTile(E,g,u.id,_)},"raster-particle":function(u,t,o){let h=t.getSource();if(!(h instanceof pa&&h.loaded()))return;let g=u.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!g)return;let _=u.paint.get("raster-particle-array-band")||h.getInitialBand(g);if(_==null)return;let v=t.getIds().map(E=>t.getTileByID(E));for(let E of v)E.updateNeeded(u.id,_)&&h.prepareTile(E,g,u.id,_)}},Vh={fill:gt},Ao={fill:function(u,t,o,h){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let g=u.context.gl,_=new pt(g.LEQUAL,pt.ReadOnly,u.depthRangeFor3D),v=new Lt({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),E=u.transform.getFreeCameraOptions().position,T=u.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(let C of h){let A=t.getTile(C),L=A.getBucket(o);if(!L)continue;let R=L.elevatedStructures;if(!R||R.depthSegments.segments[0].primitiveLength===0)continue;let k=Vu(C.toUnwrapped(),E),V=u.translatePosMatrix(C.projMatrix,A,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),z=Ih(V,k,0,1,0);T.draw(u,g.TRIANGLES,_,v,Yt.disabled,At.disabled,z,o.id,R.vertexBuffer,R.indexBuffer,R.depthSegments,o.paint,u.transform.zoom)}}};class Ma{constructor(t,o,h,g,_,v){this.context=new Mh(t,o),this.transform=h,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=_,this._timeStamp=r.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let E=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(let C of E)this._debugParams.enabledLayers[C]=!0;_.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),_.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),_.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),_.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let C of E)_.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],C);this.occlusionParams=new pc(_),this.setup(),this.numSublayers=eo.maxUnderzooming+eo.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new r.eE,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new pb(this),this._wireframeDebugCache=new qu,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let T=new r.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new r.T(this.context,T,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=g,this.worldview=v}updateTerrain(t,o){let h=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(h||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new bh(this,t));let g=this._terrain;this.transform.elevation=h?g:null,g.update(t,this.transform,o),this.transform.elevation&&!g.enabled&&(this.transform.elevation=null)}_updateFog(t){let o=t.fog;if(!o||this.transform.projection.name==="globe"||o.getOpacity(this.transform.pitch)<1||o.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[h,g]=o.getFovAdjustedRange(this.transform._fov);if(h>g)return void(this.transform.fogCullDistSq=null);let _=h+.78*(g-h);this.transform.fogCullDistSq=_*_}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new bh(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,o){if(this.width=t*r.q.devicePixelRatio,this.height=o*r.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let h of this.style.order)this.style._mergedLayers[h].resize()}setup(){let t=this.context,o=new r.ba;o.emplaceBack(0,0),o.emplaceBack(r.aj,0),o.emplaceBack(0,r.aj),o.emplaceBack(r.aj,r.aj),this.tileExtentBuffer=t.createVertexBuffer(o,r.bc.members),this.tileExtentSegments=r.bd.simpleSegment(0,0,4,2);let h=new r.ba;h.emplaceBack(0,0),h.emplaceBack(r.aj,0),h.emplaceBack(0,r.aj),h.emplaceBack(r.aj,r.aj),this.debugBuffer=t.createVertexBuffer(h,r.bc.members),this.debugSegments=r.bd.simpleSegment(0,0,4,5);let g=new r.ba;g.emplaceBack(-1,-1),g.emplaceBack(1,-1),g.emplaceBack(-1,1),g.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(g,r.bc.members),this.viewportSegments=r.bd.simpleSegment(0,0,4,2);let _=new r.aZ;_.emplaceBack(0,0,0,0),_.emplaceBack(r.aj,0,r.aj,0),_.emplaceBack(0,r.aj,0,r.aj),_.emplaceBack(r.aj,r.aj,r.aj,r.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(_,r.bf.members),this.mercatorBoundsSegments=r.bd.simpleSegment(0,0,4,2);let v=new r.a_;v.emplaceBack(0,1,2),v.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(v);let E=new r.bb;for(let C of[0,1,3,2,0])E.emplaceBack(C);this.debugIndexBuffer=t.createIndexBuffer(E),this.emptyTexture=new r.T(t,new r.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=r.bz();let T=this.context.gl;this.stencilClearMode=new Lt({func:T.ALWAYS,mask:0},0,255,T.ZERO,T.ZERO,T.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,pt.disabled,this.stencilClearMode,Yt.disabled,At.disabled,vh(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,o,h){if(!o||this.currentStencilSource===o.id||!t.isTileClipped()||!h||h.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let E=!1;for(let T of h)if(this._tileClippingMaskIDs[T.key]===void 0){E=!0;break}if(!E)return}this.currentStencilSource=o.id;let g=this.context,_=g.gl;this.nextStencilID+h.length>256&&this.clearStencil(),g.setColorMode(Yt.disabled),g.setDepthMode(pt.disabled);let v=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let E of h){let T=o.getTile(E),C=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,{tileBoundsBuffer:A,tileBoundsIndexBuffer:L,tileBoundsSegments:R}=this.getTileBoundsBuffers(T);v.draw(this,_.TRIANGLES,pt.disabled,new Lt({func:_.ALWAYS,mask:0},C,255,_.KEEP,_.KEEP,_.REPLACE),Yt.disabled,At.disabled,vh(E.projMatrix),"$clipping",A,L,R)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let t=this.nextStencilID++,o=this.context.gl;return new Lt({func:o.NOTEQUAL,mask:255},t,255,o.KEEP,o.KEEP,o.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);let o=this.context.gl;return new Lt({func:o.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,o.KEEP,o.KEEP,o.REPLACE)}stencilConfigForOverlap(t){let o=this.context.gl,h=t.sort((v,E)=>E.overscaledZ-v.overscaledZ),g=h[h.length-1].overscaledZ,_=h[0].overscaledZ-g+1;if(_>1){this.currentStencilSource=void 0,this.nextStencilID+_>256&&this.clearStencil();let v={};for(let E=0;E<_;E++)v[E+g]=new Lt({func:o.GEQUAL,mask:255},E+this.nextStencilID,255,o.KEEP,o.KEEP,o.REPLACE);return this.nextStencilID+=_,[v,h]}return[{[g]:Lt.disabled},h]}colorModeForRenderPass(){let t=this.context.gl;return this._showOverdrawInspector?new Yt([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new r.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Yt.unblended:Yt.alphaBlended}colorModeForDrapableLayerRenderPass(t){let o=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new Yt([o.ONE,o.ONE_MINUS_SRC_ALPHA,o.CONSTANT_ALPHA,o.ONE_MINUS_SRC_ALPHA],new r.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,o,h,g=!1){if(this.depthOcclusion)return new pt(this.context.gl.GREATER,pt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!g)return pt.disabled;let _=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new pt(h||this.context.gl.LEQUAL,o,[_,_])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let t=this.context.gl,o=Math.ceil(this.width),h=Math.ceil(this.height),g=this.context.bindFramebuffer.get(),_=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===o&&this.depthFBO.height===h||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),o!==0&&h!==0&&(this.depthFBO=new hl(this.context,o,h,!1,"texture"),this.depthTexture=new r.T(this.context,{width:o,height:h,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(g),t.bindTexture(t.TEXTURE_2D,_),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,o,h,0,0,o,h,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,o)=>t+o/this._fpsHistory.length,0))}render(t,o){let h=r.q.now();this._dt=h-this._timeStamp,this._timeStamp=h,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=o;let g=this.style._mergedLayers,_=!(!this.terrain||!this.terrain.enabled),v=()=>this.style._getOrder(_).filter(Te=>{let pe=g[Te];return!(pe.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[pe.type]}),E=v(),T=!1,C=!1,A=null;for(let Te of E){let pe=g[Te];pe.type==="circle"?T=!0:pe.type==="building"?A=pe:pe.type==="symbol"&&(pe.hasInitialOcclusionOpacityProperties?C=!0:T=!0)}let L=E.map(Te=>g[Te]),R=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(r.q.now()),this.imageManager.beginFrame();let k=0,V=!1;for(let Te in R){let pe=R[Te];pe.used&&(pe.prepare(this.context),pe.getSource().usedInConflation&&++k)}let z=!1;for(let Te of L)Te.isHidden(this.transform.zoom)||(Te.type==="clip"&&(z=!0),this.prepareLayer(Te));let U={},j={},W={},Y={},J={};for(let Te in R){let pe=R[Te];U[Te]=pe.getVisibleCoordinates(),j[Te]=U[Te].slice().reverse(),W[Te]=pe.getVisibleCoordinates(!0).reverse(),Y[Te]=pe.getShadowCasterCoordinates(),J[Te]=pe.sortCoordinatesByDistance(U[Te])}let ie=Te=>{let pe=this.style.getLayerSourceCache(Te);return pe&&pe.used?pe.getSource():null};if(k||z||this._clippingActiveLastFrame){let Te=[],pe=[],Pe=0;for(let Ie of L)this.isSourceForClippingOrConflation(Ie,ie(Ie))&&(Te.push(Ie),pe.push(Pe)),Pe++;if(Te&&(z||Te.length>1)||this._clippingActiveLastFrame){z=!1;let Ie=[];for(let He=0;He<Te.length;He++){let $e=Te[He],qe=pe[He],ot=this.style.getLayerSourceCache($e);if(!ot||!ot.used||!ot.getSource().usedInConflation&&$e.type!=="clip"&&$e.type!=="building")continue;let xt=r.eF,St=r.bW.None,dt=[],Tt=!0;if($e.type==="building")xt=r.eH;else if($e.type==="clip"){xt=qe;for(let wt of $e.layout.get("clip-layer-types"))St|=wt==="model"?r.bW.Model:wt==="symbol"?r.bW.Symbol:r.bW.FillExtrusion;for(let wt of $e.layout.get("clip-layer-scope"))dt.push(wt);$e.isHidden(this.transform.zoom)?Tt=!1:z=!0}Tt&&Ie.push({layer:$e.fqid,cache:ot,order:xt,clipMask:St,clipScope:dt})}this.replacementSource.setSources(Ie),V=!0}}this._clippingActiveLastFrame=z,V||this.replacementSource.clear(),this.conflationActive=V,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Te=0;Te<L.length;Te++){let pe=L[Te],Pe=pe.cutoffRange();if(this.longestCutoffRange=Math.max(Pe,this.longestCutoffRange),Pe>0){let Ie=ie(pe);Ie&&(this.minCutoffZoom=Math.max(Ie.minzoom,this.minCutoffZoom)),pe.minzoom&&(this.minCutoffZoom=Math.max(pe.minzoom,this.minCutoffZoom))}pe.is3D(_)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Te),this._lastOcclusionLayer=Te)}let le=this.style&&this.style.fog;le?(this._fogVisible=le.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=le.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(W),this.opaquePassCutoff=0,E=v(),L=E.map(Te=>g[Te]));let ue=this._shadowRenderer;if(ue){ue.updateShadowParameters(this.transform,this.style.directionalLight);for(let Te in R)for(let pe of U[Te]){let Pe={min:0,max:0};this.terrain&&(Pe=this.terrain.getMinMaxForTile(pe)||Pe),ue.addShadowReceiver(pe.toUnwrapped(),Pe.min,Pe.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new r.eG(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new xe(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let re=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),oe=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(re&&!this._snow&&(this._snow=new um(this)),!re&&this._snow&&(this._snow.destroy(),delete this._snow),oe&&!this._rain&&(this._rain=new gc(this)),!oe&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),A){this.buildingTileBorderManager||(this.buildingTileBorderManager=new Ty);let Te=this.style.getLayerSourceCache(A);this.buildingTileBorderManager.updateBorders(Te,A)}if(!la.has(this.context.gl))return;this.renderPass="offscreen";for(let Te of L){let pe=t.getLayerSourceCache(Te);if(!Te.hasOffscreenPass()||Te.isHidden(this.transform.zoom))continue;let Pe=pe?j[pe.id]:void 0;(Te.type==="custom"||Te.type==="raster"||Te.type==="raster-particle"||Te.isSky()||Pe&&Pe.length)&&this.renderLayer(this,pe,Te,Pe)}this.depthRangeFor3D=[0,1-(L.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Y)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let se=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Ee=(()=>{if(o.showOverdrawInspector)return r.am.black;let Te=this.style.fog;if(Te&&this.transform.projection.supportsFog){let pe=this.style.getLut(Te.scope);if(!se){let Pe=Te.properties.get("color-use-theme")==="none",Ie=Te.properties.get("color").toNonPremultipliedRenderColor(Pe?null:pe).toArray01();return new r.am(...Ie)}if(se){let Pe=Te.properties.get("space-color-use-theme")==="none",Ie=Te.properties.get("space-color").toNonPremultipliedRenderColor(Pe?null:pe).toArray01();return new r.am(...Ie)}}return r.am.transparent})();if(this.context.clear({color:Ee,depth:1}),this.clearStencil(),this._showOverdrawInspector=o.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&se&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=E.length-1;this.currentLayer>=0;this.currentLayer--){let Te=L[this.currentLayer],pe=t.getLayerSourceCache(Te);if(Te.isSky())continue;let Pe=pe?(Te.is3D(_)?J:j)[pe.id]:void 0;this._renderTileClippingMasks(Te,pe,Pe),this.renderLayer(this,pe,Te,Pe)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&se&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||r.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<E.length;this.currentLayer++){let Te=L[this.currentLayer],pe=t.getLayerSourceCache(Te);Te.isSky()&&this.renderLayer(this,pe,Te,pe?j[pe.id]:void 0)}function me(Te,pe){let Pe;return pe&&(Pe=(Te.type==="symbol"?W:Te.is3D(_)?J:j)[pe.id]),Pe}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<E.length;){let Te=L[this.currentLayer];if(Te.type==="raster"||Te.type==="raster-particle"){let pe=t.getLayerSourceCache(Te);this.renderLayer(this,pe,Te,me(Te,pe))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ne=0;ue&&(Ne=ue.getShadowCastingLayerCount());let Ce=!1,Be=-1;for(let Te=0;Te<E.length;++Te){let pe=L[Te];pe.isHidden(this.transform.zoom)||pe.is3D(_)&&(Be=Te)}C&&Be===-1&&(T=!0);let Qe=!1;for(;this.currentLayer<E.length;){let Te=L[this.currentLayer],pe=t.getLayerSourceCache(Te);if(Te.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Te)){if(Te.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Qe&&Te.is3D(_)&&!_){let Pe=this.currentLayer,Ie=He=>{for(this.currentLayer=0;this.currentLayer<L.length;this.currentLayer++){let $e=L[this.currentLayer];if(Vh[$e.type]){let qe=this.style.getLayerSourceCache($e);Vh[$e.type](this,qe,$e,me($e,qe),He)}}};Ie("initialize"),Ie("reset"),this.currentLayer=Pe,Qe=!0}if(T&&!Ce&&this.terrain&&!this.transform.isOrthographic&&(Ce=!0,this.blitDepth()),C&&Be!==-1&&this.currentLayer===Be+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Te,pe,pe?U[pe.id]:void 0),this.renderLayer(this,pe,Te,me(Te,pe)),!this.terrain&&ue&&Ne>0&&Te.hasShadowPass()&&--Ne==0){{this.clearStencil(),this.resetStencilClippingMasks();let Pe=this.currentLayer;for(this.currentLayer=0;this.currentLayer<L.length;this.currentLayer++){let Ie=L[this.currentLayer];if(Ao[Ie.type]){let He=this.style.getLayerSourceCache(Ie);Ao[Ie.type](this,He,Ie,me(Ie,He))}}this.currentLayer=Pe}if(ue.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){let Pe=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Pe;this.currentLayer++){let Ie=L[this.currentLayer];if(!Ie.hasLightBeamPass())continue;let He=t.getLayerSourceCache(Ie);this.renderLayer(this,He,Ie,He?j[He.id]:void 0)}this.currentLayer=Pe,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let Pe=this.currentLayer;this.depthOcclusion=!0;for(let Ie of this.layersWithOcclusionOpacity){this.currentLayer=Ie;let He=L[this.currentLayer],$e=t.getLayerSourceCache(He),qe=$e?j[$e.id]:void 0;this.terrain||this._renderTileClippingMasks(He,$e,$e?U[$e.id]:void 0),this.renderLayer(this,$e,He,qe)}this.depthOcclusion=!1,this.currentLayer=Pe,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Te=null;L.forEach(pe=>{let Pe=t.getLayerSourceCache(pe);Pe&&!pe.isHidden(this.transform.zoom)&&Pe.getVisibleCoordinates().length&&(!Te||Te.getSource().maxzoom<Pe.getSource().maxzoom)&&(Te=Pe)}),Te&&this.options.showTileBoundaries&&bs(this,Te,Te.getVisibleCoordinates(),r.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&bs(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new r.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Te){let pe=Te.transform.padding;Uu(Te,Te.transform.height-(pe.top||0),3,xy),Uu(Te,pe.bottom||0,3,im),kh(Te,pe.left||0,3,rm),kh(Te,Te.transform.width-(pe.right||0),3,om);let Pe=Te.transform.centerPoint;(function(Ie,He,$e,qe){Hu(Ie,He-1,$e-10,2,20,qe),Hu(Ie,He-10,$e-1,20,2,qe)})(Te,Pe.x,Te.transform.height-Pe.y,by)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),V||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);let{unsupportedLayers:o}=this.transform.projection,h=!o||!o.includes(t.type);if(Bh[t.type]&&(h||this.terrain&&t.type==="custom")){let g=this.style.getLayerSourceCache(t);Bh[t.type](t,g,this)}this.gpuTimingEnd()}renderLayer(t,o,h,g){h.isHidden(this.transform.zoom)||(h.type==="background"||h.type==="sky"||h.type==="custom"||h.type==="model"||h.type==="raster"||h.type==="raster-particle"||g&&g.length)&&(this.id=h.id,this.gpuTimingStart(h),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(h.type)&&(!t.terrain||h.type!=="custom")||h.type==="clip"||dm[h.type](t,o,h,g,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;let o=this.context.extTimerQuery,h=this.context.gl,g=this.gpuTimers[t.id];g||(g=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:h.createQuery()}),g.calls++,h.beginQuery(o.TIME_ELAPSED_EXT,g.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let t=this.context.extTimerQuery,o=this.context.gl,h=o.createQuery();this.deferredRenderGpuTimeQueries.push(h),o.beginQuery(t.TIME_ELAPSED_EXT,h)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){let t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){let o={};for(let h in t){let g=t[h],_=this.context.extTimerQuery,v=_.getQueryParameter(g.query,this.context.gl.QUERY_RESULT)/1e6;_.deleteQueryEXT(g.query),o[h]=v}return o}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;let o=this.context.gl,h=0;for(let g of t)h+=o.getQueryParameter(g,o.QUERY_RESULT)/1e6,o.deleteQuery(g);return h}translatePosMatrix(t,o,h,g,_){if(!h[0]&&!h[1])return t;let v=_?g==="map"?this.transform.angle:0:g==="viewport"?-this.transform.angle:0;if(v){let C=Math.sin(v),A=Math.cos(v);h=[h[0]*A-h[1]*C,h[0]*C+h[1]*A]}let E=[_?h[0]:r.aw(o,h[0],this.transform.zoom),_?h[1]:r.aw(o,h[1],this.transform.zoom),0],T=new Float32Array(16);return r.bo(T,t,E),T}saveTileTexture(t){if(t.context!==this.context)return;let o=t.size[0],h=this._tileTextures[o];h?h.push(t):this._tileTextures[o]=[t]}getTileTexture(t){let o=this._tileTextures[t];return o&&o.length>0?o.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,o,h){let g=h===void 0?this.terrain&&this.terrain.renderingToTexture:h,_=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(_.push("LIGHTING_3D_MODE"),_.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):g||_.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||_.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(_.push("TERRAIN"),this.linearFloatFilteringSupported()&&_.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&_.push("GLOBE"),!this._fogVisible||g||o!==void 0&&!o||_.push("FOG","FOG_DITHERING"),g&&_.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&_.push("OVERDRAW_INSPECTOR"),_}getOrCreateProgram(t,o){this.cache=this.cache||{};let h=o&&o.defines||[],g=o&&o.config,_=this.currentGlobalDefines(t,o&&o.overrideFog,o&&o.overrideRtt).concat(h),v=Eh.cacheKey(ku[t],t,_,g);return this.cache[v]||(this.cache[v]=new Eh(this.context,t,ku[t],g,gy[t],_)),this.cache[v]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new r.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,o){if(this.style.enable3dLights()){let h=this.style.directionalLight,g=this.style.ambientLight;if(h&&g){let _=((v,E,T)=>{let C=v.properties.get("direction"),A=v.properties.get("color-use-theme")==="none",L=v.properties.get("color").toNonPremultipliedRenderColor(A?null:T.getLut(v.scope)).toArray01(),R=v.properties.get("intensity"),k=E.properties.get("color-use-theme")==="none",V=E.properties.get("color").toNonPremultipliedRenderColor(k?null:T.getLut(E.scope)).toArray01(),z=E.properties.get("intensity"),U=[C.x,C.y,C.z],j=r.dI(V,z),W=r.dI(L,R);return{u_lighting_ambient_color:j,u_lighting_directional_dir:U,u_lighting_directional_color:W,u_ground_radiance:Vp(U,W,j)}})(h,g,this.style);o.setLightsUniformValues(t,_)}}}uploadCommonUniforms(t,o,h,g,_){if(this.uploadCommonLightUniforms(t,o),this.terrain&&this.terrain.renderingToTexture)return;let v=this.style.fog;if(v){let E=v.getOpacity(this.transform.pitch),T=((C,A,L,R,k,V,z,U,j,W,Y,J)=>{let ie=C.transform,le=A.properties.get("color-use-theme")==="none",ue=A.properties.get("color").toNonPremultipliedRenderColor(le?null:C.style.getLut(A.scope)).toArray01();ue[3]=R;let re=C.frameCounter/1e3%1,[oe,se]=A.properties.get("vertical-range");return{u_fog_matrix:L?ie.calculateFogTileMatrix(L):J||C.identityMat,u_fog_range:A.getFovAdjustedRange(ie._fov),u_fog_color:ue,u_fog_horizon_blend:A.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(oe,se),se],u_fog_temporal_offset:re,u_frustum_tl:k,u_frustum_tr:V,u_frustum_br:z,u_frustum_bl:U,u_globe_pos:j,u_globe_radius:W,u_viewport:Y,u_globe_transition:r.ah(ie.zoom),u_is_globe:+(ie.projection.name==="globe")}})(this,v,h,E,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*r.q.devicePixelRatio,this.transform.height*r.q.devicePixelRatio],g);o.setFogUniformValues(t,T)}_&&o.setCutoffUniformValues(t,_.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){let t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){let t=this.context.gl,o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),o}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let t=this._backgroundTiles,o=this._backgroundTiles={},h=this.transform.coveringTiles({tileSize:512});for(let g of h)o[g.key]=t[g.key]||new Qa(g,512,this.transform.tileZoom,this,void 0,this.worldview);return o}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,o){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!o||o.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let o=this._cachedTileFogOpacities[t.key];return o||(this._cachedTileFogOpacities[t.key]=o=this.style.fog.getOpacityForTile(t)),o[0]>=je||o[1]>=je}setupDepthForOcclusion(t,o,h){let g=this.context,_=g.gl,v=!!h;var E;h||(h={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),g.activeTexture.set(_.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),h.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],h.u_depth_range_unpack=[2/((E=this.depthRangeFor3D)[1]-E[0]),-1-2*E[0]/(E[1]-E[0])],h.u_occluder_half_size=.5*this.occlusionParams.occluderSize,h.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),g.activeTexture.set(_.TEXTURE0),v||o.setTerrainUniformValues(g,h)}}function _c(u,t){let o=!1,h=null,g=()=>{h=null,o&&(u(),h=setTimeout(g,t),o=!1)};return()=>(o=!0,h||g(),h)}class jh{constructor(t){this._hashName=t&&encodeURIComponent(t),r.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=_c(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let t=this._map;if(!t)return"";let o=Uh(t);if(this._hashName){let h=this._hashName,g=!1,_=location.hash.slice(1).split("&").map(v=>{let E=v.split("=")[0];return E===h?(g=!0,`${E}=${o}`):v}).filter(v=>v);return g||_.push(`${h}=${o}`),`#${_.join("&")}`}return`#${o}`}_getCurrentHash(){let t=location.hash.replace("#","");if(this._hashName){let o;return t.split("&").map(h=>h.split("=")).forEach(h=>{h[0]===this._hashName&&(o=h)}),(o&&o[1]||"").split("/")}return t.split("/")}_onHashChange(){let t=this._map;if(!t)return!1;let o=this._getCurrentHash();if(o.length>=3&&!o.some(h=>isNaN(Number(h)))){let h=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(o[3]||0):t.getBearing();return t.jumpTo({center:[+o[2],+o[1]],zoom:+o[0],bearing:h,pitch:+(o[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Uh(u,t){let o=u.getCenter(),h=Math.round(100*u.getZoom())/100,g=Math.ceil((h*Math.LN2+Math.log(512/360/.5))/Math.LN10),_=Math.pow(10,g),v=Math.round(o.lng*_)/_,E=Math.round(o.lat*_)/_,T=u.getBearing(),C=u.getPitch(),A=t?`/${v}/${E}/${h}`:`${h}/${E}/${v}`;return(T||C)&&(A+="/"+Math.round(10*T)/10),C&&(A+=`/${Math.round(C)}`),A}let yc={linearity:.3,easing:r.eI(0,0,.3,1)},Ra=r.h({deceleration:2500,maxSpeed:1400},yc),hm=r.h({deceleration:20,maxSpeed:1400},yc),Es=r.h({deceleration:1e3,maxSpeed:360},yc),fm=r.h({deceleration:1e3,maxSpeed:90},yc);class Hh{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:r.q.now(),settings:t})}_drainInertiaBuffer(){let t=this._inertiaBuffer,o=r.q.now();for(;t.length>0&&o-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let o={zoom:0,bearing:0,pitch:0,pan:new r.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:_}of this._inertiaBuffer)o.zoom+=_.zoomDelta||0,o.bearing+=_.bearingDelta||0,o.pitch+=_.pitchDelta||0,_.panDelta&&o.pan._add(_.panDelta),_.around&&(o.around=_.around),_.pinchAround&&(o.pinchAround=_.pinchAround);let h=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(o.pan.mag()){let _=xc(o.pan.mag(),h,r.h({},Ra,t||{}));g.offset=o.pan.mult(_.amount/o.pan.mag()),g.center=this._map.transform.center,vc(g,_)}if(o.zoom){let _=xc(o.zoom,h,hm);g.zoom=this._map.transform.zoom+_.amount,vc(g,_)}if(o.bearing){let _=xc(o.bearing,h,Es);g.bearing=this._map.transform.bearing+r.ay(_.amount,-179,179),vc(g,_)}if(o.pitch){let _=xc(o.pitch,h,fm);g.pitch=this._map.transform.pitch+_.amount,vc(g,_)}if(g.zoom||g.bearing){let _=o.pinchAround===void 0?o.around:o.pinchAround;g.around=_?this._map.unproject(_):this._map.getCenter()}return this.clear(),g.noMoveStart=!0,g}}function vc(u,t){(!u.duration||u.duration<t.duration)&&(u.duration=t.duration,u.easing=t.easing)}function xc(u,t,o){let{maxSpeed:h,linearity:g,deceleration:_}=o,v=r.ay(u*g/(t/1e3),-h,h),E=Math.abs(v)/(_*g);return{easing:o.easing,duration:1e3*E,amount:v*(E/2)}}class di extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h,g={}){let _=xo(o.getCanvasContainer(),h),v=o.unproject(_);super(t,r.h({point:_,lngLat:v,originalEvent:h},g)),this._defaultPrevented=!1,this.target=o}}class bc extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h){let g=t==="touchend"?h.changedTouches:h.touches,_=ys(o.getCanvasContainer(),g),v=_.map(T=>o.unproject(T)),E=_.reduce((T,C,A,L)=>T.add(C.div(L.length)),new r.P(0,0));super(t,{points:_,point:E,lngLats:v,lngLat:o.unproject(E),originalEvent:h}),this._defaultPrevented=!1}}class pm extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o){super("wheel",{originalEvent:o}),this._defaultPrevented=!1}}class mm{constructor(t,o){this._map=t,this._clickTolerance=o.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new pm(this._map,t))}mousedown(t,o){return this._mousedownPos=o,this._firePreventable(new di(t.type,this._map,t))}mouseup(t){this._map.fire(new di(t.type,this._map,t))}preclick(t){let o=r.h({},t);o.type="preclick",this._map.fire(new di(o.type,this._map,o))}click(t,o){this._mousedownPos&&this._mousedownPos.dist(o)>=this._clickTolerance||(this.preclick(t),this._map.fire(new di(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new di(t.type,this._map,t))}mouseover(t){this._map.fire(new di(t.type,this._map,t))}mouseout(t){this._map.fire(new di(t.type,this._map,t))}touchstart(t){return this._firePreventable(new bc(t.type,this._map,t))}touchmove(t){this._map.fire(new bc(t.type,this._map,t))}touchend(t){this._map.fire(new bc(t.type,this._map,t))}touchcancel(t){this._map.fire(new bc(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class gl{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new di(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new di("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new di(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class gm{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=o.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,o){this.isEnabled()&&t.shiftKey&&t.button===0&&(ar(),this._startPos=this._lastPos=o,this._active=!0)}mousemoveWindow(t,o){if(!this._active)return;let h=o,g=this._startPos,_=this._lastPos;if(!g||!_||_.equals(h)||!this._box&&h.dist(g)<this._clickTolerance)return;this._lastPos=h,this._box||(this._box=Fe("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));let v=Math.min(g.x,h.x),E=Math.max(g.x,h.x),T=Math.min(g.y,h.y),C=Math.max(g.y,h.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${v}px,${T}px)`,this._box.style.width=E-v+"px",this._box.style.height=C-T+"px")})}mouseupWindow(t,o){if(!this._active)return;let h=this._startPos,g=o;if(h&&t.button===0){if(this.reset(),_s(),h.x!==g.x||h.y!==g.y)return this._map.fire(new r.A("boxzoomend",{originalEvent:t})),{cameraAnimation:_=>_.fitScreenCoordinates(h,g,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),lr(),delete this._startPos,delete this._lastPos}_fireEvent(t,o){return this._map.fire(new r.A(t,{originalEvent:o}))}}function Zu(u,t){let o={};for(let h=0;h<u.length;h++)o[u[h].identifier]=t[h];return o}class _m{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,o,h){(this.centroid||h.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),h.length===this.numTouches&&(this.centroid=function(g){let _=new r.P(0,0);for(let v of g)_._add(v);return _.div(g.length)}(o),this.touches=Zu(h,o)))}touchmove(t,o,h){if(this.aborted||!this.centroid)return;let g=Zu(h,o);for(let _ in this.touches){let v=g[_];(!v||v.dist(this.touches[_])>30)&&(this.aborted=!0)}}touchend(t,o,h){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),h.length===0){let g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class Pa{constructor(t){this.singleTap=new _m(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,o,h){this.singleTap.touchstart(t,o,h)}touchmove(t,o,h){this.singleTap.touchmove(t,o,h)}touchend(t,o,h){let g=this.singleTap.touchend(t,o,h);if(g){let _=t.timeStamp-this.lastTime<500,v=!this.lastTap||this.lastTap.dist(g)<30;if(_&&v||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class ym{constructor(){this._zoomIn=new Pa({numTouches:1,numTaps:2}),this._zoomOut=new Pa({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,o,h){this._zoomIn.touchstart(t,o,h),this._zoomOut.touchstart(t,o,h)}touchmove(t,o,h){this._zoomIn.touchmove(t,o,h),this._zoomOut.touchmove(t,o,h)}touchend(t,o,h){let g=this._zoomIn.touchend(t,o,h),_=this._zoomOut.touchend(t,o,h);return g?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()+1,around:v.unproject(g)},{originalEvent:t})}):_?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()-1,around:v.unproject(_)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let vm={0:1,2:2},$h={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class wc{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,o){return!1}_move(t,o){return{}}mousedown(t,o){if(this._lastPoint)return;let h=qd(t);this._correctButton(t,h)&&(this._lastPoint=o,this._eventButton=h)}mousemoveWindow(t,o){let h=this._lastPoint;if(h){if(t.preventDefault(),this._eventButton!=null&&function(g,_){let v=vm[_];return g.buttons===void 0||(g.buttons&v)!==v}(t,this._eventButton))this.reset();else if(this._moved||!(o.dist(h)<this._clickTolerance))return this._moved=!0,this._lastPoint=o,this._move(h,o)}}mouseupWindow(t){this._lastPoint&&qd(t)===this._eventButton&&(this._moved&&_s(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class xm extends wc{mousedown(t,o){super.mousedown(t,o),this._lastPoint&&(this._active=!0)}_correctButton(t,o){return o===0&&!t.ctrlKey}_move(t,o){return{around:o,panDelta:o.sub(t)}}}class Gh extends wc{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?$h[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=.8*(o.x-t.x);if(h)return this._active=!0,{bearingDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class bm extends wc{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?$h[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=-.5*(o.y-t.y);if(h)return this._active=!0,{pitchDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Cy{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=o.clickTolerance||1,this.reset(),r.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new r.P(0,0)}touchstart(t,o,h){return this._calculateTransform(t,o,h)}touchmove(t,o,h){if(this._active&&!(h.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(h.length===1&&!r.eJ())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,o,h)}}touchend(t,o,h){this._calculateTransform(t,o,h),this._active&&h.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,o,h){h.length>0&&(this._active=!0);let g=Zu(h,o),_=new r.P(0,0),v=new r.P(0,0),E=0;for(let C in g){let A=g[C],L=this._touches[C];L&&(_._add(A),v._add(A.sub(L)),E++,g[C]=A)}if(this._touches=g,E<this._minTouches||!v.mag())return;let T=v.div(E);return this._sum._add(T),this._sum.mag()<this._clickTolerance?void 0:{around:_.div(E),panDelta:T}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Fe("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class qh{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,o,h){return{}}touchstart(t,o,h){this._firstTwoTouches||h.length<2||(this._firstTwoTouches=[h[0].identifier,h[1].identifier],this._start([o[0],o[1]]))}touchmove(t,o,h){let g=this._firstTwoTouches;if(!g)return;t.preventDefault();let[_,v]=g,E=Xu(h,o,_),T=Xu(h,o,v);if(!E||!T)return;let C=this._aroundCenter?null:E.add(T).div(2);return this._move([E,T],C,t)}touchend(t,o,h){if(!this._firstTwoTouches)return;let[g,_]=this._firstTwoTouches,v=Xu(h,o,g),E=Xu(h,o,_);v&&E||(this._active&&_s(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Xu(u,t,o){for(let h=0;h<u.length;h++)if(u[h].identifier===o)return t[h]}function wm(u,t){return Math.log(u/t)/Math.LN2}class Ay extends qh{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,o){let h=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(wm(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:wm(this._distance,h),pinchAround:o}}}function Em(u,t){return 180*u.angleWith(t)/Math.PI}class My extends qh{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,o){let h=this._vector;if(this._vector=t[0].sub(t[1]),h&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Em(this._vector,h),pinchAround:o}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());let o=25/(Math.PI*this._minDiameter)*360,h=this._startVector;if(!h)return!1;let g=Em(t,h);return Math.abs(g)<o}}function Wh(u){return Math.abs(u.y)>Math.abs(u.x)}class Ry extends qh{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Wh(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,o,h){let g=this._lastPoints;if(!g)return;let _=t[0].sub(g[0]),v=t[1].sub(g[1]);return this._map._cooperativeGestures&&!r.eJ()&&h.touches.length<3||(this._valid=this.gestureBeginsVertically(_,v,h.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(_.y+v.y)/2*-.5})}gestureBeginsVertically(t,o,h){if(this._valid!==void 0)return this._valid;let g=t.mag()>=2,_=o.mag()>=2;if(!g&&!_)return;if(!g||!_)return this._firstMove==null&&(this._firstMove=h),h-this._firstMove<100&&void 0;let v=t.y>0==o.y>0;return Wh(t)&&Wh(o)&&v}}let Py={panStep:100,bearingStep:15,pitchStep:10};class Oy{constructor(){let t=Py;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let o=0,h=0,g=0,_=0,v=0;switch(t.keyCode){case 61:case 107:case 171:case 187:o=1;break;case 189:case 109:case 173:o=-1;break;case 37:t.shiftKey?h=-1:(t.preventDefault(),_=-1);break;case 39:t.shiftKey?h=1:(t.preventDefault(),_=1);break;case 38:t.shiftKey?g=1:(t.preventDefault(),v=-1);break;case 40:t.shiftKey?g=-1:(t.preventDefault(),v=1);break;default:return}return this._rotationDisabled&&(h=0,g=0),{cameraAnimation:E=>{let T=E.getZoom();E.easeTo({duration:300,easeId:"keyboardHandler",easing:Ly,zoom:o?Math.round(T)+o*(t.shiftKey?2:1):T,bearing:E.getBearing()+h*this._bearingStep,pitch:E.getPitch()+g*this._pitchStep,offset:[-_*this._panStep,-v*this._panStep],center:E.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Ly(u){return u*(2-u)}let ky=4.000244140625,Fb=1/450;class Nb{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._handler=o,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Fb,r.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||r.eJ()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let o=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY,h=r.q.now(),g=h-(this._lastWheelEventTime||0);this._lastWheelEventTime=h,o!==0&&o%ky==0?this._type="wheel":o!==0&&Math.abs(o)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=o,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(g*o)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,o+=this._lastValue)),t.shiftKey&&o&&(o/=4),this._type&&(this._lastWheelEvent=t,this._delta-=o,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let o=xo(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:o,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let o=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){let C=this._type==="wheel"&&Math.abs(this._delta)>ky?this._wheelZoomRate:this._defaultZoomRate,A=2/(1+Math.exp(-Math.abs(this._delta*C)));this._delta<0&&A!==0&&(A=1/A);let L=o(),R=Math.pow(2,L),k=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):R;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(k*A))),this._type==="wheel"&&(this._startZoom=L,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let h=typeof this._targetZoom=="number"?this._targetZoom:o(),g=this._startZoom,_=this._easing,v,E=!1;if(this._type==="wheel"&&g&&_){let C=Math.min((r.q.now()-this._lastWheelEventTime)/200,1),A=_(C);v=r.ai(g,h,A),C<1?this._frameId||(this._frameId=!0):E=!0}else v=h,E=!0;this._active=!0,E&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let T=v-o();return T*this._lastDelta<0&&(T=0),{noInertia:!0,needsRenderFrame:!E,zoomDelta:T,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let o=r.eK;if(this._prevEase){let h=this._prevEase,g=(r.q.now()-h.start)/h.duration,_=h.easing(g+.01)-h.easing(g),v=.27/Math.sqrt(_*_+1e-4)*.01,E=Math.sqrt(.0729-v*v);o=r.eI(v,E,.25,1)}return this._prevEase={start:r.q.now(),duration:t,easing:o},o}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Fe("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class gi{constructor(t,o){this._clickZoom=t,this._tapZoom=o}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Fy{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,o){return t.preventDefault(),{cameraAnimation:h=>{h.easeTo({duration:300,zoom:h.getZoom()+(t.shiftKey?-1:1),around:h.unproject(o)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class zb{constructor(){this._tap=new Pa({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,o,h){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?h.length>0&&(this._swipePoint=o[0],this._swipeTouch=h[0].identifier):this._tap.touchstart(t,o,h))}touchmove(t,o,h){if(this._tapTime){if(this._swipePoint){if(h[0].identifier!==this._swipeTouch)return;let g=o[0],_=g.y-this._swipePoint.y;return this._swipePoint=g,t.preventDefault(),this._active=!0,{zoomDelta:_/128}}}else this._tap.touchmove(t,o,h)}touchend(t,o,h){this._tapTime?this._swipePoint&&h.length===0&&this.reset():this._tap.touchend(t,o,h)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Tm{constructor(t,o,h){this._el=t,this._mousePan=o,this._touchPan=h}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Bb{constructor(t,o,h){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=o,this._mousePitch=h}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Yu{constructor(t,o,h,g){this._el=t,this._touchZoom=o,this._touchRotate=h,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let Ku=u=>u.zoom||u.drag||u.pitch||u.rotate;class Im extends r.A{}class Zh{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,o){let h=r.at([],o,t);this.radius=r.ae(h[2]<0?r.eM([],h,this.constants):[h[0],h[1],0])}projectRay(t){r.eM(t,t,this.constants),r.au(t,t),r.eN(t,t,this.constants);let o=r.c1([],t,this.radius);if(o[2]>0){let h=r.c1([],[0,0,1],r.bG(o,[0,0,1])),g=r.c1([],r.au([],[o[0],o[1],0]),this.radius),_=r.d5([],o,r.c1([],r.at([],r.d5([],g,h),o),2));o[0]=_[0],o[1]=_[1]}return o}}function Ko(u){return u.panDelta&&u.panDelta.mag()||u.zoomDelta||u.bearingDelta||u.pitchDelta}class Xh{constructor(t,o){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Hh(t),this._bearingSnap=o.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Zh,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(o),r.aV(["handleEvent","handleWindowEvent"],this);let h=this._el;this._listeners=[[h,"touchstart",{passive:!0}],[h,"touchmove",{passive:!1}],[h,"touchend",void 0],[h,"touchcancel",void 0],[h,"mousedown",void 0],[h,"mousemove",void 0],[h,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[h,"mouseover",void 0],[h,"mouseout",void 0],[h,"dblclick",void 0],[h,"click",void 0],[h,"keydown",{capture:!1}],[h,"keyup",void 0],[h,"wheel",{passive:!1}],[h,"contextmenu",void 0],[window,"blur",void 0]];for(let[g,_,v]of this._listeners){let E=g===document?this.handleWindowEvent:this.handleEvent;g.addEventListener(_,E,v)}}destroy(){for(let[t,o,h]of this._listeners){let g=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(o,g,h)}}_addDefaultHandlers(t){let o=this._map,h=o.getCanvasContainer();this._add("mapEvent",new mm(o,t));let g=o.boxZoom=new gm(o,t);this._add("boxZoom",g);let _=new ym,v=new Fy;o.doubleClickZoom=new gi(v,_),this._add("tapZoom",_),this._add("clickZoom",v);let E=new zb;this._add("tapDragZoom",E);let T=o.touchPitch=new Ry(o);this._add("touchPitch",T);let C=new Gh(t),A=new bm(t);o.dragRotate=new Bb(t,C,A),this._add("mouseRotate",C,["mousePitch"]),this._add("mousePitch",A,["mouseRotate"]);let L=new xm(t),R=new Cy(o,t);o.dragPan=new Tm(h,L,R),this._add("mousePan",L),this._add("touchPan",R,["touchZoom","touchRotate"]);let k=new My,V=new Ay;o.touchZoomRotate=new Yu(h,V,k,E),this._add("touchRotate",k,["touchPan","touchZoom"]),this._add("touchZoom",V,["touchPan","touchRotate"]),this._add("blockableMapEvent",new gl(o));let z=o.scrollZoom=new Nb(o,this);this._add("scrollZoom",z,["mousePan"]);let U=o.keyboard=new Oy;this._add("keyboard",U);for(let j of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[j]&&o[j].enable(t[j])}_add(t,o,h){this._handlers.push({handlerName:t,handler:o,allowed:h}),this._handlersById[t]=o}stop(t){if(!this._updatingCamera){for(let{handler:o}of this._handlers)o.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Ku(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,o,h){for(let g in t)if(g!==h&&(!o||o.indexOf(g)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){let o=[];for(let h of t)this._el.contains(h.target)&&o.push(h);return o}handleEvent(t,o){this._updatingCamera=!0;let h=t.type==="renderFrame",g=h?void 0:t,_={needsRenderFrame:!1},v={},E={},T=t.touches?this._getMapTouches(t.touches):void 0,C=T?ys(this._el,T):h?void 0:xo(this._el,t);for(let{handlerName:R,handler:k,allowed:V}of this._handlers){if(!k.isEnabled())continue;let z;this._blockedByActive(E,V,R)?k.reset():k[o||t.type]&&(z=k[o||t.type](t,C,T),this.mergeHandlerResult(_,v,z,R,g),z&&z.needsRenderFrame&&this._triggerRenderFrame()),(z||k.isActive())&&(E[R]=k)}let A={};for(let R in this._previousActiveHandlers)E[R]||(A[R]=g);this._previousActiveHandlers=E,(Object.keys(A).length||Ko(_))&&(this._changes.push([_,v,A]),this._triggerRenderFrame()),(Object.keys(E).length||Ko(_))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:L}=_;L&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],L(this._map))}mergeHandlerResult(t,o,h,g,_){if(!h)return;r.h(t,h);let v={handlerName:g,originalEvent:h.originalEvent||_};h.zoomDelta!==void 0&&(o.zoom=v),h.panDelta!==void 0&&(o.drag=v),h.pitchDelta!==void 0&&(o.pitch=v),h.bearingDelta!==void 0&&(o.rotate=v)}_applyChanges(){let t={},o={},h={};for(let[g,_,v]of this._changes)g.panDelta&&(t.panDelta=(t.panDelta||new r.P(0,0))._add(g.panDelta)),g.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+g.pitchDelta),g.around!==void 0&&(t.around=g.around),g.aroundCoord!==void 0&&(t.aroundCoord=g.aroundCoord),g.pinchAround!==void 0&&(t.pinchAround=g.pinchAround),g.noInertia&&(t.noInertia=g.noInertia),r.h(o,_),r.h(h,v);this._updateMapTransform(t,o,h),this._changes=[]}_updateMapTransform(t,o,h){let g=this._map,_=g.transform,v=W=>[W.x,W.y,W.z];if((W=>{let Y=this._eventsInProgress.drag;return Y&&!this._handlersById[Y.handlerName].isActive()})()&&!Ko(t)){let W=_.zoom;_.cameraElevationReference="sea",this._originalZoom!=null&&_._orthographicProjectionAtLowPitch&&_.projection.name!=="globe"&&_.pitch===0?(_.cameraElevationReference="ground",_.zoom=this._originalZoom):(_.recenterOnTerrain(),_.cameraElevationReference="ground"),W!==_.zoom&&this._map._update(!0)}if(_._isCameraConstrained&&g._stop(!0),!Ko(t))return void this._fireEvents(o,h,!0);let{panDelta:E,zoomDelta:T,bearingDelta:C,pitchDelta:A,around:L,aroundCoord:R,pinchAround:k}=t;_._isCameraConstrained&&(T>0&&(T=0),_._isCameraConstrained=!1),k!==void 0&&(L=k),(T||(W=>o[W]&&!this._eventsInProgress[W])("drag"))&&L&&(this._dragOrigin=v(_.pointCoordinate3D(L)),this._originalZoom=_.zoom,this._trackingEllipsoid.setup(_._camera.position,this._dragOrigin)),_.cameraElevationReference="sea",g._stop(!0),L=L||g.transform.centerPoint,C&&(_.bearing+=C),A&&(_.pitch+=A),_._updateCameraState();let V=[0,0,0];if(E)if(_.projection.name==="mercator"){let W=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(L).dir),Y=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(L.sub(E)).dir);V[0]=Y[0]-W[0],V[1]=Y[1]-W[1]}else{let W=_.pointCoordinate(L);if(_.projection.name==="globe"){E=E.rotate(-_.angle);let Y=_._pixelsPerMercatorPixel/_.worldSize;V[0]=-E.x*r.eL(r.aY(W.y))*Y,V[1]=-E.y*r.eL(_.center.lat)*Y}else{let Y=_.pointCoordinate(L.sub(E));W&&Y&&(V[0]=Y.x-W.x,V[1]=Y.y-W.y)}}let z=_.zoom,U=[0,0,0];if(T){let W=v(R||_.pointCoordinate3D(L)),Y={dir:r.au([],r.at([],W,_._camera.position))};if(Y.dir[2]<0){let J=_.zoomDeltaToMovement(W,T);r.c1(U,Y.dir,J)}}let j=r.d5(V,V,U);_._translateCameraConstrained(j),T&&Math.abs(_.zoom-z)>1e-4&&_.recenterOnTerrain(),_.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(o,h,!0)}_fireEvents(t,o,h){let g=Ku(this._eventsInProgress),_=Ku(t),v={};for(let A in t){let{originalEvent:L}=t[A];this._eventsInProgress[A]||(v[`${A}start`]=L),this._eventsInProgress[A]=t[A]}!g&&_&&this._fireEvent("movestart",_.originalEvent);for(let A in v)this._fireEvent(A,v[A]);_&&this._fireEvent("move",_.originalEvent);for(let A in t){let{originalEvent:L}=t[A];this._fireEvent(A,L)}let E={},T;for(let A in this._eventsInProgress){let{handlerName:L,originalEvent:R}=this._eventsInProgress[A];this._handlersById[L].isActive()||(delete this._eventsInProgress[A],T=o[L]||R,E[`${A}end`]=T)}for(let A in E)this._fireEvent(A,E[A]);let C=Ku(this._eventsInProgress);if(h&&(g||_)&&!C){this._updatingCamera=!0;let A=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),L=R=>R!==0&&-this._bearingSnap<R&&R<this._bearingSnap;A?(L(A.bearing||this._map.getBearing())&&(A.bearing=0),this._map.easeTo(A,{originalEvent:T})):(this._map.fire(new r.A("moveend",{originalEvent:T})),L(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,o){this._map.fire(new r.A(t,o?{originalEvent:o}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new Im("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let Hi="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ts extends r.E{constructor(t,o){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=o.bearingSnap,this._respectPrefersReducedMotion=o.respectPrefersReducedMotion!==!1,r.aV(["_renderFrameCallback"],this)}getCenter(){return new r.ci(this.transform.center.lng,this.transform.center.lat)}setCenter(t,o){return this.jumpTo({center:t},o)}panBy(t,o,h){return t=r.P.convert(t).mult(-1),this.panTo(this.transform.center,r.h({offset:t},o),h)}panTo(t,o,h){return this.easeTo(r.h({center:t},o),h)}getZoom(){return this.transform.zoom}setZoom(t,o){return this.jumpTo({zoom:t},o),this}zoomTo(t,o,h){return this.easeTo(r.h({zoom:t},o),h)}zoomIn(t,o){return this.zoomTo(this.getZoom()+1,t,o),this}zoomOut(t,o){return this.zoomTo(this.getZoom()-1,t,o),this}getBearing(){return this.transform.bearing}setBearing(t,o){return this.jumpTo({bearing:t},o),this}getPadding(){return this.transform.padding}setPadding(t,o){return this.jumpTo({padding:t},o),this}rotateTo(t,o,h){return this.easeTo(r.h({bearing:t},o),h)}resetNorth(t,o){return this.rotateTo(0,r.h({duration:1e3},t),o),this}resetNorthPitch(t,o){return this.easeTo(r.h({bearing:0,pitch:0,duration:1e3},t),o),this}snapToNorth(t,o){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,o):this}getPitch(){return this.transform.pitch}setPitch(t,o){return this.jumpTo({pitch:t},o),this}cameraForBounds(t,o){t=r.aG.convert(t);let h=o&&o.bearing||0,g=o&&o.pitch||0,_=t.getNorthWest(),v=t.getSouthEast();return this._cameraForBounds(this.transform,_,v,h,g,o)}_extendPadding(t){let o={top:0,right:0,bottom:0,left:0};return t==null?r.h({},o,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:r.h({},o,t)}_extendCameraOptions(t){return(t=r.h({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,o){let h=o.max[0]-o.min[0],g=o.max[1]-o.min[1];return h/g>t.aspect?h/(2*Math.tan(.5*t.fovX)*t.aspect):g/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,o,h,g,_,v){let E=t.clone(),T=this._extendCameraOptions(v);E.bearing=g,E.pitch=_;let C=r.ci.convert(o),A=r.ci.convert(h),L=.5*(C.lat+A.lat),R=.5*(C.lng+A.lng),k=r.eO(L,R),V=r.au([],k),z=r.au([],r.bF([],V,[0,1,0])),U=r.bF([],z,V),j=[z[0],z[1],z[2],0,U[0],U[1],U[2],0,V[0],V[1],V[2],0,0,0,0,1],W=[k,r.eO(C.lat,C.lng),r.eO(A.lat,C.lng),r.eO(A.lat,A.lng),r.eO(C.lat,A.lng),r.eO(L,C.lng),r.eO(L,A.lng),r.eO(C.lat,R),r.eO(A.lat,R)],Y=r.d6.fromPoints(W.map(Ie=>[r.bG(z,Ie),r.bG(U,Ie),r.bG(V,Ie)])),J=r.ad([],Y.center,j);r.eP(J)===0&&r.eQ(J,0,0,1),r.au(J,J),r.c1(J,J,r.aB),E.center=r.eR(J);let ie=E.getWorldToCameraMatrix(),le=r.bi(new Float64Array(16),ie);Y=r.d6.applyTransform(Y,r.az([],ie,j));let ue=this._extendAABB(Y,E,T,g);if(!ue)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Y=ue,r.ad(J,J,ie);let re=.5*(Y.max[2]-Y.min[2]),oe=this._minimumAABBFrustumDistance(E,Y),se=r.c1([],[0,0,1],re),Ee=r.d5(se,J,se),me=oe+(E.pitch===0?0:r.bD(J,Ee)),Ne=E.globeCenterInViewSpace,Ce=r.at([],J,[Ne[0],Ne[1],Ne[2]]);r.au(Ce,Ce),r.c1(Ce,Ce,me);let Be=r.d5([],J,Ce);r.ad(Be,Be,le);let Qe=r.eB/r.aB,Te=r.ae(Be),pe=r.cb(Math.max(Te*Qe-r.eB,Number.EPSILON),0),Pe=Math.min(E.zoomFromMercatorZAdjusted(pe),T.maxZoom);return Pe>.5*(r.cX+r.cI)?(E.setProjection({name:"mercator"}),E.zoom=Pe,this._cameraForBounds(E,o,h,g,_,v)):{center:E.center,zoom:Pe,bearing:g,pitch:_}}_extendAABB(t,o,h,g){let _=.5*((h.padding.left||0)+(h.padding.right||0)),v=.5*((h.padding.top||0)+(h.padding.bottom||0)),E=v,T=_,C=_,A=v,L=o.width-(T+C),R=o.height-(E+A),k=r.at([],t.max,t.min),V=Math.min(L/k[0],R/k[1]),z=Math.min(o.scaleZoom(o.scale*V),h.maxZoom);if(isNaN(z))return null;let U=o.scale/o.zoomScale(z),j=new r.d6([t.min[0]-T*U,t.min[1]-A*U,t.min[2]],[t.max[0]+C*U,t.max[1]+E*U,t.max[2]]),W=(typeof h.offset.x=="number"&&typeof h.offset.y=="number"?new r.P(h.offset.x,h.offset.y):r.P.convert(h.offset)).rotate(-r.al(g));return j.center[0]-=W.x*U,j.center[1]+=W.y*U,j}queryTerrainElevation(t,o){let h=this.transform.elevation;return h?(o=r.h({},{exaggerated:!0},o),h.getAtPoint(r.ac.fromLngLat(t),null,o.exaggerated)):null}_cameraForBounds(t,o,h,g,_,v){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,o,h,g,_,v);let E=t.clone(),T=this._extendCameraOptions(v);E.bearing=g,E.pitch=_;let C=r.ci.convert(o),A=r.ci.convert(h),L=new r.ci(C.lng,A.lat),R=new r.ci(A.lng,C.lat),k=E.project(C),V=E.project(A),z=this.queryTerrainElevation(C),U=this.queryTerrainElevation(A),j=this.queryTerrainElevation(L),W=this.queryTerrainElevation(R),Y=[[k.x,k.y,Math.min(z||0,U||0,j||0,W||0)],[V.x,V.y,Math.max(z||0,U||0,j||0,W||0)]],J=r.d6.fromPoints(Y),ie=E.getWorldToCameraMatrix(),le=r.bi(new Float64Array(16),ie);J=r.d6.applyTransform(J,ie);let ue=this._extendAABB(J,E,T,g);if(!ue)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");J=ue;let re=.5*r.at([],J.max,J.min)[2],oe=this._minimumAABBFrustumDistance(E,J),se=[0,0,1,0];r.aA(se,se,ie),r.eS(se,se);let Ee=r.c1([],se,oe+re),me=r.d5([],J.center,Ee);r.ad(J.center,J.center,le),r.ad(me,me,le);let Ne=E.unproject(new r.P(J.center[0],J.center[1])),Ce=r.eT(E.projection,Ne),Be=Math.pow(2,Ce),Qe=Math.min(E._zoomFromMercatorZ(me[2]*E.pixelsPerMeter*Be/E.worldSize),T.maxZoom);return E.mercatorFromTransition&&Qe<.5*(r.cX+r.cI)?(E.setProjection({name:"globe"}),E.zoom=Qe,this._cameraForBounds(E,o,h,g,_,v)):{center:Ne,zoom:Qe,bearing:g,pitch:_}}fitBounds(t,o,h){let g=this.cameraForBounds(t,o);return this._fitInternal(g,o,h)}fitScreenCoordinates(t,o,h,g,_){let v=r.P.convert(t),E=r.P.convert(o),T=new r.P(Math.min(v.x,E.x),Math.min(v.y,E.y)),C=new r.P(Math.max(v.x,E.x),Math.max(v.y,E.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(v,E))return this;let A=this.transform.pointLocation3D(T),L=this.transform.pointLocation3D(C),R=this.transform.pointLocation3D(new r.P(T.x,C.y)),k=this.transform.pointLocation3D(new r.P(C.x,T.y)),V=[Math.min(A.lng,L.lng,R.lng,k.lng),Math.min(A.lat,L.lat,R.lat,k.lat)],z=[Math.max(A.lng,L.lng,R.lng,k.lng),Math.max(A.lat,L.lat,R.lat,k.lat)],U=g&&g.pitch?g.pitch:this.getPitch(),j=this._cameraForBounds(this.transform,V,z,h,U,g);return this._fitInternal(j,g,_)}_fitInternal(t,o,h){return t?(o=r.h(t,o)).linear?this.easeTo(o,h):this.flyTo(o,h):this}jumpTo(t,o){this.stop();let h=t.preloadOnly?this.transform.clone():this.transform,g=!1,_=!1,v=!1;"zoom"in t&&h.zoom!==+t.zoom&&(g=!0,h.zoom=+t.zoom),t.center!==void 0&&(h.center=r.ci.convert(t.center)),"bearing"in t&&h.bearing!==+t.bearing&&(_=!0,h.bearing=+t.bearing),"pitch"in t&&h.pitch!==+t.pitch&&(v=!0,h.pitch=+t.pitch);let E=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!h.isPaddingEqual(E))if(t.retainPadding===!1){let T=h.clone();T.padding=E,h.setLocationAtPoint(h.center,T.centerPoint)}else h.padding=E;return t.preloadOnly?(this._preloadTiles(h),this):(this.fire(new r.A("movestart",o)).fire(new r.A("move",o)),g&&this.fire(new r.A("zoomstart",o)).fire(new r.A("zoom",o)).fire(new r.A("zoomend",o)),_&&this.fire(new r.A("rotatestart",o)).fire(new r.A("rotate",o)).fire(new r.A("rotateend",o)),v&&this.fire(new r.A("pitchstart",o)).fire(new r.A("pitch",o)).fire(new r.A("pitchend",o)),this.fire(new r.A("moveend",o)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||r.w(Hi),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,o){let h=this.transform;if(!h.projection.supportsFreeCamera)return r.w(Hi),this;this.stop();let g=h.zoom,_=h.pitch,v=h.bearing;h.setFreeCameraOptions(t);let E=g!==h.zoom,T=_!==h.pitch,C=v!==h.bearing;return this.fire(new r.A("movestart",o)).fire(new r.A("move",o)),E&&this.fire(new r.A("zoomstart",o)).fire(new r.A("zoom",o)).fire(new r.A("zoomend",o)),C&&this.fire(new r.A("rotatestart",o)).fire(new r.A("rotate",o)).fire(new r.A("rotateend",o)),T&&this.fire(new r.A("pitchstart",o)).fire(new r.A("pitch",o)).fire(new r.A("pitchend",o)),this.fire(new r.A("moveend",o)),this}easeTo(t,o){this._stop(!1,t.easeId),((t=r.h({offset:[0,0],duration:500,easing:r.eK},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);let h=this.transform,g=this.getZoom(),_=this.getBearing(),v=this.getPitch(),E=this.getPadding(),T="zoom"in t?+t.zoom:g,C="bearing"in t?this._normalizeBearing(t.bearing,_):_,A="pitch"in t?+t.pitch:v,L=this._extendPadding(t.padding),R=r.P.convert(t.offset),k,V,z;if(h.projection.name==="globe"){let se=r.ac.fromLngLat(h.center),Ee=R.rotate(-h.angle);se.x+=Ee.x/h.worldSize,se.y+=Ee.y/h.worldSize;let me=se.toLngLat(),Ne=r.ci.convert(t.center||me);this._normalizeCenter(Ne),k=h.centerPoint.add(Ee),V=new r.P(se.x,se.y).mult(h.worldSize),z=new r.P(r.aD(Ne.lng),r.aH(Ne.lat)).mult(h.worldSize).sub(V)}else{k=h.centerPoint.add(R);let se=h.pointLocation(k),Ee=r.ci.convert(t.center||se);this._normalizeCenter(Ee),V=h.project(se),z=h.project(Ee).sub(V)}let U=h.zoomScale(T-g),j,W;t.around&&(j=r.ci.convert(t.around),W=h.locationPoint(j));let Y=this._zooming||T!==g,J=this._rotating||_!==C,ie=this._pitching||A!==v,le=!h.isPaddingEqual(L),ue=t.retainPadding===!1?h.clone():h,re=se=>Ee=>{if(Y&&(se.zoom=r.ai(g,T,Ee)),J&&(se.bearing=r.ai(_,C,Ee)),ie&&(se.pitch=r.ai(v,A,Ee)),le&&(ue.interpolatePadding(E,L,Ee),k=ue.centerPoint.add(R)),j)se.setLocationAtPoint(j,W);else{let me=se.zoomScale(se.zoom-g),Ne=T>g?Math.min(2,U):Math.max(.5,U),Ce=Math.pow(Ne,1-Ee),Be=se.unproject(V.add(z.mult(Ee*Ce)).mult(me));se.setLocationAtPoint(se.renderWorldCopies?Be.wrap():Be,k)}return t.preloadOnly||this._fireMoveEvents(o),se};if(t.preloadOnly){let se=this._emulate(re,t.duration,h);return this._preloadTiles(se),this}let oe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Y,this._rotating=J,this._pitching=ie,this._padding=le,this._easeId=t.easeId,this._prepareEase(o,t.noMoveStart,oe),this._ease(re(h),se=>{h.cameraElevationReference==="sea"&&h.recenterOnTerrain(),this._afterEase(o,se)},t),this}_prepareEase(t,o,h={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),o||h.moving||this.fire(new r.A("movestart",t)),this._zooming&&!h.zooming&&this.fire(new r.A("zoomstart",t)),this._rotating&&!h.rotating&&this.fire(new r.A("rotatestart",t)),this._pitching&&!h.pitching&&this.fire(new r.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new r.A("move",t)),this._zooming&&this.fire(new r.A("zoom",t)),this._rotating&&this.fire(new r.A("rotate",t)),this._pitching&&this.fire(new r.A("pitch",t))}_afterEase(t,o){if(this._easeId&&o&&this._easeId===o)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let h=this._zooming,g=this._rotating,_=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,h&&this.fire(new r.A("zoomend",t)),g&&this.fire(new r.A("rotateend",t)),_&&this.fire(new r.A("pitchend",t)),this.fire(new r.A("moveend",t))}flyTo(t,o){if(this._prefersReducedMotion(t)){let Ie=r.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Ie,o)}this.stop(),t=r.h({offset:[0,0],speed:1.2,curve:1.42,easing:r.eK},t);let h=this.transform,g=this.getZoom(),_=this.getBearing(),v=this.getPitch(),E=this.getPadding(),T="zoom"in t?r.ay(+t.zoom,h.minZoom,h.maxZoom):g,C="bearing"in t?this._normalizeBearing(t.bearing,_):_,A="pitch"in t?+t.pitch:v,L=this._extendPadding(t.padding),R=h.zoomScale(T-g),k=r.P.convert(t.offset),V=h.centerPoint.add(k),z=h.pointLocation(V),U=r.ci.convert(t.center||z);this._normalizeCenter(U);let j=h.project(z),W=h.project(U).sub(j),Y=t.curve,J=Math.max(h.width,h.height),ie=J/R,le=W.mag();if("minZoom"in t){let Ie=r.ay(Math.min(t.minZoom,g,T),h.minZoom,h.maxZoom),He=J/h.zoomScale(Ie-g);Y=Math.sqrt(He/le*2)}let ue=Y*Y;function re(Ie){let He=(ie*ie-J*J+(Ie?-1:1)*ue*ue*le*le)/(2*(Ie?ie:J)*ue*le);return Math.log(Math.sqrt(He*He+1)-He)}function oe(Ie){return(Math.exp(Ie)-Math.exp(-Ie))/2}function se(Ie){return(Math.exp(Ie)+Math.exp(-Ie))/2}let Ee=re(0),me=function(Ie){return se(Ee)/se(Ee+Y*Ie)},Ne=function(Ie){return J*((se(Ee)*(oe(He=Ee+Y*Ie)/se(He))-oe(Ee))/ue)/le;var He},Ce=(re(1)-Ee)/Y;if(Math.abs(le)<1e-6||!isFinite(Ce)){if(Math.abs(J-ie)<1e-6)return this.easeTo(t,o);let Ie=ie<J?-1:1;Ce=Math.abs(Math.log(ie/J))/Y,Ne=function(){return 0},me=function(He){return Math.exp(Ie*Y*He)}}t.duration="duration"in t?+t.duration:1e3*Ce/("screenSpeed"in t?+t.screenSpeed/Y:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);let Be=_!==C,Qe=A!==v,Te=!h.isPaddingEqual(L),pe=t.retainPadding===!1?h.clone():h,Pe=Ie=>He=>{let $e=He*Ce,qe=1/me($e);Ie.zoom=He===1?T:g+Ie.scaleZoom(qe),Be&&(Ie.bearing=r.ai(_,C,He)),Qe&&(Ie.pitch=r.ai(v,A,He)),Te&&(pe.interpolatePadding(E,L,He),V=pe.centerPoint.add(k));let ot=He===1?U:Ie.unproject(j.add(W.mult(Ne($e))).mult(qe));return Ie.setLocationAtPoint(Ie.renderWorldCopies?ot.wrap():ot,V),Ie._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(o),Ie};if(t.preloadOnly){let Ie=this._emulate(Pe,t.duration,h);return this._preloadTiles(Ie),this}return this._zooming=!0,this._rotating=Be,this._pitching=Qe,this._padding=Te,this._prepareEase(o,!1),this._ease(Pe(h),()=>this._afterEase(o),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,o){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let h=this._onEaseEnd;this._onEaseEnd=void 0,h.call(this,o)}if(!t){let h=this.handlers;h&&h.stop(!1)}return this}_ease(t,o,h){h.animate===!1||h.duration===0?(t(1),o()):(this._easeStart=r.q.now(),this._easeOptions=h,this._onEaseFrame=t,this._onEaseEnd=o,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let t=Math.min((r.q.now()-this._easeStart)/this._easeOptions.duration,1),o=this._onEaseFrame;o&&o(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,o){t=r.bQ(t,-180,180);let h=Math.abs(t-o);return Math.abs(t-360-o)<h&&(t-=360),Math.abs(t+360-o)<h&&(t+=360),t}_normalizeCenter(t){let o=this.transform;if(o.maxBounds||o.projection.name!=="globe"&&!o.renderWorldCopies)return;let h=t.lng-o.center.lng;t.lng+=h>180?-360:h<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&r.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,o,h){let g=Math.ceil(15*o/1e3),_=[],v=t(h.clone());for(let E=0;E<=g;E++){let T=v(E/g);_.push(T.clone())}return _}_preloadTiles(t,o){}}class Ec{constructor(t={}){this.options=t,r.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){let o=this.options&&this.options.compact,h=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Fe("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",h);let g=Fe("span","mapboxgl-ctrl-icon",this._compactButton);return g.setAttribute("aria-hidden","true"),g.setAttribute("title",h),this._innerContainer=Fe("div","mapboxgl-ctrl-attrib-inner",this._container),o&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),o===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));let o=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||r.e.ACCESS_TOKEN}];if(t){let h=o.reduce((g,_,v)=>(_.value&&(g+=`${_.key}=${_.value}${v<o.length-1?"&":""}`),g),"?");t.href=`${r.e.FEEDBACK_URL}/${h}#${Uh(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){let g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}let o=this._map.style._mergedSourceCaches;for(let g in o){let _=o[g];if(_.used){let v=_.getSource();v.attribution&&t.indexOf(v.attribution)<0&&t.push(v.attribution)}}t.sort((g,_)=>g.length-_.length),t=t.filter((g,_)=>{for(let v=_+1;v<t.length;v++)if(t[v].indexOf(g)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));let h=t.join(" | ");h!==this._attribHTML&&(this._attribHTML=h,t.length?(this._innerContainer.innerHTML=h,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Ju{constructor(){r.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=Fe("div","mapboxgl-ctrl");let o=Fe("a","mapboxgl-ctrl-logo");return o.target="_blank",o.rel="noopener nofollow",o.href="https://www.mapbox.com/",o.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),o.setAttribute("rel","noopener nofollow"),this._container.appendChild(o),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(let o in t){let h=t[o].getSource();if(h.hasOwnProperty("mapbox_logo")&&!h.mapbox_logo)return!1}return!0}_updateCompact(){let t=this._container.children;if(t.length){let o=t[0];this._map.getCanvasContainer().offsetWidth<250?o.classList.add("mapboxgl-compact"):o.classList.remove("mapboxgl-compact")}}}class Sm{constructor(){r.aV(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",o=>this._onIndoorUpdate({selectedFloorId:o.selectedFloorId,floors:o.floors})),this._container}_createButton(t,o){let h=Fe("button",t,this._container);return h.type="button",h.addEventListener("click",o),h}_setButtonTitle(t,o){this._map&&(t.setAttribute("aria-label",o),t.innerHTML=`<strong>${o}</strong>`,t.firstElementChild&&t.firstElementChild.setAttribute("title",o))}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return void(this._container.style.display="none");let o=this._model;this._model=t,this._container.style.display="inline-block";let h=t.floors.sort((g,_)=>g.levelOrder-_.levelOrder);o?(Array.from(this._container.children).forEach(g=>g.remove()),this.addCurrentFloors(h)):this.addCurrentFloors(h)}addCurrentFloors(t){for(let o of t){let h=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(o.id),Array.from(this._container.children).forEach(g=>{g.classList.remove("mapboxgl-ctrl-level-button-selected")}),h.classList.add("mapboxgl-ctrl-level-button-selected")});this._setButtonTitle(h,o.shortName),this._model&&o.id===this._model.selectedFloorId&&(this._map._selectIndoorFloor(o.id),h.classList.add("mapboxgl-ctrl-level-button-selected")),this._container.append(h)}}}class Ny{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){let o=++this._id;return this._queue.push({callback:t,id:o,cancelled:!1}),o}remove(t){let o=this._currentlyRunning,h=o?this._queue.concat(o):this._queue;for(let g of h)if(g.id===t)return void(g.cancelled=!0)}run(t=0){let o=this._currentlyRunning=this._queue;this._queue=[];for(let h of o)if(!h.cancelled&&(h.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Qu{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;let o=r.dx((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-o)+this._end*o}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,o,h){this._start=this.getValue(o),this._end=t,this._startTime=o,this._endTime=o+h}}let Vb={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class zy extends r.A{constructor(t,o,h,g){let{point:_,lngLat:v,originalEvent:E,target:T}=t;super(t.type,{point:_,lngLat:v,originalEvent:E,target:T}),this.preventDefault=()=>{t.preventDefault()},this.id=o,this.interaction=h,this.feature=g}}class Dm{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,o){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);let h=o.filter,g=o.type;h&&this.filters.set(t,r.b3(h)),g==="mouseover"&&(g="mouseenter"),g==="mouseout"&&(g="mouseleave");let _=this.interactionsByType.get(g)||new Map;g==="mouseenter"||g==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,o)):_.size===0&&this.map.on(g,this.handleType),_.size===0&&this.interactionsByType.set(g,_),_.set(t,o),this.typeById.set(t,g)}get(t){let o=this.typeById.get(t);if(!o)return;let h=this.interactionsByType.get(o);return h?h.get(t):void 0}remove(t){let o=this.typeById.get(t);if(!o)return;this.typeById.delete(t),this.filters.delete(t);let h=this.interactionsByType.get(o);h&&(h.delete(t),o==="mouseenter"||o==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):h.size===0&&this.map.off(o,this.handleType))}queryTargets(t,o){let h=[];for(let[g,_]of o)_.target&&h.push({targetId:g,target:_.target,filter:this.filters.get(g)});return this.map.style.queryRenderedTargets(t,h,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let o=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());o.length&&(t.type="mouseenter",this.handleType(t,o));let h=new Map;for(let[g,{feature:_}]of this.prevHoveredFeatures)this.hoveredFeatures.has(g)||h.set(_.id,_);h.size&&(t.type="mouseleave",this.handleType(t,Array.from(h.values())))}handleOut(t){let o=Array.from(this.hoveredFeatures.values()).map(({feature:h})=>h);o.length&&(t.type="mouseleave",this.handleType(t,o)),this.hoveredFeatures.clear()}handleType(t,o){let h=t.type==="mouseenter";if(h&&!this.interactionsByType.has(t.type))return void r.w("mouseenter interaction required for mouseleave to work.");let g=Array.from(this.interactionsByType.get(t.type)).reverse(),_=!!o;o=o||this.queryTargets(t.point,g);let v=!1,E=new Set;for(let T of o){for(let[C,A]of g){if(!A.target)continue;let L=T.variants?T.variants[C]:null;if(L){for(let R of L){if(Xd(R,T,E,C))continue;let k=new r.dr(T,R),V=pu(R,T,C);_&&(k.state=this.map.getFeatureState(k));let z=h?this.prevHoveredFeatures.get(V):null,U=new zy(t,C,A,k),j=z?z.stop:A.handler(U);if(h&&this.hoveredFeatures.set(V,{feature:T,stop:j}),j!==!1){v=!0;break}}if(v)break}}if(v)break}if(!v)for(let[T,C]of g){let{handler:A,target:L}=C;if(!L&&A(new zy(t,T,C,null))!==!1)break}}}function Cm(u,t){if(Array.isArray(u)&&Array.isArray(t)){let o=new Set(u),h=new Set(t);return o.size===h.size&&u.every(g=>h.has(g))}return r.bv(u,t)}let ed={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Tc={showCompass:!0,showZoom:!0,visualizePitch:!1};class Gs{constructor(t,o,h=!1){this._clickTolerance=10,this.element=o,this.mouseRotate=new Gh({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,h&&(this.mousePitch=new bm({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),r.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),o.addEventListener("mousedown",this.mousedown),o.addEventListener("touchstart",this.touchstart,{passive:!1}),o.addEventListener("touchmove",this.touchmove),o.addEventListener("touchend",this.touchend),o.addEventListener("touchcancel",this.reset)}down(t,o){this.mouseRotate.mousedown(t,o),this.mousePitch&&this.mousePitch.mousedown(t,o),ar()}move(t,o){let h=this.map,g=this.mouseRotate.mousemoveWindow(t,o),_=g&&g.bearingDelta;if(_&&h.setBearing(h.getBearing()+_),this.mousePitch){let v=this.mousePitch.mousemoveWindow(t,o),E=v&&v.pitchDelta;E&&h.setPitch(h.getPitch()+E)}}off(){let t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){lr(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(r.h({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),xo(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,xo(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=ys(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=ys(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Jo(u,t,o){if(u=new r.ci(u.lng,u.lat),t){let h=new r.ci(u.lng-360,u.lat),g=new r.ci(u.lng+360,u.lat),_=360*Math.ceil(Math.abs(u.lng-o.center.lng)/360),v=o.locationPoint3D(u).distSqr(t),E=t.x<0||t.y<0||t.x>o.width||t.y>o.height;o.locationPoint3D(h).distSqr(t)<v&&(E||Math.abs(h.lng-o.center.lng)<_)?u=h:o.locationPoint3D(g).distSqr(t)<v&&(E||Math.abs(g.lng-o.center.lng)<_)&&(u=g)}for(;Math.abs(u.lng-o.center.lng)>180;){let h=o.locationPoint3D(u);if(h.x>=0&&h.y>=0&&h.x<=o.width&&h.y<=o.height)break;u.lng>o.center.lng?u.lng-=360:u.lng+=360}return u}let Mo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Ur={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Ro extends r.E{constructor(t,o){super(),(t instanceof HTMLElement||o)&&(t=r.h({element:t},o)),r.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);let{anchor:h="center",color:g="#3FB1CE",scale:_=1,draggable:v=!1,clickTolerance:E=0,rotation:T=Ur.rotation,rotationAlignment:C=Ur.rotationAlignment,pitchAlignment:A=Ur.pitchAlignment,occludedOpacity:L=Ur.occludedOpacity,altitude:R=Ur.altitude}=t||{};this._anchor=h,this._color=g,this._scale=_,this._draggable=v,this._clickTolerance=E,this._rotation=T,this._rotationAlignment=C,this._pitchAlignment=A,this._occludedOpacity=L,this._altitude=R,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=r.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=r.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",z=>{z.preventDefault()}),this._element.addEventListener("mousedown",z=>{z.preventDefault()});let k=this._element.classList;for(let z in Mo)k.remove(`mapboxgl-marker-anchor-${z}`);k.add(`mapboxgl-marker-anchor-${this._anchor}`);let V=t&&t.className?t.className.trim().split(/\s+/):[];k.add(...V),this._popup=null}_createDefaultMarker(){let t=Fe("div"),o=Pt("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){let h=Pt("radialGradient",{id:"shadowGradient"},Pt("defs",{},o));Pt("stop",{offset:"10%","stop-opacity":.4},h),Pt("stop",{offset:"100%","stop-opacity":.05},h),Pt("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},o)}return Pt("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},o),Pt("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},o),Pt("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},o),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){let t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=r.ci.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||Ur.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){let g=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){let o=t.code,h=t.charCode||t.keyCode;o!=="Space"&&o!=="Enter"&&h!==32&&h!==13||this.togglePopup()}_onMapClick(t){let o=t.originalEvent.target,h=this._element;this._popup&&(o===h||h.contains(o))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let t=this._map,o=this._pos;if(!t||!o)return!1;let h=t.unproject(o,this._altitude),g=t.getFreeCameraOptions();if(!g.position)return!1;let _=g.position.toLngLat();return _.distanceTo(h)<.9*_.distanceTo(this._lngLat)}_evaluateOpacity(){let t=this._map;if(!t)return;let o=this._pos;if(!o||o.x<0||o.x>t.transform.width||o.y<0||o.y>t.transform.height)return void this._clearFadeTimer();let h=t.unproject(o,this._altitude),g;t._showingGlobe()&&r.eW(t.transform,this._lngLat)?g=0:(g=1-t._queryFogOpacity(h),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(g*=this._occludedOpacity)),this._element.style.opacity=`${g}`,this._element.style.pointerEvents=g>0?"auto":"none",this._popup&&this._popup._setOpacity(g),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let t=this._pos;if(!t||!this._map)return;let o=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Mo[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${o.x}px,${o.y}px)
        `}_calculateXYTransform(){let t=this._pos,o=this._map,h=this.getPitchAlignment();if(!o||!t||h!=="map")return"";if(!o._showingGlobe()){let T=o.getPitch();return T?`rotateX(${T}deg)`:""}let g=r.cU(r.eX(o.transform,this._lngLat)),_=t.sub(r.eY(o.transform)),v=Math.abs(_.x)+Math.abs(_.y);if(v===0)return"";let E=g/v;return`rotateX(${-_.y*E}deg) rotateY(${_.x*E}deg)`}_calculateZTransform(){let t=this._pos,o=this._map;if(!o||!t)return"";let h=0,g=this.getRotationAlignment();if(g==="map")if(o._showingGlobe()){let _=o.project(new r.ci(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),v=o.project(new r.ci(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(_);h=r.cU(Math.atan2(v.y,v.x))-90}else h=-o.getBearing();else if(g==="horizon"){let _=r.af(4,6,o.getZoom()),v=r.eY(o.transform);v.y+=_*o.transform.height;let E=t.sub(v),T=r.cU(Math.atan2(E.y,E.x));h=(T>90?T-270:T+90)*(1-_)}return h+=this._rotation,h?`rotateZ(${h}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);let o=this._map;o&&(o.transform.renderWorldCopies&&(this._lngLat=Jo(this._lngLat,this._pos,o.transform)),this._pos=o.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),o._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(o._showingGlobe()||o.getTerrain()||o.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=r.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){let o=this._map;if(!o)return;let h=this._pointerdownPos,g=this._positionDelta;if(h&&g){if(!this._isDragging){let _=this._clickTolerance||o._clickTolerance;if(t.point.dist(h)<_)return;this._isDragging=!0}this._pos=t.point.sub(g),this._lngLat=o.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new r.A("dragstart"))),this.fire(new r.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new r.A("dragend")),this._state="inactive"}_addDragHandler(t){let o=this._map,h=this._pos;o&&h&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(h),this._pointerdownPos=t.point,this._state="pending",o.on("mousemove",this._onMove),o.on("touchmove",this._onMove),o.once("mouseup",this._onUp),o.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;let o=this._map;return o&&(t?(o.on("mousedown",this._addDragHandler),o.on("touchstart",this._addDragHandler)):(o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||Ur.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||Ur.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||Ur.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||Ur.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let jb={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Ub={maxWidth:100,unit:"metric"},Hb={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},$b={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},By=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function kr(u=new r.P(0,0),t="bottom"){if(typeof u=="number"){let o=Math.round(Math.sqrt(.5*Math.pow(u,2)));switch(t){case"top":return new r.P(0,u);case"top-left":return new r.P(o,o);case"top-right":return new r.P(-o,o);case"bottom":return new r.P(0,-u);case"bottom-left":return new r.P(o,-o);case"bottom-right":return new r.P(-o,-o);case"left":return new r.P(u,0);case"right":return new r.P(-u,0)}return new r.P(0,0)}return u instanceof r.P||Array.isArray(u)?r.P.convert(u):r.P.convert(u[t]||[0,0])}return{version:M,supported:bt.supported,setRTLTextPlugin:r.f0,getRTLTextPluginStatus:r.e$,Map:class extends Ts{constructor(u){G.mark(N.create);let t=u;if((u=r.h({},ed,u)).minZoom!=null&&u.maxZoom!=null&&u.minZoom>u.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(u.minPitch!=null&&u.maxPitch!=null&&u.minPitch>u.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(u.minPitch!=null&&u.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(u.maxPitch!=null&&u.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(u.antialias&&r.eU(window)&&(u.antialias=!1,r.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new wp(u.minZoom,u.maxZoom,u.minPitch,u.maxPitch,u.renderWorldCopies,null,null),u),this._repaint=!!u.repaint,this._interactive=u.interactive,this._minTileCacheSize=u.minTileCacheSize,this._maxTileCacheSize=u.maxTileCacheSize,this._failIfMajorPerformanceCaveat=u.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=u.preserveDrawingBuffer,this._antialias=u.antialias,this._trackResize=u.trackResize,this._bearingSnap=u.bearingSnap,this._refreshExpiredTiles=u.refreshExpiredTiles,this._fadeDuration=u.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=u.crossSourceCollisions,this._collectResourceTiming=u.collectResourceTiming,this._language=this._parseLanguage(u.language),this._worldview=u.worldview,this._renderTaskQueue=new Ny,this._domRenderTaskQueue=new Ny,this._controls=[],this._markers=[],this._popups=[],this._mapId=r.a$(),this._locale=r.h({},Vb,u.locale),this._clickTolerance=u.clickTolerance,this._cooperativeGestures=u.cooperativeGestures,this._performanceMetricsCollection=u.performanceMetricsCollection,this._tessellationStep=u.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=u.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Qu(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=u.scaleFactor,this._requestManager=new Wi(u.transformRequest,u.accessToken,u.testMode),this._silenceAuthErrors=!!u.testMode,this._contextCreateOptions=u.contextCreateOptions?Object.assign({},u.contextCreateOptions):{},typeof u.container=="string"){let o=document.getElementById(u.container);if(!o)throw new Error(`Container '${u.container.toString()}' not found.`);this._container=o}else{if(!(u.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=u.container}if(this._container.childNodes.length>0&&r.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),u.maxBounds&&this.setMaxBounds(u.maxBounds),this._spriteFormat=u.spriteFormat,r.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Lb),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Xh(this,u),this._localFontFamily=u.localFontFamily,this._localIdeographFontFamily=u.localIdeographFontFamily,(u.style||!u.testMode)&&this.setStyle(u.style||r.e.DEFAULT_STYLE,{config:u.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),u.projection&&this.setProjection(u.projection),this.indoor=new gb(this),u.hash&&(this._hash=new jh(typeof u.hash=="string"&&u.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:u.center,zoom:u.zoom,bearing:u.bearing,pitch:u.pitch});let o=u.bounds;o&&(this.resize(),this.fitBounds(o,r.h({},u.fitBoundsOptions,{duration:0})))}this.resize(),u.attributionControl&&this.addControl(new Ec({customAttribution:u.customAttribution})),this._logoControl=new Ju,this.addControl(this._logoControl,u.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new r.A(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new r.A(`${o.dataType}dataloading`,o))}),this._interactions=new Dm(this)}_getMapId(){return this._mapId}addControl(u,t){if(t===void 0&&(t=u.getDefaultPosition?u.getDefaultPosition():"top-right"),!u||!u.onAdd)return this.fire(new r.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let o=u.onAdd(this);this._controls.push(u);let h=this._controlPositions[t];return t.indexOf("bottom")!==-1?h.insertBefore(o,h.firstChild):h.appendChild(o),this}removeControl(u){if(!u||!u.onRemove)return this.fire(new r.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let t=this._controls.indexOf(u);return t>-1&&this._controls.splice(t,1),u.onRemove(this),this}hasControl(u){return this._controls.indexOf(u)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(u){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let t=!this._moving;return t&&this.fire(new r.A("movestart",u)).fire(new r.A("move",u)),this.fire(new r.A("resize",u)),t&&this.fire(new r.A("moveend",u)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(u){return this.transform.setMaxBounds(r.aG.convert(u)),this._update()}setMinZoom(u){if((u=u??-2)>=-2&&u<=this.transform.maxZoom)return this.transform.minZoom=u,this._update(),this.getZoom()<u?this.setZoom(u):this.fire(new r.A("zoomstart")).fire(new r.A("zoom")).fire(new r.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(u){if((u=u??22)>=this.transform.minZoom)return this.transform.maxZoom=u,this._update(),this.getZoom()>u?this.setZoom(u):this.fire(new r.A("zoomstart")).fire(new r.A("zoom")).fire(new r.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(u){if((u=u??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(u>=0&&u<=this.transform.maxPitch)return this.transform.minPitch=u,this._update(),this.getPitch()<u?this.setPitch(u):this.fire(new r.A("pitchstart")).fire(new r.A("pitch")).fire(new r.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(u){if((u=u??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(u>=this.transform.minPitch)return this.transform.maxPitch=u,this._update(),this.getPitch()>u?this.setPitch(u):this.fire(new r.A("pitchstart")).fire(new r.A("pitch")).fire(new r.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(u){return this._scaleFactor=u,this.painter.scaleFactor=u,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(u){return this.transform.renderWorldCopies=u,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(u){return u==="auto"?navigator.language:Array.isArray(u)?u.length===0?void 0:u.map(t=>t==="auto"?navigator.language:t):u}setLanguage(u){let t=this._parseLanguage(u);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(let o of this._controls)o._setLanguage&&o._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(u){return this.style&&u!==this._worldview?(this._worldview=u,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(u){return this._lazyInitEmptyStyle(),u?typeof u=="string"&&(u={name:u}):u=null,this._useExplicitProjection=!!u,this._prioritizeAndUpdateProjection(u,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let u=this.transform,t=u.projection.name,o;t==="globe"&&u.zoom>=r.cI?(u.setMercatorFromTransition(),o=!0):t==="mercator"&&u.zoom<r.cI&&(u.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(u,t){return this._updateProjection(u||t||{name:"mercator"})}_updateProjection(u){let t;return t=u.name==="globe"&&this.transform.zoom>=r.cI?this.transform.setMercatorFromTransition():this.transform.setProjection(u),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(u,t){return this.transform.locationPoint3D(r.ci.convert(u),t)}unproject(u,t){return this.transform.pointLocation3D(r.P.convert(u),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(u,t,o){let h=g=>{let _=[];if(Array.isArray(t)){let v=t.filter(E=>this.getLayer(E));_=v.length?this.queryRenderedFeatures(g,{layers:v}):[]}else _=this.queryRenderedFeatures(g,{target:t});return _};if(u==="mouseenter"||u==="mouseover"){let g=!1;return{listener:o,targets:t,delegates:{mousemove:v=>{let E=h(v.point);E.length?g||(g=!0,o.call(this,new di(u,this,v.originalEvent,{features:E}))):g=!1},mouseout:()=>{g=!1}}}}if(u==="mouseleave"||u==="mouseout"){let g=!1;return{listener:o,targets:t,delegates:{mousemove:E=>{h(E.point).length?g=!0:g&&(g=!1,o.call(this,new di(u,this,E.originalEvent)))},mouseout:E=>{g&&(g=!1,o.call(this,new di(u,this,E.originalEvent)))}}}}{let g=_=>{let v=h(_.point);v.length&&(_.features=v,o.call(this,_),delete _.features)};return{listener:o,targets:t,delegates:{[u]:g}}}}on(u,t,o){if(typeof t=="function"||o===void 0)return super.on(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(u,t,o);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[u]=this._delegatedListeners[u]||[],this._delegatedListeners[u].push(h);for(let g in h.delegates)this.on(g,h.delegates[g]);return this}once(u,t,o){if(typeof t=="function"||o===void 0)return super.once(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(u,t,o);for(let g in h.delegates)this.once(g,h.delegates[g]);return this}off(u,t,o){if(typeof t=="function"||o===void 0)return super.off(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._delegatedListeners?this._delegatedListeners[u]:void 0;return h&&(g=>{for(let _=0;_<g.length;_++){let v=g[_];if(v.listener===o&&Cm(v.targets,t)){for(let E in v.delegates)this.off(E,v.delegates[E]);return g.splice(_,1),this}}})(h),this}queryRenderedFeatures(u,t){if(!this.style)return[];if(u===void 0||u instanceof r.P||Array.isArray(u)||t!==void 0||(t=u,u=void 0),u=u||[[0,0],[this.transform.width,this.transform.height]],!t){let _=this.style.queryRenderedFeatures(u,void 0,this.transform),v=this.style.queryRenderedFeatureset(u,void 0,this.transform);return _.concat(v)}let o=!0;if(t.target&&(o=this._isTargetValid(t.target),o&&!t.layers))return this.style.queryRenderedFeatureset(u,t,this.transform);let h=!0;if(t.layers&&Array.isArray(t.layers)){for(let _ of t.layers)if(!this._isValidId(_)){h=!1;break}if(h&&!t.target)return this.style.queryRenderedFeatures(u,t,this.transform)}let g=[];return h&&(g=g.concat(this.style.queryRenderedFeatures(u,t,this.transform))),o&&(g=g.concat(this.style.queryRenderedFeatureset(u,t,this.transform))),g}querySourceFeatures(u,t){return!u||typeof u=="string"&&!this._isValidId(u)?[]:this.style.querySourceFeatures(u,t)}isPointOnSurface(u){let{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&r.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(r.P.convert(u))}addInteraction(u,t){return this._interactions.add(u,t),this}removeInteraction(u){return this._interactions.remove(u),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(u){return this._cooperativeGestures=u,this}setStyle(u,t){return t=r.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&u&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(u,(o,h)=>{if(o){let g=typeof o=="string"?o:o instanceof Error?o.message:o.error;r.w(`Unable to perform style diff: ${g}. Rebuilding the style from scratch.`),this._updateStyle(u,t)}else h&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(u,t))}_getUIString(u){let t=this._locale[u];if(t==null)throw new Error(`Missing UI string '${u}'`);return t}_updateStyle(u,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),u){let o=r.h({},t);t&&t.config&&(o.initialConfig=t.config,delete o.config),this.style=new Xo(this,o).load(u),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Xo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(r.w("There is no style added to the map."),!1)}_isValidId(u){return u==null?(this.fire(new r.z(new Error("IDs can't be empty."))),!1):!r.dk(u)||(this.fire(new r.z(new Error(`IDs can't contain special symbols: "${u}".`))),!1)}_isTargetValid(u){return"featuresetId"in u?this._isValidId("importId"in u?u.importId:u.featuresetId):"layerId"in u&&this._isValidId(u.layerId)}_areTargetsValid(u){if(Array.isArray(u)){for(let t of u)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(u)}addSource(u,t){return this._isValidId(u)?(this._lazyInitEmptyStyle(),this.style.addSource(u,t),this._update(!0)):this}isSourceLoaded(u){return!!this._isValidId(u)&&!!this.style&&this.style._isSourceCacheLoaded(u)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(u,t,o){this._lazyInitEmptyStyle(),this.style.addSourceType(u,t,o)}removeSource(u){return this._isValidId(u)?(this.style.removeSource(u),this._updateTerrain(),this._update(!0)):this}getSource(u){return this._isValidId(u)?this.style.getOwnSource(u):null}addImage(u,t,{pixelRatio:o=1,sdf:h=!1,stretchX:g,stretchY:_,content:v}={}){this._lazyInitEmptyStyle();let E=r.I.from(u);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){let{width:T,height:C,data:A}=r.q.getImageData(t);this.style.addImage(E,{data:new r.r({width:T,height:C},A),pixelRatio:o,stretchX:g,stretchY:_,content:v,sdf:h,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new r.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:T,height:C}=t,A=t;this.style.addImage(E,{data:new r.r({width:T,height:C},new Uint8Array(A.data)),pixelRatio:o,stretchX:g,stretchY:_,content:v,sdf:h,usvg:!1,version:0,userImage:A}),A.onAdd&&A.onAdd(this,u)}}updateImage(u,t){this._lazyInitEmptyStyle();let o=r.I.from(u),h=this.style.getImage(o);if(!h)return void this.fire(new r.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let g=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?r.q.getImageData(t):t,{width:_,height:v,data:E}=g;if(_===void 0||v===void 0)return void this.fire(new r.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(_!==(h.usvg?h.icon.usvg_tree.width:h.data.width)||v!==(h.usvg?h.icon.usvg_tree.height:h.data.height))return void this.fire(new r.z(new Error(`The width and height of the updated image (${_}, ${v})
                must be that same as the previous version of the image
                (${h.data.width}, ${h.data.height})`)));let T=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap),C=!1;h.usvg?(h.data=new r.r({width:_,height:v},new Uint8Array(E)),h.usvg=!1,h.icon=void 0,C=!0):h.data.replace(E,T),this.style.updateImage(o,h,C)}hasImage(u){return u?!!this.style&&!!this.style.getImage(r.I.from(u)):(this.fire(new r.z(new Error("Missing required image id"))),!1)}removeImage(u){this.style.removeImage(r.I.from(u))}loadImage(u,t){r.o(this._requestManager.transformRequest(u,r.R.Image),(o,h)=>{t(o,h instanceof HTMLImageElement?r.q.getImageData(h):h)})}listImages(){return this.style.listImages().map(u=>u.name)}addModel(u,t){this._lazyInitEmptyStyle(),this.style.addModel(u,t)}hasModel(u){return u?this.style.hasModel(u):(this.fire(new r.z(new Error("Missing required model id"))),!1)}removeModel(u){this.style.removeModel(u)}listModels(){return this.style.listModels()}addLayer(u,t){return this._isValidId(u.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(u,t),this._update(!0)):this}getSlot(u){let t=this.getLayer(u);return t&&t.slot||null}setSlot(u,t){return this.style.setSlot(u,t),this.style.mergeLayers(),this._update(!0)}addImport(u,t){return this.style.addImport(u,t).catch(o=>this.fire(new r.z(new Error("Failed to add import",o)))),this}updateImport(u,t){return typeof t!="string"&&t.id!==u?(this.removeImport(u),this.addImport(t)):(this.style.updateImport(u,t),this._update(!0))}removeImport(u){return this.style.removeImport(u),this}moveImport(u,t){return this.style.moveImport(u,t),this._update(!0)}moveLayer(u,t){return this._isValidId(u)?(this.style.moveLayer(u,t),this._update(!0)):this}removeLayer(u){return this._isValidId(u)?(this.style.removeLayer(u),this._update(!0)):this}getLayer(u){if(!this._isValidId(u))return null;let t=this.style.getOwnLayer(u);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(u,t,o){return this._isValidId(u)?(this.style.setLayerZoomRange(u,t,o),this._update(!0)):this}setFilter(u,t,o={}){return this._isValidId(u)?(this.style.setFilter(u,t,o),this._update(!0)):this}getFilter(u){return this._isValidId(u)?this.style.getFilter(u):null}setPaintProperty(u,t,o,h={}){return this._isValidId(u)?(this.style.setPaintProperty(u,t,o,h),this._update(!0)):this}getPaintProperty(u,t){return this._isValidId(u)?this.style.getPaintProperty(u,t):null}setLayoutProperty(u,t,o,h={}){return this._isValidId(u)?(this.style.setLayoutProperty(u,t,o,h),this._update(!0)):this}getLayoutProperty(u,t){return this._isValidId(u)?this.style.getLayoutProperty(u,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(u){return this.style.setGlyphsUrl(u),this._update(!0)}getSchema(u){return this.style.getSchema(u)}setSchema(u,t){return this.style.setSchema(u,t),this._update(!0)}getConfig(u){return this.style.getConfig(u)}setConfig(u,t){return this.style.setConfig(u,t),this._update(!0)}getConfigProperty(u,t){return this.style.getConfigProperty(u,t)}setConfigProperty(u,t,o){return this.style.setConfigProperty(u,t,o),this._update(!0)}getFeaturesetDescriptors(u){return this.style.getFeaturesetDescriptors(u)}setLights(u){if(this._lazyInitEmptyStyle(),u&&u.length===1&&u[0].type==="flat"){let t=u[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(u),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let u=this.style.getLights()||[];return u.length===0&&u.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),u}setLight(u,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:u}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(u){return this._lazyInitEmptyStyle(),!u&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(u),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(u){return this._lazyInitEmptyStyle(),this.style.setFog(u),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(u){return this._lazyInitEmptyStyle(),this.style.setSnow(u),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(u){return this._lazyInitEmptyStyle(),this.style.setRain(u),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(u){return this._lazyInitEmptyStyle(),this.style.setColorTheme(u),this._update(!0)}setImportColorTheme(u,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(u,t),this._update(!0)}setCamera(u){return this.style.setCamera(u),this._triggerCameraUpdate(u)}_triggerCameraUpdate(u){return this._update(this.transform.setOrthographicProjectionAtLowPitch(u["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(u){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(r.ci.convert(u),this.transform):0}setFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.setFeatureState(u,t),this._update())}removeFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.removeFeatureState(u,t),this._update())}getFeatureState(u){return u.source&&!this._isValidId(u.source)?null:this.style.getFeatureState(u)}_selectIndoorFloor(u){this.indoor.selectFloor(u)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Sm),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;let u=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300,o,h,g,_=this._container;for(;_&&(!h||!g);){let v=window.getComputedStyle(_).transform;v&&v!=="none"&&(o=v.match(/matrix.*\((.+)\)/)[1].split(", "),o[0]&&o[0]!=="0"&&o[0]!=="1"&&(h=o[0]),o[3]&&o[3]!=="0"&&o[3]!=="1"&&(g=o[3])),_=_.parentElement}this._containerWidth=h?Math.abs(u/h):u,this._containerHeight=g?Math.abs(t/g):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&r.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let u=this._container;u.classList.add("mapboxgl-map"),(this._missingCSSCanary=Fe("div","mapboxgl-canary",u)).style.visibility="hidden",this._detectMissingCSS();let t=this._canvasContainer=Fe("div","mapboxgl-canvas-container",u);this._canvas=Fe("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let o=this._controlContainer=Fe("div","mapboxgl-control-container",u),h=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(g=>{h[g]=Fe("div",`mapboxgl-ctrl-${g}`,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(u,t){let o=r.q.devicePixelRatio||1;this._canvas.width=o*Math.ceil(u),this._canvas.height=o*Math.ceil(t),this._canvas.style.width=`${u}px`,this._canvas.style.height=`${t}px`}_addMarker(u){this._markers.push(u)}_removeMarker(u){let t=this._markers.indexOf(u);t!==-1&&this._markers.splice(t,1)}_addPopup(u){this._popups.push(u)}_removePopup(u){let t=this._popups.indexOf(u);t!==-1&&this._popups.splice(t,1)}_setupPainter(){let u=r.h({},bt.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",u);t?(ca(t,!0),this.painter=new Ma(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",o=>{o.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),r.l.testSupport(t)):this.fire(new r.z(new Error("Failed to initialize WebGL")))}_contextLost(u){u.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new r.A("webglcontextlost",{originalEvent:u}))}_contextRestored(u){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new r.A("webglcontextrestored",{originalEvent:u}))}_onMapScroll(u){if(u.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(u){return this.style?(this._styleDirty=this._styleDirty||u,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(u){return this._update(),this._renderTaskQueue.add(u)}_cancelRenderFrame(u){this._renderTaskQueue.remove(u)}_requestDomTask(u){!this.loaded()||this.loaded()&&!this.isMoving()?u():this._domRenderTaskQueue.add(u)}_render(u){let t;this.fire(new r.A("renderstart")),++this._frameId;let o=this.painter.context.extTimerQuery,h=r.q.now(),g=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=g.createQuery(),g.beginQuery(o.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(u),this._domRenderTaskQueue.run(u),this._removed)return;this._updateProjectionTransition();let _=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let C=this.transform.zoom,A=this.transform.pitch,L=r.q.now(),R=new r.aa(C,{now:L,fadeDuration:_,pitch:A,transition:this.style.transition,worldview:this._worldview});this.style.update(R)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let v=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),v=this._updateAverageElevation(h),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):v=this._updateAverageElevation(h);let E=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,_,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),E&&(this._placementDirty=E.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:_,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new r.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,G.mark(N.load),this.fire(new r.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){let C=r.q.now()-h;g.endQuery(o.TIME_ELAPSED_EXT),setTimeout(()=>{let A=g.getQueryParameter(t,g.QUERY_RESULT)/1e6;g.deleteQuery(t),this.fire(new r.A("gpu-timing-frame",{cpuTime:C,gpuTime:A}))},50)}if(this.listens("gpu-timing-layer")){let C=this.painter.collectGpuTimers();setTimeout(()=>{let A=this.painter.queryGpuTimers(C);this.fire(new r.A("gpu-timing-layer",{layerTimes:A}))},50)}if(this.listens("gpu-timing-deferred-render")){let C=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let A=this.painter.queryGpuTimeDeferredRender(C);this.fire(new r.A("gpu-timing-deferred-render",{gpuTime:A}))},50)}let T=this._sourcesDirty||this._styleDirty||this._placementDirty||v;if(T||this._repaint)this.triggerRepaint();else{let C=this.idle();if(C&&(v=this._updateAverageElevation(h,!0)),v)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new r.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let A=this._calculateSpeedIndex();this.fire(new r.A("speedindexcompleted",{speedIndex:A})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||T||(this._fullyLoaded=!0,G.mark(N.fullLoad),this._performanceMetricsCollection&&Zi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(u){for(let t of this._markers)u&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(let t of this._popups)!u||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(u,t=!1){let o=g=>(this.transform.averageElevation=g,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&o(0);let h=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(h||(t||u-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(u)){let g=this.transform.averageElevation,_=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(_)?_=0:this._averageElevationLastSampledAt=u;let v=Math.abs(g-_);if(v>1){if(this._isInitialLoad||h)return this._averageElevation.jumpTo(_),o(_);this._averageElevation.easeTo(_,u,300)}else if(v>1e-4)return this._averageElevation.jumpTo(_),o(_)}return!!this._averageElevation.isEasing(u)&&o(this._averageElevation.getValue(u))}_authenticate(){Ni(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,u=>{if(u&&(u.message===Er||u.status===401)){let t=this.painter.context.gl;ca(t,!1),this._logoControl instanceof Ju&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new r.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),Wd(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&ci(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let u=this._isDragging();this.painter.updateTerrain(this.style,u)}_calculateSpeedIndex(){let u=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());let o=this.painter.context.gl,h=o.createFramebuffer();function g(_){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,_,0);let v=new Uint8Array(o.drawingBufferWidth*o.drawingBufferHeight*4);return o.readPixels(0,0,o.drawingBufferWidth,o.drawingBufferHeight,o.RGBA,o.UNSIGNED_BYTE,v),v}return o.bindFramebuffer(o.FRAMEBUFFER,h),this._canvasPixelComparison(g(u),t.canvasCopies.map(g),t.timeStamps)}_canvasPixelComparison(u,t,o){let h=o[1]-o[0],g=u.length/4;for(let _=0;_<t.length;_++){let v=t[_],E=0;for(let T=0;T<v.length;T+=4)v[T]===u[T]&&v[T+1]===u[T+1]&&v[T+2]===u[T+2]&&v[T+3]===u[T+3]&&(E+=1);h+=(o[_+2]-o[_+1])*(1-E/g)}return h}remove(){this._hash&&this._hash.remove();for(let t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let u=this.painter.context.gl.getExtension("WEBGL_lose_context");u&&u.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),la.delete(this.painter.context.gl),Yr.remove(),Bl.remove(),this._removed=!0,this.fire(new r.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(u){this._renderNextFrame=this._renderNextFrame||u,this.style&&!this._frame&&(this._frame=r.q.frame(t=>{let o=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,o&&this._render(t)}))}_preloadTiles(u){let t=this.style?this.style.getSourceCaches():[];return r.bt(t,(o,h)=>o._preloadTiles(u,h),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(u){this._trackResize&&this.resize({originalEvent:u})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(u){this._showTileBoundaries!==u&&(this._showTileBoundaries=u,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(u){this._showParseStatus!==u&&(this._showParseStatus=u,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(u){this._showTerrainWireframe!==u&&(this._showTerrainWireframe=u,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(u){this._showLayers2DWireframe!==u&&(this._showLayers2DWireframe=u,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(u){this._showLayers3DWireframe!==u&&(this._showLayers3DWireframe=u,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(u){this._speedIndexTiming!==u&&(this._speedIndexTiming=u,this._update())}get showPadding(){return!!this._showPadding}set showPadding(u){this._showPadding!==u&&(this._showPadding=u,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(u){this._showCollisionBoxes!==u&&(this._showCollisionBoxes=u,this._tp.refreshUI(),u?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(u){this._showOverdrawInspector!==u&&(this._showOverdrawInspector=u,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(u){this._repaint!==u&&(this._repaint=u,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(u){this._vertices=u,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(u){this._showTileAABBs!==u&&(this._showTileAABBs=u,this._tp.refreshUI(),u&&this._update())}_setCacheLimits(u,t){r.eV(u,t)}get version(){return M}},NavigationControl:class{constructor(u={}){this.options=r.h({},Tc,u),this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(r.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),Fe("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),Fe("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(r.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{let o=this._map;o&&(this.options.visualizePitch?o.resetNorthPitch({},{originalEvent:t}):o.resetNorth({},{originalEvent:t}))}),this._compassIcon=Fe("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let u=this._map;if(!u)return;let t=u.getZoom(),o=t===u.getMaxZoom(),h=t===u.getMinZoom();this._zoomInButton.disabled=o,this._zoomOutButton.disabled=h,this._zoomInButton.setAttribute("aria-disabled",o.toString()),this._zoomOutButton.setAttribute("aria-disabled",h.toString())}_rotateCompassArrow(){let u=this._map;if(!u)return;let t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(u.transform.pitch*(Math.PI/180)),.5)}) rotateX(${u.transform.pitch}deg) rotateZ(${u.transform.angle*(180/Math.PI)}deg)`:`rotate(${u.transform.angle*(180/Math.PI)}deg)`;u._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(u){return this._map=u,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),u.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&u.on("pitch",this._rotateCompassArrow),u.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Gs(u,this._compass,this.options.visualizePitch)),this._container}onRemove(){let u=this._map;u&&(this._container.remove(),this.options.showZoom&&u.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&u.off("pitch",this._rotateCompassArrow),u.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(u,t){let o=Fe("button",u,this._container);return o.type="button",o.addEventListener("click",t),o}_setButtonTitle(u,t){if(!this._map)return;let o=this._map._getUIString(`NavigationControl.${t}`);u.setAttribute("aria-label",o),u.firstElementChild&&u.firstElementChild.setAttribute("title",o)}},GeolocateControl:class extends r.E{constructor(u={}){super();let t=navigator.geolocation;this.options=r.h({geolocation:t},jb,u),r.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=_c(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(u){return this._map=u,this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(u){let t=(o=!!this.options.geolocation)=>{this._supportsGeolocation=o,u(o)};this._supportsGeolocation!==void 0?u(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(o=>t(o.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(u){let t=this._map.getMaxBounds(),o=u.coords;return!!t&&(o.longitude<t.getWest()||o.longitude>t.getEast()||o.latitude<t.getSouth()||o.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(u){if(this._map){if(this._isOutOfMapMaxBounds(u))return this._setErrorState(),this.fire(new r.A("outofmaxbounds",u)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=u,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(u),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(u),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.A("geolocate",u)),this._finish()}}_updateCamera(u){let t=new r.ci(u.coords.longitude,u.coords.latitude),o=u.coords.accuracy,h=this._map.getBearing(),g=r.h({bearing:h},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(o),g,{geolocateSource:!0})}_updateMarker(u){if(u){let t=new r.ci(u.coords.longitude,u.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=u.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let u=this._map.transform,t=r.cb(1,u._center.lat)*u.worldSize,o=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(u){if(this._map){if(this.options.trackUserLocation)if(u.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(u.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.A("error",u)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(u){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=Fe("button","mapboxgl-ctrl-geolocate",this._container),Fe("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",u===!1){r.w("Geolocation support is not available so the GeolocateControl will be disabled.");let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{let t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Fe("div","mapboxgl-user-location"),this._dotElement.appendChild(Fe("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Fe("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Ro({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Fe("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ro({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new r.A("trackuserlocationend")))})}}_onDeviceOrientation(u){this._userLocationDotMarker&&(u.webkitCompassHeading?this._heading=u.webkitCompassHeading:u.absolute===!0&&(this._heading=-1*u.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return r.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new r.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new r.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new r.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let u;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(u={maximumAge:6e5,timeout:0},this._noTimeout=!0):(u=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,u),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let u=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&u()}).catch(console.error):u()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Ec,ScaleControl:class{constructor(u={}){this.options=r.h({},Ub,u),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),r.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let u=this.options.maxWidth||100,t=this._map,o=t._containerHeight/2,h=t._containerWidth/2-u/2,g=t.unproject([h,o]),_=t.unproject([h+u,o]),v=g.distanceTo(_);if(this.options.unit==="imperial"){let E=3.2808*v;E>5280?this._setScale(u,E/5280,"mile"):this._setScale(u,E,"foot")}else this.options.unit==="nautical"?this._setScale(u,v/1852,"nautical-mile"):v>=1e3?this._setScale(u,v/1e3,"kilometer"):this._setScale(u,v,"meter")}_setScale(u,t,o){this._map._requestDomTask(()=>{let h=function(_){let v=Math.pow(10,`${Math.floor(_)}`.length-1),E=_/v;return E=E>=10?10:E>=5?5:E>=3?3:E>=2?2:E>=1?1:function(T){let C=Math.pow(10,Math.ceil(-Math.log(T)/Math.LN10));return Math.round(T*C)/C}(E),v*E}(t),g=h/t;this._container.innerHTML=this._isNumberFormatSupported&&o!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:o}).format(h):`${h}&nbsp;${Hb[o]}`,this._container.style.width=u*g+"px"})}onAdd(u){return this._map=u,this._language=u.getLanguage(),this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-scale",u.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(u){this._language=u,this._update()}setUnit(u){this.options.unit=u,this._update()}},FullscreenControl:class{constructor(u={}){this._fullscreen=!1,u&&u.container&&(u.container instanceof HTMLElement?this._container=u.container:r.w("Full screen control 'container' must be a DOM element.")),r.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(u){return this._map=u,this._container||(this._container=this._map.getContainer()),this._controlContainer=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",r.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let u=this._fullscreenButton=Fe("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Fe("span","mapboxgl-ctrl-icon",u).setAttribute("aria-hidden","true"),u.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let u=this._getTitle();this._fullscreenButton.setAttribute("aria-label",u),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",u)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Sm,Popup:class extends r.E{constructor(u){super(),this.options=r.h(Object.create($b),u),this._altitude=this.options.altitude,r.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(u&&u.className?u.className.trim().split(/\s+/):[])}addTo(u){return this._map&&this.remove(),this._map=u,this.options.closeOnClick&&u.on("preclick",this._onClose),this.options.closeOnMove&&u.on("move",this._onClose),u.on("remove",this.remove),this._update(),u._addPopup(this),this._focusFirstElement(),this._trackPointer?(u.on("mousemove",this._onMouseEvent),u.on("mouseup",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")):u.on("move",this._update),this.fire(new r.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let u=this._map;return u&&(u.off("move",this._update),u.off("move",this._onClose),u.off("preclick",this._onClose),u.off("click",this._onClose),u.off("remove",this.remove),u.off("mousemove",this._onMouseEvent),u.off("mouseup",this._onMouseEvent),u.off("drag",this._onMouseEvent),u._canvasContainer&&u._canvasContainer.classList.remove("mapboxgl-track-pointer"),u._removePopup(this),this._map=void 0),this.fire(new r.A("close")),this}getLngLat(){return this._lngLat}setLngLat(u){this._lngLat=r.ci.convert(u),this._pos=null,this._trackPointer=!1,this._update();let t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(u){return this._altitude=u,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let u=this._map;return u&&(u.off("move",this._update),u.on("mousemove",this._onMouseEvent),u.on("drag",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(u){return this.setDOMContent(document.createTextNode(u))}setHTML(u){let t=document.createDocumentFragment(),o=document.createElement("body"),h;for(o.innerHTML=u;h=o.firstChild,h;)t.appendChild(h);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(u){return this.options.maxWidth=u,this._update(),this}setDOMContent(u){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=Fe("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(u),this.options.closeButton){let o=this._closeButton=Fe("button","mapboxgl-popup-close-button",t);o.type="button",o.setAttribute("aria-label","Close popup"),o.innerHTML='<span aria-hidden="true">&#215;</span>',o.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(u){return this._classList.add(u),this._updateClassList(),this}removeClassName(u){return this._classList.delete(u),this._updateClassList(),this}setOffset(u){return this.options.offset=u,this._update(),this}toggleClassName(u){let t;return this._classList.delete(u)?t=!1:(this._classList.add(u),t=!0),this._updateClassList(),t}_onMouseEvent(u){this._update(u.point)}_getAnchor(u){if(this.options.anchor)return this.options.anchor;let t=this._map,o=this._container,h=this._pos;if(!t||!o||!h)return"bottom";let g=o.offsetWidth,_=o.offsetHeight,v=h.x<g/2,E=h.x>t.transform.width-g/2;if(h.y+u<_)return v?"top-left":E?"top-right":"top";if(h.y>t.transform.height-_){if(v)return"bottom-left";if(E)return"bottom-right"}return v?"left":E?"right":"bottom"}_updateClassList(){let u=this._container;if(!u)return;let t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),u.className=t.join(" ")}_update(u){let t=this._map,o=this._content;if(!t||!this._lngLat&&!this._trackPointer||!o)return;let h=this._container;if(h||(h=this._container=Fe("div","mapboxgl-popup",t.getContainer()),this._tip=Fe("div","mapboxgl-popup-tip",h),h.appendChild(o)),this.options.maxWidth&&h.style.maxWidth!==this.options.maxWidth&&(h.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Jo(this._lngLat,this._pos,t.transform)),!this._trackPointer||u){let g=this._pos=this._trackPointer&&u instanceof r.P?u:t.project(this._lngLat,this._altitude),_=kr(this.options.offset),v=this._anchor=this._getAnchor(_.y),E=kr(this.options.offset,v),T=g.add(E).round();t._requestDomTask(()=>{this._container&&v&&(this._container.style.transform=`${Mo[v]} translate(${T.x}px,${T.y}px)`)})}if(!this._marker&&t._showingGlobe()){let g=r.eW(t.transform,this._lngLat)?0:1;this._setOpacity(g)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let u=this._container.querySelector(By);u&&u.focus()}_onClose(){this.remove()}_setOpacity(u){this._container&&(this._container.style.opacity=`${u}`),this._content&&(this._content.style.pointerEvents=u?"auto":"none")}},Marker:Ro,Style:Xo,LngLat:r.ci,LngLatBounds:r.aG,Point:r.P,MercatorCoordinate:r.ac,FreeCameraOptions:U_,Evented:r.E,config:r.e,prewarm:r.e_,clearPrewarmedResources:r.eZ,get accessToken(){return r.e.ACCESS_TOKEN},set accessToken(u){r.e.ACCESS_TOKEN=u},get baseApiUrl(){return r.e.API_URL},set baseApiUrl(u){r.e.API_URL=u},get workerCount(){return r.f7.workerCount},set workerCount(u){r.f7.workerCount=u},get maxParallelImageRequests(){return r.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(u){r.e.MAX_PARALLEL_IMAGE_REQUESTS=u},clearStorage(u){r.f6(u)},get workerUrl(){return r.f5.workerUrl},set workerUrl(u){r.f5.workerUrl=u},get workerClass(){return r.f5.workerClass},set workerClass(u){r.f5.workerClass=u},get workerParams(){return r.f5.workerParams},set workerParams(u){r.f5.workerParams=u},get dracoUrl(){return r.f4()},set dracoUrl(u){r.f3(u)},get meshoptUrl(){return r.f2()},set meshoptUrl(u){r.f1(u)},setNow:r.q.setNow,restoreNow:r.q.restoreNow}});var b=l;return b})});var l1;function zv(){return l1}function za(a){let d=l1;return l1=a,d}var YA=Symbol("NotFound");function pf(a){return a===YA||a?.name==="\u0275NotFound"}function KA(a,d){return Object.is(a,d)}var _o=null,Bv=!1,u1=1,Mz=null,wl=Symbol("SIGNAL");function Ci(a){let d=_o;return _o=a,d}function Vv(){return _o}var jv={version:0,lastCleanEpoch:0,dirty:!1,producers:void 0,producersTail:void 0,consumers:void 0,consumersTail:void 0,recomputing:!1,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,kind:"unknown",producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function Uv(a){if(Bv)throw new Error("");if(_o===null)return;_o.consumerOnSignalRead(a);let d=_o.producersTail;if(d!==void 0&&d.producer===a)return;let l,m=_o.recomputing;if(m&&(l=d!==void 0?d.nextProducer:_o.producers,l!==void 0&&l.producer===a)){_o.producersTail=l,l.lastReadVersion=a.version;return}let b=a.consumersTail;if(b!==void 0&&b.consumer===_o&&(!m||Pz(b,_o)))return;let r=mf(_o),M={producer:a,consumer:_o,nextProducer:l,prevConsumer:b,lastReadVersion:a.version,nextConsumer:void 0};_o.producersTail=M,d!==void 0?d.nextProducer=M:_o.producers=M,r&&eM(a,M)}function JA(){u1++}function QA(a){if(!(mf(a)&&!a.dirty)&&!(!a.dirty&&a.lastCleanEpoch===u1)){if(!a.producerMustRecompute(a)&&!$v(a)){c1(a);return}a.producerRecomputeValue(a),c1(a)}}function d1(a){if(a.consumers===void 0)return;let d=Bv;Bv=!0;try{for(let l=a.consumers;l!==void 0;l=l.nextConsumer){let m=l.consumer;m.dirty||Rz(m)}}finally{Bv=d}}function h1(){return _o?.consumerAllowSignalWrites!==!1}function Rz(a){a.dirty=!0,d1(a),a.consumerMarkedDirty?.(a)}function c1(a){a.dirty=!1,a.lastCleanEpoch=u1}function Hv(a){return a&&(a.producersTail=void 0,a.recomputing=!0),Ci(a)}function f1(a,d){if(Ci(d),!a)return;a.recomputing=!1;let l=a.producersTail,m=l!==void 0?l.nextProducer:a.producers;if(m!==void 0){if(mf(a))do m=m1(m);while(m!==void 0);l!==void 0?l.nextProducer=void 0:a.producers=void 0}}function $v(a){for(let d=a.producers;d!==void 0;d=d.nextProducer){let l=d.producer,m=d.lastReadVersion;if(m!==l.version||(QA(l),m!==l.version))return!0}return!1}function p1(a){if(mf(a)){let d=a.producers;for(;d!==void 0;)d=m1(d)}a.producers=void 0,a.producersTail=void 0,a.consumers=void 0,a.consumersTail=void 0}function eM(a,d){let l=a.consumersTail,m=mf(a);if(l!==void 0?(d.nextConsumer=l.nextConsumer,l.nextConsumer=d):(d.nextConsumer=void 0,a.consumers=d),d.prevConsumer=l,a.consumersTail=d,!m)for(let b=a.producers;b!==void 0;b=b.nextProducer)eM(b.producer,b)}function m1(a){let d=a.producer,l=a.nextProducer,m=a.nextConsumer,b=a.prevConsumer;if(a.nextConsumer=void 0,a.prevConsumer=void 0,m!==void 0?m.prevConsumer=b:d.consumersTail=b,b!==void 0)b.nextConsumer=m;else if(d.consumers=m,!mf(d)){let r=d.producers;for(;r!==void 0;)r=m1(r)}return l}function mf(a){return a.consumerIsAlwaysLive||a.consumers!==void 0}function tM(a){Mz?.(a)}function Pz(a,d){let l=d.producersTail;if(l!==void 0){let m=d.producers;do{if(m===a)return!0;if(m===l)break;m=m.nextProducer}while(m!==void 0)}return!1}function Oz(){throw new Error}var nM=Oz;function iM(a){nM(a)}function g1(a){nM=a}var Lz=null;function _1(a,d){let l=Object.create(Gv);l.value=a,d!==void 0&&(l.equal=d);let m=()=>rM(l);return m[wl]=l,tM(l),[m,M=>fg(l,M),M=>oM(l,M)]}function rM(a){return Uv(a),a.value}function fg(a,d){h1()||iM(a),a.equal(a.value,d)||(a.value=d,kz(a))}function oM(a,d){h1()||iM(a),fg(a,d(a.value))}var Gv=Vi(Gt({},jv),{equal:KA,value:void 0,kind:"signal"});function kz(a){a.version++,JA(),d1(a),Lz?.(a)}function Zn(a){return typeof a=="function"}function gf(a){let l=a(m=>{Error.call(m),m.stack=new Error().stack});return l.prototype=Object.create(Error.prototype),l.prototype.constructor=l,l}var qv=gf(a=>function(l){a(this),this.message=l?`${l.length} errors occurred during unsubscription:
${l.map((m,b)=>`${b+1}) ${m.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=l});function pg(a,d){if(a){let l=a.indexOf(d);0<=l&&a.splice(l,1)}}var _r=class a{constructor(d){this.initialTeardown=d,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let d;if(!this.closed){this.closed=!0;let{_parentage:l}=this;if(l)if(this._parentage=null,Array.isArray(l))for(let r of l)r.remove(this);else l.remove(this);let{initialTeardown:m}=this;if(Zn(m))try{m()}catch(r){d=r instanceof qv?r.errors:[r]}let{_finalizers:b}=this;if(b){this._finalizers=null;for(let r of b)try{sM(r)}catch(M){d=d??[],M instanceof qv?d=[...d,...M.errors]:d.push(M)}}if(d)throw new qv(d)}}add(d){var l;if(d&&d!==this)if(this.closed)sM(d);else{if(d instanceof a){if(d.closed||d._hasParent(this))return;d._addParent(this)}(this._finalizers=(l=this._finalizers)!==null&&l!==void 0?l:[]).push(d)}}_hasParent(d){let{_parentage:l}=this;return l===d||Array.isArray(l)&&l.includes(d)}_addParent(d){let{_parentage:l}=this;this._parentage=Array.isArray(l)?(l.push(d),l):l?[l,d]:d}_removeParent(d){let{_parentage:l}=this;l===d?this._parentage=null:Array.isArray(l)&&pg(l,d)}remove(d){let{_finalizers:l}=this;l&&pg(l,d),d instanceof a&&d._removeParent(this)}};_r.EMPTY=(()=>{let a=new _r;return a.closed=!0,a})();var y1=_r.EMPTY;function Wv(a){return a instanceof _r||a&&"closed"in a&&Zn(a.remove)&&Zn(a.add)&&Zn(a.unsubscribe)}function sM(a){Zn(a)?a():a.unsubscribe()}var Ys={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var _f={setTimeout(a,d,...l){let{delegate:m}=_f;return m?.setTimeout?m.setTimeout(a,d,...l):setTimeout(a,d,...l)},clearTimeout(a){let{delegate:d}=_f;return(d?.clearTimeout||clearTimeout)(a)},delegate:void 0};function Zv(a){_f.setTimeout(()=>{let{onUnhandledError:d}=Ys;if(d)d(a);else throw a})}function mg(){}var aM=v1("C",void 0,void 0);function lM(a){return v1("E",void 0,a)}function cM(a){return v1("N",a,void 0)}function v1(a,d,l){return{kind:a,value:d,error:l}}var ld=null;function yf(a){if(Ys.useDeprecatedSynchronousErrorHandling){let d=!ld;if(d&&(ld={errorThrown:!1,error:null}),a(),d){let{errorThrown:l,error:m}=ld;if(ld=null,l)throw m}}else a()}function uM(a){Ys.useDeprecatedSynchronousErrorHandling&&ld&&(ld.errorThrown=!0,ld.error=a)}var cd=class extends _r{constructor(d){super(),this.isStopped=!1,d?(this.destination=d,Wv(d)&&d.add(this)):this.destination=zz}static create(d,l,m){return new vf(d,l,m)}next(d){this.isStopped?b1(cM(d),this):this._next(d)}error(d){this.isStopped?b1(lM(d),this):(this.isStopped=!0,this._error(d))}complete(){this.isStopped?b1(aM,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(d){this.destination.next(d)}_error(d){try{this.destination.error(d)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},Fz=Function.prototype.bind;function x1(a,d){return Fz.call(a,d)}var w1=class{constructor(d){this.partialObserver=d}next(d){let{partialObserver:l}=this;if(l.next)try{l.next(d)}catch(m){Xv(m)}}error(d){let{partialObserver:l}=this;if(l.error)try{l.error(d)}catch(m){Xv(m)}else Xv(d)}complete(){let{partialObserver:d}=this;if(d.complete)try{d.complete()}catch(l){Xv(l)}}},vf=class extends cd{constructor(d,l,m){super();let b;if(Zn(d)||!d)b={next:d??void 0,error:l??void 0,complete:m??void 0};else{let r;this&&Ys.useDeprecatedNextContext?(r=Object.create(d),r.unsubscribe=()=>this.unsubscribe(),b={next:d.next&&x1(d.next,r),error:d.error&&x1(d.error,r),complete:d.complete&&x1(d.complete,r)}):b=d}this.destination=new w1(b)}};function Xv(a){Ys.useDeprecatedSynchronousErrorHandling?uM(a):Zv(a)}function Nz(a){throw a}function b1(a,d){let{onStoppedNotification:l}=Ys;l&&_f.setTimeout(()=>l(a,d))}var zz={closed:!0,next:mg,error:Nz,complete:mg};var xf=typeof Symbol=="function"&&Symbol.observable||"@@observable";function us(a){return a}function E1(...a){return T1(a)}function T1(a){return a.length===0?us:a.length===1?a[0]:function(l){return a.reduce((m,b)=>b(m),l)}}var xi=(()=>{class a{constructor(l){l&&(this._subscribe=l)}lift(l){let m=new a;return m.source=this,m.operator=l,m}subscribe(l,m,b){let r=Vz(l)?l:new vf(l,m,b);return yf(()=>{let{operator:M,source:N}=this;r.add(M?M.call(r,N):N?this._subscribe(r):this._trySubscribe(r))}),r}_trySubscribe(l){try{return this._subscribe(l)}catch(m){l.error(m)}}forEach(l,m){return m=dM(m),new m((b,r)=>{let M=new vf({next:N=>{try{l(N)}catch(G){r(G),M.unsubscribe()}},error:r,complete:b});this.subscribe(M)})}_subscribe(l){var m;return(m=this.source)===null||m===void 0?void 0:m.subscribe(l)}[xf](){return this}pipe(...l){return T1(l)(this)}toPromise(l){return l=dM(l),new l((m,b)=>{let r;this.subscribe(M=>r=M,M=>b(M),()=>m(r))})}}return a.create=d=>new a(d),a})();function dM(a){var d;return(d=a??Ys.Promise)!==null&&d!==void 0?d:Promise}function Bz(a){return a&&Zn(a.next)&&Zn(a.error)&&Zn(a.complete)}function Vz(a){return a&&a instanceof cd||Bz(a)&&Wv(a)}function I1(a){return Zn(a?.lift)}function Ei(a){return d=>{if(I1(d))return d.lift(function(l){try{return a(l,this)}catch(m){this.error(m)}});throw new TypeError("Unable to lift unknown Observable type")}}function Ti(a,d,l,m,b){return new S1(a,d,l,m,b)}var S1=class extends cd{constructor(d,l,m,b,r,M){super(d),this.onFinalize=r,this.shouldUnsubscribe=M,this._next=l?function(N){try{l(N)}catch(G){d.error(G)}}:super._next,this._error=b?function(N){try{b(N)}catch(G){d.error(G)}finally{this.unsubscribe()}}:super._error,this._complete=m?function(){try{m()}catch(N){d.error(N)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var d;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:l}=this;super.unsubscribe(),!l&&((d=this.onFinalize)===null||d===void 0||d.call(this))}}};function bf(){return Ei((a,d)=>{let l=null;a._refCount++;let m=Ti(d,void 0,void 0,void 0,()=>{if(!a||a._refCount<=0||0<--a._refCount){l=null;return}let b=a._connection,r=l;l=null,b&&(!r||b===r)&&b.unsubscribe(),d.unsubscribe()});a.subscribe(m),m.closed||(l=a.connect())})}var wf=class extends xi{constructor(d,l){super(),this.source=d,this.subjectFactory=l,this._subject=null,this._refCount=0,this._connection=null,I1(d)&&(this.lift=d.lift)}_subscribe(d){return this.getSubject().subscribe(d)}getSubject(){let d=this._subject;return(!d||d.isStopped)&&(this._subject=this.subjectFactory()),this._subject}_teardown(){this._refCount=0;let{_connection:d}=this;this._subject=this._connection=null,d?.unsubscribe()}connect(){let d=this._connection;if(!d){d=this._connection=new _r;let l=this.getSubject();d.add(this.source.subscribe(Ti(l,void 0,()=>{this._teardown(),l.complete()},m=>{this._teardown(),l.error(m)},()=>this._teardown()))),d.closed&&(this._connection=null,d=_r.EMPTY)}return d}refCount(){return bf()(this)}};var hM=gf(a=>function(){a(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var Ar=(()=>{class a extends xi{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(l){let m=new Yv(this,this);return m.operator=l,m}_throwIfClosed(){if(this.closed)throw new hM}next(l){yf(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let m of this.currentObservers)m.next(l)}})}error(l){yf(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=l;let{observers:m}=this;for(;m.length;)m.shift().error(l)}})}complete(){yf(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:l}=this;for(;l.length;)l.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var l;return((l=this.observers)===null||l===void 0?void 0:l.length)>0}_trySubscribe(l){return this._throwIfClosed(),super._trySubscribe(l)}_subscribe(l){return this._throwIfClosed(),this._checkFinalizedStatuses(l),this._innerSubscribe(l)}_innerSubscribe(l){let{hasError:m,isStopped:b,observers:r}=this;return m||b?y1:(this.currentObservers=null,r.push(l),new _r(()=>{this.currentObservers=null,pg(r,l)}))}_checkFinalizedStatuses(l){let{hasError:m,thrownError:b,isStopped:r}=this;m?l.error(b):r&&l.complete()}asObservable(){let l=new xi;return l.source=this,l}}return a.create=(d,l)=>new Yv(d,l),a})(),Yv=class extends Ar{constructor(d,l){super(),this.destination=d,this.source=l}next(d){var l,m;(m=(l=this.destination)===null||l===void 0?void 0:l.next)===null||m===void 0||m.call(l,d)}error(d){var l,m;(m=(l=this.destination)===null||l===void 0?void 0:l.error)===null||m===void 0||m.call(l,d)}complete(){var d,l;(l=(d=this.destination)===null||d===void 0?void 0:d.complete)===null||l===void 0||l.call(d)}_subscribe(d){var l,m;return(m=(l=this.source)===null||l===void 0?void 0:l.subscribe(d))!==null&&m!==void 0?m:y1}};var oo=class extends Ar{constructor(d){super(),this._value=d}get value(){return this.getValue()}_subscribe(d){let l=super._subscribe(d);return!l.closed&&d.next(this._value),l}getValue(){let{hasError:d,thrownError:l,_value:m}=this;if(d)throw l;return this._throwIfClosed(),m}next(d){super.next(this._value=d)}};var Ef=class extends Ar{constructor(){super(...arguments),this._value=null,this._hasValue=!1,this._isComplete=!1}_checkFinalizedStatuses(d){let{hasError:l,_hasValue:m,_value:b,thrownError:r,isStopped:M,_isComplete:N}=this;l?d.error(r):(M||N)&&(m&&d.next(b),d.complete())}next(d){this.isStopped||(this._value=d,this._hasValue=!0)}complete(){let{_hasValue:d,_value:l,_isComplete:m}=this;m||(this._isComplete=!0,d&&super.next(l),super.complete())}};var es=new xi(a=>a.complete());function fM(a){return a&&Zn(a.schedule)}function pM(a){return a[a.length-1]}function mM(a){return Zn(pM(a))?a.pop():void 0}function Fc(a){return fM(pM(a))?a.pop():void 0}function _M(a,d,l,m){function b(r){return r instanceof l?r:new l(function(M){M(r)})}return new(l||(l=Promise))(function(r,M){function N(Me){try{fe(m.next(Me))}catch(Ue){M(Ue)}}function G(Me){try{fe(m.throw(Me))}catch(Ue){M(Ue)}}function fe(Me){Me.done?r(Me.value):b(Me.value).then(N,G)}fe((m=m.apply(a,d||[])).next())})}function gM(a){var d=typeof Symbol=="function"&&Symbol.iterator,l=d&&a[d],m=0;if(l)return l.call(a);if(a&&typeof a.length=="number")return{next:function(){return a&&m>=a.length&&(a=void 0),{value:a&&a[m++],done:!a}}};throw new TypeError(d?"Object is not iterable.":"Symbol.iterator is not defined.")}function ud(a){return this instanceof ud?(this.v=a,this):new ud(a)}function yM(a,d,l){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var m=l.apply(a,d||[]),b,r=[];return b=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),N("next"),N("throw"),N("return",M),b[Symbol.asyncIterator]=function(){return this},b;function M(Fe){return function(Pt){return Promise.resolve(Pt).then(Fe,Ue)}}function N(Fe,Pt){m[Fe]&&(b[Fe]=function(Vt){return new Promise(function(jt,Nt){r.push([Fe,Vt,jt,Nt])>1||G(Fe,Vt)})},Pt&&(b[Fe]=Pt(b[Fe])))}function G(Fe,Pt){try{fe(m[Fe](Pt))}catch(Vt){bt(r[0][3],Vt)}}function fe(Fe){Fe.value instanceof ud?Promise.resolve(Fe.value.v).then(Me,Ue):bt(r[0][2],Fe)}function Me(Fe){G("next",Fe)}function Ue(Fe){G("throw",Fe)}function bt(Fe,Pt){Fe(Pt),r.shift(),r.length&&G(r[0][0],r[0][1])}}function vM(a){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var d=a[Symbol.asyncIterator],l;return d?d.call(a):(a=typeof gM=="function"?gM(a):a[Symbol.iterator](),l={},m("next"),m("throw"),m("return"),l[Symbol.asyncIterator]=function(){return this},l);function m(r){l[r]=a[r]&&function(M){return new Promise(function(N,G){M=a[r](M),b(N,G,M.done,M.value)})}}function b(r,M,N,G){Promise.resolve(G).then(function(fe){r({value:fe,done:N})},M)}}var Kv=a=>a&&typeof a.length=="number"&&typeof a!="function";function Jv(a){return Zn(a?.then)}function Qv(a){return Zn(a[xf])}function e0(a){return Symbol.asyncIterator&&Zn(a?.[Symbol.asyncIterator])}function t0(a){return new TypeError(`You provided ${a!==null&&typeof a=="object"?"an invalid object":`'${a}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function jz(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var n0=jz();function i0(a){return Zn(a?.[n0])}function r0(a){return yM(this,arguments,function*(){let l=a.getReader();try{for(;;){let{value:m,done:b}=yield ud(l.read());if(b)return yield ud(void 0);yield yield ud(m)}}finally{l.releaseLock()}})}function o0(a){return Zn(a?.getReader)}function Gr(a){if(a instanceof xi)return a;if(a!=null){if(Qv(a))return Uz(a);if(Kv(a))return Hz(a);if(Jv(a))return $z(a);if(e0(a))return xM(a);if(i0(a))return Gz(a);if(o0(a))return qz(a)}throw t0(a)}function Uz(a){return new xi(d=>{let l=a[xf]();if(Zn(l.subscribe))return l.subscribe(d);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Hz(a){return new xi(d=>{for(let l=0;l<a.length&&!d.closed;l++)d.next(a[l]);d.complete()})}function $z(a){return new xi(d=>{a.then(l=>{d.closed||(d.next(l),d.complete())},l=>d.error(l)).then(null,Zv)})}function Gz(a){return new xi(d=>{for(let l of a)if(d.next(l),d.closed)return;d.complete()})}function xM(a){return new xi(d=>{Wz(a,d).catch(l=>d.error(l))})}function qz(a){return xM(r0(a))}function Wz(a,d){var l,m,b,r;return _M(this,void 0,void 0,function*(){try{for(l=vM(a);m=yield l.next(),!m.done;){let M=m.value;if(d.next(M),d.closed)return}}catch(M){b={error:M}}finally{try{m&&!m.done&&(r=l.return)&&(yield r.call(l))}finally{if(b)throw b.error}}d.complete()})}function ts(a,d,l,m=0,b=!1){let r=d.schedule(function(){l(),b?a.add(this.schedule(null,m)):this.unsubscribe()},m);if(a.add(r),!b)return r}function s0(a,d=0){return Ei((l,m)=>{l.subscribe(Ti(m,b=>ts(m,a,()=>m.next(b),d),()=>ts(m,a,()=>m.complete(),d),b=>ts(m,a,()=>m.error(b),d)))})}function a0(a,d=0){return Ei((l,m)=>{m.add(a.schedule(()=>l.subscribe(m),d))})}function bM(a,d){return Gr(a).pipe(a0(d),s0(d))}function wM(a,d){return Gr(a).pipe(a0(d),s0(d))}function EM(a,d){return new xi(l=>{let m=0;return d.schedule(function(){m===a.length?l.complete():(l.next(a[m++]),l.closed||this.schedule())})})}function TM(a,d){return new xi(l=>{let m;return ts(l,d,()=>{m=a[n0](),ts(l,d,()=>{let b,r;try{({value:b,done:r}=m.next())}catch(M){l.error(M);return}r?l.complete():l.next(b)},0,!0)}),()=>Zn(m?.return)&&m.return()})}function l0(a,d){if(!a)throw new Error("Iterable cannot be null");return new xi(l=>{ts(l,d,()=>{let m=a[Symbol.asyncIterator]();ts(l,d,()=>{m.next().then(b=>{b.done?l.complete():l.next(b.value)})},0,!0)})})}function IM(a,d){return l0(r0(a),d)}function SM(a,d){if(a!=null){if(Qv(a))return bM(a,d);if(Kv(a))return EM(a,d);if(Jv(a))return wM(a,d);if(e0(a))return l0(a,d);if(i0(a))return TM(a,d);if(o0(a))return IM(a,d)}throw t0(a)}function yr(a,d){return d?SM(a,d):Gr(a)}function In(...a){let d=Fc(a);return yr(a,d)}function Tf(a,d){let l=Zn(a)?a:()=>a,m=b=>b.error(l());return new xi(d?b=>d.schedule(m,0,b):m)}function D1(a){return!!a&&(a instanceof xi||Zn(a.lift)&&Zn(a.subscribe))}var Ks=gf(a=>function(){a(this),this.name="EmptyError",this.message="no elements in sequence"});function C1(a,d){let l=typeof d=="object";return new Promise((m,b)=>{let r=!1,M;a.subscribe({next:N=>{M=N,r=!0},error:b,complete:()=>{r?m(M):l?m(d.defaultValue):b(new Ks)}})})}function oi(a,d){return Ei((l,m)=>{let b=0;l.subscribe(Ti(m,r=>{m.next(a.call(d,r,b++))}))})}var{isArray:Zz}=Array;function Xz(a,d){return Zz(d)?a(...d):a(d)}function DM(a){return oi(d=>Xz(a,d))}var{isArray:Yz}=Array,{getPrototypeOf:Kz,prototype:Jz,keys:Qz}=Object;function CM(a){if(a.length===1){let d=a[0];if(Yz(d))return{args:d,keys:null};if(eB(d)){let l=Qz(d);return{args:l.map(m=>d[m]),keys:l}}}return{args:a,keys:null}}function eB(a){return a&&typeof a=="object"&&Kz(a)===Jz}function AM(a,d){return a.reduce((l,m,b)=>(l[m]=d[b],l),{})}function gg(...a){let d=Fc(a),l=mM(a),{args:m,keys:b}=CM(a);if(m.length===0)return yr([],d);let r=new xi(tB(m,d,b?M=>AM(b,M):us));return l?r.pipe(DM(l)):r}function tB(a,d,l=us){return m=>{MM(d,()=>{let{length:b}=a,r=new Array(b),M=b,N=b;for(let G=0;G<b;G++)MM(d,()=>{let fe=yr(a[G],d),Me=!1;fe.subscribe(Ti(m,Ue=>{r[G]=Ue,Me||(Me=!0,N--),N||m.next(l(r.slice()))},()=>{--M||m.complete()}))},m)},m)}}function MM(a,d,l){a?ts(l,a,d):d()}function RM(a,d,l,m,b,r,M,N){let G=[],fe=0,Me=0,Ue=!1,bt=()=>{Ue&&!G.length&&!fe&&d.complete()},Fe=Vt=>fe<m?Pt(Vt):G.push(Vt),Pt=Vt=>{r&&d.next(Vt),fe++;let jt=!1;Gr(l(Vt,Me++)).subscribe(Ti(d,Nt=>{b?.(Nt),r?Fe(Nt):d.next(Nt)},()=>{jt=!0},void 0,()=>{if(jt)try{for(fe--;G.length&&fe<m;){let Nt=G.shift();M?ts(d,M,()=>Pt(Nt)):Pt(Nt)}bt()}catch(Nt){d.error(Nt)}}))};return a.subscribe(Ti(d,Fe,()=>{Ue=!0,bt()})),()=>{N?.()}}function br(a,d,l=1/0){return Zn(d)?br((m,b)=>oi((r,M)=>d(m,r,b,M))(Gr(a(m,b))),l):(typeof d=="number"&&(l=d),Ei((m,b)=>RM(m,b,a,l)))}function If(a=1/0){return br(us,a)}function PM(){return If(1)}function Sf(...a){return PM()(yr(a,Fc(a)))}function _g(a){return new xi(d=>{Gr(a()).subscribe(d)})}function yo(a,d){return Ei((l,m)=>{let b=0;l.subscribe(Ti(m,r=>a.call(d,r,b++)&&m.next(r)))})}function El(a){return Ei((d,l)=>{let m=null,b=!1,r;m=d.subscribe(Ti(l,void 0,void 0,M=>{r=Gr(a(M,El(a)(d))),m?(m.unsubscribe(),m=null,r.subscribe(l)):b=!0})),b&&(m.unsubscribe(),m=null,r.subscribe(l))})}function OM(a,d,l,m,b){return(r,M)=>{let N=l,G=d,fe=0;r.subscribe(Ti(M,Me=>{let Ue=fe++;G=N?a(G,Me,Ue):(N=!0,Me),m&&M.next(G)},b&&(()=>{N&&M.next(G),M.complete()})))}}function Ba(a,d){return Zn(d)?br(a,d,1):br(a,1)}function Nc(a){return Ei((d,l)=>{let m=!1;d.subscribe(Ti(l,b=>{m=!0,l.next(b)},()=>{m||l.next(a),l.complete()}))})}function Tl(a){return a<=0?()=>es:Ei((d,l)=>{let m=0;d.subscribe(Ti(l,b=>{++m<=a&&(l.next(b),a<=m&&l.complete())}))})}function c0(a=nB){return Ei((d,l)=>{let m=!1;d.subscribe(Ti(l,b=>{m=!0,l.next(b)},()=>m?l.complete():l.error(a())))})}function nB(){return new Ks}function zc(a){return Ei((d,l)=>{try{d.subscribe(l)}finally{l.add(a)}})}function Il(a,d){let l=arguments.length>=2;return m=>m.pipe(a?yo((b,r)=>a(b,r,m)):us,Tl(1),l?Nc(d):c0(()=>new Ks))}function Df(a){return a<=0?()=>es:Ei((d,l)=>{let m=[];d.subscribe(Ti(l,b=>{m.push(b),a<m.length&&m.shift()},()=>{for(let b of m)l.next(b);l.complete()},void 0,()=>{m=null}))})}function A1(a,d){let l=arguments.length>=2;return m=>m.pipe(a?yo((b,r)=>a(b,r,m)):us,Df(1),l?Nc(d):c0(()=>new Ks))}function M1(a,d){return Ei(OM(a,d,arguments.length>=2,!0))}function R1(...a){let d=Fc(a);return Ei((l,m)=>{(d?Sf(a,l,d):Sf(a,l)).subscribe(m)})}function zo(a,d){return Ei((l,m)=>{let b=null,r=0,M=!1,N=()=>M&&!b&&m.complete();l.subscribe(Ti(m,G=>{b?.unsubscribe();let fe=0,Me=r++;Gr(a(G,Me)).subscribe(b=Ti(m,Ue=>m.next(d?d(G,Ue,Me,fe++):Ue),()=>{b=null,N()}))},()=>{M=!0,N()}))})}function u0(a){return Ei((d,l)=>{Gr(a).subscribe(Ti(l,()=>l.complete(),mg)),!l.closed&&d.subscribe(l)})}function qr(a,d,l){let m=Zn(a)||d||l?{next:a,error:d,complete:l}:a;return m?Ei((b,r)=>{var M;(M=m.subscribe)===null||M===void 0||M.call(m);let N=!0;b.subscribe(Ti(r,G=>{var fe;(fe=m.next)===null||fe===void 0||fe.call(m,G),r.next(G)},()=>{var G;N=!1,(G=m.complete)===null||G===void 0||G.call(m),r.complete()},G=>{var fe;N=!1,(fe=m.error)===null||fe===void 0||fe.call(m,G),r.error(G)},()=>{var G,fe;N&&((G=m.unsubscribe)===null||G===void 0||G.call(m)),(fe=m.finalize)===null||fe===void 0||fe.call(m)}))}):us}var H1="https://angular.dev/best-practices/security#preventing-cross-site-scripting-xss",en=class extends Error{code;constructor(d,l){super(gd(d,l)),this.code=d}};function rB(a){return`NG0${Math.abs(a)}`}function gd(a,d){return`${rB(a)}${d?": "+d:""}`}var Qs=globalThis;function ji(a){for(let d in a)if(a[d]===ji)return d;throw Error("")}function Bc(a){if(typeof a=="string")return a;if(Array.isArray(a))return`[${a.map(Bc).join(", ")}]`;if(a==null)return""+a;let d=a.overriddenName||a.name;if(d)return`${d}`;let l=a.toString();if(l==null)return""+l;let m=l.indexOf(`
`);return m>=0?l.slice(0,m):l}function m0(a,d){return a?d?`${a} ${d}`:a:d||""}var oB=ji({__forward_ref__:ji});function g0(a){return a.__forward_ref__=g0,a.toString=function(){return Bc(this())},a}function so(a){return $1(a)?a():a}function $1(a){return typeof a=="function"&&a.hasOwnProperty(oB)&&a.__forward_ref__===g0}function FM(a,d){a==null&&G1(d,a,null,"!=")}function G1(a,d,l,m){throw new Error(`ASSERTION ERROR: ${a}`+(m==null?"":` [Expected=> ${l} ${m} ${d} <=Actual]`))}function Xt(a){return{token:a.token,providedIn:a.providedIn||null,factory:a.factory,value:void 0}}function vo(a){return{providers:a.providers||[],imports:a.imports||[]}}function wg(a){return sB(a,_0)}function q1(a){return wg(a)!==null}function sB(a,d){return a.hasOwnProperty(d)&&a[d]||null}function aB(a){let d=a?.[_0]??null;return d||null}function O1(a){return a&&a.hasOwnProperty(h0)?a[h0]:null}var _0=ji({\u0275prov:ji}),h0=ji({\u0275inj:ji}),Kt=class{_desc;ngMetadataName="InjectionToken";\u0275prov;constructor(d,l){this._desc=d,this.\u0275prov=void 0,typeof l=="number"?this.__NG_ELEMENT_ID__=l:l!==void 0&&(this.\u0275prov=Xt({token:this,providedIn:l.providedIn||"root",factory:l.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function W1(a){return a&&!!a.\u0275providers}var Z1=ji({\u0275cmp:ji}),X1=ji({\u0275dir:ji}),Y1=ji({\u0275pipe:ji}),K1=ji({\u0275mod:ji}),xg=ji({\u0275fac:ji}),_d=ji({__NG_ELEMENT_ID__:ji}),LM=ji({__NG_ENV_ID__:ji});function NM(a){return typeof a=="string"?a:a==null?"":String(a)}function f0(a){return typeof a=="function"?a.name||a.toString():typeof a=="object"&&a!=null&&typeof a.type=="function"?a.type.name||a.type.toString():NM(a)}var J1=ji({ngErrorCode:ji}),zM=ji({ngErrorMessage:ji}),vg=ji({ngTokenPath:ji});function Q1(a,d){return BM("",-200,d)}function y0(a,d){throw new en(-201,!1)}function lB(a,d){a[vg]??=[];let l=a[vg],m;typeof d=="object"&&"multi"in d&&d?.multi===!0?(FM(d.provide,"Token with multi: true should have a provide property"),m=f0(d.provide)):m=f0(d),l[0]!==m&&a[vg].unshift(m)}function cB(a,d){let l=a[vg],m=a[J1],b=a[zM]||a.message;return a.message=dB(b,m,l,d),a}function BM(a,d,l){let m=new en(d,a);return m[J1]=d,m[zM]=a,l&&(m[vg]=l),m}function uB(a){return a[J1]}function dB(a,d,l=[],m=null){let b="";l&&l.length>1&&(b=` Path: ${l.join(" -> ")}.`);let r=m?` Source: ${m}.`:"";return gd(d,`${a}${r}${b}`)}var L1;function VM(){return L1}function ds(a){let d=L1;return L1=a,d}function eE(a,d,l){let m=wg(a);if(m&&m.providedIn=="root")return m.value===void 0?m.value=m.factory():m.value;if(l&8)return null;if(d!==void 0)return d;y0(a,"Injector")}var hB={},dd=hB,fB="__NG_DI_FLAG__",k1=class{injector;constructor(d){this.injector=d}retrieve(d,l){let m=hd(l)||0;try{return this.injector.get(d,m&8?null:dd,m)}catch(b){if(pf(b))return b;throw b}}};function pB(a,d=0){let l=zv();if(l===void 0)throw new en(-203,!1);if(l===null)return eE(a,void 0,d);{let m=mB(d),b=l.retrieve(a,m);if(pf(b)){if(m.optional)return null;throw b}return b}}function un(a,d=0){return(VM()||pB)(so(a),d)}function mt(a,d){return un(a,hd(d))}function hd(a){return typeof a>"u"||typeof a=="number"?a:0|(a.optional&&8)|(a.host&&1)|(a.self&&2)|(a.skipSelf&&4)}function mB(a){return{optional:!!(a&8),host:!!(a&1),self:!!(a&2),skipSelf:!!(a&4)}}function F1(a){let d=[];for(let l=0;l<a.length;l++){let m=so(a[l]);if(Array.isArray(m)){if(m.length===0)throw new en(900,!1);let b,r=0;for(let M=0;M<m.length;M++){let N=m[M],G=gB(N);typeof G=="number"?G===-1?b=N.token:r|=G:b=N}d.push(un(b,r))}else d.push(un(m))}return d}function gB(a){return a[fB]}function fd(a,d){let l=a.hasOwnProperty(xg);return l?a[xg]:null}function jM(a,d,l){if(a.length!==d.length)return!1;for(let m=0;m<a.length;m++){let b=a[m],r=d[m];if(l&&(b=l(b),r=l(r)),r!==b)return!1}return!0}function UM(a){return a.flat(Number.POSITIVE_INFINITY)}function v0(a,d){a.forEach(l=>Array.isArray(l)?v0(l,d):d(l))}function tE(a,d,l){d>=a.length?a.push(l):a.splice(d,0,l)}function Eg(a,d){return d>=a.length-1?a.pop():a.splice(d,1)[0]}function HM(a,d,l,m){let b=a.length;if(b==d)a.push(l,m);else if(b===1)a.push(m,a[0]),a[0]=l;else{for(b--,a.push(a[b-1],a[b]);b>d;){let r=b-2;a[b]=a[r],b--}a[d]=l,a[d+1]=m}}function nE(a,d,l){let m=Af(a,d);return m>=0?a[m|1]=l:(m=~m,HM(a,m,d,l)),m}function x0(a,d){let l=Af(a,d);if(l>=0)return a[l|1]}function Af(a,d){return _B(a,d,1)}function _B(a,d,l){let m=0,b=a.length>>l;for(;b!==m;){let r=m+(b-m>>1),M=a[r<<l];if(d===M)return r<<l;M>d?b=r:m=r+1}return~(b<<l)}var yd={},ns=[],Cl=new Kt(""),iE=new Kt("",-1),rE=new Kt(""),bg=class{get(d,l=dd){if(l===dd){let b=BM("",-201);throw b.name="\u0275NotFound",b}return l}};function oE(a){return a[K1]||null}function Al(a){return a[Z1]||null}function sE(a){return a[X1]||null}function $M(a){return a[Y1]||null}function jc(a){return{\u0275providers:a}}function GM(a){return jc([{provide:Cl,multi:!0,useValue:a}])}function qM(...a){return{\u0275providers:aE(!0,a),\u0275fromNgModule:!0}}function aE(a,...d){let l=[],m=new Set,b,r=M=>{l.push(M)};return v0(d,M=>{let N=M;p0(N,r,[],m)&&(b||=[],b.push(N))}),b!==void 0&&WM(b,r),l}function WM(a,d){for(let l=0;l<a.length;l++){let{ngModule:m,providers:b}=a[l];lE(b,r=>{d(r,m)})}}function p0(a,d,l,m){if(a=so(a),!a)return!1;let b=null,r=O1(a),M=!r&&Al(a);if(!r&&!M){let G=a.ngModule;if(r=O1(G),r)b=G;else return!1}else{if(M&&!M.standalone)return!1;b=a}let N=m.has(b);if(M){if(N)return!1;if(m.add(b),M.dependencies){let G=typeof M.dependencies=="function"?M.dependencies():M.dependencies;for(let fe of G)p0(fe,d,l,m)}}else if(r){if(r.imports!=null&&!N){m.add(b);let fe;try{v0(r.imports,Me=>{p0(Me,d,l,m)&&(fe||=[],fe.push(Me))})}finally{}fe!==void 0&&WM(fe,d)}if(!N){let fe=fd(b)||(()=>new b);d({provide:b,useFactory:fe,deps:ns},b),d({provide:rE,useValue:b,multi:!0},b),d({provide:Cl,useValue:()=>un(b),multi:!0},b)}let G=r.providers;if(G!=null&&!N){let fe=a;lE(G,Me=>{d(Me,fe)})}}else return!1;return b!==a&&a.providers!==void 0}function lE(a,d){for(let l of a)W1(l)&&(l=l.\u0275providers),Array.isArray(l)?lE(l,d):d(l)}var yB=ji({provide:String,useValue:ji});function ZM(a){return a!==null&&typeof a=="object"&&yB in a}function vB(a){return!!(a&&a.useExisting)}function xB(a){return!!(a&&a.useFactory)}function pd(a){return typeof a=="function"}function XM(a){return!!a.useClass}var Tg=new Kt(""),d0={},kM={},P1;function Ig(){return P1===void 0&&(P1=new bg),P1}var wr=class{},md=class extends wr{parent;source;scopes;records=new Map;_ngOnDestroyHooks=new Set;_onDestroyHooks=[];get destroyed(){return this._destroyed}_destroyed=!1;injectorDefTypes;constructor(d,l,m,b){super(),this.parent=l,this.source=m,this.scopes=b,z1(d,M=>this.processProvider(M)),this.records.set(iE,Cf(void 0,this)),b.has("environment")&&this.records.set(wr,Cf(void 0,this));let r=this.records.get(Tg);r!=null&&typeof r.value=="string"&&this.scopes.add(r.value),this.injectorDefTypes=new Set(this.get(rE,ns,{self:!0}))}retrieve(d,l){let m=hd(l)||0;try{return this.get(d,dd,m)}catch(b){if(pf(b))return b;throw b}}destroy(){yg(this),this._destroyed=!0;let d=Ci(null);try{for(let m of this._ngOnDestroyHooks)m.ngOnDestroy();let l=this._onDestroyHooks;this._onDestroyHooks=[];for(let m of l)m()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),Ci(d)}}onDestroy(d){return yg(this),this._onDestroyHooks.push(d),()=>this.removeOnDestroy(d)}runInContext(d){yg(this);let l=za(this),m=ds(void 0),b;try{return d()}finally{za(l),ds(m)}}get(d,l=dd,m){if(yg(this),d.hasOwnProperty(LM))return d[LM](this);let b=hd(m),r,M=za(this),N=ds(void 0);try{if(!(b&4)){let fe=this.records.get(d);if(fe===void 0){let Me=IB(d)&&wg(d);Me&&this.injectableDefInScope(Me)?fe=Cf(N1(d),d0):fe=null,this.records.set(d,fe)}if(fe!=null)return this.hydrate(d,fe,b)}let G=b&2?Ig():this.parent;return l=b&8&&l===dd?null:l,G.get(d,l)}catch(G){let fe=uB(G);throw fe===-200||fe===-201?new en(fe,null):G}finally{ds(N),za(M)}}resolveInjectorInitializers(){let d=Ci(null),l=za(this),m=ds(void 0),b;try{let r=this.get(Cl,ns,{self:!0});for(let M of r)M()}finally{za(l),ds(m),Ci(d)}}toString(){let d=[],l=this.records;for(let m of l.keys())d.push(Bc(m));return`R3Injector[${d.join(", ")}]`}processProvider(d){d=so(d);let l=pd(d)?d:so(d&&d.provide),m=wB(d);if(!pd(d)&&d.multi===!0){let b=this.records.get(l);b||(b=Cf(void 0,d0,!0),b.factory=()=>F1(b.multi),this.records.set(l,b)),l=d,b.multi.push(d)}this.records.set(l,m)}hydrate(d,l,m){let b=Ci(null);try{if(l.value===kM)throw Q1(Bc(d));return l.value===d0&&(l.value=kM,l.value=l.factory(void 0,m)),typeof l.value=="object"&&l.value&&TB(l.value)&&this._ngOnDestroyHooks.add(l.value),l.value}finally{Ci(b)}}injectableDefInScope(d){if(!d.providedIn)return!1;let l=so(d.providedIn);return typeof l=="string"?l==="any"||this.scopes.has(l):this.injectorDefTypes.has(l)}removeOnDestroy(d){let l=this._onDestroyHooks.indexOf(d);l!==-1&&this._onDestroyHooks.splice(l,1)}};function N1(a){let d=wg(a),l=d!==null?d.factory:fd(a);if(l!==null)return l;if(a instanceof Kt)throw new en(204,!1);if(a instanceof Function)return bB(a);throw new en(204,!1)}function bB(a){if(a.length>0)throw new en(204,!1);let l=aB(a);return l!==null?()=>l.factory(a):()=>new a}function wB(a){if(ZM(a))return Cf(void 0,a.useValue);{let d=cE(a);return Cf(d,d0)}}function cE(a,d,l){let m;if(pd(a)){let b=so(a);return fd(b)||N1(b)}else if(ZM(a))m=()=>so(a.useValue);else if(xB(a))m=()=>a.useFactory(...F1(a.deps||[]));else if(vB(a))m=(b,r)=>un(so(a.useExisting),r!==void 0&&r&8?8:void 0);else{let b=so(a&&(a.useClass||a.provide));if(EB(a))m=()=>new b(...F1(a.deps));else return fd(b)||N1(b)}return m}function yg(a){if(a.destroyed)throw new en(205,!1)}function Cf(a,d,l=!1){return{factory:a,value:d,multi:l?[]:void 0}}function EB(a){return!!a.deps}function TB(a){return a!==null&&typeof a=="object"&&typeof a.ngOnDestroy=="function"}function IB(a){return typeof a=="function"||typeof a=="object"&&a.ngMetadataName==="InjectionToken"}function z1(a,d){for(let l of a)Array.isArray(l)?z1(l,d):l&&W1(l)?z1(l.\u0275providers,d):d(l)}function Xr(a,d){let l;a instanceof md?(yg(a),l=a):l=new k1(a);let m,b=za(l),r=ds(void 0);try{return d()}finally{za(b),ds(r)}}function uE(){return VM()!==void 0||zv()!=null}var ea=0,jn=1,Vn=2,Wr=3,Ds=4,Cs=5,Sg=6,Dg=7,hs=8,Mf=9,Ml=10,Bo=11,Rf=12,dE=13,Pf=14,As=15,Uc=16,vd=17,Va=18,Cg=19,hE=20,Sl=21,b0=22,Ag=23,fs=24,xd=25,Ms=26,YM=1;var Hc=7,Mg=8,bd=9,Vo=10;function Rl(a){return Array.isArray(a)&&typeof a[YM]=="object"}function ta(a){return Array.isArray(a)&&a[YM]===!0}function fE(a){return(a.flags&4)!==0}function wd(a){return a.componentOffset>-1}function pE(a){return(a.flags&1)===1}function $c(a){return!!a.template}function Of(a){return(a[Vn]&512)!==0}function Ed(a){return(a[Vn]&256)===256}var KM="svg",JM="math";function na(a){for(;Array.isArray(a);)a=a[ea];return a}function QM(a,d){return na(d[a])}function Pl(a,d){return na(d[a.index])}function w0(a,d){return a.data[d]}function ja(a,d){let l=d[a];return Rl(l)?l:l[ea]}function eR(a){return(a[Vn]&4)===4}function E0(a){return(a[Vn]&128)===128}function tR(a){return ta(a[Wr])}function Rg(a,d){return d==null?null:a[d]}function mE(a){a[vd]=0}function gE(a){a[Vn]&1024||(a[Vn]|=1024,E0(a)&&Lf(a))}function Pg(a){return!!(a[Vn]&9216||a[fs]?.dirty)}function T0(a){a[Ml].changeDetectionScheduler?.notify(8),a[Vn]&64&&(a[Vn]|=1024),Pg(a)&&Lf(a)}function Lf(a){a[Ml].changeDetectionScheduler?.notify(0);let d=Vc(a);for(;d!==null&&!(d[Vn]&8192||(d[Vn]|=8192,!E0(d)));)d=Vc(d)}function _E(a,d){if(Ed(a))throw new en(911,!1);a[Sl]===null&&(a[Sl]=[]),a[Sl].push(d)}function nR(a,d){if(a[Sl]===null)return;let l=a[Sl].indexOf(d);l!==-1&&a[Sl].splice(l,1)}function Vc(a){let d=a[Wr];return ta(d)?d[Wr]:d}function iR(a){return a[Dg]??=[]}function rR(a){return a.cleanup??=[]}function oR(a,d,l,m){let b=iR(d);b.push(l),a.firstCreatePass&&rR(a).push(m,b.length-1)}var Ii={lFrame:bR(null),bindingsEnabled:!0,skipHydrationRootTNode:null},Og=function(a){return a[a.Off=0]="Off",a[a.Exhaustive=1]="Exhaustive",a[a.OnlyDirtyViews=2]="OnlyDirtyViews",a}(Og||{}),SB=0,B1=!1;function sR(){return Ii.lFrame.elementDepthCount}function aR(){Ii.lFrame.elementDepthCount++}function yE(){Ii.lFrame.elementDepthCount--}function lR(){return Ii.bindingsEnabled}function cR(){return Ii.skipHydrationRootTNode!==null}function vE(a){return Ii.skipHydrationRootTNode===a}function xE(){Ii.skipHydrationRootTNode=null}function ur(){return Ii.lFrame.lView}function Ua(){return Ii.lFrame.tView}function ps(){let a=bE();for(;a!==null&&a.type===64;)a=a.parent;return a}function bE(){return Ii.lFrame.currentTNode}function uR(){let a=Ii.lFrame,d=a.currentTNode;return a.isParent?d:d.parent}function Lg(a,d){let l=Ii.lFrame;l.currentTNode=a,l.isParent=d}function wE(){return Ii.lFrame.isParent}function dR(){Ii.lFrame.isParent=!1}function EE(a){G1("Must never be called in production mode"),SB=a}function TE(){return B1}function IE(a){let d=B1;return B1=a,d}function hR(){let a=Ii.lFrame,d=a.bindingRootIndex;return d===-1&&(d=a.bindingRootIndex=a.tView.bindingStartIndex),d}function fR(a){return Ii.lFrame.bindingIndex=a}function pR(){return Ii.lFrame.bindingIndex++}function mR(a){let d=Ii.lFrame,l=d.bindingIndex;return d.bindingIndex=d.bindingIndex+a,l}function gR(){return Ii.lFrame.inI18n}function _R(a,d){let l=Ii.lFrame;l.bindingIndex=l.bindingRootIndex=a,I0(d)}function yR(){return Ii.lFrame.currentDirectiveIndex}function I0(a){Ii.lFrame.currentDirectiveIndex=a}function vR(a){let d=Ii.lFrame.currentDirectiveIndex;return d===-1?null:a[d]}function SE(){return Ii.lFrame.currentQueryIndex}function S0(a){Ii.lFrame.currentQueryIndex=a}function DB(a){let d=a[jn];return d.type===2?d.declTNode:d.type===1?a[Cs]:null}function DE(a,d,l){if(l&4){let b=d,r=a;for(;b=b.parent,b===null&&!(l&1);)if(b=DB(r),b===null||(r=r[Pf],b.type&10))break;if(b===null)return!1;d=b,a=r}let m=Ii.lFrame=xR();return m.currentTNode=d,m.lView=a,!0}function D0(a){let d=xR(),l=a[jn];Ii.lFrame=d,d.currentTNode=l.firstChild,d.lView=a,d.tView=l,d.contextLView=a,d.bindingIndex=l.bindingStartIndex,d.inI18n=!1}function xR(){let a=Ii.lFrame,d=a===null?null:a.child;return d===null?bR(a):d}function bR(a){let d={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:a,child:null,inI18n:!1};return a!==null&&(a.child=d),d}function wR(){let a=Ii.lFrame;return Ii.lFrame=a.parent,a.currentTNode=null,a.lView=null,a}var CE=wR;function C0(){let a=wR();a.isParent=!0,a.tView=null,a.selectedIndex=-1,a.contextLView=null,a.elementDepthCount=0,a.currentDirectiveIndex=-1,a.currentNamespace=null,a.bindingRootIndex=-1,a.bindingIndex=-1,a.currentQueryIndex=0}function kf(){return Ii.lFrame.selectedIndex}function Gc(a){Ii.lFrame.selectedIndex=a}function ER(){let a=Ii.lFrame;return w0(a.tView,a.selectedIndex)}function TR(){return Ii.lFrame.currentNamespace}var IR=!0;function AE(){return IR}function ME(a){IR=a}function V1(a,d=null,l=null,m){let b=RE(a,d,l,m);return b.resolveInjectorInitializers(),b}function RE(a,d=null,l=null,m,b=new Set){let r=[l||ns,qM(a)];return m=m||(typeof a=="object"?void 0:Bc(a)),new md(r,d||Ig(),m||null,b)}var Zr=class a{static THROW_IF_NOT_FOUND=dd;static NULL=new bg;static create(d,l){if(Array.isArray(d))return V1({name:""},l,d,"");{let m=d.name??"";return V1({name:m},d.parent,d.providers,m)}}static \u0275prov=Xt({token:a,providedIn:"any",factory:()=>un(iE)});static __NG_ELEMENT_ID__=-1},dr=new Kt(""),Ha=(()=>{class a{static __NG_ELEMENT_ID__=CB;static __NG_ENV_ID__=l=>l}return a})(),j1=class extends Ha{_lView;constructor(d){super(),this._lView=d}get destroyed(){return Ed(this._lView)}onDestroy(d){let l=this._lView;return _E(l,d),()=>nR(l,d)}};function CB(){return new j1(ur())}var Js=class{_console=console;handleError(d){this._console.error("ERROR",d)}},Rs=new Kt("",{providedIn:"root",factory:()=>{let a=mt(wr),d;return l=>{a.destroyed&&!d?setTimeout(()=>{throw l}):(d??=a.get(Js),d.handleError(l))}}}),SR={provide:Cl,useValue:()=>void mt(Js),multi:!0},AB=new Kt("",{providedIn:"root",factory:()=>{let a=mt(dr).defaultView;if(!a)return;let d=mt(Rs),l=r=>{d(r.reason),r.preventDefault()},m=r=>{r.error?d(r.error):d(new Error(r.message,{cause:r})),r.preventDefault()},b=()=>{a.addEventListener("unhandledrejection",l),a.addEventListener("error",m)};typeof Zone<"u"?Zone.root.run(b):b(),mt(Ha).onDestroy(()=>{a.removeEventListener("error",m),a.removeEventListener("unhandledrejection",l)})}});function PE(){return jc([GM(()=>void mt(AB))])}function kg(a,d){let[l,m,b]=_1(a,d?.equal),r=l,M=r[wl];return r.set=m,r.update=b,r.asReadonly=DR.bind(r),r}function DR(){let a=this[wl];if(a.readonlyFn===void 0){let d=()=>this();d[wl]=a,a.readonlyFn=d}return a.readonlyFn}var Dl=class{},A0=new Kt("",{providedIn:"root",factory:()=>!1});var OE=new Kt(""),LE=new Kt("");var M0=(()=>{class a{view;node;constructor(l,m){this.view=l,this.node=m}static __NG_ELEMENT_ID__=MB}return a})();function MB(){return new M0(ur(),ps())}var $a=(()=>{class a{taskId=0;pendingTasks=new Set;destroyed=!1;pendingTask=new oo(!1);get hasPendingTasks(){return this.destroyed?!1:this.pendingTask.value}get hasPendingTasksObservable(){return this.destroyed?new xi(l=>{l.next(!1),l.complete()}):this.pendingTask}add(){!this.hasPendingTasks&&!this.destroyed&&this.pendingTask.next(!0);let l=this.taskId++;return this.pendingTasks.add(l),l}has(l){return this.pendingTasks.has(l)}remove(l){this.pendingTasks.delete(l),this.pendingTasks.size===0&&this.hasPendingTasks&&this.pendingTask.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks&&this.pendingTask.next(!1),this.destroyed=!0,this.pendingTask.unsubscribe()}static \u0275prov=Xt({token:a,providedIn:"root",factory:()=>new a})}return a})(),Fg=(()=>{class a{internalPendingTasks=mt($a);scheduler=mt(Dl);errorHandler=mt(Rs);add(){let l=this.internalPendingTasks.add();return()=>{this.internalPendingTasks.has(l)&&(this.scheduler.notify(11),this.internalPendingTasks.remove(l))}}run(l){let m=this.add();l().catch(this.errorHandler).finally(m)}static \u0275prov=Xt({token:a,providedIn:"root",factory:()=>new a})}return a})();function Ng(...a){}var kE=(()=>{class a{static \u0275prov=Xt({token:a,providedIn:"root",factory:()=>new U1})}return a})(),U1=class{dirtyEffectCount=0;queues=new Map;add(d){this.enqueue(d),this.schedule(d)}schedule(d){d.dirty&&this.dirtyEffectCount++}remove(d){let l=d.zone,m=this.queues.get(l);m.has(d)&&(m.delete(d),d.dirty&&this.dirtyEffectCount--)}enqueue(d){let l=d.zone;this.queues.has(l)||this.queues.set(l,new Set);let m=this.queues.get(l);m.has(d)||m.add(d)}flush(){for(;this.dirtyEffectCount>0;){let d=!1;for(let[l,m]of this.queues)l===null?d||=this.flushQueue(m):d||=l.run(()=>this.flushQueue(m));d||(this.dirtyEffectCount=0)}}flushQueue(d){let l=!1;for(let m of d)m.dirty&&(this.dirtyEffectCount--,l=!0,m.run());return l}};function Wg(a){return{toString:a}.toString()}function n2(a){let d=Qs.ng;if(d&&d.\u0275compilerFacade)return d.\u0275compilerFacade;throw new Error("JIT compiler unavailable")}function UB(a){return typeof a=="function"}var N0=class{previousValue;currentValue;firstChange;constructor(d,l,m){this.previousValue=d,this.currentValue=l,this.firstChange=m}isFirstChange(){return this.firstChange}};function i2(a,d,l,m){d!==null?d.applyValueToInputSignal(d,m):a[l]=m}var Ad=(()=>{let a=()=>r2;return a.ngInherit=!0,a})();function r2(a){return a.type.prototype.ngOnChanges&&(a.setInput=$B),HB}function HB(){let a=s2(this),d=a?.current;if(d){let l=a.previous;if(l===yd)a.previous=d;else for(let m in d)l[m]=d[m];a.current=null,this.ngOnChanges(d)}}function $B(a,d,l,m,b){let r=this.declaredInputs[m],M=s2(a)||GB(a,{previous:yd,current:null}),N=M.current||(M.current={}),G=M.previous,fe=G[r];N[r]=new N0(fe&&fe.currentValue,l,G===yd),i2(a,d,b,l)}var o2="__ngSimpleChanges__";function s2(a){return a[o2]||null}function GB(a,d){return a[o2]=d}var CR=[];var or=function(a,d=null,l){for(let m=0;m<CR.length;m++){let b=CR[m];b(a,d,l)}};function qB(a,d,l){let{ngOnChanges:m,ngOnInit:b,ngDoCheck:r}=d.type.prototype;if(m){let M=r2(d);(l.preOrderHooks??=[]).push(a,M),(l.preOrderCheckHooks??=[]).push(a,M)}b&&(l.preOrderHooks??=[]).push(0-a,b),r&&((l.preOrderHooks??=[]).push(a,r),(l.preOrderCheckHooks??=[]).push(a,r))}function WB(a,d){for(let l=d.directiveStart,m=d.directiveEnd;l<m;l++){let r=a.data[l].type.prototype,{ngAfterContentInit:M,ngAfterContentChecked:N,ngAfterViewInit:G,ngAfterViewChecked:fe,ngOnDestroy:Me}=r;M&&(a.contentHooks??=[]).push(-l,M),N&&((a.contentHooks??=[]).push(l,N),(a.contentCheckHooks??=[]).push(l,N)),G&&(a.viewHooks??=[]).push(-l,G),fe&&((a.viewHooks??=[]).push(l,fe),(a.viewCheckHooks??=[]).push(l,fe)),Me!=null&&(a.destroyHooks??=[]).push(l,Me)}}function O0(a,d,l){a2(a,d,3,l)}function L0(a,d,l,m){(a[Vn]&3)===l&&a2(a,d,l,m)}function FE(a,d){let l=a[Vn];(l&3)===d&&(l&=16383,l+=1,a[Vn]=l)}function a2(a,d,l,m){let b=m!==void 0?a[vd]&65535:0,r=m??-1,M=d.length-1,N=0;for(let G=b;G<M;G++)if(typeof d[G+1]=="number"){if(N=d[G],m!=null&&N>=m)break}else d[G]<0&&(a[vd]+=65536),(N<r||r==-1)&&(ZB(a,l,d,G),a[vd]=(a[vd]&4294901760)+G+2),G++}function AR(a,d){or(4,a,d);let l=Ci(null);try{d.call(a)}finally{Ci(l),or(5,a,d)}}function ZB(a,d,l,m){let b=l[m]<0,r=l[m+1],M=b?-l[m]:l[m],N=a[M];b?a[Vn]>>14<a[vd]>>16&&(a[Vn]&3)===d&&(a[Vn]+=16384,AR(N,r)):AR(N,r)}var Nf=-1,Id=class{factory;name;injectImpl;resolving=!1;canSeeViewProviders;multi;componentProviders;index;providerFactory;constructor(d,l,m,b){this.factory=d,this.name=b,this.canSeeViewProviders=l,this.injectImpl=m}};function XB(a){return(a.flags&8)!==0}function YB(a){return(a.flags&16)!==0}function KB(a,d,l){let m=0;for(;m<l.length;){let b=l[m];if(typeof b=="number"){if(b!==0)break;m++;let r=l[m++],M=l[m++],N=l[m++];a.setAttribute(d,M,N,r)}else{let r=b,M=l[++m];QB(r)?a.setProperty(d,r,M):a.setAttribute(d,r,M),m++}}return m}function JB(a){return a===3||a===4||a===6}function QB(a){return a.charCodeAt(0)===64}function _T(a,d){if(!(d===null||d.length===0))if(a===null||a.length===0)a=d.slice();else{let l=-1;for(let m=0;m<d.length;m++){let b=d[m];typeof b=="number"?l=b:l===0||(l===-1||l===2?MR(a,l,b,null,d[++m]):MR(a,l,b,null,null))}}return a}function MR(a,d,l,m,b){let r=0,M=a.length;if(d===-1)M=-1;else for(;r<a.length;){let N=a[r++];if(typeof N=="number"){if(N===d){M=-1;break}else if(N>d){M=r-1;break}}}for(;r<a.length;){let N=a[r];if(typeof N=="number")break;if(N===l){b!==null&&(a[r+1]=b);return}r++,b!==null&&r++}M!==-1&&(a.splice(M,0,d),r=M+1),a.splice(r++,0,l),b!==null&&a.splice(r++,0,b)}function l2(a){return a!==Nf}function z0(a){return a&32767}function e3(a){return a>>16}function B0(a,d){let l=e3(a),m=d;for(;l>0;)m=m[Pf],l--;return m}var $E=!0;function RR(a){let d=$E;return $E=a,d}var t3=256,c2=t3-1,u2=5,n3=0,Ga={};function i3(a,d,l){let m;typeof l=="string"?m=l.charCodeAt(0)||0:l.hasOwnProperty(_d)&&(m=l[_d]),m==null&&(m=l[_d]=n3++);let b=m&c2,r=1<<b;d.data[a+(b>>u2)]|=r}function V0(a,d){let l=d2(a,d);if(l!==-1)return l;let m=d[jn];m.firstCreatePass&&(a.injectorIndex=d.length,NE(m.data,a),NE(d,null),NE(m.blueprint,null));let b=yT(a,d),r=a.injectorIndex;if(l2(b)){let M=z0(b),N=B0(b,d),G=N[jn].data;for(let fe=0;fe<8;fe++)d[r+fe]=N[M+fe]|G[M+fe]}return d[r+8]=b,r}function NE(a,d){a.push(0,0,0,0,0,0,0,0,d)}function d2(a,d){return a.injectorIndex===-1||a.parent&&a.parent.injectorIndex===a.injectorIndex||d[a.injectorIndex+8]===null?-1:a.injectorIndex}function yT(a,d){if(a.parent&&a.parent.injectorIndex!==-1)return a.parent.injectorIndex;let l=0,m=null,b=d;for(;b!==null;){if(m=g2(b),m===null)return Nf;if(l++,b=b[Pf],m.injectorIndex!==-1)return m.injectorIndex|l<<16}return Nf}function GE(a,d,l){i3(a,d,l)}function h2(a,d,l){if(l&8||a!==void 0)return a;y0(d,"NodeInjector")}function f2(a,d,l,m){if(l&8&&m===void 0&&(m=null),(l&3)===0){let b=a[Mf],r=ds(void 0);try{return b?b.get(d,m,l&8):eE(d,m,l&8)}finally{ds(r)}}return h2(m,d,l)}function p2(a,d,l,m=0,b){if(a!==null){if(d[Vn]&2048&&!(m&2)){let M=a3(a,d,l,m,Ga);if(M!==Ga)return M}let r=m2(a,d,l,m,Ga);if(r!==Ga)return r}return f2(d,l,m,b)}function m2(a,d,l,m,b){let r=o3(l);if(typeof r=="function"){if(!DE(d,a,m))return m&1?h2(b,l,m):f2(d,l,m,b);try{let M;if(M=r(m),M==null&&!(m&8))y0(l);else return M}finally{CE()}}else if(typeof r=="number"){let M=null,N=d2(a,d),G=Nf,fe=m&1?d[As][Cs]:null;for((N===-1||m&4)&&(G=N===-1?yT(a,d):d[N+8],G===Nf||!OR(m,!1)?N=-1:(M=d[jn],N=z0(G),d=B0(G,d)));N!==-1;){let Me=d[jn];if(PR(r,N,Me.data)){let Ue=r3(N,d,l,M,m,fe);if(Ue!==Ga)return Ue}G=d[N+8],G!==Nf&&OR(m,d[jn].data[N+8]===fe)&&PR(r,N,d)?(M=Me,N=z0(G),d=B0(G,d)):N=-1}}return b}function r3(a,d,l,m,b,r){let M=d[jn],N=M.data[a+8],G=m==null?wd(N)&&$E:m!=M&&(N.type&3)!==0,fe=b&1&&r===N,Me=k0(N,M,l,G,fe);return Me!==null?Vg(d,M,Me,N,b):Ga}function k0(a,d,l,m,b){let r=a.providerIndexes,M=d.data,N=r&1048575,G=a.directiveStart,fe=a.directiveEnd,Me=r>>20,Ue=m?N:N+Me,bt=b?N+Me:fe;for(let Fe=Ue;Fe<bt;Fe++){let Pt=M[Fe];if(Fe<G&&l===Pt||Fe>=G&&Pt.type===l)return Fe}if(b){let Fe=M[G];if(Fe&&$c(Fe)&&Fe.type===l)return G}return null}function Vg(a,d,l,m,b){let r=a[l],M=d.data;if(r instanceof Id){let N=r;if(N.resolving){let Fe=f0(M[l]);throw Q1(Fe)}let G=RR(N.canSeeViewProviders);N.resolving=!0;let fe=M[l].type||M[l],Me,Ue=N.injectImpl?ds(N.injectImpl):null,bt=DE(a,m,0);try{r=a[l]=N.factory(void 0,b,M,a,m),d.firstCreatePass&&l>=m.directiveStart&&qB(l,M[l],d)}finally{Ue!==null&&ds(Ue),RR(G),N.resolving=!1,CE()}}return r}function o3(a){if(typeof a=="string")return a.charCodeAt(0)||0;let d=a.hasOwnProperty(_d)?a[_d]:void 0;return typeof d=="number"?d>=0?d&c2:s3:d}function PR(a,d,l){let m=1<<a;return!!(l[d+(a>>u2)]&m)}function OR(a,d){return!(a&2)&&!(a&1&&d)}var Td=class{_tNode;_lView;constructor(d,l){this._tNode=d,this._lView=l}get(d,l,m){return p2(this._tNode,this._lView,d,hd(m),l)}};function s3(){return new Td(ps(),ur())}function Q0(a){return Wg(()=>{let d=a.prototype.constructor,l=d[xg]||qE(d),m=Object.prototype,b=Object.getPrototypeOf(a.prototype).constructor;for(;b&&b!==m;){let r=b[xg]||qE(b);if(r&&r!==l)return r;b=Object.getPrototypeOf(b)}return r=>new r})}function qE(a){return $1(a)?()=>{let d=qE(so(a));return d&&d()}:fd(a)}function a3(a,d,l,m,b){let r=a,M=d;for(;r!==null&&M!==null&&M[Vn]&2048&&!Of(M);){let N=m2(r,M,l,m|2,Ga);if(N!==Ga)return N;let G=r.parent;if(!G){let fe=M[hE];if(fe){let Me=fe.get(l,Ga,m);if(Me!==Ga)return Me}G=g2(M),M=M[Pf]}r=G}return b}function g2(a){let d=a[jn],l=d.type;return l===2?d.declTNode:l===1?a[Cs]:null}function l3(){return jf(ps(),ur())}function jf(a,d){return new Wc(Pl(a,d))}var Wc=(()=>{class a{nativeElement;constructor(l){this.nativeElement=l}static __NG_ELEMENT_ID__=l3}return a})();function c3(a){return a instanceof Wc?a.nativeElement:a}function u3(){return this._results[Symbol.iterator]()}var j0=class{_emitDistinctChangesOnly;dirty=!0;_onDirty=void 0;_results=[];_changesDetected=!1;_changes=void 0;length=0;first=void 0;last=void 0;get changes(){return this._changes??=new Ar}constructor(d=!1){this._emitDistinctChangesOnly=d}get(d){return this._results[d]}map(d){return this._results.map(d)}filter(d){return this._results.filter(d)}find(d){return this._results.find(d)}reduce(d,l){return this._results.reduce(d,l)}forEach(d){this._results.forEach(d)}some(d){return this._results.some(d)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(d,l){this.dirty=!1;let m=UM(d);(this._changesDetected=!jM(this._results,m,l))&&(this._results=m,this.length=m.length,this.last=m[this.length-1],this.first=m[0])}notifyOnChanges(){this._changes!==void 0&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.next(this)}onDirty(d){this._onDirty=d}setDirty(){this.dirty=!0,this._onDirty?.()}destroy(){this._changes!==void 0&&(this._changes.complete(),this._changes.unsubscribe())}[Symbol.iterator]=u3};function _2(a){return(a.flags&128)===128}var vT=function(a){return a[a.OnPush=0]="OnPush",a[a.Default=1]="Default",a}(vT||{}),y2=new Map,d3=0;function h3(){return d3++}function f3(a){y2.set(a[Cg],a)}function WE(a){y2.delete(a[Cg])}var LR="__ngContext__";function jg(a,d){Rl(d)?(a[LR]=d[Cg],f3(d)):a[LR]=d}function v2(a){return b2(a[Rf])}function x2(a){return b2(a[Ds])}function b2(a){for(;a!==null&&!ta(a);)a=a[Ds];return a}var ZE;function xT(a){ZE=a}function w2(){if(ZE!==void 0)return ZE;if(typeof document<"u")return document;throw new en(210,!1)}var ex=new Kt("",{providedIn:"root",factory:()=>p3}),p3="ng",tx=new Kt(""),Uf=new Kt("",{providedIn:"platform",factory:()=>"unknown"});var nx=new Kt("",{providedIn:"root",factory:()=>w2().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});var m3="h",g3="b";var E2=!1,T2=new Kt("",{providedIn:"root",factory:()=>E2});function bT(a){return(a.flags&32)===32}var _3=()=>null;function I2(a,d,l=!1){return _3(a,d,l)}function S2(a,d){let l=a.contentQueries;if(l!==null){let m=Ci(null);try{for(let b=0;b<l.length;b+=2){let r=l[b],M=l[b+1];if(M!==-1){let N=a.data[M];S0(r),N.contentQueries(2,d[M],M)}}}finally{Ci(m)}}}function XE(a,d,l){S0(0);let m=Ci(null);try{d(a,l)}finally{Ci(m)}}function D2(a,d,l){if(fE(d)){let m=Ci(null);try{let b=d.directiveStart,r=d.directiveEnd;for(let M=b;M<r;M++){let N=a.data[M];if(N.contentQueries){let G=l[M];N.contentQueries(1,G,M)}}}finally{Ci(m)}}}var Ol=function(a){return a[a.Emulated=0]="Emulated",a[a.None=2]="None",a[a.ShadowDom=3]="ShadowDom",a}(Ol||{});var YE=class{changingThisBreaksApplicationSecurity;constructor(d){this.changingThisBreaksApplicationSecurity=d}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see ${H1})`}};function ix(a){return a instanceof YE?a.changingThisBreaksApplicationSecurity:a}function C2(a){return a instanceof Function?a():a}function y3(a,d,l){let m=a.length;for(;;){let b=a.indexOf(d,l);if(b===-1)return b;if(b===0||a.charCodeAt(b-1)<=32){let r=d.length;if(b+r===m||a.charCodeAt(b+r)<=32)return b}l=b+1}}var A2="ng-template";function v3(a,d,l,m){let b=0;if(m){for(;b<d.length&&typeof d[b]=="string";b+=2)if(d[b]==="class"&&y3(d[b+1].toLowerCase(),l,0)!==-1)return!0}else if(wT(a))return!1;if(b=d.indexOf(1,b),b>-1){let r;for(;++b<d.length&&typeof(r=d[b])=="string";)if(r.toLowerCase()===l)return!0}return!1}function wT(a){return a.type===4&&a.value!==A2}function x3(a,d,l){let m=a.type===4&&!l?A2:a.value;return d===m}function b3(a,d,l){let m=4,b=a.attrs,r=b!==null?T3(b):0,M=!1;for(let N=0;N<d.length;N++){let G=d[N];if(typeof G=="number"){if(!M&&!ia(m)&&!ia(G))return!1;if(M&&ia(G))continue;M=!1,m=G|m&1;continue}if(!M)if(m&4){if(m=2|m&1,G!==""&&!x3(a,G,l)||G===""&&d.length===1){if(ia(m))return!1;M=!0}}else if(m&8){if(b===null||!v3(a,b,G,l)){if(ia(m))return!1;M=!0}}else{let fe=d[++N],Me=w3(G,b,wT(a),l);if(Me===-1){if(ia(m))return!1;M=!0;continue}if(fe!==""){let Ue;if(Me>r?Ue="":Ue=b[Me+1].toLowerCase(),m&2&&fe!==Ue){if(ia(m))return!1;M=!0}}}}return ia(m)||M}function ia(a){return(a&1)===0}function w3(a,d,l,m){if(d===null)return-1;let b=0;if(m||!l){let r=!1;for(;b<d.length;){let M=d[b];if(M===a)return b;if(M===3||M===6)r=!0;else if(M===1||M===2){let N=d[++b];for(;typeof N=="string";)N=d[++b];continue}else{if(M===4)break;if(M===0){b+=4;continue}}b+=r?1:2}return-1}else return I3(d,a)}function E3(a,d,l=!1){for(let m=0;m<d.length;m++)if(b3(a,d[m],l))return!0;return!1}function T3(a){for(let d=0;d<a.length;d++){let l=a[d];if(JB(l))return d}return a.length}function I3(a,d){let l=a.indexOf(4);if(l>-1)for(l++;l<a.length;){let m=a[l];if(typeof m=="number")return-1;if(m===d)return l;l++}return-1}function kR(a,d){return a?":not("+d.trim()+")":d}function S3(a){let d=a[0],l=1,m=2,b="",r=!1;for(;l<a.length;){let M=a[l];if(typeof M=="string")if(m&2){let N=a[++l];b+="["+M+(N.length>0?'="'+N+'"':"")+"]"}else m&8?b+="."+M:m&4&&(b+=" "+M);else b!==""&&!ia(M)&&(d+=kR(r,b),b=""),m=M,r=r||!ia(m);l++}return b!==""&&(d+=kR(r,b)),d}function D3(a){return a.map(S3).join(",")}function C3(a){let d=[],l=[],m=1,b=2;for(;m<a.length;){let r=a[m];if(typeof r=="string")b===2?r!==""&&d.push(r,a[++m]):b===8&&l.push(r);else{if(!ia(b))break;b=r}m++}return l.length&&d.push(1,...l),d}var Zc={};function A3(a,d){return a.createText(d)}function M2(a,d,l){return a.createElement(d,l)}function U0(a,d,l,m,b){a.insertBefore(d,l,m,b)}function R2(a,d,l){a.appendChild(d,l)}function FR(a,d,l,m,b){m!==null?U0(a,d,l,m,b):R2(a,d,l)}function M3(a,d,l){a.removeChild(null,d,l)}function R3(a,d,l){a.setAttribute(d,"style",l)}function P3(a,d,l){l===""?a.removeAttribute(d,"class"):a.setAttribute(d,"class",l)}function P2(a,d,l){let{mergedAttrs:m,classes:b,styles:r}=l;m!==null&&KB(a,d,m),b!==null&&P3(a,d,b),r!==null&&R3(a,d,r)}function O2(a,d,l,m,b,r,M,N,G,fe,Me){let Ue=Ms+m,bt=Ue+b,Fe=O3(Ue,bt),Pt=typeof fe=="function"?fe():fe;return Fe[jn]={type:a,blueprint:Fe,template:l,queries:null,viewQuery:N,declTNode:d,data:Fe.slice().fill(null,Ue),bindingStartIndex:Ue,expandoStartIndex:bt,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof r=="function"?r():r,pipeRegistry:typeof M=="function"?M():M,firstChild:null,schemas:G,consts:Pt,incompleteFirstPass:!1,ssrId:Me}}function O3(a,d){let l=[];for(let m=0;m<d;m++)l.push(m<a?null:Zc);return l}function L3(a){let d=a.tView;return d===null||d.incompleteFirstPass?a.tView=O2(1,null,a.template,a.decls,a.vars,a.directiveDefs,a.pipeDefs,a.viewQuery,a.schemas,a.consts,a.id):d}function ET(a,d,l,m,b,r,M,N,G,fe,Me){let Ue=d.blueprint.slice();return Ue[ea]=b,Ue[Vn]=m|4|128|8|64|1024,(fe!==null||a&&a[Vn]&2048)&&(Ue[Vn]|=2048),mE(Ue),Ue[Wr]=Ue[Pf]=a,Ue[hs]=l,Ue[Ml]=M||a&&a[Ml],Ue[Bo]=N||a&&a[Bo],Ue[Mf]=G||a&&a[Mf]||null,Ue[Cs]=r,Ue[Cg]=h3(),Ue[Sg]=Me,Ue[hE]=fe,Ue[As]=d.type==2?a[As]:Ue,Ue}function k3(a,d,l){let m=Pl(d,a),b=L3(l),r=a[Ml].rendererFactory,M=F2(a,ET(a,b,null,L2(l),m,d,null,r.createRenderer(m,l),null,null,null));return a[d.index]=M}function L2(a){let d=16;return a.signals?d=4096:a.onPush&&(d=64),d}function k2(a,d,l,m){if(l===0)return-1;let b=d.length;for(let r=0;r<l;r++)d.push(m),a.blueprint.push(m),a.data.push(null);return b}function F2(a,d){return a[Rf]?a[dE][Ds]=d:a[Rf]=d,a[dE]=d,d}function TT(a=1){N2(Ua(),ur(),kf()+a,!1)}function N2(a,d,l,m){if(!m)if((d[Vn]&3)===3){let r=a.preOrderCheckHooks;r!==null&&O0(d,r,l)}else{let r=a.preOrderHooks;r!==null&&L0(d,r,0,l)}Gc(l)}var rx=function(a){return a[a.None=0]="None",a[a.SignalBased=1]="SignalBased",a[a.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",a}(rx||{});function KE(a,d,l,m){let b=Ci(null);try{let[r,M,N]=a.inputs[l],G=null;(M&rx.SignalBased)!==0&&(G=d[r][wl]),G!==null&&G.transformFn!==void 0?m=G.transformFn(m):N!==null&&(m=N.call(d,m)),a.setInput!==null?a.setInput(d,G,m,l,r):i2(d,G,r,m)}finally{Ci(b)}}var Ll=function(a){return a[a.Important=1]="Important",a[a.DashCase=2]="DashCase",a}(Ll||{}),F3;function IT(a,d){return F3(a,d)}function Ff(a,d,l,m,b){if(m!=null){let r,M=!1;ta(m)?r=m:Rl(m)&&(M=!0,m=m[ea]);let N=na(m);a===0&&l!==null?b==null?R2(d,l,N):U0(d,l,N,b||null,!0):a===1&&l!==null?U0(d,l,N,b||null,!0):a===2?M3(d,N,M):a===3&&d.destroyNode(N),r!=null&&Z3(d,a,r,l,b)}}function N3(a,d){z2(a,d),d[ea]=null,d[Cs]=null}function z3(a,d,l,m,b,r){m[ea]=b,m[Cs]=d,ox(a,m,l,1,b,r)}function z2(a,d){d[Ml].changeDetectionScheduler?.notify(9),ox(a,d,d[Bo],2,null,null)}function B3(a){let d=a[Rf];if(!d)return zE(a[jn],a);for(;d;){let l=null;if(Rl(d))l=d[Rf];else{let m=d[Vo];m&&(l=m)}if(!l){for(;d&&!d[Ds]&&d!==a;)Rl(d)&&zE(d[jn],d),d=d[Wr];d===null&&(d=a),Rl(d)&&zE(d[jn],d),l=d&&d[Ds]}d=l}}function ST(a,d){let l=a[bd],m=l.indexOf(d);l.splice(m,1)}function B2(a,d){if(Ed(d))return;let l=d[Bo];l.destroyNode&&ox(a,d,l,3,null,null),B3(d)}function zE(a,d){if(Ed(d))return;let l=Ci(null);try{d[Vn]&=-129,d[Vn]|=256,d[fs]&&p1(d[fs]),j3(a,d),V3(a,d),d[jn].type===1&&d[Bo].destroy();let m=d[Uc];if(m!==null&&ta(d[Wr])){m!==d[Wr]&&ST(m,d);let b=d[Va];b!==null&&b.detachView(a)}WE(d)}finally{Ci(l)}}function V3(a,d){let l=a.cleanup,m=d[Dg];if(l!==null)for(let M=0;M<l.length-1;M+=2)if(typeof l[M]=="string"){let N=l[M+3];N>=0?m[N]():m[-N].unsubscribe(),M+=2}else{let N=m[l[M+1]];l[M].call(N)}m!==null&&(d[Dg]=null);let b=d[Sl];if(b!==null){d[Sl]=null;for(let M=0;M<b.length;M++){let N=b[M];N()}}let r=d[Ag];if(r!==null){d[Ag]=null;for(let M of r)M.destroy()}}function j3(a,d){let l;if(a!=null&&(l=a.destroyHooks)!=null)for(let m=0;m<l.length;m+=2){let b=d[l[m]];if(!(b instanceof Id)){let r=l[m+1];if(Array.isArray(r))for(let M=0;M<r.length;M+=2){let N=b[r[M]],G=r[M+1];or(4,N,G);try{G.call(N)}finally{or(5,N,G)}}else{or(4,b,r);try{r.call(b)}finally{or(5,b,r)}}}}}function U3(a,d,l){return H3(a,d.parent,l)}function H3(a,d,l){let m=d;for(;m!==null&&m.type&168;)d=m,m=d.parent;if(m===null)return l[ea];if(wd(m)){let{encapsulation:b}=a.data[m.directiveStart+m.componentOffset];if(b===Ol.None||b===Ol.Emulated)return null}return Pl(m,l)}function $3(a,d,l){return q3(a,d,l)}function G3(a,d,l){return a.type&40?Pl(a,l):null}var q3=G3,NR;function V2(a,d,l,m){let b=U3(a,m,d),r=d[Bo],M=m.parent||d[Cs],N=$3(M,m,d);if(b!=null)if(Array.isArray(l))for(let G=0;G<l.length;G++)FR(r,b,l[G],N,!1);else FR(r,b,l,N,!1);NR!==void 0&&NR(r,m,d,l,b)}function zg(a,d){if(d!==null){let l=d.type;if(l&3)return Pl(d,a);if(l&4)return JE(-1,a[d.index]);if(l&8){let m=d.child;if(m!==null)return zg(a,m);{let b=a[d.index];return ta(b)?JE(-1,b):na(b)}}else{if(l&128)return zg(a,d.next);if(l&32)return IT(d,a)()||na(a[d.index]);{let m=j2(a,d);if(m!==null){if(Array.isArray(m))return m[0];let b=Vc(a[As]);return zg(b,m)}else return zg(a,d.next)}}}return null}function j2(a,d){if(d!==null){let m=a[As][Cs],b=d.projection;return m.projection[b]}return null}function JE(a,d){let l=Vo+a+1;if(l<d.length){let m=d[l],b=m[jn].firstChild;if(b!==null)return zg(m,b)}return d[Hc]}function DT(a,d,l,m,b,r,M){for(;l!=null;){if(l.type===128){l=l.next;continue}let N=m[l.index],G=l.type;if(M&&d===0&&(N&&jg(na(N),m),l.flags|=2),!bT(l))if(G&8)DT(a,d,l.child,m,b,r,!1),Ff(d,a,b,N,r);else if(G&32){let fe=IT(l,m),Me;for(;Me=fe();)Ff(d,a,b,Me,r);Ff(d,a,b,N,r)}else G&16?W3(a,d,m,l,b,r):Ff(d,a,b,N,r);l=M?l.projectionNext:l.next}}function ox(a,d,l,m,b,r){DT(l,m,a.firstChild,d,b,r,!1)}function W3(a,d,l,m,b,r){let M=l[As],G=M[Cs].projection[m.projection];if(Array.isArray(G))for(let fe=0;fe<G.length;fe++){let Me=G[fe];Ff(d,a,b,Me,r)}else{let fe=G,Me=M[Wr];_2(m)&&(fe.flags|=128),DT(a,d,fe,Me,b,r,!0)}}function Z3(a,d,l,m,b){let r=l[Hc],M=na(l);r!==M&&Ff(d,a,m,r,b);for(let N=Vo;N<l.length;N++){let G=l[N];ox(G[jn],G,a,d,m,r)}}function X3(a,d,l,m,b){if(d)b?a.addClass(l,m):a.removeClass(l,m);else{let r=m.indexOf("-")===-1?void 0:Ll.DashCase;b==null?a.removeStyle(l,m,r):(typeof b=="string"&&b.endsWith("!important")&&(b=b.slice(0,-10),r|=Ll.Important),a.setStyle(l,m,b,r))}}function U2(a,d,l,m,b){let r=kf(),M=m&2;try{Gc(-1),M&&d.length>Ms&&N2(a,d,Ms,!1),or(M?2:0,b,l),l(m,b)}finally{Gc(r),or(M?3:1,b,l)}}function H2(a,d,l){iV(a,d,l),(l.flags&64)===64&&rV(a,d,l)}function $2(a,d,l=Pl){let m=d.localNames;if(m!==null){let b=d.index+1;for(let r=0;r<m.length;r+=2){let M=m[r+1],N=M===-1?l(d,a):a[M];a[b++]=N}}}function Y3(a,d,l,m){let r=m.get(T2,E2)||l===Ol.ShadowDom,M=a.selectRootElement(d,r);return K3(M),M}function K3(a){J3(a)}var J3=()=>null;function Q3(a){return a==="class"?"className":a==="for"?"htmlFor":a==="formaction"?"formAction":a==="innerHtml"?"innerHTML":a==="readonly"?"readOnly":a==="tabindex"?"tabIndex":a}function eV(a,d,l,m,b,r){let M=d[jn];if(CT(a,M,d,l,m)){wd(a)&&nV(d,a.index);return}a.type&3&&(l=Q3(l)),tV(a,d,l,m,b,r)}function tV(a,d,l,m,b,r){if(a.type&3){let M=Pl(a,d);m=r!=null?r(m,a.value||"",l):m,b.setProperty(M,l,m)}else a.type&12}function nV(a,d){let l=ja(d,a);l[Vn]&16||(l[Vn]|=64)}function iV(a,d,l){let m=l.directiveStart,b=l.directiveEnd;wd(l)&&k3(d,l,a.data[m+l.componentOffset]),a.firstCreatePass||V0(l,d);let r=l.initialInputs;for(let M=m;M<b;M++){let N=a.data[M],G=Vg(d,a,M,l);if(jg(G,d),r!==null&&aV(d,M-m,G,N,l,r),$c(N)){let fe=ja(l.index,d);fe[hs]=Vg(d,a,M,l)}}}function rV(a,d,l){let m=l.directiveStart,b=l.directiveEnd,r=l.index,M=yR();try{Gc(r);for(let N=m;N<b;N++){let G=a.data[N],fe=d[N];I0(N),(G.hostBindings!==null||G.hostVars!==0||G.hostAttrs!==null)&&oV(G,fe)}}finally{Gc(-1),I0(M)}}function oV(a,d){a.hostBindings!==null&&a.hostBindings(1,d)}function sV(a,d){let l=a.directiveRegistry,m=null;if(l)for(let b=0;b<l.length;b++){let r=l[b];E3(d,r.selectors,!1)&&(m??=[],$c(r)?m.unshift(r):m.push(r))}return m}function aV(a,d,l,m,b,r){let M=r[d];if(M!==null)for(let N=0;N<M.length;N+=2){let G=M[N],fe=M[N+1];KE(m,l,G,fe)}}function G2(a,d,l,m,b){let r=Ms+l,M=d[jn],N=b(M,d,a,m,l);d[r]=N,Lg(a,!0);let G=a.type===2;return G?(P2(d[Bo],N,a),(sR()===0||pE(a))&&jg(N,d),aR()):jg(N,d),AE()&&(!G||!bT(a))&&V2(M,d,N,a),a}function q2(a){let d=a;return wE()?dR():(d=d.parent,Lg(d,!1)),d}function CT(a,d,l,m,b){let r=a.inputs?.[m],M=a.hostDirectiveInputs?.[m],N=!1;if(M)for(let G=0;G<M.length;G+=2){let fe=M[G],Me=M[G+1],Ue=d.data[fe];KE(Ue,l[fe],Me,b),N=!0}if(r)for(let G of r){let fe=l[G],Me=d.data[G];KE(Me,fe,m,b),N=!0}return N}function lV(a,d){let l=ja(d,a),m=l[jn];cV(m,l);let b=l[ea];b!==null&&l[Sg]===null&&(l[Sg]=I2(b,l[Mf])),or(18),AT(m,l,l[hs]),or(19,l[hs])}function cV(a,d){for(let l=d.length;l<a.blueprint.length;l++)d.push(a.blueprint[l])}function AT(a,d,l){D0(d);try{let m=a.viewQuery;m!==null&&XE(1,m,l);let b=a.template;b!==null&&U2(a,d,b,1,l),a.firstCreatePass&&(a.firstCreatePass=!1),d[Va]?.finishViewCreation(a),a.staticContentQueries&&S2(a,d),a.staticViewQueries&&XE(2,a.viewQuery,l);let r=a.components;r!==null&&uV(d,r)}catch(m){throw a.firstCreatePass&&(a.incompleteFirstPass=!0,a.firstCreatePass=!1),m}finally{d[Vn]&=-5,C0()}}function uV(a,d){for(let l=0;l<d.length;l++)lV(a,d[l])}function dV(a,d,l,m){let b=Ci(null);try{let r=d.tView,N=a[Vn]&4096?4096:16,G=ET(a,r,l,N,null,d,null,null,m?.injector??null,m?.embeddedViewInjector??null,m?.dehydratedView??null),fe=a[d.index];G[Uc]=fe;let Me=a[Va];return Me!==null&&(G[Va]=Me.createEmbeddedView(r)),AT(r,G,l),G}finally{Ci(b)}}function zR(a,d){return!d||d.firstChild===null||_2(a)}var BR=!1,hV=new Kt("");function Ug(a,d,l,m,b=!1){for(;l!==null;){if(l.type===128){l=b?l.projectionNext:l.next;continue}let r=d[l.index];r!==null&&m.push(na(r)),ta(r)&&W2(r,m);let M=l.type;if(M&8)Ug(a,d,l.child,m);else if(M&32){let N=IT(l,d),G;for(;G=N();)m.push(G)}else if(M&16){let N=j2(d,l);if(Array.isArray(N))m.push(...N);else{let G=Vc(d[As]);Ug(G[jn],G,N,m,!0)}}l=b?l.projectionNext:l.next}return m}function W2(a,d){for(let l=Vo;l<a.length;l++){let m=a[l],b=m[jn].firstChild;b!==null&&Ug(m[jn],m,b,d)}a[Hc]!==a[ea]&&d.push(a[Hc])}function Z2(a){if(a[xd]!==null){for(let d of a[xd])d.impl.addSequence(d);a[xd].length=0}}var X2=[];function fV(a){return a[fs]??pV(a)}function pV(a){let d=X2.pop()??Object.create(gV);return d.lView=a,d}function mV(a){a.lView[fs]!==a&&(a.lView=null,X2.push(a))}var gV=Vi(Gt({},jv),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:a=>{Lf(a.lView)},consumerOnSignalRead(){this.lView[fs]=this}});function _V(a){let d=a[fs]??Object.create(yV);return d.lView=a,d}var yV=Vi(Gt({},jv),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:a=>{let d=Vc(a.lView);for(;d&&!Y2(d[jn]);)d=Vc(d);d&&gE(d)},consumerOnSignalRead(){this.lView[fs]=this}});function Y2(a){return a.type!==2}function K2(a){if(a[Ag]===null)return;let d=!0;for(;d;){let l=!1;for(let m of a[Ag])m.dirty&&(l=!0,m.zone===null||Zone.current===m.zone?m.run():m.zone.run(()=>m.run()));d=l&&!!(a[Vn]&8192)}}var vV=100;function MT(a,d=0){let m=a[Ml].rendererFactory,b=!1;b||m.begin?.();try{xV(a,d)}finally{b||m.end?.()}}function xV(a,d){let l=TE();try{IE(!0),QE(a,d);let m=0;for(;Pg(a);){if(m===vV)throw new en(103,!1);m++,QE(a,1)}}finally{IE(l)}}function J2(a,d){EE(d?Og.Exhaustive:Og.OnlyDirtyViews);try{MT(a)}finally{EE(Og.Off)}}function bV(a,d,l,m){if(Ed(d))return;let b=d[Vn],r=!1,M=!1;D0(d);let N=!0,G=null,fe=null;r||(Y2(a)?(fe=fV(d),G=Hv(fe)):Vv()===null?(N=!1,fe=_V(d),G=Hv(fe)):d[fs]&&(p1(d[fs]),d[fs]=null));try{mE(d),fR(a.bindingStartIndex),l!==null&&U2(a,d,l,2,m);let Me=(b&3)===3;if(!r)if(Me){let Fe=a.preOrderCheckHooks;Fe!==null&&O0(d,Fe,null)}else{let Fe=a.preOrderHooks;Fe!==null&&L0(d,Fe,0,null),FE(d,0)}if(M||wV(d),K2(d),Q2(d,0),a.contentQueries!==null&&S2(a,d),!r)if(Me){let Fe=a.contentCheckHooks;Fe!==null&&O0(d,Fe)}else{let Fe=a.contentHooks;Fe!==null&&L0(d,Fe,1),FE(d,1)}TV(a,d);let Ue=a.components;Ue!==null&&tP(d,Ue,0);let bt=a.viewQuery;if(bt!==null&&XE(2,bt,m),!r)if(Me){let Fe=a.viewCheckHooks;Fe!==null&&O0(d,Fe)}else{let Fe=a.viewHooks;Fe!==null&&L0(d,Fe,2),FE(d,2)}if(a.firstUpdatePass===!0&&(a.firstUpdatePass=!1),d[b0]){for(let Fe of d[b0])Fe();d[b0]=null}r||(Z2(d),d[Vn]&=-73)}catch(Me){throw r||Lf(d),Me}finally{fe!==null&&(f1(fe,G),N&&mV(fe)),C0()}}function Q2(a,d){for(let l=v2(a);l!==null;l=x2(l))for(let m=Vo;m<l.length;m++){let b=l[m];eP(b,d)}}function wV(a){for(let d=v2(a);d!==null;d=x2(d)){if(!(d[Vn]&2))continue;let l=d[bd];for(let m=0;m<l.length;m++){let b=l[m];gE(b)}}}function EV(a,d,l){or(18);let m=ja(d,a);eP(m,l),or(19,m[hs])}function eP(a,d){E0(a)&&QE(a,d)}function QE(a,d){let m=a[jn],b=a[Vn],r=a[fs],M=!!(d===0&&b&16);if(M||=!!(b&64&&d===0),M||=!!(b&1024),M||=!!(r?.dirty&&$v(r)),M||=!1,r&&(r.dirty=!1),a[Vn]&=-9217,M)bV(m,a,m.template,a[hs]);else if(b&8192){let N=Ci(null);try{K2(a),Q2(a,1);let G=m.components;G!==null&&tP(a,G,1),Z2(a)}finally{Ci(N)}}}function tP(a,d,l){for(let m=0;m<d.length;m++)EV(a,d[m],l)}function TV(a,d){let l=a.hostBindingOpCodes;if(l!==null)try{for(let m=0;m<l.length;m++){let b=l[m];if(b<0)Gc(~b);else{let r=b,M=l[++m],N=l[++m];_R(M,r);let G=d[r];or(24,G),N(2,G),or(25,G)}}}finally{Gc(-1)}}function nP(a,d){let l=TE()?64:1088;for(a[Ml].changeDetectionScheduler?.notify(d);a;){a[Vn]|=l;let m=Vc(a);if(Of(a)&&!m)return a;a=m}return null}function IV(a,d,l,m){return[a,!0,0,d,null,m,null,l,null,null]}function SV(a,d,l,m=!0){let b=d[jn];if(DV(b,d,a,l),m){let M=JE(l,a),N=d[Bo],G=N.parentNode(a[Hc]);G!==null&&z3(b,a[Cs],N,d,G,M)}let r=d[Sg];r!==null&&r.firstChild!==null&&(r.firstChild=null)}function eT(a,d){if(a.length<=Vo)return;let l=Vo+d,m=a[l];if(m){let b=m[Uc];b!==null&&b!==a&&ST(b,m),d>0&&(a[l-1][Ds]=m[Ds]);let r=Eg(a,Vo+d);N3(m[jn],m);let M=r[Va];M!==null&&M.detachView(r[jn]),m[Wr]=null,m[Ds]=null,m[Vn]&=-129}return m}function DV(a,d,l,m){let b=Vo+m,r=l.length;m>0&&(l[b-1][Ds]=d),m<r-Vo?(d[Ds]=l[b],tE(l,Vo+m,d)):(l.push(d),d[Ds]=null),d[Wr]=l;let M=d[Uc];M!==null&&l!==M&&iP(M,d);let N=d[Va];N!==null&&N.insertView(a),T0(d),d[Vn]|=128}function iP(a,d){let l=a[bd],m=d[Wr];if(Rl(m))a[Vn]|=2;else{let b=m[Wr][As];d[As]!==b&&(a[Vn]|=2)}l===null?a[bd]=[d]:l.push(d)}var qc=class{_lView;_cdRefInjectingView;_appRef=null;_attachedToViewContainer=!1;exhaustive;get rootNodes(){let d=this._lView,l=d[jn];return Ug(l,d,l.firstChild,[])}constructor(d,l){this._lView=d,this._cdRefInjectingView=l}get context(){return this._lView[hs]}set context(d){this._lView[hs]=d}get destroyed(){return Ed(this._lView)}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let d=this._lView[Wr];if(ta(d)){let l=d[Mg],m=l?l.indexOf(this):-1;m>-1&&(eT(d,m),Eg(l,m))}this._attachedToViewContainer=!1}B2(this._lView[jn],this._lView)}onDestroy(d){_E(this._lView,d)}markForCheck(){nP(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[Vn]&=-129}reattach(){T0(this._lView),this._lView[Vn]|=128}detectChanges(){this._lView[Vn]|=1024,MT(this._lView)}checkNoChanges(){return;try{this.exhaustive??=this._lView[Mf].get(hV,BR)}catch{this.exhaustive=BR}}attachToViewContainerRef(){if(this._appRef)throw new en(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let d=Of(this._lView),l=this._lView[Uc];l!==null&&!d&&ST(l,this._lView),z2(this._lView[jn],this._lView)}attachToAppRef(d){if(this._attachedToViewContainer)throw new en(902,!1);this._appRef=d;let l=Of(this._lView),m=this._lView[Uc];m!==null&&!l&&iP(m,this._lView),T0(this._lView)}};var zf=(()=>{class a{_declarationLView;_declarationTContainer;elementRef;static __NG_ELEMENT_ID__=CV;constructor(l,m,b){this._declarationLView=l,this._declarationTContainer=m,this.elementRef=b}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(l,m){return this.createEmbeddedViewImpl(l,m)}createEmbeddedViewImpl(l,m,b){let r=dV(this._declarationLView,this._declarationTContainer,l,{embeddedViewInjector:m,dehydratedView:b});return new qc(r)}}return a})();function CV(){return RT(ps(),ur())}function RT(a,d){return a.type&4?new zf(d,a,jf(a,d)):null}function PT(a,d,l,m,b){let r=a.data[d];if(r===null)r=AV(a,d,l,m,b),gR()&&(r.flags|=32);else if(r.type&64){r.type=l,r.value=m,r.attrs=b;let M=uR();r.injectorIndex=M===null?-1:M.injectorIndex}return Lg(r,!0),r}function AV(a,d,l,m,b){let r=bE(),M=wE(),N=M?r:r&&r.parent,G=a.data[d]=RV(a,N,l,d,m,b);return MV(a,G,r,M),G}function MV(a,d,l,m){a.firstChild===null&&(a.firstChild=d),l!==null&&(m?l.child==null&&d.parent!==null&&(l.child=d):l.next===null&&(l.next=d,d.prev=l))}function RV(a,d,l,m,b,r){let M=d?d.injectorIndex:-1,N=0;return cR()&&(N|=128),{type:l,index:m,insertBeforeIndex:null,injectorIndex:M,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:N,providerIndexes:0,value:b,attrs:r,mergedAttrs:null,localNames:null,initialInputs:null,inputs:null,hostDirectiveInputs:null,outputs:null,hostDirectiveOutputs:null,directiveToIndex:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:d,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}var VZ=new RegExp(`^(\\d+)*(${g3}|${m3})*(.*)`);var PV=()=>null;function VR(a,d){return PV(a,d)}var rP=class{},sx=class{},tT=class{resolveComponentFactory(d){throw new en(917,!1)}},Zg=class{static NULL=new tT},Sd=class{};var oP=(()=>{class a{static \u0275prov=Xt({token:a,providedIn:"root",factory:()=>null})}return a})();var F0={},nT=class{injector;parentInjector;constructor(d,l){this.injector=d,this.parentInjector=l}get(d,l,m){let b=this.injector.get(d,F0,m);return b!==F0||l===F0?b:this.parentInjector.get(d,l,m)}};function H0(a,d,l){let m=l?a.styles:null,b=l?a.classes:null,r=0;if(d!==null)for(let M=0;M<d.length;M++){let N=d[M];if(typeof N=="number")r=N;else if(r==1)b=m0(b,N);else if(r==2){let G=N,fe=d[++M];m=m0(m,G+": "+fe+";")}}l?a.styles=m:a.stylesWithoutHost=m,l?a.classes=b:a.classesWithoutHost=b}function Xc(a,d=0){let l=ur();if(l===null)return un(a,d);let m=ps();return p2(m,l,so(a),d)}function OT(){let a="invalid";throw new Error(a)}function OV(a,d,l,m,b){let r=m===null?null:{"":-1},M=b(a,l);if(M!==null){let N=M,G=null,fe=null;for(let Me of M)if(Me.resolveHostDirectives!==null){[N,G,fe]=Me.resolveHostDirectives(M);break}FV(a,d,l,N,r,G,fe)}r!==null&&m!==null&&LV(l,m,r)}function LV(a,d,l){let m=a.localNames=[];for(let b=0;b<d.length;b+=2){let r=l[d[b+1]];if(r==null)throw new en(-301,!1);m.push(d[b],r)}}function kV(a,d,l){d.componentOffset=l,(a.components??=[]).push(d.index)}function FV(a,d,l,m,b,r,M){let N=m.length,G=!1;for(let bt=0;bt<N;bt++){let Fe=m[bt];!G&&$c(Fe)&&(G=!0,kV(a,l,bt)),GE(V0(l,d),a,Fe.type)}UV(l,a.data.length,N);for(let bt=0;bt<N;bt++){let Fe=m[bt];Fe.providersResolver&&Fe.providersResolver(Fe)}let fe=!1,Me=!1,Ue=k2(a,d,N,null);N>0&&(l.directiveToIndex=new Map);for(let bt=0;bt<N;bt++){let Fe=m[bt];if(l.mergedAttrs=_T(l.mergedAttrs,Fe.hostAttrs),zV(a,l,d,Ue,Fe),jV(Ue,Fe,b),M!==null&&M.has(Fe)){let[Vt,jt]=M.get(Fe);l.directiveToIndex.set(Fe.type,[Ue,Vt+l.directiveStart,jt+l.directiveStart])}else(r===null||!r.has(Fe))&&l.directiveToIndex.set(Fe.type,Ue);Fe.contentQueries!==null&&(l.flags|=4),(Fe.hostBindings!==null||Fe.hostAttrs!==null||Fe.hostVars!==0)&&(l.flags|=64);let Pt=Fe.type.prototype;!fe&&(Pt.ngOnChanges||Pt.ngOnInit||Pt.ngDoCheck)&&((a.preOrderHooks??=[]).push(l.index),fe=!0),!Me&&(Pt.ngOnChanges||Pt.ngDoCheck)&&((a.preOrderCheckHooks??=[]).push(l.index),Me=!0),Ue++}NV(a,l,r)}function NV(a,d,l){for(let m=d.directiveStart;m<d.directiveEnd;m++){let b=a.data[m];if(l===null||!l.has(b))jR(0,d,b,m),jR(1,d,b,m),HR(d,m,!1);else{let r=l.get(b);UR(0,d,r,m),UR(1,d,r,m),HR(d,m,!0)}}}function jR(a,d,l,m){let b=a===0?l.inputs:l.outputs;for(let r in b)if(b.hasOwnProperty(r)){let M;a===0?M=d.inputs??={}:M=d.outputs??={},M[r]??=[],M[r].push(m),sP(d,r)}}function UR(a,d,l,m){let b=a===0?l.inputs:l.outputs;for(let r in b)if(b.hasOwnProperty(r)){let M=b[r],N;a===0?N=d.hostDirectiveInputs??={}:N=d.hostDirectiveOutputs??={},N[M]??=[],N[M].push(m,r),sP(d,M)}}function sP(a,d){d==="class"?a.flags|=8:d==="style"&&(a.flags|=16)}function HR(a,d,l){let{attrs:m,inputs:b,hostDirectiveInputs:r}=a;if(m===null||!l&&b===null||l&&r===null||wT(a)){a.initialInputs??=[],a.initialInputs.push(null);return}let M=null,N=0;for(;N<m.length;){let G=m[N];if(G===0){N+=4;continue}else if(G===5){N+=2;continue}else if(typeof G=="number")break;if(!l&&b.hasOwnProperty(G)){let fe=b[G];for(let Me of fe)if(Me===d){M??=[],M.push(G,m[N+1]);break}}else if(l&&r.hasOwnProperty(G)){let fe=r[G];for(let Me=0;Me<fe.length;Me+=2)if(fe[Me]===d){M??=[],M.push(fe[Me+1],m[N+1]);break}}N+=2}a.initialInputs??=[],a.initialInputs.push(M)}function zV(a,d,l,m,b){a.data[m]=b;let r=b.factory||(b.factory=fd(b.type,!0)),M=new Id(r,$c(b),Xc,null);a.blueprint[m]=M,l[m]=M,BV(a,d,m,k2(a,l,b.hostVars,Zc),b)}function BV(a,d,l,m,b){let r=b.hostBindings;if(r){let M=a.hostBindingOpCodes;M===null&&(M=a.hostBindingOpCodes=[]);let N=~d.index;VV(M)!=N&&M.push(N),M.push(l,m,r)}}function VV(a){let d=a.length;for(;d>0;){let l=a[--d];if(typeof l=="number"&&l<0)return l}return 0}function jV(a,d,l){if(l){if(d.exportAs)for(let m=0;m<d.exportAs.length;m++)l[d.exportAs[m]]=a;$c(d)&&(l[""]=a)}}function UV(a,d,l){a.flags|=1,a.directiveStart=d,a.directiveEnd=d+l,a.providerIndexes=d}function aP(a,d,l,m,b,r,M,N){let G=d[jn],fe=G.consts,Me=Rg(fe,M),Ue=PT(G,a,l,m,Me);return r&&OV(G,d,Ue,Rg(fe,N),b),Ue.mergedAttrs=_T(Ue.mergedAttrs,Ue.attrs),Ue.attrs!==null&&H0(Ue,Ue.attrs,!1),Ue.mergedAttrs!==null&&H0(Ue,Ue.mergedAttrs,!0),G.queries!==null&&G.queries.elementStart(G,Ue),Ue}function lP(a,d){WB(a,d),fE(d)&&a.queries.elementEnd(d)}function HV(a,d,l,m,b,r){let M=d.consts,N=Rg(M,b),G=PT(d,a,l,m,N);if(G.mergedAttrs=_T(G.mergedAttrs,G.attrs),r!=null){let fe=Rg(M,r);G.localNames=[];for(let Me=0;Me<fe.length;Me+=2)G.localNames.push(fe[Me],-1)}return G.attrs!==null&&H0(G,G.attrs,!1),G.mergedAttrs!==null&&H0(G,G.mergedAttrs,!0),d.queries!==null&&d.queries.elementStart(d,G),G}function $V(a,d,l){return a[d]=l}function LT(a,d,l){if(l===Zc)return!1;let m=a[d];return Object.is(m,l)?!1:(a[d]=l,!0)}var iT=Symbol("BINDING");var $0=class extends Zg{ngModule;constructor(d){super(),this.ngModule=d}resolveComponentFactory(d){let l=Al(d);return new Dd(l,this.ngModule)}};function GV(a){return Object.keys(a).map(d=>{let[l,m,b]=a[d],r={propName:l,templateName:d,isSignal:(m&rx.SignalBased)!==0};return b&&(r.transform=b),r})}function qV(a){return Object.keys(a).map(d=>({propName:a[d],templateName:d}))}function WV(a,d,l){let m=d instanceof wr?d:d?.injector;return m&&a.getStandaloneInjector!==null&&(m=a.getStandaloneInjector(m)||m),m?new nT(l,m):l}function ZV(a){let d=a.get(Sd,null);if(d===null)throw new en(407,!1);let l=a.get(oP,null),m=a.get(Dl,null);return{rendererFactory:d,sanitizer:l,changeDetectionScheduler:m,ngReflect:!1}}function XV(a,d){let l=(a.selectors[0][0]||"div").toLowerCase();return M2(d,l,l==="svg"?KM:l==="math"?JM:null)}var Dd=class extends sx{componentDef;ngModule;selector;componentType;ngContentSelectors;isBoundToModule;cachedInputs=null;cachedOutputs=null;get inputs(){return this.cachedInputs??=GV(this.componentDef.inputs),this.cachedInputs}get outputs(){return this.cachedOutputs??=qV(this.componentDef.outputs),this.cachedOutputs}constructor(d,l){super(),this.componentDef=d,this.ngModule=l,this.componentType=d.type,this.selector=D3(d.selectors),this.ngContentSelectors=d.ngContentSelectors??[],this.isBoundToModule=!!l}create(d,l,m,b,r,M){or(22);let N=Ci(null);try{let G=this.componentDef,fe=YV(m,G,M,r),Me=WV(G,b||this.ngModule,d),Ue=ZV(Me),bt=Ue.rendererFactory.createRenderer(null,G),Fe=m?Y3(bt,m,G.encapsulation,Me):XV(G,bt),Pt=M?.some($R)||r?.some(Nt=>typeof Nt!="function"&&Nt.bindings.some($R)),Vt=ET(null,fe,null,512|L2(G),null,null,Ue,bt,Me,null,I2(Fe,Me,!0));Vt[Ms]=Fe,D0(Vt);let jt=null;try{let Nt=aP(Ms,Vt,2,"#host",()=>fe.directiveRegistry,!0,0);Fe&&(P2(bt,Fe,Nt),jg(Fe,Vt)),H2(fe,Vt,Nt),D2(fe,Nt,Vt),lP(fe,Nt),l!==void 0&&JV(Nt,this.ngContentSelectors,l),jt=ja(Nt.index,Vt),Vt[hs]=jt[hs],AT(fe,Vt,null)}catch(Nt){throw jt!==null&&WE(jt),WE(Vt),Nt}finally{or(23),C0()}return new G0(this.componentType,Vt,!!Pt)}finally{Ci(N)}}};function YV(a,d,l,m){let b=a?["ng-version","20.1.6"]:C3(d.selectors[0]),r=null,M=null,N=0;if(l)for(let Me of l)N+=Me[iT].requiredVars,Me.create&&(Me.targetIdx=0,(r??=[]).push(Me)),Me.update&&(Me.targetIdx=0,(M??=[]).push(Me));if(m)for(let Me=0;Me<m.length;Me++){let Ue=m[Me];if(typeof Ue!="function")for(let bt of Ue.bindings){N+=bt[iT].requiredVars;let Fe=Me+1;bt.create&&(bt.targetIdx=Fe,(r??=[]).push(bt)),bt.update&&(bt.targetIdx=Fe,(M??=[]).push(bt))}}let G=[d];if(m)for(let Me of m){let Ue=typeof Me=="function"?Me:Me.type,bt=sE(Ue);G.push(bt)}return O2(0,null,KV(r,M),1,N,G,null,null,null,[b],null)}function KV(a,d){return!a&&!d?null:l=>{if(l&1&&a)for(let m of a)m.create();if(l&2&&d)for(let m of d)m.update()}}function $R(a){let d=a[iT].kind;return d==="input"||d==="twoWay"}var G0=class extends rP{_rootLView;_hasInputBindings;instance;hostView;changeDetectorRef;componentType;location;previousInputValues=null;_tNode;constructor(d,l,m){super(),this._rootLView=l,this._hasInputBindings=m,this._tNode=w0(l[jn],Ms),this.location=jf(this._tNode,l),this.instance=ja(this._tNode.index,l)[hs],this.hostView=this.changeDetectorRef=new qc(l,void 0),this.componentType=d}setInput(d,l){this._hasInputBindings;let m=this._tNode;if(this.previousInputValues??=new Map,this.previousInputValues.has(d)&&Object.is(this.previousInputValues.get(d),l))return;let b=this._rootLView,r=CT(m,b[jn],b,d,l);this.previousInputValues.set(d,l);let M=ja(m.index,b);nP(M,1)}get injector(){return new Td(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(d){this.hostView.onDestroy(d)}};function JV(a,d,l){let m=a.projection=[];for(let b=0;b<d.length;b++){let r=l[b];m.push(r!=null&&r.length?Array.from(r):null)}}var Md=(()=>{class a{static __NG_ELEMENT_ID__=QV}return a})();function QV(){let a=ps();return uP(a,ur())}var ej=Md,cP=class extends ej{_lContainer;_hostTNode;_hostLView;constructor(d,l,m){super(),this._lContainer=d,this._hostTNode=l,this._hostLView=m}get element(){return jf(this._hostTNode,this._hostLView)}get injector(){return new Td(this._hostTNode,this._hostLView)}get parentInjector(){let d=yT(this._hostTNode,this._hostLView);if(l2(d)){let l=B0(d,this._hostLView),m=z0(d),b=l[jn].data[m+8];return new Td(b,l)}else return new Td(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(d){let l=GR(this._lContainer);return l!==null&&l[d]||null}get length(){return this._lContainer.length-Vo}createEmbeddedView(d,l,m){let b,r;typeof m=="number"?b=m:m!=null&&(b=m.index,r=m.injector);let M=VR(this._lContainer,d.ssrId),N=d.createEmbeddedViewImpl(l||{},r,M);return this.insertImpl(N,b,zR(this._hostTNode,M)),N}createComponent(d,l,m,b,r,M,N){let G=d&&!UB(d),fe;if(G)fe=l;else{let jt=l||{};fe=jt.index,m=jt.injector,b=jt.projectableNodes,r=jt.environmentInjector||jt.ngModuleRef,M=jt.directives,N=jt.bindings}let Me=G?d:new Dd(Al(d)),Ue=m||this.parentInjector;if(!r&&Me.ngModule==null){let Nt=(G?Ue:this.parentInjector).get(wr,null);Nt&&(r=Nt)}let bt=Al(Me.componentType??{}),Fe=VR(this._lContainer,bt?.id??null),Pt=Fe?.firstChild??null,Vt=Me.create(Ue,b,Pt,r,M,N);return this.insertImpl(Vt.hostView,fe,zR(this._hostTNode,Fe)),Vt}insert(d,l){return this.insertImpl(d,l,!0)}insertImpl(d,l,m){let b=d._lView;if(tR(b)){let N=this.indexOf(d);if(N!==-1)this.detach(N);else{let G=b[Wr],fe=new cP(G,G[Cs],G[Wr]);fe.detach(fe.indexOf(d))}}let r=this._adjustIndex(l),M=this._lContainer;return SV(M,b,r,m),d.attachToViewContainerRef(),tE(BE(M),r,d),d}move(d,l){return this.insert(d,l)}indexOf(d){let l=GR(this._lContainer);return l!==null?l.indexOf(d):-1}remove(d){let l=this._adjustIndex(d,-1),m=eT(this._lContainer,l);m&&(Eg(BE(this._lContainer),l),B2(m[jn],m))}detach(d){let l=this._adjustIndex(d,-1),m=eT(this._lContainer,l);return m&&Eg(BE(this._lContainer),l)!=null?new qc(m):null}_adjustIndex(d,l=0){return d??this.length+l}};function GR(a){return a[Mg]}function BE(a){return a[Mg]||(a[Mg]=[])}function uP(a,d){let l,m=d[a.index];return ta(m)?l=m:(l=IV(m,d,null,a),d[a.index]=l,F2(d,l)),nj(l,d,a,m),new cP(l,a,d)}function tj(a,d){let l=a[Bo],m=l.createComment(""),b=Pl(d,a),r=l.parentNode(b);return U0(l,r,m,l.nextSibling(b),!1),m}var nj=ij;function ij(a,d,l,m){if(a[Hc])return;let b;l.type&8?b=na(m):b=tj(d,l),a[Hc]=b}var rT=class a{queryList;matches=null;constructor(d){this.queryList=d}clone(){return new a(this.queryList)}setDirty(){this.queryList.setDirty()}},oT=class a{queries;constructor(d=[]){this.queries=d}createEmbeddedView(d){let l=d.queries;if(l!==null){let m=d.contentQueries!==null?d.contentQueries[0]:l.length,b=[];for(let r=0;r<m;r++){let M=l.getByIndex(r),N=this.queries[M.indexInDeclarationView];b.push(N.clone())}return new a(b)}return null}insertView(d){this.dirtyQueriesWithMatches(d)}detachView(d){this.dirtyQueriesWithMatches(d)}finishViewCreation(d){this.dirtyQueriesWithMatches(d)}dirtyQueriesWithMatches(d){for(let l=0;l<this.queries.length;l++)kT(d,l).matches!==null&&this.queries[l].setDirty()}},sT=class{flags;read;predicate;constructor(d,l,m=null){this.flags=l,this.read=m,typeof d=="string"?this.predicate=dj(d):this.predicate=d}},aT=class a{queries;constructor(d=[]){this.queries=d}elementStart(d,l){for(let m=0;m<this.queries.length;m++)this.queries[m].elementStart(d,l)}elementEnd(d){for(let l=0;l<this.queries.length;l++)this.queries[l].elementEnd(d)}embeddedTView(d){let l=null;for(let m=0;m<this.length;m++){let b=l!==null?l.length:0,r=this.getByIndex(m).embeddedTView(d,b);r&&(r.indexInDeclarationView=m,l!==null?l.push(r):l=[r])}return l!==null?new a(l):null}template(d,l){for(let m=0;m<this.queries.length;m++)this.queries[m].template(d,l)}getByIndex(d){return this.queries[d]}get length(){return this.queries.length}track(d){this.queries.push(d)}},lT=class a{metadata;matches=null;indexInDeclarationView=-1;crossesNgTemplate=!1;_declarationNodeIndex;_appliesToNextNode=!0;constructor(d,l=-1){this.metadata=d,this._declarationNodeIndex=l}elementStart(d,l){this.isApplyingToNode(l)&&this.matchTNode(d,l)}elementEnd(d){this._declarationNodeIndex===d.index&&(this._appliesToNextNode=!1)}template(d,l){this.elementStart(d,l)}embeddedTView(d,l){return this.isApplyingToNode(d)?(this.crossesNgTemplate=!0,this.addMatch(-d.index,l),new a(this.metadata)):null}isApplyingToNode(d){if(this._appliesToNextNode&&(this.metadata.flags&1)!==1){let l=this._declarationNodeIndex,m=d.parent;for(;m!==null&&m.type&8&&m.index!==l;)m=m.parent;return l===(m!==null?m.index:-1)}return this._appliesToNextNode}matchTNode(d,l){let m=this.metadata.predicate;if(Array.isArray(m))for(let b=0;b<m.length;b++){let r=m[b];this.matchTNodeWithReadOption(d,l,rj(l,r)),this.matchTNodeWithReadOption(d,l,k0(l,d,r,!1,!1))}else m===zf?l.type&4&&this.matchTNodeWithReadOption(d,l,-1):this.matchTNodeWithReadOption(d,l,k0(l,d,m,!1,!1))}matchTNodeWithReadOption(d,l,m){if(m!==null){let b=this.metadata.read;if(b!==null)if(b===Wc||b===Md||b===zf&&l.type&4)this.addMatch(l.index,-2);else{let r=k0(l,d,b,!1,!1);r!==null&&this.addMatch(l.index,r)}else this.addMatch(l.index,m)}}addMatch(d,l){this.matches===null?this.matches=[d,l]:this.matches.push(d,l)}};function rj(a,d){let l=a.localNames;if(l!==null){for(let m=0;m<l.length;m+=2)if(l[m]===d)return l[m+1]}return null}function oj(a,d){return a.type&11?jf(a,d):a.type&4?RT(a,d):null}function sj(a,d,l,m){return l===-1?oj(d,a):l===-2?aj(a,d,m):Vg(a,a[jn],l,d)}function aj(a,d,l){if(l===Wc)return jf(d,a);if(l===zf)return RT(d,a);if(l===Md)return uP(d,a)}function dP(a,d,l,m){let b=d[Va].queries[m];if(b.matches===null){let r=a.data,M=l.matches,N=[];for(let G=0;M!==null&&G<M.length;G+=2){let fe=M[G];if(fe<0)N.push(null);else{let Me=r[fe];N.push(sj(d,Me,M[G+1],l.metadata.read))}}b.matches=N}return b.matches}function cT(a,d,l,m){let b=a.queries.getByIndex(l),r=b.matches;if(r!==null){let M=dP(a,d,b,l);for(let N=0;N<r.length;N+=2){let G=r[N];if(G>0)m.push(M[N/2]);else{let fe=r[N+1],Me=d[-G];for(let Ue=Vo;Ue<Me.length;Ue++){let bt=Me[Ue];bt[Uc]===bt[Wr]&&cT(bt[jn],bt,fe,m)}if(Me[bd]!==null){let Ue=Me[bd];for(let bt=0;bt<Ue.length;bt++){let Fe=Ue[bt];cT(Fe[jn],Fe,fe,m)}}}}}return m}function lj(a,d){return a[Va].queries[d].queryList}function cj(a,d,l){let m=new j0((l&4)===4);return oR(a,d,m,m.destroy),(d[Va]??=new oT).queries.push(new rT(m))-1}function uj(a,d,l){let m=Ua();return m.firstCreatePass&&(hj(m,new sT(a,d,l),-1),(d&2)===2&&(m.staticViewQueries=!0)),cj(m,ur(),d)}function dj(a){return a.split(",").map(d=>d.trim())}function hj(a,d,l){a.queries===null&&(a.queries=new aT),a.queries.track(new lT(d,l))}function kT(a,d){return a.queries.getByIndex(d)}function fj(a,d){let l=a[jn],m=kT(l,d);return m.crossesNgTemplate?cT(l,a,d,[]):dP(l,a,m,d)}function hP(a){let d=[],l=new Map;function m(b){let r=l.get(b);if(!r){let M=a(b);l.set(b,r=M.then(N=>mj(b,N)))}return r}return q0.forEach((b,r)=>{let M=[];b.templateUrl&&M.push(m(b.templateUrl).then(fe=>{b.template=fe}));let N=typeof b.styles=="string"?[b.styles]:b.styles||[];if(b.styles=N,b.styleUrl&&b.styleUrls?.length)throw new Error("@Component cannot define both `styleUrl` and `styleUrls`. Use `styleUrl` if the component has one stylesheet, or `styleUrls` if it has multiple");if(b.styleUrls?.length){let fe=b.styles.length,Me=b.styleUrls;b.styleUrls.forEach((Ue,bt)=>{N.push(""),M.push(m(Ue).then(Fe=>{N[fe+bt]=Fe,Me.splice(Me.indexOf(Ue),1),Me.length==0&&(b.styleUrls=void 0)}))})}else b.styleUrl&&M.push(m(b.styleUrl).then(fe=>{N.push(fe),b.styleUrl=void 0}));let G=Promise.all(M).then(()=>gj(r));d.push(G)}),fP(),Promise.all(d).then(()=>{})}var q0=new Map,pj=new Set;function fP(){let a=q0;return q0=new Map,a}function pP(){return q0.size===0}function mj(a,d){return typeof d=="string"?d:d.status!==void 0&&d.status!==200?Promise.reject(new en(918,!1)):d.text()}function gj(a){pj.delete(a)}var qR=new Set;function Rd(a){qR.has(a)||(qR.add(a),performance?.mark?.("mark_feature_usage",{detail:{feature:a}}))}var Bf=class{},ax=class{};var Hg=class extends Bf{ngModuleType;_parent;_bootstrapComponents=[];_r3Injector;instance;destroyCbs=[];componentFactoryResolver=new $0(this);constructor(d,l,m,b=!0){super(),this.ngModuleType=d,this._parent=l;let r=oE(d);this._bootstrapComponents=C2(r.bootstrap),this._r3Injector=RE(d,l,[{provide:Bf,useValue:this},{provide:Zg,useValue:this.componentFactoryResolver},...m],Bc(d),new Set(["environment"])),b&&this.resolveInjectorInitializers()}resolveInjectorInitializers(){this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(this.ngModuleType)}get injector(){return this._r3Injector}destroy(){let d=this._r3Injector;!d.destroyed&&d.destroy(),this.destroyCbs.forEach(l=>l()),this.destroyCbs=null}onDestroy(d){this.destroyCbs.push(d)}},$g=class extends ax{moduleType;constructor(d){super(),this.moduleType=d}create(d){return new Hg(this.moduleType,d,[])}};function mP(a,d,l){return new Hg(a,d,l,!1)}var W0=class extends Bf{injector;componentFactoryResolver=new $0(this);instance=null;constructor(d){super();let l=new md([...d.providers,{provide:Bf,useValue:this},{provide:Zg,useValue:this.componentFactoryResolver}],d.parent||Ig(),d.debugName,new Set(["environment"]));this.injector=l,d.runEnvironmentInitializers&&l.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(d){this.injector.onDestroy(d)}};function Hf(a,d,l=null){return new W0({providers:a,parent:d,debugName:l,runEnvironmentInitializers:!0}).injector}var _j=(()=>{class a{_injector;cachedInjectors=new Map;constructor(l){this._injector=l}getOrCreateStandaloneInjector(l){if(!l.standalone)return null;if(!this.cachedInjectors.has(l)){let m=aE(!1,l.type),b=m.length>0?Hf([m],this._injector,`Standalone[${l.type.name}]`):null;this.cachedInjectors.set(l,b)}return this.cachedInjectors.get(l)}ngOnDestroy(){try{for(let l of this.cachedInjectors.values())l!==null&&l.destroy()}finally{this.cachedInjectors.clear()}}static \u0275prov=Xt({token:a,providedIn:"environment",factory:()=>new a(un(wr))})}return a})();function Pd(a){return Wg(()=>{let d=gP(a),l=Vi(Gt({},d),{decls:a.decls,vars:a.vars,template:a.template,consts:a.consts||null,ngContentSelectors:a.ngContentSelectors,onPush:a.changeDetection===vT.OnPush,directiveDefs:null,pipeDefs:null,dependencies:d.standalone&&a.dependencies||null,getStandaloneInjector:d.standalone?b=>b.get(_j).getOrCreateStandaloneInjector(l):null,getExternalStyles:null,signals:a.signals??!1,data:a.data||{},encapsulation:a.encapsulation||Ol.Emulated,styles:a.styles||ns,_:null,schemas:a.schemas||null,tView:null,id:""});d.standalone&&Rd("NgStandalone"),_P(l);let m=a.dependencies;return l.directiveDefs=WR(m,yj),l.pipeDefs=WR(m,$M),l.id=bj(l),l})}function yj(a){return Al(a)||sE(a)}function Uo(a){return Wg(()=>({type:a.type,bootstrap:a.bootstrap||ns,declarations:a.declarations||ns,imports:a.imports||ns,exports:a.exports||ns,transitiveCompileScopes:null,schemas:a.schemas||null,id:a.id||null}))}function vj(a,d){if(a==null)return yd;let l={};for(let m in a)if(a.hasOwnProperty(m)){let b=a[m],r,M,N,G;Array.isArray(b)?(N=b[0],r=b[1],M=b[2]??r,G=b[3]||null):(r=b,M=b,N=rx.None,G=null),l[r]=[m,N,G],d[r]=M}return l}function xj(a){if(a==null)return yd;let d={};for(let l in a)a.hasOwnProperty(l)&&(d[a[l]]=l);return d}function Xg(a){return Wg(()=>{let d=gP(a);return _P(d),d})}function gP(a){let d={};return{type:a.type,providersResolver:null,factory:null,hostBindings:a.hostBindings||null,hostVars:a.hostVars||0,hostAttrs:a.hostAttrs||null,contentQueries:a.contentQueries||null,declaredInputs:d,inputConfig:a.inputs||yd,exportAs:a.exportAs||null,standalone:a.standalone??!0,signals:a.signals===!0,selectors:a.selectors||ns,viewQuery:a.viewQuery||null,features:a.features||null,setInput:null,resolveHostDirectives:null,hostDirectives:null,inputs:vj(a.inputs,d),outputs:xj(a.outputs),debugInfo:null}}function _P(a){a.features?.forEach(d=>d(a))}function WR(a,d){return a?()=>{let l=typeof a=="function"?a():a,m=[];for(let b of l){let r=d(b);r!==null&&m.push(r)}return m}:null}function bj(a){let d=0,l=typeof a.consts=="function"?"":a.consts,m=[a.selectors,a.ngContentSelectors,a.hostVars,a.hostAttrs,l,a.vars,a.decls,a.encapsulation,a.standalone,a.signals,a.exportAs,JSON.stringify(a.inputs),JSON.stringify(a.outputs),Object.getOwnPropertyNames(a.type.prototype),!!a.contentQueries,!!a.viewQuery];for(let r of m.join("|"))d=Math.imul(31,d)+r.charCodeAt(0)<<0;return d+=2147483648,"c"+d}var lx=function(a){return a[a.CHANGE_DETECTION=0]="CHANGE_DETECTION",a[a.AFTER_NEXT_RENDER=1]="AFTER_NEXT_RENDER",a}(lx||{}),Od=new Kt(""),yP=!1,uT=class extends Ar{__isAsync;destroyRef=void 0;pendingTasks=void 0;constructor(d=!1){super(),this.__isAsync=d,uE()&&(this.destroyRef=mt(Ha,{optional:!0})??void 0,this.pendingTasks=mt($a,{optional:!0})??void 0)}emit(d){let l=Ci(null);try{super.next(d)}finally{Ci(l)}}subscribe(d,l,m){let b=d,r=l||(()=>null),M=m;if(d&&typeof d=="object"){let G=d;b=G.next?.bind(G),r=G.error?.bind(G),M=G.complete?.bind(G)}this.__isAsync&&(r=this.wrapInTimeout(r),b&&(b=this.wrapInTimeout(b)),M&&(M=this.wrapInTimeout(M)));let N=super.subscribe({next:b,error:r,complete:M});return d instanceof _r&&d.add(N),N}wrapInTimeout(d){return l=>{let m=this.pendingTasks?.add();setTimeout(()=>{try{d(l)}finally{m!==void 0&&this.pendingTasks?.remove(m)}})}}},an=uT;function vP(a){let d,l;function m(){a=Ng;try{l!==void 0&&typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(l),d!==void 0&&clearTimeout(d)}catch{}}return d=setTimeout(()=>{a(),m()}),typeof requestAnimationFrame=="function"&&(l=requestAnimationFrame(()=>{a(),m()})),()=>m()}function ZR(a){return queueMicrotask(()=>a()),()=>{a=Ng}}var FT="isAngularZone",Z0=FT+"_ID",wj=0,Gi=class a{hasPendingMacrotasks=!1;hasPendingMicrotasks=!1;isStable=!0;onUnstable=new an(!1);onMicrotaskEmpty=new an(!1);onStable=new an(!1);onError=new an(!1);constructor(d){let{enableLongStackTrace:l=!1,shouldCoalesceEventChangeDetection:m=!1,shouldCoalesceRunChangeDetection:b=!1,scheduleInRootZone:r=yP}=d;if(typeof Zone>"u")throw new en(908,!1);Zone.assertZonePatched();let M=this;M._nesting=0,M._outer=M._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(M._inner=M._inner.fork(new Zone.TaskTrackingZoneSpec)),l&&Zone.longStackTraceZoneSpec&&(M._inner=M._inner.fork(Zone.longStackTraceZoneSpec)),M.shouldCoalesceEventChangeDetection=!b&&m,M.shouldCoalesceRunChangeDetection=b,M.callbackScheduled=!1,M.scheduleInRootZone=r,Ij(M)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get(FT)===!0}static assertInAngularZone(){if(!a.isInAngularZone())throw new en(909,!1)}static assertNotInAngularZone(){if(a.isInAngularZone())throw new en(909,!1)}run(d,l,m){return this._inner.run(d,l,m)}runTask(d,l,m,b){let r=this._inner,M=r.scheduleEventTask("NgZoneEvent: "+b,d,Ej,Ng,Ng);try{return r.runTask(M,l,m)}finally{r.cancelTask(M)}}runGuarded(d,l,m){return this._inner.runGuarded(d,l,m)}runOutsideAngular(d){return this._outer.run(d)}},Ej={};function NT(a){if(a._nesting==0&&!a.hasPendingMicrotasks&&!a.isStable)try{a._nesting++,a.onMicrotaskEmpty.emit(null)}finally{if(a._nesting--,!a.hasPendingMicrotasks)try{a.runOutsideAngular(()=>a.onStable.emit(null))}finally{a.isStable=!0}}}function Tj(a){if(a.isCheckStableRunning||a.callbackScheduled)return;a.callbackScheduled=!0;function d(){vP(()=>{a.callbackScheduled=!1,dT(a),a.isCheckStableRunning=!0,NT(a),a.isCheckStableRunning=!1})}a.scheduleInRootZone?Zone.root.run(()=>{d()}):a._outer.run(()=>{d()}),dT(a)}function Ij(a){let d=()=>{Tj(a)},l=wj++;a._inner=a._inner.fork({name:"angular",properties:{[FT]:!0,[Z0]:l,[Z0+l]:!0},onInvokeTask:(m,b,r,M,N,G)=>{if(Sj(G))return m.invokeTask(r,M,N,G);try{return XR(a),m.invokeTask(r,M,N,G)}finally{(a.shouldCoalesceEventChangeDetection&&M.type==="eventTask"||a.shouldCoalesceRunChangeDetection)&&d(),YR(a)}},onInvoke:(m,b,r,M,N,G,fe)=>{try{return XR(a),m.invoke(r,M,N,G,fe)}finally{a.shouldCoalesceRunChangeDetection&&!a.callbackScheduled&&!Dj(G)&&d(),YR(a)}},onHasTask:(m,b,r,M)=>{m.hasTask(r,M),b===r&&(M.change=="microTask"?(a._hasPendingMicrotasks=M.microTask,dT(a),NT(a)):M.change=="macroTask"&&(a.hasPendingMacrotasks=M.macroTask))},onHandleError:(m,b,r,M)=>(m.handleError(r,M),a.runOutsideAngular(()=>a.onError.emit(M)),!1)})}function dT(a){a._hasPendingMicrotasks||(a.shouldCoalesceEventChangeDetection||a.shouldCoalesceRunChangeDetection)&&a.callbackScheduled===!0?a.hasPendingMicrotasks=!0:a.hasPendingMicrotasks=!1}function XR(a){a._nesting++,a.isStable&&(a.isStable=!1,a.onUnstable.emit(null))}function YR(a){a._nesting--,NT(a)}var Gg=class{hasPendingMicrotasks=!1;hasPendingMacrotasks=!1;isStable=!0;onUnstable=new an;onMicrotaskEmpty=new an;onStable=new an;onError=new an;run(d,l,m){return d.apply(l,m)}runGuarded(d,l,m){return d.apply(l,m)}runOutsideAngular(d){return d()}runTask(d,l,m,b){return d.apply(l,m)}};function Sj(a){return xP(a,"__ignore_ng_zone__")}function Dj(a){return xP(a,"__scheduler_tick__")}function xP(a,d){return!Array.isArray(a)||a.length!==1?!1:a[0]?.data?.[d]===!0}function bP(a="zone.js",d){return a==="noop"?new Gg:a==="zone.js"?new Gi(d):a}var zT=(()=>{class a{impl=null;execute(){this.impl?.execute()}static \u0275prov=Xt({token:a,providedIn:"root",factory:()=>new a})}return a})(),wP=[0,1,2,3],EP=(()=>{class a{ngZone=mt(Gi);scheduler=mt(Dl);errorHandler=mt(Js,{optional:!0});sequences=new Set;deferredRegistrations=new Set;executing=!1;constructor(){mt(Od,{optional:!0})}execute(){let l=this.sequences.size>0;l&&or(16),this.executing=!0;for(let m of wP)for(let b of this.sequences)if(!(b.erroredOrDestroyed||!b.hooks[m]))try{b.pipelinedValue=this.ngZone.runOutsideAngular(()=>this.maybeTrace(()=>{let r=b.hooks[m];return r(b.pipelinedValue)},b.snapshot))}catch(r){b.erroredOrDestroyed=!0,this.errorHandler?.handleError(r)}this.executing=!1;for(let m of this.sequences)m.afterRun(),m.once&&(this.sequences.delete(m),m.destroy());for(let m of this.deferredRegistrations)this.sequences.add(m);this.deferredRegistrations.size>0&&this.scheduler.notify(7),this.deferredRegistrations.clear(),l&&or(17)}register(l){let{view:m}=l;m!==void 0?((m[xd]??=[]).push(l),Lf(m),m[Vn]|=8192):this.executing?this.deferredRegistrations.add(l):this.addSequence(l)}addSequence(l){this.sequences.add(l),this.scheduler.notify(7)}unregister(l){this.executing&&this.sequences.has(l)?(l.erroredOrDestroyed=!0,l.pipelinedValue=void 0,l.once=!0):(this.sequences.delete(l),this.deferredRegistrations.delete(l))}maybeTrace(l,m){return m?m.run(lx.AFTER_NEXT_RENDER,l):l()}static \u0275prov=Xt({token:a,providedIn:"root",factory:()=>new a})}return a})(),X0=class{impl;hooks;view;once;snapshot;erroredOrDestroyed=!1;pipelinedValue=void 0;unregisterOnDestroy;constructor(d,l,m,b,r,M=null){this.impl=d,this.hooks=l,this.view=m,this.once=b,this.snapshot=M,this.unregisterOnDestroy=r?.onDestroy(()=>this.destroy())}afterRun(){this.erroredOrDestroyed=!1,this.pipelinedValue=void 0,this.snapshot?.dispose(),this.snapshot=null}destroy(){this.impl.unregister(this),this.unregisterOnDestroy?.();let d=this.view?.[xd];d&&(this.view[xd]=d.filter(l=>l!==this))}};function BT(a,d){let l=d?.injector??mt(Zr);return Rd("NgAfterRender"),TP(a,l,d,!1)}function Yg(a,d){let l=d?.injector??mt(Zr);return Rd("NgAfterNextRender"),TP(a,l,d,!0)}function Cj(a){return a instanceof Function?[void 0,void 0,a,void 0]:[a.earlyRead,a.write,a.mixedReadWrite,a.read]}function TP(a,d,l,m){let b=d.get(zT);b.impl??=d.get(EP);let r=d.get(Od,null,{optional:!0}),M=l?.manualCleanup!==!0?d.get(Ha):null,N=d.get(M0,null,{optional:!0}),G=new X0(b.impl,Cj(a),N?.view,m,M,r?.snapshot(null));return b.impl.register(G),G}var VT=(()=>{class a{log(l){console.log(l)}warn(l){console.warn(l)}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"platform"})}return a})();var cx=new Kt(""),$f=new Kt(""),Kg=(()=>{class a{_ngZone;registry;_isZoneStable=!0;_callbacks=[];_taskTrackingZone=null;_destroyRef;constructor(l,m,b){this._ngZone=l,this.registry=m,uE()&&(this._destroyRef=mt(Ha,{optional:!0})??void 0),jT||(IP(b),b.addToWindow(m)),this._watchAngularEvents(),l.run(()=>{this._taskTrackingZone=typeof Zone>"u"?null:Zone.current.get("TaskTrackingZone")})}_watchAngularEvents(){let l=this._ngZone.onUnstable.subscribe({next:()=>{this._isZoneStable=!1}}),m=this._ngZone.runOutsideAngular(()=>this._ngZone.onStable.subscribe({next:()=>{Gi.assertNotInAngularZone(),queueMicrotask(()=>{this._isZoneStable=!0,this._runCallbacksIfReady()})}}));this._destroyRef?.onDestroy(()=>{l.unsubscribe(),m.unsubscribe()})}isStable(){return this._isZoneStable&&!this._ngZone.hasPendingMacrotasks}_runCallbacksIfReady(){if(this.isStable())queueMicrotask(()=>{for(;this._callbacks.length!==0;){let l=this._callbacks.pop();clearTimeout(l.timeoutId),l.doneCb()}});else{let l=this.getPendingTasks();this._callbacks=this._callbacks.filter(m=>m.updateCb&&m.updateCb(l)?(clearTimeout(m.timeoutId),!1):!0)}}getPendingTasks(){return this._taskTrackingZone?this._taskTrackingZone.macroTasks.map(l=>({source:l.source,creationLocation:l.creationLocation,data:l.data})):[]}addCallback(l,m,b){let r=-1;m&&m>0&&(r=setTimeout(()=>{this._callbacks=this._callbacks.filter(M=>M.timeoutId!==r),l()},m)),this._callbacks.push({doneCb:l,timeoutId:r,updateCb:b})}whenStable(l,m,b){if(b&&!this._taskTrackingZone)throw new Error('Task tracking zone is required when passing an update callback to whenStable(). Is "zone.js/plugins/task-tracking" loaded?');this.addCallback(l,m,b),this._runCallbacksIfReady()}registerApplication(l){this.registry.registerApplication(l,this)}unregisterApplication(l){this.registry.unregisterApplication(l)}findProviders(l,m,b){return[]}static \u0275fac=function(m){return new(m||a)(un(Gi),un(Jg),un($f))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),Jg=(()=>{class a{_applications=new Map;registerApplication(l,m){this._applications.set(l,m)}unregisterApplication(l){this._applications.delete(l)}unregisterAllApplications(){this._applications.clear()}getTestability(l){return this._applications.get(l)||null}getAllTestabilities(){return Array.from(this._applications.values())}getAllRootElements(){return Array.from(this._applications.keys())}findTestabilityInTree(l,m=!0){return jT?.findTestabilityInTree(this,l,m)??null}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"platform"})}return a})();function IP(a){jT=a}var jT;function Qg(a){return!!a&&typeof a.then=="function"}function SP(a){return!!a&&typeof a.subscribe=="function"}var UT=new Kt("");function ux(a){return jc([{provide:UT,multi:!0,useValue:a}])}var HT=(()=>{class a{resolve;reject;initialized=!1;done=!1;donePromise=new Promise((l,m)=>{this.resolve=l,this.reject=m});appInits=mt(UT,{optional:!0})??[];injector=mt(Zr);constructor(){}runInitializers(){if(this.initialized)return;let l=[];for(let b of this.appInits){let r=Xr(this.injector,b);if(Qg(r))l.push(r);else if(SP(r)){let M=new Promise((N,G)=>{r.subscribe({complete:N,error:G})});l.push(M)}}let m=()=>{this.done=!0,this.resolve()};Promise.all(l).then(()=>{m()}).catch(b=>{this.reject(b)}),l.length===0&&m(),this.initialized=!0}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),dx=new Kt("");function DP(){g1(()=>{let a="";throw new en(600,a)})}function CP(a){return a.isBoundToModule}var Aj=10;function $T(a,d){return Array.isArray(d)?d.reduce($T,a):Gt(Gt({},a),d)}var kl=(()=>{class a{_runningTick=!1;_destroyed=!1;_destroyListeners=[];_views=[];internalErrorHandler=mt(Rs);afterRenderManager=mt(zT);zonelessEnabled=mt(A0);rootEffectScheduler=mt(kE);dirtyFlags=0;tracingSnapshot=null;allTestViews=new Set;autoDetectTestViews=new Set;includeAllTestViews=!1;afterTick=new Ar;get allViews(){return[...(this.includeAllTestViews?this.allTestViews:this.autoDetectTestViews).keys(),...this._views]}get destroyed(){return this._destroyed}componentTypes=[];components=[];internalPendingTask=mt($a);get isStable(){return this.internalPendingTask.hasPendingTasksObservable.pipe(oi(l=>!l))}constructor(){mt(Od,{optional:!0})}whenStable(){let l;return new Promise(m=>{l=this.isStable.subscribe({next:b=>{b&&m()}})}).finally(()=>{l.unsubscribe()})}_injector=mt(wr);_rendererFactory=null;get injector(){return this._injector}bootstrap(l,m){return this.bootstrapImpl(l,m)}bootstrapImpl(l,m,b=Zr.NULL){return this._injector.get(Gi).run(()=>{or(10);let M=l instanceof sx;if(!this._injector.get(HT).done){let Pt="";throw new en(405,Pt)}let G;M?G=l:G=this._injector.get(Zg).resolveComponentFactory(l),this.componentTypes.push(G.componentType);let fe=CP(G)?void 0:this._injector.get(Bf),Me=m||G.selector,Ue=G.create(b,[],Me,fe),bt=Ue.location.nativeElement,Fe=Ue.injector.get(cx,null);return Fe?.registerApplication(bt),Ue.onDestroy(()=>{this.detachView(Ue.hostView),Bg(this.components,Ue),Fe?.unregisterApplication(bt)}),this._loadComponent(Ue),or(11,Ue),Ue})}tick(){this.zonelessEnabled||(this.dirtyFlags|=1),this._tick()}_tick(){or(12),this.tracingSnapshot!==null?this.tracingSnapshot.run(lx.CHANGE_DETECTION,this.tickImpl):this.tickImpl()}tickImpl=()=>{if(this._runningTick)throw new en(101,!1);let l=Ci(null);try{this._runningTick=!0,this.synchronize()}finally{this._runningTick=!1,this.tracingSnapshot?.dispose(),this.tracingSnapshot=null,Ci(l),this.afterTick.next(),or(13)}};synchronize(){this._rendererFactory===null&&!this._injector.destroyed&&(this._rendererFactory=this._injector.get(Sd,null,{optional:!0}));let l=0;for(;this.dirtyFlags!==0&&l++<Aj;)or(14),this.synchronizeOnce(),or(15)}synchronizeOnce(){this.dirtyFlags&16&&(this.dirtyFlags&=-17,this.rootEffectScheduler.flush());let l=!1;if(this.dirtyFlags&7){let m=!!(this.dirtyFlags&1);this.dirtyFlags&=-8,this.dirtyFlags|=8;for(let{_lView:b}of this.allViews){if(!m&&!Pg(b))continue;let r=m&&!this.zonelessEnabled?0:1;MT(b,r),l=!0}if(this.dirtyFlags&=-5,this.syncDirtyFlagsWithViews(),this.dirtyFlags&23)return}l||(this._rendererFactory?.begin?.(),this._rendererFactory?.end?.()),this.dirtyFlags&8&&(this.dirtyFlags&=-9,this.afterRenderManager.execute()),this.syncDirtyFlagsWithViews()}syncDirtyFlagsWithViews(){if(this.allViews.some(({_lView:l})=>Pg(l))){this.dirtyFlags|=2;return}else this.dirtyFlags&=-8}attachView(l){let m=l;this._views.push(m),m.attachToAppRef(this)}detachView(l){let m=l;Bg(this._views,m),m.detachFromAppRef()}_loadComponent(l){this.attachView(l.hostView);try{this.tick()}catch(b){this.internalErrorHandler(b)}this.components.push(l),this._injector.get(dx,[]).forEach(b=>b(l))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(l=>l()),this._views.slice().forEach(l=>l.destroy())}finally{this._destroyed=!0,this._views=[],this._destroyListeners=[]}}onDestroy(l){return this._destroyListeners.push(l),()=>Bg(this._destroyListeners,l)}destroy(){if(this._destroyed)throw new en(406,!1);let l=this._injector;l.destroy&&!l.destroyed&&l.destroy()}get viewCount(){return this._views.length}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function Bg(a,d){let l=a.indexOf(d);l>-1&&a.splice(l,1)}function hx(a,d,l){let m=ur(),b=pR();if(LT(m,b,d)){let r=Ua(),M=ER();eV(M,m,a,d,m[Bo],l)}return hx}function hT(a,d,l,m,b){CT(d,a,l,b?"class":"style",m)}function Ld(a,d,l,m){let b=ur(),r=b[jn],M=a+Ms,N=r.firstCreatePass?aP(M,b,2,d,sV,lR(),l,m):r.data[M];if(G2(N,b,a,d,AP),pE(N)){let G=b[jn];H2(G,b,N),D2(G,N,b)}return m!=null&&$2(b,N),Ld}function Yc(){let a=Ua(),d=ps(),l=q2(d);return a.firstCreatePass&&lP(a,l),vE(l)&&xE(),yE(),l.classesWithoutHost!=null&&XB(l)&&hT(a,l,ur(),l.classesWithoutHost,!0),l.stylesWithoutHost!=null&&YB(l)&&hT(a,l,ur(),l.stylesWithoutHost,!1),Yc}function kd(a,d,l,m){return Ld(a,d,l,m),Yc(),kd}function GT(a,d,l,m){let b=ur(),r=b[jn],M=a+Ms,N=r.firstCreatePass?HV(M,r,2,d,l,m):r.data[M];return G2(N,b,a,d,AP),m!=null&&$2(b,N),GT}function qT(){let a=ps(),d=q2(a);return vE(d)&&xE(),yE(),qT}function fx(a,d,l,m){return GT(a,d,l,m),qT(),fx}var AP=(a,d,l,m,b)=>(ME(!0),M2(d[Bo],m,TR()));var e_="en-US";var Mj=e_;function MP(a){typeof a=="string"&&(Mj=a.toLowerCase().replace(/_/g,"-"))}function WT(a,d,l){uj(a,d,l)}function px(a){let d=ur(),l=Ua(),m=SE();S0(m+1);let b=kT(l,m);if(a.dirty&&eR(d)===((b.metadata.flags&2)===2)){if(b.matches===null)a.reset([]);else{let r=fj(d,m);a.reset(r,c3),a.notifyOnChanges()}return!0}return!1}function mx(){return lj(ur(),SE())}function R0(a,d){return a<<17|d<<2}function Cd(a){return a>>17&32767}function Rj(a){return(a&2)==2}function Pj(a,d){return a&131071|d<<17}function fT(a){return a|2}function Vf(a){return(a&131068)>>2}function VE(a,d){return a&-131069|d<<2}function Oj(a){return(a&1)===1}function pT(a){return a|1}function Lj(a,d,l,m,b,r){let M=r?d.classBindings:d.styleBindings,N=Cd(M),G=Vf(M);a[m]=l;let fe=!1,Me;if(Array.isArray(l)){let Ue=l;Me=Ue[1],(Me===null||Af(Ue,Me)>0)&&(fe=!0)}else Me=l;if(b)if(G!==0){let bt=Cd(a[N+1]);a[m+1]=R0(bt,N),bt!==0&&(a[bt+1]=VE(a[bt+1],m)),a[N+1]=Pj(a[N+1],m)}else a[m+1]=R0(N,0),N!==0&&(a[N+1]=VE(a[N+1],m)),N=m;else a[m+1]=R0(G,0),N===0?N=m:a[G+1]=VE(a[G+1],m),G=m;fe&&(a[m+1]=fT(a[m+1])),KR(a,Me,m,!0),KR(a,Me,m,!1),kj(d,Me,a,m,r),M=R0(N,G),r?d.classBindings=M:d.styleBindings=M}function kj(a,d,l,m,b){let r=b?a.residualClasses:a.residualStyles;r!=null&&typeof d=="string"&&Af(r,d)>=0&&(l[m+1]=pT(l[m+1]))}function KR(a,d,l,m){let b=a[l+1],r=d===null,M=m?Cd(b):Vf(b),N=!1;for(;M!==0&&(N===!1||r);){let G=a[M],fe=a[M+1];Fj(G,d)&&(N=!0,a[M+1]=m?pT(fe):fT(fe)),M=m?Cd(fe):Vf(fe)}N&&(a[l+1]=m?fT(b):pT(b))}function Fj(a,d){return a===null||d==null||(Array.isArray(a)?a[1]:a)===d?!0:Array.isArray(a)&&typeof d=="string"?Af(a,d)>=0:!1}var jo={textEnd:0,key:0,keyEnd:0,value:0,valueEnd:0};function Nj(a){return a.substring(jo.key,jo.keyEnd)}function zj(a){return a.substring(jo.value,jo.valueEnd)}function Bj(a){return Vj(a),RP(a,Y0(a,0,jo.textEnd))}function RP(a,d){let l=jo.textEnd,m=jo.key=Y0(a,d,l);return l===m?-1:(m=jo.keyEnd=jj(a,m,l),m=JR(a,m,l,58),m=jo.value=Y0(a,m,l),m=jo.valueEnd=Uj(a,m,l),JR(a,m,l,59))}function Vj(a){jo.key=0,jo.keyEnd=0,jo.value=0,jo.valueEnd=0,jo.textEnd=a.length}function Y0(a,d,l){for(;d<l&&a.charCodeAt(d)<=32;)d++;return d}function jj(a,d,l){let m;for(;d<l&&((m=a.charCodeAt(d))===45||m===95||(m&-33)>=65&&(m&-33)<=90||m>=48&&m<=57);)d++;return d}function JR(a,d,l,m){return d=Y0(a,d,l),d<l&&d++,d}function Uj(a,d,l){let m=-1,b=-1,r=-1,M=d,N=M;for(;M<l;){let G=a.charCodeAt(M++);if(G===59)return N;G===34||G===39?N=M=QR(a,G,M,l):d===M-4&&r===85&&b===82&&m===76&&G===40?N=M=QR(a,41,M,l):G>32&&(N=M),r=b,b=m,m=G&-33}return N}function QR(a,d,l,m){let b=-1,r=l;for(;r<m;){let M=a.charCodeAt(r++);if(M==d&&b!==92)return r;M==92&&b===92?b=0:b=M}throw new Error}function ZT(a){$j(OP,Hj,a,!1)}function Hj(a,d){for(let l=Bj(d);l>=0;l=RP(d,l))OP(a,Nj(d),zj(d))}function $j(a,d,l,m){let b=Ua(),r=mR(2);b.firstUpdatePass&&Gj(b,null,r,m);let M=ur();if(l!==Zc&&LT(M,r,l)){let N=b.data[kf()];if(LP(N,m)&&!PP(b,r)){let G=m?N.classesWithoutHost:N.stylesWithoutHost;G!==null&&(l=m0(G,l||"")),hT(b,N,M,l,m)}else Kj(b,N,M,M[Bo],M[r+1],M[r+1]=Yj(a,d,l),m,r)}}function PP(a,d){return d>=a.expandoStartIndex}function Gj(a,d,l,m){let b=a.data;if(b[l+1]===null){let r=b[kf()],M=PP(a,l);LP(r,m)&&d===null&&!M&&(d=!1),d=qj(b,r,d,m),Lj(b,r,d,l,M,m)}}function qj(a,d,l,m){let b=vR(a),r=m?d.residualClasses:d.residualStyles;if(b===null)(m?d.classBindings:d.styleBindings)===0&&(l=jE(null,a,d,l,m),l=qg(l,d.attrs,m),r=null);else{let M=d.directiveStylingLast;if(M===-1||a[M]!==b)if(l=jE(b,a,d,l,m),r===null){let G=Wj(a,d,m);G!==void 0&&Array.isArray(G)&&(G=jE(null,a,d,G[1],m),G=qg(G,d.attrs,m),Zj(a,d,m,G))}else r=Xj(a,d,m)}return r!==void 0&&(m?d.residualClasses=r:d.residualStyles=r),l}function Wj(a,d,l){let m=l?d.classBindings:d.styleBindings;if(Vf(m)!==0)return a[Cd(m)]}function Zj(a,d,l,m){let b=l?d.classBindings:d.styleBindings;a[Cd(b)]=m}function Xj(a,d,l){let m,b=d.directiveEnd;for(let r=1+d.directiveStylingLast;r<b;r++){let M=a[r].hostAttrs;m=qg(m,M,l)}return qg(m,d.attrs,l)}function jE(a,d,l,m,b){let r=null,M=l.directiveEnd,N=l.directiveStylingLast;for(N===-1?N=l.directiveStart:N++;N<M&&(r=d[N],m=qg(m,r.hostAttrs,b),r!==a);)N++;return a!==null&&(l.directiveStylingLast=N),m}function qg(a,d,l){let m=l?1:2,b=-1;if(d!==null)for(let r=0;r<d.length;r++){let M=d[r];typeof M=="number"?b=M:b===m&&(Array.isArray(a)||(a=a===void 0?[]:["",a]),nE(a,M,l?!0:d[++r]))}return a===void 0?null:a}function Yj(a,d,l){if(l==null||l==="")return ns;let m=[],b=ix(l);if(Array.isArray(b))for(let r=0;r<b.length;r++)a(m,b[r],!0);else if(typeof b=="object")for(let r in b)b.hasOwnProperty(r)&&a(m,r,b[r]);else typeof b=="string"&&d(m,b);return m}function OP(a,d,l){nE(a,d,ix(l))}function Kj(a,d,l,m,b,r,M,N){b===Zc&&(b=ns);let G=0,fe=0,Me=0<b.length?b[0]:null,Ue=0<r.length?r[0]:null;for(;Me!==null||Ue!==null;){let bt=G<b.length?b[G+1]:void 0,Fe=fe<r.length?r[fe+1]:void 0,Pt=null,Vt;Me===Ue?(G+=2,fe+=2,bt!==Fe&&(Pt=Ue,Vt=Fe)):Ue===null||Me!==null&&Me<Ue?(G+=2,Pt=Me):(fe+=2,Pt=Ue,Vt=Fe),Pt!==null&&Jj(a,d,l,m,Pt,Vt,M,N),Me=G<b.length?b[G]:null,Ue=fe<r.length?r[fe]:null}}function Jj(a,d,l,m,b,r,M,N){if(!(d.type&3))return;let G=a.data,fe=G[N+1],Me=Oj(fe)?e2(G,d,l,b,Vf(fe),M):void 0;if(!K0(Me)){K0(r)||Rj(fe)&&(r=e2(G,null,l,b,N,M));let Ue=QM(kf(),l);X3(m,M,Ue,b,r)}}function e2(a,d,l,m,b,r){let M=d===null,N;for(;b>0;){let G=a[b],fe=Array.isArray(G),Me=fe?G[1]:G,Ue=Me===null,bt=l[b+1];bt===Zc&&(bt=Ue?ns:void 0);let Fe=Ue?x0(bt,m):Me===m?bt:void 0;if(fe&&!K0(Fe)&&(Fe=x0(G,m)),K0(Fe)&&(N=Fe,M))return N;let Pt=a[b+1];b=M?Cd(Pt):Vf(Pt)}if(d!==null){let G=r?d.residualClasses:d.residualStyles;G!=null&&(N=x0(G,m))}return N}function K0(a){return a!==void 0}function LP(a,d){return(a.flags&(d?8:16))!==0}function t_(a,d=""){let l=ur(),m=Ua(),b=a+Ms,r=m.firstCreatePass?PT(m,b,1,d,null):m.data[b],M=Qj(m,l,r,d,a);l[b]=M,AE()&&V2(m,l,M,r),Lg(r,!1)}var Qj=(a,d,l,m,b)=>(ME(!0),A3(d[Bo],m));function eU(a,d,l){let m=Ua();if(m.firstCreatePass){let b=$c(a);mT(l,m.data,m.blueprint,b,!0),mT(d,m.data,m.blueprint,b,!1)}}function mT(a,d,l,m,b){if(a=so(a),Array.isArray(a))for(let r=0;r<a.length;r++)mT(a[r],d,l,m,b);else{let r=Ua(),M=ur(),N=ps(),G=pd(a)?a:so(a.provide),fe=cE(a),Me=N.providerIndexes&1048575,Ue=N.directiveStart,bt=N.providerIndexes>>20;if(pd(a)||!a.multi){let Fe=new Id(fe,b,Xc,null),Pt=HE(G,d,b?Me:Me+bt,Ue);Pt===-1?(GE(V0(N,M),r,G),UE(r,a,d.length),d.push(G),N.directiveStart++,N.directiveEnd++,b&&(N.providerIndexes+=1048576),l.push(Fe),M.push(Fe)):(l[Pt]=Fe,M[Pt]=Fe)}else{let Fe=HE(G,d,Me+bt,Ue),Pt=HE(G,d,Me,Me+bt),Vt=Fe>=0&&l[Fe],jt=Pt>=0&&l[Pt];if(b&&!jt||!b&&!Vt){GE(V0(N,M),r,G);let Nt=iU(b?nU:tU,l.length,b,m,fe,a);!b&&jt&&(l[Pt].providerFactory=Nt),UE(r,a,d.length,0),d.push(G),N.directiveStart++,N.directiveEnd++,b&&(N.providerIndexes+=1048576),l.push(Nt),M.push(Nt)}else{let Nt=kP(l[b?Pt:Fe],fe,!b&&m);UE(r,a,Fe>-1?Fe:Pt,Nt)}!b&&m&&jt&&l[Pt].componentProviders++}}}function UE(a,d,l,m){let b=pd(d),r=XM(d);if(b||r){let G=(r?so(d.useClass):d).prototype.ngOnDestroy;if(G){let fe=a.destroyHooks||(a.destroyHooks=[]);if(!b&&d.multi){let Me=fe.indexOf(l);Me===-1?fe.push(l,[m,G]):fe[Me+1].push(m,G)}else fe.push(l,G)}}}function kP(a,d,l){return l&&a.componentProviders++,a.multi.push(d)-1}function HE(a,d,l,m){for(let b=l;b<m;b++)if(d[b]===a)return b;return-1}function tU(a,d,l,m,b){return gT(this.multi,[])}function nU(a,d,l,m,b){let r=this.multi,M;if(this.providerFactory){let N=this.providerFactory.componentProviders,G=Vg(m,m[jn],this.providerFactory.index,b);M=G.slice(0,N),gT(r,M);for(let fe=N;fe<G.length;fe++)M.push(G[fe])}else M=[],gT(r,M);return M}function gT(a,d){for(let l=0;l<a.length;l++){let m=a[l];d.push(m())}return d}function iU(a,d,l,m,b,r){let M=new Id(a,l,Xc,null);return M.multi=[],M.index=d,M.componentProviders=0,kP(M,b,m&&!l),M}function XT(a,d=[]){return l=>{l.providersResolver=(m,b)=>eU(m,b?b(a):a,d)}}function YT(a,d,l,m){return oU(ur(),hR(),a,d,l,m)}function rU(a,d){let l=a[d];return l===Zc?void 0:l}function oU(a,d,l,m,b,r){let M=d+l;return LT(a,M,b)?$V(a,M+1,r?m.call(r,b):m(b)):rU(a,M+1)}var P0=null;function FP(a){P0!==null&&(a.defaultEncapsulation!==P0.defaultEncapsulation||a.preserveWhitespaces!==P0.preserveWhitespaces)||(P0=a)}var J0=class{ngModuleFactory;componentFactories;constructor(d,l){this.ngModuleFactory=d,this.componentFactories=l}},KT=(()=>{class a{compileModuleSync(l){return new $g(l)}compileModuleAsync(l){return Promise.resolve(this.compileModuleSync(l))}compileModuleAndAllComponentsSync(l){let m=this.compileModuleSync(l),b=oE(l),r=C2(b.declarations).reduce((M,N)=>{let G=Al(N);return G&&M.push(new Dd(G)),M},[]);return new J0(m,r)}compileModuleAndAllComponentsAsync(l){return Promise.resolve(this.compileModuleAndAllComponentsSync(l))}clearCache(){}clearCacheFor(l){}getModuleId(l){}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),NP=new Kt("");var sU=(()=>{class a{zone=mt(Gi);changeDetectionScheduler=mt(Dl);applicationRef=mt(kl);applicationErrorHandler=mt(Rs);_onMicrotaskEmptySubscription;initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{try{this.applicationRef.dirtyFlags|=1,this.applicationRef._tick()}catch(l){this.applicationErrorHandler(l)}})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function zP({ngZoneFactory:a,ignoreChangesOutsideZone:d,scheduleInRootZone:l}){return a??=()=>new Gi(Vi(Gt({},JT()),{scheduleInRootZone:l})),[{provide:Gi,useFactory:a},{provide:Cl,multi:!0,useFactory:()=>{let m=mt(sU,{optional:!0});return()=>m.initialize()}},{provide:Cl,multi:!0,useFactory:()=>{let m=mt(aU);return()=>{m.initialize()}}},d===!0?{provide:OE,useValue:!0}:[],{provide:LE,useValue:l??yP},{provide:Rs,useFactory:()=>{let m=mt(Gi),b=mt(wr),r;return M=>{m.runOutsideAngular(()=>{b.destroyed&&!r?setTimeout(()=>{throw M}):(r??=b.get(Js),r.handleError(M))})}}}]}function JT(a){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:a?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:a?.runCoalescing??!1}}var aU=(()=>{class a{subscription=new _r;initialized=!1;zone=mt(Gi);pendingTasks=mt($a);initialize(){if(this.initialized)return;this.initialized=!0;let l=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(l=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{Gi.assertNotInAngularZone(),queueMicrotask(()=>{l!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(l),l=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{Gi.assertInAngularZone(),l??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();var BP=(()=>{class a{applicationErrorHandler=mt(Rs);appRef=mt(kl);taskService=mt($a);ngZone=mt(Gi);zonelessEnabled=mt(A0);tracing=mt(Od,{optional:!0});disableScheduling=mt(OE,{optional:!0})??!1;zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run;schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}];subscriptions=new _r;angularZoneId=this.zoneIsDefined?this.ngZone._inner?.get(Z0):null;scheduleInRootZone=!this.zonelessEnabled&&this.zoneIsDefined&&(mt(LE,{optional:!0})??!1);cancelScheduledCallback=null;useMicrotaskScheduler=!1;runningTick=!1;pendingRenderTaskId=null;constructor(){this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()})),this.disableScheduling||=!this.zonelessEnabled&&(this.ngZone instanceof Gg||!this.zoneIsDefined)}notify(l){if(!this.zonelessEnabled&&l===5)return;let m=!1;switch(l){case 0:{this.appRef.dirtyFlags|=2;break}case 3:case 2:case 4:case 5:case 1:{this.appRef.dirtyFlags|=4;break}case 6:{this.appRef.dirtyFlags|=2,m=!0;break}case 12:{this.appRef.dirtyFlags|=16,m=!0;break}case 13:{this.appRef.dirtyFlags|=2,m=!0;break}case 11:{m=!0;break}case 9:case 8:case 7:case 10:default:this.appRef.dirtyFlags|=8}if(this.appRef.tracingSnapshot=this.tracing?.snapshot(this.appRef.tracingSnapshot)??null,!this.shouldScheduleTick(m))return;let b=this.useMicrotaskScheduler?ZR:vP;this.pendingRenderTaskId=this.taskService.add(),this.scheduleInRootZone?this.cancelScheduledCallback=Zone.root.run(()=>b(()=>this.tick())):this.cancelScheduledCallback=this.ngZone.runOutsideAngular(()=>b(()=>this.tick()))}shouldScheduleTick(l){return!(this.disableScheduling&&!l||this.appRef.destroyed||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&Zone.current.get(Z0+this.angularZoneId))}tick(){if(this.runningTick||this.appRef.destroyed)return;if(this.appRef.dirtyFlags===0){this.cleanup();return}!this.zonelessEnabled&&this.appRef.dirtyFlags&7&&(this.appRef.dirtyFlags|=1);let l=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick()},void 0,this.schedulerTickApplyArgs)}catch(m){this.taskService.remove(l),this.applicationErrorHandler(m)}finally{this.cleanup()}this.useMicrotaskScheduler=!0,ZR(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(l)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let l=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(l)}}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function lU(){return typeof $localize<"u"&&$localize.locale||e_}var QT=new Kt("",{providedIn:"root",factory:()=>mt(QT,{optional:!0,skipSelf:!0})||lU()});var GP=Symbol("InputSignalNode#UNSET"),vU=Vi(Gt({},Gv),{transformFn:void 0,applyValueToInputSignal(a,d){fg(a,d)}});function qP(a,d){let l=Object.create(vU);l.value=a,l.transformFn=d?.transform;function m(){if(Uv(l),l.value===GP){let b=null;throw new en(-950,b)}return l.value}return m[wl]=l,m}var xU=new Kt("");xU.__NG_ELEMENT_ID__=a=>{let d=ps();if(d===null)throw new en(204,!1);if(d.type&2)return d.value;if(a&8)return null;throw new en(204,!1)};function VP(a,d){return qP(a,d)}function bU(a){return qP(GP,a)}var vn=(VP.required=bU,VP);function wU(a,d,l){let m=new $g(l);return Promise.resolve(m)}function jP(a){for(let d=a.length-1;d>=0;d--)if(a[d]!==void 0)return a[d]}var gx=new Kt(""),EU=new Kt("");function n_(a){return!a.moduleRef}function TU(a){let d=n_(a)?a.r3Injector:a.moduleRef.injector,l=d.get(Gi);return l.run(()=>{n_(a)?a.r3Injector.resolveInjectorInitializers():a.moduleRef.resolveInjectorInitializers();let m=d.get(Rs),b;if(l.runOutsideAngular(()=>{b=l.onError.subscribe({next:m})}),n_(a)){let r=()=>d.destroy(),M=a.platformInjector.get(gx);M.add(r),d.onDestroy(()=>{b.unsubscribe(),M.delete(r)})}else{let r=()=>a.moduleRef.destroy(),M=a.platformInjector.get(gx);M.add(r),a.moduleRef.onDestroy(()=>{Bg(a.allPlatformModules,a.moduleRef),b.unsubscribe(),M.delete(r)})}return SU(m,l,()=>{let r=d.get($a),M=r.add(),N=d.get(HT);return N.runInitializers(),N.donePromise.then(()=>{let G=d.get(QT,e_);if(MP(G||e_),!d.get(EU,!0))return n_(a)?d.get(kl):(a.allPlatformModules.push(a.moduleRef),a.moduleRef);if(n_(a)){let Me=d.get(kl);return a.rootComponent!==void 0&&Me.bootstrap(a.rootComponent),Me}else return WP?.(a.moduleRef,a.allPlatformModules),a.moduleRef}).finally(()=>void r.remove(M))})})}var WP;function UP(){WP=IU}function IU(a,d){let l=a.injector.get(kl);if(a._bootstrapComponents.length>0)a._bootstrapComponents.forEach(m=>l.bootstrap(m));else if(a.instance.ngDoBootstrap)a.instance.ngDoBootstrap(l);else throw new en(-403,!1);d.push(a)}function SU(a,d,l){try{let m=l();return Qg(m)?m.catch(b=>{throw d.runOutsideAngular(()=>a(b)),b}):m}catch(m){throw d.runOutsideAngular(()=>a(m)),m}}var ZP=(()=>{class a{_injector;_modules=[];_destroyListeners=[];_destroyed=!1;constructor(l){this._injector=l}bootstrapModuleFactory(l,m){let b=m?.scheduleInRootZone,r=()=>bP(m?.ngZone,Vi(Gt({},JT({eventCoalescing:m?.ngZoneEventCoalescing,runCoalescing:m?.ngZoneRunCoalescing})),{scheduleInRootZone:b})),M=m?.ignoreChangesOutsideZone,N=[zP({ngZoneFactory:r,ignoreChangesOutsideZone:M}),{provide:Dl,useExisting:BP},SR],G=mP(l.moduleType,this.injector,N);return UP(),TU({moduleRef:G,allPlatformModules:this._modules,platformInjector:this.injector})}bootstrapModule(l,m=[]){let b=$T({},m);return UP(),wU(this.injector,b,l).then(r=>this.bootstrapModuleFactory(r,b))}onDestroy(l){this._destroyListeners.push(l)}get injector(){return this._injector}destroy(){if(this._destroyed)throw new en(404,!1);this._modules.slice().forEach(m=>m.destroy()),this._destroyListeners.forEach(m=>m());let l=this._injector.get(gx,null);l&&(l.forEach(m=>m()),l.clear()),this._destroyed=!0}get destroyed(){return this._destroyed}static \u0275fac=function(m){return new(m||a)(un(Zr))};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"platform"})}return a})(),i_=null,XP=new Kt("");function DU(a){if(i_&&!i_.get(XP,!1))throw new en(400,!1);DP(),i_=a;let d=a.get(ZP);return MU(a),d}function tI(a,d,l=[]){let m=`Platform: ${d}`,b=new Kt(m);return(r=[])=>{let M=YP();if(!M||M.injector.get(XP,!1)){let N=[...l,...r,{provide:b,useValue:!0}];a?a(N):DU(CU(N,m))}return AU(b)}}function CU(a=[],d){return Zr.create({name:d,providers:[{provide:Tg,useValue:"platform"},{provide:gx,useValue:new Set([()=>i_=null])},...a]})}function AU(a){let d=YP();if(!d)throw new en(401,!1);return d}function YP(){return i_?.get(ZP)??null}function MU(a){let d=a.get(tx,null);Xr(a,()=>{d?.forEach(l=>l())})}var r_=(()=>{class a{static __NG_ELEMENT_ID__=RU}return a})();function RU(a){return PU(ps(),ur(),(a&16)===16)}function PU(a,d,l){if(wd(a)&&!l){let m=ja(a.index,d);return new qc(m,m)}else if(a.type&175){let m=d[As];return new qc(m,d)}return null}var KP=tI(null,"core",[]),JP=(()=>{class a{constructor(l){}static \u0275fac=function(m){return new(m||a)(un(kl))};static \u0275mod=Uo({type:a});static \u0275inj=vo({})}return a})();function QP(a){let d=Al(a);if(!d)return null;let l=new Dd(d);return{get selector(){return l.selector},get type(){return l.componentType},get inputs(){return l.inputs},get outputs(){return l.outputs},get ngContentSelectors(){return l.ngContentSelectors},get isStandalone(){return d.standalone},get isSignal(){return d.signals}}}var nO=null;function qa(){return nO}function nI(a){nO??=a}var o_=class{},s_=(()=>{class a{historyGo(l){throw new Error("")}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>mt(iO),providedIn:"platform"})}return a})(),iI=new Kt(""),iO=(()=>{class a extends s_{_location;_history;_doc=mt(dr);constructor(){super(),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return qa().getBaseHref(this._doc)}onPopState(l){let m=qa().getGlobalEventTarget(this._doc,"window");return m.addEventListener("popstate",l,!1),()=>m.removeEventListener("popstate",l)}onHashChange(l){let m=qa().getGlobalEventTarget(this._doc,"window");return m.addEventListener("hashchange",l,!1),()=>m.removeEventListener("hashchange",l)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(l){this._location.pathname=l}pushState(l,m,b){this._history.pushState(l,m,b)}replaceState(l,m,b){this._history.replaceState(l,m,b)}forward(){this._history.forward()}back(){this._history.back()}historyGo(l=0){this._history.go(l)}getState(){return this._history.state}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>new a,providedIn:"platform"})}return a})();function _x(a,d){return a?d?a.endsWith("/")?d.startsWith("/")?a+d.slice(1):a+d:d.startsWith("/")?a+d:`${a}/${d}`:a:d}function eO(a){let d=a.search(/#|\?|$/);return a[d-1]==="/"?a.slice(0,d-1)+a.slice(d):a}function ra(a){return a&&a[0]!=="?"?`?${a}`:a}var Fl=(()=>{class a{historyGo(l){throw new Error("")}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>mt(vx),providedIn:"root"})}return a})(),yx=new Kt(""),vx=(()=>{class a extends Fl{_platformLocation;_baseHref;_removeListenerFns=[];constructor(l,m){super(),this._platformLocation=l,this._baseHref=m??this._platformLocation.getBaseHrefFromDOM()??mt(dr).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(l){this._removeListenerFns.push(this._platformLocation.onPopState(l),this._platformLocation.onHashChange(l))}getBaseHref(){return this._baseHref}prepareExternalUrl(l){return _x(this._baseHref,l)}path(l=!1){let m=this._platformLocation.pathname+ra(this._platformLocation.search),b=this._platformLocation.hash;return b&&l?`${m}${b}`:m}pushState(l,m,b,r){let M=this.prepareExternalUrl(b+ra(r));this._platformLocation.pushState(l,m,M)}replaceState(l,m,b,r){let M=this.prepareExternalUrl(b+ra(r));this._platformLocation.replaceState(l,m,M)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(l=0){this._platformLocation.historyGo?.(l)}static \u0275fac=function(m){return new(m||a)(un(s_),un(yx,8))};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),Kc=(()=>{class a{_subject=new Ar;_basePath;_locationStrategy;_urlChangeListeners=[];_urlChangeSubscription=null;constructor(l){this._locationStrategy=l;let m=this._locationStrategy.getBaseHref();this._basePath=kU(eO(tO(m))),this._locationStrategy.onPopState(b=>{this._subject.next({url:this.path(!0),pop:!0,state:b.state,type:b.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(l=!1){return this.normalize(this._locationStrategy.path(l))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(l,m=""){return this.path()==this.normalize(l+ra(m))}normalize(l){return a.stripTrailingSlash(LU(this._basePath,tO(l)))}prepareExternalUrl(l){return l&&l[0]!=="/"&&(l="/"+l),this._locationStrategy.prepareExternalUrl(l)}go(l,m="",b=null){this._locationStrategy.pushState(b,"",l,m),this._notifyUrlChangeListeners(this.prepareExternalUrl(l+ra(m)),b)}replaceState(l,m="",b=null){this._locationStrategy.replaceState(b,"",l,m),this._notifyUrlChangeListeners(this.prepareExternalUrl(l+ra(m)),b)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(l=0){this._locationStrategy.historyGo?.(l)}onUrlChange(l){return this._urlChangeListeners.push(l),this._urlChangeSubscription??=this.subscribe(m=>{this._notifyUrlChangeListeners(m.url,m.state)}),()=>{let m=this._urlChangeListeners.indexOf(l);this._urlChangeListeners.splice(m,1),this._urlChangeListeners.length===0&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(l="",m){this._urlChangeListeners.forEach(b=>b(l,m))}subscribe(l,m,b){return this._subject.subscribe({next:l,error:m??void 0,complete:b??void 0})}static normalizeQueryParams=ra;static joinWithSlash=_x;static stripTrailingSlash=eO;static \u0275fac=function(m){return new(m||a)(un(Fl))};static \u0275prov=Xt({token:a,factory:()=>OU(),providedIn:"root"})}return a})();function OU(){return new Kc(un(Fl))}function LU(a,d){if(!a||!d.startsWith(a))return d;let l=d.substring(a.length);return l===""||["/",";","?","#"].includes(l[0])?l:d}function tO(a){return a.replace(/\/index.html$/,"")}function kU(a){if(new RegExp("^(https?:)?//").test(a)){let[,l]=a.split(/\/\/[^\/]+/);return l}return a}var rI=(()=>{class a extends Fl{_platformLocation;_baseHref="";_removeListenerFns=[];constructor(l,m){super(),this._platformLocation=l,m!=null&&(this._baseHref=m)}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(l){this._removeListenerFns.push(this._platformLocation.onPopState(l),this._platformLocation.onHashChange(l))}getBaseHref(){return this._baseHref}path(l=!1){let m=this._platformLocation.hash??"#";return m.length>0?m.substring(1):m}prepareExternalUrl(l){let m=_x(this._baseHref,l);return m.length>0?"#"+m:m}pushState(l,m,b,r){let M=this.prepareExternalUrl(b+ra(r))||this._platformLocation.pathname;this._platformLocation.pushState(l,m,M)}replaceState(l,m,b,r){let M=this.prepareExternalUrl(b+ra(r))||this._platformLocation.pathname;this._platformLocation.replaceState(l,m,M)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(l=0){this._platformLocation.historyGo?.(l)}static \u0275fac=function(m){return new(m||a)(un(s_),un(yx,8))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})();var oI=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275mod=Uo({type:a});static \u0275inj=vo({})}return a})();function a_(a,d){d=encodeURIComponent(d);for(let l of a.split(";")){let m=l.indexOf("="),[b,r]=m==-1?[l,""]:[l.slice(0,m),l.slice(m+1)];if(b.trim()===d)return decodeURIComponent(r)}return null}var Fd=class{};var rO="browser";var oO=(()=>{class a{static \u0275prov=Xt({token:a,providedIn:"root",factory:()=>new sI(mt(dr),window)})}return a})(),sI=class{document;window;offset=()=>[0,0];constructor(d,l){this.document=d,this.window=l}setOffset(d){Array.isArray(d)?this.offset=()=>d:this.offset=d}getScrollPosition(){return[this.window.scrollX,this.window.scrollY]}scrollToPosition(d,l){this.window.scrollTo(Vi(Gt({},l),{left:d[0],top:d[1]}))}scrollToAnchor(d,l){let m=zU(this.document,d);m&&(this.scrollToElement(m,l),m.focus())}setHistoryScrollRestoration(d){try{this.window.history.scrollRestoration=d}catch{console.warn(gd(2400,!1))}}scrollToElement(d,l){let m=d.getBoundingClientRect(),b=m.left+this.window.pageXOffset,r=m.top+this.window.pageYOffset,M=this.offset();this.window.scrollTo(Vi(Gt({},l),{left:b-M[0],top:r-M[1]}))}};function zU(a,d){let l=a.getElementById(d)||a.getElementsByName(d)[0];if(l)return l;if(typeof a.createTreeWalker=="function"&&a.body&&typeof a.body.attachShadow=="function"){let m=a.createTreeWalker(a.body,NodeFilter.SHOW_ELEMENT),b=m.currentNode;for(;b;){let r=b.shadowRoot;if(r){let M=r.getElementById(d)||r.querySelector(`[name="${d}"]`);if(M)return M}b=m.nextNode()}}return null}var bx=new Kt(""),dI=(()=>{class a{_zone;_plugins;_eventNameToPlugin=new Map;constructor(l,m){this._zone=m,l.forEach(b=>{b.manager=this}),this._plugins=l.slice().reverse()}addEventListener(l,m,b,r){return this._findPluginFor(m).addEventListener(l,m,b,r)}getZone(){return this._zone}_findPluginFor(l){let m=this._eventNameToPlugin.get(l);if(m)return m;if(m=this._plugins.find(r=>r.supports(l)),!m)throw new en(5101,!1);return this._eventNameToPlugin.set(l,m),m}static \u0275fac=function(m){return new(m||a)(un(bx),un(Gi))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),l_=class{_doc;constructor(d){this._doc=d}manager},aI="ng-app-id";function sO(a){for(let d of a)d.remove()}function aO(a,d){let l=d.createElement("style");return l.textContent=a,l}function BU(a,d,l,m){let b=a.head?.querySelectorAll(`style[${aI}="${d}"],link[${aI}="${d}"]`);if(b)for(let r of b)r.removeAttribute(aI),r instanceof HTMLLinkElement?m.set(r.href.slice(r.href.lastIndexOf("/")+1),{usage:0,elements:[r]}):r.textContent&&l.set(r.textContent,{usage:0,elements:[r]})}function cI(a,d){let l=d.createElement("link");return l.setAttribute("rel","stylesheet"),l.setAttribute("href",a),l}var hI=(()=>{class a{doc;appId;nonce;inline=new Map;external=new Map;hosts=new Set;constructor(l,m,b,r={}){this.doc=l,this.appId=m,this.nonce=b,BU(l,m,this.inline,this.external),this.hosts.add(l.head)}addStyles(l,m){for(let b of l)this.addUsage(b,this.inline,aO);m?.forEach(b=>this.addUsage(b,this.external,cI))}removeStyles(l,m){for(let b of l)this.removeUsage(b,this.inline);m?.forEach(b=>this.removeUsage(b,this.external))}addUsage(l,m,b){let r=m.get(l);r?r.usage++:m.set(l,{usage:1,elements:[...this.hosts].map(M=>this.addElement(M,b(l,this.doc)))})}removeUsage(l,m){let b=m.get(l);b&&(b.usage--,b.usage<=0&&(sO(b.elements),m.delete(l)))}ngOnDestroy(){for(let[,{elements:l}]of[...this.inline,...this.external])sO(l);this.hosts.clear()}addHost(l){this.hosts.add(l);for(let[m,{elements:b}]of this.inline)b.push(this.addElement(l,aO(m,this.doc)));for(let[m,{elements:b}]of this.external)b.push(this.addElement(l,cI(m,this.doc)))}removeHost(l){this.hosts.delete(l)}addElement(l,m){return this.nonce&&m.setAttribute("nonce",this.nonce),l.appendChild(m)}static \u0275fac=function(m){return new(m||a)(un(dr),un(ex),un(nx,8),un(Uf))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),lI={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},fI=/%COMP%/g;var cO="%COMP%",VU=`_nghost-${cO}`,jU=`_ngcontent-${cO}`,UU=!0,HU=new Kt("",{providedIn:"root",factory:()=>UU});function $U(a){return jU.replace(fI,a)}function GU(a){return VU.replace(fI,a)}function uO(a,d){return d.map(l=>l.replace(fI,a))}var pI=(()=>{class a{eventManager;sharedStylesHost;appId;removeStylesOnCompDestroy;doc;platformId;ngZone;nonce;tracingService;rendererByCompId=new Map;defaultRenderer;platformIsServer;constructor(l,m,b,r,M,N,G,fe=null,Me=null){this.eventManager=l,this.sharedStylesHost=m,this.appId=b,this.removeStylesOnCompDestroy=r,this.doc=M,this.platformId=N,this.ngZone=G,this.nonce=fe,this.tracingService=Me,this.platformIsServer=!1,this.defaultRenderer=new c_(l,M,G,this.platformIsServer,this.tracingService)}createRenderer(l,m){if(!l||!m)return this.defaultRenderer;let b=this.getOrCreateRenderer(l,m);return b instanceof xx?b.applyToHost(l):b instanceof u_&&b.applyStyles(),b}getOrCreateRenderer(l,m){let b=this.rendererByCompId,r=b.get(m.id);if(!r){let M=this.doc,N=this.ngZone,G=this.eventManager,fe=this.sharedStylesHost,Me=this.removeStylesOnCompDestroy,Ue=this.platformIsServer,bt=this.tracingService;switch(m.encapsulation){case Ol.Emulated:r=new xx(G,fe,m,this.appId,Me,M,N,Ue,bt);break;case Ol.ShadowDom:return new uI(G,fe,l,m,M,N,this.nonce,Ue,bt);default:r=new u_(G,fe,m,Me,M,N,Ue,bt);break}b.set(m.id,r)}return r}ngOnDestroy(){this.rendererByCompId.clear()}componentReplaced(l){this.rendererByCompId.delete(l)}static \u0275fac=function(m){return new(m||a)(un(dI),un(hI),un(ex),un(HU),un(dr),un(Uf),un(Gi),un(nx),un(Od,8))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),c_=class{eventManager;doc;ngZone;platformIsServer;tracingService;data=Object.create(null);throwOnSyntheticProps=!0;constructor(d,l,m,b,r){this.eventManager=d,this.doc=l,this.ngZone=m,this.platformIsServer=b,this.tracingService=r}destroy(){}destroyNode=null;createElement(d,l){return l?this.doc.createElementNS(lI[l]||l,d):this.doc.createElement(d)}createComment(d){return this.doc.createComment(d)}createText(d){return this.doc.createTextNode(d)}appendChild(d,l){(lO(d)?d.content:d).appendChild(l)}insertBefore(d,l,m){d&&(lO(d)?d.content:d).insertBefore(l,m)}removeChild(d,l){l.remove()}selectRootElement(d,l){let m=typeof d=="string"?this.doc.querySelector(d):d;if(!m)throw new en(-5104,!1);return l||(m.textContent=""),m}parentNode(d){return d.parentNode}nextSibling(d){return d.nextSibling}setAttribute(d,l,m,b){if(b){l=b+":"+l;let r=lI[b];r?d.setAttributeNS(r,l,m):d.setAttribute(l,m)}else d.setAttribute(l,m)}removeAttribute(d,l,m){if(m){let b=lI[m];b?d.removeAttributeNS(b,l):d.removeAttribute(`${m}:${l}`)}else d.removeAttribute(l)}addClass(d,l){d.classList.add(l)}removeClass(d,l){d.classList.remove(l)}setStyle(d,l,m,b){b&(Ll.DashCase|Ll.Important)?d.style.setProperty(l,m,b&Ll.Important?"important":""):d.style[l]=m}removeStyle(d,l,m){m&Ll.DashCase?d.style.removeProperty(l):d.style[l]=""}setProperty(d,l,m){d!=null&&(d[l]=m)}setValue(d,l){d.nodeValue=l}listen(d,l,m,b){if(typeof d=="string"&&(d=qa().getGlobalEventTarget(this.doc,d),!d))throw new en(5102,!1);let r=this.decoratePreventDefault(m);return this.tracingService?.wrapEventListener&&(r=this.tracingService.wrapEventListener(d,l,r)),this.eventManager.addEventListener(d,l,r,b)}decoratePreventDefault(d){return l=>{if(l==="__ngUnwrap__")return d;d(l)===!1&&l.preventDefault()}}};function lO(a){return a.tagName==="TEMPLATE"&&a.content!==void 0}var uI=class extends c_{sharedStylesHost;hostEl;shadowRoot;constructor(d,l,m,b,r,M,N,G,fe){super(d,r,M,G,fe),this.sharedStylesHost=l,this.hostEl=m,this.shadowRoot=m.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);let Me=b.styles;Me=uO(b.id,Me);for(let bt of Me){let Fe=document.createElement("style");N&&Fe.setAttribute("nonce",N),Fe.textContent=bt,this.shadowRoot.appendChild(Fe)}let Ue=b.getExternalStyles?.();if(Ue)for(let bt of Ue){let Fe=cI(bt,r);N&&Fe.setAttribute("nonce",N),this.shadowRoot.appendChild(Fe)}}nodeOrShadowRoot(d){return d===this.hostEl?this.shadowRoot:d}appendChild(d,l){return super.appendChild(this.nodeOrShadowRoot(d),l)}insertBefore(d,l,m){return super.insertBefore(this.nodeOrShadowRoot(d),l,m)}removeChild(d,l){return super.removeChild(null,l)}parentNode(d){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(d)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}},u_=class extends c_{sharedStylesHost;removeStylesOnCompDestroy;styles;styleUrls;constructor(d,l,m,b,r,M,N,G,fe){super(d,r,M,N,G),this.sharedStylesHost=l,this.removeStylesOnCompDestroy=b;let Me=m.styles;this.styles=fe?uO(fe,Me):Me,this.styleUrls=m.getExternalStyles?.(fe)}applyStyles(){this.sharedStylesHost.addStyles(this.styles,this.styleUrls)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles,this.styleUrls)}},xx=class extends u_{contentAttr;hostAttr;constructor(d,l,m,b,r,M,N,G,fe){let Me=b+"-"+m.id;super(d,l,m,r,M,N,G,fe,Me),this.contentAttr=$U(Me),this.hostAttr=GU(Me)}applyToHost(d){this.applyStyles(),this.setAttribute(d,this.hostAttr,"")}createElement(d,l){let m=super.createElement(d,l);return super.setAttribute(m,this.contentAttr,""),m}};var wx=class a extends o_{supportsDOMEvents=!0;static makeCurrent(){nI(new a)}onAndCancel(d,l,m,b){return d.addEventListener(l,m,b),()=>{d.removeEventListener(l,m,b)}}dispatchEvent(d,l){d.dispatchEvent(l)}remove(d){d.remove()}createElement(d,l){return l=l||this.getDefaultDocument(),l.createElement(d)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(d){return d.nodeType===Node.ELEMENT_NODE}isShadowRoot(d){return d instanceof DocumentFragment}getGlobalEventTarget(d,l){return l==="window"?window:l==="document"?d:l==="body"?d.body:null}getBaseHref(d){let l=qU();return l==null?null:WU(l)}resetBaseElement(){d_=null}getUserAgent(){return window.navigator.userAgent}getCookie(d){return a_(document.cookie,d)}},d_=null;function qU(){return d_=d_||document.head.querySelector("base"),d_?d_.getAttribute("href"):null}function WU(a){return new URL(a,document.baseURI).pathname}var Ex=class{addToWindow(d){Qs.getAngularTestability=(m,b=!0)=>{let r=d.findTestabilityInTree(m,b);if(r==null)throw new en(5103,!1);return r},Qs.getAllAngularTestabilities=()=>d.getAllTestabilities(),Qs.getAllAngularRootElements=()=>d.getAllRootElements();let l=m=>{let b=Qs.getAllAngularTestabilities(),r=b.length,M=function(){r--,r==0&&m()};b.forEach(N=>{N.whenStable(M)})};Qs.frameworkStabilizers||(Qs.frameworkStabilizers=[]),Qs.frameworkStabilizers.push(l)}findTestabilityInTree(d,l,m){if(l==null)return null;let b=d.getTestability(l);return b??(m?qa().isShadowRoot(l)?this.findTestabilityInTree(d,l.host,!0):this.findTestabilityInTree(d,l.parentElement,!0):null)}},ZU=(()=>{class a{build(){return new XMLHttpRequest}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),hO=(()=>{class a extends l_{constructor(l){super(l)}supports(l){return!0}addEventListener(l,m,b,r){return l.addEventListener(m,b,r),()=>this.removeEventListener(l,m,b,r)}removeEventListener(l,m,b,r){return l.removeEventListener(m,b,r)}static \u0275fac=function(m){return new(m||a)(un(dr))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),dO=["alt","control","meta","shift"],XU={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},YU={alt:a=>a.altKey,control:a=>a.ctrlKey,meta:a=>a.metaKey,shift:a=>a.shiftKey},fO=(()=>{class a extends l_{constructor(l){super(l)}supports(l){return a.parseEventName(l)!=null}addEventListener(l,m,b,r){let M=a.parseEventName(m),N=a.eventCallback(M.fullKey,b,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>qa().onAndCancel(l,M.domEventName,N,r))}static parseEventName(l){let m=l.toLowerCase().split("."),b=m.shift();if(m.length===0||!(b==="keydown"||b==="keyup"))return null;let r=a._normalizeKey(m.pop()),M="",N=m.indexOf("code");if(N>-1&&(m.splice(N,1),M="code."),dO.forEach(fe=>{let Me=m.indexOf(fe);Me>-1&&(m.splice(Me,1),M+=fe+".")}),M+=r,m.length!=0||r.length===0)return null;let G={};return G.domEventName=b,G.fullKey=M,G}static matchEventFullKeyCode(l,m){let b=XU[l.key]||l.key,r="";return m.indexOf("code.")>-1&&(b=l.code,r="code."),b==null||!b?!1:(b=b.toLowerCase(),b===" "?b="space":b==="."&&(b="dot"),dO.forEach(M=>{if(M!==b){let N=YU[M];N(l)&&(r+=M+".")}}),r+=b,r===m)}static eventCallback(l,m,b){return r=>{a.matchEventFullKeyCode(r,l)&&b.runGuarded(()=>m(r))}}static _normalizeKey(l){return l==="esc"?"escape":l}static \u0275fac=function(m){return new(m||a)(un(dr))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})();function KU(){wx.makeCurrent()}function JU(){return new Js}function QU(){return xT(document),document}var e5=[{provide:Uf,useValue:rO},{provide:tx,useValue:KU,multi:!0},{provide:dr,useFactory:QU}],mI=tI(KP,"browser",e5);var t5=[{provide:$f,useClass:Ex},{provide:cx,useClass:Kg,deps:[Gi,Jg,$f]},{provide:Kg,useClass:Kg,deps:[Gi,Jg,$f]}],n5=[{provide:Tg,useValue:"root"},{provide:Js,useFactory:JU},{provide:bx,useClass:hO,multi:!0,deps:[dr]},{provide:bx,useClass:fO,multi:!0,deps:[dr]},pI,hI,dI,{provide:Sd,useExisting:pI},{provide:Fd,useClass:ZU},[]],gI=(()=>{class a{constructor(){}static \u0275fac=function(m){return new(m||a)};static \u0275mod=Uo({type:a});static \u0275inj=vo({providers:[...n5,...t5],imports:[oI,JP]})}return a})();var qf=class{},p_=class{},Nd=class a{headers;normalizedNames=new Map;lazyInit;lazyUpdate=null;constructor(d){d?typeof d=="string"?this.lazyInit=()=>{this.headers=new Map,d.split(`
`).forEach(l=>{let m=l.indexOf(":");if(m>0){let b=l.slice(0,m),r=l.slice(m+1).trim();this.addHeaderEntry(b,r)}})}:typeof Headers<"u"&&d instanceof Headers?(this.headers=new Map,d.forEach((l,m)=>{this.addHeaderEntry(m,l)})):this.lazyInit=()=>{this.headers=new Map,Object.entries(d).forEach(([l,m])=>{this.setHeaderEntries(l,m)})}:this.headers=new Map}has(d){return this.init(),this.headers.has(d.toLowerCase())}get(d){this.init();let l=this.headers.get(d.toLowerCase());return l&&l.length>0?l[0]:null}keys(){return this.init(),Array.from(this.normalizedNames.values())}getAll(d){return this.init(),this.headers.get(d.toLowerCase())||null}append(d,l){return this.clone({name:d,value:l,op:"a"})}set(d,l){return this.clone({name:d,value:l,op:"s"})}delete(d,l){return this.clone({name:d,value:l,op:"d"})}maybeSetNormalizedName(d,l){this.normalizedNames.has(l)||this.normalizedNames.set(l,d)}init(){this.lazyInit&&(this.lazyInit instanceof a?this.copyFrom(this.lazyInit):this.lazyInit(),this.lazyInit=null,this.lazyUpdate&&(this.lazyUpdate.forEach(d=>this.applyUpdate(d)),this.lazyUpdate=null))}copyFrom(d){d.init(),Array.from(d.headers.keys()).forEach(l=>{this.headers.set(l,d.headers.get(l)),this.normalizedNames.set(l,d.normalizedNames.get(l))})}clone(d){let l=new a;return l.lazyInit=this.lazyInit&&this.lazyInit instanceof a?this.lazyInit:this,l.lazyUpdate=(this.lazyUpdate||[]).concat([d]),l}applyUpdate(d){let l=d.name.toLowerCase();switch(d.op){case"a":case"s":let m=d.value;if(typeof m=="string"&&(m=[m]),m.length===0)return;this.maybeSetNormalizedName(d.name,l);let b=(d.op==="a"?this.headers.get(l):void 0)||[];b.push(...m),this.headers.set(l,b);break;case"d":let r=d.value;if(!r)this.headers.delete(l),this.normalizedNames.delete(l);else{let M=this.headers.get(l);if(!M)return;M=M.filter(N=>r.indexOf(N)===-1),M.length===0?(this.headers.delete(l),this.normalizedNames.delete(l)):this.headers.set(l,M)}break}}addHeaderEntry(d,l){let m=d.toLowerCase();this.maybeSetNormalizedName(d,m),this.headers.has(m)?this.headers.get(m).push(l):this.headers.set(m,[l])}setHeaderEntries(d,l){let m=(Array.isArray(l)?l:[l]).map(r=>r.toString()),b=d.toLowerCase();this.headers.set(b,m),this.maybeSetNormalizedName(d,b)}forEach(d){this.init(),Array.from(this.normalizedNames.keys()).forEach(l=>d(this.normalizedNames.get(l),this.headers.get(l)))}};var Ix=class{encodeKey(d){return pO(d)}encodeValue(d){return pO(d)}decodeKey(d){return decodeURIComponent(d)}decodeValue(d){return decodeURIComponent(d)}};function i5(a,d){let l=new Map;return a.length>0&&a.replace(/^\?/,"").split("&").forEach(b=>{let r=b.indexOf("="),[M,N]=r==-1?[d.decodeKey(b),""]:[d.decodeKey(b.slice(0,r)),d.decodeValue(b.slice(r+1))],G=l.get(M)||[];G.push(N),l.set(M,G)}),l}var r5=/%(\d[a-f0-9])/gi,o5={40:"@","3A":":",24:"$","2C":",","3B":";","3D":"=","3F":"?","2F":"/"};function pO(a){return encodeURIComponent(a).replace(r5,(d,l)=>o5[l]??d)}function Tx(a){return`${a}`}var Jc=class a{map;encoder;updates=null;cloneFrom=null;constructor(d={}){if(this.encoder=d.encoder||new Ix,d.fromString){if(d.fromObject)throw new en(2805,!1);this.map=i5(d.fromString,this.encoder)}else d.fromObject?(this.map=new Map,Object.keys(d.fromObject).forEach(l=>{let m=d.fromObject[l],b=Array.isArray(m)?m.map(Tx):[Tx(m)];this.map.set(l,b)})):this.map=null}has(d){return this.init(),this.map.has(d)}get(d){this.init();let l=this.map.get(d);return l?l[0]:null}getAll(d){return this.init(),this.map.get(d)||null}keys(){return this.init(),Array.from(this.map.keys())}append(d,l){return this.clone({param:d,value:l,op:"a"})}appendAll(d){let l=[];return Object.keys(d).forEach(m=>{let b=d[m];Array.isArray(b)?b.forEach(r=>{l.push({param:m,value:r,op:"a"})}):l.push({param:m,value:b,op:"a"})}),this.clone(l)}set(d,l){return this.clone({param:d,value:l,op:"s"})}delete(d,l){return this.clone({param:d,value:l,op:"d"})}toString(){return this.init(),this.keys().map(d=>{let l=this.encoder.encodeKey(d);return this.map.get(d).map(m=>l+"="+this.encoder.encodeValue(m)).join("&")}).filter(d=>d!=="").join("&")}clone(d){let l=new a({encoder:this.encoder});return l.cloneFrom=this.cloneFrom||this,l.updates=(this.updates||[]).concat(d),l}init(){this.map===null&&(this.map=new Map),this.cloneFrom!==null&&(this.cloneFrom.init(),this.cloneFrom.keys().forEach(d=>this.map.set(d,this.cloneFrom.map.get(d))),this.updates.forEach(d=>{switch(d.op){case"a":case"s":let l=(d.op==="a"?this.map.get(d.param):void 0)||[];l.push(Tx(d.value)),this.map.set(d.param,l);break;case"d":if(d.value!==void 0){let m=this.map.get(d.param)||[],b=m.indexOf(Tx(d.value));b!==-1&&m.splice(b,1),m.length>0?this.map.set(d.param,m):this.map.delete(d.param)}else{this.map.delete(d.param);break}}}),this.cloneFrom=this.updates=null)}};var Sx=class{map=new Map;set(d,l){return this.map.set(d,l),this}get(d){return this.map.has(d)||this.map.set(d,d.defaultValue()),this.map.get(d)}delete(d){return this.map.delete(d),this}has(d){return this.map.has(d)}keys(){return this.map.keys()}};function s5(a){switch(a){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"JSONP":return!1;default:return!0}}function mO(a){return typeof ArrayBuffer<"u"&&a instanceof ArrayBuffer}function gO(a){return typeof Blob<"u"&&a instanceof Blob}function _O(a){return typeof FormData<"u"&&a instanceof FormData}function a5(a){return typeof URLSearchParams<"u"&&a instanceof URLSearchParams}var yO="Content-Type",vO="Accept",bO="X-Request-URL",wO="text/plain",EO="application/json",l5=`${EO}, ${wO}, */*`,h_=class a{url;body=null;headers;context;reportProgress=!1;withCredentials=!1;credentials;keepalive=!1;cache;priority;mode;redirect;responseType="json";method;params;urlWithParams;transferCache;timeout;constructor(d,l,m,b){this.url=l,this.method=d.toUpperCase();let r;if(s5(this.method)||b?(this.body=m!==void 0?m:null,r=b):r=m,r){if(this.reportProgress=!!r.reportProgress,this.withCredentials=!!r.withCredentials,this.keepalive=!!r.keepalive,r.responseType&&(this.responseType=r.responseType),r.headers&&(this.headers=r.headers),r.context&&(this.context=r.context),r.params&&(this.params=r.params),r.priority&&(this.priority=r.priority),r.cache&&(this.cache=r.cache),r.credentials&&(this.credentials=r.credentials),typeof r.timeout=="number"){if(r.timeout<1||!Number.isInteger(r.timeout))throw new Error("");this.timeout=r.timeout}r.mode&&(this.mode=r.mode),r.redirect&&(this.redirect=r.redirect),this.transferCache=r.transferCache}if(this.headers??=new Nd,this.context??=new Sx,!this.params)this.params=new Jc,this.urlWithParams=l;else{let M=this.params.toString();if(M.length===0)this.urlWithParams=l;else{let N=l.indexOf("?"),G=N===-1?"?":N<l.length-1?"&":"";this.urlWithParams=l+G+M}}}serializeBody(){return this.body===null?null:typeof this.body=="string"||mO(this.body)||gO(this.body)||_O(this.body)||a5(this.body)?this.body:this.body instanceof Jc?this.body.toString():typeof this.body=="object"||typeof this.body=="boolean"||Array.isArray(this.body)?JSON.stringify(this.body):this.body.toString()}detectContentTypeHeader(){return this.body===null||_O(this.body)?null:gO(this.body)?this.body.type||null:mO(this.body)?null:typeof this.body=="string"?wO:this.body instanceof Jc?"application/x-www-form-urlencoded;charset=UTF-8":typeof this.body=="object"||typeof this.body=="number"||typeof this.body=="boolean"?EO:null}clone(d={}){let l=d.method||this.method,m=d.url||this.url,b=d.responseType||this.responseType,r=d.keepalive??this.keepalive,M=d.priority||this.priority,N=d.cache||this.cache,G=d.mode||this.mode,fe=d.redirect||this.redirect,Me=d.credentials||this.credentials,Ue=d.transferCache??this.transferCache,bt=d.timeout??this.timeout,Fe=d.body!==void 0?d.body:this.body,Pt=d.withCredentials??this.withCredentials,Vt=d.reportProgress??this.reportProgress,jt=d.headers||this.headers,Nt=d.params||this.params,ar=d.context??this.context;return d.setHeaders!==void 0&&(jt=Object.keys(d.setHeaders).reduce((lr,Ri)=>lr.set(Ri,d.setHeaders[Ri]),jt)),d.setParams&&(Nt=Object.keys(d.setParams).reduce((lr,Ri)=>lr.set(Ri,d.setParams[Ri]),Nt)),new a(l,m,Fe,{params:Nt,headers:jt,context:ar,reportProgress:Vt,responseType:b,withCredentials:Pt,transferCache:Ue,keepalive:r,cache:N,priority:M,timeout:bt,mode:G,redirect:fe,credentials:Me})}},Gf=function(a){return a[a.Sent=0]="Sent",a[a.UploadProgress=1]="UploadProgress",a[a.ResponseHeader=2]="ResponseHeader",a[a.DownloadProgress=3]="DownloadProgress",a[a.Response=4]="Response",a[a.User=5]="User",a}(Gf||{}),Wf=class{headers;status;statusText;url;ok;type;constructor(d,l=200,m="OK"){this.headers=d.headers||new Nd,this.status=d.status!==void 0?d.status:l,this.statusText=d.statusText||m,this.url=d.url||null,this.ok=this.status>=200&&this.status<300}},Dx=class a extends Wf{constructor(d={}){super(d)}type=Gf.ResponseHeader;clone(d={}){return new a({headers:d.headers||this.headers,status:d.status!==void 0?d.status:this.status,statusText:d.statusText||this.statusText,url:d.url||this.url||void 0})}},Cx=class a extends Wf{body;constructor(d={}){super(d),this.body=d.body!==void 0?d.body:null}type=Gf.Response;clone(d={}){return new a({body:d.body!==void 0?d.body:this.body,headers:d.headers||this.headers,status:d.status!==void 0?d.status:this.status,statusText:d.statusText||this.statusText,url:d.url||this.url||void 0})}},f_=class extends Wf{name="HttpErrorResponse";message;error;ok=!1;constructor(d){super(d,0,"Unknown Error"),this.status>=200&&this.status<300?this.message=`Http failure during parsing for ${d.url||"(unknown url)"}`:this.message=`Http failure response for ${d.url||"(unknown url)"}: ${d.status} ${d.statusText}`,this.error=d.error||null}},c5=200,u5=204;function _I(a,d){return{body:d,headers:a.headers,context:a.context,observe:a.observe,params:a.params,reportProgress:a.reportProgress,responseType:a.responseType,withCredentials:a.withCredentials,transferCache:a.transferCache,keepalive:a.keepalive,priority:a.priority,cache:a.cache,mode:a.mode,redirect:a.redirect}}var d5=(()=>{class a{handler;constructor(l){this.handler=l}request(l,m,b={}){let r;if(l instanceof h_)r=l;else{let G;b.headers instanceof Nd?G=b.headers:G=new Nd(b.headers);let fe;b.params&&(b.params instanceof Jc?fe=b.params:fe=new Jc({fromObject:b.params})),r=new h_(l,m,b.body!==void 0?b.body:null,{headers:G,context:b.context,params:fe,reportProgress:b.reportProgress,responseType:b.responseType||"json",withCredentials:b.withCredentials,transferCache:b.transferCache,keepalive:b.keepalive,priority:b.priority,cache:b.cache,mode:b.mode,redirect:b.redirect,credentials:b.credentials})}let M=In(r).pipe(Ba(G=>this.handler.handle(G)));if(l instanceof h_||b.observe==="events")return M;let N=M.pipe(yo(G=>G instanceof Cx));switch(b.observe||"body"){case"body":switch(r.responseType){case"arraybuffer":return N.pipe(oi(G=>{if(G.body!==null&&!(G.body instanceof ArrayBuffer))throw new en(2806,!1);return G.body}));case"blob":return N.pipe(oi(G=>{if(G.body!==null&&!(G.body instanceof Blob))throw new en(2807,!1);return G.body}));case"text":return N.pipe(oi(G=>{if(G.body!==null&&typeof G.body!="string")throw new en(2808,!1);return G.body}));case"json":default:return N.pipe(oi(G=>G.body))}case"response":return N;default:throw new en(2809,!1)}}delete(l,m={}){return this.request("DELETE",l,m)}get(l,m={}){return this.request("GET",l,m)}head(l,m={}){return this.request("HEAD",l,m)}jsonp(l,m){return this.request("JSONP",l,{params:new Jc().append(m,"JSONP_CALLBACK"),observe:"body",responseType:"json"})}options(l,m={}){return this.request("OPTIONS",l,m)}patch(l,m,b={}){return this.request("PATCH",l,_I(b,m))}post(l,m,b={}){return this.request("POST",l,_I(b,m))}put(l,m,b={}){return this.request("PUT",l,_I(b,m))}static \u0275fac=function(m){return new(m||a)(un(qf))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})();var h5=new Kt("");function TO(a,d){return d(a)}function f5(a,d){return(l,m)=>d.intercept(l,{handle:b=>a(b,m)})}function p5(a,d,l){return(m,b)=>Xr(l,()=>d(m,r=>a(r,b)))}var IO=new Kt(""),vI=new Kt(""),m5=new Kt(""),xI=new Kt("",{providedIn:"root",factory:()=>!0});function g5(){let a=null;return(d,l)=>{a===null&&(a=(mt(IO,{optional:!0})??[]).reduceRight(f5,TO));let m=mt(Fg);if(mt(xI)){let r=m.add();return a(d,l).pipe(zc(r))}else return a(d,l)}}var Ax=(()=>{class a extends qf{backend;injector;chain=null;pendingTasks=mt(Fg);contributeToStability=mt(xI);constructor(l,m){super(),this.backend=l,this.injector=m}handle(l){if(this.chain===null){let m=Array.from(new Set([...this.injector.get(vI),...this.injector.get(m5,[])]));this.chain=m.reduceRight((b,r)=>p5(b,r,this.injector),TO)}if(this.contributeToStability){let m=this.pendingTasks.add();return this.chain(l,b=>this.backend.handle(b)).pipe(zc(m))}else return this.chain(l,m=>this.backend.handle(m))}static \u0275fac=function(m){return new(m||a)(un(p_),un(wr))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})();var _5=/^\)\]\}',?\n/,y5=RegExp(`^${bO}:`,"m");function v5(a){return"responseURL"in a&&a.responseURL?a.responseURL:y5.test(a.getAllResponseHeaders())?a.getResponseHeader(bO):null}var yI=(()=>{class a{xhrFactory;constructor(l){this.xhrFactory=l}handle(l){if(l.method==="JSONP")throw new en(-2800,!1);let m=this.xhrFactory;return In(null).pipe(zo(()=>new xi(r=>{let M=m.build();if(M.open(l.method,l.urlWithParams),l.withCredentials&&(M.withCredentials=!0),l.headers.forEach((jt,Nt)=>M.setRequestHeader(jt,Nt.join(","))),l.headers.has(vO)||M.setRequestHeader(vO,l5),!l.headers.has(yO)){let jt=l.detectContentTypeHeader();jt!==null&&M.setRequestHeader(yO,jt)}if(l.timeout&&(M.timeout=l.timeout),l.responseType){let jt=l.responseType.toLowerCase();M.responseType=jt!=="json"?jt:"text"}let N=l.serializeBody(),G=null,fe=()=>{if(G!==null)return G;let jt=M.statusText||"OK",Nt=new Nd(M.getAllResponseHeaders()),ar=v5(M)||l.url;return G=new Dx({headers:Nt,status:M.status,statusText:jt,url:ar}),G},Me=()=>{let{headers:jt,status:Nt,statusText:ar,url:lr}=fe(),Ri=null;Nt!==u5&&(Ri=typeof M.response>"u"?M.responseText:M.response),Nt===0&&(Nt=Ri?c5:0);let _s=Nt>=200&&Nt<300;if(l.responseType==="json"&&typeof Ri=="string"){let xo=Ri;Ri=Ri.replace(_5,"");try{Ri=Ri!==""?JSON.parse(Ri):null}catch(ys){Ri=xo,_s&&(_s=!1,Ri={error:ys,text:Ri})}}_s?(r.next(new Cx({body:Ri,headers:jt,status:Nt,statusText:ar,url:lr||void 0})),r.complete()):r.error(new f_({error:Ri,headers:jt,status:Nt,statusText:ar,url:lr||void 0}))},Ue=jt=>{let{url:Nt}=fe(),ar=new f_({error:jt,status:M.status||0,statusText:M.statusText||"Unknown Error",url:Nt||void 0});r.error(ar)},bt=Ue;l.timeout&&(bt=jt=>{let{url:Nt}=fe(),ar=new f_({error:new DOMException("Request timed out","TimeoutError"),status:M.status||0,statusText:M.statusText||"Request timeout",url:Nt||void 0});r.error(ar)});let Fe=!1,Pt=jt=>{Fe||(r.next(fe()),Fe=!0);let Nt={type:Gf.DownloadProgress,loaded:jt.loaded};jt.lengthComputable&&(Nt.total=jt.total),l.responseType==="text"&&M.responseText&&(Nt.partialText=M.responseText),r.next(Nt)},Vt=jt=>{let Nt={type:Gf.UploadProgress,loaded:jt.loaded};jt.lengthComputable&&(Nt.total=jt.total),r.next(Nt)};return M.addEventListener("load",Me),M.addEventListener("error",Ue),M.addEventListener("timeout",bt),M.addEventListener("abort",Ue),l.reportProgress&&(M.addEventListener("progress",Pt),N!==null&&M.upload&&M.upload.addEventListener("progress",Vt)),M.send(N),r.next({type:Gf.Sent}),()=>{M.removeEventListener("error",Ue),M.removeEventListener("abort",Ue),M.removeEventListener("load",Me),M.removeEventListener("timeout",bt),l.reportProgress&&(M.removeEventListener("progress",Pt),N!==null&&M.upload&&M.upload.removeEventListener("progress",Vt)),M.readyState!==M.DONE&&M.abort()}})))}static \u0275fac=function(m){return new(m||a)(un(Fd))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),SO=new Kt(""),x5="XSRF-TOKEN",b5=new Kt("",{providedIn:"root",factory:()=>x5}),w5="X-XSRF-TOKEN",E5=new Kt("",{providedIn:"root",factory:()=>w5}),m_=class{},T5=(()=>{class a{doc;cookieName;lastCookieString="";lastToken=null;parseCount=0;constructor(l,m){this.doc=l,this.cookieName=m}getToken(){let l=this.doc.cookie||"";return l!==this.lastCookieString&&(this.parseCount++,this.lastToken=a_(l,this.cookieName),this.lastCookieString=l),this.lastToken}static \u0275fac=function(m){return new(m||a)(un(dr),un(b5))};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})();function I5(a,d){let l=a.url.toLowerCase();if(!mt(SO)||a.method==="GET"||a.method==="HEAD"||l.startsWith("http://")||l.startsWith("https://"))return d(a);let m=mt(m_).getToken(),b=mt(E5);return m!=null&&!a.headers.has(b)&&(a=a.clone({headers:a.headers.set(b,m)})),d(a)}var bI=function(a){return a[a.Interceptors=0]="Interceptors",a[a.LegacyInterceptors=1]="LegacyInterceptors",a[a.CustomXsrfConfiguration=2]="CustomXsrfConfiguration",a[a.NoXsrfProtection=3]="NoXsrfProtection",a[a.JsonpSupport=4]="JsonpSupport",a[a.RequestsMadeViaParent=5]="RequestsMadeViaParent",a[a.Fetch=6]="Fetch",a}(bI||{});function S5(a,d){return{\u0275kind:a,\u0275providers:d}}function DO(...a){let d=[d5,yI,Ax,{provide:qf,useExisting:Ax},{provide:p_,useFactory:()=>mt(h5,{optional:!0})??mt(yI)},{provide:vI,useValue:I5,multi:!0},{provide:SO,useValue:!0},{provide:m_,useClass:T5}];for(let l of a)d.push(...l.\u0275providers);return jc(d)}var xO=new Kt("");function CO(){return S5(bI.LegacyInterceptors,[{provide:xO,useFactory:g5},{provide:vI,useExisting:xO,multi:!0}])}var wI=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275mod=Uo({type:a});static \u0275inj=vo({providers:[DO(CO())]})}return a})();var AO=(()=>{class a{_doc;constructor(l){this._doc=l}getTitle(){return this._doc.title}setTitle(l){this._doc.title=l||""}static \u0275fac=function(m){return new(m||a)(un(dr))};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();var Zf=Az(RO(),1);var II=new Kt("MapboxApiKey"),SI=(()=>{class a{zone=mt(Gi);MAPBOX_API_KEY=mt(II,{optional:!0});injector=mt(Zr);mapInstance;mapCreated$;mapLoaded$;mapEvents;mapCreated=new Ef;mapLoaded=new Ef;markersToRemove=[];popupsToRemove=[];imageIdsToRemove=[];subscription=new _r;constructor(){this.mapCreated$=this.mapCreated.asObservable(),this.mapLoaded$=this.mapLoaded.asObservable()}setup(l){let m=Vi(Gt({},l.mapOptions),{bearing:Array.isArray(l.mapOptions.bearing)?l.mapOptions.bearing[0]:l.mapOptions.bearing,zoom:Array.isArray(l.mapOptions.zoom)?l.mapOptions.zoom[0]:l.mapOptions.zoom,pitch:Array.isArray(l.mapOptions.pitch)?l.mapOptions.pitch[0]:l.mapOptions.pitch,accessToken:l.accessToken||this.MAPBOX_API_KEY||""});this.createMap(m),this.hookEvents(l.mapEvents),this.mapEvents=l.mapEvents,this.mapCreated.next(void 0),this.mapCreated.complete(),l.mapEvents.mapCreate.observed&&this.zone.run(()=>{l.mapEvents.mapCreate.emit(this.mapInstance)})}destroyMap(){this.mapInstance&&(this.subscription.unsubscribe(),this.mapInstance.remove())}updateProjection(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setProjection(l)})}updateMinZoom(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMinZoom(l)})}updateMaxZoom(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMaxZoom(l)})}updateMinPitch(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMinPitch(l)})}updateMaxPitch(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMaxPitch(l)})}updateRenderWorldCopies(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setRenderWorldCopies(l)})}updateScrollZoom(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.scrollZoom.enable():this.mapInstance.scrollZoom.disable()})}updateDragRotate(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.dragRotate.enable():this.mapInstance.dragRotate.disable()})}updateTouchPitch(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.touchPitch.enable():this.mapInstance.touchPitch.disable()})}updateTouchZoomRotate(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.touchZoomRotate.enable():this.mapInstance.touchZoomRotate.disable()})}updateDoubleClickZoom(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.doubleClickZoom.enable():this.mapInstance.doubleClickZoom.disable()})}updateKeyboard(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.keyboard.enable():this.mapInstance.keyboard.disable()})}updateDragPan(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.dragPan.enable():this.mapInstance.dragPan.disable()})}updateBoxZoom(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.boxZoom.enable():this.mapInstance.boxZoom.disable()})}updateStyle(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setStyle(l)})}updateMaxBounds(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMaxBounds(l)})}changeCanvasCursor(l){let m=this.mapInstance.getCanvasContainer();m.style.cursor=l}queryRenderedFeatures(l,m){return this.mapInstance.queryRenderedFeatures(l,m)}panTo(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.panTo(l,m)})}move(l,m,b,r,M,N){return this.zone.runOutsideAngular(()=>{this.mapInstance[l](Vi(Gt({},m),{zoom:b??this.mapInstance.getZoom(),center:r??this.mapInstance.getCenter(),bearing:M??this.mapInstance.getBearing(),pitch:N??this.mapInstance.getPitch()}))})}addLayer(l,m,b){this.zone.runOutsideAngular(()=>{Object.keys(l.layerOptions).forEach(r=>{let M=r;l.layerOptions[M]===void 0&&delete l.layerOptions[M]}),this.mapInstance.addLayer(l.layerOptions,b),m&&(l.layerEvents.layerClick.observed&&this.mapInstance.on("click",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerClick.emit(r)})}),l.layerEvents.layerDblClick.observed&&this.mapInstance.on("dblclick",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerDblClick.emit(r)})}),l.layerEvents.layerMouseDown.observed&&this.mapInstance.on("mousedown",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseDown.emit(r)})}),l.layerEvents.layerMouseUp.observed&&this.mapInstance.on("mouseup",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseUp.emit(r)})}),l.layerEvents.layerMouseEnter.observed&&this.mapInstance.on("mouseenter",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseEnter.emit(r)})}),l.layerEvents.layerMouseLeave.observed&&this.mapInstance.on("mouseleave",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseLeave.emit(r)})}),l.layerEvents.layerMouseMove.observed&&this.mapInstance.on("mousemove",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseMove.emit(r)})}),l.layerEvents.layerMouseOver.observed&&this.mapInstance.on("mouseover",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseOver.emit(r)})}),l.layerEvents.layerMouseOut.observed&&this.mapInstance.on("mouseout",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseOut.emit(r)})}),l.layerEvents.layerContextMenu.observed&&this.mapInstance.on("contextmenu",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerContextMenu.emit(r)})}),l.layerEvents.layerTouchStart.observed&&this.mapInstance.on("touchstart",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerTouchStart.emit(r)})}),l.layerEvents.layerTouchEnd.observed&&this.mapInstance.on("touchend",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerTouchEnd.emit(r)})}),l.layerEvents.layerTouchCancel.observed&&this.mapInstance.on("touchcancel",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerTouchCancel.emit(r)})}))})}removeLayer(l){this.zone.runOutsideAngular(()=>{this.mapInstance.getLayer(l)!=null&&this.mapInstance.removeLayer(l)})}addMarker(l){let m={offset:l.markersOptions.offset,anchor:l.markersOptions.anchor,draggable:l.markersOptions.draggable,rotationAlignment:l.markersOptions.rotationAlignment,pitchAlignment:l.markersOptions.pitchAlignment,clickTolerance:l.markersOptions.clickTolerance};Object.keys(m).forEach(M=>{let N=M;m[N]===void 0&&delete m[N]}),l.markersOptions.element.childNodes.length>0&&(m.element=l.markersOptions.element);let b=new Zf.Marker(m);l.markersEvents.markerDragStart.observed&&b.on("dragstart",M=>{if(M){let{target:N}=M;this.zone.run(()=>{l.markersEvents.markerDragStart.emit(N)})}}),l.markersEvents.markerDrag.observed&&b.on("drag",M=>{if(M){let{target:N}=M;this.zone.run(()=>{l.markersEvents.markerDrag.emit(N)})}}),l.markersEvents.markerDragEnd.observed&&b.on("dragend",M=>{if(M){let{target:N}=M;this.zone.run(()=>{l.markersEvents.markerDragEnd.emit(N)})}});let r=l.markersOptions.feature?l.markersOptions.feature.geometry.coordinates:l.markersOptions.lngLat;return b.setLngLat(r),this.zone.runOutsideAngular(()=>(b.addTo(this.mapInstance),b))}removeMarker(l){this.markersToRemove.push(l)}createPopup(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(l.popupOptions).forEach(r=>{let M=r;return l.popupOptions[M]===void 0&&delete l.popupOptions[M]});let b=new Zf.Popup(l.popupOptions);return b.setDOMContent(m),l.popupEvents.popupClose.observed&&b.on("close",()=>{this.zone.run(()=>{l.popupEvents.popupClose.emit()})}),l.popupEvents.popupOpen.observed&&b.on("open",()=>{this.zone.run(()=>{l.popupEvents.popupOpen.emit()})}),b})}addPopupToMap(l,m,b=!1){return this.zone.runOutsideAngular(()=>{b&&l._listeners&&delete l._listeners.open,l.setLngLat(m),l.addTo(this.mapInstance)})}addPopupToMarker(l,m){return this.zone.runOutsideAngular(()=>{l.setPopup(m)})}removePopupFromMap(l,m=!1){m&&l._listeners&&delete l._listeners.close,this.popupsToRemove.push(l)}removePopupFromMarker(l){return this.zone.runOutsideAngular(()=>{l.setPopup(void 0)})}addControl(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.addControl(l,m)})}removeControl(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.removeControl(l)})}loadAndAddImage(l,m,b){return bl(this,null,function*(){return this.zone.runOutsideAngular(()=>new Promise((r,M)=>{this.mapInstance.loadImage(m,(N,G)=>{if(N){M(N);return}if(!G){M(new Error("Image not loaded"));return}this.addImage(l,G,b),r()})}))})}addImage(l,m,b){return this.zone.runOutsideAngular(()=>{this.mapInstance.addImage(l,m,b)})}removeImage(l){this.imageIdsToRemove.push(l)}addSource(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(m).forEach(b=>{let r=b;return m[r]===void 0&&delete m[r]}),this.mapInstance.addSource(l,m)})}getSource(l){return this.mapInstance.getSource(l)}removeSource(l){this.zone.runOutsideAngular(()=>{this.findLayersBySourceId(l).forEach(m=>this.mapInstance.removeLayer(m.id)),this.mapInstance.removeSource(l)})}setLayerAllPaintProperty(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(m).forEach(b=>{let r=b;this.mapInstance.setPaintProperty(l,r,m[r])})})}setLayerAllLayoutProperty(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(m).forEach(b=>{let r=b;this.mapInstance.setLayoutProperty(l,r,m[r])})})}setLayerFilter(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.setFilter(l,m)})}setLayerBefore(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.moveLayer(l,m)})}setLayerZoomRange(l,m,b){return this.zone.runOutsideAngular(()=>{this.mapInstance.setLayerZoomRange(l,m||0,b||20)})}fitBounds(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.fitBounds(l,m)})}fitScreenCoordinates(l,m,b){return this.zone.runOutsideAngular(()=>{this.mapInstance.fitScreenCoordinates(l[0],l[1],m,b)})}applyChanges(){this.zone.runOutsideAngular(()=>{this.removeMarkers(),this.removePopups(),this.removeImages()})}createMap(l){Gi.assertNotInAngularZone(),Object.keys(l).forEach(m=>{let b=m;l[b]===void 0&&delete l[b]}),this.mapInstance=new Zf.Map(l),BT({write:()=>{this.applyChanges()}},{injector:this.injector})}removeMarkers(){for(let l of this.markersToRemove)l.remove();this.markersToRemove=[]}removePopups(){for(let l of this.popupsToRemove)l.remove();this.popupsToRemove=[]}removeImages(){for(let l of this.imageIdsToRemove)this.mapInstance.removeImage(l);this.imageIdsToRemove=[]}findLayersBySourceId(l){let m=this.mapInstance.getStyle().layers;return m==null?[]:m.filter(b=>"source"in b?b.source===l:!1)}hookEvents(l){this.mapInstance.on("load",m=>{this.mapLoaded.next(void 0),this.mapLoaded.complete(),this.zone.run(()=>{l.mapLoad.emit(m)})}),l.mapResize.observed&&this.mapInstance.on("resize",m=>this.zone.run(()=>{l.mapResize.emit(m)})),l.mapRemove.observed&&this.mapInstance.on("remove",m=>this.zone.run(()=>{l.mapRemove.emit(m)})),l.mapMouseDown.observed&&this.mapInstance.on("mousedown",m=>this.zone.run(()=>{l.mapMouseDown.emit(m)})),l.mapMouseUp.observed&&this.mapInstance.on("mouseup",m=>this.zone.run(()=>{l.mapMouseUp.emit(m)})),l.mapMouseMove.observed&&this.mapInstance.on("mousemove",m=>this.zone.run(()=>{l.mapMouseMove.emit(m)})),l.mapClick.observed&&this.mapInstance.on("click",m=>this.zone.run(()=>{l.mapClick.emit(m)})),l.mapDblClick.observed&&this.mapInstance.on("dblclick",m=>this.zone.run(()=>{l.mapDblClick.emit(m)})),l.mapMouseOver.observed&&this.mapInstance.on("mouseover",m=>this.zone.run(()=>{l.mapMouseOver.emit(m)})),l.mapMouseOut.observed&&this.mapInstance.on("mouseout",m=>this.zone.run(()=>{l.mapMouseOut.emit(m)})),l.mapContextMenu.observed&&this.mapInstance.on("contextmenu",m=>this.zone.run(()=>{l.mapContextMenu.emit(m)})),l.mapTouchStart.observed&&this.mapInstance.on("touchstart",m=>this.zone.run(()=>{l.mapTouchStart.emit(m)})),l.mapTouchEnd.observed&&this.mapInstance.on("touchend",m=>this.zone.run(()=>{l.mapTouchEnd.emit(m)})),l.mapTouchMove.observed&&this.mapInstance.on("touchmove",m=>this.zone.run(()=>{l.mapTouchMove.emit(m)})),l.mapTouchCancel.observed&&this.mapInstance.on("touchcancel",m=>this.zone.run(()=>{l.mapTouchCancel.emit(m)})),l.mapWheel.observed&&this.mapInstance.on("wheel",m=>this.zone.run(()=>{l.mapWheel.emit(m)})),l.moveStart.observed&&this.mapInstance.on("movestart",m=>this.zone.run(()=>l.moveStart.emit(m))),l.move.observed&&this.mapInstance.on("move",m=>this.zone.run(()=>l.move.emit(m))),l.moveEnd.observed&&this.mapInstance.on("moveend",m=>this.zone.run(()=>l.moveEnd.emit(m))),l.mapDragStart.observed&&this.mapInstance.on("dragstart",m=>this.zone.run(()=>l.mapDragStart.emit(m))),l.mapDrag.observed&&this.mapInstance.on("drag",m=>this.zone.run(()=>l.mapDrag.emit(m))),l.mapDragEnd.observed&&this.mapInstance.on("dragend",m=>this.zone.run(()=>l.mapDragEnd.emit(m))),l.zoomStart.observed&&this.mapInstance.on("zoomstart",()=>this.zone.run(()=>l.zoomStart.emit())),l.zoomEvt.observed&&this.mapInstance.on("zoom",()=>this.zone.run(()=>l.zoomEvt.emit())),l.zoomEnd.observed&&this.mapInstance.on("zoomend",()=>this.zone.run(()=>l.zoomEnd.emit())),l.rotateStart.observed&&this.mapInstance.on("rotatestart",m=>this.zone.run(()=>l.rotateStart.emit(m))),l.rotate.observed&&this.mapInstance.on("rotate",m=>this.zone.run(()=>l.rotate.emit(m))),l.rotateEnd.observed&&this.mapInstance.on("rotateend",m=>this.zone.run(()=>l.rotateEnd.emit(m))),l.pitchStart.observed&&this.mapInstance.on("pitchstart",()=>this.zone.run(()=>l.pitchStart.emit())),l.pitchEvt.observed&&this.mapInstance.on("pitch",()=>this.zone.run(()=>l.pitchEvt.emit())),l.pitchEnd.observed&&this.mapInstance.on("pitchend",()=>this.zone.run(()=>l.pitchEnd.emit())),l.boxZoomStart.observed&&this.mapInstance.on("boxzoomstart",m=>this.zone.run(()=>l.boxZoomStart.emit(m))),l.boxZoomEnd.observed&&this.mapInstance.on("boxzoomend",m=>this.zone.run(()=>l.boxZoomEnd.emit(m))),l.boxZoomCancel.observed&&this.mapInstance.on("boxzoomcancel",m=>this.zone.run(()=>l.boxZoomCancel.emit(m))),l.webGlContextLost.observed&&this.mapInstance.on("webglcontextlost",m=>this.zone.run(()=>l.webGlContextLost.emit(m))),l.webGlContextRestored.observed&&this.mapInstance.on("webglcontextrestored",m=>this.zone.run(()=>l.webGlContextRestored.emit(m))),l.render.observed&&this.mapInstance.on("render",()=>this.zone.run(()=>l.render.emit())),l.mapError.observed&&this.mapInstance.on("error",m=>this.zone.run(()=>l.mapError.emit(m.error))),l.data.observed&&this.mapInstance.on("data",m=>this.zone.run(()=>l.data.emit(m))),l.styleData.observed&&this.mapInstance.on("styledata",m=>this.zone.run(()=>l.styleData.emit(m))),l.sourceData.observed&&this.mapInstance.on("sourcedata",m=>this.zone.run(()=>l.sourceData.emit(m))),l.dataLoading.observed&&this.mapInstance.on("dataloading",m=>this.zone.run(()=>l.dataLoading.emit(m))),l.styleDataLoading.observed&&this.mapInstance.on("styledataloading",m=>this.zone.run(()=>l.styleDataLoading.emit(m))),l.sourceDataLoading.observed&&this.mapInstance.on("sourcedataloading",m=>this.zone.run(()=>l.sourceDataLoading.emit(m))),l.styleImageMissing.observed&&this.mapInstance.on("styleimagemissing",m=>this.zone.run(()=>l.styleImageMissing.emit(m))),l.idle.observed&&this.mapInstance.on("idle",()=>this.zone.run(()=>l.idle.emit()))}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})();function PO(a){return{provide:II,useValue:a.accessToken}}var C5=["container"],Mx=(()=>{class a{mapService=mt(SI);accessToken=vn();collectResourceTiming=vn();crossSourceCollisions=vn();fadeDuration=vn();hash=vn();refreshExpiredTiles=vn();failIfMajorPerformanceCaveat=vn();bearingSnap=vn();interactive=vn();pitchWithRotate=vn();clickTolerance=vn();attributionControl=vn();logoPosition=vn();maxTileCacheSize=vn();localIdeographFontFamily=vn();preserveDrawingBuffer=vn();trackResize=vn();transformRequest=vn();bounds=vn();antialias=vn();locale=vn();cooperativeGestures=vn();minZoom=vn();maxZoom=vn();minPitch=vn();maxPitch=vn();scrollZoom=vn();dragRotate=vn();touchPitch=vn();touchZoomRotate=vn();doubleClickZoom=vn();keyboard=vn();dragPan=vn();boxZoom=vn();style=vn();center=vn();maxBounds=vn();zoom=vn();bearing=vn();pitch=vn();fitBoundsOptions=vn();renderWorldCopies=vn();projection=vn();movingMethod=vn("flyTo");movingOptions=vn();fitBounds=vn();fitScreenCoordinates=vn();centerWithPanTo=vn();panToOptions=vn();cursorStyle=vn();mapResize=new an;mapRemove=new an;mapMouseDown=new an;mapMouseUp=new an;mapMouseMove=new an;mapClick=new an;mapDblClick=new an;mapMouseOver=new an;mapMouseOut=new an;mapContextMenu=new an;mapTouchStart=new an;mapTouchEnd=new an;mapTouchMove=new an;mapTouchCancel=new an;mapWheel=new an;moveStart=new an;move=new an;moveEnd=new an;mapDragStart=new an;mapDrag=new an;mapDragEnd=new an;zoomStart=new an;zoomEvt=new an;zoomEnd=new an;rotateStart=new an;rotate=new an;rotateEnd=new an;pitchStart=new an;pitchEvt=new an;pitchEnd=new an;boxZoomStart=new an;boxZoomEnd=new an;boxZoomCancel=new an;webGlContextLost=new an;webGlContextRestored=new an;mapLoad=new an;mapCreate=new an;idle=new an;render=new an;mapError=new an;data=new an;styleData=new an;sourceData=new an;dataLoading=new an;styleDataLoading=new an;sourceDataLoading=new an;styleImageMissing=new an;get mapInstance(){return this.mapService.mapInstance}mapContainer;constructor(){Yg(()=>{this.mapService.setup({accessToken:this.accessToken(),mapOptions:{collectResourceTiming:this.collectResourceTiming(),container:this.mapContainer.nativeElement,crossSourceCollisions:this.crossSourceCollisions(),fadeDuration:this.fadeDuration(),minZoom:this.minZoom(),maxZoom:this.maxZoom(),minPitch:this.minPitch(),maxPitch:this.maxPitch(),style:this.style(),hash:this.hash(),interactive:this.interactive(),bearingSnap:this.bearingSnap(),pitchWithRotate:this.pitchWithRotate(),clickTolerance:this.clickTolerance(),attributionControl:this.attributionControl(),logoPosition:this.logoPosition(),failIfMajorPerformanceCaveat:this.failIfMajorPerformanceCaveat(),preserveDrawingBuffer:this.preserveDrawingBuffer(),refreshExpiredTiles:this.refreshExpiredTiles(),maxBounds:this.maxBounds(),scrollZoom:this.scrollZoom(),boxZoom:this.boxZoom(),dragRotate:this.dragRotate(),dragPan:this.dragPan(),keyboard:this.keyboard(),doubleClickZoom:this.doubleClickZoom(),touchPitch:this.touchPitch(),touchZoomRotate:this.touchZoomRotate(),trackResize:this.trackResize(),center:this.center(),zoom:this.zoom(),bearing:this.bearing(),pitch:this.pitch(),renderWorldCopies:this.renderWorldCopies(),maxTileCacheSize:this.maxTileCacheSize(),localIdeographFontFamily:this.localIdeographFontFamily(),transformRequest:this.transformRequest(),bounds:this.bounds()?this.bounds():this.fitBounds(),fitBoundsOptions:this.fitBoundsOptions(),antialias:this.antialias(),locale:this.locale(),cooperativeGestures:this.cooperativeGestures(),projection:this.projection()},mapEvents:this}),this.cursorStyle()&&this.mapService.changeCanvasCursor(this.cursorStyle())})}ngOnDestroy(){this.mapService.destroyMap()}ngOnChanges(l){return bl(this,null,function*(){if(yield C1(this.mapService.mapCreated$),l.cursorStyle&&!l.cursorStyle.isFirstChange()&&this.mapService.changeCanvasCursor(l.cursorStyle.currentValue),l.projection&&!l.projection.isFirstChange()&&this.mapService.updateProjection(l.projection.currentValue),l.minZoom&&!l.minZoom.isFirstChange()&&this.mapService.updateMinZoom(l.minZoom.currentValue),l.maxZoom&&!l.maxZoom.isFirstChange()&&this.mapService.updateMaxZoom(l.maxZoom.currentValue),l.minPitch&&!l.minPitch.isFirstChange()&&this.mapService.updateMinPitch(l.minPitch.currentValue),l.maxPitch&&!l.maxPitch.isFirstChange()&&this.mapService.updateMaxPitch(l.maxPitch.currentValue),l.renderWorldCopies&&!l.renderWorldCopies.isFirstChange()&&this.mapService.updateRenderWorldCopies(l.renderWorldCopies.currentValue),l.scrollZoom&&!l.scrollZoom.isFirstChange()&&this.mapService.updateScrollZoom(l.scrollZoom.currentValue),l.dragRotate&&!l.dragRotate.isFirstChange()&&this.mapService.updateDragRotate(l.dragRotate.currentValue),l.touchPitch&&!l.touchPitch.isFirstChange()&&this.mapService.updateTouchPitch(l.touchPitch.currentValue),l.touchZoomRotate&&!l.touchZoomRotate.isFirstChange()&&this.mapService.updateTouchZoomRotate(l.touchZoomRotate.currentValue),l.doubleClickZoom&&!l.doubleClickZoom.isFirstChange()&&this.mapService.updateDoubleClickZoom(l.doubleClickZoom.currentValue),l.keyboard&&!l.keyboard.isFirstChange()&&this.mapService.updateKeyboard(l.keyboard.currentValue),l.dragPan&&!l.dragPan.isFirstChange()&&this.mapService.updateDragPan(l.dragPan.currentValue),l.boxZoom&&!l.boxZoom.isFirstChange()&&this.mapService.updateBoxZoom(l.boxZoom.currentValue),l.style&&!l.style.isFirstChange()&&this.mapService.updateStyle(l.style.currentValue),l.maxBounds&&!l.maxBounds.isFirstChange()&&this.mapService.updateMaxBounds(l.maxBounds.currentValue),l.fitBounds&&l.fitBounds.currentValue&&!l.fitBounds.isFirstChange()&&this.mapService.fitBounds(l.fitBounds.currentValue,this.fitBoundsOptions()),l.fitScreenCoordinates&&l.fitScreenCoordinates.currentValue){(this.center()||this.zoom()||this.pitch()||this.fitBounds())&&l.fitScreenCoordinates.isFirstChange()&&console.warn("[ngx-mapbox-gl] center / zoom / pitch / fitBounds inputs are being overridden by fitScreenCoordinates input");let m=this.bearing();this.mapService.fitScreenCoordinates(l.fitScreenCoordinates.currentValue,Array.isArray(m)?m[0]:m||0,this.movingOptions())}if(this.centerWithPanTo()&&l.center&&!l.center.isFirstChange()&&!l.zoom&&!l.bearing&&!l.pitch)this.mapService.panTo(this.center(),this.panToOptions());else if(l.center&&!l.center.isFirstChange()||l.zoom&&!l.zoom.isFirstChange()||l.bearing&&!l.bearing.isFirstChange()&&!l.fitScreenCoordinates||l.pitch&&!l.pitch.isFirstChange()){let m=this.zoom(),b=this.center(),r=this.bearing(),M=this.pitch();this.mapService.move(this.movingMethod(),this.movingOptions(),l.zoom&&m?Array.isArray(m)?m[0]:m:void 0,l.center?b:void 0,l.bearing&&r?Array.isArray(r)?r[0]:r:void 0,l.pitch&&M?Array.isArray(M)?M[0]:M:void 0)}})}static \u0275fac=function(m){return new(m||a)};static \u0275cmp=Pd({type:a,selectors:[["mgl-map"]],viewQuery:function(m,b){if(m&1&&WT(C5,7),m&2){let r;px(r=mx())&&(b.mapContainer=r.first)}},inputs:{accessToken:[1,"accessToken"],collectResourceTiming:[1,"collectResourceTiming"],crossSourceCollisions:[1,"crossSourceCollisions"],fadeDuration:[1,"fadeDuration"],hash:[1,"hash"],refreshExpiredTiles:[1,"refreshExpiredTiles"],failIfMajorPerformanceCaveat:[1,"failIfMajorPerformanceCaveat"],bearingSnap:[1,"bearingSnap"],interactive:[1,"interactive"],pitchWithRotate:[1,"pitchWithRotate"],clickTolerance:[1,"clickTolerance"],attributionControl:[1,"attributionControl"],logoPosition:[1,"logoPosition"],maxTileCacheSize:[1,"maxTileCacheSize"],localIdeographFontFamily:[1,"localIdeographFontFamily"],preserveDrawingBuffer:[1,"preserveDrawingBuffer"],trackResize:[1,"trackResize"],transformRequest:[1,"transformRequest"],bounds:[1,"bounds"],antialias:[1,"antialias"],locale:[1,"locale"],cooperativeGestures:[1,"cooperativeGestures"],minZoom:[1,"minZoom"],maxZoom:[1,"maxZoom"],minPitch:[1,"minPitch"],maxPitch:[1,"maxPitch"],scrollZoom:[1,"scrollZoom"],dragRotate:[1,"dragRotate"],touchPitch:[1,"touchPitch"],touchZoomRotate:[1,"touchZoomRotate"],doubleClickZoom:[1,"doubleClickZoom"],keyboard:[1,"keyboard"],dragPan:[1,"dragPan"],boxZoom:[1,"boxZoom"],style:[1,"style"],center:[1,"center"],maxBounds:[1,"maxBounds"],zoom:[1,"zoom"],bearing:[1,"bearing"],pitch:[1,"pitch"],fitBoundsOptions:[1,"fitBoundsOptions"],renderWorldCopies:[1,"renderWorldCopies"],projection:[1,"projection"],movingMethod:[1,"movingMethod"],movingOptions:[1,"movingOptions"],fitBounds:[1,"fitBounds"],fitScreenCoordinates:[1,"fitScreenCoordinates"],centerWithPanTo:[1,"centerWithPanTo"],panToOptions:[1,"panToOptions"],cursorStyle:[1,"cursorStyle"]},outputs:{mapResize:"mapResize",mapRemove:"mapRemove",mapMouseDown:"mapMouseDown",mapMouseUp:"mapMouseUp",mapMouseMove:"mapMouseMove",mapClick:"mapClick",mapDblClick:"mapDblClick",mapMouseOver:"mapMouseOver",mapMouseOut:"mapMouseOut",mapContextMenu:"mapContextMenu",mapTouchStart:"mapTouchStart",mapTouchEnd:"mapTouchEnd",mapTouchMove:"mapTouchMove",mapTouchCancel:"mapTouchCancel",mapWheel:"mapWheel",moveStart:"moveStart",move:"move",moveEnd:"moveEnd",mapDragStart:"mapDragStart",mapDrag:"mapDrag",mapDragEnd:"mapDragEnd",zoomStart:"zoomStart",zoomEvt:"zoomEvt",zoomEnd:"zoomEnd",rotateStart:"rotateStart",rotate:"rotate",rotateEnd:"rotateEnd",pitchStart:"pitchStart",pitchEvt:"pitchEvt",pitchEnd:"pitchEnd",boxZoomStart:"boxZoomStart",boxZoomEnd:"boxZoomEnd",boxZoomCancel:"boxZoomCancel",webGlContextLost:"webGlContextLost",webGlContextRestored:"webGlContextRestored",mapLoad:"mapLoad",mapCreate:"mapCreate",idle:"idle",render:"render",mapError:"mapError",data:"data",styleData:"styleData",sourceData:"sourceData",dataLoading:"dataLoading",styleDataLoading:"styleDataLoading",sourceDataLoading:"sourceDataLoading",styleImageMissing:"styleImageMissing"},features:[XT([SI]),Ad],decls:2,vars:0,consts:[["container",""]],template:function(m,b){m&1&&fx(0,"div",null,0)},styles:["[_nghost-%COMP%]{display:block}div[_ngcontent-%COMP%]{height:100%;width:100%}"],changeDetection:0})}return a})();var zO="3.7.7",A5=zO,Yf=typeof Buffer=="function",OO=typeof TextDecoder=="function"?new TextDecoder:void 0,LO=typeof TextEncoder=="function"?new TextEncoder:void 0,M5="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g_=Array.prototype.slice.call(M5),Rx=(a=>{let d={};return a.forEach((l,m)=>d[l]=m),d})(g_),R5=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,ao=String.fromCharCode.bind(String),kO=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):a=>new Uint8Array(Array.prototype.slice.call(a,0)),BO=a=>a.replace(/=/g,"").replace(/[+\/]/g,d=>d=="+"?"-":"_"),VO=a=>a.replace(/[^A-Za-z0-9\+\/]/g,""),jO=a=>{let d,l,m,b,r="",M=a.length%3;for(let N=0;N<a.length;){if((l=a.charCodeAt(N++))>255||(m=a.charCodeAt(N++))>255||(b=a.charCodeAt(N++))>255)throw new TypeError("invalid character found");d=l<<16|m<<8|b,r+=g_[d>>18&63]+g_[d>>12&63]+g_[d>>6&63]+g_[d&63]}return M?r.slice(0,M-3)+"===".substring(M):r},AI=typeof btoa=="function"?a=>btoa(a):Yf?a=>Buffer.from(a,"binary").toString("base64"):jO,DI=Yf?a=>Buffer.from(a).toString("base64"):a=>{let l=[];for(let m=0,b=a.length;m<b;m+=4096)l.push(ao.apply(null,a.subarray(m,m+4096)));return AI(l.join(""))},Px=(a,d=!1)=>d?BO(DI(a)):DI(a),P5=a=>{if(a.length<2){var d=a.charCodeAt(0);return d<128?a:d<2048?ao(192|d>>>6)+ao(128|d&63):ao(224|d>>>12&15)+ao(128|d>>>6&63)+ao(128|d&63)}else{var d=65536+(a.charCodeAt(0)-55296)*1024+(a.charCodeAt(1)-56320);return ao(240|d>>>18&7)+ao(128|d>>>12&63)+ao(128|d>>>6&63)+ao(128|d&63)}},O5=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,UO=a=>a.replace(O5,P5),FO=Yf?a=>Buffer.from(a,"utf8").toString("base64"):LO?a=>DI(LO.encode(a)):a=>AI(UO(a)),Xf=(a,d=!1)=>d?BO(FO(a)):FO(a),NO=a=>Xf(a,!0),L5=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,k5=a=>{switch(a.length){case 4:var d=(7&a.charCodeAt(0))<<18|(63&a.charCodeAt(1))<<12|(63&a.charCodeAt(2))<<6|63&a.charCodeAt(3),l=d-65536;return ao((l>>>10)+55296)+ao((l&1023)+56320);case 3:return ao((15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2));default:return ao((31&a.charCodeAt(0))<<6|63&a.charCodeAt(1))}},HO=a=>a.replace(L5,k5),$O=a=>{if(a=a.replace(/\s+/g,""),!R5.test(a))throw new TypeError("malformed base64.");a+="==".slice(2-(a.length&3));let d,l="",m,b;for(let r=0;r<a.length;)d=Rx[a.charAt(r++)]<<18|Rx[a.charAt(r++)]<<12|(m=Rx[a.charAt(r++)])<<6|(b=Rx[a.charAt(r++)]),l+=m===64?ao(d>>16&255):b===64?ao(d>>16&255,d>>8&255):ao(d>>16&255,d>>8&255,d&255);return l},MI=typeof atob=="function"?a=>atob(VO(a)):Yf?a=>Buffer.from(a,"base64").toString("binary"):$O,GO=Yf?a=>kO(Buffer.from(a,"base64")):a=>kO(MI(a).split("").map(d=>d.charCodeAt(0))),qO=a=>GO(WO(a)),F5=Yf?a=>Buffer.from(a,"base64").toString("utf8"):OO?a=>OO.decode(GO(a)):a=>HO(MI(a)),WO=a=>VO(a.replace(/[-_]/g,d=>d=="-"?"+":"/")),CI=a=>F5(WO(a)),N5=a=>{if(typeof a!="string")return!1;let d=a.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(d)||!/[^\s0-9a-zA-Z\-_]/.test(d)},ZO=a=>({value:a,enumerable:!1,writable:!0,configurable:!0}),XO=function(){let a=(d,l)=>Object.defineProperty(String.prototype,d,ZO(l));a("fromBase64",function(){return CI(this)}),a("toBase64",function(d){return Xf(this,d)}),a("toBase64URI",function(){return Xf(this,!0)}),a("toBase64URL",function(){return Xf(this,!0)}),a("toUint8Array",function(){return qO(this)})},YO=function(){let a=(d,l)=>Object.defineProperty(Uint8Array.prototype,d,ZO(l));a("toBase64",function(d){return Px(this,d)}),a("toBase64URI",function(){return Px(this,!0)}),a("toBase64URL",function(){return Px(this,!0)})},z5=()=>{XO(),YO()},zd={version:zO,VERSION:A5,atob:MI,atobPolyfill:$O,btoa:AI,btoaPolyfill:jO,fromBase64:CI,toBase64:Xf,encode:Xf,encodeURI:NO,encodeURL:NO,utob:UO,btou:HO,decode:CI,isValid:N5,fromUint8Array:Px,toUint8Array:qO,extendString:XO,extendUint8Array:YO,extendBuiltins:z5};var Bd={GH_TOKEN:"Z2l0aHViX3BhdF8xMUFCQlZIUVEweXpabWRRanNRdXF0X2hoenFOZTJjajNUd1BDUDZ2UUdhN3RLeDJMbmdkOGlmWEFyOW5hdHVOYnpXSkhNUUdMNmhLNWFzMTZU",STRAVA_ID:"Njk4NDc=",STRAVA_SECRET:"ZTI3ZGIzYWViYjU3MjM3MGZhZjhiZGMzYWNjMWUwYWFlMDE2ZDYyMg==",STRAVA_TOKEN:"NzUxMWE2MDNhYjU2ZDI3NzI1NTBjMGIxMWY1MWE4MGUzZGMzYWIzMw==",MAPBOX_API_KEY:"cGsuZXlKMUlqb2lhR2R5YVdabU1HNGlMQ0poSWpvaVkydHpkR2g1WW1Sa01ETmxjakp2Y1hWc2JtcHViM0pxY0NKOS5VT0RESU1ISC1LdXM1X21WaUhUUXlR",appVersion:"0.0.0",production:!0};var Kf=class a{constructor(){}get stravaClient(){return{id:zd.decode(Bd.STRAVA_ID),secret:zd.decode(Bd.STRAVA_SECRET),refresh:zd.decode(Bd.STRAVA_TOKEN)}}get mapbox(){return{api_key:zd.decode(Bd.MAPBOX_API_KEY)}}static \u0275fac=function(l){return new(l||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})};var Yn="primary",A_=Symbol("RouteTitle"),kI=class{params;constructor(d){this.params=d||{}}has(d){return Object.prototype.hasOwnProperty.call(this.params,d)}get(d){if(this.has(d)){let l=this.params[d];return Array.isArray(l)?l[0]:l}return null}getAll(d){if(this.has(d)){let l=this.params[d];return Array.isArray(l)?l:[l]}return[]}get keys(){return Object.keys(this.params)}};function Ud(a){return new kI(a)}function rL(a,d,l){let m=l.path.split("/");if(m.length>a.length||l.pathMatch==="full"&&(d.hasChildren()||m.length<a.length))return null;let b={};for(let r=0;r<m.length;r++){let M=m[r],N=a[r];if(M[0]===":")b[M.substring(1)]=N;else if(M!==N.path)return null}return{consumed:a.slice(0,m.length),posParams:b}}function V5(a,d){if(a.length!==d.length)return!1;for(let l=0;l<a.length;++l)if(!Wa(a[l],d[l]))return!1;return!0}function Wa(a,d){let l=a?FI(a):void 0,m=d?FI(d):void 0;if(!l||!m||l.length!=m.length)return!1;let b;for(let r=0;r<l.length;r++)if(b=l[r],!oL(a[b],d[b]))return!1;return!0}function FI(a){return[...Object.keys(a),...Object.getOwnPropertySymbols(a)]}function oL(a,d){if(Array.isArray(a)&&Array.isArray(d)){if(a.length!==d.length)return!1;let l=[...a].sort(),m=[...d].sort();return l.every((b,r)=>m[r]===b)}else return a===d}function sL(a){return a.length>0?a[a.length-1]:null}function Nl(a){return D1(a)?a:Qg(a)?yr(Promise.resolve(a)):In(a)}var j5={exact:lL,subset:cL},aL={exact:U5,subset:H5,ignored:()=>!0};function KO(a,d,l){return j5[l.paths](a.root,d.root,l.matrixParams)&&aL[l.queryParams](a.queryParams,d.queryParams)&&!(l.fragment==="exact"&&a.fragment!==d.fragment)}function U5(a,d){return Wa(a,d)}function lL(a,d,l){if(!Vd(a.segments,d.segments)||!kx(a.segments,d.segments,l)||a.numberOfChildren!==d.numberOfChildren)return!1;for(let m in d.children)if(!a.children[m]||!lL(a.children[m],d.children[m],l))return!1;return!0}function H5(a,d){return Object.keys(d).length<=Object.keys(a).length&&Object.keys(d).every(l=>oL(a[l],d[l]))}function cL(a,d,l){return uL(a,d,d.segments,l)}function uL(a,d,l,m){if(a.segments.length>l.length){let b=a.segments.slice(0,l.length);return!(!Vd(b,l)||d.hasChildren()||!kx(b,l,m))}else if(a.segments.length===l.length){if(!Vd(a.segments,l)||!kx(a.segments,l,m))return!1;for(let b in d.children)if(!a.children[b]||!cL(a.children[b],d.children[b],m))return!1;return!0}else{let b=l.slice(0,a.segments.length),r=l.slice(a.segments.length);return!Vd(a.segments,b)||!kx(a.segments,b,m)||!a.children[Yn]?!1:uL(a.children[Yn],d,r,m)}}function kx(a,d,l){return d.every((m,b)=>aL[l](a[b].parameters,m.parameters))}var Xa=class{root;queryParams;fragment;_queryParamMap;constructor(d=new ki([],{}),l={},m=null){this.root=d,this.queryParams=l,this.fragment=m}get queryParamMap(){return this._queryParamMap??=Ud(this.queryParams),this._queryParamMap}toString(){return q5.serialize(this)}},ki=class{segments;children;parent=null;constructor(d,l){this.segments=d,this.children=l,Object.values(l).forEach(m=>m.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return Fx(this)}},Qc=class{path;parameters;_parameterMap;constructor(d,l){this.path=d,this.parameters=l}get parameterMap(){return this._parameterMap??=Ud(this.parameters),this._parameterMap}toString(){return hL(this)}};function $5(a,d){return Vd(a,d)&&a.every((l,m)=>Wa(l.parameters,d[m].parameters))}function Vd(a,d){return a.length!==d.length?!1:a.every((l,m)=>l.path===d[m].path)}function G5(a,d){let l=[];return Object.entries(a.children).forEach(([m,b])=>{m===Yn&&(l=l.concat(d(b,m)))}),Object.entries(a.children).forEach(([m,b])=>{m!==Yn&&(l=l.concat(d(b,m)))}),l}var Hd=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>new eu,providedIn:"root"})}return a})(),eu=class{parse(d){let l=new zI(d);return new Xa(l.parseRootSegment(),l.parseQueryParams(),l.parseFragment())}serialize(d){let l=`/${__(d.root,!0)}`,m=X5(d.queryParams),b=typeof d.fragment=="string"?`#${W5(d.fragment)}`:"";return`${l}${m}${b}`}},q5=new eu;function Fx(a){return a.segments.map(d=>hL(d)).join("/")}function __(a,d){if(!a.hasChildren())return Fx(a);if(d){let l=a.children[Yn]?__(a.children[Yn],!1):"",m=[];return Object.entries(a.children).forEach(([b,r])=>{b!==Yn&&m.push(`${b}:${__(r,!1)}`)}),m.length>0?`${l}(${m.join("//")})`:l}else{let l=G5(a,(m,b)=>b===Yn?[__(a.children[Yn],!1)]:[`${b}:${__(m,!1)}`]);return Object.keys(a.children).length===1&&a.children[Yn]!=null?`${Fx(a)}/${l[0]}`:`${Fx(a)}/(${l.join("//")})`}}function dL(a){return encodeURIComponent(a).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function Ox(a){return dL(a).replace(/%3B/gi,";")}function W5(a){return encodeURI(a)}function NI(a){return dL(a).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function Nx(a){return decodeURIComponent(a)}function JO(a){return Nx(a.replace(/\+/g,"%20"))}function hL(a){return`${NI(a.path)}${Z5(a.parameters)}`}function Z5(a){return Object.entries(a).map(([d,l])=>`;${NI(d)}=${NI(l)}`).join("")}function X5(a){let d=Object.entries(a).map(([l,m])=>Array.isArray(m)?m.map(b=>`${Ox(l)}=${Ox(b)}`).join("&"):`${Ox(l)}=${Ox(m)}`).filter(l=>l);return d.length?`?${d.join("&")}`:""}var Y5=/^[^\/()?;#]+/;function RI(a){let d=a.match(Y5);return d?d[0]:""}var K5=/^[^\/()?;=#]+/;function J5(a){let d=a.match(K5);return d?d[0]:""}var Q5=/^[^=?&#]+/;function e4(a){let d=a.match(Q5);return d?d[0]:""}var t4=/^[^&#]+/;function n4(a){let d=a.match(t4);return d?d[0]:""}var zI=class{url;remaining;constructor(d){this.url=d,this.remaining=d}parseRootSegment(){return this.consumeOptional("/"),this.remaining===""||this.peekStartsWith("?")||this.peekStartsWith("#")?new ki([],{}):new ki([],this.parseChildren())}parseQueryParams(){let d={};if(this.consumeOptional("?"))do this.parseQueryParam(d);while(this.consumeOptional("&"));return d}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(this.remaining==="")return{};this.consumeOptional("/");let d=[];for(this.peekStartsWith("(")||d.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),d.push(this.parseSegment());let l={};this.peekStartsWith("/(")&&(this.capture("/"),l=this.parseParens(!0));let m={};return this.peekStartsWith("(")&&(m=this.parseParens(!1)),(d.length>0||Object.keys(l).length>0)&&(m[Yn]=new ki(d,l)),m}parseSegment(){let d=RI(this.remaining);if(d===""&&this.peekStartsWith(";"))throw new en(4009,!1);return this.capture(d),new Qc(Nx(d),this.parseMatrixParams())}parseMatrixParams(){let d={};for(;this.consumeOptional(";");)this.parseParam(d);return d}parseParam(d){let l=J5(this.remaining);if(!l)return;this.capture(l);let m="";if(this.consumeOptional("=")){let b=RI(this.remaining);b&&(m=b,this.capture(m))}d[Nx(l)]=Nx(m)}parseQueryParam(d){let l=e4(this.remaining);if(!l)return;this.capture(l);let m="";if(this.consumeOptional("=")){let M=n4(this.remaining);M&&(m=M,this.capture(m))}let b=JO(l),r=JO(m);if(d.hasOwnProperty(b)){let M=d[b];Array.isArray(M)||(M=[M],d[b]=M),M.push(r)}else d[b]=r}parseParens(d){let l={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){let m=RI(this.remaining),b=this.remaining[m.length];if(b!=="/"&&b!==")"&&b!==";")throw new en(4010,!1);let r;m.indexOf(":")>-1?(r=m.slice(0,m.indexOf(":")),this.capture(r),this.capture(":")):d&&(r=Yn);let M=this.parseChildren();l[r]=Object.keys(M).length===1?M[Yn]:new ki([],M),this.consumeOptional("//")}return l}peekStartsWith(d){return this.remaining.startsWith(d)}consumeOptional(d){return this.peekStartsWith(d)?(this.remaining=this.remaining.substring(d.length),!0):!1}capture(d){if(!this.consumeOptional(d))throw new en(4011,!1)}};function fL(a){return a.segments.length>0?new ki([],{[Yn]:a}):a}function pL(a){let d={};for(let[m,b]of Object.entries(a.children)){let r=pL(b);if(m===Yn&&r.segments.length===0&&r.hasChildren())for(let[M,N]of Object.entries(r.children))d[M]=N;else(r.segments.length>0||r.hasChildren())&&(d[m]=r)}let l=new ki(a.segments,d);return i4(l)}function i4(a){if(a.numberOfChildren===1&&a.children[Yn]){let d=a.children[Yn];return new ki(a.segments.concat(d.segments),d.children)}return a}function ip(a){return a instanceof Xa}function mL(a,d,l=null,m=null){let b=gL(a);return _L(b,d,l,m)}function gL(a){let d;function l(r){let M={};for(let G of r.children){let fe=l(G);M[G.outlet]=fe}let N=new ki(r.url,M);return r===a&&(d=N),N}let m=l(a.root),b=fL(m);return d??b}function _L(a,d,l,m){let b=a;for(;b.parent;)b=b.parent;if(d.length===0)return PI(b,b,b,l,m);let r=r4(d);if(r.toRoot())return PI(b,b,new ki([],{}),l,m);let M=o4(r,b,a),N=M.processChildren?v_(M.segmentGroup,M.index,r.commands):vL(M.segmentGroup,M.index,r.commands);return PI(b,M.segmentGroup,N,l,m)}function zx(a){return typeof a=="object"&&a!=null&&!a.outlets&&!a.segmentPath}function b_(a){return typeof a=="object"&&a!=null&&a.outlets}function PI(a,d,l,m,b){let r={};m&&Object.entries(m).forEach(([G,fe])=>{r[G]=Array.isArray(fe)?fe.map(Me=>`${Me}`):`${fe}`});let M;a===d?M=l:M=yL(a,d,l);let N=fL(pL(M));return new Xa(N,r,b)}function yL(a,d,l){let m={};return Object.entries(a.children).forEach(([b,r])=>{r===d?m[b]=l:m[b]=yL(r,d,l)}),new ki(a.segments,m)}var Bx=class{isAbsolute;numberOfDoubleDots;commands;constructor(d,l,m){if(this.isAbsolute=d,this.numberOfDoubleDots=l,this.commands=m,d&&m.length>0&&zx(m[0]))throw new en(4003,!1);let b=m.find(b_);if(b&&b!==sL(m))throw new en(4004,!1)}toRoot(){return this.isAbsolute&&this.commands.length===1&&this.commands[0]=="/"}};function r4(a){if(typeof a[0]=="string"&&a.length===1&&a[0]==="/")return new Bx(!0,0,a);let d=0,l=!1,m=a.reduce((b,r,M)=>{if(typeof r=="object"&&r!=null){if(r.outlets){let N={};return Object.entries(r.outlets).forEach(([G,fe])=>{N[G]=typeof fe=="string"?fe.split("/"):fe}),[...b,{outlets:N}]}if(r.segmentPath)return[...b,r.segmentPath]}return typeof r!="string"?[...b,r]:M===0?(r.split("/").forEach((N,G)=>{G==0&&N==="."||(G==0&&N===""?l=!0:N===".."?d++:N!=""&&b.push(N))}),b):[...b,r]},[]);return new Bx(l,d,m)}var ep=class{segmentGroup;processChildren;index;constructor(d,l,m){this.segmentGroup=d,this.processChildren=l,this.index=m}};function o4(a,d,l){if(a.isAbsolute)return new ep(d,!0,0);if(!l)return new ep(d,!1,NaN);if(l.parent===null)return new ep(l,!0,0);let m=zx(a.commands[0])?0:1,b=l.segments.length-1+m;return s4(l,b,a.numberOfDoubleDots)}function s4(a,d,l){let m=a,b=d,r=l;for(;r>b;){if(r-=b,m=m.parent,!m)throw new en(4005,!1);b=m.segments.length}return new ep(m,!1,b-r)}function a4(a){return b_(a[0])?a[0].outlets:{[Yn]:a}}function vL(a,d,l){if(a??=new ki([],{}),a.segments.length===0&&a.hasChildren())return v_(a,d,l);let m=l4(a,d,l),b=l.slice(m.commandIndex);if(m.match&&m.pathIndex<a.segments.length){let r=new ki(a.segments.slice(0,m.pathIndex),{});return r.children[Yn]=new ki(a.segments.slice(m.pathIndex),a.children),v_(r,0,b)}else return m.match&&b.length===0?new ki(a.segments,{}):m.match&&!a.hasChildren()?BI(a,d,l):m.match?v_(a,0,b):BI(a,d,l)}function v_(a,d,l){if(l.length===0)return new ki(a.segments,{});{let m=a4(l),b={};if(Object.keys(m).some(r=>r!==Yn)&&a.children[Yn]&&a.numberOfChildren===1&&a.children[Yn].segments.length===0){let r=v_(a.children[Yn],d,l);return new ki(a.segments,r.children)}return Object.entries(m).forEach(([r,M])=>{typeof M=="string"&&(M=[M]),M!==null&&(b[r]=vL(a.children[r],d,M))}),Object.entries(a.children).forEach(([r,M])=>{m[r]===void 0&&(b[r]=M)}),new ki(a.segments,b)}}function l4(a,d,l){let m=0,b=d,r={match:!1,pathIndex:0,commandIndex:0};for(;b<a.segments.length;){if(m>=l.length)return r;let M=a.segments[b],N=l[m];if(b_(N))break;let G=`${N}`,fe=m<l.length-1?l[m+1]:null;if(b>0&&G===void 0)break;if(G&&fe&&typeof fe=="object"&&fe.outlets===void 0){if(!eL(G,fe,M))return r;m+=2}else{if(!eL(G,{},M))return r;m++}b++}return{match:!0,pathIndex:b,commandIndex:m}}function BI(a,d,l){let m=a.segments.slice(0,d),b=0;for(;b<l.length;){let r=l[b];if(b_(r)){let G=c4(r.outlets);return new ki(m,G)}if(b===0&&zx(l[0])){let G=a.segments[d];m.push(new Qc(G.path,QO(l[0]))),b++;continue}let M=b_(r)?r.outlets[Yn]:`${r}`,N=b<l.length-1?l[b+1]:null;M&&N&&zx(N)?(m.push(new Qc(M,QO(N))),b+=2):(m.push(new Qc(M,{})),b++)}return new ki(m,{})}function c4(a){let d={};return Object.entries(a).forEach(([l,m])=>{typeof m=="string"&&(m=[m]),m!==null&&(d[l]=BI(new ki([],{}),0,m))}),d}function QO(a){let d={};return Object.entries(a).forEach(([l,m])=>d[l]=`${m}`),d}function eL(a,d,l){return a==l.path&&Wa(d,l.parameters)}var tp="imperative",Nr=function(a){return a[a.NavigationStart=0]="NavigationStart",a[a.NavigationEnd=1]="NavigationEnd",a[a.NavigationCancel=2]="NavigationCancel",a[a.NavigationError=3]="NavigationError",a[a.RoutesRecognized=4]="RoutesRecognized",a[a.ResolveStart=5]="ResolveStart",a[a.ResolveEnd=6]="ResolveEnd",a[a.GuardsCheckStart=7]="GuardsCheckStart",a[a.GuardsCheckEnd=8]="GuardsCheckEnd",a[a.RouteConfigLoadStart=9]="RouteConfigLoadStart",a[a.RouteConfigLoadEnd=10]="RouteConfigLoadEnd",a[a.ChildActivationStart=11]="ChildActivationStart",a[a.ChildActivationEnd=12]="ChildActivationEnd",a[a.ActivationStart=13]="ActivationStart",a[a.ActivationEnd=14]="ActivationEnd",a[a.Scroll=15]="Scroll",a[a.NavigationSkipped=16]="NavigationSkipped",a}(Nr||{}),gs=class{id;url;constructor(d,l){this.id=d,this.url=l}},tu=class extends gs{type=Nr.NavigationStart;navigationTrigger;restoredState;constructor(d,l,m="imperative",b=null){super(d,l),this.navigationTrigger=m,this.restoredState=b}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}},sa=class extends gs{urlAfterRedirects;type=Nr.NavigationEnd;constructor(d,l,m){super(d,l),this.urlAfterRedirects=m}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}},Ho=function(a){return a[a.Redirect=0]="Redirect",a[a.SupersededByNewNavigation=1]="SupersededByNewNavigation",a[a.NoDataFromResolver=2]="NoDataFromResolver",a[a.GuardRejected=3]="GuardRejected",a[a.Aborted=4]="Aborted",a}(Ho||{}),rp=function(a){return a[a.IgnoredSameUrlNavigation=0]="IgnoredSameUrlNavigation",a[a.IgnoredByUrlHandlingStrategy=1]="IgnoredByUrlHandlingStrategy",a}(rp||{}),Za=class extends gs{reason;code;type=Nr.NavigationCancel;constructor(d,l,m,b){super(d,l),this.reason=m,this.code=b}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}},Ya=class extends gs{reason;code;type=Nr.NavigationSkipped;constructor(d,l,m,b){super(d,l),this.reason=m,this.code=b}},op=class extends gs{error;target;type=Nr.NavigationError;constructor(d,l,m,b){super(d,l),this.error=m,this.target=b}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}},w_=class extends gs{urlAfterRedirects;state;type=Nr.RoutesRecognized;constructor(d,l,m,b){super(d,l),this.urlAfterRedirects=m,this.state=b}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Vx=class extends gs{urlAfterRedirects;state;type=Nr.GuardsCheckStart;constructor(d,l,m,b){super(d,l),this.urlAfterRedirects=m,this.state=b}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},jx=class extends gs{urlAfterRedirects;state;shouldActivate;type=Nr.GuardsCheckEnd;constructor(d,l,m,b,r){super(d,l),this.urlAfterRedirects=m,this.state=b,this.shouldActivate=r}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}},Ux=class extends gs{urlAfterRedirects;state;type=Nr.ResolveStart;constructor(d,l,m,b){super(d,l),this.urlAfterRedirects=m,this.state=b}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Hx=class extends gs{urlAfterRedirects;state;type=Nr.ResolveEnd;constructor(d,l,m,b){super(d,l),this.urlAfterRedirects=m,this.state=b}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},$x=class{route;type=Nr.RouteConfigLoadStart;constructor(d){this.route=d}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}},Gx=class{route;type=Nr.RouteConfigLoadEnd;constructor(d){this.route=d}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}},qx=class{snapshot;type=Nr.ChildActivationStart;constructor(d){this.snapshot=d}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},Wx=class{snapshot;type=Nr.ChildActivationEnd;constructor(d){this.snapshot=d}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},Zx=class{snapshot;type=Nr.ActivationStart;constructor(d){this.snapshot=d}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},Xx=class{snapshot;type=Nr.ActivationEnd;constructor(d){this.snapshot=d}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},sp=class{routerEvent;position;anchor;type=Nr.Scroll;constructor(d,l,m){this.routerEvent=d,this.position=l,this.anchor=m}toString(){let d=this.position?`${this.position[0]}, ${this.position[1]}`:null;return`Scroll(anchor: '${this.anchor}', position: '${d}')`}},E_=class{},ap=class{url;navigationBehaviorOptions;constructor(d,l){this.url=d,this.navigationBehaviorOptions=l}};function u4(a){return!(a instanceof E_)&&!(a instanceof ap)}function d4(a,d){return a.providers&&!a._injector&&(a._injector=Hf(a.providers,d,`Route: ${a.path}`)),a._injector??d}function oa(a){return a.outlet||Yn}function h4(a,d){let l=a.filter(m=>oa(m)===d);return l.push(...a.filter(m=>oa(m)!==d)),l}function up(a){if(!a)return null;if(a.routeConfig?._injector)return a.routeConfig._injector;for(let d=a.parent;d;d=d.parent){let l=d.routeConfig;if(l?._loadedInjector)return l._loadedInjector;if(l?._injector)return l._injector}return null}var Yx=class{rootInjector;outlet=null;route=null;children;attachRef=null;get injector(){return up(this.route?.snapshot)??this.rootInjector}constructor(d){this.rootInjector=d,this.children=new $d(this.rootInjector)}},$d=(()=>{class a{rootInjector;contexts=new Map;constructor(l){this.rootInjector=l}onChildOutletCreated(l,m){let b=this.getOrCreateContext(l);b.outlet=m,this.contexts.set(l,b)}onChildOutletDestroyed(l){let m=this.getContext(l);m&&(m.outlet=null,m.attachRef=null)}onOutletDeactivated(){let l=this.contexts;return this.contexts=new Map,l}onOutletReAttached(l){this.contexts=l}getOrCreateContext(l){let m=this.getContext(l);return m||(m=new Yx(this.rootInjector),this.contexts.set(l,m)),m}getContext(l){return this.contexts.get(l)||null}static \u0275fac=function(m){return new(m||a)(un(wr))};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),Kx=class{_root;constructor(d){this._root=d}get root(){return this._root.value}parent(d){let l=this.pathFromRoot(d);return l.length>1?l[l.length-2]:null}children(d){let l=VI(d,this._root);return l?l.children.map(m=>m.value):[]}firstChild(d){let l=VI(d,this._root);return l&&l.children.length>0?l.children[0].value:null}siblings(d){let l=jI(d,this._root);return l.length<2?[]:l[l.length-2].children.map(b=>b.value).filter(b=>b!==d)}pathFromRoot(d){return jI(d,this._root).map(l=>l.value)}};function VI(a,d){if(a===d.value)return d;for(let l of d.children){let m=VI(a,l);if(m)return m}return null}function jI(a,d){if(a===d.value)return[d];for(let l of d.children){let m=jI(a,l);if(m.length)return m.unshift(d),m}return[]}var ms=class{value;children;constructor(d,l){this.value=d,this.children=l}toString(){return`TreeNode(${this.value})`}};function Qf(a){let d={};return a&&a.children.forEach(l=>d[l.value.outlet]=l),d}var T_=class extends Kx{snapshot;constructor(d,l){super(d),this.snapshot=l,XI(this,d)}toString(){return this.snapshot.toString()}};function xL(a){let d=f4(a),l=new oo([new Qc("",{})]),m=new oo({}),b=new oo({}),r=new oo({}),M=new oo(""),N=new nu(l,m,r,M,b,Yn,a,d.root);return N.snapshot=d.root,new T_(new ms(N,[]),d)}function f4(a){let d={},l={},m={},b="",r=new jd([],d,m,b,l,Yn,a,null,{});return new I_("",new ms(r,[]))}var nu=class{urlSubject;paramsSubject;queryParamsSubject;fragmentSubject;dataSubject;outlet;component;snapshot;_futureSnapshot;_routerState;_paramMap;_queryParamMap;title;url;params;queryParams;fragment;data;constructor(d,l,m,b,r,M,N,G){this.urlSubject=d,this.paramsSubject=l,this.queryParamsSubject=m,this.fragmentSubject=b,this.dataSubject=r,this.outlet=M,this.component=N,this._futureSnapshot=G,this.title=this.dataSubject?.pipe(oi(fe=>fe[A_]))??In(void 0),this.url=d,this.params=l,this.queryParams=m,this.fragment=b,this.data=r}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=this.params.pipe(oi(d=>Ud(d))),this._paramMap}get queryParamMap(){return this._queryParamMap??=this.queryParams.pipe(oi(d=>Ud(d))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}};function Jx(a,d,l="emptyOnly"){let m,{routeConfig:b}=a;return d!==null&&(l==="always"||b?.path===""||!d.component&&!d.routeConfig?.loadComponent)?m={params:Gt(Gt({},d.params),a.params),data:Gt(Gt({},d.data),a.data),resolve:Gt(Gt(Gt(Gt({},a.data),d.data),b?.data),a._resolvedData)}:m={params:Gt({},a.params),data:Gt({},a.data),resolve:Gt(Gt({},a.data),a._resolvedData??{})},b&&wL(b)&&(m.resolve[A_]=b.title),m}var jd=class{url;params;queryParams;fragment;data;outlet;component;routeConfig;_resolve;_resolvedData;_routerState;_paramMap;_queryParamMap;get title(){return this.data?.[A_]}constructor(d,l,m,b,r,M,N,G,fe){this.url=d,this.params=l,this.queryParams=m,this.fragment=b,this.data=r,this.outlet=M,this.component=N,this.routeConfig=G,this._resolve=fe}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=Ud(this.params),this._paramMap}get queryParamMap(){return this._queryParamMap??=Ud(this.queryParams),this._queryParamMap}toString(){let d=this.url.map(m=>m.toString()).join("/"),l=this.routeConfig?this.routeConfig.path:"";return`Route(url:'${d}', path:'${l}')`}},I_=class extends Kx{url;constructor(d,l){super(l),this.url=d,XI(this,l)}toString(){return bL(this._root)}};function XI(a,d){d.value._routerState=a,d.children.forEach(l=>XI(a,l))}function bL(a){let d=a.children.length>0?` { ${a.children.map(bL).join(", ")} } `:"";return`${a.value}${d}`}function OI(a){if(a.snapshot){let d=a.snapshot,l=a._futureSnapshot;a.snapshot=l,Wa(d.queryParams,l.queryParams)||a.queryParamsSubject.next(l.queryParams),d.fragment!==l.fragment&&a.fragmentSubject.next(l.fragment),Wa(d.params,l.params)||a.paramsSubject.next(l.params),V5(d.url,l.url)||a.urlSubject.next(l.url),Wa(d.data,l.data)||a.dataSubject.next(l.data)}else a.snapshot=a._futureSnapshot,a.dataSubject.next(a._futureSnapshot.data)}function UI(a,d){let l=Wa(a.params,d.params)&&$5(a.url,d.url),m=!a.parent!=!d.parent;return l&&!m&&(!a.parent||UI(a.parent,d.parent))}function wL(a){return typeof a.title=="string"||a.title===null}var EL=new Kt(""),M_=(()=>{class a{activated=null;get activatedComponentRef(){return this.activated}_activatedRoute=null;name=Yn;activateEvents=new an;deactivateEvents=new an;attachEvents=new an;detachEvents=new an;routerOutletData=vn(void 0);parentContexts=mt($d);location=mt(Md);changeDetector=mt(r_);inputBinder=mt(R_,{optional:!0});supportsBindingToComponentInputs=!0;ngOnChanges(l){if(l.name){let{firstChange:m,previousValue:b}=l.name;if(m)return;this.isTrackedInParentContexts(b)&&(this.deactivate(),this.parentContexts.onChildOutletDestroyed(b)),this.initializeOutletWithName()}}ngOnDestroy(){this.isTrackedInParentContexts(this.name)&&this.parentContexts.onChildOutletDestroyed(this.name),this.inputBinder?.unsubscribeFromRouteData(this)}isTrackedInParentContexts(l){return this.parentContexts.getContext(l)?.outlet===this}ngOnInit(){this.initializeOutletWithName()}initializeOutletWithName(){if(this.parentContexts.onChildOutletCreated(this.name,this),this.activated)return;let l=this.parentContexts.getContext(this.name);l?.route&&(l.attachRef?this.attach(l.attachRef,l.route):this.activateWith(l.route,l.injector))}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new en(4012,!1);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new en(4012,!1);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new en(4012,!1);this.location.detach();let l=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(l.instance),l}attach(l,m){this.activated=l,this._activatedRoute=m,this.location.insert(l.hostView),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.attachEvents.emit(l.instance)}deactivate(){if(this.activated){let l=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(l)}}activateWith(l,m){if(this.isActivated)throw new en(4013,!1);this._activatedRoute=l;let b=this.location,M=l.snapshot.component,N=this.parentContexts.getOrCreateContext(this.name).children,G=new HI(l,N,b.injector,this.routerOutletData);this.activated=b.createComponent(M,{index:b.length,injector:G,environmentInjector:m}),this.changeDetector.markForCheck(),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.activateEvents.emit(this.activated.instance)}static \u0275fac=function(m){return new(m||a)};static \u0275dir=Xg({type:a,selectors:[["router-outlet"]],inputs:{name:"name",routerOutletData:[1,"routerOutletData"]},outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],features:[Ad]})}return a})(),HI=class{route;childContexts;parent;outletData;constructor(d,l,m,b){this.route=d,this.childContexts=l,this.parent=m,this.outletData=b}get(d,l){return d===nu?this.route:d===$d?this.childContexts:d===EL?this.outletData:this.parent.get(d,l)}},R_=new Kt(""),YI=(()=>{class a{outletDataSubscriptions=new Map;bindActivatedRouteToOutletComponent(l){this.unsubscribeFromRouteData(l),this.subscribeToRouteData(l)}unsubscribeFromRouteData(l){this.outletDataSubscriptions.get(l)?.unsubscribe(),this.outletDataSubscriptions.delete(l)}subscribeToRouteData(l){let{activatedRoute:m}=l,b=gg([m.queryParams,m.params,m.data]).pipe(zo(([r,M,N],G)=>(N=Gt(Gt(Gt({},r),M),N),G===0?In(N):Promise.resolve(N)))).subscribe(r=>{if(!l.isActivated||!l.activatedComponentRef||l.activatedRoute!==m||m.component===null){this.unsubscribeFromRouteData(l);return}let M=QP(m.component);if(!M){this.unsubscribeFromRouteData(l);return}for(let{templateName:N}of M.inputs)l.activatedComponentRef.setInput(N,r[N])});this.outletDataSubscriptions.set(l,b)}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})(),KI=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275cmp=Pd({type:a,selectors:[["ng-component"]],exportAs:["emptyRouterOutlet"],decls:1,vars:0,template:function(m,b){m&1&&kd(0,"router-outlet")},dependencies:[M_],encapsulation:2})}return a})();function JI(a){let d=a.children&&a.children.map(JI),l=d?Vi(Gt({},a),{children:d}):Gt({},a);return!l.component&&!l.loadComponent&&(d||l.loadChildren)&&l.outlet&&l.outlet!==Yn&&(l.component=KI),l}function p4(a,d,l){let m=S_(a,d._root,l?l._root:void 0);return new T_(m,d)}function S_(a,d,l){if(l&&a.shouldReuseRoute(d.value,l.value.snapshot)){let m=l.value;m._futureSnapshot=d.value;let b=m4(a,d,l);return new ms(m,b)}else{if(a.shouldAttach(d.value)){let r=a.retrieve(d.value);if(r!==null){let M=r.route;return M.value._futureSnapshot=d.value,M.children=d.children.map(N=>S_(a,N)),M}}let m=g4(d.value),b=d.children.map(r=>S_(a,r));return new ms(m,b)}}function m4(a,d,l){return d.children.map(m=>{for(let b of l.children)if(a.shouldReuseRoute(m.value,b.value.snapshot))return S_(a,m,b);return S_(a,m)})}function g4(a){return new nu(new oo(a.url),new oo(a.params),new oo(a.queryParams),new oo(a.fragment),new oo(a.data),a.outlet,a.component,a)}var lp=class{redirectTo;navigationBehaviorOptions;constructor(d,l){this.redirectTo=d,this.navigationBehaviorOptions=l}},TL="ngNavigationCancelingError";function Qx(a,d){let{redirectTo:l,navigationBehaviorOptions:m}=ip(d)?{redirectTo:d,navigationBehaviorOptions:void 0}:d,b=IL(!1,Ho.Redirect);return b.url=l,b.navigationBehaviorOptions=m,b}function IL(a,d){let l=new Error(`NavigationCancelingError: ${a||""}`);return l[TL]=!0,l.cancellationCode=d,l}function _4(a){return SL(a)&&ip(a.url)}function SL(a){return!!a&&a[TL]}var y4=(a,d,l,m)=>oi(b=>(new $I(d,b.targetRouterState,b.currentRouterState,l,m).activate(a),b)),$I=class{routeReuseStrategy;futureState;currState;forwardEvent;inputBindingEnabled;constructor(d,l,m,b,r){this.routeReuseStrategy=d,this.futureState=l,this.currState=m,this.forwardEvent=b,this.inputBindingEnabled=r}activate(d){let l=this.futureState._root,m=this.currState?this.currState._root:null;this.deactivateChildRoutes(l,m,d),OI(this.futureState.root),this.activateChildRoutes(l,m,d)}deactivateChildRoutes(d,l,m){let b=Qf(l);d.children.forEach(r=>{let M=r.value.outlet;this.deactivateRoutes(r,b[M],m),delete b[M]}),Object.values(b).forEach(r=>{this.deactivateRouteAndItsChildren(r,m)})}deactivateRoutes(d,l,m){let b=d.value,r=l?l.value:null;if(b===r)if(b.component){let M=m.getContext(b.outlet);M&&this.deactivateChildRoutes(d,l,M.children)}else this.deactivateChildRoutes(d,l,m);else r&&this.deactivateRouteAndItsChildren(l,m)}deactivateRouteAndItsChildren(d,l){d.value.component&&this.routeReuseStrategy.shouldDetach(d.value.snapshot)?this.detachAndStoreRouteSubtree(d,l):this.deactivateRouteAndOutlet(d,l)}detachAndStoreRouteSubtree(d,l){let m=l.getContext(d.value.outlet),b=m&&d.value.component?m.children:l,r=Qf(d);for(let M of Object.values(r))this.deactivateRouteAndItsChildren(M,b);if(m&&m.outlet){let M=m.outlet.detach(),N=m.children.onOutletDeactivated();this.routeReuseStrategy.store(d.value.snapshot,{componentRef:M,route:d,contexts:N})}}deactivateRouteAndOutlet(d,l){let m=l.getContext(d.value.outlet),b=m&&d.value.component?m.children:l,r=Qf(d);for(let M of Object.values(r))this.deactivateRouteAndItsChildren(M,b);m&&(m.outlet&&(m.outlet.deactivate(),m.children.onOutletDeactivated()),m.attachRef=null,m.route=null)}activateChildRoutes(d,l,m){let b=Qf(l);d.children.forEach(r=>{this.activateRoutes(r,b[r.value.outlet],m),this.forwardEvent(new Xx(r.value.snapshot))}),d.children.length&&this.forwardEvent(new Wx(d.value.snapshot))}activateRoutes(d,l,m){let b=d.value,r=l?l.value:null;if(OI(b),b===r)if(b.component){let M=m.getOrCreateContext(b.outlet);this.activateChildRoutes(d,l,M.children)}else this.activateChildRoutes(d,l,m);else if(b.component){let M=m.getOrCreateContext(b.outlet);if(this.routeReuseStrategy.shouldAttach(b.snapshot)){let N=this.routeReuseStrategy.retrieve(b.snapshot);this.routeReuseStrategy.store(b.snapshot,null),M.children.onOutletReAttached(N.contexts),M.attachRef=N.componentRef,M.route=N.route.value,M.outlet&&M.outlet.attach(N.componentRef,N.route.value),OI(N.route.value),this.activateChildRoutes(d,null,M.children)}else M.attachRef=null,M.route=b,M.outlet&&M.outlet.activateWith(b,M.injector),this.activateChildRoutes(d,null,M.children)}else this.activateChildRoutes(d,null,m)}},eb=class{path;route;constructor(d){this.path=d,this.route=this.path[this.path.length-1]}},np=class{component;route;constructor(d,l){this.component=d,this.route=l}};function v4(a,d,l){let m=a._root,b=d?d._root:null;return y_(m,b,l,[m.value])}function x4(a){let d=a.routeConfig?a.routeConfig.canActivateChild:null;return!d||d.length===0?null:{node:a,guards:d}}function dp(a,d){let l=Symbol(),m=d.get(a,l);return m===l?typeof a=="function"&&!q1(a)?a:d.get(a):m}function y_(a,d,l,m,b={canDeactivateChecks:[],canActivateChecks:[]}){let r=Qf(d);return a.children.forEach(M=>{b4(M,r[M.value.outlet],l,m.concat([M.value]),b),delete r[M.value.outlet]}),Object.entries(r).forEach(([M,N])=>x_(N,l.getContext(M),b)),b}function b4(a,d,l,m,b={canDeactivateChecks:[],canActivateChecks:[]}){let r=a.value,M=d?d.value:null,N=l?l.getContext(a.value.outlet):null;if(M&&r.routeConfig===M.routeConfig){let G=w4(M,r,r.routeConfig.runGuardsAndResolvers);G?b.canActivateChecks.push(new eb(m)):(r.data=M.data,r._resolvedData=M._resolvedData),r.component?y_(a,d,N?N.children:null,m,b):y_(a,d,l,m,b),G&&N&&N.outlet&&N.outlet.isActivated&&b.canDeactivateChecks.push(new np(N.outlet.component,M))}else M&&x_(d,N,b),b.canActivateChecks.push(new eb(m)),r.component?y_(a,null,N?N.children:null,m,b):y_(a,null,l,m,b);return b}function w4(a,d,l){if(typeof l=="function")return l(a,d);switch(l){case"pathParamsChange":return!Vd(a.url,d.url);case"pathParamsOrQueryParamsChange":return!Vd(a.url,d.url)||!Wa(a.queryParams,d.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!UI(a,d)||!Wa(a.queryParams,d.queryParams);case"paramsChange":default:return!UI(a,d)}}function x_(a,d,l){let m=Qf(a),b=a.value;Object.entries(m).forEach(([r,M])=>{b.component?d?x_(M,d.children.getContext(r),l):x_(M,null,l):x_(M,d,l)}),b.component?d&&d.outlet&&d.outlet.isActivated?l.canDeactivateChecks.push(new np(d.outlet.component,b)):l.canDeactivateChecks.push(new np(null,b)):l.canDeactivateChecks.push(new np(null,b))}function P_(a){return typeof a=="function"}function E4(a){return typeof a=="boolean"}function T4(a){return a&&P_(a.canLoad)}function I4(a){return a&&P_(a.canActivate)}function S4(a){return a&&P_(a.canActivateChild)}function D4(a){return a&&P_(a.canDeactivate)}function C4(a){return a&&P_(a.canMatch)}function DL(a){return a instanceof Ks||a?.name==="EmptyError"}var Lx=Symbol("INITIAL_VALUE");function cp(){return zo(a=>gg(a.map(d=>d.pipe(Tl(1),R1(Lx)))).pipe(oi(d=>{for(let l of d)if(l!==!0){if(l===Lx)return Lx;if(l===!1||A4(l))return l}return!0}),yo(d=>d!==Lx),Tl(1)))}function A4(a){return ip(a)||a instanceof lp}function M4(a,d){return br(l=>{let{targetSnapshot:m,currentSnapshot:b,guards:{canActivateChecks:r,canDeactivateChecks:M}}=l;return M.length===0&&r.length===0?In(Vi(Gt({},l),{guardsResult:!0})):R4(M,m,b,a).pipe(br(N=>N&&E4(N)?P4(m,r,a,d):In(N)),oi(N=>Vi(Gt({},l),{guardsResult:N})))})}function R4(a,d,l,m){return yr(a).pipe(br(b=>N4(b.component,b.route,l,d,m)),Il(b=>b!==!0,!0))}function P4(a,d,l,m){return yr(d).pipe(Ba(b=>Sf(L4(b.route.parent,m),O4(b.route,m),F4(a,b.path,l),k4(a,b.route,l))),Il(b=>b!==!0,!0))}function O4(a,d){return a!==null&&d&&d(new Zx(a)),In(!0)}function L4(a,d){return a!==null&&d&&d(new qx(a)),In(!0)}function k4(a,d,l){let m=d.routeConfig?d.routeConfig.canActivate:null;if(!m||m.length===0)return In(!0);let b=m.map(r=>_g(()=>{let M=up(d)??l,N=dp(r,M),G=I4(N)?N.canActivate(d,a):Xr(M,()=>N(d,a));return Nl(G).pipe(Il())}));return In(b).pipe(cp())}function F4(a,d,l){let m=d[d.length-1],r=d.slice(0,d.length-1).reverse().map(M=>x4(M)).filter(M=>M!==null).map(M=>_g(()=>{let N=M.guards.map(G=>{let fe=up(M.node)??l,Me=dp(G,fe),Ue=S4(Me)?Me.canActivateChild(m,a):Xr(fe,()=>Me(m,a));return Nl(Ue).pipe(Il())});return In(N).pipe(cp())}));return In(r).pipe(cp())}function N4(a,d,l,m,b){let r=d&&d.routeConfig?d.routeConfig.canDeactivate:null;if(!r||r.length===0)return In(!0);let M=r.map(N=>{let G=up(d)??b,fe=dp(N,G),Me=D4(fe)?fe.canDeactivate(a,d,l,m):Xr(G,()=>fe(a,d,l,m));return Nl(Me).pipe(Il())});return In(M).pipe(cp())}function z4(a,d,l,m){let b=d.canLoad;if(b===void 0||b.length===0)return In(!0);let r=b.map(M=>{let N=dp(M,a),G=T4(N)?N.canLoad(d,l):Xr(a,()=>N(d,l));return Nl(G)});return In(r).pipe(cp(),CL(m))}function CL(a){return E1(qr(d=>{if(typeof d!="boolean")throw Qx(a,d)}),oi(d=>d===!0))}function B4(a,d,l,m){let b=d.canMatch;if(!b||b.length===0)return In(!0);let r=b.map(M=>{let N=dp(M,a),G=C4(N)?N.canMatch(d,l):Xr(a,()=>N(d,l));return Nl(G)});return In(r).pipe(cp(),CL(m))}var D_=class{segmentGroup;constructor(d){this.segmentGroup=d||null}},C_=class extends Error{urlTree;constructor(d){super(),this.urlTree=d}};function Jf(a){return Tf(new D_(a))}function V4(a){return Tf(new en(4e3,!1))}function j4(a){return Tf(IL(!1,Ho.GuardRejected))}var GI=class{urlSerializer;urlTree;constructor(d,l){this.urlSerializer=d,this.urlTree=l}lineralizeSegments(d,l){let m=[],b=l.root;for(;;){if(m=m.concat(b.segments),b.numberOfChildren===0)return In(m);if(b.numberOfChildren>1||!b.children[Yn])return V4(`${d.redirectTo}`);b=b.children[Yn]}}applyRedirectCommands(d,l,m,b,r){return U4(l,b,r).pipe(oi(M=>{if(M instanceof Xa)throw new C_(M);let N=this.applyRedirectCreateUrlTree(M,this.urlSerializer.parse(M),d,m);if(M[0]==="/")throw new C_(N);return N}))}applyRedirectCreateUrlTree(d,l,m,b){let r=this.createSegmentGroup(d,l.root,m,b);return new Xa(r,this.createQueryParams(l.queryParams,this.urlTree.queryParams),l.fragment)}createQueryParams(d,l){let m={};return Object.entries(d).forEach(([b,r])=>{if(typeof r=="string"&&r[0]===":"){let N=r.substring(1);m[b]=l[N]}else m[b]=r}),m}createSegmentGroup(d,l,m,b){let r=this.createSegments(d,l.segments,m,b),M={};return Object.entries(l.children).forEach(([N,G])=>{M[N]=this.createSegmentGroup(d,G,m,b)}),new ki(r,M)}createSegments(d,l,m,b){return l.map(r=>r.path[0]===":"?this.findPosParam(d,r,b):this.findOrReturn(r,m))}findPosParam(d,l,m){let b=m[l.path.substring(1)];if(!b)throw new en(4001,!1);return b}findOrReturn(d,l){let m=0;for(let b of l){if(b.path===d.path)return l.splice(m),b;m++}return d}};function U4(a,d,l){if(typeof a=="string")return In(a);let m=a,{queryParams:b,fragment:r,routeConfig:M,url:N,outlet:G,params:fe,data:Me,title:Ue}=d;return Nl(Xr(l,()=>m({params:fe,data:Me,queryParams:b,fragment:r,routeConfig:M,url:N,outlet:G,title:Ue})))}var qI={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function H4(a,d,l,m,b){let r=AL(a,d,l);return r.matched?(m=d4(d,m),B4(m,d,l,b).pipe(oi(M=>M===!0?r:Gt({},qI)))):In(r)}function AL(a,d,l){if(d.path==="**")return $4(l);if(d.path==="")return d.pathMatch==="full"&&(a.hasChildren()||l.length>0)?Gt({},qI):{matched:!0,consumedSegments:[],remainingSegments:l,parameters:{},positionalParamSegments:{}};let b=(d.matcher||rL)(l,a,d);if(!b)return Gt({},qI);let r={};Object.entries(b.posParams??{}).forEach(([N,G])=>{r[N]=G.path});let M=b.consumed.length>0?Gt(Gt({},r),b.consumed[b.consumed.length-1].parameters):r;return{matched:!0,consumedSegments:b.consumed,remainingSegments:l.slice(b.consumed.length),parameters:M,positionalParamSegments:b.posParams??{}}}function $4(a){return{matched:!0,parameters:a.length>0?sL(a).parameters:{},consumedSegments:a,remainingSegments:[],positionalParamSegments:{}}}function tL(a,d,l,m){return l.length>0&&W4(a,l,m)?{segmentGroup:new ki(d,q4(m,new ki(l,a.children))),slicedSegments:[]}:l.length===0&&Z4(a,l,m)?{segmentGroup:new ki(a.segments,G4(a,l,m,a.children)),slicedSegments:l}:{segmentGroup:new ki(a.segments,a.children),slicedSegments:l}}function G4(a,d,l,m){let b={};for(let r of l)if(nb(a,d,r)&&!m[oa(r)]){let M=new ki([],{});b[oa(r)]=M}return Gt(Gt({},m),b)}function q4(a,d){let l={};l[Yn]=d;for(let m of a)if(m.path===""&&oa(m)!==Yn){let b=new ki([],{});l[oa(m)]=b}return l}function W4(a,d,l){return l.some(m=>nb(a,d,m)&&oa(m)!==Yn)}function Z4(a,d,l){return l.some(m=>nb(a,d,m))}function nb(a,d,l){return(a.hasChildren()||d.length>0)&&l.pathMatch==="full"?!1:l.path===""}function X4(a,d,l){return d.length===0&&!a.children[l]}var WI=class{};function Y4(a,d,l,m,b,r,M="emptyOnly"){return new ZI(a,d,l,m,b,M,r).recognize()}var K4=31,ZI=class{injector;configLoader;rootComponentType;config;urlTree;paramsInheritanceStrategy;urlSerializer;applyRedirects;absoluteRedirectCount=0;allowRedirects=!0;constructor(d,l,m,b,r,M,N){this.injector=d,this.configLoader=l,this.rootComponentType=m,this.config=b,this.urlTree=r,this.paramsInheritanceStrategy=M,this.urlSerializer=N,this.applyRedirects=new GI(this.urlSerializer,this.urlTree)}noMatchError(d){return new en(4002,`'${d.segmentGroup}'`)}recognize(){let d=tL(this.urlTree.root,[],[],this.config).segmentGroup;return this.match(d).pipe(oi(({children:l,rootSnapshot:m})=>{let b=new ms(m,l),r=new I_("",b),M=mL(m,[],this.urlTree.queryParams,this.urlTree.fragment);return M.queryParams=this.urlTree.queryParams,r.url=this.urlSerializer.serialize(M),{state:r,tree:M}}))}match(d){let l=new jd([],Object.freeze({}),Object.freeze(Gt({},this.urlTree.queryParams)),this.urlTree.fragment,Object.freeze({}),Yn,this.rootComponentType,null,{});return this.processSegmentGroup(this.injector,this.config,d,Yn,l).pipe(oi(m=>({children:m,rootSnapshot:l})),El(m=>{if(m instanceof C_)return this.urlTree=m.urlTree,this.match(m.urlTree.root);throw m instanceof D_?this.noMatchError(m):m}))}processSegmentGroup(d,l,m,b,r){return m.segments.length===0&&m.hasChildren()?this.processChildren(d,l,m,r):this.processSegment(d,l,m,m.segments,b,!0,r).pipe(oi(M=>M instanceof ms?[M]:[]))}processChildren(d,l,m,b){let r=[];for(let M of Object.keys(m.children))M==="primary"?r.unshift(M):r.push(M);return yr(r).pipe(Ba(M=>{let N=m.children[M],G=h4(l,M);return this.processSegmentGroup(d,G,N,M,b)}),M1((M,N)=>(M.push(...N),M)),Nc(null),A1(),br(M=>{if(M===null)return Jf(m);let N=ML(M);return J4(N),In(N)}))}processSegment(d,l,m,b,r,M,N){return yr(l).pipe(Ba(G=>this.processSegmentAgainstRoute(G._injector??d,l,G,m,b,r,M,N).pipe(El(fe=>{if(fe instanceof D_)return In(null);throw fe}))),Il(G=>!!G),El(G=>{if(DL(G))return X4(m,b,r)?In(new WI):Jf(m);throw G}))}processSegmentAgainstRoute(d,l,m,b,r,M,N,G){return oa(m)!==M&&(M===Yn||!nb(b,r,m))?Jf(b):m.redirectTo===void 0?this.matchSegmentAgainstRoute(d,b,m,r,M,G):this.allowRedirects&&N?this.expandSegmentAgainstRouteUsingRedirect(d,b,l,m,r,M,G):Jf(b)}expandSegmentAgainstRouteUsingRedirect(d,l,m,b,r,M,N){let{matched:G,parameters:fe,consumedSegments:Me,positionalParamSegments:Ue,remainingSegments:bt}=AL(l,b,r);if(!G)return Jf(l);typeof b.redirectTo=="string"&&b.redirectTo[0]==="/"&&(this.absoluteRedirectCount++,this.absoluteRedirectCount>K4&&(this.allowRedirects=!1));let Fe=new jd(r,fe,Object.freeze(Gt({},this.urlTree.queryParams)),this.urlTree.fragment,nL(b),oa(b),b.component??b._loadedComponent??null,b,iL(b)),Pt=Jx(Fe,N,this.paramsInheritanceStrategy);return Fe.params=Object.freeze(Pt.params),Fe.data=Object.freeze(Pt.data),this.applyRedirects.applyRedirectCommands(Me,b.redirectTo,Ue,Fe,d).pipe(zo(jt=>this.applyRedirects.lineralizeSegments(b,jt)),br(jt=>this.processSegment(d,m,l,jt.concat(bt),M,!1,N)))}matchSegmentAgainstRoute(d,l,m,b,r,M){let N=H4(l,m,b,d,this.urlSerializer);return m.path==="**"&&(l.children={}),N.pipe(zo(G=>G.matched?(d=m._injector??d,this.getChildConfig(d,m,b).pipe(zo(({routes:fe})=>{let Me=m._loadedInjector??d,{parameters:Ue,consumedSegments:bt,remainingSegments:Fe}=G,Pt=new jd(bt,Ue,Object.freeze(Gt({},this.urlTree.queryParams)),this.urlTree.fragment,nL(m),oa(m),m.component??m._loadedComponent??null,m,iL(m)),Vt=Jx(Pt,M,this.paramsInheritanceStrategy);Pt.params=Object.freeze(Vt.params),Pt.data=Object.freeze(Vt.data);let{segmentGroup:jt,slicedSegments:Nt}=tL(l,bt,Fe,fe);if(Nt.length===0&&jt.hasChildren())return this.processChildren(Me,fe,jt,Pt).pipe(oi(lr=>new ms(Pt,lr)));if(fe.length===0&&Nt.length===0)return In(new ms(Pt,[]));let ar=oa(m)===r;return this.processSegment(Me,fe,jt,Nt,ar?Yn:r,!0,Pt).pipe(oi(lr=>new ms(Pt,lr instanceof ms?[lr]:[])))}))):Jf(l)))}getChildConfig(d,l,m){return l.children?In({routes:l.children,injector:d}):l.loadChildren?l._loadedRoutes!==void 0?In({routes:l._loadedRoutes,injector:l._loadedInjector}):z4(d,l,m,this.urlSerializer).pipe(br(b=>b?this.configLoader.loadChildren(d,l).pipe(qr(r=>{l._loadedRoutes=r.routes,l._loadedInjector=r.injector})):j4(l))):In({routes:[],injector:d})}};function J4(a){a.sort((d,l)=>d.value.outlet===Yn?-1:l.value.outlet===Yn?1:d.value.outlet.localeCompare(l.value.outlet))}function Q4(a){let d=a.value.routeConfig;return d&&d.path===""}function ML(a){let d=[],l=new Set;for(let m of a){if(!Q4(m)){d.push(m);continue}let b=d.find(r=>m.value.routeConfig===r.value.routeConfig);b!==void 0?(b.children.push(...m.children),l.add(b)):d.push(m)}for(let m of l){let b=ML(m.children);d.push(new ms(m.value,b))}return d.filter(m=>!l.has(m))}function nL(a){return a.data||{}}function iL(a){return a.resolve||{}}function e6(a,d,l,m,b,r){return br(M=>Y4(a,d,l,m,M.extractedUrl,b,r).pipe(oi(({state:N,tree:G})=>Vi(Gt({},M),{targetSnapshot:N,urlAfterRedirects:G}))))}function t6(a,d){return br(l=>{let{targetSnapshot:m,guards:{canActivateChecks:b}}=l;if(!b.length)return In(l);let r=new Set(b.map(G=>G.route)),M=new Set;for(let G of r)if(!M.has(G))for(let fe of RL(G))M.add(fe);let N=0;return yr(M).pipe(Ba(G=>r.has(G)?n6(G,m,a,d):(G.data=Jx(G,G.parent,a).resolve,In(void 0))),qr(()=>N++),Df(1),br(G=>N===M.size?In(l):es))})}function RL(a){let d=a.children.map(l=>RL(l)).flat();return[a,...d]}function n6(a,d,l,m){let b=a.routeConfig,r=a._resolve;return b?.title!==void 0&&!wL(b)&&(r[A_]=b.title),_g(()=>(a.data=Jx(a,a.parent,l).resolve,i6(r,a,d,m).pipe(oi(M=>(a._resolvedData=M,a.data=Gt(Gt({},a.data),M),null)))))}function i6(a,d,l,m){let b=FI(a);if(b.length===0)return In({});let r={};return yr(b).pipe(br(M=>r6(a[M],d,l,m).pipe(Il(),qr(N=>{if(N instanceof lp)throw Qx(new eu,N);r[M]=N}))),Df(1),oi(()=>r),El(M=>DL(M)?es:Tf(M)))}function r6(a,d,l,m){let b=up(d)??m,r=dp(a,b),M=r.resolve?r.resolve(d,l):Xr(b,()=>r(d,l));return Nl(M)}function LI(a){return zo(d=>{let l=a(d);return l?yr(l).pipe(oi(()=>d)):In(d)})}var QI=(()=>{class a{buildTitle(l){let m,b=l.root;for(;b!==void 0;)m=this.getResolvedTitleForRoute(b)??m,b=b.children.find(r=>r.outlet===Yn);return m}getResolvedTitleForRoute(l){return l.data[A_]}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>mt(PL),providedIn:"root"})}return a})(),PL=(()=>{class a extends QI{title;constructor(l){super(),this.title=l}updateTitle(l){let m=this.buildTitle(l);m!==void 0&&this.title.setTitle(m)}static \u0275fac=function(m){return new(m||a)(un(AO))};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),Gd=new Kt("",{providedIn:"root",factory:()=>({})}),hp=new Kt(""),ib=(()=>{class a{componentLoaders=new WeakMap;childrenLoaders=new WeakMap;onLoadStartListener;onLoadEndListener;compiler=mt(KT);loadComponent(l,m){if(this.componentLoaders.get(m))return this.componentLoaders.get(m);if(m._loadedComponent)return In(m._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(m);let b=Nl(Xr(l,()=>m.loadComponent())).pipe(oi(LL),qr(M=>{this.onLoadEndListener&&this.onLoadEndListener(m),m._loadedComponent=M}),zc(()=>{this.componentLoaders.delete(m)})),r=new wf(b,()=>new Ar).pipe(bf());return this.componentLoaders.set(m,r),r}loadChildren(l,m){if(this.childrenLoaders.get(m))return this.childrenLoaders.get(m);if(m._loadedRoutes)return In({routes:m._loadedRoutes,injector:m._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(m);let r=OL(m,this.compiler,l,this.onLoadEndListener).pipe(zc(()=>{this.childrenLoaders.delete(m)})),M=new wf(r,()=>new Ar).pipe(bf());return this.childrenLoaders.set(m,M),M}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function OL(a,d,l,m){return Nl(Xr(l,()=>a.loadChildren())).pipe(oi(LL),br(b=>b instanceof ax||Array.isArray(b)?In(b):yr(d.compileModuleAsync(b))),oi(b=>{m&&m(a);let r,M,N=!1;return Array.isArray(b)?(M=b,N=!0):(r=b.create(l).injector,M=r.get(hp,[],{optional:!0,self:!0}).flat()),{routes:M.map(JI),injector:r}}))}function o6(a){return a&&typeof a=="object"&&"default"in a}function LL(a){return o6(a)?a.default:a}var rb=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>mt(s6),providedIn:"root"})}return a})(),s6=(()=>{class a{shouldProcessUrl(l){return!0}extract(l){return l}merge(l,m){return l}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),eS=new Kt(""),tS=new Kt("");function kL(a,d,l){let m=a.get(tS),b=a.get(dr);if(!b.startViewTransition||m.skipNextTransition)return m.skipNextTransition=!1,new Promise(fe=>setTimeout(fe));let r,M=new Promise(fe=>{r=fe}),N=b.startViewTransition(()=>(r(),a6(a)));N.ready.catch(fe=>{});let{onViewTransitionCreated:G}=m;return G&&Xr(a,()=>G({transition:N,from:d,to:l})),M}function a6(a){return new Promise(d=>{Yg({read:()=>setTimeout(d)},{injector:a})})}var nS=new Kt(""),ob=(()=>{class a{currentNavigation=null;currentTransition=null;lastSuccessfulNavigation=null;events=new Ar;transitionAbortWithErrorSubject=new Ar;configLoader=mt(ib);environmentInjector=mt(wr);destroyRef=mt(Ha);urlSerializer=mt(Hd);rootContexts=mt($d);location=mt(Kc);inputBindingEnabled=mt(R_,{optional:!0})!==null;titleStrategy=mt(QI);options=mt(Gd,{optional:!0})||{};paramsInheritanceStrategy=this.options.paramsInheritanceStrategy||"emptyOnly";urlHandlingStrategy=mt(rb);createViewTransition=mt(eS,{optional:!0});navigationErrorHandler=mt(nS,{optional:!0});navigationId=0;get hasRequestedNavigation(){return this.navigationId!==0}transitions;afterPreactivation=()=>In(void 0);rootComponentType=null;destroyed=!1;constructor(){let l=b=>this.events.next(new $x(b)),m=b=>this.events.next(new Gx(b));this.configLoader.onLoadEndListener=m,this.configLoader.onLoadStartListener=l,this.destroyRef.onDestroy(()=>{this.destroyed=!0})}complete(){this.transitions?.complete()}handleNavigationRequest(l){let m=++this.navigationId;this.transitions?.next(Vi(Gt({},l),{extractedUrl:this.urlHandlingStrategy.extract(l.rawUrl),targetSnapshot:null,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null,abortController:new AbortController,id:m}))}setupNavigations(l){return this.transitions=new oo(null),this.transitions.pipe(yo(m=>m!==null),zo(m=>{let b=!1;return In(m).pipe(zo(r=>{if(this.navigationId>m.id)return this.cancelNavigationTransition(m,"",Ho.SupersededByNewNavigation),es;this.currentTransition=m,this.currentNavigation={id:r.id,initialUrl:r.rawUrl,extractedUrl:r.extractedUrl,targetBrowserUrl:typeof r.extras.browserUrl=="string"?this.urlSerializer.parse(r.extras.browserUrl):r.extras.browserUrl,trigger:r.source,extras:r.extras,previousNavigation:this.lastSuccessfulNavigation?Vi(Gt({},this.lastSuccessfulNavigation),{previousNavigation:null}):null,abort:()=>r.abortController.abort()};let M=!l.navigated||this.isUpdatingInternalState()||this.isUpdatedBrowserUrl(),N=r.extras.onSameUrlNavigation??l.onSameUrlNavigation;if(!M&&N!=="reload"){let G="";return this.events.next(new Ya(r.id,this.urlSerializer.serialize(r.rawUrl),G,rp.IgnoredSameUrlNavigation)),r.resolve(!1),es}if(this.urlHandlingStrategy.shouldProcessUrl(r.rawUrl))return In(r).pipe(zo(G=>(this.events.next(new tu(G.id,this.urlSerializer.serialize(G.extractedUrl),G.source,G.restoredState)),G.id!==this.navigationId?es:Promise.resolve(G))),e6(this.environmentInjector,this.configLoader,this.rootComponentType,l.config,this.urlSerializer,this.paramsInheritanceStrategy),qr(G=>{m.targetSnapshot=G.targetSnapshot,m.urlAfterRedirects=G.urlAfterRedirects,this.currentNavigation=Vi(Gt({},this.currentNavigation),{finalUrl:G.urlAfterRedirects});let fe=new w_(G.id,this.urlSerializer.serialize(G.extractedUrl),this.urlSerializer.serialize(G.urlAfterRedirects),G.targetSnapshot);this.events.next(fe)}));if(M&&this.urlHandlingStrategy.shouldProcessUrl(r.currentRawUrl)){let{id:G,extractedUrl:fe,source:Me,restoredState:Ue,extras:bt}=r,Fe=new tu(G,this.urlSerializer.serialize(fe),Me,Ue);this.events.next(Fe);let Pt=xL(this.rootComponentType).snapshot;return this.currentTransition=m=Vi(Gt({},r),{targetSnapshot:Pt,urlAfterRedirects:fe,extras:Vi(Gt({},bt),{skipLocationChange:!1,replaceUrl:!1})}),this.currentNavigation.finalUrl=fe,In(m)}else{let G="";return this.events.next(new Ya(r.id,this.urlSerializer.serialize(r.extractedUrl),G,rp.IgnoredByUrlHandlingStrategy)),r.resolve(!1),es}}),qr(r=>{let M=new Vx(r.id,this.urlSerializer.serialize(r.extractedUrl),this.urlSerializer.serialize(r.urlAfterRedirects),r.targetSnapshot);this.events.next(M)}),oi(r=>(this.currentTransition=m=Vi(Gt({},r),{guards:v4(r.targetSnapshot,r.currentSnapshot,this.rootContexts)}),m)),M4(this.environmentInjector,r=>this.events.next(r)),qr(r=>{if(m.guardsResult=r.guardsResult,r.guardsResult&&typeof r.guardsResult!="boolean")throw Qx(this.urlSerializer,r.guardsResult);let M=new jx(r.id,this.urlSerializer.serialize(r.extractedUrl),this.urlSerializer.serialize(r.urlAfterRedirects),r.targetSnapshot,!!r.guardsResult);this.events.next(M)}),yo(r=>r.guardsResult?!0:(this.cancelNavigationTransition(r,"",Ho.GuardRejected),!1)),LI(r=>{if(r.guards.canActivateChecks.length!==0)return In(r).pipe(qr(M=>{let N=new Ux(M.id,this.urlSerializer.serialize(M.extractedUrl),this.urlSerializer.serialize(M.urlAfterRedirects),M.targetSnapshot);this.events.next(N)}),zo(M=>{let N=!1;return In(M).pipe(t6(this.paramsInheritanceStrategy,this.environmentInjector),qr({next:()=>N=!0,complete:()=>{N||this.cancelNavigationTransition(M,"",Ho.NoDataFromResolver)}}))}),qr(M=>{let N=new Hx(M.id,this.urlSerializer.serialize(M.extractedUrl),this.urlSerializer.serialize(M.urlAfterRedirects),M.targetSnapshot);this.events.next(N)}))}),LI(r=>{let M=N=>{let G=[];if(N.routeConfig?.loadComponent&&!N.routeConfig._loadedComponent){let fe=up(N)??this.environmentInjector;G.push(this.configLoader.loadComponent(fe,N.routeConfig).pipe(qr(Me=>{N.component=Me}),oi(()=>{})))}for(let fe of N.children)G.push(...M(fe));return G};return gg(M(r.targetSnapshot.root)).pipe(Nc(null),Tl(1))}),LI(()=>this.afterPreactivation()),zo(()=>{let{currentSnapshot:r,targetSnapshot:M}=m,N=this.createViewTransition?.(this.environmentInjector,r.root,M.root);return N?yr(N).pipe(oi(()=>m)):In(m)}),oi(r=>{let M=p4(l.routeReuseStrategy,r.targetSnapshot,r.currentRouterState);return this.currentTransition=m=Vi(Gt({},r),{targetRouterState:M}),this.currentNavigation.targetRouterState=M,m}),qr(()=>{this.events.next(new E_)}),y4(this.rootContexts,l.routeReuseStrategy,r=>this.events.next(r),this.inputBindingEnabled),Tl(1),u0(new xi(r=>{let M=m.abortController.signal,N=()=>r.next();return M.addEventListener("abort",N),()=>M.removeEventListener("abort",N)}).pipe(yo(()=>!b&&!m.targetRouterState),qr(()=>{this.cancelNavigationTransition(m,m.abortController.signal.reason+"",Ho.Aborted)}))),qr({next:r=>{b=!0,this.lastSuccessfulNavigation=this.currentNavigation,this.events.next(new sa(r.id,this.urlSerializer.serialize(r.extractedUrl),this.urlSerializer.serialize(r.urlAfterRedirects))),this.titleStrategy?.updateTitle(r.targetRouterState.snapshot),r.resolve(!0)},complete:()=>{b=!0}}),u0(this.transitionAbortWithErrorSubject.pipe(qr(r=>{throw r}))),zc(()=>{b||this.cancelNavigationTransition(m,"",Ho.SupersededByNewNavigation),this.currentTransition?.id===m.id&&(this.currentNavigation=null,this.currentTransition=null)}),El(r=>{if(this.destroyed)return m.resolve(!1),es;if(b=!0,SL(r))this.events.next(new Za(m.id,this.urlSerializer.serialize(m.extractedUrl),r.message,r.cancellationCode)),_4(r)?this.events.next(new ap(r.url,r.navigationBehaviorOptions)):m.resolve(!1);else{let M=new op(m.id,this.urlSerializer.serialize(m.extractedUrl),r,m.targetSnapshot??void 0);try{let N=Xr(this.environmentInjector,()=>this.navigationErrorHandler?.(M));if(N instanceof lp){let{message:G,cancellationCode:fe}=Qx(this.urlSerializer,N);this.events.next(new Za(m.id,this.urlSerializer.serialize(m.extractedUrl),G,fe)),this.events.next(new ap(N.redirectTo,N.navigationBehaviorOptions))}else throw this.events.next(M),r}catch(N){this.options.resolveNavigationPromiseOnError?m.resolve(!1):m.reject(N)}}return es}))}))}cancelNavigationTransition(l,m,b){let r=new Za(l.id,this.urlSerializer.serialize(l.extractedUrl),m,b);this.events.next(r),l.resolve(!1)}isUpdatingInternalState(){return this.currentTransition?.extractedUrl.toString()!==this.currentTransition?.currentUrlTree.toString()}isUpdatedBrowserUrl(){let l=this.urlHandlingStrategy.extract(this.urlSerializer.parse(this.location.path(!0))),m=this.currentNavigation?.targetBrowserUrl??this.currentNavigation?.extractedUrl;return l.toString()!==m?.toString()&&!this.currentNavigation?.extras.skipLocationChange}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function l6(a){return a!==tp}var FL=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>mt(c6),providedIn:"root"})}return a})(),tb=class{shouldDetach(d){return!1}store(d,l){}shouldAttach(d){return!1}retrieve(d){return null}shouldReuseRoute(d,l){return d.routeConfig===l.routeConfig}},c6=(()=>{class a extends tb{static \u0275fac=(()=>{let l;return function(b){return(l||(l=Q0(a)))(b||a)}})();static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),NL=(()=>{class a{urlSerializer=mt(Hd);options=mt(Gd,{optional:!0})||{};canceledNavigationResolution=this.options.canceledNavigationResolution||"replace";location=mt(Kc);urlHandlingStrategy=mt(rb);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";currentUrlTree=new Xa;getCurrentUrlTree(){return this.currentUrlTree}rawUrlTree=this.currentUrlTree;getRawUrlTree(){return this.rawUrlTree}createBrowserPath({finalUrl:l,initialUrl:m,targetBrowserUrl:b}){let r=l!==void 0?this.urlHandlingStrategy.merge(l,m):m,M=b??r;return M instanceof Xa?this.urlSerializer.serialize(M):M}commitTransition({targetRouterState:l,finalUrl:m,initialUrl:b}){m&&l?(this.currentUrlTree=m,this.rawUrlTree=this.urlHandlingStrategy.merge(m,b),this.routerState=l):this.rawUrlTree=b}routerState=xL(null);getRouterState(){return this.routerState}stateMemento=this.createStateMemento();updateStateMemento(){this.stateMemento=this.createStateMemento()}createStateMemento(){return{rawUrlTree:this.rawUrlTree,currentUrlTree:this.currentUrlTree,routerState:this.routerState}}resetInternalState({finalUrl:l}){this.routerState=this.stateMemento.routerState,this.currentUrlTree=this.stateMemento.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,l??this.rawUrlTree)}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:()=>mt(u6),providedIn:"root"})}return a})(),u6=(()=>{class a extends NL{currentPageId=0;lastSuccessfulId=-1;restoredState(){return this.location.getState()}get browserPageId(){return this.canceledNavigationResolution!=="computed"?this.currentPageId:this.restoredState()?.\u0275routerPageId??this.currentPageId}registerNonRouterCurrentEntryChangeListener(l){return this.location.subscribe(m=>{m.type==="popstate"&&setTimeout(()=>{l(m.url,m.state,"popstate")})})}handleRouterEvent(l,m){l instanceof tu?this.updateStateMemento():l instanceof Ya?this.commitTransition(m):l instanceof w_?this.urlUpdateStrategy==="eager"&&(m.extras.skipLocationChange||this.setBrowserUrl(this.createBrowserPath(m),m)):l instanceof E_?(this.commitTransition(m),this.urlUpdateStrategy==="deferred"&&!m.extras.skipLocationChange&&this.setBrowserUrl(this.createBrowserPath(m),m)):l instanceof Za&&l.code!==Ho.SupersededByNewNavigation&&l.code!==Ho.Redirect?this.restoreHistory(m):l instanceof op?this.restoreHistory(m,!0):l instanceof sa&&(this.lastSuccessfulId=l.id,this.currentPageId=this.browserPageId)}setBrowserUrl(l,{extras:m,id:b}){let{replaceUrl:r,state:M}=m;if(this.location.isCurrentPathEqualTo(l)||r){let N=this.browserPageId,G=Gt(Gt({},M),this.generateNgRouterState(b,N));this.location.replaceState(l,"",G)}else{let N=Gt(Gt({},M),this.generateNgRouterState(b,this.browserPageId+1));this.location.go(l,"",N)}}restoreHistory(l,m=!1){if(this.canceledNavigationResolution==="computed"){let b=this.browserPageId,r=this.currentPageId-b;r!==0?this.location.historyGo(r):this.getCurrentUrlTree()===l.finalUrl&&r===0&&(this.resetInternalState(l),this.resetUrlToCurrentUrlTree())}else this.canceledNavigationResolution==="replace"&&(m&&this.resetInternalState(l),this.resetUrlToCurrentUrlTree())}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.getRawUrlTree()),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}generateNgRouterState(l,m){return this.canceledNavigationResolution==="computed"?{navigationId:l,\u0275routerPageId:m}:{navigationId:l}}static \u0275fac=(()=>{let l;return function(b){return(l||(l=Q0(a)))(b||a)}})();static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function sb(a,d){a.events.pipe(yo(l=>l instanceof sa||l instanceof Za||l instanceof op||l instanceof Ya),oi(l=>l instanceof sa||l instanceof Ya?0:(l instanceof Za?l.code===Ho.Redirect||l.code===Ho.SupersededByNewNavigation:!1)?2:1),yo(l=>l!==2),Tl(1)).subscribe(()=>{d()})}var d6={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},h6={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"},iu=(()=>{class a{get currentUrlTree(){return this.stateManager.getCurrentUrlTree()}get rawUrlTree(){return this.stateManager.getRawUrlTree()}disposed=!1;nonRouterCurrentEntryChangeSubscription;console=mt(VT);stateManager=mt(NL);options=mt(Gd,{optional:!0})||{};pendingTasks=mt($a);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";navigationTransitions=mt(ob);urlSerializer=mt(Hd);location=mt(Kc);urlHandlingStrategy=mt(rb);injector=mt(wr);_events=new Ar;get events(){return this._events}get routerState(){return this.stateManager.getRouterState()}navigated=!1;routeReuseStrategy=mt(FL);onSameUrlNavigation=this.options.onSameUrlNavigation||"ignore";config=mt(hp,{optional:!0})?.flat()??[];componentInputBindingEnabled=!!mt(R_,{optional:!0});constructor(){this.resetConfig(this.config),this.navigationTransitions.setupNavigations(this).subscribe({error:l=>{this.console.warn(l)}}),this.subscribeToNavigationEvents()}eventsSubscription=new _r;subscribeToNavigationEvents(){let l=this.navigationTransitions.events.subscribe(m=>{try{let b=this.navigationTransitions.currentTransition,r=this.navigationTransitions.currentNavigation;if(b!==null&&r!==null){if(this.stateManager.handleRouterEvent(m,r),m instanceof Za&&m.code!==Ho.Redirect&&m.code!==Ho.SupersededByNewNavigation)this.navigated=!0;else if(m instanceof sa)this.navigated=!0;else if(m instanceof ap){let M=m.navigationBehaviorOptions,N=this.urlHandlingStrategy.merge(m.url,b.currentRawUrl),G=Gt({browserUrl:b.extras.browserUrl,info:b.extras.info,skipLocationChange:b.extras.skipLocationChange,replaceUrl:b.extras.replaceUrl||this.urlUpdateStrategy==="eager"||l6(b.source)},M);this.scheduleNavigation(N,tp,null,G,{resolve:b.resolve,reject:b.reject,promise:b.promise})}}u4(m)&&this._events.next(m)}catch(b){this.navigationTransitions.transitionAbortWithErrorSubject.next(b)}});this.eventsSubscription.add(l)}resetRootComponentType(l){this.routerState.root.component=l,this.navigationTransitions.rootComponentType=l}initialNavigation(){this.setUpLocationChangeListener(),this.navigationTransitions.hasRequestedNavigation||this.navigateToSyncWithBrowser(this.location.path(!0),tp,this.stateManager.restoredState())}setUpLocationChangeListener(){this.nonRouterCurrentEntryChangeSubscription??=this.stateManager.registerNonRouterCurrentEntryChangeListener((l,m,b)=>{this.navigateToSyncWithBrowser(l,b,m)})}navigateToSyncWithBrowser(l,m,b){let r={replaceUrl:!0},M=b?.navigationId?b:null;if(b){let G=Gt({},b);delete G.navigationId,delete G.\u0275routerPageId,Object.keys(G).length!==0&&(r.state=G)}let N=this.parseUrl(l);this.scheduleNavigation(N,m,M,r).catch(G=>{this.disposed||this.injector.get(Rs)(G)})}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return this.navigationTransitions.currentNavigation}get lastSuccessfulNavigation(){return this.navigationTransitions.lastSuccessfulNavigation}resetConfig(l){this.config=l.map(JI),this.navigated=!1}ngOnDestroy(){this.dispose()}dispose(){this._events.unsubscribe(),this.navigationTransitions.complete(),this.nonRouterCurrentEntryChangeSubscription&&(this.nonRouterCurrentEntryChangeSubscription.unsubscribe(),this.nonRouterCurrentEntryChangeSubscription=void 0),this.disposed=!0,this.eventsSubscription.unsubscribe()}createUrlTree(l,m={}){let{relativeTo:b,queryParams:r,fragment:M,queryParamsHandling:N,preserveFragment:G}=m,fe=G?this.currentUrlTree.fragment:M,Me=null;switch(N??this.options.defaultQueryParamsHandling){case"merge":Me=Gt(Gt({},this.currentUrlTree.queryParams),r);break;case"preserve":Me=this.currentUrlTree.queryParams;break;default:Me=r||null}Me!==null&&(Me=this.removeEmptyProps(Me));let Ue;try{let bt=b?b.snapshot:this.routerState.snapshot.root;Ue=gL(bt)}catch{(typeof l[0]!="string"||l[0][0]!=="/")&&(l=[]),Ue=this.currentUrlTree.root}return _L(Ue,l,Me,fe??null)}navigateByUrl(l,m={skipLocationChange:!1}){let b=ip(l)?l:this.parseUrl(l),r=this.urlHandlingStrategy.merge(b,this.rawUrlTree);return this.scheduleNavigation(r,tp,null,m)}navigate(l,m={skipLocationChange:!1}){return f6(l),this.navigateByUrl(this.createUrlTree(l,m),m)}serializeUrl(l){return this.urlSerializer.serialize(l)}parseUrl(l){try{return this.urlSerializer.parse(l)}catch{return this.urlSerializer.parse("/")}}isActive(l,m){let b;if(m===!0?b=Gt({},d6):m===!1?b=Gt({},h6):b=m,ip(l))return KO(this.currentUrlTree,l,b);let r=this.parseUrl(l);return KO(this.currentUrlTree,r,b)}removeEmptyProps(l){return Object.entries(l).reduce((m,[b,r])=>(r!=null&&(m[b]=r),m),{})}scheduleNavigation(l,m,b,r,M){if(this.disposed)return Promise.resolve(!1);let N,G,fe;M?(N=M.resolve,G=M.reject,fe=M.promise):fe=new Promise((Ue,bt)=>{N=Ue,G=bt});let Me=this.pendingTasks.add();return sb(this,()=>{queueMicrotask(()=>this.pendingTasks.remove(Me))}),this.navigationTransitions.handleNavigationRequest({source:m,restoredState:b,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,rawUrl:l,extras:r,resolve:N,reject:G,promise:fe,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),fe.catch(Ue=>Promise.reject(Ue))}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function f6(a){for(let d=0;d<a.length;d++)if(a[d]==null)throw new en(4008,!1)}var O_=class{};var zL=(()=>{class a{router;injector;preloadingStrategy;loader;subscription;constructor(l,m,b,r){this.router=l,this.injector=m,this.preloadingStrategy=b,this.loader=r}setUpPreloading(){this.subscription=this.router.events.pipe(yo(l=>l instanceof sa),Ba(()=>this.preload())).subscribe(()=>{})}preload(){return this.processRoutes(this.injector,this.router.config)}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}processRoutes(l,m){let b=[];for(let r of m){r.providers&&!r._injector&&(r._injector=Hf(r.providers,l,`Route: ${r.path}`));let M=r._injector??l,N=r._loadedInjector??M;(r.loadChildren&&!r._loadedRoutes&&r.canLoad===void 0||r.loadComponent&&!r._loadedComponent)&&b.push(this.preloadConfig(M,r)),(r.children||r._loadedRoutes)&&b.push(this.processRoutes(N,r.children??r._loadedRoutes))}return yr(b).pipe(If())}preloadConfig(l,m){return this.preloadingStrategy.preload(m,()=>{let b;m.loadChildren&&m.canLoad===void 0?b=this.loader.loadChildren(l,m):b=In(null);let r=b.pipe(br(M=>M===null?In(void 0):(m._loadedRoutes=M.routes,m._loadedInjector=M.injector,this.processRoutes(M.injector??l,M.routes))));if(m.loadComponent&&!m._loadedComponent){let M=this.loader.loadComponent(l,m);return yr([r,M]).pipe(If())}else return r})}static \u0275fac=function(m){return new(m||a)(un(iu),un(wr),un(O_),un(ib))};static \u0275prov=Xt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),BL=new Kt(""),p6=(()=>{class a{urlSerializer;transitions;viewportScroller;zone;options;routerEventsSubscription;scrollEventsSubscription;lastId=0;lastSource=tp;restoredId=0;store={};constructor(l,m,b,r,M={}){this.urlSerializer=l,this.transitions=m,this.viewportScroller=b,this.zone=r,this.options=M,M.scrollPositionRestoration||="disabled",M.anchorScrolling||="disabled"}init(){this.options.scrollPositionRestoration!=="disabled"&&this.viewportScroller.setHistoryScrollRestoration("manual"),this.routerEventsSubscription=this.createScrollEvents(),this.scrollEventsSubscription=this.consumeScrollEvents()}createScrollEvents(){return this.transitions.events.subscribe(l=>{l instanceof tu?(this.store[this.lastId]=this.viewportScroller.getScrollPosition(),this.lastSource=l.navigationTrigger,this.restoredId=l.restoredState?l.restoredState.navigationId:0):l instanceof sa?(this.lastId=l.id,this.scheduleScrollEvent(l,this.urlSerializer.parse(l.urlAfterRedirects).fragment)):l instanceof Ya&&l.code===rp.IgnoredSameUrlNavigation&&(this.lastSource=void 0,this.restoredId=0,this.scheduleScrollEvent(l,this.urlSerializer.parse(l.url).fragment))})}consumeScrollEvents(){return this.transitions.events.subscribe(l=>{l instanceof sp&&(l.position?this.options.scrollPositionRestoration==="top"?this.viewportScroller.scrollToPosition([0,0]):this.options.scrollPositionRestoration==="enabled"&&this.viewportScroller.scrollToPosition(l.position):l.anchor&&this.options.anchorScrolling==="enabled"?this.viewportScroller.scrollToAnchor(l.anchor):this.options.scrollPositionRestoration!=="disabled"&&this.viewportScroller.scrollToPosition([0,0]))})}scheduleScrollEvent(l,m){this.zone.runOutsideAngular(()=>bl(this,null,function*(){yield new Promise(b=>{setTimeout(b),typeof requestAnimationFrame<"u"&&requestAnimationFrame(b)}),this.zone.run(()=>{this.transitions.events.next(new sp(l,this.lastSource==="popstate"?this.store[this.restoredId]:null,m))})}))}ngOnDestroy(){this.routerEventsSubscription?.unsubscribe(),this.scrollEventsSubscription?.unsubscribe()}static \u0275fac=function(m){OT()};static \u0275prov=Xt({token:a,factory:a.\u0275fac})}return a})();function m6(a){return a.routerState.root}function L_(a,d){return{\u0275kind:a,\u0275providers:d}}function g6(){let a=mt(Zr);return d=>{let l=a.get(kl);if(d!==l.components[0])return;let m=a.get(iu),b=a.get(VL);a.get(rS)===1&&m.initialNavigation(),a.get(HL,null,{optional:!0})?.setUpPreloading(),a.get(BL,null,{optional:!0})?.init(),m.resetRootComponentType(l.componentTypes[0]),b.closed||(b.next(),b.complete(),b.unsubscribe())}}var VL=new Kt("",{factory:()=>new Ar}),rS=new Kt("",{providedIn:"root",factory:()=>1});function jL(){let a=[{provide:rS,useValue:0},ux(()=>{let d=mt(Zr);return d.get(iI,Promise.resolve()).then(()=>new Promise(m=>{let b=d.get(iu),r=d.get(VL);sb(b,()=>{m(!0)}),d.get(ob).afterPreactivation=()=>(m(!0),r.closed?In(void 0):r),b.initialNavigation()}))})];return L_(2,a)}function UL(){let a=[ux(()=>{mt(iu).setUpLocationChangeListener()}),{provide:rS,useValue:2}];return L_(3,a)}var HL=new Kt("");function $L(a){return L_(0,[{provide:HL,useExisting:zL},{provide:O_,useExisting:a}])}function GL(){return L_(8,[YI,{provide:R_,useExisting:YI}])}function qL(a){Rd("NgRouterViewTransitions");let d=[{provide:eS,useValue:kL},{provide:tS,useValue:Gt({skipNextTransition:!!a?.skipInitialTransition},a)}];return L_(9,d)}var WL=[Kc,{provide:Hd,useClass:eu},iu,$d,{provide:nu,useFactory:m6,deps:[iu]},ib,[]],ab=(()=>{class a{constructor(){}static forRoot(l,m){return{ngModule:a,providers:[WL,[],{provide:hp,multi:!0,useValue:l},[],m?.errorHandler?{provide:nS,useValue:m.errorHandler}:[],{provide:Gd,useValue:m||{}},m?.useHash?y6():v6(),_6(),m?.preloadingStrategy?$L(m.preloadingStrategy).\u0275providers:[],m?.initialNavigation?x6(m):[],m?.bindToComponentInputs?GL().\u0275providers:[],m?.enableViewTransitions?qL().\u0275providers:[],b6()]}}static forChild(l){return{ngModule:a,providers:[{provide:hp,multi:!0,useValue:l}]}}static \u0275fac=function(m){return new(m||a)};static \u0275mod=Uo({type:a});static \u0275inj=vo({})}return a})();function _6(){return{provide:BL,useFactory:()=>{let a=mt(oO),d=mt(Gi),l=mt(Gd),m=mt(ob),b=mt(Hd);return l.scrollOffset&&a.setOffset(l.scrollOffset),new p6(b,m,a,d,l)}}}function y6(){return{provide:Fl,useClass:rI}}function v6(){return{provide:Fl,useClass:vx}}function x6(a){return[a.initialNavigation==="disabled"?UL().\u0275providers:[],a.initialNavigation==="enabledBlocking"?jL().\u0275providers:[]]}var iS=new Kt("");function b6(){return[{provide:iS,useFactory:g6},{provide:dx,multi:!0,useExisting:iS}]}var T6=[],lb=class a{static \u0275fac=function(l){return new(l||a)};static \u0275mod=Uo({type:a});static \u0275inj=vo({imports:[ab.forRoot(T6),ab]})};var I6=a=>[a,40],cb=class a{constructor(d){this.config=d;this.strava=this.config.stravaClient}title=kg("velopitt");strava={};static \u0275fac=function(l){return new(l||a)(Xc(Kf))};static \u0275cmp=Pd({type:a,selectors:[["app-root"]],standalone:!1,decls:10,vars:6,consts:[[1,"content"],[3,"zoom","center"]],template:function(l,m){l&1&&(Ld(0,"div",0)(1,"h1"),t_(2,"Everything GitHub Demo"),Yc(),Ld(3,"h4"),t_(4,"deployed with \u2764\uFE0F and angular-cli-ghpages"),Yc(),Ld(5,"p"),t_(6," This is some dynamically loaded content that we hope to find in the Google index later on: "),Yc(),kd(7,"hr"),Yc(),kd(8,"mgl-map",1)(9,"router-outlet")),l&2&&(TT(8),ZT("mapbox://styles/hgriff0n/cmds2q1t100u101s2063wbeh6"),hx("zoom",9)("center",YT(4,I6,-74.5)))},dependencies:[M_,Mx],encapsulation:2})};var ub=class a{config=mt(Kf);static \u0275fac=function(l){return new(l||a)};static \u0275mod=Uo({type:a,bootstrap:[cb]});static \u0275inj=vo({providers:[PE(),PO({accessToken:zd.decode(Bd.MAPBOX_API_KEY)})],imports:[gI,lb,Mx,wI]})};mI().bootstrapModule(ub,{ngZoneEventCoalescing:!0}).catch(a=>console.error(a));
