var Jz=Object.create;var xw=Object.defineProperty,Qz=Object.defineProperties,e3=Object.getOwnPropertyDescriptor,t3=Object.getOwnPropertyDescriptors,n3=Object.getOwnPropertyNames,Gv=Object.getOwnPropertySymbols,r3=Object.getPrototypeOf,bw=Object.prototype.hasOwnProperty,_M=Object.prototype.propertyIsEnumerable;var gM=(a,u,l)=>u in a?xw(a,u,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[u]=l,$t=(a,u)=>{for(var l in u||={})bw.call(u,l)&&gM(a,l,u[l]);if(Gv)for(var l of Gv(u))_M.call(u,l)&&gM(a,l,u[l]);return a},Vr=(a,u)=>Qz(a,t3(u));var $v=(a,u)=>{var l={};for(var m in a)bw.call(a,m)&&u.indexOf(m)<0&&(l[m]=a[m]);if(a!=null&&Gv)for(var m of Gv(a))u.indexOf(m)<0&&_M.call(a,m)&&(l[m]=a[m]);return l};var yM=(a,u)=>()=>(u||a((u={exports:{}}).exports,u),u.exports);var i3=(a,u,l,m)=>{if(u&&typeof u=="object"||typeof u=="function")for(let b of n3(u))!bw.call(a,b)&&b!==l&&xw(a,b,{get:()=>u[b],enumerable:!(m=e3(u,b))||m.enumerable});return a};var ww=(a,u,l)=>(l=a!=null?Jz(r3(a)):{},i3(u||!a||!a.__esModule?xw(l,"default",{value:a,enumerable:!0}):l,a));var El=(a,u,l)=>new Promise((m,b)=>{var r=U=>{try{k(l.next(U))}catch(ae){b(ae)}},M=U=>{try{k(l.throw(U))}catch(ae){b(ae)}},k=U=>U.done?m(U.value):Promise.resolve(U.value).then(r,M);k((l=l.apply(a,u)).next())});var WI=yM((GI,$I)=>{"use strict";(function(a,u){typeof GI=="object"&&typeof $I<"u"?$I.exports=u():typeof define=="function"&&define.amd?define(u):(a=typeof globalThis<"u"?globalThis:a||self,a.mapboxgl=u())})(GI,function(){"use strict";var a,u,l;function m(r,M){if(!a)a=M;else if(!u)u=M;else{var k="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+a+")(sharedChunk); ("+u+")(sharedChunk); self.onerror = null;",U={};a(U),l=M(U),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(l.workerUrl=window.URL.createObjectURL(new Blob([k],{type:"text/javascript"})))}}m(["exports"],function(r){var M=1e-6,k=typeof Float32Array<"u"?Float32Array:Array;function U(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=n*f-c*s;return p?(i[0]=f*(p=1/p),i[1]=-s*p,i[2]=-c*p,i[3]=n*p,i):null}function ae(){var i=new k(9);return k!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function Ee(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=e[4],y=e[5],x=e[6],w=e[7],I=e[8];return i[0]=p*I-y*w,i[1]=c*w-s*I,i[2]=s*y-c*p,i[3]=y*x-f*I,i[4]=n*I-c*x,i[5]=c*f-n*y,i[6]=f*w-p*x,i[7]=s*x-n*w,i[8]=n*p-s*f,i}function Be(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3],y=e[4],x=e[5],w=e[6],I=e[7],S=e[8],D=n[0],P=n[1],O=n[2],N=n[3],B=n[4],G=n[5],X=n[6],q=n[7],K=n[8];return i[0]=D*s+P*p+O*w,i[1]=D*c+P*y+O*I,i[2]=D*f+P*x+O*S,i[3]=N*s+B*p+G*w,i[4]=N*c+B*y+G*I,i[5]=N*f+B*x+G*S,i[6]=X*s+q*p+K*w,i[7]=X*c+q*y+K*I,i[8]=X*f+q*x+K*S,i}function ht(){var i=new k(16);return k!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i}function Oe(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function Ct(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=e[4],y=e[5],x=e[6],w=e[7],I=e[8],S=e[9],D=e[10],P=e[11],O=e[12],N=e[13],B=e[14],G=e[15],X=n*y-s*p,q=n*x-c*p,K=n*w-f*p,he=s*x-c*y,le=s*w-f*y,ue=c*w-f*x,ge=I*N-S*O,ye=I*B-D*O,ke=I*G-P*O,be=S*B-D*N,ze=S*G-P*N,et=D*G-P*B,Ue=X*et-q*ze+K*be+he*ke-le*ye+ue*ge;return Ue?(i[0]=(y*et-x*ze+w*be)*(Ue=1/Ue),i[1]=(c*ze-s*et-f*be)*Ue,i[2]=(N*ue-B*le+G*he)*Ue,i[3]=(D*le-S*ue-P*he)*Ue,i[4]=(x*ke-p*et-w*ye)*Ue,i[5]=(n*et-c*ke+f*ye)*Ue,i[6]=(B*K-O*ue-G*q)*Ue,i[7]=(I*ue-D*K+P*q)*Ue,i[8]=(p*ze-y*ke+w*ge)*Ue,i[9]=(s*ke-n*ze-f*ge)*Ue,i[10]=(O*le-N*K+G*X)*Ue,i[11]=(S*K-I*le-P*X)*Ue,i[12]=(y*ye-p*be-x*ge)*Ue,i[13]=(n*be-s*ye+c*ge)*Ue,i[14]=(N*q-O*he-B*X)*Ue,i[15]=(I*he-S*q+D*X)*Ue,i):null}function Vt(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3],y=e[4],x=e[5],w=e[6],I=e[7],S=e[8],D=e[9],P=e[10],O=e[11],N=e[12],B=e[13],G=e[14],X=e[15],q=n[0],K=n[1],he=n[2],le=n[3];return i[0]=q*s+K*y+he*S+le*N,i[1]=q*c+K*x+he*D+le*B,i[2]=q*f+K*w+he*P+le*G,i[3]=q*p+K*I+he*O+le*X,i[4]=(q=n[4])*s+(K=n[5])*y+(he=n[6])*S+(le=n[7])*N,i[5]=q*c+K*x+he*D+le*B,i[6]=q*f+K*w+he*P+le*G,i[7]=q*p+K*I+he*O+le*X,i[8]=(q=n[8])*s+(K=n[9])*y+(he=n[10])*S+(le=n[11])*N,i[9]=q*c+K*x+he*D+le*B,i[10]=q*f+K*w+he*P+le*G,i[11]=q*p+K*I+he*O+le*X,i[12]=(q=n[12])*s+(K=n[13])*y+(he=n[14])*S+(le=n[15])*N,i[13]=q*c+K*x+he*D+le*B,i[14]=q*f+K*w+he*P+le*G,i[15]=q*p+K*I+he*O+le*X,i}function Ut(i,e,n){var s,c,f,p,y,x,w,I,S,D,P,O,N=n[0],B=n[1],G=n[2];return e===i?(i[12]=e[0]*N+e[4]*B+e[8]*G+e[12],i[13]=e[1]*N+e[5]*B+e[9]*G+e[13],i[14]=e[2]*N+e[6]*B+e[10]*G+e[14],i[15]=e[3]*N+e[7]*B+e[11]*G+e[15]):(c=e[1],f=e[2],p=e[3],y=e[4],x=e[5],w=e[6],I=e[7],S=e[8],D=e[9],P=e[10],O=e[11],i[0]=s=e[0],i[1]=c,i[2]=f,i[3]=p,i[4]=y,i[5]=x,i[6]=w,i[7]=I,i[8]=S,i[9]=D,i[10]=P,i[11]=O,i[12]=s*N+y*B+S*G+e[12],i[13]=c*N+x*B+D*G+e[13],i[14]=f*N+w*B+P*G+e[14],i[15]=p*N+I*B+O*G+e[15]),i}function Nt(i,e,n){var s=n[0],c=n[1],f=n[2];return i[0]=e[0]*s,i[1]=e[1]*s,i[2]=e[2]*s,i[3]=e[3]*s,i[4]=e[4]*c,i[5]=e[5]*c,i[6]=e[6]*c,i[7]=e[7]*c,i[8]=e[8]*f,i[9]=e[9]*f,i[10]=e[10]*f,i[11]=e[11]*f,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function li(i,e,n){var s=Math.sin(n),c=Math.cos(n),f=e[4],p=e[5],y=e[6],x=e[7],w=e[8],I=e[9],S=e[10],D=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=f*c+w*s,i[5]=p*c+I*s,i[6]=y*c+S*s,i[7]=x*c+D*s,i[8]=w*c-f*s,i[9]=I*c-p*s,i[10]=S*c-y*s,i[11]=D*c-x*s,i}function ci(i,e,n){var s=Math.sin(n),c=Math.cos(n),f=e[0],p=e[1],y=e[2],x=e[3],w=e[8],I=e[9],S=e[10],D=e[11];return e!==i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=f*c-w*s,i[1]=p*c-I*s,i[2]=y*c-S*s,i[3]=x*c-D*s,i[8]=f*s+w*c,i[9]=p*s+I*c,i[10]=y*s+S*c,i[11]=x*s+D*c,i}function Rr(i,e,n){var s=Math.sin(n),c=Math.cos(n),f=e[0],p=e[1],y=e[2],x=e[3],w=e[4],I=e[5],S=e[6],D=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=f*c+w*s,i[1]=p*c+I*s,i[2]=y*c+S*s,i[3]=x*c+D*s,i[4]=w*c-f*s,i[5]=I*c-p*s,i[6]=S*c-y*s,i[7]=D*c-x*s,i}function bs(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=e[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function wo(i,e,n){var s,c,f,p=n[0],y=n[1],x=n[2],w=Math.hypot(p,y,x);return w<M?null:(p*=w=1/w,y*=w,x*=w,s=Math.sin(e),c=Math.cos(e),i[0]=p*p*(f=1-c)+c,i[1]=y*p*f+x*s,i[2]=x*p*f-y*s,i[3]=0,i[4]=p*y*f-x*s,i[5]=y*y*f+c,i[6]=x*y*f+p*s,i[7]=0,i[8]=p*x*f+y*s,i[9]=y*x*f-p*s,i[10]=x*x*f+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i)}function ws(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=n+n,y=s+s,x=c+c,w=n*p,I=s*p,S=s*y,D=c*p,P=c*y,O=c*x,N=f*p,B=f*y,G=f*x;return i[0]=1-S-O,i[1]=I+G,i[2]=D-B,i[3]=0,i[4]=I-G,i[5]=1-w-O,i[6]=P+N,i[7]=0,i[8]=D+B,i[9]=P-N,i[10]=1-w-S,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});var Zd=Vt;function zn(){var i=new k(3);return k!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function Ul(i){var e=new k(3);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e}function Ei(i){return Math.hypot(i[0],i[1],i[2])}function Zr(i,e,n){var s=new k(3);return s[0]=i,s[1]=e,s[2]=n,s}function jr(i,e,n,s){return i[0]=e,i[1]=n,i[2]=s,i}function mr(i,e,n){return i[0]=e[0]+n[0],i[1]=e[1]+n[1],i[2]=e[2]+n[2],i}function uo(i,e,n){return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],i}function au(i,e,n){return i[0]=e[0]*n[0],i[1]=e[1]*n[1],i[2]=e[2]*n[2],i}function Os(i,e,n){return i[0]=Math.min(e[0],n[0]),i[1]=Math.min(e[1],n[1]),i[2]=Math.min(e[2],n[2]),i}function Zo(i,e,n){return i[0]=Math.max(e[0],n[0]),i[1]=Math.max(e[1],n[1]),i[2]=Math.max(e[2],n[2]),i}function hr(i,e,n){return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i}function zi(i,e,n,s){return i[0]=e[0]+n[0]*s,i[1]=e[1]+n[1]*s,i[2]=e[2]+n[2]*s,i}function jl(i,e){var n=e[0]-i[0],s=e[1]-i[1],c=e[2]-i[2];return n*n+s*s+c*c}function qd(i){var e=i[0],n=i[1],s=i[2];return e*e+n*n+s*s}function ca(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i}function cr(i,e){var n=e[0],s=e[1],c=e[2],f=n*n+s*s+c*c;return f>0&&(f=1/Math.sqrt(f)),i[0]=e[0]*f,i[1]=e[1]*f,i[2]=e[2]*f,i}function kr(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function qr(i,e,n){var s=e[0],c=e[1],f=e[2],p=n[0],y=n[1],x=n[2];return i[0]=c*x-f*y,i[1]=f*p-s*x,i[2]=s*y-c*p,i}function Yi(i,e,n,s){var c=e[0],f=e[1],p=e[2];return i[0]=c+s*(n[0]-c),i[1]=f+s*(n[1]-f),i[2]=p+s*(n[2]-p),i}function Nr(i,e,n){var s=e[0],c=e[1],f=e[2],p=n[3]*s+n[7]*c+n[11]*f+n[15];return i[0]=(n[0]*s+n[4]*c+n[8]*f+n[12])/(p=p||1),i[1]=(n[1]*s+n[5]*c+n[9]*f+n[13])/p,i[2]=(n[2]*s+n[6]*c+n[10]*f+n[14])/p,i}function ua(i,e,n){var s=e[0],c=e[1],f=e[2];return i[0]=s*n[0]+c*n[3]+f*n[6],i[1]=s*n[1]+c*n[4]+f*n[7],i[2]=s*n[2]+c*n[5]+f*n[8],i}function da(i,e,n){var s=n[0],c=n[1],f=n[2],p=e[0],y=e[1],x=e[2],w=c*x-f*y,I=f*p-s*x,S=s*y-c*p,D=c*S-f*I,P=f*w-s*S,O=s*I-c*w,N=2*n[3];return I*=N,S*=N,P*=2,O*=2,i[0]=p+(w*=N)+(D*=2),i[1]=y+I+P,i[2]=x+S+O,i}function lu(i){return i[0]=0,i[1]=0,i[2]=0,i}function qo(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]}var zr=uo,Ki=au,ha=Ei;function cu(){var i=new k(4);return k!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function Ls(i,e,n){return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i[3]=e[3]*n,i}function Eo(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=n*n+s*s+c*c+f*f;return p>0&&(p=1/Math.sqrt(p)),i[0]=n*p,i[1]=s*p,i[2]=c*p,i[3]=f*p,i}function ho(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3];return i[0]=n[0]*s+n[4]*c+n[8]*f+n[12]*p,i[1]=n[1]*s+n[5]*c+n[9]*f+n[13]*p,i[2]=n[2]*s+n[6]*c+n[10]*f+n[14]*p,i[3]=n[3]*s+n[7]*c+n[11]*f+n[15]*p,i}function Fs(){var i=new k(4);return k!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function ks(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function Qa(i,e,n){n*=.5;var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x+p*y,i[1]=c*x+f*y,i[2]=f*x-c*y,i[3]=p*x-s*y,i}function Hl(i,e,n){n*=.5;var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x-f*y,i[1]=c*x+p*y,i[2]=f*x+s*y,i[3]=p*x-c*y,i}zn(),cu();var Ji,To,uu,Ns=Eo,Gl=(Ji=zn(),To=Zr(1,0,0),uu=Zr(0,1,0),function(i,e,n){var s=kr(e,n);return s<-.999999?(qr(Ji,To,e),ha(Ji)<1e-6&&qr(Ji,uu,e),cr(Ji,Ji),function(c,f,p){p*=.5;var y=Math.sin(p);c[0]=y*f[0],c[1]=y*f[1],c[2]=y*f[2],c[3]=Math.cos(p)}(i,Ji,Math.PI),i):s>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(qr(Ji,e,n),i[0]=Ji[0],i[1]=Ji[1],i[2]=Ji[2],i[3]=1+s,Ns(i,i))});function Mi(){var i=new k(2);return k!=Float32Array&&(i[0]=0,i[1]=0),i}function Io(i,e){var n=new k(2);return n[0]=i,n[1]=e,n}function fa(i,e,n){return i[0]=e[0]+n[0],i[1]=e[1]+n[1],i}function zs(i,e,n){return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i}function pa(i,e,n){return i[0]=e[0]*n,i[1]=e[1]*n,i}function ma(i){return Math.hypot(i[0],i[1])}function $l(i,e){var n=e[0],s=e[1],c=n*n+s*s;return c>0&&(c=1/Math.sqrt(c)),i[0]=e[0]*c,i[1]=e[1]*c,i}function ur(i,e){return i[0]*e[0]+i[1]*e[1]}Fs(),Fs(),ae();var du,hu,So=zs;function fu(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}Mi();var xp=function(){if(hu)return du;function i(e,n,s,c){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(c-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=n,this.p2x=s,this.p2y=c}return hu=1,du=i,i.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,n){if(n===void 0&&(n=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,c=0;c<8;c++){var f=this.sampleCurveX(s)-e;if(Math.abs(f)<n)return s;var p=this.sampleCurveDerivativeX(s);if(Math.abs(p)<1e-6)break;s-=f/p}var y=0,x=1;for(s=e,c=0;c<20&&(f=this.sampleCurveX(s),!(Math.abs(f-e)<n));c++)e>f?y=s:x=s,s=.5*(x-y)+y;return s},solve:function(e,n){return this.sampleCurveY(this.solveCurveX(e,n))}},du}(),Wl=fu(xp);function Xe(i,e){this.x=i,this.y=e}function Bs(i,e){if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let n=0;n<i.length;n++)if(!Bs(i[n],e[n]))return!1;return!0}if(typeof i=="object"&&i!==null&&e!==null){if(typeof e!="object"||Object.keys(i).length!==Object.keys(e).length)return!1;for(let n in i)if(!Bs(i[n],e[n]))return!1;return!0}return i===e}Xe.prototype={clone(){return new Xe(this.x,this.y)},add(i){return this.clone()._add(i)},sub(i){return this.clone()._sub(i)},multByPoint(i){return this.clone()._multByPoint(i)},divByPoint(i){return this.clone()._divByPoint(i)},mult(i){return this.clone()._mult(i)},div(i){return this.clone()._div(i)},rotate(i){return this.clone()._rotate(i)},rotateAround(i,e){return this.clone()._rotateAround(i,e)},matMult(i){return this.clone()._matMult(i)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(i){return this.x===i.x&&this.y===i.y},dist(i){return Math.sqrt(this.distSqr(i))},distSqr(i){let e=i.x-this.x,n=i.y-this.y;return e*e+n*n},angle(){return Math.atan2(this.y,this.x)},angleTo(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith(i){return this.angleWithSep(i.x,i.y)},angleWithSep(i,e){return Math.atan2(this.x*e-this.y*i,this.x*i+this.y*e)},_matMult(i){let e=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=e,this},_add(i){return this.x+=i.x,this.y+=i.y,this},_sub(i){return this.x-=i.x,this.y-=i.y,this},_mult(i){return this.x*=i,this.y*=i,this},_div(i){return this.x/=i,this.y/=i,this},_multByPoint(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint(i){return this.x/=i.x,this.y/=i.y,this},_unit(){return this._div(this.mag()),this},_perp(){let i=this.y;return this.y=this.x,this.x=-i,this},_rotate(i){let e=Math.cos(i),n=Math.sin(i),s=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=s,this},_rotateAround(i,e){let n=Math.cos(i),s=Math.sin(i),c=e.y+s*(this.x-e.x)+n*(this.y-e.y);return this.x=e.x+n*(this.x-e.x)-s*(this.y-e.y),this.y=c,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Xe},Xe.convert=function(i){if(i instanceof Xe)return i;if(Array.isArray(i))return new Xe(+i[0],+i[1]);if(i.x!==void 0&&i.y!==void 0)return new Xe(+i.x,+i.y);throw new Error("Expected [x, y] or {x, y} point format")};let bp=Math.PI/180,pu=180/Math.PI;function Sn(i){return i*bp}function De(i){return i*pu}let $=[[0,0],[1,0],[1,1],[0,1]];function W(i){if(i<=0)return 0;if(i>=1)return 1;let e=i*i,n=e*i;return 4*(i<.5?n:3*(i-e)+n-.75)}function te(i,e,n,s){let c=new Wl(i,e,n,s);return function(f){return c.solve(f)}}let fe=te(.25,.1,.25,1);function ne(i,e,n){return Math.min(n,Math.max(e,i))}function _e(i,e,n){return(n=ne((n-i)/(e-i),0,1))*n*(3-2*n)}function Me(i,e,n){let s=n-e,c=((i-e)%s+s)%s+e;return c===e?n:c}function ve(i,e,n){if(!i.length)return n(null,[]);let s=i.length,c=new Array(i.length),f=null;i.forEach((p,y)=>{e(p,(x,w)=>{x&&(f=x),c[y]=w,--s==0&&n(f,c)})})}function Ce(i,...e){for(let n of e)for(let s in n)i[s]=n[s];return i}let nt=1;function je(){return nt++}function Dt(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))}function kt(i,e){i.forEach(n=>{e[n]&&(e[n]=e[n].bind(e))})}function jt(i,e,n){let s={};for(let c in i)s[c]=e.call(this,i[c],c,i);return s}function dn(i,e,n){let s={};for(let c in i)e.call(this,i[c],c,i)&&(s[c]=i[c]);return s}function rn(i){return Array.isArray(i)?i.map(rn):typeof i=="object"&&i?jt(i,rn):i}function hn(i,e){for(let n=0;n<i.length;n++)if(e.indexOf(i[n])>=0)return!0;return!1}let Kn={};function fn(i){Kn[i]||(typeof console<"u"&&console.warn(i),Kn[i]=!0)}function Pr(i,e,n){return(n.y-i.y)*(e.x-i.x)>(e.y-i.y)*(n.x-i.x)}function ii(i){let e=0;for(let n,s,c=0,f=i.length,p=f-1;c<f;p=c++)n=i[c],s=i[p],e+=(s.x-n.x)*(n.y+s.y);return e}function Jr([i,e,n]){let s=Sn(e+90),c=Sn(n);return{x:i*Math.cos(s)*Math.sin(c),y:i*Math.sin(s)*Math.sin(c),z:i*Math.cos(c),azimuthal:e,polar:n}}function $n(i){return(typeof self<"u"||i!==void 0)&&typeof WorkerGlobalScope<"u"&&(i!==void 0?i:self)instanceof WorkerGlobalScope}function An(i){let e={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,s,c,f)=>{let p=c||f;return e[s]=!p||p.toLowerCase(),""}),e["max-age"]){let n=parseInt(e["max-age"],10);isNaN(n)?delete e["max-age"]:e["max-age"]=n}return e}let Ar=null;function wr(i,e){return[i[4*e],i[4*e+1],i[4*e+2],i[4*e+3]]}function gr(i,e,n,s){for(;e<n;){let c=e+n>>1;i[c]<s?e=c+1:n=c}return e}function hi(i,e,n,s){for(;e<n;){let c=e+n>>1;i[c]<=s?e=c+1:n=c}return e}function Qi(i){return i>0?1/(1.001-i):1+i}function Ri(i){return i>0?1-1/(1.001-i):-i}function mu(i,e,n){return(i-e.min)*(n.max-n.min)/(e.max-e.min)+n.min}let vi={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!vi.API_URL)return null;try{let i=new URL(vi.API_URL);return i.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":i.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.1.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function ga(i){return vi.API_URL_REGEX.test(i)}function Xd(i){return vi.API_SPRITE_REGEX.test(i)}let gu,_u,Yd,Kd,el,yu;function Jd(){return gu==null&&(gu=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),gu}let cs={now:()=>Kd!==void 0?Kd:performance.now(),setNow(i){Kd=i},restoreNow(){Kd=void 0},frame(i){let e=requestAnimationFrame(i);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(i,e=0){let{width:n,height:s}=i;el||(el=document.createElement("canvas"));let c=el.getContext("2d",{willReadFrequently:!0});if(!c)throw new Error("failed to create canvas 2d context");return(n>el.width||s>el.height)&&(el.width=n,el.height=s),c.clearRect(-e,-e,n+2*e,s+2*e),c.drawImage(i,0,0,n,s),c.getImageData(-e,-e,n+2*e,s+2*e)},resolveURL:i=>(_u||(_u=document.createElement("a")),_u.href=i,_u.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Yd==null&&(Yd=window.matchMedia("(prefers-reduced-motion: reduce)")),Yd.matches)},hasCanvasFingerprintNoise(){if(yu!==void 0)return yu;if(!Jd())return yu=!1,!1;let i=new OffscreenCanvas(85,1),e=i.getContext("2d",{willReadFrequently:!0}),n=0;for(let c=0;c<i.width;++c)e.fillStyle=`rgba(${n++},${n++},${n++}, 255)`,e.fillRect(c,0,1,1);let s=e.getImageData(0,0,i.width,i.height);n=0;for(let c=0;c<s.data.length;++c)if(c%4!=3&&n++!==s.data[c])return yu=!0,!0;return yu=!1,!1}};function Do(i,e){let n=i.indexOf("?");if(n<0)return`${i}?${new URLSearchParams(e).toString()}`;let s=new URLSearchParams(i.slice(n));for(let c in e)s.set(c,e[c]);return`${i.slice(0,n)}?${s.toString()}`}function Xo(i,e={persistentParams:[]}){let n=i.indexOf("?");if(n<0)return i;let s=new URLSearchParams,c=new URLSearchParams(i.slice(n));for(let p of e.persistentParams){let y=c.get(p);y&&s.set(p,y)}let f=s.toString();return`${i.slice(0,n)}${f.length>0?`?${f}`:""}`}let Vs="mapbox-tiles",us=500,Us=50,vu=["language","worldview","jobid"],Es,xu;function tl(){try{return caches}catch{}}function Zl(){let i=tl();i&&Es==null&&(Es=i.open(Vs))}let wp=1/0,Ep={supported:!1,testSupport:function(i){!bu&&nl&&(ql?G_(i):eo=i)}},eo,nl,bu=!1,ql=!1,H_=typeof self<"u"?self:{};function G_(i){let e=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);try{if(i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,nl),i.isContextLost())return;Ep.supported=!0}catch{}i.deleteTexture(e),bu=!0}H_.document&&(nl=H_.document.createElement("img"),nl.onload=function(){eo&&G_(eo),eo=null,ql=!0},nl.onerror=function(){bu=!0,eo=null},nl.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let wu={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(wu);class xn extends Error{constructor(e,n,s){n===401&&ga(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=n,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let Qd=$n()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Xl=function(i,e){if(!(/^file:/.test(n=i.url)||/^file:/.test(Qd())&&!/^\w+:/.test(n))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,c){let f=new AbortController,p=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:Qd(),referrerPolicy:s.referrerPolicy,signal:f.signal}),y=!1,x=!1,w=(I=p.url).indexOf("sku=")>0&&ga(I);var I;s.type==="json"&&p.headers.set("Accept","application/json");let S=(P,O,N)=>{if(x)return;if(P&&P.message!=="SecurityError"&&fn(P.toString()),O&&N)return D(O);let B=Date.now();fetch(p).then(G=>{if(G.ok){let X=w?G.clone():null;return D(G,X,B)}return c(new xn(G.statusText,G.status,s.url))}).catch(G=>{G.name!=="AbortError"&&c(new Error(`${G.message} ${s.url}`))})},D=(P,O,N)=>{(s.type==="arrayBuffer"?P.arrayBuffer():s.type==="json"?P.json():P.text()).then(B=>{x||(O&&N&&function(G,X,q){if(Zl(),Es==null)return;let K=An(X.headers.get("Cache-Control")||"");if(K["no-store"])return;let he={status:X.status,statusText:X.statusText,headers:new Headers};X.headers.forEach((ge,ye)=>he.headers.set(ye,ge)),K["max-age"]&&he.headers.set("Expires",new Date(q+1e3*K["max-age"]).toUTCString());let le=he.headers.get("Expires");if(!le||new Date(le).getTime()-q<42e4)return;let ue=Xo(G.url,{persistentParams:vu});if(X.status===206){let ge=G.headers.get("Range");if(!ge)return;he.status=200,ue=Do(ue,{range:ge})}(function(ge,ye){if(xu===void 0)try{new Response(new ReadableStream),xu=!0}catch{xu=!1}xu?ye(ge.body):ge.blob().then(ye).catch(ke=>fn(ke.message))})(X,ge=>{let ye=new Response((ke=X.status)!==200&&ke!==404&&[101,103,204,205,304].includes(ke)?null:ge,he);var ke;Zl(),Es?.then(be=>be.put(ue,ye)).catch(be=>fn(be.message))})}(p,O,N),y=!0,c(null,B,P.headers.get("Cache-Control"),P.headers.get("Expires")))}).catch(B=>{x||c(new Error(B.message))})};return w?function(P,O){if(Zl(),Es==null)return O(null);Es.then(N=>{let B=Xo(P.url,{persistentParams:vu}),G=P.headers.get("Range");G&&(B=Do(B,{range:G})),N.match(B).then(X=>{let q=function(K){if(!K)return!1;let he=new Date(K.headers.get("Expires")||0),le=An(K.headers.get("Cache-Control")||"");return Number(he)>Date.now()&&!le["no-cache"]}(X);N.delete(B).catch(O),q&&N.put(B,X.clone()).catch(O),O(null,X,q)}).catch(O)}).catch(O)}(p,S):S(null,null),{cancel:()=>{x=!0,y||f.abort()}}}(i,e);if($n(self)&&self.worker.actor)return self.worker.actor.send("getResource",i,e,void 0,!0)}var n;return function(s,c){let f=new XMLHttpRequest;f.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(f.responseType="arraybuffer");for(let p in s.headers)f.setRequestHeader(p,s.headers[p]);return s.type==="json"&&(f.responseType="text",f.setRequestHeader("Accept","application/json")),f.withCredentials=s.credentials==="include",f.onerror=()=>{c(new Error(f.statusText))},f.onload=()=>{if((f.status>=200&&f.status<300||f.status===0)&&f.response!==null){let p=f.response;if(s.type==="json")try{p=JSON.parse(f.response)}catch(y){return c(y)}c(null,p,f.getResponseHeader("Cache-Control"),f.getResponseHeader("Expires"))}else c(new xn(f.statusText,f.status,s.url))},f.send(s.body),{cancel:()=>f.abort()}}(i,e)},Eu=function(i,e){return Xl(Ce(i,{type:"arrayBuffer"}),e)};function Ib(i){let e=document.createElement("a");return e.href=i,e.protocol===location.protocol&&e.host===location.host}let Tu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",rl,_a;rl=[],_a=0;let Iu=function(i,e){if(Ep.supported&&(i.headers||(i.headers={}),i.headers.accept="image/webp,*/*"),_a>=vi.MAX_PARALLEL_IMAGE_REQUESTS){let f={requestParameters:i,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return rl.push(f),f}_a++;let n=!1,s=()=>{if(!n)for(n=!0,_a--;rl.length&&_a<vi.MAX_PARALLEL_IMAGE_REQUESTS;){let f=rl.shift(),{requestParameters:p,callback:y,cancelled:x}=f;x||(f.cancel=Iu(p,y).cancel)}},c=Eu(i,(f,p,y,x)=>{s(),f?e(f):p&&(self.createImageBitmap?function(w,I){let S=new Blob([new Uint8Array(w)],{type:"image/png"});createImageBitmap(S).then(D=>{I(null,D)}).catch(D=>{I(new Error(`Could not load image because of ${D.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(p,(w,I)=>e(w,I,y,x)):function(w,I){let S=new Image;S.onload=()=>{I(null,S),URL.revokeObjectURL(S.src),S.onload=null,requestAnimationFrame(()=>{S.src=Tu})},S.onerror=()=>I(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let D=new Blob([new Uint8Array(w)],{type:"image/png"});S.src=w.byteLength?URL.createObjectURL(D):Tu}(p,(w,I)=>e(w,I,y,x)))});return{cancel:()=>{c.cancel(),s()}}};var $_,eh,W_,Yl={exports:{}},il={exports:{}},Z_={exports:{}},Su=function(){if(W_)return Yl.exports;W_=1;var i=($_||($_=1,il.exports=function(n,s){var c,f,p,y,x,w,I,S;for(f=n.length-(c=3&n.length),p=s,x=3432918353,w=461845907,S=0;S<f;)I=255&n.charCodeAt(S)|(255&n.charCodeAt(++S))<<8|(255&n.charCodeAt(++S))<<16|(255&n.charCodeAt(++S))<<24,++S,p=27492+(65535&(y=5*(65535&(p=(p^=I=(65535&(I=(I=(65535&I)*x+(((I>>>16)*x&65535)<<16)&4294967295)<<15|I>>>17))*w+(((I>>>16)*w&65535)<<16)&4294967295)<<13|p>>>19))+((5*(p>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(I=0,c){case 3:I^=(255&n.charCodeAt(S+2))<<16;case 2:I^=(255&n.charCodeAt(S+1))<<8;case 1:p^=I=(65535&(I=(I=(65535&(I^=255&n.charCodeAt(S)))*x+(((I>>>16)*x&65535)<<16)&4294967295)<<15|I>>>17))*w+(((I>>>16)*w&65535)<<16)&4294967295}return p^=n.length,p=2246822507*(65535&(p^=p>>>16))+((2246822507*(p>>>16)&65535)<<16)&4294967295,p=3266489909*(65535&(p^=p>>>13))+((3266489909*(p>>>16)&65535)<<16)&4294967295,(p^=p>>>16)>>>0}),il.exports),e=(eh||(eh=1,Z_.exports=function(n,s){for(var c,f=n.length,p=s^f,y=0;f>=4;)c=1540483477*(65535&(c=255&n.charCodeAt(y)|(255&n.charCodeAt(++y))<<8|(255&n.charCodeAt(++y))<<16|(255&n.charCodeAt(++y))<<24))+((1540483477*(c>>>16)&65535)<<16),p=1540483477*(65535&p)+((1540483477*(p>>>16)&65535)<<16)^(c=1540483477*(65535&(c^=c>>>24))+((1540483477*(c>>>16)&65535)<<16)),f-=4,++y;switch(f){case 3:p^=(255&n.charCodeAt(y+2))<<16;case 2:p^=(255&n.charCodeAt(y+1))<<8;case 1:p=1540483477*(65535&(p^=255&n.charCodeAt(y)))+((1540483477*(p>>>16)&65535)<<16)}return p=1540483477*(65535&(p^=p>>>13))+((1540483477*(p>>>16)&65535)<<16),(p^=p>>>15)>>>0}),Z_.exports);return Yl.exports=i,Yl.exports.murmur3=i,Yl.exports.murmur2=e,Yl.exports}(),Kl=fu(Su);class js{constructor(e,...n){Ce(this,n[0]||{}),this.type=e}}class Co extends js{constructor(e,n={}){super("error",Ce({error:e},n))}}function Tp(i,e,n){n[i]&&n[i].indexOf(e)!==-1||(n[i]=n[i]||[],n[i].push(e))}function Ip(i,e,n){if(n&&n[i]){let s=n[i].indexOf(e);s!==-1&&n[i].splice(s,1)}}class ol{on(e,n){return this._listeners=this._listeners||{},Tp(e,n,this._listeners),this}off(e,n){return Ip(e,n,this._listeners),Ip(e,n,this._oneTimeListeners),this}once(e,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},Tp(e,n,this._oneTimeListeners),this):new Promise(s=>{this.once(e,s)})}fire(e,n){let s=typeof e=="string"?new js(e,n):e,c=s.type;if(this.listens(c)){s.target=this;let f=this._listeners&&this._listeners[c]?this._listeners[c].slice():[];for(let x of f)x.call(this,s);let p=this._oneTimeListeners&&this._oneTimeListeners[c]?this._oneTimeListeners[c].slice():[];for(let x of p)Ip(c,x,this._oneTimeListeners),x.call(this,s);let y=this._eventedParent;y&&(Ce(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),y.fire(s))}else s instanceof Co&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,n){return this._eventedParent=e,this._eventedParentData=n,this}}class fo{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new fo(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){let[n,s]=e.split("");return new fo({name:n,iconsetId:s})}static isEqual(e,n){return e.name===n.name&&e.iconsetId===n.iconsetId}toString(){return fo.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Sp,th={},Dp=function(){if(Sp)return th;Sp=1;var i={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(f){return(f=Math.round(f))<0?0:f>255?255:f}function n(f){return e(f[f.length-1]==="%"?parseFloat(f)/100*255:parseInt(f))}function s(f){return(p=f[f.length-1]==="%"?parseFloat(f)/100:parseFloat(f))<0?0:p>1?1:p;var p}function c(f,p,y){return y<0?y+=1:y>1&&(y-=1),6*y<1?f+(p-f)*y*6:2*y<1?p:3*y<2?f+(p-f)*(2/3-y)*6:f}try{th.parseCSSColor=function(f){var p,y=f.replace(/ /g,"").toLowerCase();if(y in i)return i[y].slice();if(y[0]==="#")return y.length===4?(p=parseInt(y.substr(1),16))>=0&&p<=4095?[(3840&p)>>4|(3840&p)>>8,240&p|(240&p)>>4,15&p|(15&p)<<4,1]:null:y.length===7&&(p=parseInt(y.substr(1),16))>=0&&p<=16777215?[(16711680&p)>>16,(65280&p)>>8,255&p,1]:null;var x=y.indexOf("("),w=y.indexOf(")");if(x!==-1&&w+1===y.length){var I=y.substr(0,x),S=y.substr(x+1,w-(x+1)).split(","),D=1;switch(I){case"rgba":if(S.length!==4)return null;D=s(S.pop());case"rgb":return S.length!==3?null:[n(S[0]),n(S[1]),n(S[2]),D];case"hsla":if(S.length!==4)return null;D=s(S.pop());case"hsl":if(S.length!==3)return null;var P=(parseFloat(S[0])%360+360)%360/360,O=s(S[1]),N=s(S[2]),B=N<=.5?N*(O+1):N+O-N*O,G=2*N-B;return[e(255*c(G,B,P+1/3)),e(255*c(G,B,P)),e(255*c(G,B,P-1/3)),D];default:return null}}return null}}catch{}return th}();class Ln{constructor(e,n,s,c=1){this.r=e,this.g=n,this.b=s,this.a=c}static parse(e){if(!e)return;if(e instanceof Ln)return e;if(typeof e!="string")return;let n=Dp.parseCSSColor(e);return n?new Ln(n[0]/255,n[1]/255,n[2]/255,n[3]):void 0}toString(){let[e,n,s,c]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*n)},${Math.round(255*s)},${c})`}toNonPremultipliedRenderColor(e){let{r:n,g:s,b:c,a:f}=this;return new Jl(e,n,s,c,f)}toPremultipliedRenderColor(e){let{r:n,g:s,b:c,a:f}=this;return new q_(e,n*f,s*f,c*f,f)}clone(){return new Ln(this.r,this.g,this.b,this.a)}}class Du{constructor(e,n,s,c,f,p=!1){if(this.premultiplied=!1,this.premultiplied=p,e){let y=e.image.height,x=y*y;this.premultiplied?(n=f===0?0:n/f*(y-1),s=f===0?0:s/f*(y-1),c=f===0?0:c/f*(y-1)):(n*=y-1,s*=y-1,c*=y-1);let w=Math.floor(n),I=Math.floor(s),S=Math.floor(c),D=Math.ceil(n),P=Math.ceil(s),O=Math.ceil(c),N=n-w,B=s-I,G=c-S,X=e.image.data,q=4*(w+I*x+S*y),K=4*(w+I*x+O*y),he=4*(w+P*x+S*y),le=4*(w+P*x+O*y),ue=4*(D+I*x+S*y),ge=4*(D+I*x+O*y),ye=4*(D+P*x+S*y),ke=4*(D+P*x+O*y);if(q<0||ke>=X.length)throw new Error("out of range");this.r=At(At(At(X[q],X[K],G),At(X[he],X[le],G),B),At(At(X[ue],X[ge],G),At(X[ye],X[ke],G),B),N)/255*(this.premultiplied?f:1),this.g=At(At(At(X[q+1],X[K+1],G),At(X[he+1],X[le+1],G),B),At(At(X[ue+1],X[ge+1],G),At(X[ye+1],X[ke+1],G),B),N)/255*(this.premultiplied?f:1),this.b=At(At(At(X[q+2],X[K+2],G),At(X[he+2],X[le+2],G),B),At(At(X[ue+2],X[ge+2],G),At(X[ye+2],X[ke+2],G),B),N)/255*(this.premultiplied?f:1),this.a=f}else this.r=n,this.g=s,this.b=c,this.a=f}toArray(){let{r:e,g:n,b:s,a:c}=this;return[255*e,255*n,255*s,c]}toHslaArray(){let{r:e,g:n,b:s,a:c}=this;if(this.premultiplied){if(c===0)return[0,0,0,0];e/=c,n/=c,s/=c}let f=Math.min(Math.max(e,0),1),p=Math.min(Math.max(n,0),1),y=Math.min(Math.max(s,0),1),x=Math.min(f,p,y),w=Math.max(f,p,y),I=(x+w)/2;if(x===w)return[0,0,100*I,c];let S=w-x,D=I>.5?S/(2-w-x):S/(w+x),P=0;return w===f?P=(p-y)/S+(p<y?6:0):w===p?P=(y-f)/S+2:w===y&&(P=(f-p)/S+4),P*=60,[Math.min(Math.max(P,0),360),Math.min(Math.max(100*D,0),100),Math.min(Math.max(100*I,0),100),c]}toArray01(){let{r:e,g:n,b:s,a:c}=this;return[e,n,s,c]}toArray01Scaled(e){let{r:n,g:s,b:c}=this;return[n*e,s*e,c*e]}toArray01Linear(){let{r:e,g:n,b:s,a:c}=this;return[Math.pow(e,2.2),Math.pow(n,2.2),Math.pow(s,2.2),c]}}class Jl extends Du{constructor(e,n,s,c,f){super(e,n,s,c,f,!1)}}class q_ extends Du{constructor(e,n,s,c,f){super(e,n,s,c,f,!0)}}function At(i,e,n){return i*(1-n)+e*n}function X_(i,e,n){return i.map((s,c)=>At(s,e[c],n))}Ln.black=new Ln(0,0,0,1),Ln.white=new Ln(1,1,1,1),Ln.transparent=new Ln(0,0,0,0),Ln.red=new Ln(1,0,0,1),Ln.blue=new Ln(0,0,1,1);var Cu=Object.freeze({__proto__:null,array:X_,color:function(i,e,n){return new Ln(At(i.r,e.r,n),At(i.g,e.g,n),At(i.b,e.b,n),At(i.a,e.a,n))},number:At});function sl(i,...e){for(let n of e)for(let s in n)i[s]=n[s];return i}class Ao extends Error{constructor(e,n){super(n),this.message=n,this.key=e}}class Cp{constructor(e,n=[]){this.parent=e,this.bindings={};for(let[s,c]of n)this.bindings[s]=c}concat(e){return new Cp(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}let Ql={kind:"null"},It={kind:"number"},Pn={kind:"string"},On={kind:"boolean"},po={kind:"color"},Hs={kind:"object"},Fn={kind:"value"},nh={kind:"collator"},Au={kind:"formatted"},Mu={kind:"resolvedImage"};function Pi(i,e){return{kind:"array",itemType:i,N:e}}function Qr(i){if(i.kind==="array"){let e=Qr(i.itemType);return typeof i.N=="number"?`array<${e}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${e}>`}return i.kind}let Sb=[Ql,It,Pn,On,po,Au,Hs,Pi(Fn),Mu];function ec(i,e){if(e.kind==="error")return null;if(i.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!ec(i.itemType,e.itemType))&&(typeof i.N!="number"||i.N===e.N))return null}else{if(i.kind===e.kind)return null;if(i.kind==="value"){for(let n of Sb)if(!ec(n,e))return null}}return`Expected ${Qr(i)} but found ${Qr(e)} instead.`}function ya(i,e){return e.some(n=>n.kind===i.kind)}function Ru(i,e){return e.some(n=>n==="null"?i===null:n==="array"?Array.isArray(i):n==="object"?i&&!Array.isArray(i)&&typeof i=="object":n===typeof i)}function rh(i,e){return i.kind==="array"&&e.kind==="array"?i.N===e.N&&rh(i.itemType,e.itemType):i.kind===e.kind}class Pu{constructor(e,n,s){this.sensitivity=e?n?"variant":"case":n?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,n){return this.collator.compare(e,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ih{constructor(e,n,s,c,f){this.text=e.normalize?e.normalize():e,this.image=n,this.scale=s,this.fontStack=c,this.textColor=f}}class Bi{constructor(e){this.sections=e}static fromString(e){return new Bi([new ih(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Bi?e:Bi.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){let e=["format"];for(let n of this.sections){if(n.image){let c=n.image.getPrimary().id.toString();e.push(["image",c]);continue}e.push(n.text);let s={};n.fontStack&&(s["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(s["font-scale"]=n.scale),n.textColor&&(s["text-color"]=["rgba"].concat(n.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class Gs{constructor(e,n={}){if(this.id=fo.from(e),this.options=Object.assign({},n),n.transform){let{a:s,b:c,c:f,d:p,e:y,f:x}=n.transform;this.options.transform=new DOMMatrix([s,c,f,p,y,x])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:e,b:n,c:s,d:c,e:f,f:p}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:n,c:s,d:c,e:f,f:p}})}static parse(e){let n,s,c,f;try{({name:n,iconsetId:s,params:c,transform:f}=JSON.parse(e)||{})}catch{return null}if(!n)return null;let{a:p,b:y,c:x,d:w,e:I,f:S}=f||{};return new Gs({name:n,iconsetId:s},{params:c,transform:new DOMMatrix([p,y,x,w,I,S])})}scaleSelf(e,n){return this.options.transform.scaleSelf(e,n),this}}class to{constructor(e,n,s,c,f=!1){this.primaryId=fo.from(e),this.primaryOptions=n,s&&(this.secondaryId=fo.from(s)),this.secondaryOptions=c,this.available=f}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Gs(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Gs(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?to.build({name:e}):e}static build(e,n,s,c){return!e||typeof e=="object"&&!("name"in e)?null:new to(e,s,n,c)}}function al(i,e,n,s){return typeof i=="number"&&i>=0&&i<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof n=="number"&&n>=0&&n<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[i,e,n,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[i,e,n,s]:[i,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Yt(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof Ln||i instanceof Pu||i instanceof Bi||i instanceof to)return!0;if(Array.isArray(i)){for(let e of i)if(!Yt(e))return!1;return!0}if(typeof i=="object"){for(let e in i)if(!Yt(i[e]))return!1;return!0}return!1}function gt(i){if(i===null)return Ql;if(typeof i=="string")return Pn;if(typeof i=="boolean")return On;if(typeof i=="number")return It;if(i instanceof Ln)return po;if(i instanceof Pu)return nh;if(i instanceof Bi)return Au;if(i instanceof to)return Mu;if(Array.isArray(i)){let e=i.length,n;for(let s of i){let c=gt(s);if(n){if(n===c)continue;n=Fn;break}n=c}return Pi(n||Fn,e)}return Hs}function Yo(i){let e=typeof i;return i===null?"":e==="string"||e==="number"||e==="boolean"?String(i):i instanceof Bi||i instanceof to||i instanceof Ln?i.toString():JSON.stringify(i)}class Lt{constructor(e,n){this.type=e,this.value=n}static parse(e,n){if(e.length!==2)return n.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Yt(e[1]))return n.error("invalid value");let s=e[1],c=gt(s),f=n.expectedType;return c.kind!=="array"||c.N!==0||!f||f.kind!=="array"||typeof f.N=="number"&&f.N!==0||(c=f),new Lt(c,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ln?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Bi?this.value.serialize():this.value}}class Xr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}let Ou={string:Pn,number:It,boolean:On,object:Hs};class Mt{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s,c=1,f=e[0];if(f==="array"){let y,x;if(e.length>2){let w=e[1];if(typeof w!="string"||!(w in Ou)||w==="object")return n.error('The item type argument of "array" must be one of string, number, boolean',1);y=Ou[w],c++}else y=Fn;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return n.error('The length argument to "array" must be a positive integer literal',2);x=e[2],c++}s=Pi(y,x)}else s=Ou[f];let p=[];for(;c<e.length;c++){let y=n.parse(e[c],c,Fn);if(!y)return null;p.push(y)}return new Mt(s,p)}evaluate(e){for(let n=0;n<this.args.length;n++){let s=this.args[n].evaluate(e);if(!ec(this.type,gt(s)))return s;if(n===this.args.length-1)throw new Xr(`The expression ${JSON.stringify(this.args[n].serialize())} evaluated to ${Qr(gt(s))} but was expected to be of type ${Qr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=this.type,n=[e.kind];if(e.kind==="array"){let s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){n.push(s.kind);let c=e.N;(typeof c=="number"||this.args.length>1)&&n.push(c)}}return n.concat(this.args.map(s=>s.serialize()))}}class tc{constructor(e){this.type=Au,this.sections=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s=e[1];if(!Array.isArray(s)&&typeof s=="object")return n.error("First argument must be an image or text section.");let c=[],f=!1;for(let p=1;p<=e.length-1;++p){let y=e[p];if(f&&typeof y=="object"&&!Array.isArray(y)){f=!1;let x=null;if(y["font-scale"]&&(x=n.parseObjectValue(y["font-scale"],p,"font-scale",It),!x))return null;let w=null;if(y["text-font"]&&(w=n.parseObjectValue(y["text-font"],p,"text-font",Pi(Pn)),!w))return null;let I=null;if(y["text-color"]&&(I=n.parseObjectValue(y["text-color"],p,"text-color",po),!I))return null;let S=c[c.length-1];S.scale=x,S.font=w,S.textColor=I}else{let x=n.parse(e[p],p,Fn);if(!x)return null;let w=x.type.kind;if(w!=="string"&&w!=="value"&&w!=="null"&&w!=="resolvedImage")return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");f=!0,c.push({content:x,scale:null,font:null,textColor:null})}}return new tc(c)}evaluate(e){return new Bi(this.sections.map(n=>{let s=n.content.evaluate(e);return rh(gt(s),Mu)?new ih("",s,null,null,null):new ih(Yo(s),null,n.scale?n.scale.evaluate(e):null,n.font?n.font.evaluate(e).join(","):null,n.textColor?n.textColor.evaluate(e):null)}))}eachChild(e){for(let n of this.sections)e(n.content),n.scale&&e(n.scale),n.font&&e(n.font),n.textColor&&e(n.textColor)}outputDefined(){return!1}serialize(){let e=["format"];for(let n of this.sections){e.push(n.content.serialize());let s={};n.scale&&(s["font-scale"]=n.scale.serialize()),n.font&&(s["text-font"]=n.font.serialize()),n.textColor&&(s["text-color"]=n.textColor.serialize()),e.push(s)}return e}}class nc{constructor(e,n,s,c){this._imageWarnHistory={},this.type=Mu,this.namePrimary=e,this.nameSecondary=n,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),c&&(this.paramsSecondary=c.params,this.iconsetIdSecondary=c.iconset?c.iconset.id:void 0)}static parse(e,n){if(e.length<2)return n.error("Expected two or more arguments.");let s=1,c=[];function f(){if(s<e.length){let y=n.parse(e[s],s++,Pn);return y?(c.push({image:y,options:{}}),!0):(n.error(c.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function p(){if(s<e.length){let x=e[s];if((y=x)===null||typeof y!="object"||Array.isArray(y))return!0;let w=x.params,I=x.iconset,S=n.concat(s);if(!w&&!I)return s++,!0;if(w){if(typeof w!="object"||w.constructor!==Object)return S.error('Image options "params" should be an object'),!1;let D={},P=S.concat(void 0,"params");for(let O in w){if(!O)return P.error("Image parameter name should be non-empty"),!1;let N=P.concat(void 0,O).parse(w[O],void 0,po,void 0,{typeAnnotation:"coerce"});if(!N)return!1;D[O]=N}c[c.length-1].options.params=D}if(I){if(typeof I!="object"||I.constructor!==Object)return S.error('Image options "iconset" should be an object'),!1;if(!I.id)return S.error('Image options "iconset" should have an "id" property'),!1;c[c.length-1].options.iconset=I}return s++,!0}var y;return!0}for(let y=0;y<2;y++)if(!f()||!p())return;return new nc(c[0].image,c[1]?c[1].image:void 0,c[0].options,c[1]?c[1].options:void 0)}evaluateParams(e,n){let s={};if(n){for(let c in n)if(n[c])try{s[c]=n[c].evaluate(e)}catch{continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){let n={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,c=to.build(n,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(c&&e.availableImages){let f=c.getPrimary().id;if(c.available=e.availableImages.some(p=>fo.isEqual(p,f)),c.available){let p=c.getSecondary()?c.getSecondary().id:null;p&&(c.available=e.availableImages.some(y=>fo.isEqual(y,p)))}}return c}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(let n in this.paramsPrimary)this.paramsPrimary[n]&&e(this.paramsPrimary[n]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(let n in this.paramsSecondary)this.paramsSecondary[n]&&e(this.paramsSecondary[n])}outputDefined(){return!1}serializeOptions(e,n){let s={};if(n&&(s.iconset={id:n}),e){s.params={};for(let c in e)e[c]&&(s.params[c]=e[c].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){let e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let n=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);n&&e.push(n)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let n=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);n&&e.push(n)}return e}}function va(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}let Y_={"to-boolean":On,"to-color":po,"to-number":It,"to-string":Pn};class Ko{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s=e[0],c=[],f=Ql;if(s==="to-array"){if(!Array.isArray(e[1]))return null;let p=e[1].length;if(n.expectedType){if(n.expectedType.kind!=="array")return n.error(`Expected ${n.expectedType.kind} but found array.`);f=Pi(n.expectedType.itemType,p)}else{if(!(p>0&&Yt(e[1][0])))return null;f=Pi(gt(e[1][0]),p)}for(let y=0;y<p;y++){let x=e[1][y],w;if(va(x)==="array")w=n.parse(x,void 0,f.itemType);else{let I=va(x);if(I!==f.itemType.kind)return n.error(`Expected ${f.itemType.kind} but found ${I}.`);w=n.registry.literal.parse(["literal",x===void 0?null:x],n)}if(!w)return null;c.push(w)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return n.error("Expected one argument.");f=Y_[s];for(let p=1;p<e.length;p++){let y=n.parse(e[p],p,Fn);if(!y)return null;c.push(y)}}return new Ko(f,c)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let n,s;for(let c of this.args){if(n=c.evaluate(e),s=null,n instanceof Ln)return n;if(typeof n=="string"){let f=e.parseColor(n);if(f)return f}else if(Array.isArray(n)&&(s=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:al(n[0],n[1],n[2],n[3]),!s))return new Ln(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Xr(s||`Could not parse color from value '${typeof n=="string"?n:String(JSON.stringify(n))}'`)}if(this.type.kind==="number"){let n=null;for(let s of this.args){if(n=s.evaluate(e),n===null)return 0;let c=Number(n);if(!isNaN(c))return c}throw new Xr(`Could not convert ${JSON.stringify(n)} to number.`)}return this.type.kind==="formatted"?Bi.fromString(Yo(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?to.build(Yo(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(n=>n.evaluate(e)):Yo(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new tc([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new nc(this.args[0]).serialize();let e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{e.push(n.serialize())}),e}}let Vi=["Unknown","Point","LineString","Polygon"];class Lu{constructor(e,n){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=n}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Vi[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let e=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:s,y:c}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*n-e[0])+this.featureDistanceData.bearing[1]*(c*n-e[1])}return 0}parseColor(e){let n=this._parseColorCache[e];return n||(n=this._parseColorCache[e]=Ln.parse(e)),n}getConfig(e){return this.options?this.options.get(e):null}}class fi{constructor(e,n,s,c,f){this.name=e,this.type=n,this._evaluate=s,this.args=c,this._overloadIndex=f}evaluate(e){if(!this._evaluate){let n=fi.definitions[this.name];this._evaluate=Array.isArray(n)?n[2]:n.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,n){let s=e[0],c=fi.definitions[s];if(!c)return n.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);let f=Array.isArray(c)?c[0]:c.type,p=Array.isArray(c)?[[c[1],c[2]]]:c.overloads,y=[],x=null,w=-1;for(let[I,S]of p){if(Array.isArray(I)&&I.length!==e.length-1)continue;y.push(I),w++,x=new _h(n.registry,n.path,null,n.scope,void 0,n._scope,n.options);let D=[],P=!1;for(let O=1;O<e.length;O++){let N=e[O],B=Array.isArray(I)?I[O-1]:I.type,G=x.parse(N,1+D.length,B);if(!G){P=!0;break}D.push(G)}if(!P)if(Array.isArray(I)&&I.length!==D.length)x.error(`Expected ${I.length} arguments, but found ${D.length} instead.`);else{for(let O=0;O<D.length;O++){let N=Array.isArray(I)?I[O]:I.type,B=D[O];x.concat(O+1).checkSubtype(N,B.type)}if(x.errors.length===0)return new fi(s,f,S,D,w)}}if(y.length===1)n.errors.push(...x.errors);else{let I=(y.length?y:p.map(([D])=>D)).map(Ap).join(" | "),S=[];for(let D=1;D<e.length;D++){let P=n.parse(e[D],1+S.length);if(!P)return null;S.push(Qr(P.type))}n.error(`Expected arguments of type ${I}, but found (${S.join(", ")}) instead.`)}return null}static register(e,n){fi.definitions=n;for(let s in n)e[s]=fi}}function Ap(i){return Array.isArray(i)?`(${i.map(Qr).join(", ")})`:`(${Qr(i.type)}...)`}class Ts{constructor(e,n,s){this.type=nh,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=n}static parse(e,n){if(e.length!==2)return n.error("Expected one argument.");let s=e[1];if(typeof s!="object"||Array.isArray(s))return n.error("Collator options argument must be an object.");let c=s["case-sensitive"]===void 0?n.parse(!1,1,On):n.parseObjectValue(s["case-sensitive"],1,"case-sensitive",On);if(!c)return null;let f=s["diacritic-sensitive"]===void 0?n.parse(!1,1,On):n.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",On);if(!f)return null;let p=null;return s.locale&&(p=n.parseObjectValue(s.locale,1,"locale",Pn),!p)?null:new Ts(c,f,p)}evaluate(e){return new Pu(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){let e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Oi(i,e,n=0,s=i.length-1,c=Db){for(;s>n;){if(s-n>600){let x=s-n+1,w=e-n+1,I=Math.log(x),S=.5*Math.exp(2*I/3),D=.5*Math.sqrt(I*S*(x-S)/x)*(w-x/2<0?-1:1);Oi(i,e,Math.max(n,Math.floor(e-w*S/x+D)),Math.min(s,Math.floor(e+(x-w)*S/x+D)),c)}let f=i[e],p=n,y=s;for(Fu(i,n,e),c(i[s],f)>0&&Fu(i,n,s);p<y;){for(Fu(i,p,y),p++,y--;c(i[p],f)<0;)p++;for(;c(i[y],f)>0;)y--}c(i[n],f)===0?Fu(i,n,y):(y++,Fu(i,y,s)),y<=e&&(n=y+1),e<=y&&(s=y-1)}}function Fu(i,e,n){let s=i[e];i[e]=i[n],i[n]=s}function Db(i,e){return i<e?-1:i>e?1:0}function Cb(i){let e=0;for(let n,s,c=0,f=i.length,p=f-1;c<f;p=c++)n=i[c],s=i[p],e+=(s.x-n.x)*(n.y+s.y);return e}function xa(i,e){i[0]=Math.min(i[0],e[0]),i[1]=Math.min(i[1],e[1]),i[2]=Math.max(i[2],e[0]),i[3]=Math.max(i[3],e[1])}function rc(i,e){return!(i[0]<=e[0]||i[2]>=e[2]||i[1]<=e[1]||i[3]>=e[3])}function ll(i,e,n){let s=i[0]-e[0],c=i[1]-e[1],f=i[0]-n[0],p=i[1]-n[1];return s*p-f*c==0&&s*f<=0&&c*p<=0}function ic(i,e,n=!1){let s=!1;for(let y=0,x=e.length;y<x;y++){let w=e[y];for(let I=0,S=w.length,D=S-1;I<S;D=I++){let P=w[D],O=w[I];if(ll(i,P,O))return n;(f=P)[1]>(c=i)[1]!=(p=O)[1]>c[1]&&c[0]<(p[0]-f[0])*(c[1]-f[1])/(p[1]-f[1])+f[0]&&(s=!s)}}var c,f,p;return s}function K_(i,e,n,s){let c=s[0]-n[0],f=s[1]-n[1],p=(i[0]-n[0])*f-c*(i[1]-n[1]),y=(e[0]-n[0])*f-c*(e[1]-n[1]);return p>0&&y<0||p<0&&y>0}function oh(i,e,n,s){return(c=[s[0]-n[0],s[1]-n[1]])[0]*(f=[e[0]-i[0],e[1]-i[1]])[1]-c[1]*f[0]!=0&&!(!K_(i,e,n,s)||!K_(n,s,i,e));var c,f}function Mp(i){let e=new Xe(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=new Xe(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let s of i[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),n.x<s.x&&(n.x=s.x),n.y<s.y&&(n.y=s.y);return{min:e,max:n}}let ba=8192;function Ab(i,e){let n=(180+i[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,c=Math.pow(2,e.z);return[Math.round(n*c*ba),Math.round(s*c*ba)]}function J_(i,e){for(let n=0;n<e.length;n++)if(ic(i,e[n]))return!0;return!1}function Mb(i,e,n){for(let s of n)for(let c=0,f=s.length,p=f-1;c<f;p=c++)if(oh(i,e,s[p],s[c]))return!0;return!1}function Q_(i,e){for(let n=0;n<i.length;++n)if(!ic(i[n],e))return!1;for(let n=0;n<i.length-1;++n)if(Mb(i[n],i[n+1],e))return!1;return!0}function ey(i,e){for(let n=0;n<e.length;n++)if(Q_(i,e[n]))return!0;return!1}function Rp(i,e,n){let s=[];for(let c=0;c<i.length;c++){let f=[];for(let p=0;p<i[c].length;p++){let y=Ab(i[c][p],n);xa(e,y),f.push(y)}s.push(f)}return s}function wa(i,e,n){let s=[];for(let c=0;c<i.length;c++){let f=Rp(i[c],e,n);s.push(f)}return s}function ty(i,e,n,s){if(i[0]<n[0]||i[0]>n[2]){let c=.5*s,f=i[0]-n[0]>c?-s:n[0]-i[0]>c?s:0;f===0&&(f=i[0]-n[2]>c?-s:n[2]-i[0]>c?s:0),i[0]+=f}xa(e,i)}function ny(i,e,n,s){let c=Math.pow(2,s.z)*ba,f=[s.x*ba,s.y*ba],p=[];if(!i)return p;for(let y of i)for(let x of y){let w=[x.x+f[0],x.y+f[1]];ty(w,e,n,c),p.push(w)}return p}function sh(i,e,n,s){let c=Math.pow(2,s.z)*ba,f=[s.x*ba,s.y*ba],p=[];if(!i)return p;for(let x of i){let w=[];for(let I of x){let S=[I.x+f[0],I.y+f[1]];xa(e,S),w.push(S)}p.push(w)}if(e[2]-e[0]<=c/2){(y=e)[0]=y[1]=1/0,y[2]=y[3]=-1/0;for(let x of p)for(let w of x)ty(w,e,n,c)}var y;return p}class Ea{constructor(e,n){this.type=On,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Yt(e[1])){let s=e[1];if(s.type==="FeatureCollection")for(let c=0;c<s.features.length;++c){let f=s.features[c].geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new Ea(s,s.features[c].geometry)}else if(s.type==="Feature"){let c=s.geometry.type;if(c==="Polygon"||c==="MultiPolygon")return new Ea(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new Ea(s,s)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(n,s){let c=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(!p)return!1;if(s.type==="Polygon"){let y=Rp(s.coordinates,f,p),x=ny(n.geometry(),c,f,p);if(!rc(c,f))return!1;for(let w of x)if(!ic(w,y))return!1}if(s.type==="MultiPolygon"){let y=wa(s.coordinates,f,p),x=ny(n.geometry(),c,f,p);if(!rc(c,f))return!1;for(let w of x)if(!J_(w,y))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(n,s){let c=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(!p)return!1;if(s.type==="Polygon"){let y=Rp(s.coordinates,f,p),x=sh(n.geometry(),c,f,p);if(!rc(c,f))return!1;for(let w of x)if(!Q_(w,y))return!1}if(s.type==="MultiPolygon"){let y=wa(s.coordinates,f,p),x=sh(n.geometry(),c,f,p);if(!rc(c,f))return!1;for(let w of x)if(!ey(w,y))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let ku={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Jo=1/298.257223563,Pp=Jo*(2-Jo),oc=Math.PI/180;class sc{static fromTile(e,n,s){let c=Math.PI*(1-2*(e+.5)/Math.pow(2,n)),f=Math.atan(.5*(Math.exp(c)-Math.exp(-c)))/oc;return new sc(f,s)}static get units(){return ku}constructor(e,n){if(e===void 0)throw new Error("No latitude given.");if(n&&!ku[n])throw new Error(`Unknown unit ${n}. Use one of: ${Object.keys(ku).join(", ")}`);let s=6378.137*oc*(n?ku[n]:1),c=Math.cos(e*oc),f=1/(1-Pp*(1-c*c)),p=Math.sqrt(f);this.kx=s*p*c,this.ky=s*p*f*(1-Pp)}distance(e,n){let s=Mo(e[0]-n[0])*this.kx,c=(e[1]-n[1])*this.ky;return Math.sqrt(s*s+c*c)}bearing(e,n){let s=Mo(n[0]-e[0])*this.kx;return Math.atan2(s,(n[1]-e[1])*this.ky)/oc}destination(e,n,s){let c=s*oc;return this.offset(e,Math.sin(c)*n,Math.cos(c)*n)}offset(e,n,s){return[e[0]+n/this.kx,e[1]+s/this.ky]}lineDistance(e){let n=0;for(let s=0;s<e.length-1;s++)n+=this.distance(e[s],e[s+1]);return n}area(e){let n=0;for(let s=0;s<e.length;s++){let c=e[s];for(let f=0,p=c.length,y=p-1;f<p;y=f++)n+=Mo(c[f][0]-c[y][0])*(c[f][1]+c[y][1])*(s?-1:1)}return Math.abs(n)/2*this.kx*this.ky}along(e,n){let s=0;if(n<=0)return e[0];for(let c=0;c<e.length-1;c++){let f=e[c],p=e[c+1],y=this.distance(f,p);if(s+=y,s>n)return ah(f,p,(n-(s-y))/y)}return e[e.length-1]}pointToSegmentDistance(e,n,s){let[c,f]=n,p=Mo(s[0]-c)*this.kx,y=(s[1]-f)*this.ky;if(p!==0||y!==0){let x=(Mo(e[0]-c)*this.kx*p+(e[1]-f)*this.ky*y)/(p*p+y*y);x>1?(c=s[0],f=s[1]):x>0&&(c+=p/this.kx*x,f+=y/this.ky*x)}return p=Mo(e[0]-c)*this.kx,y=(e[1]-f)*this.ky,Math.sqrt(p*p+y*y)}pointOnLine(e,n){let s=1/0,c=e[0][0],f=e[0][1],p=0,y=0;for(let x=0;x<e.length-1;x++){let w=e[x][0],I=e[x][1],S=Mo(e[x+1][0]-w)*this.kx,D=(e[x+1][1]-I)*this.ky,P=0;S===0&&D===0||(P=(Mo(n[0]-w)*this.kx*S+(n[1]-I)*this.ky*D)/(S*S+D*D),P>1?(w=e[x+1][0],I=e[x+1][1]):P>0&&(w+=S/this.kx*P,I+=D/this.ky*P)),S=Mo(n[0]-w)*this.kx,D=(n[1]-I)*this.ky;let O=S*S+D*D;O<s&&(s=O,c=w,f=I,p=x,y=P)}return{point:[c,f],index:p,t:Math.max(0,Math.min(1,y))}}lineSlice(e,n,s){let c=this.pointOnLine(s,e),f=this.pointOnLine(s,n);if(c.index>f.index||c.index===f.index&&c.t>f.t){let w=c;c=f,f=w}let p=[c.point],y=c.index+1,x=f.index;!Op(s[y],p[0])&&y<=x&&p.push(s[y]);for(let w=y+1;w<=x;w++)p.push(s[w]);return Op(s[x],f.point)||p.push(f.point),p}lineSliceAlong(e,n,s){let c=0,f=[];for(let p=0;p<s.length-1;p++){let y=s[p],x=s[p+1],w=this.distance(y,x);if(c+=w,c>e&&f.length===0&&f.push(ah(y,x,(e-(c-w))/w)),c>=n)return f.push(ah(y,x,(n-(c-w))/w)),f;c>e&&f.push(x)}return f}bufferPoint(e,n){let s=n/this.ky,c=n/this.kx;return[e[0]-c,e[1]-s,e[0]+c,e[1]+s]}bufferBBox(e,n){let s=n/this.ky,c=n/this.kx;return[e[0]-c,e[1]-s,e[2]+c,e[3]+s]}insideBBox(e,n){return Mo(e[0]-n[0])>=0&&Mo(e[0]-n[2])<=0&&e[1]>=n[1]&&e[1]<=n[3]}}function Op(i,e){return i[0]===e[0]&&i[1]===e[1]}function ah(i,e,n){let s=Mo(e[0]-i[0]);return[i[0]+s*n,i[1]+(e[1]-i[1])*n]}function Mo(i){for(;i<-180;)i+=360;for(;i>180;)i-=360;return i}class lh{constructor(e=[],n=(s,c)=>s<c?-1:s>c?1:0){if(this.data=e,this.length=this.data.length,this.compare=n,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;let e=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),e}peek(){return this.data[0]}_up(e){let{data:n,compare:s}=this,c=n[e];for(;e>0;){let f=e-1>>1,p=n[f];if(s(c,p)>=0)break;n[e]=p,e=f}n[e]=c}_down(e){let{data:n,compare:s}=this,c=this.length>>1,f=n[e];for(;e<c;){let p=1+(e<<1),y=p+1;if(y<this.length&&s(n[y],n[p])<0&&(p=y),s(n[p],f)>=0)break;n[e]=n[p],e=p}n[e]=f}}var st=8192;function Lp(i,e){return e.dist-i.dist}let ch=100,uh=50;function Nu(i){let e=[1/0,1/0,-1/0,-1/0];if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==i[n])return!1;return!0}function cl(i){return i[1]-i[0]+1}function Qo(i,e){let n=i[1]>=i[0]&&i[1]<e;return n||console.warn("Distance Expression: Index is out of range"),n}function dh(i,e){if(i[0]>i[1])return[null,null];let n=cl(i);if(e){if(n===2)return[i,null];let s=Math.floor(n/2);return[[i[0],i[0]+s],[i[0]+s,i[1]]]}{if(n===1)return[i,null];let s=Math.floor(n/2)-1;return[[i[0],i[0]+s],[i[0]+s+1,i[1]]]}}function Ta(i,e){let n=[1/0,1/0,-1/0,-1/0];if(!Qo(e,i.length))return n;for(let s=e[0];s<=e[1];++s)xa(n,i[s]);return n}function zu(i){let e=[1/0,1/0,-1/0,-1/0];for(let n=0;n<i.length;++n)for(let s=0;s<i[n].length;++s)xa(e,i[n][s]);return e}function ds(i,e,n){if(Nu(i)||Nu(e))return NaN;let s=0,c=0;return i[2]<e[0]&&(s=e[0]-i[2]),i[0]>e[2]&&(s=i[0]-e[2]),i[1]>e[3]&&(c=i[1]-e[3]),i[3]<e[1]&&(c=e[1]-i[3]),n.distance([0,0],[s,c])}function mn(i){return 360*i-180}function Rb(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}function Fp(i,e){let n=Math.pow(2,e.z),s=(i.y/st+e.y)/n;return[mn((i.x/st+e.x)/n),Rb(s)]}function Pb(i,e){let n=[];for(let s=0;s<i.length;++s)n.push(Fp(i[s],e));return n}function kp(i,e,n){let s=n.pointOnLine(e,i).point;return n.distance(i,s)}function ry(i,e,n,s,c){let f=n.slice(s[0],s[1]+1),p=1/0;for(let y=e[0];y<=e[1];++y)if((p=Math.min(p,kp(i[y],f,c)))===0)return 0;return p}function fr(i,e,n,s,c){let f=Math.min(c.pointToSegmentDistance(i,n,s),c.pointToSegmentDistance(e,n,s)),p=Math.min(c.pointToSegmentDistance(n,i,e),c.pointToSegmentDistance(s,i,e));return Math.min(f,p)}function Ob(i,e,n,s,c){if(!Qo(e,i.length)||!Qo(s,n.length))return NaN;let f=1/0;for(let p=e[0];p<e[1];++p)for(let y=s[0];y<s[1];++y){if(oh(i[p],i[p+1],n[y],n[y+1]))return 0;f=Math.min(f,fr(i[p],i[p+1],n[y],n[y+1],c))}return f}function Lb(i,e,n,s,c){if(!Qo(e,i.length)||!Qo(s,n.length))return NaN;let f=1/0;for(let p=e[0];p<=e[1];++p)for(let y=s[0];y<=s[1];++y)if((f=Math.min(f,c.distance(i[p],n[y])))===0)return f;return f}function Fb(i,e,n){if(ic(i,e,!0))return 0;let s=1/0;for(let c of e){let f=c.length;if(f<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(c[0]!==c[f-1]&&(s=Math.min(s,n.pointToSegmentDistance(i,c[f-1],c[0])))===0||(s=Math.min(s,kp(i,c,n)))===0)return s}return s}function kb(i,e,n,s){if(!Qo(e,i.length))return NaN;for(let f=e[0];f<=e[1];++f)if(ic(i[f],n,!0))return 0;let c=1/0;for(let f=e[0];f<e[1];++f)for(let p of n)for(let y=0,x=p.length,w=x-1;y<x;w=y++){if(oh(i[f],i[f+1],p[w],p[y]))return 0;c=Math.min(c,fr(i[f],i[f+1],p[w],p[y],s))}return c}function iy(i,e){for(let n of i)for(let s=0;s<=n.length-1;++s)if(ic(n[s],e,!0))return!0;return!1}function Nb(i,e,n,s=1/0){let c=zu(i),f=zu(e);if(s!==1/0&&ds(c,f,n)>=s)return s;if(rc(c,f)){if(iy(i,e))return 0}else if(iy(e,i))return 0;let p=s;for(let y of i)for(let x=0,w=y.length,I=w-1;x<w;I=x++)for(let S of e)for(let D=0,P=S.length,O=P-1;D<P;O=D++){if(oh(y[I],y[x],S[O],S[D]))return 0;p=Math.min(p,fr(y[I],y[x],S[O],S[D],n))}return p}function hh(i,e,n,s,c,f,p){if(f===null||p===null)return;let y=ds(Ta(s,f),Ta(c,p),n);y<e&&i.push({dist:y,range1:f,range2:p})}function zb(i,e,n,s,c=1/0){let f=Math.min(s.distance(i[0],n[0][0]),c);if(f===0)return f;let p=new lh([{dist:0,range1:[0,i.length-1],range2:[0,0]}],Lp),y=e?uh:ch,x=zu(n);for(;p.length;){let w=p.pop();if(w.dist>=f)continue;let I=w.range1;if(cl(I)<=y){if(!Qo(I,i.length))return NaN;if(e){let S=kb(i,I,n,s);if((f=Math.min(f,S))===0)return f}else for(let S=I[0];S<=I[1];++S){let D=Fb(i[S],n,s);if((f=Math.min(f,D))===0)return f}}else{let S=dh(I,e);if(S[0]!==null){let D=ds(Ta(i,S[0]),x,s);D<f&&p.push({dist:D,range1:S[0],range2:[0,0]})}if(S[1]!==null){let D=ds(Ta(i,S[1]),x,s);D<f&&p.push({dist:D,range1:S[1],range2:[0,0]})}}}return f}function oy(i,e,n,s,c,f=1/0){let p=Math.min(f,c.distance(i[0],n[0]));if(p===0)return p;let y=new lh([{dist:0,range1:[0,i.length-1],range2:[0,n.length-1]}],Lp),x=e?uh:ch,w=s?uh:ch;for(;y.length;){let I=y.pop();if(I.dist>=p)continue;let S=I.range1,D=I.range2;if(cl(S)<=x&&cl(D)<=w){if(!Qo(S,i.length)||!Qo(D,n.length))return NaN;if(e&&s?p=Math.min(p,Ob(i,S,n,D,c)):e||s?e&&!s?p=Math.min(p,ry(n,D,i,S,c)):!e&&s&&(p=Math.min(p,ry(i,S,n,D,c))):p=Math.min(p,Lb(i,S,n,D,c)),p===0)return p}else{let P=dh(S,e),O=dh(D,s);hh(y,p,c,i,n,P[0],O[0]),hh(y,p,c,i,n,P[0],O[1]),hh(y,p,c,i,n,P[1],O[0]),hh(y,p,c,i,n,P[1],O[1])}}return p}function Np(i,e,n,s,c=1/0){let f=c,p=Ta(i,[0,i.length-1]);for(let y of n)if(!(f!==1/0&&ds(p,Ta(y,[0,y.length-1]),s)>=f)&&(f=Math.min(f,oy(i,e,y,!0,s,f)),f===0))return f;return f}function fh(i,e,n,s,c=1/0){let f=c,p=Ta(i,[0,i.length-1]);for(let y of n){if(f!==1/0&&ds(p,zu(y),s)>=f)continue;let x=zb(i,e,y,s,f);if(isNaN(x))return x;if((f=Math.min(f,x))===0)return f}return f}function zp(i){return i==="Point"||i==="MultiPoint"||i==="LineString"||i==="MultiLineString"||i==="Polygon"||i==="MultiPolygon"}class ul{constructor(e,n){this.type=It,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(Yt(e[1])){let s=e[1];if(s.type==="FeatureCollection"){for(let c=0;c<s.features.length;++c)if(zp(s.features[c].geometry.type))return new ul(s,s.features[c].geometry)}else if(s.type==="Feature"){if(zp(s.geometry.type))return new ul(s,s.geometry)}else if(zp(s.type))return new ul(s,s)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){let n=e.geometry(),s=e.canonicalID();if(n!=null&&s!=null){if(e.geometryType()==="Point")return function(c,f,p){let y=[];for(let w of c)for(let I of w)y.push(Fp(I,f));let x=new sc(y[0][1],"meters");return p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString"?oy(y,!1,p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",x):p.type==="MultiLineString"?Np(y,!1,p.coordinates,x):p.type==="Polygon"||p.type==="MultiPolygon"?fh(y,!1,p.type==="Polygon"?[p.coordinates]:p.coordinates,x):null}(n,s,this.geometries);if(e.geometryType()==="LineString")return function(c,f,p){let y=[];for(let w of c){let I=[];for(let S of w)I.push(Fp(S,f));y.push(I)}let x=new sc(y[0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return Np(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,x);if(p.type==="MultiLineString"){let w=1/0;for(let I=0;I<p.coordinates.length;I++){let S=Np(p.coordinates[I],!0,y,x,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}if(p.type==="Polygon"||p.type==="MultiPolygon"){let w=1/0;for(let I=0;I<y.length;I++){let S=fh(y[I],!0,p.type==="Polygon"?[p.coordinates]:p.coordinates,x,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}return null}(n,s,this.geometries);if(e.geometryType()==="Polygon")return function(c,f,p){let y=[];for(let w of function(I,S){let D=I.length;if(D<=1)return[I];let P=[],O,N;for(let B=0;B<D;B++){let G=Cb(I[B]);G!==0&&(I[B].area=Math.abs(G),N===void 0&&(N=G<0),N===G<0?(O&&P.push(O),O=[I[B]]):O.push(I[B]))}return O&&P.push(O),P}(c)){let I=[];for(let S=0;S<w.length;++S)I.push(Pb(w[S],f));y.push(I)}let x=new sc(y[0][0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return fh(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,x);if(p.type==="MultiLineString"){let w=1/0;for(let I=0;I<p.coordinates.length;I++){let S=fh(p.coordinates[I],!0,y,x,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}return p.type==="Polygon"||p.type==="MultiPolygon"?function(w,I,S){let D=1/0;for(let P of w)for(let O of I){let N=Nb(P,O,S,D);if(isNaN(N))return N;if((D=Math.min(D,N))===0)return D}return D}(p.type==="Polygon"?[p.coordinates]:p.coordinates,y,x):null}(n,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function ac(i){if(i instanceof fi&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof Ea||i instanceof ul)return!1;if(i instanceof cc)return i.featureConstant;let e=!0;return i.eachChild(n=>{e&&!ac(n)&&(e=!1)}),e}function ph(i){if(i instanceof fi&&i.name==="feature-state")return!1;let e=!0;return i.eachChild(n=>{e&&!ph(n)&&(e=!1)}),e}function mh(i){if(i instanceof cc)return new Set([i.key]);let e=new Set;return i.eachChild(n=>{e=new Set([...e,...mh(n)])}),e}function lc(i,e){if(i instanceof fi&&e.indexOf(i.name)>=0)return!1;let n=!0;return i.eachChild(s=>{n&&!lc(s,e)&&(n=!1)}),n}function sy(i,e,n){return[i,e,n].filter(Boolean).join("")}function Bp(i,e){switch(i){case"string":return Yo(e);case"number":return+e;case"boolean":return!!e;case"color":return Ln.parse(e);case"formatted":return Bi.fromString(Yo(e));case"resolvedImage":return to.build(Yo(e))}return e}function ay(i,e,n,s){return s!==void 0&&(i=s*Math.round(i/s)),e!==void 0&&i<e&&(i=e),n!==void 0&&i>n&&(i=n),i}class cc{constructor(e,n,s,c=!1){this.type=e,this.key=n,this.scope=s,this.featureConstant=c}static parse(e,n){let s=n.expectedType;if(s==null&&(s=Fn),e.length<2||e.length>3)return n.error("Invalid number of arguments for 'config' expression.");let c=n.parse(e[1],1);if(!(c instanceof Lt))return n.error("Key name of 'config' expression must be a string literal.");let f,p=!0,y=Yo(c.value);if(e.length>=3){let x=n.parse(e[2],2);if(!(x instanceof Lt))return n.error("Scope of 'config' expression must be a string literal.");f=Yo(x.value)}if(n.options){let x=sy(y,f,n._scope),w=n.options.get(x);w&&(p=ac(w.value||w.default))}return new cc(s,y,f,p)}evaluate(e){let n=sy(this.key,this.scope,e.scope),s=e.getConfig(n);if(!s)return null;let{type:c,value:f,values:p,minValue:y,maxValue:x,stepValue:w}=s,I=s.default.evaluate(e),S=I;if(f){let D=e.scope;e.scope=(D||"").split("").slice(1).join(""),S=f.evaluate(e),e.scope=D}return c&&(S=Bp(c,S)),S===void 0||y===void 0&&x===void 0&&w===void 0||(typeof S=="number"?S=ay(S,y,x,w):Array.isArray(S)&&(S=S.map(D=>typeof D=="number"?ay(D,y,x,w):D))),f!==void 0&&S!==void 0&&p&&!p.includes(S)&&(S=I,c&&(S=Bp(c,S))),(c&&c!==this.type||S!==void 0&&!rh(gt(S),this.type))&&(S=Bp(this.type.kind,S)),S}eachChild(){}outputDefined(){return!1}serialize(){let e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class gh{constructor(e,n){this.type=n.type,this.name=e,this.boundExpression=n}static parse(e,n){if(e.length!==2||typeof e[1]!="string")return n.error("'var' expression requires exactly one string literal argument.");let s=e[1];return n.scope.has(s)?new gh(s,n.scope.get(s)):n.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class _h{constructor(e,n=[],s,c=new Cp,f=[],p,y){this.registry=e,this.path=n,this.key=n.map(x=>typeof x=="string"?`['${x}']`:`[${x}]`).join(""),this.scope=c,this.errors=f,this.expectedType=s,this._scope=p,this.options=y}parse(e,n,s,c,f={}){return n||s?this.concat(n,null,s,c)._parse(e,f):this._parse(e,f)}parseObjectValue(e,n,s,c,f,p={}){return this.concat(n,s,c,f)._parse(e,p)}_parse(e,n){function s(c,f,p){return p==="assert"?new Mt(f,[c]):p==="coerce"?new Ko(f,[c]):c}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let c=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(c){let f=c.parse(e,this);if(!f)return null;if(this.expectedType){let p=this.expectedType,y=f.type;if(p.kind!=="string"&&p.kind!=="number"&&p.kind!=="boolean"&&p.kind!=="object"&&p.kind!=="array"||y.kind!=="value")if(p.kind!=="color"&&p.kind!=="formatted"&&p.kind!=="resolvedImage"||y.kind!=="value"&&y.kind!=="string"){if(this.checkSubtype(p,y))return null}else f=s(f,p,n.typeAnnotation||"coerce");else f=s(f,p,n.typeAnnotation||"assert")}if(!(f instanceof Lt)&&f.type.kind!=="resolvedImage"&&Vp(f)){let p=new Lu(this._scope,this.options);try{f=new Lt(f.type,f.evaluate(p))}catch(y){return this.error(y.message),null}}return f}return Ko.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,n,s,c){let f=typeof e=="number"?this.path.concat(e):this.path;f=typeof n=="string"?f.concat(n):f;let p=c?this.scope.concat(c):this.scope;return new _h(this.registry,f,s||null,p,this.errors,this._scope,this.options)}error(e,...n){let s=`${this.key}${n.map(c=>`[${c}]`).join("")}`;this.errors.push(new Ao(s,e))}checkSubtype(e,n){let s=ec(e,n);return s&&this.error(s),s}}function Vp(i){if(i instanceof gh)return Vp(i.boundExpression);if(i instanceof fi&&i.name==="error"||i instanceof Ts||i instanceof Ea||i instanceof ul||i instanceof cc)return!1;let e=i instanceof Ko||i instanceof Mt,n=!0;return i.eachChild(s=>{n=e?n&&Vp(s):n&&s instanceof Lt}),!!n&&ac(i)&&lc(i,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function yh(i,e){let n=i.length-1,s,c,f=0,p=n,y=0;for(;f<=p;)if(y=Math.floor((f+p)/2),s=i[y],c=i[y+1],s<=e){if(y===n||e<c)return y;f=y+1}else{if(!(s>e))throw new Xr("Input is not a number.");p=y-1}return 0}class Bu{constructor(e,n,s){this.type=e,this.input=n,this.labels=[],this.outputs=[];for(let[c,f]of s)this.labels.push(c),this.outputs.push(f)}static parse(e,n){if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");let s=n.parse(e[1],1,It);if(!s)return null;let c=[],f=null;n.expectedType&&n.expectedType.kind!=="value"&&(f=n.expectedType);for(let p=1;p<e.length;p+=2){let y=p===1?-1/0:e[p],x=e[p+1],w=p,I=p+1;if(typeof y!="number")return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(c.length&&c[c.length-1][0]>=y)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',w);let S=n.parse(x,I,f);if(!S)return null;f=f||S.type,c.push([y,S])}return new Bu(f,s,c)}evaluate(e){let n=this.labels,s=this.outputs;if(n.length===1)return s[0].evaluate(e);let c=this.input.evaluate(e);if(c<=n[0])return s[0].evaluate(e);let f=n.length;return c>=n[f-1]?s[f-1].evaluate(e):s[yh(n,c)].evaluate(e)}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&e.push(this.labels[n]),e.push(this.outputs[n].serialize());return e}}let ly=.95047,cy=1.08883,uy=4/29,uc=6/29,dy=3*uc*uc,Up=uc*uc*uc,Bb=Math.PI/180,hy=180/Math.PI;function jp(i){return i>Up?Math.pow(i,1/3):i/dy+uy}function Hp(i){return i>uc?i*i*i:dy*(i-uy)}function Gp(i){return 255*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055)}function vh(i){return(i/=255)<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function $p(i){let e=vh(i.r),n=vh(i.g),s=vh(i.b),c=jp((.4124564*e+.3575761*n+.1804375*s)/ly),f=jp((.2126729*e+.7151522*n+.072175*s)/1);return{l:116*f-16,a:500*(c-f),b:200*(f-jp((.0193339*e+.119192*n+.9503041*s)/cy)),alpha:i.a}}function dl(i){let e=(i.l+16)/116,n=isNaN(i.a)?e:e+i.a/500,s=isNaN(i.b)?e:e-i.b/200;return e=1*Hp(e),n=ly*Hp(n),s=cy*Hp(s),new Ln(Gp(3.2404542*n-1.5371385*e-.4985314*s),Gp(-.969266*n+1.8760108*e+.041556*s),Gp(.0556434*n-.2040259*e+1.0572252*s),i.alpha)}function fy(i,e,n){let s=e-i;return i+n*(s>180||s<-180?s-360*Math.round(s/360):s)}let dc={forward:$p,reverse:dl,interpolate:function(i,e,n){return{l:At(i.l,e.l,n),a:At(i.a,e.a,n),b:At(i.b,e.b,n),alpha:At(i.alpha,e.alpha,n)}}},Vu={forward:function(i){let{l:e,a:n,b:s}=$p(i),c=Math.atan2(s,n)*hy;return{h:c<0?c+360:c,c:Math.sqrt(n*n+s*s),l:e,alpha:i.a}},reverse:function(i){let e=i.h*Bb,n=i.c;return dl({l:i.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:i.alpha})},interpolate:function(i,e,n){return{h:fy(i.h,e.h,n),c:At(i.c,e.c,n),l:At(i.l,e.l,n),alpha:At(i.alpha,e.alpha,n)}}};var xh=Object.freeze({__proto__:null,hcl:Vu,lab:dc});class no{constructor(e,n,s,c,f){this.type=e,this.operator=n,this.interpolation=s,this.input=c,this.labels=[],this.outputs=[];for(let[p,y]of f)this.labels.push(p),this.outputs.push(y)}static interpolationFactor(e,n,s,c){let f=0;if(e.name==="exponential")f=Wp(n,e.base,s,c);else if(e.name==="linear")f=Wp(n,1,s,c);else if(e.name==="cubic-bezier"){let p=e.controlPoints;f=new Wl(p[0],p[1],p[2],p[3]).solve(Wp(n,1,s,c))}return f}static parse(e,n){let[s,c,f,...p]=e;if(!Array.isArray(c)||c.length===0)return n.error("Expected an interpolation type expression.",1);if(c[0]==="linear")c={name:"linear"};else if(c[0]==="exponential"){let w=c[1];if(typeof w!="number")return n.error("Exponential interpolation requires a numeric base.",1,1);c={name:"exponential",base:w}}else{if(c[0]!=="cubic-bezier")return n.error(`Unknown interpolation type ${String(c[0])}`,1,0);{let w=c.slice(1);if(w.length!==4||w.some(I=>typeof I!="number"||I<0||I>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);c={name:"cubic-bezier",controlPoints:w}}}if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(f=n.parse(f,2,It),!f)return null;let y=[],x=null;s==="interpolate-hcl"||s==="interpolate-lab"?x=po:n.expectedType&&n.expectedType.kind!=="value"&&(x=n.expectedType);for(let w=0;w<p.length;w+=2){let I=p[w],S=p[w+1],D=w+3,P=w+4;if(typeof I!="number")return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',D);if(y.length&&y[y.length-1][0]>=I)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',D);let O=n.parse(S,P,x);if(!O)return null;x=x||O.type,y.push([I,O])}return x.kind==="number"||x.kind==="color"||x.kind==="array"&&x.itemType.kind==="number"&&typeof x.N=="number"?new no(x,s,c,f,y):n.error(`Type ${Qr(x)} is not interpolatable.`)}evaluate(e){let n=this.labels,s=this.outputs;if(n.length===1)return s[0].evaluate(e);let c=this.input.evaluate(e);if(c<=n[0])return s[0].evaluate(e);let f=n.length;if(c>=n[f-1])return s[f-1].evaluate(e);let p=yh(n,c),y=no.interpolationFactor(this.interpolation,c,n[p],n[p+1]),x=s[p].evaluate(e),w=s[p+1].evaluate(e);return this.operator==="interpolate"?Cu[this.type.kind.toLowerCase()](x,w,y):this.operator==="interpolate-hcl"?Vu.reverse(Vu.interpolate(Vu.forward(x),Vu.forward(w),y)):dc.reverse(dc.interpolate(dc.forward(x),dc.forward(w),y))}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let n=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)n.push(this.labels[s],this.outputs[s].serialize());return n}}function Wp(i,e,n,s){let c=s-n,f=i-n;return c===0?0:e===1?f/c:(Math.pow(e,f)-1)/(Math.pow(e,c)-1)}class bh{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expectected at least one argument.");let s=null,c=n.expectedType;c&&c.kind!=="value"&&(s=c);let f=[];for(let y of e.slice(1)){let x=n.parse(y,1+f.length,s,void 0,{typeAnnotation:"omit"});if(!x)return null;s=s||x.type,f.push(x)}let p=c&&f.some(y=>ec(c,y.type));return new bh(p?Fn:s,f)}evaluate(e){let n,s=null,c=0;for(let f of this.args){if(c++,s=f.evaluate(e),s&&s instanceof to&&!s.available&&(n||(n=s),s=null,c===this.args.length))return n;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=["coalesce"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class Uu{constructor(e,n){this.type=n.type,this.bindings=[].concat(e),this.result=n}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(let n of this.bindings)e(n[1]);e(this.result)}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);let s=[];for(let f=1;f<e.length-1;f+=2){let p=e[f];if(typeof p!="string")return n.error(`Expected string, but found ${typeof p} instead.`,f);if(/[^a-zA-Z0-9_]/.test(p))return n.error("Variable names must contain only alphanumeric characters or '_'.",f);let y=n.parse(e[f+1],f+1);if(!y)return null;s.push([p,y])}let c=n.parse(e[e.length-1],e.length-1,n.expectedType,s);return c?new Uu(s,c):null}outputDefined(){return this.result.outputDefined()}serialize(){let e=["let"];for(let[n,s]of this.bindings)e.push(n,s.serialize());return e.push(this.result.serialize()),e}}class wh{constructor(e,n,s){this.type=e,this.index=n,this.input=s}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,It),c=n.parse(e[2],2,Pi(n.expectedType||Fn));return s&&c?new wh(c.type.itemType,s,c):null}evaluate(e){let n=this.index.evaluate(e),s=this.input.evaluate(e);if(n<0)throw new Xr(`Array index out of bounds: ${n} < 0.`);if(n>=s.length)throw new Xr(`Array index out of bounds: ${n} > ${s.length-1}.`);if(n!==Math.floor(n))throw new Xr(`Array index must be an integer, but found ${n} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return s[n]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Zp{constructor(e,n,s){this.type=e,this.index=n,this.input=s}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,It),c=n.parse(e[2],2,Pi(n.expectedType||Fn));return s&&c?new Zp(c.type.itemType,s,c):null}evaluate(e){let n=this.index.evaluate(e),s=this.input.evaluate(e);if(n<0)throw new Xr(`Array index out of bounds: ${n} < 0.`);if(n>s.length-1)throw new Xr(`Array index out of bounds: ${n} > ${s.length-1}.`);if(n===Math.floor(n))return s[n];let c=Math.floor(n),f=Math.ceil(n),p=s[c],y=s[f];if(typeof p!="number"||typeof y!="number")throw new Xr(`Cannot interpolate between non-number values at index ${n}.`);let x=n-c;return p*(1-x)+y*x}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class qp{constructor(e,n){this.type=On,this.needle=e,this.haystack=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Fn),c=n.parse(e[2],2,Fn);return s&&c?ya(s.type,[On,Pn,It,Ql,Fn])?new qp(s,c):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Qr(s.type)} instead`):null}evaluate(e){let n=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!Ru(n,["boolean","string","number","null"]))throw new Xr(`Expected first argument to be of type boolean, string, number or null, but found ${Qr(gt(n))} instead.`);if(!Ru(s,["string","array"]))throw new Xr(`Expected second argument to be of type array or string, but found ${Qr(gt(s))} instead.`);return s.indexOf(n)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Eh{constructor(e,n,s){this.type=It,this.needle=e,this.haystack=n,this.fromIndex=s}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Fn),c=n.parse(e[2],2,Fn);if(!s||!c)return null;if(!ya(s.type,[On,Pn,It,Ql,Fn]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Qr(s.type)} instead`);if(e.length===4){let f=n.parse(e[3],3,It);return f?new Eh(s,c,f):null}return new Eh(s,c)}evaluate(e){let n=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Ru(n,["boolean","string","number","null"]))throw new Xr(`Expected first argument to be of type boolean, string, number or null, but found ${Qr(gt(n))} instead.`);if(!Ru(s,["string","array"]))throw new Xr(`Expected second argument to be of type array or string, but found ${Qr(gt(s))} instead.`);if(this.fromIndex){let c=this.fromIndex.evaluate(e);return s.indexOf(n,c)}return s.indexOf(n)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Th{constructor(e,n,s,c,f,p){this.inputType=e,this.type=n,this.input=s,this.cases=c,this.outputs=f,this.otherwise=p}static parse(e,n){if(e.length<5)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return n.error("Expected an even number of arguments.");let s,c;n.expectedType&&n.expectedType.kind!=="value"&&(c=n.expectedType);let f={},p=[];for(let w=2;w<e.length-1;w+=2){let I=e[w],S=e[w+1];Array.isArray(I)||(I=[I]);let D=n.concat(w);if(I.length===0)return D.error("Expected at least one branch label.");for(let O of I){if(typeof O!="number"&&typeof O!="string")return D.error("Branch labels must be numbers or strings.");if(typeof O=="number"&&Math.abs(O)>Number.MAX_SAFE_INTEGER)return D.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof O=="number"&&Math.floor(O)!==O)return D.error("Numeric branch labels must be integer values.");if(s){if(D.checkSubtype(s,gt(O)))return null}else s=gt(O);if(f[String(O)]!==void 0)return D.error("Branch labels must be unique.");f[String(O)]=p.length}let P=n.parse(S,w,c);if(!P)return null;c=c||P.type,p.push(P)}let y=n.parse(e[1],1,Fn);if(!y)return null;let x=n.parse(e[e.length-1],e.length-1,c);return x?y.type.kind!=="value"&&n.concat(1).checkSubtype(s,y.type)?null:new Th(s,c,y,f,p,x):null}evaluate(e){let n=this.input.evaluate(e);return(rh(gt(n),this.inputType)&&this.outputs[this.cases[n]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),s=[],c={};for(let p of n){let y=c[this.cases[p]];y===void 0?(c[this.cases[p]]=s.length,s.push([this.cases[p],[p]])):s[y][1].push(p)}let f=p=>this.inputType.kind==="number"?Number(p):p;for(let[p,y]of s)e.push(y.length===1?f(y[0]):y.map(f)),e.push(this.outputs[p].serialize());return e.push(this.otherwise.serialize()),e}}class Ih{constructor(e,n,s){this.type=e,this.branches=n,this.otherwise=s}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return n.error("Expected an odd number of arguments.");let s;n.expectedType&&n.expectedType.kind!=="value"&&(s=n.expectedType);let c=[];for(let p=1;p<e.length-1;p+=2){let y=n.parse(e[p],p,On);if(!y)return null;let x=n.parse(e[p+1],p+1,s);if(!x)return null;c.push([y,x]),s=s||x.type}let f=n.parse(e[e.length-1],e.length-1,s);return f?new Ih(s,c,f):null}evaluate(e){for(let[n,s]of this.branches)if(n.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(let[n,s]of this.branches)e(n),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["case"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class hl{constructor(e,n,s,c){this.type=e,this.input=n,this.beginIndex=s,this.endIndex=c}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Fn),c=n.parse(e[2],2,It);if(!s||!c)return null;if(!ya(s.type,[Pi(Fn),Pn,Fn]))return n.error(`Expected first argument to be of type array or string, but found ${Qr(s.type)} instead`);if(e.length===4){let f=n.parse(e[3],3,It);return f?new hl(s.type,s,c,f):null}return new hl(s.type,s,c)}evaluate(e){let n=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Ru(n,["string","array"]))throw new Xr(`Expected first argument to be of type array or string, but found ${Qr(gt(n))} instead.`);if(this.endIndex){let c=this.endIndex.evaluate(e);return n.slice(s,c)}return n.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class Xp{constructor(e,n){this.type=Pi(Pn),this.str=e,this.delimiter=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Pn),c=n.parse(e[2],2,Pn);return s&&c?new Xp(s,c):void 0}evaluate(e){let n=this.str.evaluate(e),s=this.delimiter.evaluate(e);return n.split(s)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Yp(i,e){return i==="=="||i==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function py(i,e,n,s){return s.compare(e,n)===0}function hc(i,e,n){let s=i!=="=="&&i!=="!=";return class tL{constructor(f,p,y){this.type=On,this.lhs=f,this.rhs=p,this.collator=y,this.hasUntypedArgument=f.type.kind==="value"||p.type.kind==="value"}static parse(f,p){if(f.length!==3&&f.length!==4)return p.error("Expected two or three arguments.");let y=f[0],x=p.parse(f[1],1,Fn);if(!x)return null;if(!Yp(y,x.type))return p.concat(1).error(`"${y}" comparisons are not supported for type '${Qr(x.type)}'.`);let w=p.parse(f[2],2,Fn);if(!w)return null;if(!Yp(y,w.type))return p.concat(2).error(`"${y}" comparisons are not supported for type '${Qr(w.type)}'.`);if(x.type.kind!==w.type.kind&&x.type.kind!=="value"&&w.type.kind!=="value")return p.error(`Cannot compare types '${Qr(x.type)}' and '${Qr(w.type)}'.`);s&&(x.type.kind==="value"&&w.type.kind!=="value"?x=new Mt(w.type,[x]):x.type.kind!=="value"&&w.type.kind==="value"&&(w=new Mt(x.type,[w])));let I=null;if(f.length===4){if(x.type.kind!=="string"&&w.type.kind!=="string"&&x.type.kind!=="value"&&w.type.kind!=="value")return p.error("Cannot use collator to compare non-string types.");if(I=p.parse(f[3],3,nh),!I)return null}return new tL(x,w,I)}evaluate(f){let p=this.lhs.evaluate(f),y=this.rhs.evaluate(f);if(s&&this.hasUntypedArgument){let x=gt(p),w=gt(y);if(x.kind!==w.kind||x.kind!=="string"&&x.kind!=="number")throw new Xr(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${x.kind}, ${w.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){let x=gt(p),w=gt(y);if(x.kind!=="string"||w.kind!=="string")return e(f,p,y)}return this.collator?n(f,p,y,this.collator.evaluate(f)):e(f,p,y)}eachChild(f){f(this.lhs),f(this.rhs),this.collator&&f(this.collator)}outputDefined(){return!0}serialize(){let f=[i];return this.eachChild(p=>{f.push(p.serialize())}),f}}}let my=hc("==",function(i,e,n){return e===n},py),gy=hc("!=",function(i,e,n){return e!==n},function(i,e,n,s){return!py(0,e,n,s)}),Vb=hc("<",function(i,e,n){return e<n},function(i,e,n,s){return s.compare(e,n)<0}),Ub=hc(">",function(i,e,n){return e>n},function(i,e,n,s){return s.compare(e,n)>0}),jb=hc("<=",function(i,e,n){return e<=n},function(i,e,n,s){return s.compare(e,n)<=0}),Sh=hc(">=",function(i,e,n){return e>=n},function(i,e,n,s){return s.compare(e,n)>=0});class Kp{constructor(e,n,s,c,f,p){this.type=Pn,this.number=e,this.locale=n,this.currency=s,this.unit=c,this.minFractionDigits=f,this.maxFractionDigits=p}static parse(e,n){if(e.length!==3)return n.error("Expected two arguments.");let s=n.parse(e[1],1,It);if(!s)return null;let c=e[2];if(typeof c!="object"||Array.isArray(c))return n.error("NumberFormat options argument must be an object.");let f=null;if(c.locale&&(f=n.parseObjectValue(c.locale,2,"locale",Pn),!f))return null;let p=null;if(c.currency&&(p=n.parseObjectValue(c.currency,2,"currency",Pn),!p))return null;let y=null;if(c.unit&&(y=n.parseObjectValue(c.unit,2,"unit",Pn),!y))return null;let x=null;if(c["min-fraction-digits"]&&(x=n.parseObjectValue(c["min-fraction-digits"],2,"min-fraction-digits",It),!x))return null;let w=null;return c["max-fraction-digits"]&&(w=n.parseObjectValue(c["max-fraction-digits"],2,"max-fraction-digits",It),!w)?null:new Kp(s,f,p,y,x,w)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Jp{constructor(e){this.type=It,this.input=e}static parse(e,n){if(e.length!==2)return n.error(`Expected 1 argument, but found ${e.length-1} instead.`);let s=n.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?n.error(`Expected argument of type string or array, but found ${Qr(s.type)} instead.`):new Jp(s):null}evaluate(e){let n=this.input.evaluate(e);if(typeof n=="string"||Array.isArray(n))return n.length;throw new Xr(`Expected value to be of type string or array, but found ${Qr(gt(n))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){let e=["length"];return this.eachChild(n=>{e.push(n.serialize())}),e}}function _y(i){return function(){i=1831565813+(i|=0)|0;let e=Math.imul(i^i>>>15,1|i);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let fc={"==":my,"!=":gy,">":Ub,"<":Vb,">=":Sh,"<=":jb,array:Mt,at:wh,"at-interpolated":Zp,boolean:Mt,case:Ih,coalesce:bh,collator:Ts,format:tc,image:nc,in:qp,"index-of":Eh,interpolate:no,"interpolate-hcl":no,"interpolate-lab":no,length:Jp,let:Uu,literal:Lt,match:Th,number:Mt,"number-format":Kp,object:Mt,slice:hl,step:Bu,string:Mt,"to-boolean":Ko,"to-color":Ko,"to-number":Ko,"to-string":Ko,var:gh,within:Ea,distance:ul,config:cc,split:Xp};function Qp(i,[e,n,s,c]){e=e.evaluate(i),n=n.evaluate(i),s=s.evaluate(i);let f=c?c.evaluate(i):1,p=al(e,n,s,f);if(p)throw new Xr(p);return new Ln(e/255,n/255,s/255,f)}function yy(i,[e,n,s,c]){e=e.evaluate(i),n=n.evaluate(i),s=s.evaluate(i);let f=c?c.evaluate(i):1,p=function(w,I,S,D){return typeof w=="number"&&w>=0&&w<=360?typeof I=="number"&&I>=0&&I<=100&&typeof S=="number"&&S>=0&&S<=100?D===void 0||typeof D=="number"&&D>=0&&D<=1?null:`Invalid hsla value [${[w,I,S,D].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof D=="number"?[w,I,S,D]:[w,I,S]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof D=="number"?[w,I,S,D]:[w,I,S]).join(", ")}]: 'h' must be between 0 and 360.`}(e,n,s,f);if(p)throw new Xr(p);let y=`hsla(${e}, ${n}%, ${s}%, ${f})`,x=Ln.parse(y);if(!x)throw new Xr(`Failed to parse HSLA color: ${y}`);return x}function vy(i,e){return i in e}function Dh(i,e){let n=e[i];return n===void 0?null:n}function Ia(i){return{type:i}}function em(i){return{result:"success",value:i}}function Sa(i){return{result:"error",value:i}}function Da(i,e){return!!i&&!!i.parameters&&i.parameters.indexOf(e)>-1}function Ch(i){return i["property-type"]==="data-driven"}function xy(i){return Da(i.expression,"measure-light")}function by(i){return Da(i.expression,"zoom")}function Ah(i){return!!i.expression&&i.expression.interpolated}function Mh(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function wy(i){return i}function tm(i,e){let n=e.type==="color",s=i.stops&&typeof i.stops[0][0]=="object",c=s||!(s||i.property!==void 0),f=i.type||(Ah(e)?"exponential":"interval");if(n&&((i=sl({},i)).stops&&(i.stops=i.stops.map(w=>[w[0],Ln.parse(w[1])])),i.default=Ln.parse(i.default?i.default:e.default)),i.colorSpace&&i.colorSpace!=="rgb"&&!xh[i.colorSpace])throw new Error(`Unknown color space: ${i.colorSpace}`);let p,y,x;if(f==="exponential")p=Ty;else if(f==="interval")p=Ey;else if(f==="categorical"){p=nm,y=Object.create(null);for(let w of i.stops)y[w[0]]=w[1];x=typeof i.stops[0][0]}else{if(f!=="identity")throw new Error(`Unknown function type "${f}"`);p=Iy}if(s){let w={},I=[];for(let P=0;P<i.stops.length;P++){let O=i.stops[P],N=O[0].zoom;w[N]===void 0&&(w[N]={zoom:N,type:i.type,property:i.property,default:i.default,stops:[]},I.push(N)),w[N].stops.push([O[0].value,O[1]])}let S=[];for(let P of I)S.push([w[P].zoom,tm(w[P],e)]);let D={name:"linear"};return{kind:"composite",interpolationType:D,interpolationFactor:no.interpolationFactor.bind(void 0,D),zoomStops:S.map(P=>P[0]),evaluate:({zoom:P},O)=>Ty({stops:S,base:i.base},e,P).evaluate(P,O)}}if(c){let w=f==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:w,interpolationFactor:no.interpolationFactor.bind(void 0,w),zoomStops:i.stops.map(I=>I[0]),evaluate:({zoom:I})=>p(i,e,I,y,x)}}return{kind:"source",evaluate(w,I){let S=I&&I.properties?I.properties[i.property]:void 0;return S===void 0?fl(i.default,e.default):p(i,e,S,y,x)}}}function fl(i,e,n){return i!==void 0?i:e!==void 0?e:n!==void 0?n:void 0}function nm(i,e,n,s,c){return fl(typeof n===c?s[n]:void 0,i.default,e.default)}function Ey(i,e,n){if(va(n)!=="number")return fl(i.default,e.default);let s=i.stops.length;if(s===1||n<=i.stops[0][0])return i.stops[0][1];if(n>=i.stops[s-1][0])return i.stops[s-1][1];let c=yh(i.stops.map(f=>f[0]),n);return i.stops[c][1]}function Ty(i,e,n){let s=i.base!==void 0?i.base:1;if(va(n)!=="number")return fl(i.default,e.default);let c=i.stops.length;if(c===1||n<=i.stops[0][0])return i.stops[0][1];if(n>=i.stops[c-1][0])return i.stops[c-1][1];let f=yh(i.stops.map(I=>I[0]),n),p=function(I,S,D,P){let O=P-D,N=I-D;return O===0?0:S===1?N/O:(Math.pow(S,N)-1)/(Math.pow(S,O)-1)}(n,s,i.stops[f][0],i.stops[f+1][0]),y=i.stops[f][1],x=i.stops[f+1][1],w=Cu[e.type]||wy;if(i.colorSpace&&i.colorSpace!=="rgb"){let I=xh[i.colorSpace];w=(S,D)=>I.reverse(I.interpolate(I.forward(S),I.forward(D),p))}return typeof y.evaluate=="function"?{evaluate(...I){let S=y.evaluate.apply(void 0,I),D=x.evaluate.apply(void 0,I);if(S!==void 0&&D!==void 0)return w(S,D,p)}}:w(y,x,p)}function Iy(i,e,n){return e.type==="color"?n=Ln.parse(n):e.type==="formatted"?n=Bi.fromString(n.toString()):e.type==="resolvedImage"?n=to.build(n.toString()):va(n)===e.type||e.type==="enum"&&e.values[n]||(n=void 0),fl(n,i.default,e.default)}fi.register(fc,{error:[{kind:"error"},[Pn],(i,[e])=>{throw new Xr(e.evaluate(i))}],typeof:[Pn,[Fn],(i,[e])=>Qr(gt(e.evaluate(i)))],"to-rgba":[Pi(It,4),[po],(i,[e])=>e.evaluate(i).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Pi(It,4),[po],(i,[e])=>e.evaluate(i).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[po,[It,It,It],Qp],rgba:[po,[It,It,It,It],Qp],hsl:[po,[It,It,It],yy],hsla:[po,[It,It,It,It],yy],has:{type:On,overloads:[[[Pn],(i,[e])=>vy(e.evaluate(i),i.properties())],[[Pn,Hs],(i,[e,n])=>vy(e.evaluate(i),n.evaluate(i))]]},get:{type:Fn,overloads:[[[Pn],(i,[e])=>Dh(e.evaluate(i),i.properties())],[[Pn,Hs],(i,[e,n])=>Dh(e.evaluate(i),n.evaluate(i))]]},"feature-state":[Fn,[Pn],(i,[e])=>Dh(e.evaluate(i),i.featureState||{})],properties:[Hs,[],i=>i.properties()],"geometry-type":[Pn,[],i=>i.geometryType()],worldview:[Pn,[],i=>i.globals.worldview||""],id:[Fn,[],i=>i.id()],zoom:[It,[],i=>i.globals.zoom],pitch:[It,[],i=>i.globals.pitch||0],"distance-from-center":[It,[],i=>i.distanceFromCenter()],"measure-light":[It,[Pn],(i,[e])=>i.measureLight(e.evaluate(i))],"heatmap-density":[It,[],i=>i.globals.heatmapDensity||0],"line-progress":[It,[],i=>i.globals.lineProgress||0],"raster-value":[It,[],i=>i.globals.rasterValue||0],"raster-particle-speed":[It,[],i=>i.globals.rasterParticleSpeed||0],"sky-radial-progress":[It,[],i=>i.globals.skyRadialProgress||0],accumulated:[Fn,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[It,Ia(It),(i,e)=>{let n=0;for(let s of e)n+=s.evaluate(i);return n}],"*":[It,Ia(It),(i,e)=>{let n=1;for(let s of e)n*=s.evaluate(i);return n}],"-":{type:It,overloads:[[[It,It],(i,[e,n])=>e.evaluate(i)-n.evaluate(i)],[[It],(i,[e])=>-e.evaluate(i)]]},"/":[It,[It,It],(i,[e,n])=>e.evaluate(i)/n.evaluate(i)],"%":[It,[It,It],(i,[e,n])=>e.evaluate(i)%n.evaluate(i)],ln2:[It,[],()=>Math.LN2],pi:[It,[],()=>Math.PI],e:[It,[],()=>Math.E],"^":[It,[It,It],(i,[e,n])=>Math.pow(e.evaluate(i),n.evaluate(i))],sqrt:[It,[It],(i,[e])=>Math.sqrt(e.evaluate(i))],log10:[It,[It],(i,[e])=>Math.log(e.evaluate(i))/Math.LN10],ln:[It,[It],(i,[e])=>Math.log(e.evaluate(i))],log2:[It,[It],(i,[e])=>Math.log(e.evaluate(i))/Math.LN2],sin:[It,[It],(i,[e])=>Math.sin(e.evaluate(i))],cos:[It,[It],(i,[e])=>Math.cos(e.evaluate(i))],tan:[It,[It],(i,[e])=>Math.tan(e.evaluate(i))],asin:[It,[It],(i,[e])=>Math.asin(e.evaluate(i))],acos:[It,[It],(i,[e])=>Math.acos(e.evaluate(i))],atan:[It,[It],(i,[e])=>Math.atan(e.evaluate(i))],min:[It,Ia(It),(i,e)=>Math.min(...e.map(n=>n.evaluate(i)))],max:[It,Ia(It),(i,e)=>Math.max(...e.map(n=>n.evaluate(i)))],abs:[It,[It],(i,[e])=>Math.abs(e.evaluate(i))],round:[It,[It],(i,[e])=>{let n=e.evaluate(i);return n<0?-Math.round(-n):Math.round(n)}],floor:[It,[It],(i,[e])=>Math.floor(e.evaluate(i))],ceil:[It,[It],(i,[e])=>Math.ceil(e.evaluate(i))],"filter-==":[On,[Pn,Fn],(i,[e,n])=>i.properties()[e.value]===n.value],"filter-id-==":[On,[Fn],(i,[e])=>i.id()===e.value],"filter-type-==":[On,[Pn],(i,[e])=>i.geometryType()===e.value],"filter-<":[On,[Pn,Fn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s<c}],"filter-id-<":[On,[Fn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n<s}],"filter->":[On,[Pn,Fn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s>c}],"filter-id->":[On,[Fn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n>s}],"filter-<=":[On,[Pn,Fn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s<=c}],"filter-id-<=":[On,[Fn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n<=s}],"filter->=":[On,[Pn,Fn],(i,[e,n])=>{let s=i.properties()[e.value],c=n.value;return typeof s==typeof c&&s>=c}],"filter-id->=":[On,[Fn],(i,[e])=>{let n=i.id(),s=e.value;return typeof n==typeof s&&n>=s}],"filter-has":[On,[Fn],(i,[e])=>e.value in i.properties()],"filter-has-id":[On,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[On,[Pi(Pn)],(i,[e])=>e.value.indexOf(i.geometryType())>=0],"filter-id-in":[On,[Pi(Fn)],(i,[e])=>e.value.indexOf(i.id())>=0],"filter-in-small":[On,[Pn,Pi(Fn)],(i,[e,n])=>n.value.indexOf(i.properties()[e.value])>=0],"filter-in-large":[On,[Pn,Pi(Fn)],(i,[e,n])=>function(s,c,f,p){for(;f<=p;){let y=f+p>>1;if(c[y]===s)return!0;c[y]>s?p=y-1:f=y+1}return!1}(i.properties()[e.value],n.value,0,n.value.length-1)],all:{type:On,overloads:[[[On,On],(i,[e,n])=>e.evaluate(i)&&n.evaluate(i)],[Ia(On),(i,e)=>{for(let n of e)if(!n.evaluate(i))return!1;return!0}]]},any:{type:On,overloads:[[[On,On],(i,[e,n])=>e.evaluate(i)||n.evaluate(i)],[Ia(On),(i,e)=>{for(let n of e)if(n.evaluate(i))return!0;return!1}]]},"!":[On,[On],(i,[e])=>!e.evaluate(i)],"is-supported-script":[On,[Pn],(i,[e])=>{let n=i.globals&&i.globals.isSupportedScript;return!n||n(e.evaluate(i))}],upcase:[Pn,[Pn],(i,[e])=>e.evaluate(i).toUpperCase()],downcase:[Pn,[Pn],(i,[e])=>e.evaluate(i).toLowerCase()],concat:[Pn,Ia(Fn),(i,e)=>e.map(n=>Yo(n.evaluate(i))).join("")],"resolved-locale":[Pn,[nh],(i,[e])=>e.evaluate(i).resolvedLocale()],random:[It,[It,It,Fn],(i,e)=>{let[n,s,c]=e.map(p=>p.evaluate(i));if(n>s||n===s)return n;let f;if(typeof c=="string")f=function(p){let y=0;if(p.length===0)return y;for(let x=0;x<p.length;x++)y=(y<<5)-y+p.charCodeAt(x),y|=0;return y}(c);else{if(typeof c!="number")throw new Xr(`Invalid seed input: ${c}`);f=c}return n+_y(f)()*(s-n)}]});class rm{constructor(e,n,s,c){this.expression=e,this._warningHistory={},this._evaluator=new Lu(s,c),this._defaultValue=n?function(f){return f.type==="color"&&(Mh(f.default)||Array.isArray(f.default))?new Ln(0,0,0,0):f.type==="color"?Ln.parse(f.default)||null:f.default===void 0?null:f.default}(n):null,this._enumValues=n&&n.type==="enum"?n.values:null,this.configDependencies=mh(e)}evaluateWithoutErrorHandling(e,n,s,c,f,p,y,x){return this._evaluator.globals=e,this._evaluator.feature=n,this._evaluator.featureState=s,this._evaluator.canonical=c||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=x||null,this.expression.evaluate(this._evaluator)}evaluate(e,n,s,c,f,p,y,x){this._evaluator.globals=e,this._evaluator.feature=n||null,this._evaluator.featureState=s||null,this._evaluator.canonical=c||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p||null,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=x||null;try{let w=this.expression.evaluate(this._evaluator);if(w==null||typeof w=="number"&&w!=w)return this._defaultValue;if(this._enumValues&&!(w in this._enumValues))throw new Xr(`Expected value to be one of ${Object.keys(this._enumValues).map(I=>JSON.stringify(I)).join(", ")}, but found ${JSON.stringify(w)} instead.`);return w}catch(w){return this._warningHistory[w.message]||(this._warningHistory[w.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${w.message}`)),this._defaultValue}}}function im(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in fc}function pl(i,e,n,s){let c=new _h(fc,[],e?function(p){let y={color:po,string:Pn,number:It,enum:Pn,boolean:On,formatted:Au,resolvedImage:Mu};return p.type==="array"?Pi(y[p.value]||Fn,p.length):y[p.type]}(e):void 0,void 0,void 0,n,s),f=c.parse(i,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?em(new rm(f,e,n,s)):Sa(c.errors)}class Rh{constructor(e,n,s,c){this.kind=e,this._styleExpression=n,this.isLightConstant=s,this.isLineProgressConstant=c,this.isStateDependent=e!=="constant"&&!ph(n.expression),this.configDependencies=mh(n.expression)}evaluateWithoutErrorHandling(e,n,s,c,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,n,s,c,f,p)}evaluate(e,n,s,c,f,p){return this._styleExpression.evaluate(e,n,s,c,f,p)}}class Ca{constructor(e,n,s,c,f,p){this.kind=e,this.zoomStops=s,this._styleExpression=n,this.isStateDependent=e!=="camera"&&!ph(n.expression),this.isLightConstant=f,this.isLineProgressConstant=p,this.configDependencies=mh(n.expression),this.interpolationType=c}evaluateWithoutErrorHandling(e,n,s,c,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,n,s,c,f,p)}evaluate(e,n,s,c,f,p){return this._styleExpression.evaluate(e,n,s,c,f,p)}interpolationFactor(e,n,s){return this.interpolationType?no.interpolationFactor(this.interpolationType,e,n,s):0}}function om(i,e,n,s){if((i=pl(i,e,n,s)).result==="error")return i;let c=i.value.expression,f=ac(c);if(!f&&!Ch(e))return Sa([new Ao("","data expressions not supported")]);let p=lc(c,["zoom","pitch","distance-from-center"]);if(!p&&!by(e))return Sa([new Ao("","zoom expressions not supported")]);let y=lc(c,["measure-light"]);if(!y&&!xy(e))return Sa([new Ao("","measure-light expression not supported")]);let x=lc(c,["line-progress"]);if(!x&&!function(S){return Da(S.expression,"line-progress")}(e))return Sa([new Ao("","line-progress expression not supported")]);let w=e.expression&&e.expression.relaxZoomRestriction,I=ju(c);return I||p||w?I instanceof Ao?Sa([I]):I instanceof no&&!Ah(e)?Sa([new Ao("",'"interpolate" expressions cannot be used with this property')]):em(I?new Ca(f&&x?"camera":"composite",i.value,I.labels,I instanceof no?I.interpolation:void 0,y,x):new Rh(f&&x?"constant":"source",i.value,y,x)):Sa([new Ao("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class ml{constructor(e,n){this._parameters=e,this._specification=n,sl(this,tm(this._parameters,this._specification))}static deserialize(e){return new ml(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function ju(i){let e=null;if(i instanceof Uu)e=ju(i.result);else if(i instanceof bh){for(let n of i.args)if(e=ju(n),e)break}else(i instanceof Bu||i instanceof no)&&i.input instanceof fi&&i.input.name==="zoom"&&(e=i);return e instanceof Ao||i.eachChild(n=>{let s=ju(n);s instanceof Ao?e=s:e&&s&&e!==s&&(e=new Ao("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var sm,Sy,am=function(){if(Sy)return sm;Sy=1,sm=e;var i=3;function e(n,s,c){var f=this.cells=[];if(n instanceof ArrayBuffer){this.arrayBuffer=n;var p=new Int32Array(this.arrayBuffer);n=p[0],this.d=(s=p[1])+2*(c=p[2]);for(var y=0;y<this.d*this.d;y++){var x=p[i+y],w=p[i+y+1];f.push(x===w?null:p.subarray(x,w))}var I=p[i+f.length+1];this.keys=p.subarray(p[i+f.length],I),this.bboxes=p.subarray(I),this.insert=this._insertReadonly}else{this.d=s+2*c;for(var S=0;S<this.d*this.d;S++)f.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=n,this.padding=c,this.scale=s/n,this.uid=0;var D=c/s*n;this.min=-D,this.max=n+D}return e.prototype.insert=function(n,s,c,f,p){this._forEachCell(s,c,f,p,this._insertCell,this.uid++),this.keys.push(n),this.bboxes.push(s),this.bboxes.push(c),this.bboxes.push(f),this.bboxes.push(p)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(n,s,c,f,p,y){this.cells[p].push(y)},e.prototype.query=function(n,s,c,f,p){var y=this.min,x=this.max;if(n<=y&&s<=y&&x<=c&&x<=f&&!p)return Array.prototype.slice.call(this.keys);var w=[];return this._forEachCell(n,s,c,f,this._queryCell,w,{},p),w},e.prototype._queryCell=function(n,s,c,f,p,y,x,w){var I=this.cells[p];if(I!==null)for(var S=this.keys,D=this.bboxes,P=0;P<I.length;P++){var O=I[P];if(x[O]===void 0){var N=4*O;(w?w(D[N+0],D[N+1],D[N+2],D[N+3]):n<=D[N+2]&&s<=D[N+3]&&c>=D[N+0]&&f>=D[N+1])?(x[O]=!0,y.push(S[O])):x[O]=!1}}},e.prototype._forEachCell=function(n,s,c,f,p,y,x,w){for(var I=this._convertToCellCoord(n),S=this._convertToCellCoord(s),D=this._convertToCellCoord(c),P=this._convertToCellCoord(f),O=I;O<=D;O++)for(var N=S;N<=P;N++){var B=this.d*N+O;if((!w||w(this._convertFromCellCoord(O),this._convertFromCellCoord(N),this._convertFromCellCoord(O+1),this._convertFromCellCoord(N+1)))&&p.call(this,n,s,c,f,B,y,x,w))return}},e.prototype._convertFromCellCoord=function(n){return(n-this.padding)/this.scale},e.prototype._convertToCellCoord=function(n){return Math.max(0,Math.min(this.d-1,Math.floor(n*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var n=this.cells,s=i+this.cells.length+1+1,c=0,f=0;f<this.cells.length;f++)c+=this.cells[f].length;var p=new Int32Array(s+c+this.keys.length+this.bboxes.length);p[0]=this.extent,p[1]=this.n,p[2]=this.padding;for(var y=s,x=0;x<n.length;x++){var w=n[x];p[i+x]=y,p.set(w,y),y+=w.length}return p[i+n.length]=y,p.set(this.keys,y),p[i+n.length+1]=y+=this.keys.length,p.set(this.bboxes,y),y+=this.bboxes.length,p.buffer},sm}(),Aa=fu(am);let Hu={};function _t(i,e,n={}){Object.defineProperty(i,"_classRegistryKey",{value:e,writable:!1}),Hu[e]={klass:i,omit:n.omit||[]}}_t(Object,"Object"),Aa.serialize=function(i,e){let n=i.toArrayBuffer();return e&&e.add(n),{buffer:n}},Aa.deserialize=function(i){return new Aa(i.buffer)},Object.defineProperty(Aa,"name",{value:"Grid"}),_t(Aa,"Grid"),delete Xe.prototype.constructor,typeof DOMMatrix<"u"&&_t(DOMMatrix,"DOMMatrix"),_t(Ln,"Color"),_t(Error,"Error"),_t(Bi,"Formatted"),_t(ih,"FormattedSection"),_t(xn,"AJAXError"),_t(to,"ResolvedImage"),_t(ml,"StylePropertyFunction"),_t(rm,"StyleExpression",{omit:["_evaluator"]}),_t(fo,"ImageId"),_t(Gs,"ImageVariant"),_t(Ca,"ZoomDependentExpression"),_t(Rh,"ZoomConstantExpression"),_t(fi,"CompoundExpression",{omit:["_evaluate"]});for(let i in fc)Hu[fc[i]._classRegistryKey]||_t(fc[i],`Expression${i}`);function Ph(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Gu(i){return self.ImageBitmap&&i instanceof ImageBitmap}function $s(i,e){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp)return i;if(Ph(i)||Gu(i))return e&&e.add(i),i;if(ArrayBuffer.isView(i))return e&&e.add(i.buffer),i;if(i instanceof ImageData)return e&&e.add(i.data.buffer),i;if(Array.isArray(i)){let n=[];for(let s of i)n.push($s(s,e));return n}if(i instanceof Map){let n={$name:"Map",entries:[]};for(let[s,c]of i.entries())n.entries.push($s(s),$s(c,e));return n}if(i instanceof Set){let n={$name:"Set"},s=0;for(let c of i.values())n[++s]=$s(c);return n}if(i instanceof DOMMatrix){let n={$name:"DOMMatrix"},s=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(let c of s)n[c]=i[c];return n}if(typeof i=="bigint")return{$name:"BigInt",value:i.toString()};if(typeof i=="object"){let n=i.constructor,s=n._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${n.name}".`);let c=n.serialize?n.serialize(i,e):{};if(!n.serialize){for(let f in i)i.hasOwnProperty(f)&&(Hu[s].omit.indexOf(f)>=0||(c[f]=$s(i[f],e)));i instanceof Error&&(c.message=i.message)}if(c.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(c.$name=s),c}throw new Error("can't serialize object of type "+typeof i)}function ro(i){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||Ph(i)||Gu(i)||ArrayBuffer.isView(i)||i instanceof ImageData)return i;if(Array.isArray(i))return i.map(ro);if(typeof i=="object"){let e=i.$name||"Object";if(e==="Map"){let c=i.entries||[],f=new Map;for(let p=0;p<c.length;p+=2)f.set(ro(c[p]),ro(c[p+1]));return f}if(e==="Set"){let c=new Set;for(let f of Object.keys(i))f!=="$name"&&c.add(ro(i[f]));return c}if(e==="DOMMatrix"){let c;return c=i.is2D?[i.a,i.b,i.c,i.d,i.e,i.f]:[i.m11,i.m12,i.m13,i.m14,i.m21,i.m22,i.m23,i.m24,i.m31,i.m32,i.m33,i.m34,i.m41,i.m42,i.m43,i.m44],new DOMMatrix(c)}if(e==="BigInt")return BigInt(i.value);let{klass:n}=Hu[e];if(!n)throw new Error(`Can't deserialize unregistered class "${e}".`);if(n.deserialize)return n.deserialize(i);let s=Object.create(n.prototype);for(let c of Object.keys(i))c!=="$name"&&(s[c]=ro(i[c]));return s}throw new Error("can't deserialize object of type "+typeof i)}let Pt={"Latin-1 Supplement":i=>i>=128&&i<=255,Arabic:i=>i>=1536&&i<=1791,"Arabic Supplement":i=>i>=1872&&i<=1919,"Arabic Extended-A":i=>i>=2208&&i<=2303,"Hangul Jamo":i=>i>=4352&&i<=4607,"Unified Canadian Aboriginal Syllabics":i=>i>=5120&&i<=5759,Khmer:i=>i>=6016&&i<=6143,"Unified Canadian Aboriginal Syllabics Extended":i=>i>=6320&&i<=6399,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"CJK Radicals Supplement":i=>i>=11904&&i<=12031,"Kangxi Radicals":i=>i>=12032&&i<=12255,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Hiragana:i=>i>=12352&&i<=12447,Katakana:i=>i>=12448&&i<=12543,Bopomofo:i=>i>=12544&&i<=12591,"Hangul Compatibility Jamo":i=>i>=12592&&i<=12687,Kanbun:i=>i>=12688&&i<=12703,"Bopomofo Extended":i=>i>=12704&&i<=12735,"CJK Strokes":i=>i>=12736&&i<=12783,"Katakana Phonetic Extensions":i=>i>=12784&&i<=12799,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"CJK Unified Ideographs Extension A":i=>i>=13312&&i<=19903,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"CJK Unified Ideographs":i=>i>=19968&&i<=40959,"Yi Syllables":i=>i>=40960&&i<=42127,"Yi Radicals":i=>i>=42128&&i<=42191,"Hangul Jamo Extended-A":i=>i>=43360&&i<=43391,"Hangul Syllables":i=>i>=44032&&i<=55215,"Hangul Jamo Extended-B":i=>i>=55216&&i<=55295,"Private Use Area":i=>i>=57344&&i<=63743,"CJK Compatibility Ideographs":i=>i>=63744&&i<=64255,"Arabic Presentation Forms-A":i=>i>=64336&&i<=65023,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Arabic Presentation Forms-B":i=>i>=65136&&i<=65279,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519,Osage:i=>i>=66736&&i<=66815,"CJK Unified Ideographs Extension B":i=>i>=131072&&i<=173791};function lm(i){for(let e of i)if(Oh(e.charCodeAt(0)))return!0;return!1}function Hb(i){for(let e of i)if(!Gb(e.charCodeAt(0)))return!1;return!0}function Gb(i){return!(Pt.Arabic(i)||Pt["Arabic Supplement"](i)||Pt["Arabic Extended-A"](i)||Pt["Arabic Presentation Forms-A"](i)||Pt["Arabic Presentation Forms-B"](i))}function Oh(i){return!(i!==746&&i!==747&&(i<4352||!(Pt["Bopomofo Extended"](i)||Pt.Bopomofo(i)||Pt["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||Pt["CJK Compatibility Ideographs"](i)||Pt["CJK Compatibility"](i)||Pt["CJK Radicals Supplement"](i)||Pt["CJK Strokes"](i)||!(!Pt["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||Pt["CJK Unified Ideographs Extension A"](i)||Pt["CJK Unified Ideographs"](i)||Pt["Enclosed CJK Letters and Months"](i)||Pt["Hangul Compatibility Jamo"](i)||Pt["Hangul Jamo Extended-A"](i)||Pt["Hangul Jamo Extended-B"](i)||Pt["Hangul Jamo"](i)||Pt["Hangul Syllables"](i)||Pt.Hiragana(i)||Pt["Ideographic Description Characters"](i)||Pt.Kanbun(i)||Pt["Kangxi Radicals"](i)||Pt["Katakana Phonetic Extensions"](i)||Pt.Katakana(i)&&i!==12540||!(!Pt["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!Pt["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||Pt["Unified Canadian Aboriginal Syllabics"](i)||Pt["Unified Canadian Aboriginal Syllabics Extended"](i)||Pt["Vertical Forms"](i)||Pt["Yijing Hexagram Symbols"](i)||Pt["Yi Syllables"](i)||Pt["Yi Radicals"](i))))}function Lh(i){return!(Oh(i)||function(e){return!!(Pt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Pt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Pt["Letterlike Symbols"](e)||Pt["Number Forms"](e)||Pt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Pt["Control Pictures"](e)&&e!==9251||Pt["Optical Character Recognition"](e)||Pt["Enclosed Alphanumerics"](e)||Pt["Geometric Shapes"](e)||Pt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Pt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Pt["CJK Symbols and Punctuation"](e)||Pt.Katakana(e)||Pt["Private Use Area"](e)||Pt["CJK Compatibility Forms"](e)||Pt["Small Form Variants"](e)||Pt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(i))}function Dy(i){return Pt.Arabic(i)||Pt["Arabic Supplement"](i)||Pt["Arabic Extended-A"](i)||Pt["Arabic Presentation Forms-A"](i)||Pt["Arabic Presentation Forms-B"](i)}function Fh(i){return i>=1424&&i<=2303||Pt["Arabic Presentation Forms-A"](i)||Pt["Arabic Presentation Forms-B"](i)}function $b(i,e){return!(!e&&Fh(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||Pt.Khmer(i))}function Wb(i){for(let e of i)if(Fh(e.charCodeAt(0)))return!0;return!1}let mo={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"},cm=null,Ui=mo.unavailable,Ma=null,Cy=function(i){i&&typeof i=="string"&&i.indexOf("NetworkError")>-1&&(Ui=mo.error),cm&&cm(i)};function um(){dm.fire(new js("pluginStateChange",{pluginStatus:Ui,pluginURL:Ma}))}let dm=new ol,hm=function(){return Ui},Ay=function(){if(Ui!==mo.deferred||!Ma)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Ui=mo.loading,um(),Ma&&Eu({url:Ma},i=>{i?Cy(i):(Ui=mo.loaded,um())})},Is={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Ui===mo.loaded||Is.applyArabicShaping!=null,isLoading:()=>Ui===mo.loading,setState(i){Ui=i.pluginStatus,Ma=i.pluginURL},isParsing:()=>Ui===mo.parsing,isParsed:()=>Ui===mo.parsed,getPluginURL:()=>Ma};class jn{constructor(e,n){this.zoom=e,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness,this.worldview=n.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(n,s){for(let c of n)if(!$b(c.charCodeAt(0),s))return!1;return!0}(e,Is.isLoaded())}}class $u{constructor(e,n,s,c){this.property=e,this.value=n,this.expression=function(f,p,y,x){if(Mh(f))return new ml(f,p);if(im(f)||Array.isArray(f)&&f.length>0){let w=om(f,p,y,x);if(w.result==="error")throw new Error(w.value.map(I=>`${I.key}: ${I.message}`).join(", "));return w.value}{let w=f;return typeof f=="string"&&p.type==="color"&&(w=Ln.parse(f)),{kind:"constant",configDependencies:new Set,evaluate:()=>w}}}(n===void 0?e.specification.default:n,e.specification,s,c)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,n,s){return this.property.possiblyEvaluate(this,e,n,s)}}class kh{constructor(e,n,s){this.property=e,this.value=new $u(e,void 0,n,s)}transitioned(e,n){return new My(this.property,this.value,n,Ce({},e.transition,this.transition),e.now)}untransitioned(){return new My(this.property,this.value,null,{},0)}}class Wu{constructor(e,n,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=n,this._options=s,this.configDependencies=new Set}getValue(e){return rn(this._values[e].value.value)}setValue(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new kh(this._values[e].property,this._scope,this._options)),this._values[e].value=new $u(this._values[e].property,n===null?void 0:rn(n),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,n){n&&(this._options=n);let s=this._properties.properties;if(e)for(let c in e){let f=e[c];if(c.endsWith("-transition")){let p=c.slice(0,-11);s[p]&&this.setTransition(p,f)}else s.hasOwnProperty(c)&&this.setValue(c,f)}}getTransition(e){return rn(this._values[e].transition)}setTransition(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new kh(this._values[e].property)),this._values[e].transition=rn(n)||void 0}serialize(){let e={};for(let n of Object.keys(this._values)){let s=this.getValue(n);s!==void 0&&(e[n]=s);let c=this.getTransition(n);c!==void 0&&(e[`${n}-transition`]=c)}return e}transitioned(e,n){let s=new Ry(this._properties);for(let c of Object.keys(this._values))s._values[c]=this._values[c].transitioned(e,n._values[c]);return s}untransitioned(){let e=new Ry(this._properties);for(let n of Object.keys(this._values))e._values[n]=this._values[n].untransitioned();return e}}class My{constructor(e,n,s,c,f){let p=c.delay||0,y=c.duration||0;f=f||0,this.property=e,this.value=n,this.begin=f+p,this.end=this.begin+y,e.specification.transition&&(c.delay||c.duration)&&(this.prior=s)}possiblyEvaluate(e,n,s){let c=e.now||0,f=this.value.possiblyEvaluate(e,n,s),p=this.prior;if(p){if(c>this.end)return this.prior=null,f;if(this.value.isDataDriven())return this.prior=null,f;if(c<this.begin)return p.possiblyEvaluate(e,n,s);{let y=(c-this.begin)/(this.end-this.begin);return this.property.interpolate(p.possiblyEvaluate(e,n,s),f,W(y))}}return f}}class Ry{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,n,s){let c=new hs(this._properties);for(let f of Object.keys(this._values))c._values[f]=this._values[f].possiblyEvaluate(e,n,s);return c}hasTransition(){for(let e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Ra{constructor(e,n,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=n,this._options=s,this.configDependencies=new Set}getValue(e){return rn(this._values[e].value)}setValue(e,n){this._values[e]=new $u(this._values[e].property,n===null?void 0:rn(n),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){let e={};for(let n of Object.keys(this._values)){let s=this.getValue(n);s!==void 0&&(e[n]=s)}return e}possiblyEvaluate(e,n,s){let c=new hs(this._properties);for(let f of Object.keys(this._values))c._values[f]=this._values[f].possiblyEvaluate(e,n,s);return c}}class gl{constructor(e,n,s){this.property=e,this.value=n,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,n,s,c){return this.property.evaluate(this.value,this.parameters,e,n,s,c)}}class hs{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class tt{constructor(e){this.specification=e}possiblyEvaluate(e,n){return e.expression.evaluate(n)}interpolate(e,n,s){let c=Cu[this.specification.type];return c?c(e,n,s):e}}class dt{constructor(e,n){this.specification=e,this.overrides=n}possiblyEvaluate(e,n,s,c){return new gl(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(n,null,{},s,c)}:e.expression,n)}interpolate(e,n,s){if(e.value.kind!=="constant"||n.value.kind!=="constant")return e;if(e.value.value===void 0||n.value.value===void 0)return new gl(this,{kind:"constant",value:void 0},e.parameters);let c=Cu[this.specification.type];return c?new gl(this,{kind:"constant",value:c(e.value.value,n.value.value,s)},e.parameters):e}evaluate(e,n,s,c,f,p){return e.kind==="constant"?e.value:e.evaluate(n,s,c,f,p)}}class pc{constructor(e){this.specification=e}possiblyEvaluate(e,n,s,c){return!!e.expression.evaluate(n,null,{},s,c)}interpolate(){return!1}}class Mr{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let n=new jn(0,{});for(let s in e){let c=e[s];c.specification.overridable&&this.overridableProperties.push(s);let f=this.defaultPropertyValues[s]=new $u(c,void 0),p=this.defaultTransitionablePropertyValues[s]=new kh(c);this.defaultTransitioningPropertyValues[s]=p.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=f.possiblyEvaluate(n)}}}_t(dt,"DataDrivenProperty"),_t(tt,"DataConstantProperty"),_t(pc,"ColorRampProperty");var xe=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"expression"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Py(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function Zu(i){if(Array.isArray(i))return i.map(Zu);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){let e={};for(let n in i)e[n]=Zu(i[n]);return e}return Py(i)}function qu(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(let e of i.slice(1))if(!qu(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function mc(i,e="",n=null,s="fill"){if(i==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};qu(i)||(i=zh(i));let c=i,f=!0;try{f=function(I){if(!gc(I))return I;let S=Zu(I);return Nh(S),S=fm(S),S}(c)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(c,null,2)}
        `)}let p=null,y=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){y=xe[`filter_${s}`];let I=pl(f,y,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));p=(S,D,P)=>I.value.evaluate(S,D,{},P)}let x=null,w=null;if(f!==c){let I=pl(c,y,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));x=(S,D,P,O,N)=>I.value.evaluate(S,D,{},P,void 0,void 0,O,N),w=!ac(I.value.expression)}return{filter:p,dynamicFilter:x||void 0,needGeometry:pm(f),needFeature:!!w}}function fm(i){if(!Array.isArray(i))return i;let e=function(n){if(Ss.has(n[0])){for(let s=1;s<n.length;s++)if(gc(n[s]))return!0}return n}(i);return e===!0?e:e.map(n=>fm(n))}function Nh(i){let e=!1,n=[];if(i[0]==="case"){for(let s=1;s<i.length-1;s+=2)e=e||gc(i[s]),n.push(i[s+1]);n.push(i[i.length-1])}else if(i[0]==="match"){e=e||gc(i[1]);for(let s=2;s<i.length-1;s+=2)n.push(i[s+1]);n.push(i[i.length-1])}else if(i[0]==="step"){e=e||gc(i[1]);for(let s=1;s<i.length-1;s+=2)n.push(i[s+1])}e&&(i.length=0,i.push("any",...n));for(let s=1;s<i.length;s++)Nh(i[s])}function gc(i){if(!Array.isArray(i))return!1;if((e=i[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let n=1;n<i.length;n++)if(gc(i[n]))return!0;return!1}let Ss=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Zb(i,e){return i<e?-1:i>e?1:0}function pm(i){if(!Array.isArray(i))return!1;if(i[0]==="within"||i[0]==="distance")return!0;for(let e=1;e<i.length;e++)if(pm(i[e]))return!0;return!1}function zh(i){if(!i)return!0;let e=i[0];return i.length<=1?e!=="any":e==="=="?mm(i[1],i[2],"=="):e==="!="?Bh(mm(i[1],i[2],"==")):e==="<"||e===">"||e==="<="||e===">="?mm(i[1],i[2],e):e==="any"?(n=i.slice(1),["any"].concat(n.map(zh))):e==="all"?["all"].concat(i.slice(1).map(zh)):e==="none"?["all"].concat(i.slice(1).map(zh).map(Bh)):e==="in"?Oy(i[1],i.slice(2)):e==="!in"?Bh(Oy(i[1],i.slice(2))):e==="has"?Ly(i[1]):e!=="!has"||Bh(Ly(i[1]));var n}function mm(i,e,n){switch(i){case"$type":return[`filter-type-${n}`,e];case"$id":return[`filter-id-${n}`,e];default:return[`filter-${n}`,i,e]}}function Oy(i,e){if(e.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(n=>typeof n!=typeof e[0])?["filter-in-large",i,["literal",e.sort(Zb)]]:["filter-in-small",i,["literal",e]]}}function Ly(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function Bh(i){return["!",i]}let Xu="";function _c(i,e){return e?`${i}${Xu}${e}`:i}let Fy="-transition",qb=new Set(["fill","line","background","hillshade","raster"]);class Li extends ol{constructor(e,n,s,c,f){if(super(),this.id=e.id,this.fqid=_c(this.id,s),this.type=e.type,this.scope=s,this.lut=c,this.options=f,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;let p=pl(this.filter,xe[`filter_${e.type}`]);p.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...p.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),n.layout&&(this._unevaluatedLayout=new Ra(n.layout,this.scope,f),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),n.paint){this._transitionablePaint=new Wu(n.paint,this.scope,f);for(let p in e.paint)this.setPaintProperty(p,e.paint[p]);for(let p in e.layout)this.setLayoutProperty(p,e.layout[p]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new hs(n.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&qb.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,n){if(this.type==="custom"&&e==="visibility")return void(this.visibility=n);let s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(Fy)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,n){let s=this._transitionablePaint,c=s._properties.properties;if(e.endsWith(Fy)){let S=e.slice(0,-11);return c[S]&&s.setTransition(S,n||void 0),!1}if(!c[e])return!1;let f=s._values[e],p=f.value.isDataDriven(),y=f.value;s.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);let x=s._values[e].value,w=x.isDataDriven(),I=e.endsWith("pattern")||e==="line-dasharray";return w||p||I||this._handleOverridablePaintPropertyUpdate(e,y,x)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,n,s){return null}_handleOverridablePaintPropertyUpdate(e,n,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,n)}serialize(){return dn({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,n)=>!(e===void 0||n==="layout"&&!Object.keys(e).length||n==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(let e in this.paint._values){let n=this.paint.get(e);if(n instanceof gl&&Ch(n.property.specification)&&(n.value.kind==="source"||n.value.kind==="composite")&&n.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=mc(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,n,s,c,f,p,y,x,w){}}let Xb={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Yu{constructor(e,n){this._structArray=e,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class sr{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,n){return e._trim(),n&&n.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){let n=Object.create(this.prototype);return n.arrayBuffer=e.arrayBuffer,n.length=e.length,n.capacity=e.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function gn(i,e=1){let n=0,s=0;return{members:i.map(c=>{let f=Xb[c.type].BYTES_PER_ELEMENT,p=n=gm(n,Math.max(e,f)),y=c.components||1;return s=Math.max(s,f),n+=f*y,{name:c.name,type:c.type,components:y,offset:p}}),size:gm(n,Math.max(s,e)),alignment:e}}function gm(i,e){return Math.ceil(i/e)*e}class io extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let c=2*e;return this.int16[c+0]=n,this.int16[c+1]=s,e}}io.prototype.bytesPerElement=4,_t(io,"StructArrayLayout2i4");class yc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=3*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.int16[f+2]=c,e}}yc.prototype.bytesPerElement=6,_t(yc,"StructArrayLayout3i6");class vc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=4*e;return this.int16[p+0]=n,this.int16[p+1]=s,this.int16[p+2]=c,this.int16[p+3]=f,e}}vc.prototype.bytesPerElement=8,_t(vc,"StructArrayLayout4i8");class _l extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.float32[1*e+0]=n,e}}_l.prototype.bytesPerElement=4,_t(_l,"StructArrayLayout1f4");class _m extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=4*e,p=2*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.float32[p+1]=c,e}}_m.prototype.bytesPerElement=8,_t(_m,"StructArrayLayout2i1f8");class ym extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=4*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.int16[f+2]=c,e}}ym.prototype.bytesPerElement=8,_t(ym,"StructArrayLayout3i8");class Vh extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=5*e;return this.int16[y+0]=n,this.int16[y+1]=s,this.int16[y+2]=c,this.int16[y+3]=f,this.int16[y+4]=p,e}}Vh.prototype.bytesPerElement=10,_t(Vh,"StructArrayLayout5i10");class Uh extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=6*e,I=12*e,S=3*e;return this.int16[w+0]=n,this.int16[w+1]=s,this.uint8[I+4]=c,this.uint8[I+5]=f,this.uint8[I+6]=p,this.uint8[I+7]=y,this.float32[S+2]=x,e}}Uh.prototype.bytesPerElement=12,_t(Uh,"StructArrayLayout2i4ub1f12");class Ro extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=3*e;return this.float32[f+0]=n,this.float32[f+1]=s,this.float32[f+2]=c,e}}Ro.prototype.bytesPerElement=12,_t(Ro,"StructArrayLayout3f12");class Pa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=6*e,x=3*e;return this.uint16[y+0]=n,this.uint16[y+1]=s,this.uint16[y+2]=c,this.uint16[y+3]=f,this.float32[x+2]=p,e}}Pa.prototype.bytesPerElement=12,_t(Pa,"StructArrayLayout4ui1f12");class xc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=4*e;return this.uint16[p+0]=n,this.uint16[p+1]=s,this.uint16[p+2]=c,this.uint16[p+3]=f,e}}xc.prototype.bytesPerElement=8,_t(xc,"StructArrayLayout4ui8");class jh extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=6*e;return this.int16[x+0]=n,this.int16[x+1]=s,this.int16[x+2]=c,this.int16[x+3]=f,this.int16[x+4]=p,this.int16[x+5]=y,e}}jh.prototype.bytesPerElement=12,_t(jh,"StructArrayLayout6i12");class Hh extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D){let P=this.length;return this.resize(P+1),this.emplace(P,e,n,s,c,f,p,y,x,w,I,S,D)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P){let O=12*e;return this.int16[O+0]=n,this.int16[O+1]=s,this.int16[O+2]=c,this.int16[O+3]=f,this.uint16[O+4]=p,this.uint16[O+5]=y,this.uint16[O+6]=x,this.uint16[O+7]=w,this.int16[O+8]=I,this.int16[O+9]=S,this.int16[O+10]=D,this.int16[O+11]=P,e}}Hh.prototype.bytesPerElement=24,_t(Hh,"StructArrayLayout4i4ui4i24");class bc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=10*e,w=5*e;return this.int16[x+0]=n,this.int16[x+1]=s,this.int16[x+2]=c,this.float32[w+2]=f,this.float32[w+3]=p,this.float32[w+4]=y,e}}bc.prototype.bytesPerElement=20,_t(bc,"StructArrayLayout3i3f20");class Oa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=4*e;return this.float32[p+0]=n,this.float32[p+1]=s,this.float32[p+2]=c,this.float32[p+3]=f,e}}Oa.prototype.bytesPerElement=16,_t(Oa,"StructArrayLayout4f16");class vm extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint32[1*e+0]=n,e}}vm.prototype.bytesPerElement=4,_t(vm,"StructArrayLayout1ul4");class Ds extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let c=2*e;return this.uint16[c+0]=n,this.uint16[c+1]=s,e}}Ds.prototype.bytesPerElement=4,_t(Ds,"StructArrayLayout2ui4");class xm extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P){let O=this.length;return this.resize(O+1),this.emplace(O,e,n,s,c,f,p,y,x,w,I,S,D,P)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O){let N=20*e,B=10*e;return this.int16[N+0]=n,this.int16[N+1]=s,this.int16[N+2]=c,this.int16[N+3]=f,this.int16[N+4]=p,this.float32[B+3]=y,this.float32[B+4]=x,this.float32[B+5]=w,this.float32[B+6]=I,this.int16[N+14]=S,this.uint32[B+8]=D,this.uint16[N+18]=P,this.uint16[N+19]=O,e}}xm.prototype.bytesPerElement=40,_t(xm,"StructArrayLayout5i4f1i1ul2ui40");class Gh extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=8*e;return this.int16[w+0]=n,this.int16[w+1]=s,this.int16[w+2]=c,this.int16[w+4]=f,this.int16[w+5]=p,this.int16[w+6]=y,this.int16[w+7]=x,e}}Gh.prototype.bytesPerElement=16,_t(Gh,"StructArrayLayout3i2i2i16");class wc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=4*e,x=8*e;return this.float32[y+0]=n,this.float32[y+1]=s,this.float32[y+2]=c,this.int16[x+6]=f,this.int16[x+7]=p,e}}wc.prototype.bytesPerElement=16,_t(wc,"StructArrayLayout2f1f2i16");class Ec extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=20*e,w=5*e;return this.uint8[x+0]=n,this.uint8[x+1]=s,this.float32[w+1]=c,this.float32[w+2]=f,this.float32[w+3]=p,this.float32[w+4]=y,e}}Ec.prototype.bytesPerElement=20,_t(Ec,"StructArrayLayout2ub4f20");class dr extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,s)}emplace(e,n,s,c){let f=3*e;return this.uint16[f+0]=n,this.uint16[f+1]=s,this.uint16[f+2]=c,e}}dr.prototype.bytesPerElement=6,_t(dr,"StructArrayLayout3ui6");class Tc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G,X,q,K,he){let le=this.length;return this.resize(le+1),this.emplace(le,e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G,X,q,K,he)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G,X,q,K,he,le){let ue=30*e,ge=15*e,ye=60*e;return this.int16[ue+0]=n,this.int16[ue+1]=s,this.int16[ue+2]=c,this.float32[ge+2]=f,this.float32[ge+3]=p,this.uint16[ue+8]=y,this.uint16[ue+9]=x,this.uint32[ge+5]=w,this.uint32[ge+6]=I,this.uint32[ge+7]=S,this.uint16[ue+16]=D,this.uint16[ue+17]=P,this.uint16[ue+18]=O,this.float32[ge+10]=N,this.float32[ge+11]=B,this.uint8[ye+48]=G,this.uint8[ye+49]=X,this.uint8[ye+50]=q,this.uint32[ge+13]=K,this.int16[ue+28]=he,this.uint8[ye+58]=le,e}}Tc.prototype.bytesPerElement=60,_t(Tc,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class bm extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G,X,q,K,he,le,ue,ge,ye,ke,be,ze,et,Ue,Ze,Je,Le){let qe=this.length;return this.resize(qe+1),this.emplace(qe,e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G,X,q,K,he,le,ue,ge,ye,ke,be,ze,et,Ue,Ze,Je,Le)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G,X,q,K,he,le,ue,ge,ye,ke,be,ze,et,Ue,Ze,Je,Le,qe){let we=20*e,Fe=40*e,rt=80*e;return this.float32[we+0]=n,this.float32[we+1]=s,this.int16[Fe+4]=c,this.int16[Fe+5]=f,this.int16[Fe+6]=p,this.int16[Fe+7]=y,this.int16[Fe+8]=x,this.int16[Fe+9]=w,this.int16[Fe+10]=I,this.int16[Fe+11]=S,this.int16[Fe+12]=D,this.uint16[Fe+13]=P,this.uint16[Fe+14]=O,this.uint16[Fe+15]=N,this.uint16[Fe+16]=B,this.uint16[Fe+17]=G,this.uint16[Fe+18]=X,this.uint16[Fe+19]=q,this.uint16[Fe+20]=K,this.uint16[Fe+21]=he,this.uint16[Fe+22]=le,this.uint16[Fe+23]=ue,this.uint16[Fe+24]=ge,this.uint16[Fe+25]=ye,this.uint16[Fe+26]=ke,this.uint16[Fe+27]=be,this.uint32[we+14]=ze,this.float32[we+15]=et,this.float32[we+16]=Ue,this.float32[we+17]=Ze,this.float32[we+18]=Je,this.uint8[rt+76]=Le,this.uint16[Fe+39]=qe,e}}bm.prototype.bytesPerElement=80,_t(bm,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class wm extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,c,f,p)}emplace(e,n,s,c,f,p,y){let x=6*e;return this.float32[x+0]=n,this.float32[x+1]=s,this.float32[x+2]=c,this.float32[x+3]=f,this.float32[x+4]=p,this.float32[x+5]=y,e}}wm.prototype.bytesPerElement=24,_t(wm,"StructArrayLayout6f24");class yl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,c,f)}emplace(e,n,s,c,f,p){let y=5*e;return this.float32[y+0]=n,this.float32[y+1]=s,this.float32[y+2]=c,this.float32[y+3]=f,this.float32[y+4]=p,e}}yl.prototype.bytesPerElement=20,_t(yl,"StructArrayLayout5f20");class Em extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=7*e;return this.float32[w+0]=n,this.float32[w+1]=s,this.float32[w+2]=c,this.float32[w+3]=f,this.float32[w+4]=p,this.float32[w+5]=y,this.float32[w+6]=x,e}}Em.prototype.bytesPerElement=28,_t(Em,"StructArrayLayout7f28");class Ku extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S){let D=this.length;return this.resize(D+1),this.emplace(D,e,n,s,c,f,p,y,x,w,I,S)}emplace(e,n,s,c,f,p,y,x,w,I,S,D){let P=11*e;return this.float32[P+0]=n,this.float32[P+1]=s,this.float32[P+2]=c,this.float32[P+3]=f,this.float32[P+4]=p,this.float32[P+5]=y,this.float32[P+6]=x,this.float32[P+7]=w,this.float32[P+8]=I,this.float32[P+9]=S,this.float32[P+10]=D,e}}Ku.prototype.bytesPerElement=44,_t(Ku,"StructArrayLayout11f44");class Tm extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,s,c,f,p,y,x,w)}emplace(e,n,s,c,f,p,y,x,w,I){let S=9*e;return this.float32[S+0]=n,this.float32[S+1]=s,this.float32[S+2]=c,this.float32[S+3]=f,this.float32[S+4]=p,this.float32[S+5]=y,this.float32[S+6]=x,this.float32[S+7]=w,this.float32[S+8]=I,e}}Tm.prototype.bytesPerElement=36,_t(Tm,"StructArrayLayout9f36");class La extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let c=2*e;return this.float32[c+0]=n,this.float32[c+1]=s,e}}La.prototype.bytesPerElement=8,_t(La,"StructArrayLayout2f8");class Im extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,c){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,c)}emplace(e,n,s,c,f){let p=6*e;return this.uint32[3*e+0]=n,this.uint16[p+2]=s,this.uint16[p+3]=c,this.uint16[p+4]=f,e}}Im.prototype.bytesPerElement=12,_t(Im,"StructArrayLayout1ul3ui12");class Sm extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint16[1*e+0]=n,e}}Sm.prototype.bytesPerElement=2,_t(Sm,"StructArrayLayout1ui2");class $h extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B){let G=this.length;return this.resize(G+1),this.emplace(G,e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B)}emplace(e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G){let X=16*e;return this.float32[X+0]=n,this.float32[X+1]=s,this.float32[X+2]=c,this.float32[X+3]=f,this.float32[X+4]=p,this.float32[X+5]=y,this.float32[X+6]=x,this.float32[X+7]=w,this.float32[X+8]=I,this.float32[X+9]=S,this.float32[X+10]=D,this.float32[X+11]=P,this.float32[X+12]=O,this.float32[X+13]=N,this.float32[X+14]=B,this.float32[X+15]=G,e}}$h.prototype.bytesPerElement=64,_t($h,"StructArrayLayout16f64");class Ic extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,c,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,c,f,p,y)}emplace(e,n,s,c,f,p,y,x){let w=10*e,I=5*e;return this.uint16[w+0]=n,this.uint16[w+1]=s,this.uint16[w+2]=c,this.uint16[w+3]=f,this.float32[I+2]=p,this.float32[I+3]=y,this.float32[I+4]=x,e}}Ic.prototype.bytesPerElement=20,_t(Ic,"StructArrayLayout4ui3f20");class Dm extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.int16[1*e+0]=n,e}}Dm.prototype.bytesPerElement=2,_t(Dm,"StructArrayLayout1i2");class Wh extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint8[1*e+0]=n,e}}Wh.prototype.bytesPerElement=1,_t(Wh,"StructArrayLayout1ub1");class Cm extends Yu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Cm.prototype.size=40;class ky extends xm{get(e){return new Cm(this,e)}}_t(ky,"CollisionBoxArray");class Zh extends Yu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Zh.prototype.size=60;class Ju extends Tc{get(e){return new Zh(this,e)}}_t(Ju,"PlacedSymbolArray");class Am extends Yu{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Am.prototype.size=80;class Ny extends bm{get(e){return new Am(this,e)}}_t(Ny,"SymbolInstanceArray");class Mm extends _l{getoffsetX(e){return this.float32[1*e+0]}}_t(Mm,"GlyphOffsetArray");class zy extends io{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}_t(zy,"SymbolLineVertexArray");class qh extends Yu{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}qh.prototype.size=12;class By extends Im{get(e){return new qh(this,e)}}_t(By,"FeatureIndexArray");class Vy extends Ds{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}_t(Vy,"FillExtrusionCentroidArray");class Uy extends Yu{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Uy.prototype.size=6;class jy extends yc{get(e){return new Uy(this,e)}}_t(jy,"FillExtrusionWallArray");let Hy=gn([{name:"a_pos",components:2,type:"Int16"}],4),Yb=gn([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Kb=gn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class _r{constructor(e=[]){this.segments=e}_prepareSegment(e,n,s,c){let f=this.segments[this.segments.length-1];return e>_r.MAX_VERTEX_ARRAY_LENGTH&&fn(`Max vertices per segment is ${_r.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!f||f.vertexLength+e>_r.MAX_VERTEX_ARRAY_LENGTH||f.sortKey!==c)&&(f={vertexOffset:n,primitiveOffset:s,vertexLength:0,primitiveLength:0},c!==void 0&&(f.sortKey=c),this.segments.push(f)),f}prepareSegment(e,n,s,c){return this._prepareSegment(e,n.length,s.length,c)}get(){return this.segments}destroy(){for(let e of this.segments)for(let n in e.vaos)e.vaos[n].destroy()}static simpleSegment(e,n,s,c){return new _r([{vertexOffset:e,primitiveOffset:n,vertexLength:s,primitiveLength:c,vaos:{},sortKey:0}])}}function Gy(i,e){return 256*(i=ne(Math.floor(i),0,255))+ne(Math.floor(e),0,255)}_r.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,_t(_r,"SegmentVector");let Jb=gn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Rm=gn([{name:"a_pattern_b",components:4,type:"Uint16"}]),Qb=gn([{name:"a_dash",components:4,type:"Uint16"}]);class Qu{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,n,s,c){this.ids.push(ed(e)),this.positions.push(n,s,c)}eachPosition(e,n){let s=ed(e),c=0,f=this.ids.length-1;for(;c<f;){let p=c+f>>1;this.ids[p]>=s?f=p:c=p+1}for(;this.ids[c]===s;)n(this.positions[3*c],this.positions[3*c+1],this.positions[3*c+2]),c++}static serialize(e,n){let s=new Float64Array(e.ids),c=new Uint32Array(e.positions);return Pm(s,c,0,s.length-1),n&&(n.add(s.buffer),n.add(c.buffer)),{ids:s,positions:c}}static deserialize(e){let n=new Qu,s;n.ids=e.ids,n.positions=e.positions;for(let c of n.ids)c!==s&&n.uniqueIds.push(c),s=c;return n.indexed=!0,n}}function ed(i){let e=+i;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Kl(String(i))}function Pm(i,e,n,s){for(;n<s;){let c=i[n+s>>1],f=n-1,p=s+1;for(;;){do f++;while(i[f]<c);do p--;while(i[p]>c);if(f>=p)break;Xh(i,f,p),Xh(e,3*f,3*p),Xh(e,3*f+1,3*p+1),Xh(e,3*f+2,3*p+2)}p-n<s-p?(Pm(i,e,n,p),n=p+1):(Pm(i,e,p+1,s),s=p)}}function Xh(i,e,n){let s=i[e];i[e]=i[n],i[n]=s}_t(Qu,"FeaturePositionMap");class es{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,n),this.initialized=!0),!!this.location}set(e,n,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Yh extends es{constructor(e){super(e),this.current=0}set(e,n,s){this.fetchUniformLocation(e,n)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class Hr extends es{constructor(e){super(e),this.current=0}set(e,n,s){this.fetchUniformLocation(e,n)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class Cs extends es{constructor(e){super(e),this.current=[0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class Sc extends es{constructor(e){super(e),this.current=[0,0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class td extends es{constructor(e){super(e),this.current=[0,0,0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class Om extends es{constructor(e){super(e),this.current=Ln.transparent.toPremultipliedRenderColor(null)}set(e,n,s){this.fetchUniformLocation(e,n)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}let $y=new Float32Array(16);class nd extends es{constructor(e){super(e),this.current=$y}set(e,n,s){if(this.fetchUniformLocation(e,n)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let c=1;c<16;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}let e1=new Float32Array(9),Wy=new Float32Array(4);class Lm extends es{constructor(e){super(e),this.current=Wy}set(e,n,s){if(this.fetchUniformLocation(e,n)){for(let c=0;c<4;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function Fm(i){return[Gy(255*i.r,255*i.g),Gy(255*i.b,255*i.a)]}class rd{constructor(e,n,s,c){this.value=e,this.uniformNames=n.map(f=>`u_${f}`),this.type=s,this.context=c}setUniform(e,n,s,c,f){let p=c.constantOr(this.value);n.set(e,f,p instanceof Ln?p.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):p)}getBinding(e,n){return this.type==="color"?new Om(e):new Hr(e)}}class Dc{constructor(e,n){this.uniformNames=n.map(s=>`u_${s}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,n){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=n?n.tl.concat(n.br):this.pattern}setUniform(e,n,s,c,f){let p=null;f!=="u_pattern"&&f!=="u_dash"||(p=this.pattern),f==="u_pattern_b"&&(p=this.patternTransition),f==="u_pixel_ratio"&&(p=this.pixelRatio),p&&n.set(e,f,p)}getBinding(e,n){return n==="u_pattern"||n==="u_pattern_b"||n==="u_dash"?new td(e):new Hr(e)}}class Ws{constructor(e,n,s,c){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=n.map(f=>({name:`a_${f}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new c}populatePaintArray(e,n,s,c,f,p,y,x){let w=this.paintVertexArray.length,I=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new jn(0,{brightness:p,worldview:x}),n,{},f,c,y):this.expression.kind==="constant"&&this.expression.value,S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new jn(0,{brightness:p,worldview:x}),n,{},f,c,y):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(w,e,I,S?null:this.context.lut)}updatePaintArray(e,n,s,c,f,p,y,x){let w=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:y,worldview:x},s,c,void 0,f):this.expression.kind==="constant"&&this.expression.value,I=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new jn(0,{brightness:y,worldview:x}),s,c,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,n,w,I?null:this.context.lut)}_setPaintValue(e,n,s,c){if(this.type==="color"){let f=Fm(s.toPremultipliedRenderColor(c));for(let p=e;p<n;p++)this.paintVertexArray.emplace(p,f[0],f[1])}else{for(let f=e;f<n;f++)this.paintVertexArray.emplace(f,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ts{constructor(e,n,s,c,f,p){this.expression=e,this.uniformNames=n.map(y=>`u_${y}_t`),this.type=s,this.useIntegerZoom=c,this.context=f,this.maxValue=0,this.paintVertexAttributes=n.map(y=>({name:`a_${y}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new p}populatePaintArray(e,n,s,c,f,p,y,x){let w=this.expression.evaluate(new jn(this.context.zoom,{brightness:p,worldview:x}),n,{},f,c,y),I=this.expression.evaluate(new jn(this.context.zoom+1,{brightness:p,worldview:x}),n,{},f,c,y),S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new jn(0,{brightness:p,worldview:x}),n,{},f,c,y):this.lutExpression.value)==="none",D=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(D,e,w,I,S?null:this.context.lut)}updatePaintArray(e,n,s,c,f,p,y,x){let w=this.expression.evaluate({zoom:this.context.zoom,brightness:y,worldview:x},s,c,void 0,f),I=this.expression.evaluate({zoom:this.context.zoom+1,brightness:y,worldview:x},s,c,void 0,f),S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new jn(0,{brightness:y,worldview:x}),s,c,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,n,w,I,S?null:this.context.lut)}_setPaintValue(e,n,s,c,f){if(this.type==="color"){let p=Fm(s.toPremultipliedRenderColor(f)),y=Fm(s.toPremultipliedRenderColor(f));for(let x=e;x<n;x++)this.paintVertexArray.emplace(x,p[0],p[1],y[0],y[1])}else{for(let p=e;p<n;p++)this.paintVertexArray.emplace(p,s,c);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(c))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,n,s,c,f){let p=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,y=ne(this.expression.interpolationFactor(p,this.context.zoom,this.context.zoom+1),0,1);n.set(e,f,y)}getBinding(e,n){return new Hr(e)}}class Po{constructor(e,n,s,c,f){this.expression=e,this.layerId=f,this.paintVertexAttributes=(s==="array"?Qb:Jb).members;for(let p=0;p<n.length;++p);this.paintVertexArray=new c,this.paintTransitionVertexArray=new xc}populatePaintArray(e,n,s,c){let f=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(f,e,n.patterns&&n.patterns[this.layerId],s)}updatePaintArray(e,n,s,c,f,p,y){this._setPaintValues(e,n,s.patterns&&s.patterns[this.layerId],p)}_setPaintValues(e,n,s,c){if(!c||!s)return;let f=c[s[0]],p=c[s[1]];if(f){if(f){let{tl:y,br:x,pixelRatio:w}=f;for(let I=e;I<n;I++)this.paintVertexArray.emplace(I,y[0],y[1],x[0],x[1],w)}if(p){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);let{tl:y,br:x}=p;for(let w=e;w<n;w++)this.paintTransitionVertexArray.emplace(w,y[0],y[1],x[0],x[1])}}}upload(e){let n=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,n)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Rm.members,n))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class ji{constructor(e,n,s=()=>!0){this.binders={},this._buffers=[],this.context=n;let c=[];for(let f in e.paint._values){let p=e.paint.get(f);if(f.endsWith("-use-theme")||!s(f)||!(p instanceof gl&&Ch(p.property.specification)))continue;let y=n1(f,e.type),x=p.value,w=p.property.specification.type,I=!!p.property.useIntegerZoom,S=f==="line-dasharray"||f.endsWith("pattern"),D=e.paint.get(`${f}-use-theme`),P=f==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||D&&D.value.kind!=="constant";if(x.kind!=="constant"||P)if(x.kind==="source"||P||S){let O=Zy(f,w,"source");this.binders[f]=S?new Po(x,y,w,O,e.id):new Ws(x,y,w,O),c.push(`/a_${f}`)}else{let O=Zy(f,w,"composite");this.binders[f]=new ts(x,y,w,I,n,O),c.push(`/z_${f}`)}else this.binders[f]=S?new Dc(x.value,y):new rd(x.value,y,w,n),c.push(`/u_${f}`);D&&(this.binders[f].lutExpression=D.value)}this.cacheKey=c.sort().join("")}getMaxValue(e){let n=this.binders[e];return n instanceof Ws||n instanceof ts?n.maxValue:0}populatePaintArrays(e,n,s,c,f,p,y,x){for(let w in this.binders){let I=this.binders[w];I.context=this.context,(I instanceof Ws||I instanceof ts||I instanceof Po)&&I.populatePaintArray(e,n,s,c,f,p,y,x)}}setConstantPatternPositions(e,n){for(let s in this.binders){let c=this.binders[s];c instanceof Dc&&c.setConstantPatternPositions(e,n)}}getPatternTransitionVertexBuffer(e){let n=this.binders[e];return n instanceof Po?n.paintTransitionVertexBuffer:null}updatePaintArrays(e,n,s,c,f,p,y,x,w,I){let S=!1,D=Object.keys(e),P=D.length!==0&&!x,O=P?D:n.uniqueIds;this.context.lut=f.lut;for(let N in this.binders){let B=this.binders[N];if(B.context=this.context,(B instanceof Ws||B instanceof ts||B instanceof Po)&&B.expression&&B.expression.kind&&B.expression.kind!=="constant"&&(B.expression.isStateDependent===!0||B.expression.isLightConstant===!1)){let G=f.paint.get(N);B.expression=G.value;for(let X of O){let q=e[X.toString()];n.eachPosition(X,(K,he,le)=>{let ue=c.feature(K);B.updatePaintArray(he,le,ue,q,p,y,w,I)})}if(!P)for(let X of s.uniqueIds){let q=e[X.toString()];s.eachPosition(X,(K,he,le)=>{let ue=c.feature(K);B.updatePaintArray(he,le,ue,q,p,y,w,I)})}S=!0}}return S}defines(){let e=[];for(let n in this.binders){let s=this.binders[n];(s instanceof rd||s instanceof Dc)&&e.push(...s.uniformNames.map(c=>`#define HAS_UNIFORM_${c}`))}return e}getBinderAttributes(){let e=[];for(let n in this.binders){let s=this.binders[n];if(s instanceof Ws||s instanceof ts||s instanceof Po)for(let c=0;c<s.paintVertexAttributes.length;c++)e.push(s.paintVertexAttributes[c].name);if(s instanceof Po)for(let c=0;c<Rm.members.length;c++)e.push(Rm.members[c].name)}return e}getBinderUniforms(){let e=[];for(let n in this.binders){let s=this.binders[n];if(s instanceof rd||s instanceof Dc||s instanceof ts)for(let c of s.uniformNames)e.push(c)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){let n=[];for(let s in this.binders){let c=this.binders[s];if(c instanceof rd||c instanceof Dc||c instanceof ts)for(let f of c.uniformNames)n.push({name:f,property:s,binding:c.getBinding(e,f)})}return n}setUniforms(e,n,s,c,f){for(let{name:p,property:y,binding:x}of s)this.binders[y].setUniform(e,x,f,c.get(y),p)}updatePaintBuffers(){this._buffers=[];for(let e in this.binders){let n=this.binders[e];(n instanceof Ws||n instanceof ts||n instanceof Po)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer),n instanceof Po&&n.paintTransitionVertexBuffer&&this._buffers.push(n.paintTransitionVertexBuffer)}}upload(e){for(let n in this.binders){let s=this.binders[n];(s instanceof Ws||s instanceof ts||s instanceof Po)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(let e in this.binders){let n=this.binders[e];(n instanceof Ws||n instanceof ts||n instanceof Po)&&n.destroy()}}}class Oo{constructor(e,n,s=()=>!0){this.programConfigurations={};for(let c of e)this.programConfigurations[c.id]=new ji(c,n,s);this.needsUpload=!1,this._featureMap=new Qu,this._featureMapWithoutIds=new Qu,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,n,s,c,f,p,y,x,w){for(let I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(e,n,c,f,p,y,x,w);n.id!==void 0?this._featureMap.add(n.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,n,s,c,f,p,y,x){for(let w of s)this.needsUpload=this.programConfigurations[w.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,n,w,c,f,p,y||0,x)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(let n in this.programConfigurations)this.programConfigurations[n].upload(e);this.needsUpload=!1}}destroy(){for(let e in this.programConfigurations)this.programConfigurations[e].destroy()}}let t1={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function n1(i,e){return t1[i]||[i.replace(`${e}-`,"").replace(/-/g,"_")]}let r1={"line-pattern":{source:Pa,composite:Pa},"fill-pattern":{source:Pa,composite:Pa},"fill-extrusion-pattern":{source:Pa,composite:Pa},"line-dasharray":{source:xc,composite:xc}},i1={color:{source:La,composite:Oa},number:{source:_l,composite:La}};function Zy(i,e,n){let s=r1[i];return s&&s[n]||i1[e][n]}_t(rd,"ConstantBinder"),_t(Dc,"PatternConstantBinder"),_t(Ws,"SourceExpressionBinder"),_t(Po,"PatternCompositeBinder"),_t(ts,"CompositeExpressionBinder"),_t(ji,"ProgramConfiguration",{omit:["_buffers"]}),_t(Oo,"ProgramConfigurationSet");let Fi=st/Math.PI/2,qy=5,d=6,t=16383,o=64,h=[o,32,16],g=-Fi,_=Fi;function v(i,e,n,s=Fi){return n=Sn(n),[i*Math.sin(n)*s,-e*s,i*Math.cos(n)*s]}function E(i,e,n){return v(Math.cos(Sn(i)),Math.sin(Sn(i)),e,n)}let T=63710088e-1,C=2*Math.PI*T;class A{constructor(e,n){if(isNaN(e)||isNaN(n))throw new Error(`Invalid LngLat object: (${e}, ${n})`);if(this.lng=+e,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new A(Me(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){let n=Math.PI/180,s=this.lat*n,c=e.lat*n,f=Math.sin(s)*Math.sin(c)+Math.cos(s)*Math.cos(c)*Math.cos((e.lng-this.lng)*n);return T*Math.acos(Math.min(f,1))}toBounds(e=0){let n=360*e/40075017,s=n/Math.cos(Math.PI/180*this.lat);return new L({lng:this.lng-s,lat:this.lat-n},{lng:this.lng+s,lat:this.lat+n})}toEcef(e){return E(this.lat,this.lng,Fi+e*Fi/T)}static convert(e){if(e instanceof A)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new A(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new A(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class L{constructor(e,n){if(e)if(n)this.setSouthWest(e).setNorthEast(n);else if(e.length===4){let s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{let s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof A?new A(e.lng,e.lat):A.convert(e),this}setSouthWest(e){return this._sw=e instanceof A?new A(e.lng,e.lat):A.convert(e),this}extend(e){let n=this._sw,s=this._ne,c,f;if(e instanceof A)c=e,f=e;else{if(!(e instanceof L))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(L.convert(e)):this.extend(A.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(A.convert(e)):this;if(c=e._sw,f=e._ne,!c||!f)return this}return n||s?(n.lng=Math.min(c.lng,n.lng),n.lat=Math.min(c.lat,n.lat),s.lng=Math.max(f.lng,s.lng),s.lat=Math.max(f.lat,s.lat)):(this._sw=new A(c.lng,c.lat),this._ne=new A(f.lng,f.lat)),this}getCenter(){return new A((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new A(this.getWest(),this.getNorth())}getSouthEast(){return new A(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){let{lng:n,lat:s}=A.convert(e),c=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(c=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&c}static convert(e){if(e)return e instanceof L?e:new L(e)}}let R=0,F=25.5;function V(i){return C*Math.cos(i*Math.PI/180)}function z(i){return(180+i)/360}function H(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function j(i,e){return i/V(e)}function Z(i){return 360*i-180}function Y(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}function J(i,e){return i*V(Y(e))}let re=85.051129;function ce(i){return Math.cos(Sn(ne(i,-re,re)))}function de(i,e){let n=ne(e,R,F),s=Math.pow(2,n);return ce(i)*C/(512*s)}function ie(i){return 1/Math.cos(i*Math.PI/180)}function oe(i,e=0){let n=Math.exp(Math.PI*(1-(i.y+e/st)/(1<<i.z)*2));return 80150034*n/(n*n+1)/st/(1<<i.z)}class se{constructor(e,n,s=0){this.x=+e,this.y=+n,this.z=+s}static fromLngLat(e,n=0){let s=A.convert(e);return new se(z(s.lng),H(s.lat),j(n,s.lat))}toLngLat(){return new A(Z(this.x),Y(this.y))}toAltitude(){return J(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/C*ie(Y(this.y))}}function Te(i,e,n,s,c,f,p,y,x){let w=(e+s)/2,I=(n+c)/2,S=new Xe(w,I);y(S),function(D,P,O,N,B,G){let X=O-B,q=N-G;return Math.abs((N-P)*X-(O-D)*q)/Math.hypot(X,q)}(S.x,S.y,f.x,f.y,p.x,p.y)>=x?(Te(i,e,n,w,I,f,S,y,x),Te(i,w,I,s,c,S,p,y,x)):i.push(p)}function me(i,e,n){let s=i[0],c=s.x,f=s.y;e(s);let p=[s];for(let y=1;y<i.length;y++){let x=i[y],{x:w,y:I}=x;e(x),Te(p,c,f,w,I,s,x,e,n),c=w,f=I,s=x}return p}function Ne(i,e,n,s){if(s(e,n)){let c=e.add(n)._mult(.5);Ne(i,e,c,s),Ne(i,c,n,s)}else i.push(n)}function Ae(i,e){let n=i[0],s=[n];for(let c=1;c<i.length;c++){let f=i[c];Ne(s,n,f,e),n=f}return s}let Ve=Math.pow(2,14)-1,Qe=-Ve-1;function Ie(i,e){let n=Math.round(i.x*e),s=Math.round(i.y*e);return i.x=ne(n,Qe,Ve),i.y=ne(s,Qe,Ve),(n<i.x||n>i.x+1||s<i.y||s>i.y+1)&&fn("Geometry exceeds allowed extent, reduce your vector tile buffer size"),i}function pe(i,e,n){let s=i.loadGeometry(),c=i.extent,f=st/c;if(e&&n&&n.projection.isReprojectedInTileSpace){let p=1<<e.z,{scale:y,x,y:w,projection:I}=n,S=D=>{let P=Z((e.x+D.x/c)/p),O=Y((e.y+D.y/c)/p),N=I.project(P,O);D.x=(N.x*y-x)*c,D.y=(N.y*y-w)*c};for(let D=0;D<s.length;D++)if(i.type!==1)s[D]=me(s[D],S,1);else{let P=[];for(let O of s[D])O.x<0||O.x>=c||O.y<0||O.y>=c||(S(O),P.push(O));s[D]=P}}for(let p of s)for(let y of p)Ie(y,f);return s}function Pe(i,e){return{type:i.type,id:i.id,properties:i.properties,geometry:e?pe(i):[]}}class Se{constructor(e,n,s,c,f){this.properties={},this.extent=s,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=c,this._values=f,e.readFields(He,this,n)}loadGeometry(){let e=this._pbf;e.pos=this._geometry;let n=e.readVarint()+e.pos,s=[],c,f=1,p=0,y=0,x=0;for(;e.pos<n;){if(p<=0){let w=e.readVarint();f=7&w,p=w>>3}if(p--,f===1||f===2)y+=e.readSVarint(),x+=e.readSVarint(),f===1&&(c&&s.push(c),c=[]),c&&c.push(new Xe(y,x));else{if(f!==7)throw new Error(`unknown command ${f}`);c&&c.push(c[0].clone())}}return c&&s.push(c),s}bbox(){let e=this._pbf;e.pos=this._geometry;let n=e.readVarint()+e.pos,s=1,c=0,f=0,p=0,y=1/0,x=-1/0,w=1/0,I=-1/0;for(;e.pos<n;){if(c<=0){let S=e.readVarint();s=7&S,c=S>>3}if(c--,s===1||s===2)f+=e.readSVarint(),p+=e.readSVarint(),f<y&&(y=f),f>x&&(x=f),p<w&&(w=p),p>I&&(I=p);else if(s!==7)throw new Error(`unknown command ${s}`)}return[y,w,x,I]}toGeoJSON(e,n,s){let c=this.extent*Math.pow(2,s),f=this.extent*e,p=this.extent*n,y=this.loadGeometry();function x(D){return[360*(D.x+f)/c-180,360/Math.PI*Math.atan(Math.exp((1-2*(D.y+p)/c)*Math.PI))-90]}function w(D){return D.map(x)}let I;if(this.type===1){let D=[];for(let O of y)D.push(O[0]);let P=w(D);I=D.length===1?{type:"Point",coordinates:P[0]}:{type:"MultiPoint",coordinates:P}}else if(this.type===2){let D=y.map(w);I=D.length===1?{type:"LineString",coordinates:D[0]}:{type:"MultiLineString",coordinates:D}}else{if(this.type!==3)throw new Error("unknown feature type");{let D=function(O){let N=O.length;if(N<=1)return[O];let B=[],G,X;for(let q=0;q<N;q++){let K=Ge(O[q]);K!==0&&(X===void 0&&(X=K<0),X===K<0?(G&&B.push(G),G=[O[q]]):G&&G.push(O[q]))}return G&&B.push(G),B}(y),P=[];for(let O of D)P.push(O.map(w));I=P.length===1?{type:"Polygon",coordinates:P[0]}:{type:"MultiPolygon",coordinates:P}}}let S={type:"Feature",geometry:I,properties:this.properties};return this.id!=null&&(S.id=this.id),S}}function He(i,e,n){i===1?e.id=n.readVarint():i===2?function(s,c){let f=s.readVarint()+s.pos;for(;s.pos<f;){let p=c._keys[s.readVarint()],y=c._values[s.readVarint()];c.properties[p]=y}}(n,e):i===3?e.type=n.readVarint():i===4&&(e._geometry=n.pos)}function Ge(i){let e=0;for(let n,s,c=0,f=i.length,p=f-1;c<f;p=c++)n=i[c],s=i[p],e+=(s.x-n.x)*(n.y+s.y);return e}Se.types=["Unknown","Point","LineString","Polygon"];class We{constructor(e,n){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(ot,this,n),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];let n=this._pbf.readVarint()+this._pbf.pos;return new Se(this._pbf,n,this.extent,this._keys,this._values)}}function ot(i,e,n){i===15?e.version=n.readVarint():i===1?e.name=n.readString():i===5?e.extent=n.readVarint():i===2?e._features.push(n.pos):i===3?e._keys.push(n.readString()):i===4&&e._values.push(function(s){let c=null,f=s.readVarint()+s.pos;for(;s.pos<f;){let p=s.readVarint()>>3;c=p===1?s.readString():p===2?s.readFloat():p===3?s.readDouble():p===4?s.readVarint64():p===5?s.readVarint():p===6?s.readSVarint():p===7?s.readBoolean():null}if(c==null)throw new Error("unknown feature value");return c}(n))}class bt{constructor(e,n){this.layers=e.readFields(St,{},n)}}function St(i,e,n){if(i===3){let s=new We(n,n.readVarint()+n.pos);s.length&&(e[s.name]=s)}}let ft="3d_elevation_id",Tt="level";class wt{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,n){return this._valid&&e(n(this._geometry)),this}require(e,n,s){return this.get(e,!0,n,s)}optional(e,n,s){return this.get(e,!1,n,s)}success(){return this._valid}get(e,n,s,c){let f=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&f!==void 0&&!Number.isNaN(f)?s(c?c(f):f):n&&(this._valid=!1),this}}class zt{constructor(e,n){this.featureFunc=e,this.vertexFunc=n}parseFeature(e,n,s){return this.featureFunc(e,n,s)}parseVertex(e,n,s){return this.vertexFunc(e,n,s)}}let Wt=new zt((i,e,n)=>i.reset(e).require(ft,s=>{n.id=s}).optional("fixed_height_relative",s=>{n.constantHeight=s},bn.decodeRelativeHeight).geometry(s=>{n.bounds=s},Mp).success(),(i,e,n)=>i.reset(e).require(ft,s=>{n.id=s}).require("elevation_idx",s=>{n.idx=s}).require("extent",s=>{n.extent=s}).require("height_relative",s=>{n.height=s},bn.decodeRelativeHeight).geometry(s=>{n.position=s},bn.getPoint).success()),on=new zt((i,e,n)=>i.reset(e).require(ft,s=>{n.id=s}).optional("fixed_height",s=>{n.constantHeight=s},bn.decodeMetricHeight).geometry(s=>{n.bounds=s},Mp).success(),(i,e,n)=>i.reset(e).require(ft,s=>{n.id=s}).require("elevation_idx",s=>{n.idx=s}).require("extent",s=>{n.extent=s}).require("height",s=>{n.height=s},bn.decodeMetricHeight).geometry(s=>{n.position=s},bn.getPoint).success());class bn{static getPoint(e){return Io(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){let n=[],s=[],c=e.length,f=new wt;for(let y=0;y<c;y++){let x=e.feature(y),w=x.properties.version,I=(p=w)?p==="1.0.1"?on:void 0:Wt;if(I===void 0){fn(`Unknown elevation feature version number ${w||"(unknown)"}`);continue}let S=x.properties.hasOwnProperty("type")?x.properties.type:void 0;if(S){if(Se.types[x.type]==="Point"&&S==="curve_point"){let D={};I.parseVertex(f,x,D)&&n.push(D)}else if(Se.types[x.type]==="Polygon"&&S==="curve_meta"){let D={};I.parseFeature(f,x,D)&&s.push(D)}}}var p;return{vertices:n,features:s}}}class Ht{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,s){let c=ur(n,this.dir);if(Math.abs(c)<1e-6)return!1;let f=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1])/c;return s[0]=this.pos[0]+this.dir[0]*f,s[1]=this.pos[1]+this.dir[1]*f,!0}}class wn{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,s){let c=kr(n,this.dir);if(Math.abs(c)<1e-6)return!1;let f=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1]+(e[2]-this.pos[2])*n[2])/c;return s[0]=this.pos[0]+this.dir[0]*f,s[1]=this.pos[1]+this.dir[1]*f,s[2]=this.pos[2]+this.dir[2]*f,!0}closestPointOnSphere(e,n,s){if(function(P,O){var N=P[0],B=P[1],G=P[2],X=O[0],q=O[1],K=O[2];return Math.abs(N-X)<=M*Math.max(1,Math.abs(N),Math.abs(X))&&Math.abs(B-q)<=M*Math.max(1,Math.abs(B),Math.abs(q))&&Math.abs(G-K)<=M*Math.max(1,Math.abs(G),Math.abs(K))}(this.pos,e)||n===0)return s[0]=s[1]=s[2]=0,!1;let[c,f,p]=this.dir,y=this.pos[0]-e[0],x=this.pos[1]-e[1],w=this.pos[2]-e[2],I=c*c+f*f+p*p,S=2*(y*c+x*f+w*p),D=S*S-4*I*(y*y+x*x+w*w-n*n);if(D<0){let P=Math.max(-S/2,0),O=y+c*P,N=x+f*P,B=w+p*P,G=Math.hypot(O,N,B);return s[0]=O*n/G,s[1]=N*n/G,s[2]=B*n/G,!1}{let P=(-S-Math.sqrt(D))/(2*I);if(P<0){let O=Math.hypot(y,x,w);return s[0]=y*n/O,s[1]=x*n/O,s[2]=w*n/O,!1}return s[0]=y+c*P,s[1]=x+f*P,s[2]=w+p*P,!0}}}class Dn{constructor(e,n,s,c,f){this.TL=e,this.TR=n,this.BR=s,this.BL=c,this.horizon=f}static fromInvProjectionMatrix(e,n,s){let c=[-1,1,1],f=[1,1,1],p=[1,-1,1],y=[-1,-1,1],x=Nr(c,c,e),w=Nr(f,f,e),I=Nr(p,p,e),S=Nr(y,y,e);return new Dn(x,w,I,S,n/s)}}function Xn(i,e,n){let s=1/0,c=-1/0,f=[];for(let p of i){zr(f,p,e);let y=kr(f,n);s=Math.min(s,y),c=Math.max(c,y)}return[s,c]}function tn(i,e){let n=!0;for(let s=0;s<i.planes.length;s++){let c=i.planes[s],f=0;for(let p=0;p<e.length;p++)f+=kr(c,e[p])+c[3]>=0;if(f===0)return 0;f!==e.length&&(n=!1)}return n?2:1}function En(i,e){for(let n of i.projections){let s=Xn(e,i.points[0],n.axis);if(n.projection[1]<s[0]||n.projection[0]>s[1])return 0}return 1}function Tn(i,e){let n=0,s=[0,0,0,0];for(let p=0;p<i.length;p++)s[0]=i[p][0],s[1]=i[p][1],s[2]=i[p][2],s[3]=1,(c=s)[0]*(f=e)[0]+c[1]*f[1]+c[2]*f[2]+c[3]*f[3]>=0&&n++;var c,f;return n}class Mn{constructor(e,n){this.points=e||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=sn.fromPoints(this.points),this.projections=[],this.frustumEdges=[zr([],this.points[2],this.points[3]),zr([],this.points[0],this.points[3]),zr([],this.points[4],this.points[0]),zr([],this.points[5],this.points[1]),zr([],this.points[6],this.points[2]),zr([],this.points[7],this.points[3])];for(let s of this.frustumEdges){let c=[0,-s[2],s[1]],f=[s[2],0,-s[0]];this.projections.push({axis:c,projection:Xn(this.points,this.points[0],c)}),this.projections.push({axis:f,projection:Xn(this.points,this.points[0],f)})}}static fromInvProjectionMatrix(e,n,s,c){let f=Math.pow(2,s),p=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(w=>{let I=ho([],w,e),S=1/I[3]/n*f;return(D=I)[0]=(P=I)[0]*(O=[S,S,c?1/I[3]:S,S])[0],D[1]=P[1]*O[1],D[2]=P[2]*O[2],D[3]=P[3]*O[3],D;var D,P,O}),y=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(w=>{let I=cr([],qr([],zr([],p[w[0]],p[w[1]]),zr([],p[w[2]],p[w[1]]))),S=-kr(I,p[w[1]]);return I.concat(S)}),x=[];for(let w=0;w<p.length;w++)x.push([p[w][0],p[w][1],p[w][2]]);return new Mn(x,y)}intersectsPrecise(e,n,s){for(let c=0;c<n.length;c++)if(!Tn(e,n[c]))return 0;for(let c=0;c<this.planes.length;c++)if(!Tn(e,this.planes[c]))return 0;for(let c of s)for(let f of this.frustumEdges){let p=qr([],c,f),y=Ei(p);if(y===0)continue;hr(p,p,1/y);let x=Xn(this.points,this.points[0],p),w=Xn(e,this.points[0],p);if(x[0]>w[1]||w[0]>x[1])return 0}return 1}containsPoint(e){for(let n of this.planes){let s=n[3];if(kr([n[0],n[1],n[2]],e)+s<0)return!1}return!0}}class sn{static fromPoints(e){let n=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(let c of e)Os(n,n,c),Zo(s,s,c);return new sn(n,s)}static fromTileIdAndHeight(e,n,s){let c=1<<e.canonical.z,f=e.canonical.x,p=e.canonical.y;return new sn([f/c,p/c,n],[(f+1)/c,(p+1)/c,s])}static applyTransform(e,n){let s=e.getCorners();for(let c=0;c<s.length;++c)Nr(s[c],s[c],n);return sn.fromPoints(s)}static applyTransformFast(e,n){let s=[n[12],n[13],n[14]],c=[...s];for(let f=0;f<3;f++)for(let p=0;p<3;p++){let y=n[4*p+f],x=y*e.min[p],w=y*e.max[p];s[f]+=Math.min(x,w),c[f]+=Math.max(x,w)}return new sn(s,c)}static projectAabbCorners(e,n){let s=e.getCorners();for(let c=0;c<s.length;++c)Nr(s[c],s[c],n);return s}constructor(e,n){this.min=e,this.max=n,this.center=hr([],mr([],this.min,this.max),.5)}quadrant(e){let n=[e%2==0,e<2],s=Ul(this.min),c=Ul(this.max);for(let f=0;f<n.length;f++)s[f]=n[f]?this.min[f]:this.center[f],c[f]=n[f]?this.center[f]:this.max[f];return c[2]=this.max[2],new sn(s,c)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){let e=this.min,n=this.max;return[[e[0],e[1],e[2]],[n[0],e[1],e[2]],[n[0],n[1],e[2]],[e[0],n[1],e[2]],[e[0],e[1],n[2]],[n[0],e[1],n[2]],[n[0],n[1],n[2]],[e[0],n[1],n[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?tn(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?tn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,n){return n||this.intersects(e)?En(e,this.getCorners()):0}intersectsPreciseFlat(e,n){return n||this.intersectsFlat(e)?En(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let n=0;n<3;++n)if(this.min[n]>e.max[n]||e.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e.min[n]),this.max[n]=Math.max(this.max[n],e.max[n])}encapsulatePoint(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e[n]),this.max[n]=Math.max(this.max[n],e[n])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}_t(sn,"Aabb");class Bn{constructor(e,n){this.feature=e,this.metersToTile=n,this.index=0}get(){let e=this.feature.vertices[this.index],n=this.feature.vertexProps[this.index].dir,s=n[1],c=-n[0],f=(e.extent+1)*this.metersToTile;return[new Xe(Math.trunc(e.position[0]+s*f),Math.trunc(e.position[1]+c*f)),new Xe(Math.trunc(e.position[0]-s*f),Math.trunc(e.position[1]-c*f))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Cn{constructor(e,n,s,c,f,p){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:s,max:s},this.safeArea=n,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||c.length!==0)){this.vertices=c,this.edges=f,this.edges=this.edges.filter(y=>{return y.a<this.vertices.length&&y.b<this.vertices.length&&!((x=this.vertices[y.a].position)[0]===(w=this.vertices[y.b].position)[0]&&x[1]===w[1]);var x,w}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let y of this.vertices)this.vertexProps.push({dir:Io(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,y.height),this.heightRange.max=Math.max(this.heightRange.max,y.height);for(let y of this.edges){let x=this.vertices[y.a].position,w=this.vertices[y.b].position,I=zs(Mi(),w,x),S=ma(I),D=pa(Mi(),I,1/S);this.edgeProps.push({vec:I,dir:D,len:S});let P=this.vertexProps[y.a].dir,O=this.vertexProps[y.b].dir;fa(P,P,D),fa(O,O,D)}for(let y of this.vertexProps)y.dir[0]===0&&y.dir[1]===0||$l(y.dir,y.dir);this.tessellate(p)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;let n=this.getClosestEdge(e);if(n==null)return 0;let[s,c]=n;return At(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,c)}computeSlopeNormal(e,n){let s=this.getClosestEdge(e);if(!s)return Zr(0,0,1);let c=s[0],f=this.edges[c],p=this.edgeProps[c].vec,y=Zr(p[0],p[1],(this.vertices[f.b].height-this.vertices[f.a].height)*n),x=Zr(y[1],-y[0],0);qr(x,x,y);let w=Ei(x);return w>0?hr(x,x,1/w):Zr(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let n=0,s=Number.POSITIVE_INFINITY,c=0,f=Io(e.x,e.y);for(let p=0;p<this.edges.length;p++){let y=this.edges[p],x=this.edgeProps[p].dir,w=new Ht(f,this.edgeProps[p].dir),I=this.vertices[y.a].position,S=this.vertices[y.b].position,D=Mi(),P=Mi(),O=w.intersectsPlane(I,this.vertexProps[y.a].dir,D),N=w.intersectsPlane(S,this.vertexProps[y.b].dir,P);if(!O||!N)continue;let B=zs(Mi(),P,D),G=zs(Mi(),f,D),X=ur(B,B),q=X>0?ur(G,B)/X:0,K=ne(q,0,1),he=Math.abs((q-K)*this.edgeProps[p].len),le=zs(Mi(),f,I),ue=he+Math.abs(ur(le,Io(x[1],-x[0])));ue<s&&(n=p,s=ue,c=K)}return[n,c]}tessellate(e){for(let n=this.edges.length-1;n>=0;--n){let s=this.edges[n].a,c=this.edges[n].b,{position:f,height:p,extent:y}=this.vertices[s],{position:x,height:w,extent:I}=this.vertices[c],S=this.vertexProps[s].dir,D=this.vertexProps[c].dir,P=Zr(f[0]/e,f[1]/e,p),O=Zr(x[0]/e,x[1]/e,w),N=Zr(S[1],-S[0],0);hr(N,N,y);let B=Zr(D[1],-D[0],0);if(hr(B,B,I),this.distSqLines(Zr(P[0]+.5*N[0],P[1]+.5*N[1],P[2]+.5*N[2]),Zr(O[0]-.5*B[0],O[1]-.5*B[1],O[2]-.5*B[2]),Zr(P[0]-.5*N[0],P[1]-.5*N[1],P[2]-.5*N[2]),Zr(O[0]+.5*B[0],O[1]+.5*B[1],O[2]+.5*B[2]))<=.0025000000000000005)continue;let G=this.vertices.length,X=fa(Mi(),f,x);this.vertices.push({position:pa(X,X,.5),height:.5*(p+w),extent:.5*(y+I)});let q=fa(Mi(),S,D);this.vertexProps.push({dir:$l(q,q)}),this.edges.splice(n,1),this.edgeProps.splice(n,1),this.edges.push({a:s,b:G}),this.edges.push({a:G,b:c});let K=zs(Mi(),this.vertices[G].position,f),he=ma(K),le={vec:K,dir:pa(Mi(),K,1/he),len:he};this.edgeProps.push(le),this.edgeProps.push(le)}}distSqLines(e,n,s,c){let f=uo(zn(),n,e),p=uo(zn(),c,s),y=uo(zn(),e,s),x=kr(f,f),w=kr(f,p),I=kr(f,y),S=kr(p,p),D=kr(p,y),P=x*S-w*w;if(P===0){let B=kr(y,p)/kr(p,p);return jl(Yi(zn(),s,c,B),e)}let O=(w*D-I*S)/P,N=(x*D-w*I)/P;return jl(Yi(zn(),e,n,O),Yi(zn(),s,c,N))}}class yr{static parseFrom(e,n){let s=bn.parse(e);if(!s)return[];let{vertices:c,features:f}=s,p=1/oe(n);f.sort((I,S)=>I.id-S.id),c.sort((I,S)=>I.id-S.id||I.idx-S.idx),c=c.filter((I,S,D)=>S===D.findIndex(P=>P.id===I.id&&P.idx===I.idx));let y=new Array,x=0,w=c.length;for(let I of f){if(I.constantHeight){y.push(new Cn(I.id,I.bounds,I.constantHeight));continue}for(;x!==w&&c[x].id<I.id;)x++;if(x===w||c[x].id!==I.id)continue;let S=new Array,D=new Array,P=x;for(;x!==w&&c[x].id===I.id;){let O=c[x];if(S.push({position:O.position,height:O.height,extent:O.extent}),x!==P&&c[x-1].idx===O.idx-1){let N=x-P;D.push({a:N-1,b:N})}x++}y.push(new Cn(I.id,I.bounds,void 0,S,D,p))}return y}static getElevationFeature(e,n){if(!n)return;let s=+e.properties[ft];return Number.isNaN(s)?void 0:n.find(c=>c.id===s)}}class vn{constructor(e,n){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(n)||(this.zScale=Math.pow(2,n.z-e.z),this.xOffset=(e.x*this.zScale-n.x)*st,this.yOffset=(e.y*this.zScale-n.y)*st)}constantElevation(e,n){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,n)}pointElevation(e,n,s){let c=this.constantElevation(n,s);return c??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(n.pointElevation(e),s))}computeBiasedHeight(e,n){return n<=0?e:e+n*_e(0,n,e>=0?e:Math.abs(.5*e))}}_t(Cn,"ElevationFeature");class Rn{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new io,this.indexArray=new dr,this.segments=new _r,this.programConfigurations=new Oo(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new _l),this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){let f=this.layers[0],p=[],y=null;f.type==="circle"&&(y=f.layout.get("circle-sort-key"));for(let{feature:w,id:I,index:S,sourceLayerIndex:D}of e){let P=this.layers[0]._featureFilter.needGeometry,O=Pe(w,P);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom,{worldview:this.worldview}),O,s))continue;let N=y?y.evaluate(O,{},s):void 0,B={id:I,properties:w.properties,type:w.type,sourceLayerIndex:D,index:S,geometry:P?O.geometry:pe(w,s,c),patterns:{},sortKey:N};p.push(B)}y&&p.sort((w,I)=>w.sortKey-I.sortKey);let x=null;c.projection.name==="globe"&&(this.globeExtVertexArray=new jh,x=c.projection);for(let w of p){let{geometry:I,index:S,sourceLayerIndex:D}=w,P=e[S].feature;this.addFeature(w,I,S,n.availableImages,s,x,n.brightness,n.elevationFeatures),n.featureIndex.insert(P,I,S,D,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,n,s,c,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Hy.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Kb.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Yb.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,n,s,c,f,p,y,x){let w;this.elevationMode!=="none"&&(w=yr.getElevationFeature(e,x));for(let I of n)for(let S of I){let D=S.x,P=S.y;if(D<0||D>=st||P<0||P>=st)continue;if(p){let B=p.projectTilePoint(D,P,f),G=p.upVector(f,D,P);this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G)}let O=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),N=O.vertexLength;if(this.addCircleVertex(D,P,-1,-1),this.addCircleVertex(D,P,1,-1),this.addCircleVertex(D,P,1,1),this.addCircleVertex(D,P,-1,1),this.elevationMode!=="none"){let B=w?w.pointElevation(new Xe(D,P)):0;this.hasElevation=this.hasElevation||B!==0;for(let G=0;G<4;G++)this.elevatedLayoutVertexArray.emplaceBack(B)}this.indexArray.emplaceBack(N,N+1,N+2),this.indexArray.emplaceBack(N,N+2,N+3),O.vertexLength+=4,O.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},c,f,y,void 0,this.worldview)}addCircleVertex(e,n,s,c){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*n+(c+1)/2)}addGlobeExtVertex(e,n){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}}function Wn(i,e){for(let n=0;n<i.length;n++)if(Ii(e,i[n]))return!0;for(let n=0;n<e.length;n++)if(Ii(i,e[n]))return!0;return!!pi(i,e)}function Gr(i,e,n){return!!Ii(i,e)||!!Ti(e,i,n)}function Br(i,e){if(i.length===1)return ns(e,i[0]);for(let n=0;n<e.length;n++){let s=e[n];for(let c=0;c<s.length;c++)if(Ii(i,s[c]))return!0}for(let n=0;n<i.length;n++)if(ns(e,i[n]))return!0;for(let n=0;n<e.length;n++)if(pi(i,e[n]))return!0;return!1}function Wr(i,e,n){if(i.length>1){if(pi(i,e))return!0;for(let s=0;s<e.length;s++)if(Ti(e[s],i,n))return!0}for(let s=0;s<i.length;s++)if(Ti(i[s],e,n))return!0;return!1}function pi(i,e){if(i.length===0||e.length===0)return!1;for(let n=0;n<i.length-1;n++){let s=i[n],c=i[n+1];for(let f=0;f<e.length-1;f++)if(fs(s,c,e[f],e[f+1]))return!0}return!1}function fs(i,e,n,s){return Pr(i,n,s)!==Pr(e,n,s)&&Pr(i,e,n)!==Pr(i,e,s)}function Hi(i,e,n){return(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x)}function go(i,e,n,s){let c=Hi(i,e,s),f=Hi(i,e,n);if(Math.sign(c)===Math.sign(f))return;let p=Hi(n,s,i),y=p+f-c;return Math.sign(p)!==Math.sign(y)?[p/(p-y),f/(f-c)]:void 0}function Ti(i,e,n){let s=n*n;if(e.length===1)return i.distSqr(e[0])<s;for(let c=1;c<e.length;c++)if(Lo(i,e[c-1],e[c])<s)return!0;return!1}function Lo(i,e,n){let s=e.distSqr(n);if(s===0)return i.distSqr(e);let c=((i.x-e.x)*(n.x-e.x)+(i.y-e.y)*(n.y-e.y))/s;return i.distSqr(c<0?e:c>1?n:n.sub(e)._mult(c)._add(e))}function ns(i,e){let n,s,c,f=!1;for(let p=0;p<i.length;p++){n=i[p];for(let y=0,x=n.length-1;y<n.length;x=y++)s=n[y],c=n[x],s.y>e.y!=c.y>e.y&&e.x<(c.x-s.x)*(e.y-s.y)/(c.y-s.y)+s.x&&(f=!f)}return f}function Ii(i,e){let n=!1;for(let s=0,c=i.length-1;s<i.length;c=s++){let f=i[s],p=i[c];f.y>e.y!=p.y>e.y&&e.x<(p.x-f.x)*(e.y-f.y)/(p.y-f.y)+f.x&&(n=!n)}return n}function Or(i,e,n,s,c){for(let p of i)if(e<=p.x&&n<=p.y&&s>=p.x&&c>=p.y)return!0;let f=[new Xe(e,n),new Xe(e,c),new Xe(s,c),new Xe(s,n)];if(i.length>2){for(let p of f)if(Ii(i,p))return!0}for(let p=0;p<i.length-1;p++)if(Dr(i[p],i[p+1],f))return!0;return!1}function Dr(i,e,n){let s=n[0],c=n[2];if(i.x<s.x&&e.x<s.x||i.x>c.x&&e.x>c.x||i.y<s.y&&e.y<s.y||i.y>c.y&&e.y>c.y)return!1;let f=Pr(i,e,n[0]);return f!==Pr(i,e,n[1])||f!==Pr(i,e,n[2])||f!==Pr(i,e,n[3])}function Jn(i,e,n,s,c,f){let p=e.y-i.y,y=i.x-e.x;if(f=f||0){let x=p*p+y*y;if(x===0)return!0;let w=Math.sqrt(x);p/=w,y/=w}return!((n.x-i.x)*p+(n.y-i.y)*y-f<0||(s.x-i.x)*p+(s.y-i.y)*y-f<0||(c.x-i.x)*p+(c.y-i.y)*y-f<0)}function ei(i,e,n,s,c,f,p){return!(Jn(i,e,s,c,f,p)||Jn(e,n,s,c,f,p)||Jn(n,i,s,c,f,p)||Jn(s,c,i,e,n,p)||Jn(c,f,i,e,n,p)||Jn(f,s,i,e,n,p))}function mi(i,e,n){let s=e.paint.get(i).value;return s.kind==="constant"?s.value:n.programConfigurations.get(e.id).getMaxValue(i)}function Lr(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function Fo(i,e,n,s,c){if(!e[0]&&!e[1])return i;let f=Xe.convert(e)._mult(c);n==="viewport"&&f._rotate(-s);let p=[];for(let y=0;y<i.length;y++)p.push(i[y].sub(f));return p}function vl(i,e,n,s){let c=Xe.convert(i)._mult(s);return e==="viewport"&&c._rotate(-n),c}let Fa,Cc;function Ac(i,e,n){var s=2*Math.PI*6378137/256/Math.pow(2,n);return[i*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}_t(Rn,"CircleBucket",{omit:["layers"]});class ko{constructor(e,n,s){this.z=e,this.x=n,this.y=s,this.key=No(0,e,e,n,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){let n=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>n&&e.y===this.y>>n}url(e,n){let s=function(f,p,y){var x=Ac(256*f,256*(p=Math.pow(2,y)-p-1),y),w=Ac(256*(f+1),256*(p+1),y);return x[0]+","+x[1]+","+w[0]+","+w[1]}(this.x,this.y,this.z),c=function(f,p,y){let x,w="";for(let I=f;I>0;I--)x=1<<I-1,w+=(p&x?1:0)+(y&x?2:0);return w}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(n==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",c).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class As{constructor(e,n){this.wrap=e,this.canonical=n,this.key=No(e,n.z,n.z,n.x,n.y)}}class ti{constructor(e,n,s,c,f){this.overscaledZ=e,this.wrap=n,this.canonical=new ko(s,+c,+f),this.key=n===0&&e===s?this.canonical.key:No(n,e,s,c,f)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){let n=this.canonical.z-e;return e>this.canonical.z?new ti(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new ti(e,this.wrap,e,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(e,n=!0){if(this.overscaledZ===e&&n)return this.key;if(e>this.canonical.z)return No(this.wrap*+n,e,this.canonical.z,this.canonical.x,this.canonical.y);{let s=this.canonical.z-e;return No(this.wrap*+n,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;let n=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>n&&e.canonical.y===this.canonical.y>>n}children(e){if(this.overscaledZ>=e)return[new ti(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let n=this.canonical.z+1,s=2*this.canonical.x,c=2*this.canonical.y;return[new ti(n,this.wrap,n,s,c),new ti(n,this.wrap,n,s+1,c),new ti(n,this.wrap,n,s,c+1),new ti(n,this.wrap,n,s+1,c+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new ti(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new ti(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new As(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function No(i,e,n,s,c){let f=1<<Math.min(n,22),p=f*(c%f)+s%f;return i&&n<22&&(p+=f*f*((i<0?-2*i-1:2*i)%(1<<2*(22-n)))),16*(32*p+n)+(e-n)}let xl=[i=>{let e=i.canonical.x-1,n=i.wrap;return e<0&&(e=(1<<i.canonical.z)-1,n--),new ti(i.overscaledZ,n,i.canonical.z,e,i.canonical.y)},i=>{let e=i.canonical.x+1,n=i.wrap;return e===1<<i.canonical.z&&(e=0,n++),new ti(i.overscaledZ,n,i.canonical.z,e,i.canonical.y)},i=>new ti(i.overscaledZ,i.wrap,i.canonical.z,i.canonical.x,(i.canonical.y===0?1<<i.canonical.z:i.canonical.y)-1),i=>new ti(i.overscaledZ,i.wrap,i.canonical.z,i.canonical.x,i.canonical.y===(1<<i.canonical.z)-1?0:i.canonical.y+1)];_t(ko,"CanonicalTileID"),_t(ti,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let IF=gn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Xy}=IF,SF=gn([{name:"a_pos_3",components:3,type:"Int16"}]);var DS=gn([{name:"a_pos",type:"Int16",components:2}]);function Yy(i){return i*Fi/T}let DF=[new sn([g,g,g],[_,_,_]),new sn([g,g,g],[0,0,_]),new sn([0,g,g],[_,0,_]),new sn([g,0,g],[0,_,_]),new sn([0,0,g],[_,_,_])];function CS(i,e,n,s=!0){let c=hr([],i._camera.position,i.worldSize),f=[e,n,1,1];ho(f,f,i.pixelMatrixInverse),Ls(f,f,1/f[3]);let p=cr([],zr([],f,c)),y=i.globeMatrix,x=[y[12],y[13],y[14]],w=zr([],x,c),I=Ei(w),S=cr([],w),D=i.worldSize/(2*Math.PI),P=kr(S,p),O=Math.asin(D/I);if(O<Math.acos(P)){if(!s)return null;let ke=[],be=[];hr(ke,p,I/P),cr(be,zr(be,ke,w)),cr(p,mr(p,w,hr(p,be,Math.tan(O)*I)))}let N=[];new wn(c,p).closestPointOnSphere(x,D,N);let B=cr([],wr(y,0)),G=cr([],wr(y,1)),X=cr([],wr(y,2)),q=kr(B,N),K=kr(G,N),he=kr(X,N),le=De(Math.asin(-K/D)),ue=De(Math.atan2(q,he));ue=i.center.lng+function(ke,be){let ze=(be-ke+180)%360-180;return ze<-180?ze+360:ze}(i.center.lng,ue);let ge=z(ue),ye=ne(H(le),0,1);return new se(ge,ye)}class CF{constructor(e,n,s){this.a=zr([],e,s),this.b=zr([],n,s),this.center=s;let c=cr([],this.a),f=cr([],this.b);this.angle=Math.acos(kr(c,f))}}function o1(i,e){if(i.angle===0)return null;let n;return n=i.a[e]===0?1/i.angle*.5*Math.PI:1/i.angle*Math.atan(i.b[e]/i.a[e]/Math.sin(i.angle)-1/Math.tan(i.angle)),n<0||n>1?null:function(s,c,f,p){let y=Math.sin(f);return s*(Math.sin((1-p)*f)/y)+c*(Math.sin(p*f)/y)}(i.a[e],i.b[e],i.angle,ne(n,0,1))+i.center[e]}function ka(i){if(i.z<=1)return DF[i.z+2*i.y+i.x];let e=s1(Ky(i));return sn.fromPoints(e)}function bl(i,e,n){return hr(i,i,1-n),zi(i,i,e,n)}function AS(i,e,n){for(let s of i)Nr(s,s,e),hr(s,s,n)}function MS(i,e,n,s){let c=e/i.worldSize,f=i.globeMatrix;if(n.z<=1){let ye=ka(n).getCorners();return AS(ye,f,c),sn.fromPoints(ye)}let p=Ky(n,s),y=s1(p,Fi+Yy(i._tileCoverLift));AS(y,f,c);let x=Number.MAX_VALUE,w=[-x,-x,-x],I=[x,x,x];if(p.contains(i.center)){for(let be of y)Os(I,I,be),Zo(w,w,be);w[2]=0;let ye=i.point,ke=[ye.x*c,ye.y*c,0];return Os(I,I,ke),Zo(w,w,ke),new sn(I,w)}if(i._tileCoverLift>0){for(let ye of y)Os(I,I,ye),Zo(w,w,ye);return new sn(I,w)}let S=[f[12]*c,f[13]*c,f[14]*c],D=p.getCenter(),P=ne(i.center.lat,-re,re),O=ne(D.lat,-re,re),N=z(i.center.lng),B=H(P),G=N-z(D.lng),X=B-H(O);G>.5?G-=1:G<-.5&&(G+=1);let q=0;Math.abs(G)>Math.abs(X)?q=G>=0?1:3:(q=X>=0?0:2,zi(S,S,[f[4]*c,f[5]*c,f[6]*c],-Math.sin(Sn(X>=0?p.getSouth():p.getNorth()))*Fi));let K=y[q],he=y[(q+1)%4],le=new CF(K,he,S),ue=[o1(le,0)||K[0],o1(le,1)||K[1],o1(le,2)||K[2]],ge=Mc(i.zoom);if(ge>0){let ye=function({x:be,y:ze,z:et},Ue,Ze,Je,Le){let qe=1/(1<<et),we=be*qe,Fe=we+qe,rt=ze*qe,Ye=rt+qe,Et=0,yt=(we+Fe)/2-Je;return yt>.5?Et=-1:yt<-.5&&(Et=1),we=((we+Et)*Ue-(Je*=Ue))*Ze+Je,Fe=((Fe+Et)*Ue-Je)*Ze+Je,rt=(rt*Ue-(Le*=Ue))*Ze+Le,Ye=(Ye*Ue-Le)*Ze+Le,[[we,Ye,0],[Fe,Ye,0],[Fe,rt,0],[we,rt,0]]}(n,e,i._pixelsPerMercatorPixel,N,B);for(let be=0;be<y.length;be++)bl(y[be],ye[be],ge);let ke=mr([],ye[q],ye[(q+1)%4]);hr(ke,ke,.5),bl(ue,ke,ge)}for(let ye of y)Os(I,I,ye),Zo(w,w,ye);return I[2]=Math.min(K[2],he[2]),Os(I,I,ue),Zo(w,w,ue),new sn(I,w)}function Ky({x:i,y:e,z:n},s=!1){let c=1/(1<<n),f=new A(Z(i*c),e===(1<<n)-1&&s?-90:Y((e+1)*c)),p=new A(Z((i+1)*c),e===0&&s?90:Y(e*c));return new L(f,p)}function s1(i,e=Fi){let n=Sn(i.getNorth()),s=Sn(i.getSouth()),c=Math.cos(n),f=Math.cos(s),p=Math.sin(n),y=Math.sin(s),x=i.getWest(),w=i.getEast();return[v(f,y,x,e),v(f,y,w,e),v(c,p,w,e),v(c,p,x,e)]}function km(i,e,n,s){let c=1<<n.z,f=(i/st+n.x)/c;return E(Y((e/st+n.y)/c),Z(f),s)}function Jy({min:i,max:e}){return t/Math.max(e[0]-i[0],e[1]-i[1],e[2]-i[2])}let RS=new Float64Array(16);function Qy(i){let e=Jy(i),n=bs(RS,[e,e,e]);return Ut(n,n,ca([],i.min))}function a1(i){let e=(s=i.min,(n=RS)[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=s[0],n[13]=s[1],n[14]=s[2],n[15]=1,n);var n,s;let c=1/Jy(i);return Nt(e,e,[c,c,c])}function l1(i){let e=st/(2*Math.PI);return i/(2*Math.PI)/e}function PS(i,e){return st/(512*Math.pow(2,i))*Jy(ka(e))}function OS(i,e,n,s,c){let f=l1(n),p=[i,e,-n/(2*Math.PI)],y=Oe(new Float64Array(16));return Ut(y,y,p),Nt(y,y,[f,f,f]),li(y,y,Sn(-c)),ci(y,y,Sn(-s)),y}function Mc(i){return _e(qy,d,i)}function LS(i,e){let n=E(e.lat,e.lng),s=function(O){let N=E(O._center.lat,O._center.lng),B=qr([],Zr(0,1,0),N),G=wo([],-O.angle,N);B=Nr(B,B,G),wo(G,-O._pitch,B);let X=cr([],N);return hr(X,X,Yy(O.cameraToCenterDistance/O.pixelsPerMeter)),Nr(X,X,G),mr([],N,X)}(i);return p=(c=uo([],s,n))[0],y=c[1],x=c[2],w=(f=n)[0],I=f[1],S=f[2],P=(D=Math.sqrt(p*p+y*y+x*x)*Math.sqrt(w*w+I*I+S*S))&&kr(c,f)/D,Math.acos(Math.min(Math.max(P,-1),1));var c,f,p,y,x,w,I,S,D,P}function c1(i,e){return LS(i,e)>Math.PI/2*1.01}let FS=Sn(85),AF=Math.cos(FS),MF=Math.sin(FS),RF=ht(),kS=i=>{let e=[];return i.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),i.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function NS(i,e,n,s,c,f,p,y,x){if(f&&i.queryGeometry.isAboveHorizon)return!1;f&&(x*=i.pixelToTileUnitsFactor);let w=i.tileID.canonical,I=n.projection.upVectorScale(w,n.center.lat,n.worldSize).metersToTile;for(let S of e)for(let D of S){let P=D.add(y),O=c&&n.elevation?n.elevation.exaggeration()*c.getElevationAt(P.x,P.y,!0):0,N=n.projection.projectTilePoint(P.x,P.y,w);if(O>0){let q=n.projection.upVector(w,P.x,P.y);N.x+=q[0]*I*O,N.y+=q[1]*I*O,N.z+=q[2]*I*O}let B=f?P:PF(N.x,N.y,N.z,s),G=f?i.tilespaceRays.map(q=>LF(q,O)):i.queryGeometry.screenGeometry,X=ho([],[N.x,N.y,N.z,1],s);if(!p&&f?x*=X[3]/n.cameraToCenterDistance:p&&!f&&(x*=n.cameraToCenterDistance/X[3]),f){let q=Y((D.y/st+w.y)/(1<<w.z));x/=n.projection.pixelsPerMeter(q,1)/j(1,q)}if(Gr(G,B,x))return!0}return!1}function PF(i,e,n,s){let c=ho([],[i,e,n,1],s);return new Xe(c[0]/c[3],c[1]/c[3])}let zS=Zr(0,0,0),OF=Zr(0,0,1);function LF(i,e){let n=zn();return zS[2]=e,i.intersectsPlane(zS,OF,n),new Xe(n[0],n[1])}class BS extends Rn{}let VS,US,jS,HS;function GS(i,{width:e,height:n},s,c){if(c){if(c instanceof Uint8ClampedArray)c=new Uint8Array(c.buffer);else if(c.length!==e*n*s)throw new RangeError("mismatched image size")}else c=new Uint8Array(e*n*s);return i.width=e,i.height=n,i.data=c,i}function $S(i,e,n){let{width:s,height:c}=e;s===i.width&&c===i.height||(u1(i,e,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,s),height:Math.min(i.height,c)},n,null),i.width=s,i.height=c,i.data=e.data)}function u1(i,e,n,s,c,f,p,y){if(c.width===0||c.height===0)return e;if(c.width>i.width||c.height>i.height||n.x>i.width-c.width||n.y>i.height-c.height)throw new RangeError("out of range source coordinates for image copy");if(c.width>e.width||c.height>e.height||s.x>e.width-c.width||s.y>e.height-c.height)throw new RangeError("out of range destination coordinates for image copy");let x=i.data,w=e.data,I=f===4&&y;for(let S=0;S<c.height;S++){let D=((n.y+S)*i.width+n.x)*f,P=((s.y+S)*e.width+s.x)*f;if(I)for(let O=0;O<c.width;O++){let N=D+O*f+3,B=P+O*f;w[B+0]=255,w[B+1]=255,w[B+2]=255,w[B+3]=x[N]}else if(p)for(let O=0;O<c.width;O++){let N=D+O*f,B=P+O*f,G=new Ln(x[N+0]/255,x[N+1]/255,x[N+2]/255,x[N+3]).toNonPremultipliedRenderColor(p).toArray();w[B+0]=G[0],w[B+1]=G[1],w[B+2]=G[2],w[B+3]=G[3]}else for(let O=0;O<c.width*f;O++)w[P+O]=x[D+O]}return e}_t(BS,"HeatmapBucket",{omit:["layers"]});class Rc{constructor(e,n){GS(this,e,1,n)}resize(e){$S(this,new Rc(e),1)}clone(){return new Rc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,s,c,f){u1(e,n,s,c,f,1,null)}}class Si{constructor(e,n){GS(this,e,4,n)}resize(e){$S(this,new Si(e),4)}replace(e,n){n?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Si({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,s,c,f,p,y){u1(e,n,s,c,f,4,p,y)}}class WS{constructor(e,n){this.width=e.width,this.height=e.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}function Nm(i){let e={},n=i.resolution||256,s=i.clips?i.clips.length:1,c=i.image||new Si({width:n,height:s}),f=(p,y,x)=>{e[i.evaluationKey]=x;let w=i.expression.evaluate(e),I=w?w.toNonPremultipliedRenderColor(null):null;I&&(c.data[p+y+0]=Math.floor(255*I.r),c.data[p+y+1]=Math.floor(255*I.g),c.data[p+y+2]=Math.floor(255*I.b),c.data[p+y+3]=Math.floor(255*I.a))};if(i.clips)for(let p=0,y=0;p<s;++p,y+=4*n)for(let x=0,w=0;x<n;x++,w+=4){let I=x/(n-1),{start:S,end:D}=i.clips[p];f(y,w,S*(1-I)+D*I)}else for(let p=0,y=0;p<n;p++,y+=4)f(0,y,p/(n-1));return c}_t(Rc,"AlphaImage"),_t(Si,"RGBAImage");let FF=gn([{name:"a_pos",components:2,type:"Int16"}],4),kF=gn([{name:"a_road_z_offset",components:1,type:"Float32"}],4),NF=gn([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),zF=gn([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Kh(i,e,n=2){let s=e&&e.length,c=s?e[0]*n:i.length,f=ZS(i,0,c,n,!0),p=[];if(!f||f.next===f.prev)return p;let y,x,w;if(s&&(f=function(I,S,D,P){let O=[];for(let N=0,B=S.length;N<B;N++){let G=ZS(I,S[N]*P,N<B-1?S[N+1]*P:I.length,P,!1);G===G.next&&(G.steiner=!0),O.push(WF(G))}O.sort(HF);for(let N=0;N<O.length;N++)D=GF(O[N],D);return D}(i,e,f,n)),i.length>80*n){y=i[0],x=i[1];let I=y,S=x;for(let D=n;D<c;D+=n){let P=i[D],O=i[D+1];P<y&&(y=P),O<x&&(x=O),P>I&&(I=P),O>S&&(S=O)}w=Math.max(I-y,S-x),w=w!==0?32767/w:0}return zm(f,p,n,y,x,w,0),p}function ZS(i,e,n,s,c){let f;if(c===function(p,y,x,w){let I=0;for(let S=y,D=x-w;S<x;S+=w)I+=(p[D]-p[S])*(p[S+1]+p[D+1]),D=S;return I}(i,e,n,s)>0)for(let p=e;p<n;p+=s)f=KS(p/s|0,i[p],i[p+1],f);else for(let p=n-s;p>=e;p-=s)f=KS(p/s|0,i[p],i[p+1],f);return f&&Jh(f,f.next)&&(Um(f),f=f.next),f}function id(i,e){if(!i)return i;e||(e=i);let n,s=i;do if(n=!1,s.steiner||!Jh(s,s.next)&&ui(s.prev,s,s.next)!==0)s=s.next;else{if(Um(s),s=e=s.prev,s===s.next)break;n=!0}while(n||s!==e);return e}function zm(i,e,n,s,c,f,p){if(!i)return;!p&&f&&function(x,w,I,S){let D=x;do D.z===0&&(D.z=d1(D.x,D.y,w,I,S)),D.prevZ=D.prev,D.nextZ=D.next,D=D.next;while(D!==x);D.prevZ.nextZ=null,D.prevZ=null,function(P){let O,N=1;do{let B,G=P;P=null;let X=null;for(O=0;G;){O++;let q=G,K=0;for(let le=0;le<N&&(K++,q=q.nextZ,q);le++);let he=N;for(;K>0||he>0&&q;)K!==0&&(he===0||!q||G.z<=q.z)?(B=G,G=G.nextZ,K--):(B=q,q=q.nextZ,he--),X?X.nextZ=B:P=B,B.prevZ=X,X=B;G=q}X.nextZ=null,N*=2}while(O>1)}(D)}(i,s,c,f);let y=i;for(;i.prev!==i.next;){let x=i.prev,w=i.next;if(f?VF(i,s,c,f):BF(i))e.push(x.i,i.i,w.i),Um(i),i=w.next,y=w.next;else if((i=w)===y){p?p===1?zm(i=UF(id(i),e),e,n,s,c,f,2):p===2&&jF(i,e,n,s,c,f):zm(id(i),e,n,s,c,f,1);break}}}function BF(i){let e=i.prev,n=i,s=i.next;if(ui(e,n,s)>=0)return!1;let c=e.x,f=n.x,p=s.x,y=e.y,x=n.y,w=s.y,I=Math.min(c,f,p),S=Math.min(y,x,w),D=Math.max(c,f,p),P=Math.max(y,x,w),O=s.next;for(;O!==e;){if(O.x>=I&&O.x<=D&&O.y>=S&&O.y<=P&&Bm(c,y,f,x,p,w,O.x,O.y)&&ui(O.prev,O,O.next)>=0)return!1;O=O.next}return!0}function VF(i,e,n,s){let c=i.prev,f=i,p=i.next;if(ui(c,f,p)>=0)return!1;let y=c.x,x=f.x,w=p.x,I=c.y,S=f.y,D=p.y,P=Math.min(y,x,w),O=Math.min(I,S,D),N=Math.max(y,x,w),B=Math.max(I,S,D),G=d1(P,O,e,n,s),X=d1(N,B,e,n,s),q=i.prevZ,K=i.nextZ;for(;q&&q.z>=G&&K&&K.z<=X;){if(q.x>=P&&q.x<=N&&q.y>=O&&q.y<=B&&q!==c&&q!==p&&Bm(y,I,x,S,w,D,q.x,q.y)&&ui(q.prev,q,q.next)>=0||(q=q.prevZ,K.x>=P&&K.x<=N&&K.y>=O&&K.y<=B&&K!==c&&K!==p&&Bm(y,I,x,S,w,D,K.x,K.y)&&ui(K.prev,K,K.next)>=0))return!1;K=K.nextZ}for(;q&&q.z>=G;){if(q.x>=P&&q.x<=N&&q.y>=O&&q.y<=B&&q!==c&&q!==p&&Bm(y,I,x,S,w,D,q.x,q.y)&&ui(q.prev,q,q.next)>=0)return!1;q=q.prevZ}for(;K&&K.z<=X;){if(K.x>=P&&K.x<=N&&K.y>=O&&K.y<=B&&K!==c&&K!==p&&Bm(y,I,x,S,w,D,K.x,K.y)&&ui(K.prev,K,K.next)>=0)return!1;K=K.nextZ}return!0}function UF(i,e){let n=i;do{let s=n.prev,c=n.next.next;!Jh(s,c)&&XS(s,n,n.next,c)&&Vm(s,c)&&Vm(c,s)&&(e.push(s.i,n.i,c.i),Um(n),Um(n.next),n=i=c),n=n.next}while(n!==i);return id(n)}function jF(i,e,n,s,c,f){let p=i;do{let y=p.next.next;for(;y!==p.prev;){if(p.i!==y.i&&ZF(p,y)){let x=YS(p,y);return p=id(p,p.next),x=id(x,x.next),zm(p,e,n,s,c,f,0),void zm(x,e,n,s,c,f,0)}y=y.next}p=p.next}while(p!==i)}function HF(i,e){let n=i.x-e.x;return n===0&&(n=i.y-e.y,n===0)&&(n=(i.next.y-i.y)/(i.next.x-i.x)-(e.next.y-e.y)/(e.next.x-e.x)),n}function GF(i,e){let n=function(c,f){let p=f,y=c.x,x=c.y,w,I=-1/0;if(Jh(c,p))return p;do{if(Jh(c,p.next))return p.next;if(x<=p.y&&x>=p.next.y&&p.next.y!==p.y){let N=p.x+(x-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(N<=y&&N>I&&(I=N,w=p.x<p.next.x?p:p.next,N===y))return w}p=p.next}while(p!==f);if(!w)return null;let S=w,D=w.x,P=w.y,O=1/0;p=w;do{if(y>=p.x&&p.x>=D&&y!==p.x&&qS(x<P?y:I,x,D,P,x<P?I:y,x,p.x,p.y)){let N=Math.abs(x-p.y)/(y-p.x);Vm(p,c)&&(N<O||N===O&&(p.x>w.x||p.x===w.x&&$F(w,p)))&&(w=p,O=N)}p=p.next}while(p!==S);return w}(i,e);if(!n)return e;let s=YS(n,i);return id(s,s.next),id(n,n.next)}function $F(i,e){return ui(i.prev,i,e.prev)<0&&ui(e.next,i,i.next)<0}function d1(i,e,n,s,c){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-n)*c|0)|i<<8))|i<<4))|i<<2))|i<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*c|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function WF(i){let e=i,n=i;do(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next;while(e!==i);return n}function qS(i,e,n,s,c,f,p,y){return(c-p)*(e-y)>=(i-p)*(f-y)&&(i-p)*(s-y)>=(n-p)*(e-y)&&(n-p)*(f-y)>=(c-p)*(s-y)}function Bm(i,e,n,s,c,f,p,y){return!(i===p&&e===y)&&qS(i,e,n,s,c,f,p,y)}function ZF(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!function(n,s){let c=n;do{if(c.i!==n.i&&c.next.i!==n.i&&c.i!==s.i&&c.next.i!==s.i&&XS(c,c.next,n,s))return!0;c=c.next}while(c!==n);return!1}(i,e)&&(Vm(i,e)&&Vm(e,i)&&function(n,s){let c=n,f=!1,p=(n.x+s.x)/2,y=(n.y+s.y)/2;do c.y>y!=c.next.y>y&&c.next.y!==c.y&&p<(c.next.x-c.x)*(y-c.y)/(c.next.y-c.y)+c.x&&(f=!f),c=c.next;while(c!==n);return f}(i,e)&&(ui(i.prev,i,e.prev)||ui(i,e.prev,e))||Jh(i,e)&&ui(i.prev,i,i.next)>0&&ui(e.prev,e,e.next)>0)}function ui(i,e,n){return(e.y-i.y)*(n.x-e.x)-(e.x-i.x)*(n.y-e.y)}function Jh(i,e){return i.x===e.x&&i.y===e.y}function XS(i,e,n,s){let c=tv(ui(i,e,n)),f=tv(ui(i,e,s)),p=tv(ui(n,s,i)),y=tv(ui(n,s,e));return c!==f&&p!==y||!(c!==0||!ev(i,n,e))||!(f!==0||!ev(i,s,e))||!(p!==0||!ev(n,i,s))||!(y!==0||!ev(n,e,s))}function ev(i,e,n){return e.x<=Math.max(i.x,n.x)&&e.x>=Math.min(i.x,n.x)&&e.y<=Math.max(i.y,n.y)&&e.y>=Math.min(i.y,n.y)}function tv(i){return i>0?1:i<0?-1:0}function Vm(i,e){return ui(i.prev,i,i.next)<0?ui(i,e,i.next)>=0&&ui(i,i.prev,e)>=0:ui(i,e,i.prev)<0||ui(i,i.next,e)<0}function YS(i,e){let n=h1(i.i,i.x,i.y),s=h1(e.i,e.x,e.y),c=i.next,f=e.prev;return i.next=e,e.prev=i,n.next=c,c.prev=n,s.next=n,n.prev=s,f.next=s,s.prev=f,s}function KS(i,e,n,s){let c=h1(i,e,n);return s?(c.next=s.next,c.prev=s,s.next.prev=c,s.next=c):(c.prev=c,c.next=c),c}function Um(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function h1(i,e,n){return{i,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function jm(i,e){let n=i.length;if(n<=1)return[i];let s=[],c,f;for(let p=0;p<n;p++){let y=ii(i[p]);y!==0&&(i[p].area=Math.abs(y),f===void 0&&(f=y<0),f===y<0?(c&&s.push(c),c=[i[p]]):c.push(i[p]))}if(c&&s.push(c),e>1)for(let p=0;p<s.length;p++)s[p].length<=e||(Oi(s[p],e,1,s[p].length-1,qF),s[p]=s[p].slice(0,e));return s}function qF(i,e){return e.area-i.area}function JS(i,e,n=1){if(!i)return null;let s=typeof i=="string"?to.from(i).getPrimary():i.getPrimary(),c=typeof i=="string"?null:i.getSecondary();for(let f of[s,c]){if(!f)continue;let p=f.id.toString();e.has(p)||e.set(p,[]),f.scaleSelf(n),e.get(p).push(f)}return{primary:s.toString(),secondary:c?c.toString():null}}function f1(i,e,n,s){let c=s.patternDependencies,f=!1;for(let p of e){let y=p.paint.get(`${i}-pattern`);y.isConstant()||(f=!0),JS(y.constantOr(null),c,n)&&(f=!0)}return f}function p1(i,e,n,s,c,f){let p=f.patternDependencies;for(let y of e){let x=y.paint.get(`${i}-pattern`).value;if(x.kind!=="constant"){let w=x.evaluate({zoom:s},n,{},f.availableImages);w=w&&w.name?w.name:w;let I=JS(w,p,c);if(!I)continue;let{primary:S,secondary:D}=I;S&&(n.patterns[y.id]=[S,D].filter(Boolean))}}return n}class QS{constructor(){this.polygons=new Map}add(e,...n){this.polygons.has(e)?this.polygons.get(e).push(...n):this.polygons.set(e,n)}merge(e){for(let[n,s]of e.polygons)this.add(n,...s)}}class od{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new od;let n=[];for(let w of e)n.push(...w.portals);if(n.length===0)return new od;let s=(w,I)=>w<=0&&I<=0||w>=st&&I>=st;for(let w of n){let I=w.va,S=w.vb;(s(I.x,S.x)||s(I.y,S.y))&&(w.type="border")}let c=n.filter(w=>w.type!=="unevaluated"),f=n.filter(w=>w.type==="unevaluated");if(f.length===0)return new od;f.sort((w,I)=>w.hash===I.hash?w.isTunnel===I.isTunnel?0:w.isTunnel?-1:1:w.hash<I.hash?1:-1),n=c.concat(f);let p=c.length,y=p,x=p;do if(y++,y===n.length||n[p].hash!==n[y].hash){if(y-p==2){x<p&&(n[x]=n[p],n[p]=null);let w=n[x],I=n[y-1];w.type=w.isTunnel!==I.isTunnel?"tunnel":"polygon",w.connection={a:w.connection.a,b:I.connection.a},x++}p=y}while(p!==n.length);return n.splice(x),n.sort((w,I)=>w.hash<I.hash?1:-1),{portals:n}}}_t(od,"ElevationPortalGraph"),_t(QS,"ElevationPolygons");class XF{constructor(e,n,s){this.outPositions=e,this.outNormals=n,this.outIndices=s,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,n,s){let c=e[2];s!=null&&(c*=s);let f=this.getVec3Bits(e)<<96n|this.getVec3Bits(n),p=this.vertexLookup.get(f);if(p!=null)return p;let y=this.outPositions.length;this.vertexLookup.set(f,y);let x=Math.trunc(16384*n[0]),w=Math.trunc(16384*n[1]),I=Math.trunc(16384*n[2]);return this.outPositions.emplaceBack(e[0],e[1],c),this.outNormals.emplaceBack(x,w,I),y}addTriangle(e,n,s){this.outIndices.emplaceBack(e,n,s)}addTriangles(e,n,s){if(e.length===0)return;let c=s.length===1,f=zn(),p=zn();for(let y=0;y<e.length;y+=3){let x=n[e[y+0]],w=n[e[y+1]],I=n[e[y+2]],S=c?s[0]:s[e[y+1]],D=c?s[0]:s[e[y+2]];jr(f,x.x,x.y,c?s[0]:s[e[y+0]]);let P=this.addVertex(f,p);jr(f,w.x,w.y,S);let O=this.addVertex(f,p);jr(f,I.x,I.y,D);let N=this.addVertex(f,p);this.outIndices.emplaceBack(P,O,N)}}addQuad(e,n,s,c,f,p){let y=this.addVertex(e,f,p),x=this.addVertex(n,f,p),w=this.addVertex(s,f,p),I=this.addVertex(c,f,p);this.addTriangle(y,x,w),this.addTriangle(w,I,y)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class zo{constructor(e,n,s,c){this.unevaluatedPortals=new od,this.portalPolygons=new QS,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new _m,this.vertexNormals=new ym,this.indexArray=new dr,this.tileToMeters=oe(e),this.bridgeProgramConfigurations=new Oo(n,{zoom:s,lut:c},f=>f!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new Oo(n,{zoom:s,lut:c},f=>f!=="fill-bridge-guard-rail-color")}addVertices(e,n){let s=this.unevalVertices.length;for(let c=0;c<e.length;c++)this.unevalVertices.push(e[c]),this.unevalHeights.push(n[c]);return s}addTriangles(e,n,s){let c=s?this.unevalTunnelTriangles:this.unevalTriangles;for(let f of e)c.push(f+n)}addRenderableRing(e,n,s,c,f,p){let y=[new Xe(f.min.x,f.min.y),new Xe(f.max.x,f.min.y),new Xe(f.max.x,f.max.y),new Xe(f.min.x,f.max.y)];for(let x=0;x<s-1;x++){let w=n+x,I=w+1,S=this.unevalVertices[w],D=this.unevalVertices[I];if(!(S.x>=f.min.x&&S.x<=f.max.x&&S.y>=f.min.y&&S.y<=f.max.y||D.x>=f.min.x&&D.x<=f.max.x&&D.y>=f.min.y&&D.y<=f.max.y||Dr(S,D,y))||this.isOnBorder(S.x,D.x)||this.isOnBorder(S.y,D.y))continue;let P=zo.computeEdgeHash(this.unevalVertices[w],this.unevalVertices[I]),O,N=this.vertexHashLookup.get(zo.computePosHash(S));N!=null?O=N.next:(N=this.vertexHashLookup.get(zo.computePosHash(D)),O=N!=null?N.prev:P),this.unevalEdges.push({polygonIdx:e,a:w,b:I,hash:P,portalHash:O,isTunnel:c,type:"unevaluated",featureInfo:p})}}addPortalCandidates(e,n,s,c,f){if(n.length===0)return;this.portalPolygons.add(e,{geometry:n,zLevel:f});let p=n[0];this.vertexHashLookup.clear();let y=zo.computeEdgeHash(p[p.length-2],p[p.length-1]);for(let x=0;x<p.length-1;x++){let w=p[x+0],I=p[x+1],S=Io(I.x-w.x,I.y-w.y),D=ma(S);if(D===0)continue;let P="unevaluated",O=c.pointElevation(w),N=c.pointElevation(I);Math.abs(O)<.01&&Math.abs(N)<.01?P="entrance":(this.isOnBorder(w.x,I.x)||this.isOnBorder(w.y,I.y))&&(P="border");let B=zo.computeEdgeHash(w,I);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:w,vb:I,vab:S,length:D,hash:B,isTunnel:s,type:P});let G=zo.computePosHash(w);this.vertexHashLookup.set(G,{prev:y,next:B}),y=B}}construct(e){if(this.unevalVertices.length===0)return;let n=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=D=>{D.primitiveLength=this.indexArray.length-D.primitiveOffset},c=new XF(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);let f=n(),p=n(),y=n(),x=(D,P)=>{D.sort((N,B)=>N.type===P&&B.type!==P?-1:N.type!==P&&B.type===P?1:0);let O=D.findIndex(N=>N.type!==P);return O>=0?O:D.length},w=0;this.unevalEdges.length>0&&(w=x(this.unevalEdges,"none"),this.constructBridgeStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},this.tileToMeters)),s(y);let I=n(),S=n();if(this.unevalEdges.length>0){let D=this.unevalEdges.splice(w),P=x(D,"tunnel")+w;this.unevalEdges.push(...D),this.constructTunnelStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},{min:w,max:P})}s(I),c.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(S),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(p),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(f),this.maskSegments=_r.simpleSegment(0,S.primitiveOffset,0,S.primitiveLength),this.depthSegments=_r.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.renderableBridgeSegments=_r.simpleSegment(0,y.primitiveOffset,0,y.primitiveLength),this.renderableTunnelSegments=_r.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.shadowCasterSegments=_r.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength)}update(e,n,s,c,f,p,y,x){this.bridgeProgramConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x),this.tunnelProgramConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,NF.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,zF.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,n,s,c,f){let p=(y,x)=>{for(let w=0;w<x.length-1;w++){let I=x[w].featureIndex,S=x[w+1].vertexStart,D=e.feature(I);y.populatePaintArrays(S,D,I,{},s,n,c,void 0,f)}};p(this.bridgeProgramConfigurations,this.bridgeFeatureSections),p(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,n,s,c,f){let p=new Map;for(let y=c;y<f;y++){let x=s[y],w=x.a,I=x.b,S=zo.computePosHash(e[w]),D=zo.computePosHash(e[I]),P=p.get(S);P||(P={},p.set(S,P));let O=p.get(D);O||(O={},p.set(D,O)),n[w]<=0&&n[I]<=0||(P.to=I,O.from=w)}return p}isTerminalVertex(e,n){let s=zo.computePosHash(this.unevalVertices[e]),c=n.get(s);return!c||!c.from||!c.to}constructBridgeStructures(e,n,s,c,f,p){e.clearVertexLookup();let y=this.computeVertexConnections(n,s,c,f.min,f.max),x=1/p,w=.5*x,I=(Ze,Je)=>jr(Ze,n[Je].x,n[Je].y,s[Je]*x),S=zn(),D=zn(),P=zn(),O=zn(),N=zn(),B=(Ze,Je)=>{let Le=y.get(zo.computePosHash(n[Je])),qe=Le.from,we=Le.to;if(!qe||!we)return;I(S,qe),I(D,Je),I(P,we),lu(O),qo(S,D)||(zr(N,D,S),cr(O,N)),qo(P,D)||(zr(N,P,D),mr(O,O,cr(N,N)));let Fe=ha(O);return Fe>0?hr(Ze,O,1/Fe):void 0},G=Number.POSITIVE_INFINITY;this.sortSubarray(c,f.min,f.max,(Ze,Je)=>Ze.featureInfo.featureIndex-Je.featureInfo.featureIndex);let X=zn(),q=zn(),K=zn(),he=zn(),le=zn(),ue=zn(),ge=zn(),ye=zn(),ke=zn(),be=[zn(),zn(),zn(),zn()],ze=[zn(),zn(),zn(),zn()],et=[{coord:new Xe(0,0),height:0},{coord:new Xe(0,0),height:0}],Ue=(Ze,Je)=>Ze>Je;for(let Ze=f.min;Ze<f.max;Ze++){let Je=c[Ze];if(!Je.featureInfo.guardRailEnabled||!this.prepareEdgePoints(et,n,s,Je,Ue))continue;let[Le,qe]=et;if(jr(X,Le.coord.x,Le.coord.y,x*Le.height),jr(q,qe.coord.x,qe.coord.y,x*qe.height),qo(X,q))continue;zr(K,q,X),cr(K,K);let we=B(ye,Je.a)||K,Fe=B(ke,Je.b)||K;jr(he,we[1],-we[0],0),cr(he,he),jr(le,Fe[1],-Fe[0],0),cr(le,le),qr(ye,he,we),cr(ue,ye),qr(ye,le,Fe),cr(ge,ye),mr(be[0],X,hr(ye,zr(ye,he,ue),w)),mr(be[1],X,hr(ye,mr(ye,he,ue),w)),mr(be[2],X,hr(ye,ue,w)),be[3]=X,mr(ze[0],q,hr(ye,zr(ye,le,ge),w)),mr(ze[1],q,hr(ye,mr(ye,le,ge),w)),mr(ze[2],q,hr(ye,ge,w)),ze[3]=q,G=this.addFeatureSection(Je.featureInfo.featureIndex,G,this.bridgeFeatureSections,e);let rt=e.addVertex(be[0],he,p),Ye=e.addVertex(be[1],he,p),Et=e.addVertex(ze[0],le,p),yt=e.addVertex(ze[1],le,p);e.addTriangle(rt,Ye,Et),e.addTriangle(Ye,yt,Et);let $e=e.addVertex(be[1],ue,p),Ke=e.addVertex(be[2],ue,p),xt=e.addVertex(ze[1],ge,p),pt=e.addVertex(ze[2],ge,p);e.addTriangle($e,Ke,xt),e.addTriangle(Ke,pt,xt),ca(he,he),ca(le,le);let at=e.addVertex(be[2],he,p),mt=e.addVertex(be[3],he,p),Rt=e.addVertex(ze[2],le,p),Bt=e.addVertex(ze[3],le,p);e.addTriangle(at,mt,Rt),e.addTriangle(mt,Bt,Rt);let qt=this.isTerminalVertex(Je.a,y),Gt=this.isTerminalVertex(Je.b,y);Le.height<.01&&qt&&e.addQuad(be[3],be[2],be[1],be[0],ca(we,we),p),qe.height<.01&&Gt&&e.addQuad(ze[0],ze[1],ze[2],ze[3],Fe,p)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,n,s,c,f,p){e.clearVertexLookup();let y=Number.POSITIVE_INFINITY,x=(G,X)=>G.featureInfo.featureIndex-X.featureInfo.featureIndex;this.sortSubarray(c,f.min,f.max,x),this.sortSubarray(c,p.min,p.max,x);let w=G=>cr(G,G),I=[{coord:new Xe(0,0),height:0},{coord:new Xe(0,0),height:0}],S=(G,X)=>G<X,D=zn(),P=zn(),O=zn(),N=zn(),B=zn();for(let G=f.min;G<f.max;G++){if(!this.prepareEdgePoints(I,n,s,c[G],S))continue;let[X,q]=I,K=w(jr(B,-(q.coord.y-X.coord.y),q.coord.x-X.coord.x,0));y=this.addFeatureSection(c[G].featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad(jr(D,X.coord.x,X.coord.y,X.height),jr(P,q.coord.x,q.coord.y,q.height),jr(O,q.coord.x,q.coord.y,c[G].isTunnel?-.1:0),jr(N,X.coord.x,X.coord.y,c[G].isTunnel?-.1:0),K)}for(let G=p.min;G<p.max;G++){let X=c[G];X.isTunnel&&([X.a,X.b]=[X.b,X.a]);let q=n[X.a],K=n[X.b],he=w(jr(B,-(K.y-q.y),K.x-q.x,0));y=this.addFeatureSection(X.featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad(jr(D,K.x,K.y,0),jr(P,q.x,q.y,0),jr(O,q.x,q.y,s[X.a]+4),jr(N,K.x,K.y,s[X.b]+4),he),e.addQuad(jr(D,q.x,q.y,0),jr(P,K.x,K.y,0),jr(O,K.x,K.y,s[X.b]+4),jr(N,q.x,q.y,s[X.a]+4),he)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,n,s,c){e.coord.x=n,e.coord.y=s,e.height=c}prepareEdgePoints(e,n,s,c,f){let p=n[c.a].x,y=n[c.a].y,x=n[c.b].x,w=n[c.b].y,I=s[c.a],S=s[c.b],D=f(I,0),P=f(S,0);if(D&&P)return this.setElevatedPoint(e[0],p,y,I),this.setElevatedPoint(e[1],x,w,S),!0;if(!D&&!P)return!1;if(D){if(!P){let O=S/(S-I);x=At(x,p,O),w=At(w,y,O),S=At(S,I,O)}}else{let O=I/(I-S);p=At(p,x,O),y=At(y,w,O),I=At(I,S,O)}return this.setElevatedPoint(e[0],p,y,I),this.setElevatedPoint(e[1],x,w,S),!0}prepareEdges(e,n){if(n.length===0)return;n.sort((y,x)=>y.hash===x.hash?x.polygonIdx-y.polygonIdx:x.hash>y.hash?1:-1);let s=0,c=0,f=0,p=n[s].polygonIdx;do c++,(c===n.length||n[s].hash!==n[c].hash)&&((c-s==1||n[c-1].polygonIdx!==p)&&(f<s&&(n[f]=n[s],n[s]=null),n[f].type="none",f++),s=c,s!==n.length&&(p=n[s].polygonIdx));while(s!==n.length);if(n.splice(f),n.length!==0&&e.length!==0){n.sort((w,I)=>w.portalHash<I.portalHash?1:-1);let y=0,x=0;for(;y!==n.length&&x!==e.length;){let w=n[y],I=e[x];w.portalHash>I.hash?y++:I.hash>w.portalHash?x++:(w.type=I.type,y++)}}}isOnBorder(e,n){return e<=0&&n<=0||e>=st&&n>=st}addFeatureSection(e,n,s,c){return e!==n&&(n=e,s.push({featureIndex:e,vertexStart:c.getVertexCount()}),c.clearVertexLookup()),n}sortSubarray(e,n,s,c){let f=e.slice(n,s);f.sort(c),e.splice(n,f.length,...f)}static computeEdgeHash(e,n){return(e.y===n.y&&e.x>n.x||e.y>n.y)&&([e,n]=[n,e]),BigInt(zo.computePosHash(e))<<32n|BigInt(zo.computePosHash(n))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var eD,tD={exports:{}},nD=(eD||(eD=1,function(i,e){(function(n){function s(Q,ee){return Q>ee?1:Q<ee?-1:0}var c=function(Q,ee){Q===void 0&&(Q=s),ee===void 0&&(ee=!1),this._compare=Q,this._root=null,this._size=0,this._noDuplicates=!!ee},f={size:{configurable:!0}};function p(Q,ee,Re,it,ct){var lt=ct-it;if(lt>0){var vt=it+Math.floor(lt/2),Ft={key:ee[vt],data:Re[vt],parent:Q};return Ft.left=p(Ft,ee,Re,it,vt),Ft.right=p(Ft,ee,Re,vt+1,ct),Ft}return null}function y(Q,ee,Re,it,ct){if(!(Re>=it)){for(var lt=Q[Re+it>>1],vt=Re-1,Ft=it+1;;){do vt++;while(ct(Q[vt],lt)<0);do Ft--;while(ct(Q[Ft],lt)>0);if(vt>=Ft)break;var cn=Q[vt];Q[vt]=Q[Ft],Q[Ft]=cn,cn=ee[vt],ee[vt]=ee[Ft],ee[Ft]=cn}y(Q,ee,Re,Ft,ct),y(Q,ee,Ft+1,it,ct)}}c.prototype.rotateLeft=function(Q){var ee=Q.right;ee&&(Q.right=ee.left,ee.left&&(ee.left.parent=Q),ee.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=ee:Q.parent.right=ee:this._root=ee,ee&&(ee.left=Q),Q.parent=ee},c.prototype.rotateRight=function(Q){var ee=Q.left;ee&&(Q.left=ee.right,ee.right&&(ee.right.parent=Q),ee.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=ee:Q.parent.right=ee:this._root=ee,ee&&(ee.right=Q),Q.parent=ee},c.prototype._splay=function(Q){for(;Q.parent;){var ee=Q.parent;ee.parent?ee.left===Q&&ee.parent.left===ee?(this.rotateRight(ee.parent),this.rotateRight(ee)):ee.right===Q&&ee.parent.right===ee?(this.rotateLeft(ee.parent),this.rotateLeft(ee)):ee.left===Q&&ee.parent.right===ee?(this.rotateRight(ee),this.rotateLeft(ee)):(this.rotateLeft(ee),this.rotateRight(ee)):ee.left===Q?this.rotateRight(ee):this.rotateLeft(ee)}},c.prototype.splay=function(Q){for(var ee,Re,it,ct,lt;Q.parent;)(Re=(ee=Q.parent).parent)&&Re.parent?((it=Re.parent).left===Re?it.left=Q:it.right=Q,Q.parent=it):(Q.parent=null,this._root=Q),ct=Q.left,lt=Q.right,Q===ee.left?(Re&&(Re.left===ee?(ee.right?(Re.left=ee.right,Re.left.parent=Re):Re.left=null,ee.right=Re,Re.parent=ee):(ct?(Re.right=ct,ct.parent=Re):Re.right=null,Q.left=Re,Re.parent=Q)),lt?(ee.left=lt,lt.parent=ee):ee.left=null,Q.right=ee,ee.parent=Q):(Re&&(Re.right===ee?(ee.left?(Re.right=ee.left,Re.right.parent=Re):Re.right=null,ee.left=Re,Re.parent=ee):(lt?(Re.left=lt,lt.parent=Re):Re.left=null,Q.right=Re,Re.parent=Q)),ct?(ee.right=ct,ct.parent=ee):ee.right=null,Q.left=ee,ee.parent=Q)},c.prototype.replace=function(Q,ee){Q.parent?Q===Q.parent.left?Q.parent.left=ee:Q.parent.right=ee:this._root=ee,ee&&(ee.parent=Q.parent)},c.prototype.minNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.left;)Q=Q.left;return Q},c.prototype.maxNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.right;)Q=Q.right;return Q},c.prototype.insert=function(Q,ee){var Re=this._root,it=null,ct=this._compare;if(this._noDuplicates)for(;Re;){if(it=Re,ct(Re.key,Q)===0)return;Re=ct(Re.key,Q)<0?Re.right:Re.left}else for(;Re;)it=Re,Re=ct(Re.key,Q)<0?Re.right:Re.left;return Re={key:Q,data:ee,left:null,right:null,parent:it},it?ct(it.key,Re.key)<0?it.right=Re:it.left=Re:this._root=Re,this.splay(Re),this._size++,Re},c.prototype.find=function(Q){for(var ee=this._root,Re=this._compare;ee;){var it=Re(ee.key,Q);if(it<0)ee=ee.right;else{if(!(it>0))return ee;ee=ee.left}}return null},c.prototype.contains=function(Q){for(var ee=this._root,Re=this._compare;ee;){var it=Re(Q,ee.key);if(it===0)return!0;ee=it<0?ee.left:ee.right}return!1},c.prototype.remove=function(Q){var ee=this.find(Q);if(!ee)return!1;if(this.splay(ee),ee.left)if(ee.right){var Re=this.minNode(ee.right);Re.parent!==ee&&(this.replace(Re,Re.right),Re.right=ee.right,Re.right.parent=Re),this.replace(ee,Re),Re.left=ee.left,Re.left.parent=Re}else this.replace(ee,ee.left);else this.replace(ee,ee.right);return this._size--,!0},c.prototype.removeNode=function(Q){if(!Q)return!1;if(this.splay(Q),Q.left)if(Q.right){var ee=this.minNode(Q.right);ee.parent!==Q&&(this.replace(ee,ee.right),ee.right=Q.right,ee.right.parent=ee),this.replace(Q,ee),ee.left=Q.left,ee.left.parent=ee}else this.replace(Q,Q.left);else this.replace(Q,Q.right);return this._size--,!0},c.prototype.erase=function(Q){var ee=this.find(Q);if(ee){this.splay(ee);var Re=ee.left,it=ee.right,ct=null;Re&&(Re.parent=null,ct=this.maxNode(Re),this.splay(ct),this._root=ct),it&&(Re?ct.right=it:this._root=it,it.parent=ct),this._size--}},c.prototype.pop=function(){var Q=this._root,ee=null;if(Q){for(;Q.left;)Q=Q.left;ee={key:Q.key,data:Q.data},this.remove(Q.key)}return ee},c.prototype.next=function(Q){var ee=Q;if(ee)if(ee.right)for(ee=ee.right;ee&&ee.left;)ee=ee.left;else for(ee=Q.parent;ee&&ee.right===Q;)Q=ee,ee=ee.parent;return ee},c.prototype.prev=function(Q){var ee=Q;if(ee)if(ee.left)for(ee=ee.left;ee&&ee.right;)ee=ee.right;else for(ee=Q.parent;ee&&ee.left===Q;)Q=ee,ee=ee.parent;return ee},c.prototype.forEach=function(Q){for(var ee=this._root,Re=[],it=!1,ct=0;!it;)ee?(Re.push(ee),ee=ee.left):Re.length>0?(Q(ee=Re.pop(),ct++),ee=ee.right):it=!0;return this},c.prototype.range=function(Q,ee,Re,it){for(var ct=[],lt=this._compare,vt=this._root;ct.length!==0||vt;)if(vt)ct.push(vt),vt=vt.left;else{if(lt((vt=ct.pop()).key,ee)>0)break;if(lt(vt.key,Q)>=0&&Re.call(it,vt))return this;vt=vt.right}return this},c.prototype.keys=function(){for(var Q=this._root,ee=[],Re=[],it=!1;!it;)Q?(ee.push(Q),Q=Q.left):ee.length>0?(Q=ee.pop(),Re.push(Q.key),Q=Q.right):it=!0;return Re},c.prototype.values=function(){for(var Q=this._root,ee=[],Re=[],it=!1;!it;)Q?(ee.push(Q),Q=Q.left):ee.length>0?(Q=ee.pop(),Re.push(Q.data),Q=Q.right):it=!0;return Re},c.prototype.at=function(Q){for(var ee=this._root,Re=[],it=!1,ct=0;!it;)if(ee)Re.push(ee),ee=ee.left;else if(Re.length>0){if(ee=Re.pop(),ct===Q)return ee;ct++,ee=ee.right}else it=!0;return null},c.prototype.load=function(Q,ee,Re){if(Q===void 0&&(Q=[]),ee===void 0&&(ee=[]),Re===void 0&&(Re=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var it=Q.length;return Re&&y(Q,ee,0,it-1,this._compare),this._root=p(null,Q,ee,0,it),this._size=it,this},c.prototype.min=function(){var Q=this.minNode(this._root);return Q?Q.key:null},c.prototype.max=function(){var Q=this.maxNode(this._root);return Q?Q.key:null},c.prototype.isEmpty=function(){return this._root===null},f.size.get=function(){return this._size},c.createTree=function(Q,ee,Re,it,ct){return new c(Re,ct).load(Q,ee,it)},Object.defineProperties(c.prototype,f);var x=0,w=1,I=2,S=3,D=0,P=1,O=2,N=3;function B(Q,ee,Re){ee===null?(Q.inOut=!1,Q.otherInOut=!0):(Q.isSubject===ee.isSubject?(Q.inOut=!ee.inOut,Q.otherInOut=ee.otherInOut):(Q.inOut=!ee.otherInOut,Q.otherInOut=ee.isVertical()?!ee.inOut:ee.inOut),ee&&(Q.prevInResult=!G(ee,Re)||ee.isVertical()?ee.prevInResult:ee));var it=G(Q,Re);Q.resultTransition=it?function(ct,lt){var vt,Ft=!ct.inOut,cn=!ct.otherInOut;switch(lt){case D:vt=Ft&&cn;break;case P:vt=Ft||cn;break;case N:vt=Ft^cn;break;case O:vt=ct.isSubject?Ft&&!cn:cn&&!Ft}return vt?1:-1}(Q,Re):0}function G(Q,ee){switch(Q.type){case x:switch(ee){case D:return!Q.otherInOut;case P:return Q.otherInOut;case O:return Q.isSubject&&Q.otherInOut||!Q.isSubject&&!Q.otherInOut;case N:return!0}break;case I:return ee===D||ee===P;case S:return ee===O;case w:return!1}return!1}var X=function(Q,ee,Re,it,ct){this.left=ee,this.point=Q,this.otherEvent=Re,this.isSubject=it,this.type=ct||x,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},q={inResult:{configurable:!0}};function K(Q,ee){return Q[0]===ee[0]&&Q[1]===ee[1]}X.prototype.isBelow=function(Q){var ee=this.point,Re=this.otherEvent.point;return this.left?(ee[0]-Q[0])*(Re[1]-Q[1])-(Re[0]-Q[0])*(ee[1]-Q[1])>0:(Re[0]-Q[0])*(ee[1]-Q[1])-(ee[0]-Q[0])*(Re[1]-Q[1])>0},X.prototype.isAbove=function(Q){return!this.isBelow(Q)},X.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},q.inResult.get=function(){return this.resultTransition!==0},X.prototype.clone=function(){var Q=new X(this.point,this.left,this.otherEvent,this.isSubject,this.type);return Q.contourId=this.contourId,Q.resultTransition=this.resultTransition,Q.prevInResult=this.prevInResult,Q.isExteriorRing=this.isExteriorRing,Q.inOut=this.inOut,Q.otherInOut=this.otherInOut,Q},Object.defineProperties(X.prototype,q);var he=11102230246251565e-32,le=134217729,ue=(3+8*he)*he;function ge(Q,ee,Re,it,ct){var lt,vt,Ft,cn,un=ee[0],Jt=it[0],Hn=0,Er=0;Jt>un==Jt>-un?(lt=un,un=ee[++Hn]):(lt=Jt,Jt=it[++Er]);var Xt=0;if(Hn<Q&&Er<Re)for(Jt>un==Jt>-un?(Ft=lt-((vt=un+lt)-un),un=ee[++Hn]):(Ft=lt-((vt=Jt+lt)-Jt),Jt=it[++Er]),lt=vt,Ft!==0&&(ct[Xt++]=Ft);Hn<Q&&Er<Re;)Jt>un==Jt>-un?(Ft=lt-((vt=lt+un)-(cn=vt-lt))+(un-cn),un=ee[++Hn]):(Ft=lt-((vt=lt+Jt)-(cn=vt-lt))+(Jt-cn),Jt=it[++Er]),lt=vt,Ft!==0&&(ct[Xt++]=Ft);for(;Hn<Q;)Ft=lt-((vt=lt+un)-(cn=vt-lt))+(un-cn),un=ee[++Hn],lt=vt,Ft!==0&&(ct[Xt++]=Ft);for(;Er<Re;)Ft=lt-((vt=lt+Jt)-(cn=vt-lt))+(Jt-cn),Jt=it[++Er],lt=vt,Ft!==0&&(ct[Xt++]=Ft);return lt===0&&Xt!==0||(ct[Xt++]=lt),Xt}function ye(Q){return new Float64Array(Q)}var ke=33306690738754716e-32,be=22204460492503146e-32,ze=11093356479670487e-47,et=ye(4),Ue=ye(8),Ze=ye(12),Je=ye(16),Le=ye(4);function qe(Q,ee,Re){var it=function(ct,lt,vt,Ft,cn,un){var Jt=(lt-un)*(vt-cn),Hn=(ct-cn)*(Ft-un),Er=Jt-Hn;if(Jt===0||Hn===0||Jt>0!=Hn>0)return Er;var Xt=Math.abs(Jt+Hn);return Math.abs(Er)>=ke*Xt?Er:-function(ar,Qn,kn,vr,rr,er,tr){var Vn,Qt,Gn,xr,Ot,yn,ir,Cr,lr,ni,Zn,Yr,_o,Di,xi,yo,Ba,ri,ai=ar-rr,Ci=kn-rr,Gi=Qn-er,ki=vr-er;et[0]=(xi=(Cr=ai-(ir=(yn=le*ai)-(yn-ai)))*(ni=ki-(lr=(yn=le*ki)-(yn-ki)))-((Di=ai*ki)-ir*lr-Cr*lr-ir*ni))-((Zn=xi-(Ba=(Cr=Gi-(ir=(yn=le*Gi)-(yn-Gi)))*(ni=Ci-(lr=(yn=le*Ci)-(yn-Ci)))-((yo=Gi*Ci)-ir*lr-Cr*lr-ir*ni)))+(Ot=xi-Zn))+(Ot-Ba),et[1]=(_o=Di-((Yr=Di+Zn)-(Ot=Yr-Di))+(Zn-Ot))-((Zn=_o-yo)+(Ot=_o-Zn))+(Ot-yo),et[2]=Yr-((ri=Yr+Zn)-(Ot=ri-Yr))+(Zn-Ot),et[3]=ri;var zc=function(fH,pM){for(var mM=pM[0],vw=1;vw<4;vw++)mM+=pM[vw];return mM}(0,et),vg=be*tr;if(zc>=vg||-zc>=vg||(Vn=ar-(ai+(Ot=ar-ai))+(Ot-rr),Gn=kn-(Ci+(Ot=kn-Ci))+(Ot-rr),Qt=Qn-(Gi+(Ot=Qn-Gi))+(Ot-er),xr=vr-(ki+(Ot=vr-ki))+(Ot-er),Vn===0&&Qt===0&&Gn===0&&xr===0)||(vg=ze*tr+ue*Math.abs(zc),(zc+=ai*xr+ki*Vn-(Gi*Gn+Ci*Qt))>=vg||-zc>=vg))return zc;Le[0]=(xi=(Cr=Vn-(ir=(yn=le*Vn)-(yn-Vn)))*(ni=ki-(lr=(yn=le*ki)-(yn-ki)))-((Di=Vn*ki)-ir*lr-Cr*lr-ir*ni))-((Zn=xi-(Ba=(Cr=Qt-(ir=(yn=le*Qt)-(yn-Qt)))*(ni=Ci-(lr=(yn=le*Ci)-(yn-Ci)))-((yo=Qt*Ci)-ir*lr-Cr*lr-ir*ni)))+(Ot=xi-Zn))+(Ot-Ba),Le[1]=(_o=Di-((Yr=Di+Zn)-(Ot=Yr-Di))+(Zn-Ot))-((Zn=_o-yo)+(Ot=_o-Zn))+(Ot-yo),Le[2]=Yr-((ri=Yr+Zn)-(Ot=ri-Yr))+(Zn-Ot),Le[3]=ri;var Xz=ge(4,et,4,Le,Ue);Le[0]=(xi=(Cr=ai-(ir=(yn=le*ai)-(yn-ai)))*(ni=xr-(lr=(yn=le*xr)-(yn-xr)))-((Di=ai*xr)-ir*lr-Cr*lr-ir*ni))-((Zn=xi-(Ba=(Cr=Gi-(ir=(yn=le*Gi)-(yn-Gi)))*(ni=Gn-(lr=(yn=le*Gn)-(yn-Gn)))-((yo=Gi*Gn)-ir*lr-Cr*lr-ir*ni)))+(Ot=xi-Zn))+(Ot-Ba),Le[1]=(_o=Di-((Yr=Di+Zn)-(Ot=Yr-Di))+(Zn-Ot))-((Zn=_o-yo)+(Ot=_o-Zn))+(Ot-yo),Le[2]=Yr-((ri=Yr+Zn)-(Ot=ri-Yr))+(Zn-Ot),Le[3]=ri;var Yz=ge(Xz,Ue,4,Le,Ze);Le[0]=(xi=(Cr=Vn-(ir=(yn=le*Vn)-(yn-Vn)))*(ni=xr-(lr=(yn=le*xr)-(yn-xr)))-((Di=Vn*xr)-ir*lr-Cr*lr-ir*ni))-((Zn=xi-(Ba=(Cr=Qt-(ir=(yn=le*Qt)-(yn-Qt)))*(ni=Gn-(lr=(yn=le*Gn)-(yn-Gn)))-((yo=Qt*Gn)-ir*lr-Cr*lr-ir*ni)))+(Ot=xi-Zn))+(Ot-Ba),Le[1]=(_o=Di-((Yr=Di+Zn)-(Ot=Yr-Di))+(Zn-Ot))-((Zn=_o-yo)+(Ot=_o-Zn))+(Ot-yo),Le[2]=Yr-((ri=Yr+Zn)-(Ot=ri-Yr))+(Zn-Ot),Le[3]=ri;var Kz=ge(Yz,Ze,4,Le,Je);return Je[Kz-1]}(ct,lt,vt,Ft,cn,un,Xt)}(Q[0],Q[1],ee[0],ee[1],Re[0],Re[1]);return it>0?-1:it<0?1:0}function we(Q,ee){var Re=Q.point,it=ee.point;return Re[0]>it[0]?1:Re[0]<it[0]?-1:Re[1]!==it[1]?Re[1]>it[1]?1:-1:function(ct,lt,vt,Ft){return ct.left!==lt.left?ct.left?1:-1:qe(vt,ct.otherEvent.point,lt.otherEvent.point)!==0?ct.isBelow(lt.otherEvent.point)?-1:1:!ct.isSubject&&lt.isSubject?1:-1}(Q,ee,Re)}function Fe(Q,ee,Re){var it=new X(ee,!1,Q,Q.isSubject),ct=new X(ee,!0,Q.otherEvent,Q.isSubject);return K(Q.point,Q.otherEvent.point)&&console.warn("what is that, a collapsed segment?",Q),it.contourId=ct.contourId=Q.contourId,we(ct,Q.otherEvent)>0&&(Q.otherEvent.left=!0,ct.left=!1),Q.otherEvent.otherEvent=ct,Q.otherEvent=it,Re.push(ct),Re.push(it),Re}function rt(Q,ee){return Q[0]*ee[1]-Q[1]*ee[0]}function Ye(Q,ee){return Q[0]*ee[0]+Q[1]*ee[1]}function Et(Q,ee,Re){var it=function(cn,un,Jt,Hn,Er){var Xt=[un[0]-cn[0],un[1]-cn[1]],ar=[Hn[0]-Jt[0],Hn[1]-Jt[1]];function Qn(yn,ir,Cr){return[yn[0]+ir*Cr[0],yn[1]+ir*Cr[1]]}var kn=[Jt[0]-cn[0],Jt[1]-cn[1]],vr=rt(Xt,ar),rr=vr*vr,er=Ye(Xt,Xt);if(rr>0){var tr=rt(kn,ar)/vr;if(tr<0||tr>1)return null;var Vn=rt(kn,Xt)/vr;return Vn<0||Vn>1?null:tr===0||tr===1?[Qn(cn,tr,Xt)]:Vn===0||Vn===1?[Qn(Jt,Vn,ar)]:[Qn(cn,tr,Xt)]}if((rr=(vr=rt(kn,Xt))*vr)>0)return null;var Qt=Ye(Xt,kn)/er,Gn=Qt+Ye(Xt,ar)/er,xr=Math.min(Qt,Gn),Ot=Math.max(Qt,Gn);return xr<=1&&Ot>=0?xr===1?[Qn(cn,xr>0?xr:0,Xt)]:Ot===0?[Qn(cn,Ot<1?Ot:1,Xt)]:[Qn(cn,xr>0?xr:0,Xt),Qn(cn,Ot<1?Ot:1,Xt)]:null}(Q.point,Q.otherEvent.point,ee.point,ee.otherEvent.point),ct=it?it.length:0;if(ct===0||ct===1&&(K(Q.point,ee.point)||K(Q.otherEvent.point,ee.otherEvent.point))||ct===2&&Q.isSubject===ee.isSubject)return 0;if(ct===1)return K(Q.point,it[0])||K(Q.otherEvent.point,it[0])||Fe(Q,it[0],Re),K(ee.point,it[0])||K(ee.otherEvent.point,it[0])||Fe(ee,it[0],Re),1;var lt=[],vt=!1,Ft=!1;return K(Q.point,ee.point)?vt=!0:we(Q,ee)===1?lt.push(ee,Q):lt.push(Q,ee),K(Q.otherEvent.point,ee.otherEvent.point)?Ft=!0:we(Q.otherEvent,ee.otherEvent)===1?lt.push(ee.otherEvent,Q.otherEvent):lt.push(Q.otherEvent,ee.otherEvent),vt&&Ft||vt?(ee.type=w,Q.type=ee.inOut===Q.inOut?I:S,vt&&!Ft&&Fe(lt[1].otherEvent,lt[0].point,Re),2):Ft?(Fe(lt[0],lt[1].point,Re),3):lt[0]!==lt[3].otherEvent?(Fe(lt[0],lt[1].point,Re),Fe(lt[1],lt[2].point,Re),3):(Fe(lt[0],lt[1].point,Re),Fe(lt[3].otherEvent,lt[2].point,Re),3)}function yt(Q,ee){if(Q===ee)return 0;if(qe(Q.point,Q.otherEvent.point,ee.point)!==0||qe(Q.point,Q.otherEvent.point,ee.otherEvent.point)!==0)return K(Q.point,ee.point)?Q.isBelow(ee.otherEvent.point)?-1:1:Q.point[0]===ee.point[0]?Q.point[1]<ee.point[1]?-1:1:we(Q,ee)===1?ee.isAbove(Q.point)?-1:1:Q.isBelow(ee.point)?-1:1;if(Q.isSubject!==ee.isSubject)return Q.isSubject?-1:1;var Re=Q.point,it=ee.point;return Re[0]===it[0]&&Re[1]===it[1]?(Re=Q.otherEvent.point)[0]===(it=ee.otherEvent.point)[0]&&Re[1]===it[1]?0:Q.contourId>ee.contourId?1:-1:we(Q,ee)===1?1:-1}var $e=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function Ke(Q,ee,Re,it){var ct,lt=Q+1,vt=ee[Q].point,Ft=ee.length;for(lt<Ft&&(ct=ee[lt].point);lt<Ft&&ct[0]===vt[0]&&ct[1]===vt[1];){if(!Re[lt])return lt;++lt<Ft&&(ct=ee[lt].point)}for(lt=Q-1;Re[lt]&&lt>it;)lt--;return lt}$e.prototype.isExterior=function(){return this.holeOf==null};var xt=at,pt=at;function at(Q,ee){if(!(this instanceof at))return new at(Q,ee);if(this.data=Q||[],this.length=this.data.length,this.compare=ee||mt,this.length>0)for(var Re=(this.length>>1)-1;Re>=0;Re--)this._down(Re)}function mt(Q,ee){return Q<ee?-1:Q>ee?1:0}at.prototype={push:function(Q){this.data.push(Q),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var Q=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),Q}},peek:function(){return this.data[0]},_up:function(Q){for(var ee=this.data,Re=this.compare,it=ee[Q];Q>0;){var ct=Q-1>>1,lt=ee[ct];if(Re(it,lt)>=0)break;ee[Q]=lt,Q=ct}ee[Q]=it},_down:function(Q){for(var ee=this.data,Re=this.compare,it=this.length>>1,ct=ee[Q];Q<it;){var lt=1+(Q<<1),vt=lt+1,Ft=ee[lt];if(vt<this.length&&Re(ee[vt],Ft)<0&&(lt=vt,Ft=ee[vt]),Re(Ft,ct)>=0)break;ee[Q]=Ft,Q=lt}ee[Q]=ct}},xt.default=pt;var Rt=Math.max,Bt=Math.min,qt=0;function Gt(Q,ee,Re,it,ct,lt){var vt,Ft,cn,un,Jt,Hn;for(vt=0,Ft=Q.length-1;vt<Ft;vt++)if(un=Q[vt+1],Jt=new X(cn=Q[vt],!1,void 0,ee),Hn=new X(un,!1,Jt,ee),Jt.otherEvent=Hn,cn[0]!==un[0]||cn[1]!==un[1]){Jt.contourId=Hn.contourId=Re,lt||(Jt.isExteriorRing=!1,Hn.isExteriorRing=!1),we(Jt,Hn)>0?Hn.left=!0:Jt.left=!0;var Er=cn[0],Xt=cn[1];ct[0]=Bt(ct[0],Er),ct[1]=Bt(ct[1],Xt),ct[2]=Rt(ct[2],Er),ct[3]=Rt(ct[3],Xt),it.push(Jt),it.push(Hn)}}var pn=[];function nn(Q,ee,Re){typeof Q[0][0][0]=="number"&&(Q=[Q]),typeof ee[0][0][0]=="number"&&(ee=[ee]);var it=function(Xt,ar,Qn){var kn=null;return Xt.length*ar.length==0&&(Qn===D?kn=pn:Qn===O?kn=Xt:Qn!==P&&Qn!==N||(kn=Xt.length===0?ar:Xt)),kn}(Q,ee,Re);if(it)return it===pn?null:it;var ct=[1/0,1/0,-1/0,-1/0],lt=[1/0,1/0,-1/0,-1/0],vt=function(Xt,ar,Qn,kn,vr){var rr,er,tr,Vn,Qt,Gn,xr=new xt(null,we);for(tr=0,Vn=Xt.length;tr<Vn;tr++)for(Qt=0,Gn=(rr=Xt[tr]).length;Qt<Gn;Qt++)(er=Qt===0)&&qt++,Gt(rr[Qt],!0,qt,xr,Qn,er);for(tr=0,Vn=ar.length;tr<Vn;tr++)for(Qt=0,Gn=(rr=ar[tr]).length;Qt<Gn;Qt++)er=Qt===0,vr===O&&(er=!1),er&&qt++,Gt(rr[Qt],!1,qt,xr,kn,er);return xr}(Q,ee,ct,lt,Re);if(it=function(Xt,ar,Qn,kn,vr){var rr=null;return(Qn[0]>kn[2]||kn[0]>Qn[2]||Qn[1]>kn[3]||kn[1]>Qn[3])&&(vr===D?rr=pn:vr===O?rr=Xt:vr!==P&&vr!==N||(rr=Xt.concat(ar))),rr}(Q,ee,ct,lt,Re))return it===pn?null:it;for(var Ft=function(Xt){var ar,Qn,kn=function(tr){var Vn,Qt,Gn,xr,Ot=[];for(Qt=0,Gn=tr.length;Qt<Gn;Qt++)((Vn=tr[Qt]).left&&Vn.inResult||!Vn.left&&Vn.otherEvent.inResult)&&Ot.push(Vn);for(var yn=!1;!yn;)for(yn=!0,Qt=0,Gn=Ot.length;Qt<Gn;Qt++)Qt+1<Gn&&we(Ot[Qt],Ot[Qt+1])===1&&(xr=Ot[Qt],Ot[Qt]=Ot[Qt+1],Ot[Qt+1]=xr,yn=!1);for(Qt=0,Gn=Ot.length;Qt<Gn;Qt++)(Vn=Ot[Qt]).otherPos=Qt;for(Qt=0,Gn=Ot.length;Qt<Gn;Qt++)(Vn=Ot[Qt]).left||(xr=Vn.otherPos,Vn.otherPos=Vn.otherEvent.otherPos,Vn.otherEvent.otherPos=xr);return Ot}(Xt),vr={},rr=[],er=function(){if(!vr[ar]){var tr=rr.length,Vn=function(Ot,yn,ir){var Cr=new $e;if(Ot.prevInResult!=null){var lr=Ot.prevInResult,ni=lr.outputContourId;if(lr.resultTransition>0){var Zn=yn[ni];if(Zn.holeOf!=null){var Yr=Zn.holeOf;yn[Yr].holeIds.push(ir),Cr.holeOf=Yr,Cr.depth=yn[ni].depth}else yn[ni].holeIds.push(ir),Cr.holeOf=ni,Cr.depth=yn[ni].depth+1}else Cr.holeOf=null,Cr.depth=yn[ni].depth}else Cr.holeOf=null,Cr.depth=0;return Cr}(kn[ar],rr,tr),Qt=function(Ot){vr[Ot]=!0,Ot<kn.length&&kn[Ot]&&(kn[Ot].outputContourId=tr)},Gn=ar,xr=ar;for(Vn.points.push(kn[ar].point);Qt(Gn),Qt(Gn=kn[Gn].otherPos),Vn.points.push(kn[Gn].point),!((Gn=Ke(Gn,kn,vr,xr))==xr||Gn>=kn.length)&&kn[Gn];);rr.push(Vn)}};for(ar=0,Qn=kn.length;ar<Qn;ar++)er();return rr}(function(Xt,ar,Qn,kn,vr,rr){for(var er,tr,Vn,Qt=new c(yt),Gn=[],xr=Math.min(kn[2],vr[2]);Xt.length!==0;){var Ot=Xt.pop();if(Gn.push(Ot),rr===D&&Ot.point[0]>xr||rr===O&&Ot.point[0]>kn[2])break;if(Ot.left){tr=er=Qt.insert(Ot),er=er!==(Vn=Qt.minNode())?Qt.prev(er):null,tr=Qt.next(tr);var yn=er?er.key:null;if(B(Ot,yn,rr),tr&&Et(Ot,tr.key,Xt)===2&&(B(Ot,yn,rr),B(tr.key,Ot,rr)),er&&Et(er.key,Ot,Xt)===2){var ir=er;B(yn,(ir=ir!==Vn?Qt.prev(ir):null)?ir.key:null,rr),B(Ot,yn,rr)}}else tr=er=Qt.find(Ot=Ot.otherEvent),er&&tr&&(er=er!==Vn?Qt.prev(er):null,tr=Qt.next(tr),Qt.remove(Ot),tr&&er&&Et(er.key,tr.key,Xt))}return Gn}(vt,0,0,ct,lt,Re)),cn=[],un=0;un<Ft.length;un++){var Jt=Ft[un];if(Jt.isExterior()){for(var Hn=[Jt.points],Er=0;Er<Jt.holeIds.length;Er++)Hn.push(Ft[Jt.holeIds[Er]].points);cn.push(Hn)}}return cn}var nr={UNION:P,DIFFERENCE:O,INTERSECTION:D,XOR:N};n.diff=function(Q,ee){return nn(Q,ee,O)},n.intersection=function(Q,ee){return nn(Q,ee,D)},n.operations=nr,n.union=function(Q,ee){return nn(Q,ee,P)},n.xor=function(Q,ee){return nn(Q,ee,N)},Object.defineProperty(n,"__esModule",{value:!0})})(e)}(0,tD.exports)),tD.exports);function nv(i,e,n,s){let c=[],f=s===0?(p,y,x,w,I,S)=>{p.push(new Xe(S,x+(S-y)/(w-y)*(I-x)))}:(p,y,x,w,I,S)=>{p.push(new Xe(y+(S-x)/(I-x)*(w-y),S))};for(let p of i){let y=[];for(let x of p){if(x.length<=2)continue;let w=[];for(let D=0;D<x.length-1;D++){let P=x[D].x,O=x[D].y,N=x[D+1].x,B=x[D+1].y,G=s===0?P:O,X=s===0?N:B;G<e?X>e&&f(w,P,O,N,B,e):G>n?X<n&&f(w,P,O,N,B,n):w.push(x[D]),X<e&&G>=e&&f(w,P,O,N,B,e),X>n&&G<=n&&f(w,P,O,N,B,n)}let I=x[x.length-1],S=s===0?I.x:I.y;S>=e&&S<=n&&w.push(I),w.length&&(I=w[w.length-1],w[0].x===I.x&&w[0].y===I.y||w.push(w[0]),y.push(w))}y.length&&c.push(y)}return c}function YF(i,e){let n=m1(i),s=m1([e]),c=nD.intersection(n,s);return c==null?[]:rD(c)}function KF(i,e){let s=m1(i,65536);for(;e.valid();e.next()){let[c,f]=e.get(),p=c.x*65536,y=c.y*65536,x=f.x*65536,w=f.y*65536,I=x-p,S=w-y,D=Math.hypot(I,S),P=Math.trunc(S/D*3),O=-Math.trunc(I/D*3);s=nD.diff(s,[[[p,y],[x,w],[x+P,w+O],[p+P,y+O],[p,y]]])}return rD(s,1/65536)}function m1(i,e=1){return[i.map(n=>n.map(s=>[s.x*e,s.y*e]))]}function rD(i,e=1){return i.map(n=>n.map((s,c)=>{let f=s.map(p=>new Xe(p[0]*e,p[1]*e).round());return c>0&&f.reverse(),f}))}class g1{constructor(e,n){this.layoutVertexArray=new io,this.indexArray=new dr,this.lineIndexArray=new Ds,this.triangleSegments=new _r,this.lineSegments=new _r,this.programConfigurations=new Oo(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,n&&(this.elevatedLayoutVertexArray=new _l)}update(e,n,s,c,f,p,y,x){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,FF.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,kF.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,n,s,c,f,p,y){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,s,c,f,p,void 0,y)}}class _1{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new g1(e,!1),this.elevationBufferData=new g1(e,!0),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){this.hasPattern=f1("fill",this.layers,this.pixelRatio,n);let f=this.layers[0].layout.get("fill-sort-key"),p=[];for(let{feature:y,id:x,index:w,sourceLayerIndex:I}of e){let S=this.layers[0]._featureFilter.needGeometry,D=Pe(y,S);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom,{worldview:this.worldview}),D,s))continue;let P=f?f.evaluate(D,{},s,n.availableImages):void 0,O={id:x,properties:y.properties,type:y.type,sourceLayerIndex:I,index:w,geometry:S?D.geometry:pe(y,s,c),patterns:{},sortKey:P};p.push(O)}f&&p.sort((y,x)=>y.sortKey-x.sortKey);for(let y of p){let{geometry:x,index:w,sourceLayerIndex:I}=y;if(this.hasPattern){let S=p1("fill",this.layers,y,this.zoom,this.pixelRatio,n);this.patternFeatures.push(S)}else this.addFeature(y,x,w,s,{},n.availableImages,n.brightness,n.elevationFeatures);n.featureIndex.insert(e[w].feature,x,w,I,this.index)}}update(e,n,s,c,f,p,y){this.bufferData.update(e,n,s,c,f,p,y,this.worldview),this.elevationBufferData.update(e,n,s,c,f,p,y,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,n,s,c,f,p,y,this.worldview)}addFeatures(e,n,s,c,f,p){for(let y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,n,s,c,p,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,n,s,c,f,p=[],y,x){let w=jm(n,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,w,c,s,x):this.addGeometry(w,this.bufferData),this.bufferData.populatePaintArrays(e,s,f,p,c,y,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,f,p,c,y,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,n,s,c,f){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(n,s,c,f,this.worldview))}addElevatedRoadFeature(e,n,s,c,f){let p=new Array,y=yr.getElevationFeature(e,f);if(!y)return void this.addGeometry(n,this.bufferData);{let w=this.clipPolygonsToTile(n,1);w.length>0&&p.push({polygons:w,elevationFeature:y,elevationTileID:s})}let x={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:c};for(let w of p)if(w.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new zo(w.elevationTileID,this.layers,this.zoom,this.lut));let S=w.elevationFeature.isTunnel(),D=0;e.properties.hasOwnProperty(Tt)&&(D=+e.properties[Tt]);for(let P of w.polygons)this.elevatedStructures.addPortalCandidates(w.elevationFeature.id,P,S,w.elevationFeature,D)}w.elevationFeature.constantHeight==null&&(w.polygons=this.prepareElevatedPolygons(w.polygons,w.elevationFeature,w.elevationTileID));let I=new vn(s,w.elevationTileID);this.addElevatedGeometry(w.polygons,I,w.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,c,x)}}addElevatedGeometry(e,n,s,c,f,p){let y={elevation:s,elevationSampler:n,bias:c,index:f,featureInfo:p},[x,w]=this.addGeometry(e,this.elevationBufferData,y);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:x,max:w}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,x),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,w))}addGeometry(e,n,s){let c=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,p=null;s&&(p=s.elevationSampler.constantElevation(s.elevation,s.bias),p!=null&&(c=p,f=p));let y=(x,w,I)=>{if(s!=null)if(w.push(x),p!=null)n.elevatedLayoutVertexArray.emplaceBack(p),I.push(p);else{let S=s.elevationSampler.pointElevation(x,s.elevation,s.bias);n.elevatedLayoutVertexArray.emplaceBack(S),I.push(S),c=Math.min(c,S),f=Math.max(f,S)}};for(let x of e){let w=0;for(let q of x)w+=q.length;let I=n.triangleSegments.prepareSegment(w,n.layoutVertexArray,n.indexArray),S=I.vertexLength,D=[],P=[],O=[],N=[],B=[],G=n.layoutVertexArray.length;for(let q of x){if(q.length===0)continue;q!==x[0]&&P.push(D.length/2);let K=n.lineSegments.prepareSegment(q.length,n.layoutVertexArray,n.lineIndexArray),he=K.vertexLength;s&&B.push(n.layoutVertexArray.length-G),y(q[0],O,N),n.layoutVertexArray.emplaceBack(q[0].x,q[0].y),n.lineIndexArray.emplaceBack(he+q.length-1,he),D.push(q[0].x),D.push(q[0].y);for(let le=1;le<q.length;le++)y(q[le],O,N),n.layoutVertexArray.emplaceBack(q[le].x,q[le].y),n.lineIndexArray.emplaceBack(he+le-1,he+le),D.push(q[le].x),D.push(q[le].y);K.vertexLength+=q.length,K.primitiveLength+=q.length}let X=Kh(D,P);for(let q=0;q<X.length;q+=3)n.indexArray.emplaceBack(S+X[q],S+X[q+1],S+X[q+2]);if(X.length>0&&s&&this.elevationMode==="hd-road-base"){let q=s.elevation.isTunnel(),K=s.elevation.safeArea,he=this.elevatedStructures.addVertices(O,N);this.elevatedStructures.addTriangles(X,he,q);let le=B.length;if(le>0){for(let ue=0;ue<le-1;ue++)this.elevatedStructures.addRenderableRing(s.index,B[ue]+he,B[ue+1]-B[ue],q,K,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,B[le-1]+he,O.length-B[le-1],q,K,s.featureInfo)}}I.vertexLength+=w,I.primitiveLength+=X.length/3}return[c,f]}prepareElevatedPolygons(e,n,s){let c=1/oe(s),f=[];for(let p of e){let y=KF(p,new Bn(n,c));f.push(...y)}return f}clipPolygonsToTile(e,n){let s=-n,c=-n,f=st+n,p=st+n,y=0,x=[],w=[];for(;y<e.length;y++){let D=e[y],P=Mp(D);(P.min.x>=s&&P.max.x<=f&&P.min.y>=c&&P.max.y<=p?x:w).push(D)}if(x.length===e.length)return e;let I=[new Xe(s,c),new Xe(f,c),new Xe(f,p),new Xe(s,p),new Xe(s,c)],S=x;for(let D of w)S.push(...YF(D,I));return S}}let iD,oD,sD,aD;_t(_1,"FillBucket",{omit:["layers","patternFeatures"]}),_t(g1,"FillBufferData"),_t(zo,"ElevatedStructures");class rv{constructor(e,n,s,c){if(this.triangleCount=n.length/3,this.min=new Xe(0,0),this.max=new Xe(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;let[f,p]=[e[0].clone(),e[0].clone()];for(let S=1;S<e.length;++S){let D=e[S];f.x=Math.min(f.x,D.x),f.y=Math.min(f.y,D.y),p.x=Math.max(p.x,D.x),p.y=Math.max(p.y,D.y)}if(c){let S=Math.ceil(Math.max(p.x-f.x,p.y-f.y)/c);s=Math.max(s,S)}if(s===0)return;this.min=f,this.max=p;let y=this.max.sub(this.min);y.x=Math.max(y.x,1),y.y=Math.max(y.y,1);let x=Math.max(y.x,y.y)/s;this.cellsX=Math.max(1,Math.ceil(y.x/x)),this.cellsY=Math.max(1,Math.ceil(y.y/x)),this.xScale=1/x,this.yScale=1/x;let w=[];for(let S=0;S<this.triangleCount;S++){let D=e[n[3*S+0]].sub(this.min),P=e[n[3*S+1]].sub(this.min),O=e[n[3*S+2]].sub(this.min),N=Na(Math.floor(Math.min(D.x,P.x,O.x)),this.xScale,this.cellsX),B=Na(Math.floor(Math.max(D.x,P.x,O.x)),this.xScale,this.cellsX),G=Na(Math.floor(Math.min(D.y,P.y,O.y)),this.yScale,this.cellsY),X=Na(Math.floor(Math.max(D.y,P.y,O.y)),this.yScale,this.cellsY),q=new Xe(0,0),K=new Xe(0,0),he=new Xe(0,0),le=new Xe(0,0);for(let ue=G;ue<=X;++ue){q.y=K.y=ue*x,he.y=le.y=(ue+1)*x;for(let ge=N;ge<=B;++ge)q.x=he.x=ge*x,K.x=le.x=(ge+1)*x,(ei(D,P,O,q,K,le)||ei(D,P,O,q,le,he))&&w.push({cellIdx:ue*this.cellsX+ge,triIdx:S})}}if(w.length===0)return;w.sort((S,D)=>S.cellIdx-D.cellIdx||S.triIdx-D.triIdx);let I=0;for(;I<w.length;){let S=w[I].cellIdx,D={start:this.payload.length,len:0};for(;I<w.length&&w[I].cellIdx===S;)++D.len,this.payload.push(w[I++].triIdx);this.cells[S]=D}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,n){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;let s=Na(e.x-this.min.x,this.xScale,this.cellsX),c=Na(e.y-this.min.y,this.yScale,this.cellsY),f=this.cells[c*this.cellsX+s];if(f){this._lazyInitLookup();for(let p=0;p<f.len;p++){let y=this.payload[f.start+p],x=Math.floor(y/8),w=1<<y%8;if(!(this.lookup[x]&w)&&(this.lookup[x]|=w,n.push(y),n.length===this.triangleCount))return}}}query(e,n,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>n.x||e.y>this.max.y||this.min.y>n.y)return;this._lazyInitLookup();let c=Na(e.x-this.min.x,this.xScale,this.cellsX),f=Na(n.x-this.min.x,this.xScale,this.cellsX),p=Na(e.y-this.min.y,this.yScale,this.cellsY),y=Na(n.y-this.min.y,this.yScale,this.cellsY);for(let x=p;x<=y;x++)for(let w=c;w<=f;w++){let I=this.cells[x*this.cellsX+w];if(I)for(let S=0;S<I.len;S++){let D=this.payload[I.start+S],P=Math.floor(D/8),O=1<<D%8;if(!(this.lookup[P]&O)&&(this.lookup[P]|=O,s.push(D),s.length===this.triangleCount))return}}}}function Na(i,e,n){return Math.max(0,Math.min(n-1,Math.floor(i*e)))}_t(rv,"TriangleGridIndex");class lD{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,n){for(let s of this.footprints)n.push({footprint:s,id:e})}populate(e,n,s,c){let f=[];for(let{feature:p,id:y,index:x,sourceLayerIndex:w}of e){let I=this.layers[0]._featureFilter.needGeometry,S=Pe(p,I);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom,{worldview:this.worldview}),S,s))continue;let D={id:y,properties:p.properties,type:p.type,sourceLayerIndex:w,index:x,geometry:I?S.geometry:pe(p,s,c),patterns:{}};f.push(D)}for(let p of f){let{geometry:y,index:x,sourceLayerIndex:w}=p;this.addFeature(p,y,x,s,{},n.availableImages,n.brightness),n.featureIndex.insert(e[x].feature,y,x,w,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,n,s,c,f,p,y){}destroy(){}addFeature(e,n,s,c,f,p=[],y){for(let x of jm(n,2)){let w=[],I=[],S=[],D=new Xe(1/0,1/0),P=new Xe(-1/0,-1/0);for(let B of x)if(B.length!==0){B!==x[0]&&S.push(I.length/2);for(let G=0;G<B.length;G++)I.push(B[G].x),I.push(B[G].y),w.push(B[G]),D.x=Math.min(D.x,B[G].x),D.y=Math.min(D.y,B[G].y),P.x=Math.max(P.x,B[G].x),P.y=Math.max(P.y,B[G].y)}let O=Kh(I,S),N=new rv(w,O,8,256);this.footprints.push({vertices:w,indices:O,grid:N,min:D,max:P})}}}_t(lD,"ClipBucket",{omit:["layers"]});let JF=gn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),QF=gn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),ek=gn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),tk=gn([{name:"a_join_normal_inside",components:3,type:"Int16"}]),nk=gn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),rk=gn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:ik}=JF,Hm=Number.MAX_SAFE_INTEGER,cD=Hm-1;function uD(i,e,n,s){return i.order<e||i.order===Hm||!(i.clipMask&n)||function(c,f){return f.length!==0&&f.find(p=>p===c)===void 0}(s,i.clipScope)}function iv(i,e){return i.x-e.x||i.y-e.y}function dD(i,e){return iv(i.min,e.min)===0&&iv(i.max,e.max)===0}function y1(i,e){return!(i.min.x>e.max.x||i.max.x<e.min.x||i.min.y>e.max.y||i.max.y<e.min.y)}function ov(i,e){if(i.length!==e.length)return!1;for(let n=0;n<i.length;n++)if(i[n].sourceId!==e[n].sourceId||!dD(i[n],e[n])||i[n].order!==e[n].order||i[n].clipMask!==e[n].clipMask||!Bs(i[n].clipScope,e[n].clipScope))return!1;return!0}function hD(i,e,n){let s=1/st,c=1/(1<<n.canonical.z),f=(e.x*s+n.canonical.x)*c+n.wrap,p=(e.y*s+n.canonical.y)*c;return{min:new Xe((i.x*s+n.canonical.x)*c+n.wrap,(i.y*s+n.canonical.y)*c),max:new Xe(f,p)}}function ok(i,e,n){let s=1<<n.canonical.z,c=((e.x-n.wrap)*s-n.canonical.x)*st,f=(e.y*s-n.canonical.y)*st;return{min:new Xe(((i.x-n.wrap)*s-n.canonical.x)*st,(i.y*s-n.canonical.y)*st),max:new Xe(c,f)}}function v1(i,e,n,s,c,f,p){let y=i.indices,x=i.vertices,w=[];for(let I=s;I<s+c;I+=3){let S=e[n[I+0]+f],D=e[n[I+1]+f],P=e[n[I+2]+f],O=Math.min(S.x,D.x,P.x),N=Math.max(S.x,D.x,P.x),B=Math.min(S.y,D.y,P.y),G=Math.max(S.y,D.y,P.y);w.length=0,i.grid.query(new Xe(O,B),new Xe(N,G),w);for(let X=0;X<w.length;X++){let q=w[X];if(ei(x[y[3*q+0]],x[y[3*q+1]],x[y[3*q+2]],S,D,P,p))return!0}}return!1}function fD(i,e,n,s){if(!i||!n)return!1;let c=i.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(n.vertices.length<i.vertices.length)return fD(n,s,i,e);let f=e.canonical,p=s.canonical,y=Math.pow(2,p.z-f.z);c=i.vertices.map(x=>new Xe((x.x+f.x*st)*y-p.x*st,(x.y+f.y*st)*y-p.y*st))}return v1(n,c,i.indices,0,i.indices.length,0,0)}function pD(i,e,n,s){let c=Math.pow(2,s.z-n.z);return new Xe((i+n.x*st)*c-s.x*st,(e+n.y*st)*c-s.y*st)}function x1(i,e){let n=[];e.grid.queryPoint(i,n);let s=e.indices,c=e.vertices;for(let f=0;f<n.length;f++){let p=n[f];if(Ii([c[s[3*p+0]],c[s[3*p+1]],c[s[3*p+2]]],i))return!0}return!1}let b1=[new Xe(0,0),new Xe(st,0),new Xe(st,st),new Xe(0,st)];function mD(i,e){let n=[],s=[];if(!e||i.length<2)return[i];if(i.length===2)return Dr(i[0],i[1],b1)?[i]:[];for(let c=0;c<i.length+2;c++){let f=i[c%i.length],p=i[(c+1)%i.length],y=Dr(c===0?i[i.length-1]:i[(c-1)%i.length],f,b1),x=Dr(f,p,b1),w=y||x;w&&s.push(f),w&&x||s.length>0&&(s.length>1&&n.push(s),s=[])}return s.length>1&&n.push(s),n}let w1=Se.types,sk=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],ak=["fill-extrusion-flood-light-ground-radius"],lk=Math.pow(2,13),ck=Math.pow(2,15)-1,gD=new Xe(0,1),Pc=2147483648;function Gm(i,e,n,s,c,f,p,y){i.emplaceBack((e<<1)+p,(n<<1)+f,(Math.floor(s*lk)<<1)+c,Math.round(y))}function $m(i,e,n){i.emplaceBack(e.x*st,e.y*st,n?1:0)}function sv(i,e,n,s,c,f){i.emplaceBack(e.x,e.y,(n.x<<1)+s,(n.y<<1)+c,f)}function Wm(i,e,n){i.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class _D{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class yD{constructor(){this.centroidXY=new Xe(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Xe(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Xe(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Xe(this.max.x-this.min.x,this.max.y-this.min.y)}}class vD{constructor(){this.acc=new Xe(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,n){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=n.x,e.min.y=e.max.y=n.y)}appendEdge(e,n,s){this.accCount++,this.acc._add(n);let c=!!this.borders;n.x<e.min.x?(e.min.x=n.x,c=!0):n.x>e.max.x&&(e.max.x=n.x,c=!0),n.y<e.min.y?(e.min.y=n.y,c=!0):n.y>e.max.y&&(e.max.y=n.y,c=!0),((n.x===0||n.x===st)&&n.x===s.x)!=((n.y===0||n.y===st)&&n.y===s.y)&&this.processBorderOverlap(n,s),c&&this.checkBorderIntersection(n,s)}checkBorderIntersection(e,n){n.x<0!=e.x<0&&this.addBorderIntersection(0,At(n.y,e.y,(0-n.x)/(e.x-n.x))),n.x>st!=e.x>st&&this.addBorderIntersection(1,At(n.y,e.y,(st-n.x)/(e.x-n.x))),n.y<0!=e.y<0&&this.addBorderIntersection(2,At(n.x,e.x,(0-n.y)/(e.y-n.y))),n.y>st!=e.y>st&&this.addBorderIntersection(3,At(n.x,e.x,(st-n.y)/(e.y-n.y)))}addBorderIntersection(e,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let s=this.borders[e];n<s[0]&&(s[0]=n),n>s[1]&&(s[1]=n)}processBorderOverlap(e,n){if(e.x===n.x){if(e.y===n.y)return;let s=e.x===0?0:1;this.addBorderIntersection(s,n.y),this.addBorderIntersection(s,e.y)}else{let s=e.y===0?2:3;this.addBorderIntersection(s,n.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new Xe(0,0):new Xe(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,n)=>e+ +(n[0]!==Number.MAX_VALUE),0):0}}function xD(i,e){let n=i.add(e)._unit(),s=ne(i.x*n.x+i.y*n.y,-1,1);var c,f,p;return c=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(c)))/4*ck*((f=i).x*(p=e).y-f.y*p.x<0?-1:1)}let uk=[i=>i.x<0,i=>i.x>st,i=>i.y<0,i=>i.y>st];function dk(i,e,n,s){let c=[4];if(s===0)return c;n._mult(s);let f=i.sub(n),p=e.sub(n),y=[i,e,f,p];for(let x=0;x<4;x++)for(let w of y)if(uk[x](w)){c.push(x);break}return c}class E1{constructor(e){this.vertexArray=new Vh,this.indexArray=new dr,this.programConfigurations=new Oo(e.layers,{zoom:e.zoom,lut:e.lut},n=>ak.includes(n)),this._segments=new _r,this.hiddenByLandmarkVertexArray=new Wh,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new _r}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,n,s,c=!1){let f=e.length;if(f>2){let p=Math.max(0,this._segments.get().length-1),y=this._segments._prepareSegment(4*f,this.vertexArray.length,2*this._segmentToGroundQuads[p].length),x;p!==this._segments.get().length-1&&(p++,this._segmentToGroundQuads[p]=[],this._segmentToRegionTriCounts[p]=[0,0,0,0,0]);{let w=e[0],I=e[1];x=xD(w.sub(e[f-1])._perp()._unit(),I.sub(w)._perp()._unit())}for(let w=0;w<f;w++){let I=w===f-1?0:w+1,S=e[w],D=e[I],P=e[I===f-1?0:I+1],O=D.sub(S)._perp()._unit(),N=xD(O,P.sub(D)._perp()._unit()),B=x,G=N;if(T1(S,D,n)||c&&ED(S,n)&&ED(D,n)){x=N;continue}let X=y.vertexLength;sv(this.vertexArray,S,D,1,1,B),sv(this.vertexArray,S,D,1,0,B),sv(this.vertexArray,S,D,0,1,G),sv(this.vertexArray,S,D,0,0,G),y.vertexLength+=4;let q=dk(S,D,O,s);for(let K of q)this._segmentToGroundQuads[p].push({id:X,region:K}),this._segmentToRegionTriCounts[p][K]+=2,y.primitiveLength+=2;x=N}}}prepareBorderSegments(){if(!this.hasData())return;let e=this._segments.get(),n=e.length;for(let s=0;s<n;s++)this._segmentToGroundQuads[s].sort((c,f)=>c.region-f.region);for(let s=0;s<n;s++){let c=this._segmentToGroundQuads[s],f=e[s],p=this._segmentToRegionTriCounts[s];p.reduce((x,w)=>x+w,0);let y=0;for(let x=0;x<=4;x++){let w=p[x];if(w!==0){let I=this.regionSegments[x];I||(I=this.regionSegments[x]=new _r);let S={vertexOffset:f.vertexOffset,primitiveOffset:f.primitiveOffset+y,vertexLength:f.vertexLength,primitiveLength:w};I.get().push(S)}y+=w}for(let x=0;x<c.length;x++){let w=c[x].id;this.indexArray.emplaceBack(w,w+1,w+3),this.indexArray.emplaceBack(w,w+3,w+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,n,s,c,f,p,y){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,n,s,c,f,p,void 0,y)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,QF.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,n,s,c,f,p,y,x){this.hasData()&&this.programConfigurations.updatePaintArrays(e,n,s,c,f,p,y,x)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Pc))}updateHiddenByLandmarkRange(e,n,s){if(!this.hasData())return;let c=n+e;if(n!==0){for(let f=e;f<c;++f)this.hiddenByLandmarkVertexArray.emplace(f,s?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,nk.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){let n=this.regionSegments[e];n&&n.destroy()}}}}class av{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new dr,this.footprintVertices=new io,this.footprintSegments=[],this.layoutVertexArray=new vc,this.centroidVertexArray=new Vy,this.wallVertexArray=new jy,this.indexArray=new dr,this.programConfigurations=new Oo(e.layers,{zoom:e.zoom,lut:e.lut},n=>sk.includes(n)),this.segments=new _r,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new E1(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){this.features=[],this.hasPattern=f1("fill-extrusion",this.layers,this.pixelRatio,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=oe(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:f,id:p,index:y,sourceLayerIndex:x}of e){let w=this.layers[0]._featureFilter.needGeometry,I=Pe(f,w);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom,{worldview:this.worldview}),I,s))continue;let S={id:p,sourceLayerIndex:x,index:y,geometry:w?I.geometry:pe(f,s,c),properties:f.properties,type:f.type,patterns:{}},D=this.layoutVertexArray.length,P=w1[S.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:f.id,feature:p1("fill-extrusion",this.layers,S,this.zoom,this.pixelRatio,n)});else if(this.wallMode)for(let O of S.geometry)for(let N of mD(O,P))this.addFeature(f.id,S,[N],y,s,{},n.availableImages,c,n.brightness);else this.addFeature(f.id,S,S.geometry,y,s,{},n.availableImages,c,n.brightness);n.featureIndex.insert(f,S.geometry,y,x,this.index,D)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,n,s,c,f,p){for(let{featureId:y,feature:x}of this.features){let w=w1[x.type]==="Polygon",{geometry:I}=x;if(this.wallMode)for(let S of I)for(let D of mD(S,w))this.addFeature(y,x,[D],x.index,n,s,c,f,p);else this.addFeature(y,x,I,x.index,n,s,c,f,p)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,n,s,c,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview),this.groundEffect.update(e,n,f,s,c,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,ik),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,tk.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,rk.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,ek.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,n,s,c,f,p,y,x,w){let I=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(n,{})/this.tileToMeter,S=[new Xe(0,0),new Xe(st,st)],D=x.projection,P=D.name==="globe",O=this.wallMode||w1[n.type]==="Polygon",N=new vD;N.centroidDataIndex=this.centroidData.length;let B=new yD;B.buildingId=e,n.properties&&n.properties.hasOwnProperty("building_id")&&(B.buildingId=n.properties.building_id);let G=this.layers[0].paint.get("fill-extrusion-base").evaluate(n,{},f)<=0,X=this.layers[0].paint.get("fill-extrusion-height").evaluate(n,{},f),q;if(B.height=X,B.vertexArrayOffset=this.layoutVertexArray.length,B.groundVertexArrayOffset=this.groundEffect.vertexArray.length,P&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new jh),this.wallMode){if(P)return void fn("Non zero fill-extrusion-line-width is not yet supported on globe.");if(s.length!==1)return;q=function(be){let ze=be[0].x===be[be.length-1].x&&be[0].y===be[be.length-1].y;(function(Ke){let xt=0,pt=Ke.length;for(let at=0;at<pt;at++)xt+=(Ke[(at+1)%pt].x-Ke[at].x)*(Ke[(at+1)%pt].y+Ke[at].y);return xt>=0})(be)||(be=be.reverse());let Ue={geometry:[],joinNormals:[],indices:[]},Ze=[],Je=[],Le=[],qe=be.length;for(;qe>=2&&be[qe-1].equals(be[qe-2]);)qe--;if(qe<(ze?3:2))return Ue;let we,Fe,rt,Ye,Et,yt=0;for(;yt<qe-1&&be[yt].equals(be[yt+1]);)yt++;ze&&(we=be[qe-2],Et=be[yt].sub(we)._unit()._perp());for(let Ke=yt;Ke<qe;Ke++){if(rt=Ke===qe-1?ze?be[yt+1]:void 0:be[Ke+1],rt&&be[Ke].equals(rt))continue;Et&&(Ye=Et),we&&(Fe=we),we=be[Ke],Et=rt?rt.sub(we)._unit()._perp():Ye,Ye=Ye||Et;let xt=Ye.add(Et);xt.x===0&&xt.y===0||xt._unit();let pt=xt.x*Et.x+xt.y*Et.y,at=pt!==0?1/pt:1/0,mt=Ye.x*Et.y-Ye.y*Et.x>0,Rt="miter",Bt=2;Rt==="miter"&&at>Bt&&(Rt="bevel"),Rt==="bevel"&&(at>100&&(Rt="flipbevel"),at<Bt&&(Rt="miter"));let qt=(Gt,pn,nn,nr)=>{let Q=new Xe(Gt.x,Gt.y),ee=new Xe(Gt.x,Gt.y);Q.x+=pn.x*nr,Q.y+=pn.y*nr,ee.x-=pn.x*Math.max(nn,1),ee.y-=pn.y*Math.max(nn,1),Le.push(pn),Ze.push(Q),Je.push(ee)};if(Rt==="miter")xt._mult(at),qt(we,xt,0,0);else if(Rt==="flipbevel")xt=Et.mult(-1),qt(we,xt,0,0),qt(we,xt.mult(-1),0,0);else{let Gt=-Math.sqrt(at*at-1),pn=mt?Gt:0,nn=mt?0:Gt;Fe&&qt(we,Ye,pn,nn),rt&&qt(we,Et,pn,nn)}}Ue.geometry=[...Ze,...Je.reverse(),Ze[0]],Ue.joinNormals=[...Le,...Le.reverse(),Le[Le.length-1]];let $e=Ue.geometry.length-1;for(let Ke=0;Ke<$e/2;Ke++)if(Ke+1<$e/2){let xt=Ke,pt=Ke+1,at=$e-1-Ke,mt=$e-2-Ke;xt=xt===0?$e-1:xt-1,pt=pt===0?$e-1:pt-1,at=at===0?$e-1:at-1,mt=mt===0?$e-1:mt-1,Ue.indices.push(at),Ue.indices.push(pt),Ue.indices.push(xt),Ue.indices.push(at),Ue.indices.push(mt),Ue.indices.push(pt)}return Ue}(s[0]),s=[q.geometry]}let K=(be,ze)=>be<(ze.length-1)/2||be===ze.length-1,he=this.wallMode?[s]:jm(s,500);for(let be=he.length-1;be>=0;be--){let ze=he[be];(ze.length===0||(le=ze[0]).every(et=>et.x<=0)||le.every(et=>et.x>=st)||le.every(et=>et.y<=0)||le.every(et=>et.y>=st))&&he.splice(be,1)}var le;let ue;if(P)ue=DD(he,S,f);else{ue=[];for(let be of he)ue.push({polygon:be,bounds:S})}let ge=O?this.edgeRadius:0,ye=ge>0&&this.zoom<17,ke=(be,ze)=>{if(be.length===0)return!1;let et=be[be.length-1];return ze.x===et.x&&ze.y===et.y};for(let{polygon:be,bounds:ze}of ue){let et=0,Ue=0;for(let qe of be)O&&!qe[0].equals(qe[qe.length-1])&&qe.push(qe[0]),Ue+=O?qe.length-1:qe.length;let Ze=this.segments.prepareSegment((O?5:4)*Ue,this.layoutVertexArray,this.indexArray);B.footprintSegIdx<0&&(B.footprintSegIdx=this.footprintSegments.length),B.polygonSegIdx<0&&(B.polygonSegIdx=this.polygonSegments.length);let Je={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Le=new _D;if(Le.vertexOffset=this.footprintVertices.length,Le.indexOffset=3*this.footprintIndices.length,Le.ringIndices=[],O){let qe=[],we=[];et=Ze.vertexLength;for(let rt=0;rt<be.length;rt++){let Ye=be[rt];Ye.length&&rt!==0&&we.push(qe.length/2);let Et=[],yt,$e;yt=Ye[1].sub(Ye[0])._perp()._unit(),Le.ringIndices.push(Ye.length-1);for(let Ke=1;Ke<Ye.length;Ke++){let xt=Ye[Ke],pt=Ye[Ke===Ye.length-1?1:Ke+1],at=xt.clone();if(ge){$e=pt.sub(xt)._perp()._unit();let mt=yt.add($e)._unit(),Rt=ge*Math.min(4,1/(yt.x*mt.x+yt.y*mt.y));at.x+=Rt*mt.x,at.y+=Rt*mt.y,at.x=Math.round(at.x),at.y=Math.round(at.y),yt=$e}if(!G||ge!==0&&!ye||ke(Et,at)||Et.push(at),Gm(this.layoutVertexArray,at.x,at.y,0,0,1,1,0),this.wallMode){let mt=K(Ke,Ye);$m(this.wallVertexArray,q.joinNormals[Ke],!mt)}Ze.vertexLength++,this.footprintVertices.emplaceBack(xt.x,xt.y),qe.push(xt.x,xt.y),P&&Wm(this.layoutVertexExtArray,D.projectTilePoint(at.x,at.y,f),D.upVector(f,at.x,at.y))}G&&(ge===0||ye)&&(Et.length!==0&&ke(Et,Et[0])&&Et.pop(),this.groundEffect.addData(Et,ze,I))}let Fe=this.wallMode?q.indices:Kh(qe,we);for(let rt=0;rt<Fe.length;rt+=3)this.footprintIndices.emplaceBack(Le.vertexOffset+Fe[rt+0],Le.vertexOffset+Fe[rt+1],Le.vertexOffset+Fe[rt+2]),this.indexArray.emplaceBack(et+Fe[rt],et+Fe[rt+2],et+Fe[rt+1]),Ze.primitiveLength++;Le.indexCount+=Fe.length,Le.vertexCount+=this.footprintVertices.length-Le.vertexOffset}for(let qe=0;qe<be.length;qe++){let we=be[qe];N.startRing(B,we[0]);let Fe=we.length>4&&TD(we[we.length-2],we[0],we[1]),rt=ge?hk(we[we.length-2],we[0],we[1],ge):0,Ye=[],Et,yt,$e;yt=we[1].sub(we[0])._perp()._unit();let Ke=!0;for(let xt=1,pt=0;xt<we.length;xt++){let at=we[xt-1],mt=we[xt],Rt=we[xt===we.length-1?1:xt+1];if(N.appendEdge(B,mt,at),T1(mt,at,ze)){ge&&(yt=Rt.sub(mt)._perp()._unit(),Ke=!Ke);continue}let Bt=mt.sub(at)._perp(),qt=Bt.x/(Math.abs(Bt.x)+Math.abs(Bt.y)),Gt=Bt.y>0?1:0,pn=at.dist(mt);if(pt+pn>32768&&(pt=0),ge){$e=Rt.sub(mt)._perp()._unit();let ee=wD(at,mt,Rt,bD(yt,$e),ge);isNaN(ee)&&(ee=0);let Re=mt.sub(at)._unit();at=at.add(Re.mult(rt))._round(),mt=mt.add(Re.mult(-ee))._round(),rt=ee,yt=$e,G&&this.zoom>=17&&(ke(Ye,at)||Ye.push(at),ke(Ye,mt)||Ye.push(mt))}let nn=Ze.vertexLength,nr=we.length>4&&TD(at,mt,Rt),Q=ID(pt,Fe,Ke);if(Gm(this.layoutVertexArray,at.x,at.y,qt,Gt,0,0,Q),Gm(this.layoutVertexArray,at.x,at.y,qt,Gt,0,1,Q),this.wallMode){let ee=K(xt-1,we),Re=q.joinNormals[xt-1];$m(this.wallVertexArray,Re,ee),$m(this.wallVertexArray,Re,ee)}if(pt+=pn,Q=ID(pt,nr,!Ke),Fe=nr,Gm(this.layoutVertexArray,mt.x,mt.y,qt,Gt,0,0,Q),Gm(this.layoutVertexArray,mt.x,mt.y,qt,Gt,0,1,Q),this.wallMode){let ee=K(xt,we),Re=q.joinNormals[xt];$m(this.wallVertexArray,Re,ee),$m(this.wallVertexArray,Re,ee)}if(Ze.vertexLength+=4,this.indexArray.emplaceBack(nn+0,nn+1,nn+2),this.indexArray.emplaceBack(nn+1,nn+3,nn+2),Ze.primitiveLength+=2,ge){let ee=et+(xt===1?we.length-2:xt-2),Re=xt===1?et:ee+1;if(this.indexArray.emplaceBack(nn+1,ee,nn+3),this.indexArray.emplaceBack(ee,Re,nn+3),Ze.primitiveLength+=2,Et===void 0&&(Et=nn),!T1(Rt,we[xt],ze)){let it=xt===we.length-1?Et:Ze.vertexLength;this.indexArray.emplaceBack(nn+2,nn+3,it),this.indexArray.emplaceBack(nn+3,it+1,it),this.indexArray.emplaceBack(nn+3,Re,it+1),Ze.primitiveLength+=3}Ke=!Ke}if(P){let ee=this.layoutVertexExtArray,Re=D.projectTilePoint(at.x,at.y,f),it=D.projectTilePoint(mt.x,mt.y,f),ct=D.upVector(f,at.x,at.y),lt=D.upVector(f,mt.x,mt.y);Wm(ee,Re,ct),Wm(ee,Re,ct),Wm(ee,it,lt),Wm(ee,it,lt)}}O&&(et+=we.length-1),G&&ge&&this.zoom>=17&&(Ye.length!==0&&ke(Ye,Ye[0])&&Ye.pop(),this.groundEffect.addData(Ye,ze,I,ge>0))}this.footprintSegments.push(Le),Je.triangleCount=this.indexArray.length-Je.triangleArrayOffset,this.polygonSegments.push(Je),++B.footprintSegLen,++B.polygonSegLen}if(B.vertexCount=this.layoutVertexArray.length-B.vertexArrayOffset,B.groundVertexCount=this.groundEffect.vertexArray.length-B.groundVertexArrayOffset,B.vertexCount!==0){if(B.centroidXY=N.borders?gD:this.encodeCentroid(N,B),this.centroidData.push(B),N.borders){this.featuresOnBorder.push(N);let be=this.featuresOnBorder.length-1;for(let ze=0;ze<N.borders.length;ze++)N.borders[ze][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ze].push(be)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,c,p,y,f,w,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(n,c,p,y,f,w,this.worldview),this.maxHeight=Math.max(this.maxHeight,X)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((n,s)=>this.featuresOnBorder[n].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){let e=[];for(let y=0;y<this.centroidData.length;y++){let x=this.centroidData[y],w=+(x.min.y+x.max.y>st),I=2*w+(+(x.min.x+x.max.x>st)^w);for(let S=0;S<x.polygonSegLen;S++){let D=x.polygonSegIdx+S;e.push({centroidIdx:y,subtile:I,polygonSegmentIdx:D,triangleSegmentIdx:this.polygonSegments[D].triangleSegIdx})}}let n=new dr;e.sort((y,x)=>y.triangleSegmentIdx===x.triangleSegmentIdx?y.subtile-x.subtile:y.triangleSegmentIdx-x.triangleSegmentIdx);let s=0,c=0,f=0;for(let y of e){if(y.triangleSegmentIdx!==s)break;f++}let p=e.length;for(;c!==e.length;){s=e[c].triangleSegmentIdx;let y=0,x=c,w=c;for(let I=x;I<f&&e[I].subtile===y;I++)w++;for(;x!==f;){let I=e[x];y=I.subtile;let S=this.centroidData[I.centroidIdx].min.clone(),D=this.centroidData[I.centroidIdx].max.clone(),P={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:n.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let O=x;O<w;O++){let N=e[O],B=this.polygonSegments[N.polygonSegmentIdx],G=this.centroidData[N.centroidIdx].min,X=this.centroidData[N.centroidIdx].max,q=this.indexArray.uint16;for(let K=B.triangleArrayOffset;K<B.triangleArrayOffset+B.triangleCount;K++)n.emplaceBack(q[3*K],q[3*K+1],q[3*K+2]);P.primitiveLength+=B.triangleCount,S.x=Math.min(S.x,G.x),S.y=Math.min(S.y,G.y),D.x=Math.max(D.x,X.x),D.y=Math.max(D.y,X.y)}P.primitiveLength>0&&this.triangleSubSegments.push({segment:P,min:S,max:D}),x=w;for(let O=x;O<f&&e[O].subtile===e[x].subtile;O++)w++}c=f;for(let I=c;I<p&&e[I].triangleSegmentIdx===e[c].triangleSegmentIdx;I++)f++}n._trim(),this.indexArray=n}getVisibleSegments(e,n,s){let c=new _r;if(this.wallMode){for(let N of this.triangleSubSegments)c.segments.push(N.segment);return c}let f=0,p=0,y=1<<e.canonical.z;if(n){let N=n.getMinMaxForTile(e);N&&(f=N.min,p=N.max)}p+=this.maxHeight;let x=e.toUnwrapped(),w,I=[x.canonical.x/y+x.wrap,x.canonical.y/y],S=[(x.canonical.x+1)/y+x.wrap,(x.canonical.y+1)/y],D=(N,B,G)=>[N[0]*(1-G[0])+B[0]*G[0],N[1]*(1-G[1])+B[1]*G[1]],P=[],O=[];for(let N of this.triangleSubSegments){P[0]=N.min.x/st,P[1]=N.min.y/st,O[0]=N.max.x/st,O[1]=N.max.y/st;let B=D(I,S,P),G=D(I,S,O);if(new sn([B[0],B[1],f],[G[0],G[1],p]).intersectsPrecise(s)===0){w&&(c.segments.push(w),w=void 0);continue}let X=N.segment;w&&w.vertexOffset!==X.vertexOffset&&(c.segments.push(w),w=void 0),w?(w.vertexLength+=X.vertexLength,w.primitiveLength+=X.primitiveLength):w={vertexOffset:X.vertexOffset,primitiveLength:X.primitiveLength,vertexLength:X.vertexLength,primitiveOffset:X.primitiveOffset,sortKey:void 0,vaos:{}}}return w&&c.segments.push(w),c}encodeCentroid(e,n){let s=e.centroid(),c=n.span(),f=Math.min(7,Math.round(c.x*this.tileToMeter/10)),p=Math.min(7,Math.round(c.y*this.tileToMeter/10));return new Xe(ne(s.x,1,st-1)<<3|f,ne(s.y,1,st-1)<<3|p)}encodeBorderCentroid(e){if(!e.borders)return new Xe(0,0);let n=e.borders,s=Number.MAX_VALUE;if(n[0][0]!==s||n[1][0]!==s){let c=n[0][0]!==s?0:1;return new Xe(6|(n[0][0]!==s?0:65528),(n[c][0]+n[c][1])/2<<3|6)}{let c=n[2][0]!==s?2:3;return new Xe((n[c][0]+n[c][1])/2<<3|6,6|(n[2][0]!==s?0:65528))}}showCentroid(e){let n=this.centroidData[e.centroidDataIndex];n.flags&=2147483647,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);let n=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,c=e.flags&Pc?gD:e.centroidXY,f=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==c.y||f!==c.x){for(let p=n;p<s;++p)this.centroidVertexArray.emplace(p,c.x,c.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,n,s){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let c=n.getReplacementRegionsForTile(e.toUnwrapped());if(ov(this.activeReplacements,c))return;if(this.activeReplacements=c,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let p of this.centroidData)p.flags&=2147483647;let f=[];for(let p of this.activeReplacements){if(p.order<s)continue;let y=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));if(p.footprint.buildingId){let x=p.footprint.buildingId;for(let w of this.centroidData)w.buildingId===x&&(w.flags|=Pc)}else for(let x of this.centroidData)if(!(x.flags&Pc||p.min.x>x.max.x||x.min.x>p.max.x||p.min.y>x.max.y||x.min.y>p.max.y))for(let w=0;w<x.footprintSegLen;w++){let I=this.footprintSegments[x.footprintSegIdx+w];if(f.length=0,fk(this.footprintVertices,I.vertexOffset,I.vertexCount,p.footprintTileId.canonical,e.canonical,f),v1(p.footprint,f,this.footprintIndices.uint16,I.indexOffset,I.indexCount,-I.vertexOffset,-y)){x.flags|=Pc;break}}}for(let p of this.centroidData)this.writeCentroidToBuffer(p);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,n,s){let c=!1;for(let f=0;f<s.footprintSegLen;f++){let p=this.footprintSegments[s.footprintSegIdx+f],y=0;for(let x of p.ringIndices){for(let w=y,I=x+y-1;w<x+y;I=w++){let S=this.footprintVertices.int16[2*(w+p.vertexOffset)+0],D=this.footprintVertices.int16[2*(w+p.vertexOffset)+1],P=this.footprintVertices.int16[2*(I+p.vertexOffset)+1];D>n!=P>n&&e<(this.footprintVertices.int16[2*(I+p.vertexOffset)+0]-S)*(n-D)/(P-D)+S&&(c=!c)}y=x}}return c}getHeightAtTileCoord(e,n){let s=Number.NEGATIVE_INFINITY,c=!0,f=4*(e+st)*st+(n+st);if(this.partLookup.hasOwnProperty(f)){let p=this.partLookup[f];return p?{height:p.height,hidden:!!(p.flags&Pc)}:void 0}for(let p of this.centroidData)e>p.max.x||p.min.x>e||n>p.max.y||p.min.y>n||p.height<=s||this.footprintContainsPoint(e,n,p)&&(s=p.height,this.partLookup[f]=p,c=!!(p.flags&Pc));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:c};this.partLookup[f]=void 0}}function bD(i,e){let n=i.add(e)._unit();return i.x*n.x+i.y*n.y}function hk(i,e,n,s){let c=e.sub(i)._perp()._unit(),f=n.sub(e)._perp()._unit();return wD(i,e,n,bD(c,f),s)}function wD(i,e,n,s,c){let f=Math.sqrt(1-s*s);return Math.min(i.dist(e)/3,e.dist(n)/3,c*f/s)}function T1(i,e,n){return i.x<n[0].x&&e.x<n[0].x||i.x>n[1].x&&e.x>n[1].x||i.y<n[0].y&&e.y<n[0].y||i.y>n[1].y&&e.y>n[1].y}function ED(i,e){return i.x<e[0].x||i.x>e[1].x||i.y<e[0].y||i.y>e[1].y}function TD(i,e,n){if(i.x<0||i.x>=st||e.x<0||e.x>=st||n.x<0||n.x>=st)return!1;let s=n.sub(e),c=s.perp(),f=i.sub(e);return(s.x*f.x+s.y*f.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(f.x*f.x+f.y*f.y))>-.866&&c.x*f.x+c.y*f.y<0}function ID(i,e,n){let s=e?2|i:-3&i;return n?1|s:-2&s}function SD(){let i=Math.PI/32,e=Math.tan(i),n=T;return n*Math.sqrt(1+2*e*e)-n}function DD(i,e,n){let s=1<<n.z,c=Z(n.x/s),f=Z((n.x+1)/s),p=Y(n.y/s),y=Y((n.y+1)/s);return function(x,w,I,S,D=0,P){let O=[];if(!x.length||!I||!S)return O;let N=(le,ue)=>{for(let ge of le)O.push({polygon:ge,bounds:ue})},B=Math.ceil(Math.log2(I)),G=Math.ceil(Math.log2(S)),X=B-G,q=[];for(let le=0;le<Math.abs(X);le++)q.push(X>0?0:1);for(let le=0;le<Math.min(B,G);le++)q.push(0),q.push(1);let K=x;if(K=nv(K,w[0].y-D,w[1].y+D,1),K=nv(K,w[0].x-D,w[1].x+D,0),!K.length)return O;let he=[];for(q.length?he.push({polygons:K,bounds:w,depth:0}):N(K,w);he.length;){let le=he.pop(),ue=le.depth,ge=q[ue],ye=le.bounds[0],ke=le.bounds[1],be=ge===0?ye.x:ye.y,ze=ge===0?ke.x:ke.y,et=P?P(ge,be,ze):.5*(be+ze),Ue=nv(le.polygons,be-D,et+D,ge),Ze=nv(le.polygons,et-D,ze+D,ge);if(Ue.length){let Je=[ye,new Xe(ge===0?et:ke.x,ge===1?et:ke.y)];q.length>ue+1?he.push({polygons:Ue,bounds:Je,depth:ue+1}):N(Ue,Je)}if(Ze.length){let Je=[new Xe(ge===0?et:ye.x,ge===1?et:ye.y),ke];q.length>ue+1?he.push({polygons:Ze,bounds:Je,depth:ue+1}):N(Ze,Je)}}return O}(i,e,Math.ceil((f-c)/11.25),Math.ceil((p-y)/11.25),1,(x,w,I)=>{if(x===0)return .5*(w+I);{let S=Y((n.y+w/st)/s);return(H(.5*(Y((n.y+I/st)/s)+S))*s-n.y)*st}})}function fk(i,e,n,s,c,f){let p=Math.pow(2,s.z-c.z);for(let y=0;y<n;y++){let x=i.int16[2*(y+e)+0],w=i.int16[2*(y+e)+1];x=(x+c.x*st)*p-s.x*st,w=(w+c.y*st)*p-s.y*st,f.push(new Xe(x,w))}}let CD,AD;_t(av,"FillExtrusionBucket",{omit:["layers","features"]}),_t(yD,"PartData"),_t(_D,"FootprintSegment"),_t(vD,"BorderCentroidData"),_t(E1,"GroundEffect");class sd extends Xe{constructor(e,n,s){super(e,n),this.z=s}}class MD extends sd{constructor(e,n,s,c){super(e,n,s),this.w=c}}function RD(i,e,n,s){let c=n==="x"?"y":"x",f=(s-i[n])/(e[n]-i[n]);i[c]=Math.round(i[c]+(e[c]-i[c])*f),i[n]=s,i.hasOwnProperty("z")&&(i.z=At(i.z,e.z,f)),i.hasOwnProperty("w")&&(i.w=At(i.w,e.w,f))}function PD(i,e,n,s){let c=n,f=s;for(let p of["x","y"]){let y=i,x=e;y[p]>=x[p]&&(y=e,x=i),y[p]<c&&x[p]>c&&RD(y,x,p,c),y[p]<f&&x[p]>f&&RD(x,y,p,f)}}function lv(i,e,n,s,c,f){let p=[];for(let y=0;y<i.length;y++){let x=i[y],w,I=p.length,S=0;for(let D=0;D<x.length-1;D++){let P=x[D],O=x[D+1],N=0,B=S,G,X;f&&(N=Math.hypot(O.x-P.x,O.y-P.y),S+=N,G=P,X=O),P.x<e&&O.x<e||(P.x<e?P=new Xe(e,P.y+(e-P.x)/(O.x-P.x)*(O.y-P.y))._round():O.x<e&&(O=new Xe(e,P.y+(e-P.x)/(O.x-P.x)*(O.y-P.y))._round()),P.y<n&&O.y<n||(P.y<n?P=new Xe(P.x+(n-P.y)/(O.y-P.y)*(O.x-P.x),n)._round():O.y<n&&(O=new Xe(P.x+(n-P.y)/(O.y-P.y)*(O.x-P.x),n)._round()),P.x>=s&&O.x>=s||(P.x>=s?P=new Xe(s,P.y+(s-P.x)/(O.x-P.x)*(O.y-P.y))._round():O.x>=s&&(O=new Xe(s,P.y+(s-P.x)/(O.x-P.x)*(O.y-P.y))._round()),P.y>=c&&O.y>=c||(P.y>=c?P=new Xe(P.x+(c-P.y)/(O.y-P.y)*(O.x-P.x),c)._round():O.y>=c&&(O=new Xe(P.x+(c-P.y)/(O.y-P.y)*(O.x-P.x),c)._round()),w&&P.equals(w[w.length-1])||(w=[P],p.push(w),f&&f.push({progress:{min:B+OD(G,X,P)*N,max:1},parentIndex:y,prevPoint:G,nextPoint:X})),w.push(O),f&&(f[f.length-1].progress.max=B+OD(G,X,O)*N,f[f.length-1].nextPoint=X)))))}if(f&&S>0)for(let D=I;D<p.length;D++)f[D].progress.min/=S,f[D].progress.max/=S}return p}function pk(i,e,n,s,c){if(i.length<2)return void s.push(i);let f=[];for(;e.valid();){let[w,I]=e.get();for(let S=0;S<i.length-1;S++){let D=i[S],P=i[S+1],O=go(D,P,w,I);if(O){let[N]=O,B=new Xe(At(D.x,P.x,N),At(D.y,P.y,N));f.push({t:S+N,distance:0,point:B})}}e.next()}if(f.length===0)return void s.push(i);f.sort((w,I)=>w.t-I.t);let p=0,y=0,x=[];for(s.push(x);p!==i.length;){if(y===f.length){for(;p!==i.length;)x.length!==0&&x[x.length-1].equals(i[p])||x.push(i[p]),p++;break}f[y].t<=p?(x.length!==0&&x[x.length-1].equals(f[y].point)||x.push(f[y].point),Math.trunc(f[y].t),y++):(x.length!==0&&x[x.length-1].equals(i[p])||x.push(i[p]),p++)}}function OD(i,e,n){return i.x!==e.x?(n.x-i.x)/(e.x-i.x):i.y!==e.y?(n.y-i.y)/(e.y-i.y):0}function Zm(i,e){return i.x*e.x+i.y*e.y}function LD(i,e){if(i.length===1){let n=0,s=e[n++],c;for(;!c||s.equals(c);)if(c=e[n++],!c)return 1/0;for(;n<e.length;n++){let f=e[n],p=i[0],y=c.sub(s),x=f.sub(s),w=p.sub(s),I=Zm(y,y),S=Zm(y,x),D=Zm(x,x),P=Zm(w,y),O=Zm(w,x),N=I*D-S*S,B=(D*P-S*O)/N,G=(I*O-S*P)/N,X=s.z*(1-B-G)+c.z*B+f.z*G;if(isFinite(X))return X}return 1/0}{let n=1/0;for(let s of e)n=Math.min(n,s.z);return n}}function FD(i,e,n,s,c,f,p,y){let x=p*c.getElevationAt(i,e,!0,!0),w=f[0]!==0,I=w?f[1]===0?p*(f[0]/7-450):p*function(S,D,P){let O=Math.floor(D[0]/8),N=Math.floor(D[1]/8),B=10*(D[0]-8*O),G=10*(D[1]-8*N),X=S.getElevationAt(O,N,!0,!0),q=S.getMeterToDEM(P),K=Math.floor(.5*(B*q-1)),he=Math.floor(.5*(G*q-1)),le=S.tileCoordToPixel(O,N),ue=2*K+1,ge=2*he+1,ye=function(Ze,Je,Le,qe,we){return[Ze.getElevationAtPixel(Je,Le,!0),Ze.getElevationAtPixel(Je+we,Le,!0),Ze.getElevationAtPixel(Je,Le+we,!0),Ze.getElevationAtPixel(Je+qe,Le+we,!0)]}(S,le.x-K,le.y-he,ue,ge),ke=Math.abs(ye[0]-ye[1]),be=Math.abs(ye[2]-ye[3]),ze=Math.abs(ye[0]-ye[2])+Math.abs(ye[1]-ye[3]),et=Math.min(.25,.5*q*(ke+be)/ue),Ue=Math.min(.25,.5*q*ze/ge);return X+Math.max(et*B,Ue*G)}(c,f,y):x;return{base:x+(n===0?-1:n),top:w?Math.max(I+s,x+n+2):x+s}}class mk{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class gk{constructor(){this.tasks={},this.taskQueue=[],kt(["process"],this),this.invoker=new mk(this.process),this.nextId=0}add(e,n){let s=this.nextId++,c=function({type:f,isSymbolTile:p,zoom:y}){return y=y||0,f==="message"?0:f!=="maybePrepare"||p?f!=="parseTile"||p?f==="parseTile"&&p?300-y:f==="maybePrepare"&&p?400-y:500:200-y:100-y}(n);if(c===0){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:n,priority:c,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;let e=this.pick();if(e===null)return;let n=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let e=null,n=1/0;for(let c=0;c<this.taskQueue.length;c++){let f=this.tasks[this.taskQueue[c]];f.priority<n&&(n=f.priority,e=c)}if(e===null)return null;let s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class kD{constructor(e,n,s){this.target=e,this.parent=n,this.mapId=s,this.callbacks={},this.cancelCallbacks={},kt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new gk}send(e,n,s,c,f=!1,p){let y=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=p,this.callbacks[y]=s);let x=new Set;return this.target.postMessage({id:y,type:e,hasCallback:!!s,targetMapId:c,mustQueue:f,sourceMapId:this.mapId,data:$s(n,x)},x),{cancel:()=>{s&&delete this.callbacks[y],this.target.postMessage({id:y,type:"<cancel>",targetMapId:c,sourceMapId:this.mapId})}}}receive(e){let n=e.data;if(!n)return;let s=n.id;if(s&&(!n.targetMapId||this.mapId===n.targetMapId))if(n.type==="<cancel>"){let c=this.cancelCallbacks[s];delete this.cancelCallbacks[s],c&&c.cancel()}else if(n.mustQueue||$n(self)){let c=this.callbacks[s],f=this.scheduler.add(()=>this.processTask(s,n),c&&c.metadata||{type:"message"});f&&(this.cancelCallbacks[s]=f)}else this.processTask(s,n)}processTask(e,n){if(delete this.cancelCallbacks[e],n.type==="<response>"){let s=this.callbacks[e];delete this.callbacks[e],s&&(n.error?s(ro(n.error)):s(null,ro(n.data)))}else{let s=new Set,c=n.hasCallback?(p,y)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:p?$s(p):null,data:$s(y,s)},s)}:()=>{},f=ro(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,f,c);else if(this.parent.getWorkerSource){let p=n.type.split("."),{source:y,scope:x}=f;this.parent.getWorkerSource(n.sourceMapId,p[0],y,x)[p[1]](f,c)}else c(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var qm={workerUrl:"",workerClass:null,workerParams:void 0};let I1="mapboxgl_preloaded_worker_pool",cv=(()=>{class i{constructor(){this.active={}}acquire(n,s=i.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<s;)this.workers.push(qm.workerClass!=null?new qm.workerClass:new self.Worker(qm.workerUrl,qm.workerParams));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.workers&&this.numActive()===0&&(this.workers.forEach(s=>{s.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[I1]}numActive(){return Object.keys(this.active).length}}return i.workerCount=2,i})();class Qh{constructor(e,n,s="Worker",c=cv.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=je();let f=this.workerPool.acquire(this.id,c);for(let p=0;p<f.length;p++){let y=new Qh.Actor(f[p],n,this.id);y.name=`${s} ${p}`,this.actors.push(y)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,n,s){ve(this.actors,(c,f)=>{c.send(e,n,f)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Xm,S1;function uv(){return Xm||(Xm=new cv),Xm}Qh.Actor=kD;class _k{constructor(e){this.module=e}createIntArray(e){let n=new Int32Array(e),s=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heap32.set(n,s/n.BYTES_PER_ELEMENT),s}createFloatArray(e){let n=new Float32Array(e),s=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heapF32.set(n,s/n.BYTES_PER_ELEMENT),s}createStringBuffer(e){let n=this.module.malloc(e.length+1);for(let s=0;s<e.length;++s)this.module.heapU8[n+s]=e.charCodeAt(s);return this.module.heapU8[n+e.length]=0,n}readStringBuffer(e){let n="";for(;this.module.heapU8[e]!==0;)n+=String.fromCharCode(this.module.heapU8[e]),++e;return n}setStyle(e){let n=e.entranceColorRgb,s=e.facadeGlazingColorRgb,c=e.roofColorRgb,f=e.wallColorRgb,p=e.normalScale;this.module.setStyle(n[0],n[1],n[2],s[0],s[1],s[2],c[0],c[1],c[2],f[0],f[1],f[2],p[0],p[1],p[2],e.tileToMeters)}setAOOptions(e,n){this.module.setAOOptions(e?1:0,n)}setMetricOptions(e,n){this.module.setMetricOptions(e?1:0,n)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,n){this.module.setFacadeOptions(e,n?1:0)}setFauxFacadeOptions(e,n,s){this.module.setFauxFacadeOptions(e?1:0,n?1:0,s)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,n){for(let y of e){let x=this.createStringBuffer(y.roofType),w=[0],I=[];for(let P of y.coordinates)if(Array.isArray(P)){for(let O of P)I.push(O.x),I.push(O.y);w.push(I.length)}let S=this.createIntArray(w),D=this.createFloatArray(I);this.module.addFeature(y.id,y.sourceId,y.minHeight,y.height,x,y.roofType.length,D,S,w.length-1),this.module.free(x),this.module.free(S),this.module.free(D)}for(let y of n){let x;x=y.entrances?JSON.parse(y.entrances):[];let w=this.createFloatArray(x),I=[];for(let D of y.coordinates)I.push(D.x),I.push(D.y);let S=this.createFloatArray(I);this.module.addFacade(y.sourceId,y.crossPerc,y.distanceToRoad,w,x.length,S,I.length),this.module.free(w),this.module.free(S)}if(!this.module.generateMesh()){let y=this.module.getLastError();return this.readStringBuffer(y)}let s=this.module.getMeshCount(),c=new Array(s);for(let y=0;y<s;y++){let x=this.module.getPositionsPtr(y),w=this.module.getPositionsLength(y),I=new Float32Array(this.module.heapF32.buffer,x,w),S=this.module.getNormalsPtr(y),D=this.module.getNormalsLength(y),P=new Float32Array(this.module.heapF32.buffer,S,D),O=this.module.getColorsPtr(y),N=this.module.getColorsLength(y),B=new Uint8Array(this.module.heapU8.buffer,O,N),G=this.module.getAOPtr(y),X=this.module.getAOLength(y),q=new Float32Array(this.module.heapF32.buffer,G,X),K=this.module.getUVPtr(y),he=this.module.getUVLength(y),le=new Float32Array(this.module.heapF32.buffer,K,he),ue=this.module.getFauxFacadePtr(y),ge=this.module.getFauxFacadeLength(y),ye=new Uint8Array(this.module.heapU8.buffer,ue,ge),ke=this.module.getIndicesPtr(y),be=this.module.getIndicesLength(y),ze=new Int32Array(this.module.heap32.buffer,ke,be),et=this.module.getBuildingPart(y),Ue=this.readStringBuffer(et);c[y]={positions:I,normals:P,colors:B,ao:q,uv:le,isFauxFacade:ye,indices:ze,buildingPart:Ue}}let f=this.module.getRingCount(),p=[];for(let y=0;y<f;y++){let x=this.module.getRingPtr(y),w=this.module.getRingLength(y),I=new Float32Array(this.module.heapF32.buffer,x,w);p.push(I)}return{meshes:c,modifiedPolygonRings:p}}}let Ym,D1,Zs,ef,C1,tf=null,nf=null,ND=null,dv=null;function zD(){return $n(self)&&self.worker.dracoUrl?self.worker.dracoUrl:D1||vi.DRACO_URL}function BD(){if($n(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(ef)return ef;let i=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return ef=WebAssembly.validate(i)?vi.MESHOPT_SIMD_URL:vi.MESHOPT_URL,ef}function yk(){return dv}let hv={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},vk={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Km={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function VD(i,e,n){let s=n.json.bufferViews.length,c=n.buffers.length;e.bufferView=s,n.json.bufferViews[s]={buffer:c,byteLength:i.byteLength},n.buffers[c]=i}let A1="KHR_draco_mesh_compression";function xk(i,e){let n=i.extensions&&i.extensions[A1];if(!n)return;let s=new Zs.Decoder,c=GD(e,n.bufferView),f=new Zs.Mesh;if(!s.DecodeArrayToMesh(c,c.byteLength,f))throw new Error("Failed to decode Draco mesh");let p=e.json.accessors[i.indices],y=hv[p.componentType],x=p.count*y.BYTES_PER_ELEMENT,w=Zs._malloc(x);y===Uint16Array?s.GetTrianglesUInt16Array(f,x,w):s.GetTrianglesUInt32Array(f,x,w),VD(Zs.memory.buffer.slice(w,w+x),p,e),Zs._free(w);for(let I of Object.keys(n.attributes)){let S=s.GetAttributeByUniqueId(f,n.attributes[I]),D=e.json.accessors[i.attributes[I]],P=vk[D.componentType],O=D.count*Km[D.type]*hv[D.componentType].BYTES_PER_ELEMENT,N=Zs._malloc(O);s.GetAttributeDataArrayForAllPoints(f,S,Zs[P],O,N),VD(Zs.memory.buffer.slice(N,N+O),D,e),Zs._free(N)}s.destroy(),f.destroy(),delete i.extensions[A1]}let fv="EXT_meshopt_compression";function bk(i,e){if(!i.extensions||!i.extensions[fv])return;let n=i.extensions[fv],s=new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength||0),c=new Uint8Array(n.count*n.byteStride);C1.decodeGltfBuffer(c,n.count,n.byteStride,s,n.mode,n.filter),i.buffer=e.buffers.length,i.byteOffset=0,e.buffers[i.buffer]=c.buffer,delete i.extensions[fv]}let UD=1179937895,jD=new TextDecoder("utf8");function HD(i,e){return new URL(i,e).href}function wk(i,e,n,s){return fetch(HD(i.uri,s)).then(c=>c.arrayBuffer()).then(c=>{e.buffers[n]=c})}function GD(i,e){let n=i.json.bufferViews[e];return new Uint8Array(i.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function Ek(i,e,n,s){if(i.uri){let c=HD(i.uri,s);return fetch(c).then(f=>f.blob()).then(f=>createImageBitmap(f)).then(f=>{e.images[n]=f})}if(i.bufferView!==void 0){let c=GD(e,i.bufferView),f=new Blob([c],{type:i.mimeType});return createImageBitmap(f).then(p=>{e.images[n]=p})}}function $D(i,e=0,n){let s={json:null,images:[],buffers:[]};if(new Uint32Array(i,e,1)[0]===UD){let I=new Uint32Array(i,e),S=2,D=(I[S++]>>2)-3,P=I[S++]>>2;if(S++,s.json=JSON.parse(jD.decode(I.subarray(S,S+P))),S+=P,S<D){let O=I[S++];S++;let N=e+(S<<2);s.buffers[0]=i.slice(N,N+O)}}else s.json=JSON.parse(jD.decode(new Uint8Array(i,e)));let{buffers:c,images:f,meshes:p,extensionsUsed:y,bufferViews:x}=s.json,w=Promise.resolve();if(c){let I=[];for(let S=0;S<c.length;S++){let D=c[S];D.uri?I.push(wk(D,s,S,n)):s.buffers[S]||(s.buffers[S]=null)}w=Promise.all(I)}return w.then(()=>{let I=[],S=y&&y.includes(A1),D=y&&y.includes(fv);if(S&&I.push(function(){if(!Zs)return Ym??(Ym=function(P){let O,N=null;function B(){O=new Uint8Array(N.buffer)}function G(){throw new Error("Unexpected Draco error.")}let X={a:{a:G,d:function(q,K,he){return O.copyWithin(q,K,K+he)},c:function(q){let K=O.length,he=Math.max(q>>>0,Math.ceil(1.2*K)),le=Math.ceil((he-K)/65536);try{return N.grow(le),B(),!0}catch{return!1}},b:G}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(P,X):P.then(q=>q.arrayBuffer()).then(q=>WebAssembly.instantiate(q,X))).then(q=>{let{Rb:K,Qb:he,P:le,T:ue,X:ge,Ja:ye,La:ke,Qa:be,Va:ze,Wa:et,eb:Ue,jb:Ze,f:Je,e:Le,yb:qe,zb:we,Ab:Fe,Bb:rt,Db:Ye,Gb:Et}=q.instance.exports;N=Le;let yt=(()=>{let $e=0,Ke=0,xt=0,pt=0;return at=>{xt&&(K(pt),K($e),Ke+=xt,xt=$e=0),$e||(Ke+=128,$e=he(Ke));let mt=at.length+7&-8,Rt=$e;mt>=Ke&&(xt=mt,Rt=pt=he(mt));for(let Bt=0;Bt<at.length;Bt++)O[Rt+Bt]=at[Bt];return Rt}})();return B(),Je(),{memory:Le,_free:K,_malloc:he,Mesh:class{constructor(){this.ptr=le()}destroy(){ue(this.ptr)}},Decoder:class{constructor(){this.ptr=ye()}destroy(){Ze(this.ptr)}DecodeArrayToMesh($e,Ke,xt){let pt=yt($e),at=ke(this.ptr,pt,Ke,xt.ptr);return!!ge(at)}GetAttributeByUniqueId($e,Ke){return{ptr:be(this.ptr,$e.ptr,Ke)}}GetTrianglesUInt16Array($e,Ke,xt){ze(this.ptr,$e.ptr,Ke,xt)}GetTrianglesUInt32Array($e,Ke,xt){et(this.ptr,$e.ptr,Ke,xt)}GetAttributeDataArrayForAllPoints($e,Ke,xt,pt,at){Ue(this.ptr,$e.ptr,Ke.ptr,xt,pt,at)}},DT_INT8:qe(),DT_UINT8:we(),DT_INT16:Fe(),DT_UINT16:rt(),DT_UINT32:Ye(),DT_FLOAT32:Et()}})}(fetch(zD())),Ym.then(P=>{Zs=P,Ym=void 0}))}()),D&&I.push(function(){if(C1)return;let P=function(O){let N,B=WebAssembly.instantiateStreaming(O,{}).then(q=>{N=q.instance,N.exports.__wasm_call_ctors()}),G={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},X={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:B,supported:!0,decodeGltfBuffer(q,K,he,le,ue,ge){(function(ye,ke,be,ze,et,Ue,Ze){let Je=ye.exports.sbrk,Le=ze+3&-4,qe=Je(Le*et),we=Je(Ue.length),Fe=new Uint8Array(ye.exports.memory.buffer);Fe.set(Ue,we);let rt=ke(qe,ze,et,we,Ue.length);if(rt===0&&Ze&&Ze(qe,Le,et),be.set(Fe.subarray(qe,qe+ze*et)),Je(qe-Je(0)),rt!==0)throw new Error(`Malformed buffer data: ${rt}`)})(N,N.exports[X[ue]],q,K,he,le,N.exports[G[ge]])}}}(fetch(BD()));return P.ready.then(()=>{C1=P})}()),f)for(let P=0;P<f.length;P++)I.push(Ek(f[P],s,P,n));return(I.length?Promise.all(I):Promise.resolve()).then(()=>{if(S&&p)for(let{primitives:P}of p)for(let O of P)xk(O,s);if(D&&p&&x)for(let P of x)bk(P,s);return s})})}function M1(i){switch(i){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function R1(i){switch(i){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class P1{constructor(e,n,s,c){this.context=e,this.format=s,this.useMipmap=c&&c.useMipmap,this.texture=e.gl.createTexture(),this.update(n,{premultiply:c&&c.premultiply})}update(e,n){let s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,c=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:f}=this,{gl:p}=f,{x:y,y:x}=n&&n.position?n.position:{x:0,y:0},w=y+s,I=x+c;!this.size||this.size[0]===w&&this.size[1]===I||(p.bindTexture(p.TEXTURE_2D,null),p.deleteTexture(this.texture),this.texture=p.createTexture(),this.size=null),p.bindTexture(p.TEXTURE_2D,this.texture),f.pixelStoreUnpackFlipY.set(!1),f.pixelStoreUnpack.set(1),f.pixelStoreUnpackPremultiplyAlpha.set(this.format===p.RGBA8&&(!n||n.premultiply!==!1));let S=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&w>0&&I>0){let D=this.useMipmap?Math.floor(Math.log2(Math.max(w,I)))+1:1;p.texStorage2D(p.TEXTURE_2D,D,this.format,w,I),this.size=[w,I]}if(this.size)if(S)p.texSubImage2D(p.TEXTURE_2D,0,y,x,M1(this.format),R1(this.format),e);else{let D=e.data;D&&p.texSubImage2D(p.TEXTURE_2D,0,y,x,s,c,M1(this.format),R1(this.format),D)}this.useMipmap&&p.generateMipmap(p.TEXTURE_2D)}bind(e,n,s=!1){let{context:c}=this,{gl:f}=c;f.bindTexture(f.TEXTURE_2D,this.texture),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,e),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),n!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,n),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(e,n,s,c,f){let{context:p}=this,{gl:y}=p;y.bindTexture(y.TEXTURE_2D,this.texture),n!==this.magFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,n),this.magFilter=n),e!==this.minFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.useMipmap?e===y.NEAREST?y.NEAREST_MIPMAP_NEAREST:y.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,s),this.wrapS=s),c!==this.wrapT&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,c),this.wrapT=c),f!==this.compareMode&&(f?(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_FUNC,f)):y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.NONE),this.compareMode=f)}destroy(){let{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Jm{constructor(e,n){this.context=e,this.texture=n}bind(e,n){let{context:s}=this,{gl:c}=s;c.bindTexture(c.TEXTURE_2D,this.texture),e!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,e),this.minFilter=e),n!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,n),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,n),this.wrapS=n)}}let Tk=gn([{name:"a_pos_3f",components:3,type:"Float32"}]),Ik=gn([{name:"a_color_3f",components:3,type:"Float32"}]),Sk=gn([{name:"a_color_4f",components:4,type:"Float32"}]),Dk=gn([{name:"a_uv_2f",components:2,type:"Float32"}]),Ck=gn([{name:"a_normal_3f",components:3,type:"Float32"}]),Ak=gn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Mk=gn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function WD(i,e){let n=pv(i.projection,i.zoom,i.width,i.height),s=function(f,p,y,x,w){let I=new A(y.lng-180*Oc,y.lat),S=new A(y.lng+180*Oc,y.lat),D=f.project(I.lng,I.lat),P=f.project(S.lng,S.lat),O=-Math.atan2(P.y-D.y,P.x-D.x),N=se.fromLngLat(y);N.y=ne(N.y,-1+Oc,1-Oc);let B=N.toLngLat(),G=f.project(B.lng,B.lat),X=se.fromLngLat(B);X.x+=Oc;let q=X.toLngLat(),K=f.project(q.lng,q.lat),he=qD(K.x-G.x,K.y-G.y,O),le=se.fromLngLat(B);le.y+=Oc;let ue=le.toLngLat(),ge=f.project(ue.lng,ue.lat),ye=qD(ge.x-G.x,ge.y-G.y,O),ke=Math.abs(he.x)/Math.abs(ye.y),be=Oe([]);Rr(be,be,-O*(1-(w?0:x)));let ze=Oe([]);return Nt(ze,ze,[1,1-(1-ke)*x,1]),ze[4]=-ye.x/ye.y*x,Rr(ze,ze,O),Vt(ze,be,ze),ze}(i.projection,0,i.center,n,e),c=ZD(i);return Nt(s,s,[c,c,1]),s}function ZD(i){let e=i.projection,n=pv(i.projection,i.zoom,i.width,i.height),s=O1(e,i.center),c=O1(e,A.convert(e.center));return Math.pow(2,s*n+(1-n)*c)}function pv(i,e,n,s,c=1/0){let f=i.range;if(!f)return 0;let p=Math.min(c,Math.max(n,s)),y=Math.log(p/1024)/Math.LN2;return _e(f[0]+y,f[1]+y,e)}let Oc=1/4e4;function O1(i,e){let n=ne(e.lat,-re,re),s=new A(e.lng-180*Oc,n),c=new A(e.lng+180*Oc,n),f=i.project(s.lng,n),p=i.project(c.lng,n),y=se.fromLngLat(s),x=se.fromLngLat(c),w=p.x-f.x,I=p.y-f.y,S=x.x-y.x,D=x.y-y.y,P=Math.sqrt((S*S+D*D)/(w*w+I*I));return Math.log(P)/Math.LN2}function qD(i,e,n){let s=Math.cos(n),c=Math.sin(n);return{x:i*s-e*c,y:i*c+e*s}}function XD(i,e,n){Oe(i),Rr(i,i,Sn(e[2])),li(i,i,Sn(e[0])),ci(i,i,Sn(e[1])),Nt(i,i,n),Vt(i,i,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function mv(i,e,n,s,c,f,p,y){let x=[n[0]-e[0],n[1]-e[1],0],w=[s[0]-e[0],s[1]-e[1],0];if(Ei(x)<1e-12||Ei(w)<1e-12)return ks(i);let I=qr([],x,w);cr(I,I),uo(w,s,e),x[2]=(f-c)*y,w[2]=(p-c)*y;let S=x;return qr(S,x,w),cr(S,S),Gl(i,I,S)}function L1(i,e,n=!1){let s=Mc(e.zoom),c=function(f,p,y){let x=p.worldSize,w=[f[12],f[13],f[14]],I=Y(w[1]/x),S=Z(w[0]/x),D=Oe([]),P=j(1,I)*x,O=j(1,0)*x*de(I,p.zoom),N=1/l1(x),B=O*N;if(y){let K=pv(p.projection,p.zoom,p.width,p.height,1024);B=N*p.projection.pixelSpaceConversion(p.center.lat,x,K)}let G=E(I,S);mr(G,G,hr([],cr([],G),P*B*w[2]));let X=function(K){let he=[K[0],K[1],K[2]],le=[0,1,0],ue=qr([],le,he);return qr(le,he,ue),qd(le)===0&&(le=[0,1,0],qr(ue,he,le)),cr(ue,ue),cr(le,le),cr(he,he),[ue[0],ue[1],ue[2],0,le[0],le[1],le[2],0,he[0],he[1],he[2],0,K[0],K[1],K[2],1]}(G);Nt(D,D,[B,B,B*P]),Ut(D,D,[-w[0],-w[1],-w[2]]);let q=Vt([],p.globeMatrix,X);return Vt(q,q,D),Vt(q,q,f),q}(i,e,n);if(s>0){let f=function(p,y){let x=y.worldSize,w=j(1,0)*x*de(y.center.lat,y.zoom)/l1(x),I=j(1,y.center.lat)*x,S=Oe([]);return ci(S,S,Sn(y.center.lng)),li(S,S,Sn(y.center.lat)),Ut(S,S,[0,0,Fi]),Nt(S,S,[w,w,w*I]),Ut(S,S,[y.point.x-.5*x,y.point.y-.5*x,0]),Vt(S,S,p),Vt(S,y.globeMatrix,S)}(i,e);return function(p,y,x){let w=(O,N,B)=>{let G=Ei(O),X=Ei(N),q=bl(O,N,B);return hr(q,q,1/Ei(q)*At(G,X,B))},I=w([p[0],p[1],p[2]],[y[0],y[1],y[2]],x),S=w([p[4],p[5],p[6]],[y[4],y[5],y[6]],x),D=w([p[8],p[9],p[10]],[y[8],y[9],y[10]],x),P=bl([p[12],p[13],p[14]],[y[12],y[13],y[14]],x);return[I[0],I[1],I[2],0,S[0],S[1],S[2],0,D[0],D[1],D[2],0,P[0],P[1],P[2],1]}(c,f,s)}return c}function YD(i,e,n,s){let c=sn.projectAabbCorners(s,n),f=Number.MAX_VALUE,p=-1;for(let w=0;w<c.length;++w){let I=c[w];I[0]=(.5*I[0]+.5)*e.width,I[1]=(.5-.5*I[1])*e.height,I[2]<f&&(p=w,f=I[2])}let y=w=>new Xe(c[w][0],c[w][1]),x;switch(p){case 0:case 6:x=[y(1),y(5),y(4),y(7),y(3),y(2),y(1)];break;case 1:case 7:x=[y(0),y(4),y(5),y(6),y(2),y(3),y(0)];break;case 3:case 5:x=[y(1),y(0),y(4),y(7),y(6),y(2),y(1)];break;default:x=[y(1),y(5),y(6),y(7),y(3),y(0),y(1)]}if(Wn(i,x))return f}let ad=64,rf={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function KD(i,e,n,s,c,f,p,y,x,w=!1){let I=n.zoom,S=n.project(s),D=de(s.lat,I),P=1/D;Oe(i),Ut(i,i,[S.x+p[0]*P,S.y+p[1]*P,p[2]]);let O=1,N=1,B=n.worldSize;if(w){if(n.projection.name==="mercator"){let K=0;n.elevation&&(K=n.elevation.getAtPointOrZero(new se(S.x/B,S.y/B),0));let he=ho([],[S.x,S.y,K,1],n.projMatrix)[3]/n.cameraToCenterDistance;O=he,N=he*de(n.center.lat,I)}else if(n.projection.name==="globe"){let K=L1(i,n),he=[0,0,0,1];ho(he,he,Vt([],n.projMatrix,K));let le=he[3]/n.cameraToCenterDistance,ue=Mc(I),ge=n.projection.pixelsPerMeter(s.lat,B)*de(s.lat,I),ye=n.projection.pixelsPerMeter(n.center.lat,B)*de(n.center.lat,I);O=le/At(ge,ce(n.center.lat),ue),N=le*D/ge,O*=ye,N*=ye}}else O=P;Nt(i,i,[O,O,N]);let G=[...i],X=e.orientation,q=[];if(XD(q,[X[0]+c[0],X[1]+c[1],X[2]+c[2]],f),Vt(i,G,q),y&&n.elevation){let K=0,he=[];if(x&&n.elevation){K=function(ue,ge,ye,ke,be){let ze=ge.elevation;if(!ze)return 0;let et=sn.projectAabbCorners(ye,ke),Ue=j(1,be.lat)*ge.worldSize,Ze=function(Ke,xt){let pt=[0,0,1],at=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let mt of at){let Rt=Ke[mt.corners[0]],Bt=Ke[mt.corners[1]],qt=Ke[mt.corners[2]],Gt=[Bt[0]-Rt[0],Bt[1]-Rt[1],xt*(Bt[2]-Rt[2])],pn=qr(Gt,Gt,[qt[0]-Rt[0],qt[1]-Rt[1],xt*(qt[2]-Rt[2])]);cr(pn,pn),mt.dotProductWithUp=kr(pn,pt)}return at.sort((mt,Rt)=>mt.dotProductWithUp-Rt.dotProductWithUp),at[0].corners}(et,Ue),Je=et[Ze[0]],Le=et[Ze[1]],qe=et[Ze[2]],we=et[Ze[3]],Fe=ze.getAtPointOrZero(new se(Je[0]/ge.worldSize,Je[1]/ge.worldSize),0),rt=ze.getAtPointOrZero(new se(Le[0]/ge.worldSize,Le[1]/ge.worldSize),0),Ye=ze.getAtPointOrZero(new se(qe[0]/ge.worldSize,qe[1]/ge.worldSize),0),Et=ze.getAtPointOrZero(new se(we[0]/ge.worldSize,we[1]/ge.worldSize),0),yt=(Fe+Et)/2,$e=(rt+Ye)/2;return yt>$e?rt<Ye?mv(ue,Le,we,Je,rt,Et,Fe,Ue):mv(ue,qe,Je,we,Ye,Fe,Et,Ue):Fe<Et?mv(ue,Je,Le,qe,Fe,rt,Ye,Ue):mv(ue,we,qe,Le,Et,Ye,rt,Ue),Math.max(yt,$e)}(he,n,e.aabb,i,s);let le=Vt([],ws([],he),q);Vt(i,G,le)}else K=n.elevation.getAtPointOrZero(new se(S.x/B,S.y/B),0);K!==0&&(i[14]+=K)}}function Qm(i,e,n=!1){i.uploaded||(i.gfxTexture=new P1(e,i.image,n?e.gl.R8:e.gl.RGBA8,{useMipmap:i.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),i.uploaded=!0,i.image=null)}function Rk(i,e,n){i.indexBuffer=e.createIndexBuffer(i.indexArray,!1,!0),i.vertexBuffer=e.createVertexBuffer(i.vertexArray,Tk.members,!1,!0),i.normalArray&&(i.normalBuffer=e.createVertexBuffer(i.normalArray,Ck.members,!1,!0)),i.texcoordArray&&(i.texcoordBuffer=e.createVertexBuffer(i.texcoordArray,Dk.members,!1,!0)),i.colorArray&&(i.colorBuffer=e.createVertexBuffer(i.colorArray,(i.colorArray.bytesPerElement===12?Ik:Sk).members,!1,!0)),i.featureArray&&(i.pbrBuffer=e.createVertexBuffer(i.featureArray,Mk.members,!0)),i.segments=_r.simpleSegment(0,0,i.vertexArray.length,i.indexArray.length);let s=i.material;s.pbrMetallicRoughness.baseColorTexture&&Qm(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&Qm(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&Qm(s.normalTexture,e),s.occlusionTexture&&Qm(s.occlusionTexture,e,n),s.emissionTexture&&Qm(s.emissionTexture,e)}function F1(i,e,n){if(i.meshes)for(let s of i.meshes)Rk(s,e,n);if(i.children)for(let s of i.children)F1(s,e,n)}function gv(i){if(i.meshes)for(let e of i.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(i.children)for(let e of i.children)gv(e)}function k1(i){if(i.meshes)for(let n of i.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((e=n.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(i.children)for(let n of i.children)k1(n)}function ld(i,e){let n=i.json.bufferViews[e.bufferView],s=hv[e.componentType];return new s(i.buffers[n.buffer],(e.byteOffset||0)+(n.byteOffset||0),e.count*(n.byteStride&&n.byteStride!==Km[e.type]*s.BYTES_PER_ELEMENT?n.byteStride/s.BYTES_PER_ELEMENT:Km[e.type]))}function N1(i,e,n,s){let c=hv[e.componentType],f=function(I){switch(I){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(c),p=i.json.bufferViews[e.bufferView],y=p.byteStride?p.byteStride/c.BYTES_PER_ELEMENT:Km[e.type],x=n.float32,w=x.length/n.capacity;for(let I=0,S=0;I<e.count*y;I+=y,S+=w)for(let D=0;D<w;D++)x[S+D]=s[I+D]*f;n._trim()}function Pk(i,e,n){let s=i.indices,c=i.attributes,f={};f.indexArray=new dr;let p=e.json.accessors[s],y=p.count/3;f.indexArray.reserve(y);let x=ld(e,p);for(let D=0;D<y;D++)f.indexArray.emplaceBack(x[3*D],x[3*D+1],x[3*D+2]);f.indexArray._trim(),f.vertexArray=new Ro;let w=e.json.accessors[c.POSITION];f.vertexArray.reserve(w.count);let I=ld(e,w);for(let D=0;D<w.count;D++)f.vertexArray.emplaceBack(I[3*D],I[3*D+1],I[3*D+2]);if(f.vertexArray._trim(),f.aabb=new sn(w.min,w.max),f.centroid=function(D,P){let O=[0,0,0],N=D.length;if(N>0){for(let B=0;B<N;B++){let G=3*D[B];O[0]+=P[G],O[1]+=P[G+1],O[2]+=P[G+2]}O[0]/=N,O[1]/=N,O[2]/=N}return O}(x,I),c.COLOR_0!==void 0){let D=e.json.accessors[c.COLOR_0],P=Km[D.type],O=ld(e,D);f.colorArray=P===3?new Ro:new Oa,f.colorArray.resize(D.count),N1(e,D,f.colorArray,O)}if(c.NORMAL!==void 0){f.normalArray=new Ro;let D=e.json.accessors[c.NORMAL];f.normalArray.resize(D.count);let P=ld(e,D);N1(e,D,f.normalArray,P)}if(c.TEXCOORD_0!==void 0&&n.length>0){f.texcoordArray=new La;let D=e.json.accessors[c.TEXCOORD_0];f.texcoordArray.resize(D.count);let P=ld(e,D);N1(e,D,f.texcoordArray,P)}if(c._FEATURE_ID_RGBA4444!==void 0){let D=e.json.accessors[c._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(f.featureData=ld(e,D))}c._FEATURE_RGBA4444!==void 0&&(f.featureData=new Uint32Array(ld(e,e.json.accessors[c._FEATURE_RGBA4444]).buffer));let S=i.material;return f.material=function(D,P){let{emissiveFactor:O=[0,0,0],alphaMode:N="OPAQUE",alphaCutoff:B=.5,normalTexture:G,occlusionTexture:X,emissiveTexture:q,doubleSided:K}=D,{baseColorFactor:he=[1,1,1,1],metallicFactor:le=1,roughnessFactor:ue=1,baseColorTexture:ge,metallicRoughnessTexture:ye}=D.pbrMetallicRoughness||{},ke=X?P[X.index]:void 0;if(X&&X.extensions&&X.extensions.KHR_texture_transform&&ke){let be=X.extensions.KHR_texture_transform;ke.offsetScale=[be.offset[0],be.offset[1],be.scale[0],be.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Ln(...he),metallicFactor:le,roughnessFactor:ue,baseColorTexture:ge?P[ge.index]:void 0,metallicRoughnessTexture:ye?P[ye.index]:void 0},doubleSided:K,emissiveFactor:new Ln(...O),alphaMode:N,alphaCutoff:B,normalTexture:G?P[G.index]:void 0,occlusionTexture:ke,emissionTexture:q?P[q.index]:void 0,defined:D.defined===void 0}}(S!==void 0?e.json.materials[S]:{defined:!1},n),f}function JD(i,e,n){let{matrix:s,rotation:c,translation:f,scale:p,mesh:y,extras:x,children:w}=i,I={};if(I.matrix=s||function(S,D,P,O){var N=D[0],B=D[1],G=D[2],X=D[3],q=N+N,K=B+B,he=G+G,le=N*q,ue=N*K,ge=N*he,ye=B*K,ke=B*he,be=G*he,ze=X*q,et=X*K,Ue=X*he,Ze=O[0],Je=O[1],Le=O[2];return S[0]=(1-(ye+be))*Ze,S[1]=(ue+Ue)*Ze,S[2]=(ge-et)*Ze,S[3]=0,S[4]=(ue-Ue)*Je,S[5]=(1-(le+be))*Je,S[6]=(ke+ze)*Je,S[7]=0,S[8]=(ge+et)*Le,S[9]=(ke-ze)*Le,S[10]=(1-(le+ye))*Le,S[11]=0,S[12]=P[0],S[13]=P[1],S[14]=P[2],S[15]=1,S}([],c||[0,0,0,1],f||[0,0,0],p||[1,1,1]),y!==void 0){I.meshes=n[y];let S=I.anchor=[0,0];for(let D of I.meshes){let{min:P,max:O}=D.aabb;S[0]+=P[0]+O[0],S[1]+=P[1]+O[1]}S[0]=Math.floor(S[0]/I.meshes.length/2),S[1]=Math.floor(S[1]/I.meshes.length/2)}if(x&&(x.id&&(I.id=x.id),x.lights&&(I.lights=function(S){if(!S.length)return[];let D=function(G){let X=atob(G),q=new Uint8Array(X.length);for(let K=0;K<X.length;K++)q[K]=X.codePointAt(K);return q}(S),P=[],O=D.length/24,N=new Uint16Array(D.buffer),B=new Float32Array(D.buffer);for(let G=0;G<O;G++){let X=N[2*G*6]/30,q=N[2*G*6+1]/30,K=N[2*G*6+10]/100,he=B[6*G+1],le=B[6*G+2],ue=B[6*G+3],ge=B[6*G+4],ye=ue-he,ke=ge-le,be=Math.hypot(ye,ke);P.push({pos:[he+.5*ye,le+.5*ke,q],normal:[ke/be,-ye/be,0],width:be,height:X,depth:K,points:[he,le,ue,ge]})}return P}(x.lights))),w){let S=[];for(let D of w)S.push(JD(e.json.nodes[D],e,n));I.children=S}return I}function Ok(i){if(i.vertices.length===0||i.indices.length===0)return null;let e=new rv(i.vertices,i.indices,8,256),[n,s]=[e.min.clone(),e.max.clone()];return{vertices:i.vertices,indices:i.indices,grid:e,min:n,max:s}}function Lk(i){if(!i.extras||!i.extras.ground)return null;let e=i.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;let n=e[0];if(!n||!Array.isArray(n)||n.length===0)return null;let s=[];for(let p of n){if(!Array.isArray(p)||p.length!==2)continue;let y=p[0],x=p[1];typeof y=="number"&&typeof x=="number"&&s.push(new Xe(y,x))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let c=0;for(let p=0;p<s.length;p++){let y=s[p],x=s[(p+1)%s.length],w=s[(p+2)%s.length];c+=(y.x-x.x)*(w.y-x.y)-(w.x-x.x)*(y.y-x.y)}c>0&&s.reverse();let f=Kh(s.flatMap(p=>[p.x,p.y]),[]);return f.length===0?null:{vertices:s,indices:f}}function Fk(i,e){let n=[],s=[],c=0,f=[];for(let p of i){c=n.length;let y=p.vertexArray.float32,x=p.indexArray.uint16;for(let w=0;w<p.vertexArray.length;w++)f[0]=y[3*w+0],f[1]=y[3*w+1],f[2]=y[3*w+2],Nr(f,f,e),n.push(new Xe(f[0],f[1]));for(let w=0;w<3*p.indexArray.length;w++)s.push(x[w]+c)}if(s.length%3!=0)return null;for(let p=0;p<s.length;p+=3){let y=n[s[p+0]],x=n[s[p+1]],w=n[s[p+2]];(y.x-x.x)*(w.y-x.y)-(w.x-x.x)*(y.y-x.y)>0&&([s[p+1],s[p+2]]=[s[p+2],s[p+1]])}return{vertices:n,indices:s}}function QD(i){let e=function(x,w){let I=[],S=WebGL2RenderingContext;if(x.json.textures)for(let D of x.json.textures){let P={magFilter:S.LINEAR,minFilter:S.NEAREST,wrapS:S.REPEAT,wrapT:S.REPEAT};D.sampler!==void 0&&Object.assign(P,x.json.samplers[D.sampler]),I.push({image:w[D.source],sampler:P,uploaded:!1})}return I}(i,i.images),n=function(x,w){let I=[];for(let S of x.json.meshes){let D=[];for(let P of S.primitives)D.push(Pk(P,x,w));I.push(D)}return I}(i,e),{scenes:s,scene:c,nodes:f}=i.json,p=s?s[c||0].nodes:f,y=[];for(let x of p)y.push(JD(f[x],i,n));return function(x,w,I){let S={},D=new Set;for(let P=0;P<x.length;P++){let O=I[w[P]];if(!O.extras)continue;let N=O.extras["mapbox:footprint:version"],B=O.extras["mapbox:footprint:id"];(N||B)&&D.add(P),N==="1.0.0"&&B&&(S[B]=P)}for(let P=0;P<x.length;P++){if(D.has(P))continue;let O=x[P],N=I[w[P]];if(!N.extras)continue;let B=null;O.id in S&&(B=Fk(x[S[O.id]].meshes,O.matrix)),B||(B=Lk(N)),B&&(O.footprint=Ok(B))}if(D.size>0){let P=Array.from(D.values()).sort((O,N)=>O-N);for(let O=P.length-1;O>=0;O--)x.splice(P[O],1)}}(y,p,i.json.nodes),y}function kk(i){i.heightmap=new Float32Array(4096),i.heightmap.fill(-1);let e=i.vertexArray.float32,n=i.aabb.min[0]-1,s=i.aabb.min[1]-1,c=ad/(i.aabb.max[0]-n+2),f=ad/(i.aabb.max[1]-s+2);for(let p=0;p<e.length;p+=3){let y=e[p+2],x=(e[p+0]-n)*c|0,w=(e[p+1]-s)*f|0;y>i.heightmap[w*ad+x]&&(i.heightmap[w*ad+x]=y)}}function eC(i,e,n,s,c){n.reserve(n.length+4*i.length),s.reserve(s.length+10*i.length),c.reserve(c.length+10*i.length);let f=s.length;for(let p of i){let y=Math.min(10,Math.max(4,1.3*p.height))*e,x=[-p.normal[1],p.normal[0],0],w=Math.min(.29,.1*p.width/p.depth),I=p.width-2*p.depth*e*(w+.01),S=zi([],p.pos,x,I/2),D=zi([],p.pos,x,-I/2),P=[S[0],S[1],S[2]+p.height],O=[D[0],D[1],D[2]+p.height],N=zi([],p.normal,x,w);hr(N,N,y);let B=zi([],p.normal,x,-w);hr(B,B,y),mr(N,S,N),mr(B,D,B),S[2]+=.1,D[2]+=.1,s.emplaceBack(N[0],N[1],N[2]),s.emplaceBack(B[0],B[1],B[2]),s.emplaceBack(S[0],S[1],S[2]),s.emplaceBack(D[0],D[1],D[2]),s.emplaceBack(P[0],P[1],P[2]),s.emplaceBack(O[0],O[1],O[2]),s.emplaceBack(S[0],S[1],S[2]),s.emplaceBack(D[0],D[1],D[2]),s.emplaceBack(N[0],N[1],N[2]),s.emplaceBack(B[0],B[1],B[2]);let G=I/y/2;c.emplaceBack(-G-w,-1,G,.8),c.emplaceBack(G+w,-1,G,.8),c.emplaceBack(-G,0,G,1.3),c.emplaceBack(G,0,G,1.3),c.emplaceBack(G+w,-.8,G,.7),c.emplaceBack(G+w,-.8,G,.7),c.emplaceBack(0,0,G,1.3),c.emplaceBack(0,0,G,1.3),c.emplaceBack(G+w,-1.2,G,.8),c.emplaceBack(G+w,-1.2,G,.8),n.emplaceBack(6+f,4+f,8+f),n.emplaceBack(7+f,9+f,5+f),n.emplaceBack(0+f,1+f,2+f),n.emplaceBack(1+f,3+f,2+f),f+=10}}function Nk(i,e){let n={};n.indexArray=new dr,n.vertexArray=new Ro,n.colorArray=new Oa,eC(i,e,n.indexArray,n.vertexArray,n.colorArray);let s={defined:!0};s.emissiveFactor=Ln.black;let c={};return c.baseColorFactor=Ln.white,s.pbrMetallicRoughness=c,n.material=s,n.aabb=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}let tC=gn([{name:"a_pos_3f",components:3,type:"Float32"}]),zk=gn([{name:"a_normal_3",components:3,type:"Int16"}]),nC=gn([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),Bk=gn([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),rC=Se.types,z1=32767;function Vk(i,e){let n=st+e;for(let s of i)for(let c of s)if(c.x<-e||c.x>n||c.y<-e||c.y>n)return!1;return!0}class iC{constructor(e){this.layoutAOArray=[],this.indexArrayForConflationUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.layoutVertexArray=new Ro,this.layoutNormalArray=new yc,this.layoutColorArray=new Ds,this.indexArray=new dr,this.indexArrayForConflation=new dr,this.entranceBloom={layoutVertexArray:new Ro,layoutVertexBuffer:null,layoutAttenuationArray:new Oa,layoutAttenuationBuffer:null,layoutColorArray:new Ds,layoutColorBuffer:null,indexArray:new dr,indexArrayForConflation:new dr,indexBuffer:null,segmentsBucket:new _r},this.programConfigurations=new Oo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segmentsBucket=new _r,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.groundEffect=new E1(e)}get segments(){return this.segmentsBucket}get bloomGeometry(){return this.entranceBloom}updateFootprints(e,n){for(let s of this.footprints)n.push({footprint:s,id:e})}prepare(){return function(){if(dv!=null||ND!=null)return null;if(nf!=null)return nf;let e=fetch(vi.BUILDING_GEN_URL);return nf=function(n){let s,c,f,p;function y(){s=new Uint8Array(p.buffer),c=new Int32Array(p.buffer),f=new Float32Array(p.buffer)}function x(){throw new Error("Unexpected BuildingGen error.")}let w=()=>{},I={a:{a:x,f:function(S){let D=s.length,P=Math.max(S>>>0,Math.ceil(1.2*D)),O=Math.ceil((P-D)/65536);try{return p.grow(O),y(),!0}catch{return!1}},g:x,b:w,c:w,d:w,e:w}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(n,I):n.then(S=>S.arrayBuffer()).then(S=>WebAssembly.instantiate(S,I))).then(S=>{let D=S.instance.exports;return(0,D.g)(),p=D.f,y(),new _k({setStyle:D.h,setAOOptions:D.i,setMetricOptions:D.j,setStructuralOptions:D.k,setFacadeOptions:D.l,setFauxFacadeOptions:D.m,setFacadeClassifierOptions:D.n,addFeature:D.o,addFacade:D.p,generateMesh:D.q,getLastError:D.r,getMeshCount:D.s,getPositionsPtr:D.t,getPositionsLength:D.u,getNormalsPtr:D.v,getNormalsLength:D.w,getColorsPtr:D.x,getColorsLength:D.y,getAOPtr:D.z,getAOLength:D.A,getUVPtr:D.B,getUVLength:D.C,getFauxFacadePtr:D.D,getFauxFacadeLength:D.E,getIndicesPtr:D.F,getIndicesLength:D.G,getBuildingPart:D.H,getRingCount:D.I,getRingPtr:D.J,getRingLength:D.K,free:D.L,malloc:D.M,heapU8:s,heap32:c,heapF32:f})})}(e).then(n=>(nf=null,dv=n,dv)).catch(n=>{fn("Could not load building-gen"),nf=null,ND=n}),nf}()}populate(e,n,s,c){let f=yk();if(!f)return;let p=oe(s);this.tileToMeter=p,this.brightness=n.brightness,f.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,p],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:p,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),f.setAOOptions(!1,.3),f.setMetricOptions(!1,16),f.setStructuralOptions(!0),f.setFacadeOptions(4,!0),f.setFauxFacadeOptions(!1,!1,1),f.setFacadeClassifierOptions(3);let y=new Map;for(let{feature:x}of e){if(rC[x.type]!=="LineString")continue;let w=this.layers[0]._featureFilter.needGeometry,I=Pe(x,w);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom),I,s))continue;let S=w?I.geometry:pe(x,s,c),D=[];for(let B of S)for(let G of B)D.push({x:G.x,y:G.y});let P={coordinates:D,crossPerc:x.properties.cross_perc,distanceToRoad:x.properties.distance_to_road,entrances:x.properties.entrances,sourceId:0},O=x.properties.source_id,N=y.get(O);N||(N=[],y.set(O,N)),N.push(P)}this.maxHeight=0;for(let{feature:x,index:w}of e){if(rC[x.type]==="LineString")continue;let I=this.layers[0]._featureFilter.needGeometry,S=Pe(x,I);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom),S,s))continue;let D=I?S.geometry:pe(x,s,c),P=jm(D,500);if(!Vk(D,163))continue;let O=this.layers[0],N=O.layout.get("building-base").evaluate(x,{},s),B=O.layout.get("building-height").evaluate(x,{},s),G=O.layout.get("building-roof-shape").evaluate(x,{},s),X=O.paint.get("building-ambient-occlusion-intensity"),q=O.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if(G==="flat")continue;let K=x.properties.source_id,he;he=y.has(K)?y.get(K):[];let le=[],ue=new Xe(1/0,1/0),ge=new Xe(-1/0,-1/0);for(let $e of P)if($e.length>0){let Ke=[];for(let xt of $e){let pt=[];for(let at=xt.length-1;at>=0;at--){let mt=xt[at];pt.push({x:mt.x,y:mt.y}),ue.x=Math.min(ue.x,mt.x),ue.y=Math.min(ue.y,mt.y),ge.x=Math.max(ge.x,mt.x),ge.y=Math.max(ge.y,mt.y)}Ke.push(pt)}le.push({id:x.id,height:B,minHeight:N,sourceId:0,roofType:G,coordinates:Ke})}let ye=f.generateMesh(le,he);if(typeof ye=="string"||ye.meshes.length===0||ye.modifiedPolygonRings.length===0)continue;let ke=0;for(let $e of ye.meshes)ke+=$e.positions.length/3;let be=this.segmentsBucket.prepareSegment(ke,this.layoutVertexArray,this.indexArray),ze=[],et=null,Ue=0,Ze=-1,Je=this.indexArray.length,Le=0;for(let $e of ye.meshes){let Ke=this.layoutVertexArray.length;if($e.buildingPart==="entrance"){let pt=new Array;for(let Bt=0;Bt<$e.indices.length;Bt+=12){let qt=$e.positions[Bt+0],Gt=$e.positions[Bt+1],pn=$e.positions[Bt+3],nn=$e.positions[Bt+4],nr=$e.positions[Bt+2],Q=$e.positions[Bt+8]-nr,ee=1,Re=pn-qt,it=nn-Gt,ct=Math.hypot(Re,it);pt.push({pos:[qt+.5*Re,Gt+.5*it,nr],normal:[it/ct,-Re/ct,0],width:ct,height:Q,depth:ee,points:[qt,Gt,pn,nn]})}let at=this.entranceBloom.segmentsBucket.prepareSegment(10*pt.length,this.entranceBloom.layoutVertexArray,this.entranceBloom.indexArray),mt=this.entranceBloom.layoutVertexArray.length;Ue=this.entranceBloom.indexArray.length,eC(pt,.5/this.tileToMeter,this.entranceBloom.indexArray,this.entranceBloom.layoutVertexArray,this.entranceBloom.layoutAttenuationArray);let Rt=this.entranceBloom.layoutVertexArray.length-mt;Ze=this.entranceBloom.indexArray.length-Ue;for(let Bt=0;Bt<Rt;Bt++)this.entranceBloom.layoutColorArray.emplaceBack(65535,65535);at.vertexLength+=Rt,at.primitiveLength+=Ze,et={part:$e.buildingPart,vertexOffset:mt,vertexLength:Rt}}for(let pt=0;pt<$e.positions.length;pt+=3)Le=Math.max(Le,$e.positions[pt+2]),this.layoutVertexArray.emplaceBack($e.positions[pt],$e.positions[pt+1],$e.positions[pt+2]);for(let pt=0;pt<$e.normals.length;pt+=3)this.layoutNormalArray.emplaceBack($e.normals[pt+0]*z1,$e.normals[pt+1]*z1,$e.normals[pt+2]*z1);for(let pt=0;pt<$e.ao.length;pt++)this.layoutAOArray.push($e.ao[pt]);for(let pt=0;pt<$e.colors.length;pt+=3){let at=1+($e.ao[pt/3]-1)*X;this.layoutColorArray.emplaceBack($e.colors[pt]*at<<8|$e.colors[pt+1]*at,$e.colors[pt+2]*at<<8)}let xt=be.vertexLength;for(let pt=0;pt<$e.indices.length;pt+=3)this.indexArray.emplaceBack(xt+$e.indices[pt],xt+$e.indices[pt+1],xt+$e.indices[pt+2]);be.vertexLength+=$e.positions.length/3,be.primitiveLength+=$e.indices.length/3,($e.buildingPart==="roof"||$e.buildingPart==="wall"||$e.buildingPart==="facade_glazing"||$e.buildingPart==="entrance")&&ze.push({part:$e.buildingPart,vertexOffset:Ke,vertexLength:$e.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Le),this.buildingFeatures.push({feature:S,segment:be,parts:ze,buildingBloom:et});let qe=this.indexArray.length-Je,we=[],Fe=[],rt=new Xe(1/0,1/0),Ye=new Xe(-1/0,-1/0),Et=this.groundEffect.vertexArray.length;for(let $e of ye.modifiedPolygonRings){let Ke=[],xt=new Xe(1/0,1/0),pt=new Xe(-1/0,-1/0);for(let at=0;at<$e.length;at+=2){let mt=$e.length-at-2;xt.x=Math.min(xt.x,$e[mt]),xt.y=Math.min(xt.y,$e[mt+1]),pt.x=Math.max(pt.x,$e[mt]),pt.y=Math.max(pt.y,$e[mt+1]);let Rt=new Xe($e[mt],$e[mt+1]);Ke.push(Rt),we.push(Rt.x,Rt.y),Fe.push(Rt.clone())}rt.x=Math.min(rt.x,xt.x),rt.y=Math.min(rt.y,xt.y),Ye.x=Math.max(Ye.x,pt.x),Ye.y=Math.max(Ye.y,pt.y),this.groundEffect.addData(Ke,[xt,pt],q)}let yt=this.groundEffect.vertexArray.length-Et;(ue.x<0||ge.x>st||ue.y<0||ge.y>st)&&this.featuresOnBorder.push({featureId:x.id,footprintIndex:this.footprints.length});{let $e=Kh(we,null,2),Ke=new rv(Fe,$e,8,256),xt=x.id;x.properties&&x.properties.hasOwnProperty("building_id")&&(xt=x.properties.building_id),this.footprints.push({vertices:Fe,indices:$e,grid:Ke,min:rt,max:Ye,buildingId:xt,hiddenFlags:0,indicesOffset:Je,indicesLength:qe,bloomIndicesOffset:Ue,bloomIndicesLength:Ze,groundEffectVertexOffset:Et,groundEffectVertexLength:yt,segment:be,height:Le})}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,x,w,{},n.availableImages,s,n.brightness),this.groundEffect.addPaintPropertiesData(x,w,{},n.availableImages,s,n.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0])}update(e,n,s,c,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y),this.groundEffect.update(e,n,f,s,c,p,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,tC.members),this.layoutNormalBuffer=e.createVertexBuffer(this.layoutNormalArray,zk.members),this.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(this.entranceBloom.layoutVertexArray,tC.members),this.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(this.entranceBloom.layoutAttenuationArray,Bk.members),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutNormalBuffer.destroy(),this.layoutColorBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segmentsBucket.destroy(),this.entranceBloom.layoutVertexBuffer.destroy(),this.entranceBloom.layoutColorBuffer.destroy(),this.entranceBloom.layoutAttenuationBuffer.destroy(),this.entranceBloom.indexBuffer.destroy(),this.entranceBloom.segmentsBucket.destroy())}updateFootprintHiddenFlags(e,n,s=!0){let c=!1,f=s?n:0,p=0|(s?-1:~n);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let y of e){let x=this.footprints[y],w=x.hiddenFlags&p|f;x.hiddenFlags!==w&&(x.hiddenFlags=w,c=!0,this.groundEffect.updateHiddenByLandmarkRange(x.groundEffectVertexOffset,x.groundEffectVertexLength,x.hiddenFlags!==0))}return c&&(this.indexArrayForConflationUploaded=!1),c}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),!this.indexArrayForConflationUploaded&&this.indexArray.length!==0){this.indexArrayForConflation.resize(this.indexArray.length),this.indexArrayForConflation.uint16.set(this.indexArray.uint16),this.entranceBloom.indexArrayForConflation.resize(this.entranceBloom.indexArray.length),this.entranceBloom.indexArrayForConflation.uint16.set(this.entranceBloom.indexArray.uint16);for(let n of this.footprints){let s=n.indicesOffset+n.indicesLength;if(n.hiddenFlags!==0){for(let f=n.indicesOffset;f<s;f++)this.indexArrayForConflation.uint16[3*f+0]=0,this.indexArrayForConflation.uint16[3*f+1]=0,this.indexArrayForConflation.uint16[3*f+2]=0;let c=n.bloomIndicesOffset+n.bloomIndicesLength;for(let f=n.bloomIndicesOffset;f<c;f++)this.entranceBloom.indexArrayForConflation.uint16[3*f+0]=0,this.entranceBloom.indexArrayForConflation.uint16[3*f+1]=0,this.entranceBloom.indexArrayForConflation.uint16[3*f+2]=0}}this.indexBuffer?this.indexBuffer.updateData(this.indexArrayForConflation):this.indexBuffer=e.createIndexBuffer(this.indexArrayForConflation,!0),this.entranceBloom.indexBuffer?this.entranceBloom.indexBuffer.updateData(this.entranceBloom.indexArrayForConflation):this.entranceBloom.indexBuffer=e.createIndexBuffer(this.entranceBloom.indexArrayForConflation,!0),this.indexArrayForConflationUploaded=!0}}uploadUpdatedColorBuffer(e){this.layoutColorBuffer?this.layoutColorBuffer.updateData(this.layoutColorArray):this.layoutColorBuffer=e.createVertexBuffer(this.layoutColorArray,nC.members,!0),this.entranceBloom.layoutColorBuffer?this.entranceBloom.layoutColorBuffer.updateData(this.entranceBloom.layoutColorArray):this.entranceBloom.layoutColorBuffer=e.createVertexBuffer(this.entranceBloom.layoutColorArray,nC.members,!0)}evaluate(e){let n=e.paint.get("building-ambient-occlusion-intensity");for(let s of this.buildingFeatures){let c=s.feature;c.properties["building-part"]="roof";let f=e.paint.get("building-color").evaluate(c,{},this.canonical),p=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);c.properties["building-part"]="wall";let y=e.paint.get("building-color").evaluate(c,{},this.canonical),x=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);c.properties["building-part"]="window";let w=e.paint.get("building-color").evaluate(c,{},this.canonical),I=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);c.properties["building-part"]="door";let S=e.paint.get("building-color").evaluate(c,{},this.canonical),D=e.paint.get("building-emissive-strength").evaluate(c,{},this.canonical);for(let O of s.parts){let N,B=f;O.part==="roof"?(B=f,N=p):O.part==="wall"?(B=y,N=x):O.part==="facade_glazing"?(B=w,N=I):O.part==="entrance"&&(B=S,N=D),N=ne(N,0,1);for(let G=0;G<O.vertexLength;G++){let X=O.vertexOffset+G,q=1+(this.layoutAOArray[X]-1)*n;this.layoutColorArray.emplace(X,B.r*q*255<<8|B.g*q*255,B.b*q*255<<8|255*N)}}let P=s.buildingBloom;if(P)for(let O=0;O<P.vertexLength;O++)this.bloomGeometry.layoutColorArray.emplace(P.vertexOffset+O,255*S.r<<8|255*S.g,255*S.b<<8|51*D)}}needsEvaluation(e,n){let s=e.transform.projectionOptions,c=e.style.getBrightness();return!(this.uploaded&&s.name===this.projection.name&&this.brightness===c||(this.projection=s,this.brightness=c,0))}updateReplacement(e,n,s){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let c=n.getReplacementRegionsForTile(e.toUnwrapped());if(ov(this.activeReplacements,c))return;this.activeReplacements=c;for(let p of this.footprints)p.hiddenFlags&=-2;let f=[];for(let p of this.activeReplacements){if(p.order<=cD)continue;let y=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));for(let x of this.footprints)x.min.x>p.max.x||x.max.x<p.min.x||x.min.y>p.max.y||x.max.y<p.min.y||(f.length=0,Uk(x.vertices,0,x.vertices.length,p.footprintTileId.canonical,e.canonical,f),v1(p.footprint,f,x.indices,0,x.indices.length,0,-y)&&(x.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let p of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(p.groundEffectVertexOffset,p.groundEffectVertexLength,p.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(e,n){let s=Number.NEGATIVE_INFINITY,c=!0,f=4*(e+st)*st+(n+st);if(this.footprintLookup.hasOwnProperty(f)){let y=this.footprintLookup[f];return y?{height:y.height,hidden:y.hiddenFlags!==0}:void 0}let p=new Xe(e,n);for(let y of this.footprints)e>y.max.x||y.min.x>e||n>y.max.y||y.min.y>n||y.height<=s||x1(p,y)&&(s=y.height,this.footprintLookup[f]=y,c=y.hiddenFlags!==0);if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:c};this.footprintLookup[f]=void 0}}function Uk(i,e,n,s,c,f){let p=Math.pow(2,s.z-c.z);for(let y=0;y<n;y++){let x=i[y+e].x,w=i[y+e].y;x=(x+c.x*st)*p-s.x*st,w=(w+c.y*st)*p-s.y*st,f.push(new Xe(x,w))}}let oC,sC;_t(iC,"BuildingBucket",{omit:["layers"]});let jk=gn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),Hk=gn([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:Gk}=jk,$k=gn([{name:"a_packed",components:3,type:"Float32"}]),{members:Wk}=$k,Zk=gn([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:qk}=Zk;class aC{constructor(e,n){this.width=e,this.height=n,this.nextRow=0,this.image=new Rc({width:e,height:n}),this.positions={},this.uploaded=!1}getDash(e,n){let s=this.getKey(e,n);return this.positions[s]}trim(){let e=this.width,n=this.height=Dt(this.nextRow);this.image.resize({width:e,height:n})}getKey(e,n){return e.join(",")+n}getDashRanges(e,n,s){let c=[],f=e.length%2==1?-e[e.length-1]*s:0,p=e[0]*s,y=!0;c.push({left:f,right:p,isDash:y,zeroLength:e[0]===0});let x=e[0];for(let w=1;w<e.length;w++){y=!y;let I=e[w];f=x*s,x+=I,p=x*s,c.push({left:f,right:p,isDash:y,zeroLength:I===0})}return c}addRoundDash(e,n,s){let c=n/2;for(let f=-s;f<=s;f++){let p=this.width*(this.nextRow+s+f),y=0,x=e[y];for(let w=0;w<this.width;w++){w/x.right>1&&(x=e[++y]);let I=Math.abs(w-x.left),S=Math.abs(w-x.right),D=Math.min(I,S),P,O=f/s*(c+1);if(x.isDash){let N=c-Math.abs(O);P=Math.sqrt(D*D+N*N)}else P=c-Math.sqrt(D*D+O*O);this.image.data[p+w]=Math.max(0,Math.min(255,P+128))}}}addRegularDash(e,n){for(let x=e.length-1;x>=0;--x){let w=e[x],I=e[x+1];w.zeroLength?e.splice(x,1):I&&I.isDash===w.isDash&&(I.left=w.left,e.splice(x,1))}let s=e[0],c=e[e.length-1];s.isDash===c.isDash&&(s.left=c.left-this.width,c.right=s.right+this.width);let f=this.width*this.nextRow,p=0,y=e[p];for(let x=0;x<this.width;x++){x/y.right>1&&(y=e[++p]);let w=Math.abs(x-y.left),I=Math.abs(x-y.right),S=Math.min(w,I);this.image.data[f+x]=Math.max(0,Math.min(255,(y.isDash?S:-S)+n+128))}}addDash(e,n){let s=this.getKey(e,n);if(this.positions[s])return this.positions[s];let c=n==="round",f=c?7:0,p=2*f+1;if(this.nextRow+p>this.height)return fn("LineAtlas out of space"),null;e.length===0&&e.push(1);let y=0;for(let I=0;I<e.length;I++)e[I]<0&&(fn("Negative value is found in line dasharray, replacing values with 0"),e[I]=0),y+=e[I];if(y!==0){let I=this.width/y,S=this.getDashRanges(e,this.width,I);c?this.addRoundDash(S,I,f):this.addRegularDash(S,n==="square"?.5*I:0)}let x=this.nextRow+f;this.nextRow+=p;let w={tl:[x,f],br:[y,0]};return this.positions[s]=w,w}}_t(aC,"LineAtlas");let Xk=Se.types,Yk=Math.cos(Math.PI/180*37.5),Kk=Math.cos(Math.PI/180*5);class B1{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new Uh,this.layoutVertexArray2=new Ro,this.patternVertexArray=new Ro,this.indexArray=new dr,this.programConfigurations=new Oo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new _r,this.maxLineLength=0,this.zOffsetVertexArray=new Ro,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:st/64,this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,c){this.hasPattern=f1("line",this.layers,this.pixelRatio,n);let f=this.layers[0].layout.get("line-sort-key");this.tileToMeter=oe(s);let p=this.layers[0].layout.get("line-elevation-reference");if(p==="hd-road-markup")this.elevationType="road";else{let D=this.layers[0].layout.get("line-z-offset"),P=D.isConstant()&&!D.constantOr(0);this.elevationType=p!=="sea"&&p!=="ground"&&P?"none":"offset",this.elevationType==="offset"&&p==="none"&&fn(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}let y=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&y!==void 0;let x=[];for(let{feature:D,id:P,index:O,sourceLayerIndex:N}of e){let B=this.layers[0]._featureFilter.needGeometry,G=Pe(D,B);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom,{worldview:this.worldview}),G,s))continue;let X=f?f.evaluate(G,{},s):void 0,q={id:P,properties:D.properties,type:D.type,sourceLayerIndex:N,index:O,geometry:B?G.geometry:pe(D,s,c),patterns:{},sortKey:X};x.push(q)}f&&x.sort((D,P)=>D.sortKey-P.sortKey);let{lineAtlas:w,featureIndex:I}=n,S=this.addConstantDashes(w);for(let D of x){let{geometry:P,index:O,sourceLayerIndex:N}=D;if(S&&this.addFeatureDashes(D,w),this.hasPattern){let B=p1("line",this.layers,D,this.zoom,this.pixelRatio,n);this.patternFeatures.push(B)}else this.addFeature(D,P,O,s,w.positions,n.availableImages,n.brightness,n.elevationFeatures);I.insert(e[O].feature,P,O,N,this.index)}}addConstantDashes(e){let n=!1;for(let s of this.layers){let c=s.paint.get("line-dasharray").value,f=s.layout.get("line-cap").value;if(c.kind!=="constant"||f.kind!=="constant")n=!0;else{let p=f.value,y=c.value;if(!y)continue;e.addDash(y,p)}}return n}addFeatureDashes(e,n){let s=this.zoom;for(let c of this.layers){let f=c.paint.get("line-dasharray").value,p=c.layout.get("line-cap").value;if(f.kind==="constant"&&p.kind==="constant")continue;let y,x;if(f.kind==="constant"){if(y=f.value,!y)continue}else y=f.evaluate({zoom:s},e);x=p.kind==="constant"?p.value:p.evaluate({zoom:s},e),n.addDash(y,x),e.patterns[c.id]=[n.getKey(y,x)]}}update(e,n,s,c,f,p,y,x){this.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,x)}addFeatures(e,n,s,c,f,p){for(let y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,n,s,c,p)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Wk)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,qk)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Hk.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Gk),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,n,s,c,f,p,y,x){let w=this.layers[0].layout,I=w.get("line-join").evaluate(e,{}),S=w.get("line-cap").evaluate(e,{}),D=w.get("line-miter-limit"),P=w.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=w.get("line-z-offset").value;let O=this.layers[0].paint.get("line-width").value;if(O.kind!=="constant"&&O.isLineProgressConstant===!1&&(this.variableWidthValue=O),this.elevationType==="road"){let N=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,n,c,x,I,S,D,P)){let[B,G]=this.clipRuntimeLinesToTile(n,1);for(let X=0;X<B.length;X++){let q=B[X],K=G[X],he={progress:{min:K.progress.min,max:K.progress.max},nextDir:this.computeSegNextDir(K,q),prevDir:this.computeSegPrevDir(K,q)};this.addLine(q,e,c,I,S,D,P,he)}this.fillNonElevatedRoadSegment(N)}}else for(let N of n)this.addLine(N,e,c,I,S,D,P);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,f,p,c,y,void 0,this.worldview)}computeSegNextDir(e,n){return e.nextPoint.sub(n.at(-2)).unit()}computeSegPrevDir(e,n){return n[1].sub(e.prevPoint).unit()}clipLinesToTile(e,n){return lv(e,-n,-n,st+n,st+n)}clipRuntimeLinesToTile(e,n){let s=[];return[lv(e,-n,-n,st+n,st+n,s),s]}addElevatedRoadFeature(e,n,s,c,f,p,y,x){let w=[],I=yr.getElevationFeature(e,c);if(I){let S=this.clipLinesToTile(n,1),D=this.prepareElevatedLines(S,I,s);for(let P of D)w.push({geometry:P,elevation:I,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(w.length===0)return!1;for(let S of w){let D=this.layoutVertexArray.length;this.addLine(S.geometry,e,s,f,p,y,x);let P=new vn(s,S.elevationTileID);if(S.elevation)for(let O=D;O<this.layoutVertexArray.length;O++){let N=new Xe(this.layoutVertexArray.int16[6*O]>>1,this.layoutVertexArray.int16[6*O+1]>>1),B=P.pointElevation(N,S.elevation,.05);this.updateHeightRange(B),this.zOffsetVertexArray.emplaceBack(B,0,0)}else this.fillNonElevatedRoadSegment(D)}return!0}prepareElevatedLines(e,n,s){if(n.constantHeight!=null)return e;let c=[],f=1/oe(s);for(let p of e)pk(p,new Bn(n,f),0,c);return c}fillNonElevatedRoadSegment(e){for(let n=e;n<this.layoutVertexArray.length;n++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,n,s,c,f,p,y,x){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;let w=c==="none";this.patternJoinNone=this.hasPattern&&w,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];let I=x&&x.progress.min>0,S=x&&x.progress.max<1;if(this.lineClips){let ge={min:this.lineClips.start,max:this.lineClips.end},ye=1;if(x){let ze=this.lineClips.end-this.lineClips.start;ge=function(et,Ue,Ze){return{min:mu(et.min,Ue,Ze),max:mu(et.max,Ue,Ze)}}(x.progress,{min:0,max:1},ge),ze>0&&(ye=(ge.max-ge.min)/ze)}let ke=+n.properties.mapbox_clip_feature_len,be=+n.properties.mapbox_clip_seg_len;if(Number.isNaN(ke)||Number.isNaN(be)){for(let et=0;et<e.length-1;et++)this.totalDistance+=e[et].dist(e[et+1]);let ze=this.totalDistance/(ge.max-ge.min);this.totalFeatureLength=Number.isFinite(ze)?ze:0,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=ke,this.distance=be*ye,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}let D=Xk[n.type]==="Polygon",P=e.length;for(;P>=2&&e[P-1].equals(e[P-2]);)P--;let O=0;for(;O<P-1&&e[O].equals(e[O+1]);)O++;if(P<(D?3:2))return;c==="bevel"&&(p=1.05);let N=this.segments.prepareSegment(10*P,this.layoutVertexArray,this.indexArray),B,G,X,q,K,he,le,ue;x&&x.prevDir&&(he=x.prevDir.perp()),x&&x.nextDir&&(le=x.nextDir.perp()),this.e1=this.e2=-1,D&&(B=e[P-2],K=e[O].sub(B)._unit()._perp());for(let ge=O;ge<P;ge++){if(X=ge===P-1?D?e[O+1]:void 0:e[ge+1],X&&e[ge].equals(X))continue;K&&(q=K),B&&(G=B),B=e[ge],ue=this.evaluateLineProgressFeatures(G?G.dist(B):0),K=X?X.sub(B)._unit()._perp():q,q=q||K;let ye=G&&X,ke=ye?c:D||w?"butt":f,be=q.x*K.x+q.y*K.y;if(w){let we=function(Fe){if(Fe.patternJoinNone){let rt=Fe.segmentPoints.length/2,Ye=Fe.lineSoFar-Fe.segmentStart;for(let Et=0;Et<rt;++Et){let yt=Fe.segmentPoints[2*Et+1],$e=Math.round(Fe.segmentPoints[2*Et])+.5+.25*yt;Fe.patternVertexArray.emplaceBack($e,Ye,Fe.segmentStart),Fe.patternVertexArray.emplaceBack($e,Ye,Fe.segmentStart)}Fe.segmentPoints.length=0}Fe.e1=Fe.e2=-1};if(ye&&be<Kk){this.updateDistance(G,B),this.addCurrentVertex(B,q,1,1,N,ue),we(this),this.addCurrentVertex(B,K,-1,-1,N,ue);continue}if(G){if(!X){this.updateDistance(G,B),this.addCurrentVertex(B,q,1,1,N,ue),we(this);continue}ke="miter"}}let ze=q.add(K);ze.x===0&&ze.y===0||ze._unit();let et=ze.x*K.x+ze.y*K.y,Ue=et!==0?1/et:1/0,Ze=2*Math.sqrt(2-2*et),Je=et<Yk&&G&&X,Le=q.x*K.y-q.y*K.x>0,qe=this.overscaling<=16?15*st/(512*this.overscaling):0;if(ye&&ke==="round"){if(Ue<y)ke="miter";else if(Ue<=2){let we=V1(B,-10,st+10);ke=this.elevationType==="offset"&&(we||this.hasCrossSlope)?"miter":"fakeround"}}if(ke==="miter"&&Ue>p&&(ke="bevel"),ke==="bevel"&&(Ue>2&&(ke="flipbevel"),Ue<p&&(ke="miter")),G&&!(ke==="miter"&&Je)&&this.updateDistance(G,B),ke==="miter")if(Je){let we=B.dist(G);if(we>2*qe){let rt=B.sub(B.sub(G)._mult(qe/we)._round());this.updateDistance(G,rt),this.addCurrentVertex(rt,q,0,0,N,ue),G=rt}this.updateDistance(G,B),ze._mult(Ue),this.addCurrentVertex(B,ze,0,0,N,ue);let Fe=B.dist(X);if(Fe>2*qe){let rt=B.add(X.sub(B)._mult(qe/Fe)._round());this.updateDistance(B,rt),this.addCurrentVertex(rt,K,0,0,N,ue),B=rt}}else ze._mult(Ue),this.addCurrentVertex(B,ze,0,0,N,ue);else if(ke==="flipbevel"){if(Ue>100)ze=K.mult(-1);else{let we=Ue*q.add(K).mag()/q.sub(K).mag();ze._perp()._mult(we*(Le?-1:1))}this.addCurrentVertex(B,ze,0,0,N,ue),this.addCurrentVertex(B,ze.mult(-1),0,0,N,ue)}else if(ke==="bevel"||ke==="fakeround"){ue!=null&&G&&this.addCurrentVertex(B,le||q,-1,-1,N,ue);let we=B.dist(G)<=2*qe&&ke!=="bevel",Fe=ze.mult(Le?1:-1);Fe._mult(Ue);let rt=K.mult(Le?-1:1),Ye=q.mult(Le?-1:1),Et=this.evaluateLineProgressFeatures(this.distance);if(ue==null&&(this.addHalfVertex(B,Fe.x,Fe.y,!1,!Le,0,N,Et),we||this.addHalfVertex(B,Fe.x+2*Ye.x,Fe.y+2*Ye.y,!1,Le,0,N,Et)),ke==="fakeround"){let yt=Math.round(180*Ze/Math.PI/20);this.addHalfVertex(B,Ye.x,Ye.y,!1,Le,0,N,Et);for(let $e=0;$e<yt;$e++){let Ke=$e/yt;if(Ke!==.5){let pt=Ke-.5;Ke+=Ke*pt*(Ke-1)*((1.0904+be*(be*(3.55645-1.43519*be)-3.2452))*pt*pt+(.848013+be*(.215638*be-1.06021)))}let xt=rt.sub(Ye)._mult(Ke)._add(Ye)._unit();this.addHalfVertex(B,xt.x,xt.y,!1,Le,0,N,Et)}this.addHalfVertex(B,rt.x,rt.y,!1,Le,0,N,Et)}we||ue!=null||this.addHalfVertex(B,Fe.x+2*rt.x,Fe.y+2*rt.y,!1,Le,0,N,Et),ue!=null&&X&&this.addCurrentVertex(B,he||K,1,1,N,ue)}else if(ke==="butt")this.addCurrentVertex(B,ze,0,0,N,ue);else if(ke==="square"){if(!G){let we=I?0:-1;this.addCurrentVertex(B,ze,we,we,N,ue)}if(this.addCurrentVertex(B,ze,0,0,N,ue),G){let we=S?0:1;this.addCurrentVertex(B,ze,we,we,N,ue)}}else if(ke==="round"){if(G){let we=!ye&&le?le:q;this.addCurrentVertex(B,we,0,0,N,ue),!ye&&S||this.addCurrentVertex(B,we,1,1,N,ue,!0)}if(X){let we=!ye&&he?he:K;!ye&&I||this.addCurrentVertex(B,we,-1,-1,N,ue,!0),this.addCurrentVertex(B,we,0,0,N,ue)}}}}addVerticesTo(e,n,s,c,f,p,y,x,w,I){let S=(n.w-e.w)/this.tessellationStep|0,D=0,P=this.scaledDistance;if(S>1){this.lineSoFar=e.w;let N=(n.x-e.x)/S,B=(n.y-e.y)/S,G=(n.z-e.z)/S,X=(n.w-e.w)/S;for(let q=1;q<S;++q){e.x+=N,e.y+=B,e.z+=G,this.lineSoFar+=X,D+=X;let K=this.evaluateLineProgressFeatures(this.prevDistance+D);this.scaledDistance=(this.prevDistance+D)/this.totalDistance,this.addHalfVertex(e,s,c,I,!1,y,w,K),this.addHalfVertex(e,f,p,I,!0,-x,w,K)}}this.lineSoFar=n.w,this.scaledDistance=P;let O=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(n,s,c,I,!1,y,w,O),this.addHalfVertex(n,f,p,I,!0,-x,w,O)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):fn(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let n=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(n=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:n}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:n}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:n}}addCurrentVertex(e,n,s,c,f,p,y=!1){let x=n.x+n.y*s,w=n.y-n.x*s,I=n.y*c-n.x,S=-n.y-n.x*c;if(p!=null){let D=this.elevationType==="offset",P=-10,O=st+10,N=p.zOffset,B=new MD(e.x,e.y,N,this.lineSoFar),G=!!D&&V1(e,P,O),X=this.lineSoFar,q=this.distance;if(this.currentVertex)if(G){let K=this.currentVertexIsOutside,he=this.currentVertex,le=new MD(e.x,e.y,N,this.lineSoFar);if(PD(he,le,P,O),!V1(le,P,O)){if(K){this.e1=this.e2=-1,this.distance-=he.dist(B),this.lineSoFar=he.w;let ue=this.evaluateLineProgressFeatures(he.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(he,x,w,y,!1,s,f,ue),this.addHalfVertex(he,I,S,y,!0,-c,f,ue),this.prevDistance=this.distance}this.distance=this.prevDistance+he.dist(le),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(he,le,x,w,I,S,s,c,f,y),this.distance=q,this.scaledDistance=this.distance/this.totalDistance}}else{let K=this.currentVertex;if(this.currentVertexIsOutside){PD(K,B,P,O),this.e1=this.e2=-1,this.distance-=K.dist(B),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=K.w;let he=this.evaluateLineProgressFeatures(K.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(K,x,w,y,!1,s,f,he),this.addHalfVertex(K,I,S,y,!0,-c,f,he),this.prevDistance=this.distance,this.distance=q,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(K,B,x,w,I,S,s,c,f,y)}else G||(this.addHalfVertex(e,x,w,y,!1,s,f,p),this.addHalfVertex(e,I,S,y,!0,-c,f,p));this.currentVertex=B,this.currentVertexIsOutside=G,this.lineSoFar=X}else this.addHalfVertex(e,x,w,y,!1,s,f,p),this.addHalfVertex(e,I,S,y,!0,-c,f,p)}addHalfVertex({x:e,y:n},s,c,f,p,y,x,w){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),p||this.segmentPoints.push(this.lineSoFar-this.segmentStart,y)),this.layoutVertexArray.emplaceBack((e<<1)+(f?1:0),(n<<1)+(p?1:0),Math.round(63*s)+128,Math.round(63*c)+128,1+(y===0?0:y<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let S=At(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,S)}let I=x.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,I),x.primitiveLength++),p?this.e2=I:this.e1=I,w!=null&&this.zOffsetVertexArray.emplaceBack(w.zOffset,w.variableWidth,w.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,n){this.prevDistance=this.distance,this.distance+=e.dist(n),this.updateScaledDistance()}}function V1(i,e,n){return i.x<e||i.x>n||i.y<e||i.y>n}let lC,cC;function uC(i,e,n){return e*(st/(i.tileSize*Math.pow(2,n-i.tileID.overscaledZ)))}_t(B1,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let dC=(i,e,n)=>(1-n)*i+n*e;function hC(i,e){return 1/uC(i,1,e.tileZoom)}function fC(i,e,n,s){return i.translatePosMatrix(s||e.tileID.projMatrix,e,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}let pC=i=>{let e=[];mC(i)&&e.push("RENDER_LINE_DASH"),i.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");let n=i.paint.get("line-trim-offset");n[0]===0&&n[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),i.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");let s=i.layout.get("line-join").constantOr("miter")==="none",c=!!i.paint.get("line-pattern").constantOr(1);return s&&c&&e.push("LINE_JOIN_NONE"),e};function mC(i){let e=i.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let U1,gC=()=>U1||(U1={layout:lC||(lC=new Mr({"line-cap":new dt(xe.layout_line["line-cap"]),"line-join":new dt(xe.layout_line["line-join"]),"line-miter-limit":new tt(xe.layout_line["line-miter-limit"]),"line-round-limit":new tt(xe.layout_line["line-round-limit"]),"line-sort-key":new dt(xe.layout_line["line-sort-key"]),"line-z-offset":new dt(xe.layout_line["line-z-offset"]),"line-elevation-reference":new tt(xe.layout_line["line-elevation-reference"]),"line-cross-slope":new tt(xe.layout_line["line-cross-slope"]),visibility:new tt(xe.layout_line.visibility),"line-width-unit":new tt(xe.layout_line["line-width-unit"])})),paint:cC||(cC=new Mr({"line-opacity":new dt(xe.paint_line["line-opacity"]),"line-color":new dt(xe.paint_line["line-color"]),"line-translate":new tt(xe.paint_line["line-translate"]),"line-translate-anchor":new tt(xe.paint_line["line-translate-anchor"]),"line-width":new dt(xe.paint_line["line-width"]),"line-gap-width":new dt(xe.paint_line["line-gap-width"]),"line-offset":new dt(xe.paint_line["line-offset"]),"line-blur":new dt(xe.paint_line["line-blur"]),"line-dasharray":new dt(xe.paint_line["line-dasharray"]),"line-pattern":new dt(xe.paint_line["line-pattern"]),"line-pattern-cross-fade":new tt(xe.paint_line["line-pattern-cross-fade"]),"line-gradient":new pc(xe.paint_line["line-gradient"]),"line-trim-offset":new tt(xe.paint_line["line-trim-offset"]),"line-trim-fade-range":new tt(xe.paint_line["line-trim-fade-range"]),"line-trim-color":new tt(xe.paint_line["line-trim-color"]),"line-emissive-strength":new tt(xe.paint_line["line-emissive-strength"]),"line-border-width":new dt(xe.paint_line["line-border-width"]),"line-border-color":new dt(xe.paint_line["line-border-color"]),"line-occlusion-opacity":new tt(xe.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},U1);class Jk extends dt{possiblyEvaluate(e,n){return n=new jn(Math.floor(n.zoom),{now:n.now,fadeDuration:n.fadeDuration,transition:n.transition,worldview:n.worldview}),super.possiblyEvaluate(e,n)}evaluate(e,n,s,c){return n=Ce({},n,{zoom:Math.floor(n.zoom)}),super.evaluate(e,n,s,c)}}let eg;function _C(i,e){return e>0?e+2*i:i}let Qk=gn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),eN=gn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),tN=gn([{name:"a_projected_pos",components:4,type:"Float32"}],4);gn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let nN=gn([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),rN=gn([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),iN=gn([{name:"a_texb",components:2,type:"Uint16"}]),oN=gn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),sN=gn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);gn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let yC=gn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),aN=gn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);gn([{name:"triangle",components:3,type:"Uint16"}]),gn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),gn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),gn([{type:"Float32",name:"offsetX"}]),gn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var gi=24;function lN(i,e,n){return i.sections.forEach(s=>{s.text=function(c,f,p){let y=f.layout.get("text-transform").evaluate(p,{});return y==="uppercase"?c=c.toLocaleUpperCase():y==="lowercase"&&(c=c.toLocaleLowerCase()),Is.applyArabicShaping&&(c=Is.applyArabicShaping(c)),c}(s.text,e,n)}),i}let tg={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function cN(i){return i==="\uFE36"||i==="\uFE48"||i==="\uFE38"||i==="\uFE44"||i==="\uFE42"||i==="\uFE3E"||i==="\uFE3C"||i==="\uFE3A"||i==="\uFE18"||i==="\uFE40"||i==="\uFE10"||i==="\uFE13"||i==="\uFE14"||i==="\uFF40"||i==="\uFFE3"||i==="\uFE11"||i==="\uFE12"}function uN(i){return i==="\uFE35"||i==="\uFE47"||i==="\uFE37"||i==="\uFE43"||i==="\uFE41"||i==="\uFE3D"||i==="\uFE3B"||i==="\uFE39"||i==="\uFE17"||i==="\uFE3F"}let j1=4294967296,vC=1/j1,xC=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),_v=class{constructor(i=new Uint8Array(16)){this.buf=ArrayBuffer.isView(i)?i:new Uint8Array(i),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(i,e,n=this.length){for(;this.pos<n;){let s=this.readVarint(),c=s>>3,f=this.pos;this.type=7&s,i(c,e,this),this.pos===f&&this.skip(s)}return e}readMessage(i,e){return this.readFields(i,e,this.readVarint()+this.pos)}readFixed32(){let i=this.dataView.getUint32(this.pos,!0);return this.pos+=4,i}readSFixed32(){let i=this.dataView.getInt32(this.pos,!0);return this.pos+=4,i}readFixed64(){let i=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*j1;return this.pos+=8,i}readSFixed64(){let i=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*j1;return this.pos+=8,i}readFloat(){let i=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,i}readDouble(){let i=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,i}readVarint(i){let e=this.buf,n,s;return s=e[this.pos++],n=127&s,s<128?n:(s=e[this.pos++],n|=(127&s)<<7,s<128?n:(s=e[this.pos++],n|=(127&s)<<14,s<128?n:(s=e[this.pos++],n|=(127&s)<<21,s<128?n:(s=e[this.pos],n|=(15&s)<<28,function(c,f,p){let y=p.buf,x,w;if(w=y[p.pos++],x=(112&w)>>4,w<128||(w=y[p.pos++],x|=(127&w)<<3,w<128)||(w=y[p.pos++],x|=(127&w)<<10,w<128)||(w=y[p.pos++],x|=(127&w)<<17,w<128)||(w=y[p.pos++],x|=(127&w)<<24,w<128)||(w=y[p.pos++],x|=(1&w)<<31,w<128))return of(c,x,f);throw new Error("Expected varint not more than 10 bytes")}(n,i,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){let i=this.readVarint();return i%2==1?(i+1)/-2:i/2}readBoolean(){return!!this.readVarint()}readString(){let i=this.readVarint()+this.pos,e=this.pos;return this.pos=i,i-e>=12&&xC?xC.decode(this.buf.subarray(e,i)):function(n,s,c){let f="",p=s;for(;p<c;){let y=n[p],x,w,I,S=null,D=y>239?4:y>223?3:y>191?2:1;if(p+D>c)break;D===1?y<128&&(S=y):D===2?(x=n[p+1],(192&x)==128&&(S=(31&y)<<6|63&x,S<=127&&(S=null))):D===3?(x=n[p+1],w=n[p+2],(192&x)==128&&(192&w)==128&&(S=(15&y)<<12|(63&x)<<6|63&w,(S<=2047||S>=55296&&S<=57343)&&(S=null))):D===4&&(x=n[p+1],w=n[p+2],I=n[p+3],(192&x)==128&&(192&w)==128&&(192&I)==128&&(S=(15&y)<<18|(63&x)<<12|(63&w)<<6|63&I,(S<=65535||S>=1114112)&&(S=null))),S===null?(S=65533,D=1):S>65535&&(S-=65536,f+=String.fromCharCode(S>>>10&1023|55296),S=56320|1023&S),f+=String.fromCharCode(S),p+=D}return f}(this.buf,e,i)}readBytes(){let i=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,i);return this.pos=i,e}readPackedVarint(i=[],e){let n=this.readPackedEnd();for(;this.pos<n;)i.push(this.readVarint(e));return i}readPackedSVarint(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readSVarint());return i}readPackedBoolean(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readBoolean());return i}readPackedFloat(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readFloat());return i}readPackedDouble(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readDouble());return i}readPackedFixed32(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readFixed32());return i}readPackedSFixed32(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readSFixed32());return i}readPackedFixed64(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readFixed64());return i}readPackedSFixed64(i=[]){let e=this.readPackedEnd();for(;this.pos<e;)i.push(this.readSFixed64());return i}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(i){let e=7&i;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(i,e){this.writeVarint(i<<3|e)}realloc(i){let e=this.length||16;for(;e<this.pos+i;)e*=2;if(e!==this.length){let n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.dataView=new DataView(n.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(i){this.realloc(4),this.dataView.setInt32(this.pos,i,!0),this.pos+=4}writeSFixed32(i){this.realloc(4),this.dataView.setInt32(this.pos,i,!0),this.pos+=4}writeFixed64(i){this.realloc(8),this.dataView.setInt32(this.pos,-1&i,!0),this.dataView.setInt32(this.pos+4,Math.floor(i*vC),!0),this.pos+=8}writeSFixed64(i){this.realloc(8),this.dataView.setInt32(this.pos,-1&i,!0),this.dataView.setInt32(this.pos+4,Math.floor(i*vC),!0),this.pos+=8}writeVarint(i){(i=+i||0)>268435455||i<0?function(e,n){let s,c;if(e>=0?(s=e%4294967296|0,c=e/4294967296|0):(s=~(-e%4294967296),c=~(-e/4294967296),4294967295^s?s=s+1|0:(s=0,c=c+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),function(f,p,y){y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,y.buf[y.pos]=127&(f>>>=7)}(s,0,n),function(f,p){let y=(7&f)<<4;p.buf[p.pos++]|=y|((f>>>=3)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f)))))}(c,n)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))}writeSVarint(i){this.writeVarint(i<0?2*-i-1:2*i)}writeBoolean(i){this.writeVarint(+i)}writeString(i){i=String(i),this.realloc(4*i.length),this.pos++;let e=this.pos;this.pos=function(s,c,f){for(let p,y,x=0;x<c.length;x++){if(p=c.charCodeAt(x),p>55295&&p<57344){if(!y){p>56319||x+1===c.length?(s[f++]=239,s[f++]=191,s[f++]=189):y=p;continue}if(p<56320){s[f++]=239,s[f++]=191,s[f++]=189,y=p;continue}p=y-55296<<10|p-56320|65536,y=null}else y&&(s[f++]=239,s[f++]=191,s[f++]=189,y=null);p<128?s[f++]=p:(p<2048?s[f++]=p>>6|192:(p<65536?s[f++]=p>>12|224:(s[f++]=p>>18|240,s[f++]=p>>12&63|128),s[f++]=p>>6&63|128),s[f++]=63&p|128)}return f}(this.buf,i,this.pos);let n=this.pos-e;n>=128&&bC(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n}writeFloat(i){this.realloc(4),this.dataView.setFloat32(this.pos,i,!0),this.pos+=4}writeDouble(i){this.realloc(8),this.dataView.setFloat64(this.pos,i,!0),this.pos+=8}writeBytes(i){let e=i.length;this.writeVarint(e),this.realloc(e);for(let n=0;n<e;n++)this.buf[this.pos++]=i[n]}writeRawMessage(i,e){this.pos++;let n=this.pos;i(e,this);let s=this.pos-n;s>=128&&bC(n,s,this),this.pos=n-1,this.writeVarint(s),this.pos+=s}writeMessage(i,e,n){this.writeTag(i,2),this.writeRawMessage(e,n)}writePackedVarint(i,e){e.length&&this.writeMessage(i,dN,e)}writePackedSVarint(i,e){e.length&&this.writeMessage(i,hN,e)}writePackedBoolean(i,e){e.length&&this.writeMessage(i,mN,e)}writePackedFloat(i,e){e.length&&this.writeMessage(i,fN,e)}writePackedDouble(i,e){e.length&&this.writeMessage(i,pN,e)}writePackedFixed32(i,e){e.length&&this.writeMessage(i,gN,e)}writePackedSFixed32(i,e){e.length&&this.writeMessage(i,_N,e)}writePackedFixed64(i,e){e.length&&this.writeMessage(i,yN,e)}writePackedSFixed64(i,e){e.length&&this.writeMessage(i,vN,e)}writeBytesField(i,e){this.writeTag(i,2),this.writeBytes(e)}writeFixed32Field(i,e){this.writeTag(i,5),this.writeFixed32(e)}writeSFixed32Field(i,e){this.writeTag(i,5),this.writeSFixed32(e)}writeFixed64Field(i,e){this.writeTag(i,1),this.writeFixed64(e)}writeSFixed64Field(i,e){this.writeTag(i,1),this.writeSFixed64(e)}writeVarintField(i,e){this.writeTag(i,0),this.writeVarint(e)}writeSVarintField(i,e){this.writeTag(i,0),this.writeSVarint(e)}writeStringField(i,e){this.writeTag(i,2),this.writeString(e)}writeFloatField(i,e){this.writeTag(i,5),this.writeFloat(e)}writeDoubleField(i,e){this.writeTag(i,1),this.writeDouble(e)}writeBooleanField(i,e){this.writeVarintField(i,+e)}};function of(i,e,n){return n?4294967296*e+(i>>>0):4294967296*(e>>>0)+(i>>>0)}function bC(i,e,n){let s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(s);for(let c=n.pos-1;c>=i;c--)n.buf[c+s]=n.buf[c]}function dN(i,e){for(let n=0;n<i.length;n++)e.writeVarint(i[n])}function hN(i,e){for(let n=0;n<i.length;n++)e.writeSVarint(i[n])}function fN(i,e){for(let n=0;n<i.length;n++)e.writeFloat(i[n])}function pN(i,e){for(let n=0;n<i.length;n++)e.writeDouble(i[n])}function mN(i,e){for(let n=0;n<i.length;n++)e.writeBoolean(i[n])}function gN(i,e){for(let n=0;n<i.length;n++)e.writeFixed32(i[n])}function _N(i,e){for(let n=0;n<i.length;n++)e.writeSFixed32(i[n])}function yN(i,e){for(let n=0;n<i.length;n++)e.writeFixed64(i[n])}function vN(i,e){for(let n=0;n<i.length;n++)e.writeSFixed64(i[n])}let H1=3;function xN(i,e,n){e.glyphs=[],i===1&&n.readMessage(bN,e)}function bN(i,e,n){if(i===3){let{id:s,bitmap:c,width:f,height:p,left:y,top:x,advance:w}=n.readMessage(wN,{});e.glyphs.push({id:s,bitmap:new Rc({width:f+2*H1,height:p+2*H1},c),metrics:{width:f,height:p,left:y,top:x,advance:w}})}else i===4?e.ascender=n.readSVarint():i===5&&(e.descender=n.readSVarint())}function wN(i,e,n){i===1?e.id=n.readVarint():i===2?e.bitmap=n.readBytes():i===3?e.width=n.readVarint():i===4?e.height=n.readVarint():i===5?e.left=n.readSVarint():i===6?e.top=n.readSVarint():i===7&&(e.advance=n.readVarint())}let wC=H1,Bo={horizontal:1,vertical:2,horizontalOnly:3};class ng{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,n){let s=new ng;return s.scale=e||1,s.fontStack=n,s}static forImage(e){let n=new ng;return n.image=e,n}}class sf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,n,s){let c=new sf;for(let f=0;f<e.sections.length;f++){let p=e.sections[f];p.image?c.addImageSection(p,s):c.addTextSection(p,n)}return c}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(n,s){let c="";for(let f=0;f<n.length;f++){let p=n.charCodeAt(f+1)||null,y=n.charCodeAt(f-1)||null;c+=!s&&(p&&Lh(p)&&!tg[n[f+1]]||y&&Lh(y)&&!tg[n[f-1]])||!tg[n[f]]?n[f]:tg[n[f]]}return c}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&yv[this.text.charCodeAt(s)];s++)e++;let n=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&yv[this.text.charCodeAt(s)];s--)n--;this.text=this.text.substring(e,n),this.sectionIndex=this.sectionIndex.slice(e,n)}substring(e,n){let s=new sf;return s.text=this.text.substring(e,n),s.sectionIndex=this.sectionIndex.slice(e,n),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,n)=>Math.max(e,this.sections[n].scale),0)}addTextSection(e,n){this.text+=e.text,this.sections.push(ng.forText(e.scale,e.fontStack||n));let s=this.sections.length-1;for(let c=0;c<e.text.length;++c)this.sectionIndex.push(s)}addImageSection(e,n){let s=e.image?e.image.getPrimary():null;if(!s)return void fn("Can't add FormattedSection with an empty image.");s.scaleSelf(n);let c=this.getNextImageSectionCharCode();c?(this.text+=String.fromCodePoint(c),this.sections.push(ng.forImage(s)),this.sectionIndex.push(this.sections.length-1)):fn("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function G1(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,N=1){let B=sf.fromFeature(i,c,N);S===Bo.vertical&&B.verticalizePunctuation(D);let G=[],X=function(ue,ge,ye,ke,be,ze){if(!ue)return[];let et=[],Ue=function(qe,we,Fe,rt,Ye,Et){let yt=0;for(let $e=0;$e<qe.length();$e++){let Ke=qe.getSection($e);yt+=EC(qe.getCodePoint($e),Ke,rt,Ye,we,Et)}return yt/Math.max(1,Math.ceil(yt/Fe))}(ue,ge,ye,ke,be,ze),Ze=ue.text.indexOf("\u200B")>=0,Je=0;for(let qe=0;qe<ue.length();qe++){let we=ue.getSection(qe),Fe=ue.getCodePoint(qe);if(yv[Fe]||(Je+=EC(Fe,we,ke,be,ge,ze)),qe<ue.length()-1){let rt=!((Le=Fe)<11904||!(Pt["Bopomofo Extended"](Le)||Pt.Bopomofo(Le)||Pt["CJK Compatibility Forms"](Le)||Pt["CJK Compatibility Ideographs"](Le)||Pt["CJK Compatibility"](Le)||Pt["CJK Radicals Supplement"](Le)||Pt["CJK Strokes"](Le)||Pt["CJK Symbols and Punctuation"](Le)||Pt["CJK Unified Ideographs Extension A"](Le)||Pt["CJK Unified Ideographs"](Le)||Pt["Enclosed CJK Letters and Months"](Le)||Pt["Halfwidth and Fullwidth Forms"](Le)||Pt.Hiragana(Le)||Pt["Ideographic Description Characters"](Le)||Pt["Kangxi Radicals"](Le)||Pt["Katakana Phonetic Extensions"](Le)||Pt.Katakana(Le)||Pt["Vertical Forms"](Le)||Pt["Yi Radicals"](Le)||Pt["Yi Syllables"](Le)));(EN[Fe]||rt||we.image)&&et.push(IC(qe+1,Je,Ue,et,TN(Fe,ue.getCodePoint(qe+1),rt&&Ze),!1))}}var Le;return SC(IC(ue.length(),Je,Ue,et,0,!0))}(B,w,f,e,s,P),{processBidirectionalText:q,processStyledBidirectionalText:K}=Is;if(q&&B.sections.length===1){let ue=q(B.toString(),X);for(let ge of ue){let ye=new sf;ye.text=ge,ye.sections=B.sections;for(let ke=0;ke<ge.length;ke++)ye.sectionIndex.push(0);G.push(ye)}}else if(K){let ue=K(B.text,B.sectionIndex,X);for(let ge of ue){let ye=new sf;ye.text=ge[0],ye.sectionIndex=ge[1],ye.sections=B.sections,G.push(ye)}}else G=function(ue,ge){let ye=[],ke=ue.text,be=0;for(let ze of ge)ye.push(ue.substring(be,ze)),be=ze;return be<ke.length&&ye.push(ue.substring(be,ke.length)),ye}(B,X);let he=[],le={positionedLines:he,text:B.toString(),top:I[1],bottom:I[1],left:I[0],right:I[0],writingMode:S,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(ue,ge,ye,ke,be,ze,et,Ue,Ze,Je,Le,qe){let we=0,Fe=0,rt=0,Ye=Ue==="right"?1:Ue==="left"?0:.5,Et=!1;for(let at of be){let mt=at.getSections();for(let Rt of mt){if(Rt.image)continue;let Bt=ge[Rt.fontStack];if(Bt&&(Et=Bt.ascender!==void 0&&Bt.descender!==void 0,!Et))break}if(!Et)break}let yt=0;for(let at of be){at.trim();let mt=at.getMaxScale(),Rt=(mt-1)*gi,Bt={positionedGlyphs:[],lineOffset:0};ue.positionedLines[yt]=Bt;let qt=Bt.positionedGlyphs,Gt=0;if(!at.length()){Fe+=ze,++yt;continue}let pn=0,nn=0;for(let Q=0;Q<at.length();Q++){let ee=at.getSection(Q),Re=at.getSectionIndex(Q),it=at.getCodePoint(Q),ct=ee.scale,lt=null,vt=null,Ft=null,cn=gi,un=0,Jt=Ze;Jt===Bo.vertical&&(($e=it)===12312||$e===12313||$e===12316||$e===12540||$e===12448)&&(Jt=Bo.horizontal);let Hn=!(Jt===Bo.horizontal||!Le&&!Oh(it)||Le&&(yv[it]||Dy(it)));if(ee.image){let Er=ke.get(ee.image.toString());if(!Er)continue;Ft=ee.image,ue.iconsInText=ue.iconsInText||!0,vt=Er.paddedRect;let Xt=Er.displaySize;ct=ct*gi/qe,lt={width:Xt[0],height:Xt[1],left:0,top:-wC,advance:Hn?Xt[1]:Xt[0],localGlyph:!1},un=Et?-lt.height*ct:mt*gi-17-Xt[1]*ct,cn=lt.advance;let ar=(Hn?Xt[0]:Xt[1])*ct-gi*mt;ar>0&&ar>Gt&&(Gt=ar)}else{let Er=ye[ee.fontStack];if(!Er)continue;Er[it]&&(vt=Er[it]);let Xt=ge[ee.fontStack];if(!Xt)continue;let ar=Xt.glyphs[it];if(!ar)continue;if(lt=ar.metrics,cn=it!==8203?gi:0,Et){let Qn=Xt.ascender!==void 0?Math.abs(Xt.ascender):0,kn=Xt.descender!==void 0?Math.abs(Xt.descender):0,vr=(Qn+kn)*ct;pn<vr&&(pn=vr,nn=(Qn-kn)/2*ct),un=-Qn*ct}else un=(mt-ct)*gi-17}Hn?(ue.verticalizable=!0,qt.push({glyph:it,image:Ft,x:we,y:Fe+un,vertical:Hn,scale:ct,localGlyph:lt.localGlyph,fontStack:ee.fontStack,sectionIndex:Re,metrics:lt,rect:vt}),we+=cn*ct+Je):(qt.push({glyph:it,image:Ft,x:we,y:Fe+un,vertical:Hn,scale:ct,localGlyph:lt.localGlyph,fontStack:ee.fontStack,sectionIndex:Re,metrics:lt,rect:vt}),we+=lt.advance*ct+Je)}qt.length!==0&&(rt=Math.max(we-Je,rt),Et?DC(qt,Ye,Gt,nn,ze*mt/2):DC(qt,Ye,Gt,0,ze/2)),we=0;let nr=ze*mt+Gt;Bt.lineOffset=Math.max(Gt,Rt),Fe+=nr,++yt}var $e;let Ke=Fe,{horizontalAlign:xt,verticalAlign:pt}=$1(et);(function(at,mt,Rt,Bt,qt,Gt){let pn=(mt-Rt)*qt,nn=-Gt*Bt;for(let nr of at)for(let Q of nr.positionedGlyphs)Q.x+=pn,Q.y+=nn})(ue.positionedLines,Ye,xt,pt,rt,Ke),ue.top+=-pt*Ke,ue.bottom=ue.top+Ke,ue.left+=-xt*rt,ue.right=ue.left+rt,ue.hasBaseline=Et}(le,e,n,s,G,p,y,x,S,w,D,O),!function(ue){for(let ge of ue)if(ge.positionedGlyphs.length!==0)return!1;return!0}(he))return le}let yv={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},EN={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function EC(i,e,n,s,c,f){if(e.image){let p=s.get(e.image.toString());return p?p.displaySize[0]*e.scale*gi/f+c:0}{let p=n[e.fontStack],y=p&&p.glyphs[i];return y?y.metrics.advance*e.scale+c:0}}function TC(i,e,n,s){let c=Math.pow(i-e,2);return s?i<e?c/2:2*c:c+Math.abs(n)*n}function TN(i,e,n){let s=0;return i===10&&(s-=1e4),n&&(s+=150),i!==40&&i!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function IC(i,e,n,s,c,f){let p=null,y=TC(e,n,c,f);for(let x of s){let w=TC(e-x.x,n,c,f)+x.badness;w<=y&&(p=x,y=w)}return{index:i,x:e,priorBreak:p,badness:y}}function SC(i){return i?SC(i.priorBreak).concat(i.index):[]}function $1(i){let e=.5,n=.5;switch(i){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:e,verticalAlign:n}}function DC(i,e,n,s,c){if(!(e||n||s||c))return;let f=i.length-1,p=i[f],y=(p.x+p.metrics.advance*p.scale)*e;for(let x=0;x<=f;x++)i[x].x-=y,i[x].y+=n+s+c}function CC(i){return i.imagePrimary!==void 0&&i.top!==void 0&&i.bottom!==void 0&&i.left!==void 0&&i.right!==void 0}function IN(i,e,n,s){let{horizontalAlign:c,verticalAlign:f}=$1(s),p=n[0]-i.displaySize[0]*c,y=n[1]-i.displaySize[1]*f;return{imagePrimary:i,imageSecondary:e,top:y,bottom:y+i.displaySize[1],left:p,right:p+i.displaySize[0]}}function AC(i,e,n,s,c,f){let p=i.imagePrimary,y;if(p.content){let B=p.content,G=p.pixelRatio||1;y=[B[0]/G,B[1]/G,p.displaySize[0]-B[2]/G,p.displaySize[1]-B[3]/G]}let x=e.left*f,w=e.right*f,I,S,D,P;n==="width"||n==="both"?(P=c[0]+x-s[3],S=c[0]+w+s[1]):(P=c[0]+(x+w-p.displaySize[0])/2,S=P+p.displaySize[0]);let O=e.top*f,N=e.bottom*f;return n==="height"||n==="both"?(I=c[1]+O-s[0],D=c[1]+N+s[2]):(I=c[1]+(O+N-p.displaySize[1])/2,D=I+p.displaySize[1]),{imagePrimary:p,imageSecondary:void 0,top:I,right:S,bottom:D,left:P,collisionPadding:y}}function MC(i){return!i.imagePrimary.stretchX}function RC(i){return!i.imagePrimary.stretchY}function PC(i){return{width:i.right-i.left,height:i.bottom-i.top}}let za=128;function OC(i,e,n){let{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new jn(i+1,{worldview:n}))};if(s.kind==="source")return{kind:"source"};{let{zoomStops:c,interpolationType:f}=s,p=0;for(;p<c.length&&c[p]<=i;)p++;p=Math.max(0,p-1);let y=p;for(;y<c.length&&c[y]<i+1;)y++;y=Math.min(c.length-1,y);let x=c[p],w=c[y];return s.kind==="composite"?{kind:"composite",minZoom:x,maxZoom:w,interpolationType:f}:{kind:"camera",minZoom:x,maxZoom:w,minSize:s.evaluate(new jn(x,{worldview:n})),maxSize:s.evaluate(new jn(w,{worldview:n})),interpolationType:f}}}function W1(i,{uSize:e,uSizeT:n},{lowerSize:s,upperSize:c}){return i.kind==="source"?s/za:i.kind==="composite"?At(s/za,c/za,n):e}function rg(i,e,n=1){let s=0,c=0;if(i.kind==="constant")c=i.layoutSize*n;else if(i.kind!=="source"){let{interpolationType:f,minZoom:p,maxZoom:y}=i,x=f?ne(no.interpolationFactor(f,e,p,y),0,1):0;i.kind==="camera"?c=At(i.minSize,i.maxSize,x)*n:s=x*n}return{uSizeT:s,uSize:c}}class wl extends Xe{constructor(e,n,s,c,f){super(e,n),this.angle=c,this.z=s,f!==void 0&&(this.segment=f)}clone(){return new wl(this.x,this.y,this.z,this.angle,this.segment)}}function LC(i,e,n,s,c){if(e.segment===void 0)return!0;let f=e,p=e.segment+1,y=0;for(;y>-n/2;){if(p--,p<0)return!1;y-=i[p].dist(f),f=i[p]}y+=i[p].dist(i[p+1]),p++;let x=[],w=0;for(;y<n/2;){let I=i[p],S=i[p+1];if(!S)return!1;let D=i[p-1].angleTo(I)-I.angleTo(S);for(D=Math.abs((D+3*Math.PI)%(2*Math.PI)-Math.PI),x.push({distance:y,angleDelta:D}),w+=D;y-x[0].distance>s;)w-=x.shift().angleDelta;if(w>c)return!1;p++,y+=I.dist(S)}return!0}function FC(i){let e=0;for(let n=0;n<i.length-1;n++)e+=i[n].dist(i[n+1]);return e}function kC(i,e,n){return i?.6*e*n:0}function NC(i,e){return Math.max(i?i.right-i.left:0,e?e.right-e.left:0)}function SN(i,e,n,s,c,f){let p=kC(n,c,f),y=NC(n,s)*f,x=0,w=FC(i)/2;for(let I=0;I<i.length-1;I++){let S=i[I],D=i[I+1],P=S.dist(D);if(x+P>w){let O=(w-x)/P,N=At(S.x,D.x,O),B=At(S.y,D.y,O),G=new wl(N,B,0,D.angleTo(S),I);return!p||LC(i,G,y,p,e)?G:void 0}x+=P}}function DN(i,e,n,s,c,f,p,y,x){let w=kC(s,f,p),I=NC(s,c),S=I*p,D=i[0].x===0||i[0].x===x||i[0].y===0||i[0].y===x;return e-S<e/4&&(e=S+e/4),zC(i,D?e/2*y%e:(I/2+2*f)*p*y%e,e,w,n,S,D,!1,x)}function zC(i,e,n,s,c,f,p,y,x){let w=f/2,I=FC(i),S=0,D=e-n,P=[];for(let O=0;O<i.length-1;O++){let N=i[O],B=i[O+1],G=N.dist(B),X=B.angleTo(N);for(;D+n<S+G;){D+=n;let q=(D-S)/G,K=At(N.x,B.x,q),he=At(N.y,B.y,q);if(K>=0&&K<x&&he>=0&&he<x&&D-w>=0&&D+w<=I){let le=new wl(K,he,0,X,O);s&&!LC(i,le,f,s,c)||P.push(le)}}S+=G}return y||P.length||p||(P=zC(i,S/2,n,s,c,f,p,!0,x)),P}function BC(i){let e=0,n=0;for(let p of i)e+=p.w*p.h,n=Math.max(n,p.w);i.sort((p,y)=>y.h-p.h);let s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),n),h:1/0}],c=0,f=0;for(let p of i)for(let y=s.length-1;y>=0;y--){let x=s[y];if(!(p.w>x.w||p.h>x.h)){if(p.x=x.x,p.y=x.y,f=Math.max(f,p.y+p.h),c=Math.max(c,p.x+p.w),p.w===x.w&&p.h===x.h){let w=s.pop();w&&y<s.length&&(s[y]=w)}else p.h===x.h?(x.x+=p.w,x.w-=p.w):p.w===x.w?(x.y+=p.h,x.h-=p.h):(s.push({x:x.x+p.w,y:x.y,w:x.w-p.w,h:p.h}),x.y+=p.h,x.h-=p.h);break}}return{w:c,h:f,fill:e/(c*f)||0}}_t(wl,"Anchor");let cd=1;class ig{static getImagePositionScale(e,n,s){if(n&&e&&e.options&&e.options.transform){let c=e.options.transform;return{x:c.a,y:c.d}}return{x:s,y:s}}constructor(e,n,s,c){this.paddedRect=e;let{pixelRatio:f,version:p,stretchX:y,stretchY:x,content:w,sdf:I,usvg:S}=n;this.pixelRatio=f,this.stretchX=y,this.stretchY=x,this.content=w,this.version=p,this.padding=s,this.sdf=I,this.usvg=S,this.scale=ig.getImagePositionScale(c,S,f)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function Z1(i,e,n){let s=Gs.parse(i),c=function(f,p,y=[1,1]){return{x:0,y:0,w:(f.data?f.data.width:f.width*y[0])+2*p,h:(f.data?f.data.height:f.height*y[1])+2*p}}(e,n,[s.options.transform.a,s.options.transform.d]);return{bin:c,imagePosition:new ig(c,e,n,s),imageVariant:s}}class VC{constructor(e,n,s){let c=new Map,f=new Map;this.haveRenderCallbacks=[];let p=[];this.addImages(e,c,cd,p),this.addImages(n,f,2,p);let{w:y,h:x}=BC(p),w=new Si({width:y||1,height:x||1});for(let[I,S]of e.entries()){let D=c.get(I).paddedRect;Si.copy(S.data,w,{x:0,y:0},{x:D.x+cd,y:D.y+cd},S.data,s,S.sdf)}for(let[I,S]of n.entries()){let D=f.get(I),P=D.paddedRect,O=D.padding,N=P.x+O,B=P.y+O,G=S.data.width,X=S.data.height;O=O>1?O-1:O,Si.copy(S.data,w,{x:0,y:0},{x:N,y:B},S.data,s),Si.copy(S.data,w,{x:0,y:X-O},{x:N,y:B-O},{width:G,height:O},s),Si.copy(S.data,w,{x:0,y:0},{x:N,y:B+X},{width:G,height:O},s),Si.copy(S.data,w,{x:G-O,y:0},{x:N-O,y:B},{width:O,height:X},s),Si.copy(S.data,w,{x:0,y:0},{x:N+G,y:B},{width:O,height:X},s),Si.copy(S.data,w,{x:G-O,y:X-O},{x:N-O,y:B-O},{width:O,height:O},s),Si.copy(S.data,w,{x:0,y:X-O},{x:N+G,y:B-O},{width:O,height:O},s),Si.copy(S.data,w,{x:0,y:0},{x:N+G,y:B+X},{width:O,height:O},s),Si.copy(S.data,w,{x:G-O,y:0},{x:N-O,y:B+X},{width:O,height:O},s)}this.lut=s,this.image=w,this.iconPositions=c,this.patternPositions=f}addImages(e,n,s,c){for(let[f,p]of e.entries()){let{bin:y,imagePosition:x,imageVariant:w}=Z1(f,p,s);n.set(f,x),c.push(y),p.hasRenderCallback&&this.haveRenderCallbacks.push(w.id)}}patchUpdatedImages(e,n,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(c=>e.hasImage(c,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(let c of e.getUpdatedImages(s)){for(let f of this.iconPositions.keys()){let p=Gs.parse(f);if(fo.isEqual(p.id,c)){let y=e.getImage(c,s);this.patchUpdatedImage(this.iconPositions.get(f),y,n)}}for(let f of this.patternPositions.keys()){let p=Gs.parse(f);if(fo.isEqual(p.id,c)){let y=e.getImage(c,s);this.patchUpdatedImage(this.patternPositions.get(f),y,n)}}}}patchUpdatedImage(e,n,s){if(!e||!n||e.version===n.version)return;e.version=n.version;let[c,f]=e.tl,p=e.sdf;if(this.lut||p){let y={width:n.data.width,height:n.data.height},x=new Si(y);Si.copy(n.data,x,{x:0,y:0},{x:0,y:0},y,this.lut,p),s.update(x,{position:{x:c,y:f}})}else s.update(n.data,{position:{x:c,y:f}})}}_t(ig,"ImagePosition"),_t(VC,"ImageAtlas");let og=1e20;function UC(i,e,n,s,c,f,p,y,x){for(let w=e;w<e+s;w++)jC(i,n*f+w,f,c,p,y,x);for(let w=n;w<n+c;w++)jC(i,w*f+e,1,s,p,y,x)}function jC(i,e,n,s,c,f,p){f[0]=0,p[0]=-og,p[1]=og,c[0]=i[e];for(let y=1,x=0,w=0;y<s;y++){c[y]=i[e+y*n];let I=y*y;do{let S=f[x];w=(c[y]-c[S]+I-S*S)/(y-S)/2}while(w<=p[x]&&--x>-1);x++,f[x]=y,p[x]=w,p[x+1]=og}for(let y=0,x=0;y<s;y++){for(;p[x+1]<y;)x++;let w=f[x],I=y-w;i[e+y*n]=c[w]+I*I}}let qs=2,q1={none:0,ideographs:1,all:2};class af{constructor(e,n,s){this.requestManager=e,this.localGlyphMode=n,this.localFontFamily=s,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,n){let s=[],c=this.url||vi.GLYPHS_URL;for(let f in e)for(let p of e[f])s.push({stack:f,id:p});ve(s,({stack:f,id:p},y)=>{let x=this.entries[f];x||(x=this.entries[f]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let w=x.glyphs[p];if(w!==void 0)return void y(null,{stack:f,id:p,glyph:w});if(w=this._tinySDF(x,f,p),w)return x.glyphs[p]=w,void y(null,{stack:f,id:p,glyph:w});let I=Math.floor(p/256);if(256*I>65535)return fn("glyphs > 65535 not supported"),void y(null,{stack:f,id:p,glyph:w});if(x.ranges[I])return void y(null,{stack:f,id:p,glyph:w});let S=x.requests[I];S||(S=x.requests[I]=[],af.loadGlyphRange(f,I,c,this.requestManager,(D,P)=>{if(P){x.ascender=P.ascender,x.descender=P.descender;for(let O in P.glyphs)this._doesCharSupportLocalGlyph(+O)||(x.glyphs[+O]=P.glyphs[+O]);x.ranges[I]=!0}for(let O of S)O(D,P);delete x.requests[I]})),S.push((D,P)=>{D?y(D):P&&y(null,{stack:f,id:p,glyph:P.glyphs[p]||null})})},(f,p)=>{if(f)n(f);else if(p){let y={};for(let{stack:x,id:w,glyph:I}of p)y[x]===void 0&&(y[x]={}),y[x].glyphs===void 0&&(y[x].glyphs={}),y[x].glyphs[w]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},y[x].ascender=this.entries[x].ascender,y[x].descender=this.entries[x].descender;n(null,y)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==q1.none&&(this.localGlyphMode===q1.all?!!this.localFontFamily:!!this.localFontFamily&&(Pt["CJK Unified Ideographs"](e)||Pt["Hangul Syllables"](e)||Pt.Hiragana(e)||Pt.Katakana(e)||Pt["CJK Symbols and Punctuation"](e)||Pt["CJK Unified Ideographs Extension A"](e)||Pt["CJK Unified Ideographs Extension B"](e)||Pt.Osage(e)))}_tinySDF(e,n,s){let c=this.localFontFamily;if(!c||!this._doesCharSupportLocalGlyph(s))return;let f=e.tinySDF;if(!f){let N="400";/bold/i.test(n)?N="900":/medium/i.test(n)?N="500":/light/i.test(n)&&(N="200"),f=e.tinySDF=new af.TinySDF({fontFamily:c,fontWeight:N,fontSize:24*qs,buffer:3*qs,radius:8*qs}),f.fontWeight=N}if(this.localGlyphs[f.fontWeight][s])return this.localGlyphs[f.fontWeight][s];let p=String.fromCodePoint(s),{data:y,width:x,height:w,glyphWidth:I,glyphHeight:S,glyphLeft:D,glyphTop:P,glyphAdvance:O}=f.draw(p);return this.localGlyphs[f.fontWeight][s]={id:s,bitmap:new Rc({width:x,height:w},y),metrics:{width:I/qs,height:S/qs,left:D/qs,top:P/qs-27,advance:O/qs,localGlyph:!0}}}}af.loadGlyphRange=function(i,e,n,s,c){let f=256*e,p=f+255,y=s.transformRequest(s.normalizeGlyphsURL(n).replace("{fontstack}",i).replace("{range}",`${f}-${p}`),wu.Glyphs);Eu(y,(x,w)=>{if(x)c(x);else if(w){let I={},S=function(D){return new _v(D).readFields(xN,{})}(w);for(let D of S.glyphs)I[D.id]=D;c(null,{glyphs:I,ascender:S.ascender,descender:S.descender})}})},af.TinySDF=class{constructor({fontSize:i=24,buffer:e=3,radius:n=8,cutoff:s=.25,fontFamily:c="sans-serif",fontWeight:f="normal",fontStyle:p="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=n;let y=this.size=i+4*e,x=this._createCanvas(y),w=this.ctx=x.getContext("2d",{willReadFrequently:!0});w.font=`${p} ${f} ${i}px ${c}`,w.textBaseline="alphabetic",w.textAlign="left",w.fillStyle="black",this.gridOuter=new Float64Array(y*y),this.gridInner=new Float64Array(y*y),this.f=new Float64Array(y),this.z=new Float64Array(y+1),this.v=new Uint16Array(y)}_createCanvas(i){let e=document.createElement("canvas");return e.width=e.height=i,e}draw(i){let{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:s,actualBoundingBoxLeft:c,actualBoundingBoxRight:f}=this.ctx.measureText(i),p=Math.ceil(n),y=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(f-c))),x=Math.min(this.size-this.buffer,p+Math.ceil(s)),w=y+2*this.buffer,I=x+2*this.buffer,S=Math.max(w*I,0),D=new Uint8ClampedArray(S),P={data:D,width:w,height:I,glyphWidth:y,glyphHeight:x,glyphTop:p,glyphLeft:0,glyphAdvance:e};if(y===0||x===0)return P;let{ctx:O,buffer:N,gridInner:B,gridOuter:G}=this;O.clearRect(N,N,y,x),O.fillText(i,N,N+p);let X=O.getImageData(N,N,y,x);G.fill(og,0,S),B.fill(0,0,S);for(let q=0;q<x;q++)for(let K=0;K<y;K++){let he=X.data[4*(q*y+K)+3]/255;if(he===0)continue;let le=(q+N)*w+K+N;if(he===1)G[le]=0,B[le]=og;else{let ue=.5-he;G[le]=ue>0?ue*ue:0,B[le]=ue<0?ue*ue:0}}UC(G,0,0,w,I,w,this.f,this.v,this.z),UC(B,N,N,y,x,w,this.f,this.v,this.z);for(let q=0;q<S;q++){let K=Math.sqrt(G[q])-Math.sqrt(B[q]);D[q]=Math.round(255-255*(K/this.radius+this.cutoff))}return P}};let Lc=cd;function HC(i,e){return i+e[1]-e[0]}function GC(i,e,n,s,c=1){let f=[],p=i.imagePrimary,y=p.pixelRatio,x=p.paddedRect.w-2*Lc,w=p.paddedRect.h-2*Lc,I=(i.right-i.left)*c,S=(i.bottom-i.top)*c,D=p.stretchX||[[0,x]],P=p.stretchY||[[0,w]],O=D.reduce(HC,0),N=P.reduce(HC,0),B=x-O,G=w-N,X=0,q=O,K=0,he=N,le=0,ue=B,ge=0,ye=G;if(p.content&&s){let be=p.content;X=vv(D,0,be[0]),K=vv(P,0,be[1]),q=vv(D,be[0],be[2]),he=vv(P,be[1],be[3]),le=be[0]-X,ge=be[1]-K,ue=be[2]-be[0]-q,ye=be[3]-be[1]-he}let ke=(be,ze,et,Ue)=>{let Ze=xv(be.stretch-X,q,I,i.left*c),Je=bv(be.fixed-le,ue,be.stretch,O),Le=xv(ze.stretch-K,he,S,i.top*c),qe=bv(ze.fixed-ge,ye,ze.stretch,N),we=xv(et.stretch-X,q,I,i.left*c),Fe=bv(et.fixed-le,ue,et.stretch,O),rt=xv(Ue.stretch-K,he,S,i.top*c),Ye=bv(Ue.fixed-ge,ye,Ue.stretch,N),Et=new Xe(Ze,Le),yt=new Xe(we,Le),$e=new Xe(we,rt),Ke=new Xe(Ze,rt),xt=new Xe(Je/y,qe/y),pt=new Xe(Fe/y,Ye/y),at=e*Math.PI/180;if(at){let pn=Math.sin(at),nn=Math.cos(at),nr=[nn,-pn,pn,nn];Et._matMult(nr),yt._matMult(nr),Ke._matMult(nr),$e._matMult(nr)}let mt=be.stretch+be.fixed,Rt=et.stretch+et.fixed,Bt=ze.stretch+ze.fixed,qt=Ue.stretch+Ue.fixed,Gt=i.imageSecondary;return{tl:Et,tr:yt,bl:Ke,br:$e,texPrimary:{x:p.paddedRect.x+Lc+mt,y:p.paddedRect.y+Lc+Bt,w:Rt-mt,h:qt-Bt},texSecondary:Gt?{x:Gt.paddedRect.x+Lc+mt,y:Gt.paddedRect.y+Lc+Bt,w:Rt-mt,h:qt-Bt}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:xt,pixelOffsetBR:pt,minFontScaleX:ue/y/I,minFontScaleY:ye/y/S,isSDF:n}};if(s&&(p.stretchX||p.stretchY)){let be=$C(D,B,O),ze=$C(P,G,N);for(let et=0;et<be.length-1;et++){let Ue=be[et],Ze=be[et+1];for(let Je=0;Je<ze.length-1;Je++)f.push(ke(Ue,ze[Je],Ze,ze[Je+1]))}}else f.push(ke({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:x+1},{fixed:0,stretch:w+1}));return f}function vv(i,e,n){let s=0;for(let c of i)s+=Math.max(e,Math.min(n,c[1]))-Math.max(e,Math.min(n,c[0]));return s}function $C(i,e,n){let s=[{fixed:-Lc,stretch:0}];for(let[c,f]of i){let p=s[s.length-1];s.push({fixed:c-p.stretch,stretch:p.stretch}),s.push({fixed:c-p.stretch,stretch:p.stretch+(f-c)})}return s.push({fixed:e+Lc,stretch:n}),s}function xv(i,e,n,s){return i/e*n+s}function bv(i,e,n,s){return i-e*n/s}function CN(i,e,n,s){let c=e+i.positionedLines[s].lineOffset;return s===0?n+c/2:n+(c+(e+i.positionedLines[s-1].lineOffset))/2}function AN(i,e=1,n=!1){let s=1/0,c=1/0,f=-1/0,p=-1/0,y=i[0];for(let P=0;P<y.length;P++){let O=y[P];(!P||O.x<s)&&(s=O.x),(!P||O.y<c)&&(c=O.y),(!P||O.x>f)&&(f=O.x),(!P||O.y>p)&&(p=O.y)}let x=Math.min(f-s,p-c),w=x/2,I=new lh([],MN);if(x===0)return new Xe(s,c);for(let P=s;P<f;P+=x)for(let O=c;O<p;O+=x)I.push(new lf(P+w,O+w,w,i));let S=function(P){let O=0,N=0,B=0,G=P[0];for(let X=0,q=G.length,K=q-1;X<q;K=X++){let he=G[X],le=G[K],ue=he.x*le.y-le.x*he.y;N+=(he.x+le.x)*ue,B+=(he.y+le.y)*ue,O+=3*ue}return new lf(N/O,B/O,0,P)}(i),D=I.length;for(;I.length;){let P=I.pop();(P.d>S.d||!S.d)&&(S=P,n&&console.log("found best %d after %d probes",Math.round(1e4*P.d)/1e4,D)),P.max-S.d<=e||(w=P.h/2,I.push(new lf(P.p.x-w,P.p.y-w,w,i)),I.push(new lf(P.p.x+w,P.p.y-w,w,i)),I.push(new lf(P.p.x-w,P.p.y+w,w,i)),I.push(new lf(P.p.x+w,P.p.y+w,w,i)),D+=4)}return n&&(console.log(`num probes: ${D}`),console.log(`best distance: ${S.d}`)),S.p}function MN(i,e){return e.max-i.max}class lf{constructor(e,n,s,c){this.p=new Xe(e,n),this.h=s,this.d=function(f,p){let y=!1,x=1/0;for(let w=0;w<p.length;w++){let I=p[w];for(let S=0,D=I.length,P=D-1;S<D;P=S++){let O=I[S],N=I[P];O.y>f.y!=N.y>f.y&&f.x<(N.x-O.x)*(f.y-O.y)/(N.y-O.y)+O.x&&(y=!y),x=Math.min(x,Lo(f,O,N))}}return(y?1:-1)*Math.sqrt(x)}(this.p,c),this.max=this.d+this.h*Math.SQRT2}}let RN=Object.keys,X1=Number.POSITIVE_INFINITY,PN=Math.sqrt(2);function WC(i,[e,n]){let s=0,c=0;if(n===X1){e<0&&(e=0);let f=e/PN;switch(i){case"top-right":case"top-left":c=f-7;break;case"bottom-right":case"bottom-left":c=7-f;break;case"bottom":c=7-e;break;case"top":c=e-7}switch(i){case"top-right":case"bottom-right":s=-f;break;case"top-left":case"bottom-left":s=f;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),n=Math.abs(n),i){case"top-right":case"top-left":case"top":c=n-7;break;case"bottom-right":case"bottom-left":case"bottom":c=7-n}switch(i){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,c]}function wv(i,e,n,s,c,f,p,y,x){if(!e||!e.usvg)return;let w=PC(s),I=PC(c),S=f!=="both"&&f!=="width"||!MC(s)?1:I.width/w.width,D=f!=="both"&&f!=="height"||!RC(s)?1:I.height/w.height;n.scaleSelf(S,D);let P=n.toString();p.set(P,n),y.set(P,e);let{imagePosition:O}=Z1(P,e,cd);x.set(P,O)}function ZC(i,e,n,s,c,f,p,y,x){if(!i)return;let w=function(I,S,D,P,O,N){if(I.kind==="camera")return I.maxSize;if(I.kind==="composite"){let B=S.possiblyEvaluate(new jn(I.maxZoom,{worldview:N}),D).evaluate(O,{},D),G=S.possiblyEvaluate(new jn(I.minZoom,{worldview:N}),D).evaluate(O,{},D);return Math.max(B,G)}return S.possiblyEvaluate(new jn(P,{worldview:N})).evaluate(O,{},D)}(e,n,s,c,f,x);return i.scaleSelf(w*y*p)}function qC(i,e,n,s,c,f,p,y,x){return{iconPrimary:ZC(i.getPrimary(),e,n,s,c,f,p,y,x),iconSecondary:ZC(i.getSecondary(),e,n,s,c,f,p,y,x)}}function ON(i,e,n){if(!e)return;let s=n.get(i.toString()),c=n.get(e.toString());c&&(s.paddedRect.w===c.paddedRect.w&&s.paddedRect.h===c.paddedRect.h||fn(`Mismatch in icon variant sizes: ${i.toString()} and ${e.toString()}`),s.usvg!==c.usvg&&fn(`Mismatch in icon variant image types: ${i.id} and ${e.id}`))}function XC(i,e,n,s){if(!i)return;let c=e.get(n.toString());if(i.imagePrimary=c,s){let f=e.get(s.toString());i.imageSecondary=f}}function LN(i,e){for(let n in i.horizontal)YC(i.horizontal[n],e);YC(i.vertical,e)}function YC(i,e){if(i){for(let n of i.positionedLines)for(let s of n.positionedGlyphs)if(s.image!==null){let c=s.image.toString();s.rect=e.get(c).paddedRect}}}function Y1(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function FN(i,e,n,s,c,f,p,y,x){let w=K1(f.horizontal)||f.vertical,I=n.get("icon-text-fit-padding").evaluate(s,{},c),S,D=e;return e&&x!=="none"&&(i.allowVerticalPlacement&&f.vertical&&(S=AC(e,f.vertical,x,I,y,p)),w&&(D=AC(e,w,x,I,y,p))),{defaultShapedIcon:D,verticallyShapedIcon:S}}function kN(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G,X,q){let K=p.textMaxSize.evaluate(e,{},D);K===void 0?K=y*p.textScaleFactor:K*=p.textScaleFactor;let he=i.layers[0].layout,le=K1(n.horizontal)||n.vertical,ue=P.name==="globe",ge=gi,ye=i.tilePixelRatio*K/ge,ke=(Je=i.overscaling,i.zoom>18&&Je>2&&(Je>>=1),Math.max(st/(512*Je),1)*he.get("symbol-spacing")),be=he.get("text-padding")*i.tilePixelRatio,ze=he.get("icon-padding")*i.tilePixelRatio,et=Sn(he.get("text-max-angle")),Ue=he.get("icon-rotation-alignment")==="map"&&q!=="point",Ze=ke/2;var Je;i.hasAnyIconTextFit===!1&&B!=="none"&&(i.hasAnyIconTextFit=!0);let Le=e.properties?+e.properties[ft]:null,qe=Le&&i.elevationFeatureIdToIndex?i.elevationFeatureIdToIndex.get(Le):65535,we=(Fe,rt,Ye)=>{if(rt.x<0||rt.x>=st||rt.y<0||rt.y>=st)return;let Et=null;if(ue){let{x:yt,y:$e,z:Ke}=P.projectTilePoint(rt.x,rt.y,Ye);Et={anchor:new wl(yt,$e,Ke,0,void 0),up:P.upVector(Ye,rt.x,rt.y)}}(function(yt,$e,Ke,xt,pt,at,mt,Rt,Bt,qt,Gt,pn,nn,nr,Q,ee,Re,it,ct,lt,vt,Ft,cn,un,Jt,Hn,Er,Xt,ar){let Qn=yt.addToLineVertexArray($e,xt),kn,vr,rr,er,tr,Vn,Qt,Gn=0,xr=0,Ot=0,yn=0,ir=-1,Cr=-1,lr={},ni=Kl(""),Zn=Ke?Ke.anchor:$e,Yr=Xt!=="none",_o=0,Di=0;if(Bt._unevaluatedLayout.getValue("text-radial-offset")===void 0){let ri=Bt.layout.get("text-offset").evaluate(vt,{},Jt);_o=ri[0]*gi,Di=ri[1]*gi}else _o=Bt.layout.get("text-radial-offset").evaluate(vt,{},Jt)*gi,Di=X1;if(yt.allowVerticalPlacement&&pt.vertical){let ri=pt.vertical;if(Q)Vn=J1(ri),Rt&&(Qt=J1(Rt));else{let ai=Bt.layout.get("text-rotate").evaluate(vt,{},Jt)+90;rr=Ev(qt,Zn,$e,Gt,pn,nn,ri,nr,ai,ee),Rt&&(er=Ev(qt,Zn,$e,Gt,pn,nn,Rt,it,ai))}}if(at){let ri=yt.iconSizeData,ai=Bt.layout.get("icon-rotate").evaluate(vt,{},Jt),Ci=GC(at,ai,cn,Yr,Ft.iconScaleFactor),Gi=Rt?GC(Rt,ai,cn,Yr,Ft.iconScaleFactor):void 0;vr=Ev(qt,Zn,$e,Gt,pn,nn,at,it,ai,null),Gn=4*Ci.length;let ki=null;ri.kind==="source"?(ki=[za*Bt.layout.get("icon-size").evaluate(vt,{},Jt)*Ft.iconScaleFactor],ki[0]>Fc&&fn(`${yt.layerIds[0]}: Value for "icon-size" is >= ${sg}. Reduce your "icon-size".`)):ri.kind==="composite"&&(ki=[za*Ft.compositeIconSizes[0].evaluate(vt,{},Jt)*Ft.iconScaleFactor,za*Ft.compositeIconSizes[1].evaluate(vt,{},Jt)*Ft.iconScaleFactor],(ki[0]>Fc||ki[1]>Fc)&&fn(`${yt.layerIds[0]}: Value for "icon-size" is >= ${sg}. Reduce your "icon-size".`)),yt.addSymbols(yt.icon,Ci,ki,lt,ct,vt,void 0,Ke,$e,Qn.lineStartIndex,Qn.lineLength,-1,un,Jt,Hn,Er),ir=yt.icon.placedSymbolArray.length-1,Gi&&(xr=4*Gi.length,yt.addSymbols(yt.icon,Gi,ki,lt,ct,vt,Bo.vertical,Ke,$e,Qn.lineStartIndex,Qn.lineLength,-1,un,Jt,Hn,Er),Cr=yt.icon.placedSymbolArray.length-1)}for(let ri in pt.horizontal){let ai=ri,Ci=pt.horizontal[ai];kn||(ni=Kl(Ci.text),Q?tr=J1(Ci):kn=Ev(qt,Zn,$e,Gt,pn,nn,Ci,nr,Bt.layout.get("text-rotate").evaluate(vt,{},Jt),ee));let Gi=Ci.positionedLines.length===1;if(Ot+=KC(yt,Ke,$e,Ci,mt,Bt,Q,vt,ee,Qn,pt.vertical?Bo.horizontal:Bo.horizontalOnly,Gi?RN(pt.horizontal):[ai],lr,ir,Ft,un,Jt,Hn),Gi)break}pt.vertical&&(yn+=KC(yt,Ke,$e,pt.vertical,mt,Bt,Q,vt,ee,Qn,Bo.vertical,["vertical"],lr,Cr,Ft,un,Jt,Hn));let xi=-1,yo=(ri,ai)=>ri?Math.max(ri,ai):ai;xi=yo(tr,xi),xi=yo(Vn,xi),xi=yo(Qt,xi);let Ba=xi>-1?1:0;yt.glyphOffsetArray.length>=65535&&fn("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),vt.sortKey!==void 0&&yt.addToSortKeyRanges(yt.symbolInstances.length,vt.sortKey),yt.symbolInstances.emplaceBack($e.x,$e.y,Zn.x,Zn.y,Zn.z,lr.right>=0?lr.right:-1,lr.center>=0?lr.center:-1,lr.left>=0?lr.left:-1,lr.vertical>=0?lr.vertical:-1,ir,Cr,ni,kn!==void 0?kn:yt.collisionBoxArray.length,kn!==void 0?kn+1:yt.collisionBoxArray.length,rr!==void 0?rr:yt.collisionBoxArray.length,rr!==void 0?rr+1:yt.collisionBoxArray.length,vr!==void 0?vr:yt.collisionBoxArray.length,vr!==void 0?vr+1:yt.collisionBoxArray.length,er||yt.collisionBoxArray.length,er?er+1:yt.collisionBoxArray.length,Gt,Ot,yn,Gn,xr,Ba,0,_o,Di,xi,0,Yr?1:0,ar)})(i,rt,Et,Fe,n,s,f,c,i.layers[0],i.collisionBoxArray,e.index,e.sourceLayerIndex,i.index,be,X,w,0,ze,Ue,G,e,p,I,S,D,O,N,B,qe)};if(q==="line")for(let Fe of lv(e.geometry,0,0,st,st)){let rt=DN(Fe,ke,et,n.vertical||le,s,ge,ye,i.overscaling,st);for(let Ye of rt)le&&NN(i,le.text,Ze,Ye)||we(Fe,Ye,D)}else if(q==="line-center"){for(let Fe of e.geometry)if(Fe.length>1){let rt=SN(Fe,et,n.vertical||le,s,ge,ye);rt&&we(Fe,rt,D)}}else if(e.type==="Polygon")for(let Fe of jm(e.geometry,0)){let rt=AN(Fe,16);we(Fe[0],new wl(rt.x,rt.y,0,0,void 0),D)}else if(e.type==="LineString")for(let Fe of e.geometry)we(Fe,new wl(Fe[0].x,Fe[0].y,0,0,void 0),D);else if(e.type==="Point")for(let Fe of e.geometry)for(let rt of Fe)we([rt],new wl(rt.x,rt.y,0,0,void 0),D)}let sg=255,Fc=sg*za;function KC(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B,G){let X=function(he,le,ue,ge,ye,ke,be,ze){let et=[];if(le.positionedLines.length===0)return et;let Ue=ge.layout.get("text-rotate").evaluate(ke,{})*Math.PI/180,Ze=function(Fe){let rt=Fe[0],Ye=Fe[1],Et=rt*Ye;return Et>0?[rt,-Ye]:Et<0?[-rt,Ye]:rt===0?[Ye,rt]:[Ye,-rt]}(ue),Je=Math.abs(le.top-le.bottom);for(let Fe of le.positionedLines)Je-=Fe.lineOffset;let Le=le.positionedLines.length,qe=Je/Le,we=le.top-ue[1];for(let Fe=0;Fe<Le;++Fe){let rt=le.positionedLines[Fe];we=CN(le,qe,we,Fe);for(let Ye of rt.positionedGlyphs){if(!Ye.rect)continue;let Et=Ye.rect||{},yt=wC+1,$e=!0,Ke=1,xt=0;if(Ye.image){let vt=be.get(Ye.image.toString());if(!vt)continue;if(vt.sdf){fn("SDF images are not supported in formatted text and will be ignored.");continue}$e=!1,Ke=vt.pixelRatio,yt=cd/Ke}let pt=(ye||ze)&&Ye.vertical,at=Ye.metrics.advance*Ye.scale/2,mt=Ye.metrics,Rt=Ye.rect;if(Rt===null)continue;ze&&le.verticalizable&&(xt=Ye.image?at-Ye.metrics.width*Ye.scale/2:0);let Bt=ye?[Ye.x+at,Ye.y]:[0,0],qt=[0,0],Gt=[0,0],pn=!1;ye||(pt?(Gt=[Ye.x+at+Ze[0],Ye.y+Ze[1]-xt],pn=!0):qt=[Ye.x+at+ue[0],Ye.y+ue[1]-xt]);let nn=Rt.w*Ye.scale/(Ke*(Ye.localGlyph?qs:1)),nr=Rt.h*Ye.scale/(Ke*(Ye.localGlyph?qs:1)),Q,ee,Re,it;if(pt){let vt=Ye.y-we,Ft=new Xe(-at,at-vt),cn=-Math.PI/2,un=new Xe(...Gt);Q=new Xe(-at+qt[0],qt[1]),Q._rotateAround(cn,Ft)._add(un),Q.x+=-vt+at,Q.y-=(mt.left-yt)*Ye.scale;let Jt=Ye.image?mt.advance*Ye.scale:gi*Ye.scale,Hn=String.fromCodePoint(Ye.glyph);cN(Hn)?Q.x+=(1-yt)*Ye.scale:uN(Hn)?Q.x+=Jt-mt.height*Ye.scale+(-yt-1)*Ye.scale:Q.x+=Ye.image||mt.width+2*yt===Rt.w&&mt.height+2*yt===Rt.h?(Jt-nr)/2:(Jt-(mt.height+2*yt)*Ye.scale)/2,ee=new Xe(Q.x,Q.y-nn),Re=new Xe(Q.x+nr,Q.y),it=new Xe(Q.x+nr,Q.y-nn)}else{let vt=(mt.left-yt)*Ye.scale-at+qt[0],Ft=(-mt.top-yt)*Ye.scale+qt[1],cn=vt+nn,un=Ft+nr;Q=new Xe(vt,Ft),ee=new Xe(cn,Ft),Re=new Xe(vt,un),it=new Xe(cn,un)}if(Ue){let vt;vt=ye?new Xe(0,0):pn?new Xe(Ze[0],Ze[1]):new Xe(ue[0],ue[1]),Q._rotateAround(Ue,vt),ee._rotateAround(Ue,vt),Re._rotateAround(Ue,vt),it._rotateAround(Ue,vt)}let ct=new Xe(0,0),lt=new Xe(0,0);et.push({tl:Q,tr:ee,bl:Re,br:it,texPrimary:Et,texSecondary:void 0,writingMode:le.writingMode,glyphOffset:Bt,sectionIndex:Ye.sectionIndex,isSDF:$e,pixelOffsetTL:ct,pixelOffsetBR:lt,minFontScaleX:0,minFontScaleY:0})}}return et}(0,s,x,f,p,y,c,i.allowVerticalPlacement),q=i.textSizeData,K=null;q.kind==="source"?(K=[za*f.layout.get("text-size").evaluate(y,{},B)*O.textScaleFactor],K[0]>Fc&&fn(`${i.layerIds[0]}: Value for "text-size" is >= ${sg}. Reduce your "text-size".`)):q.kind==="composite"&&(K=[za*O.compositeTextSizes[0].evaluate(y,{},B)*O.textScaleFactor,za*O.compositeTextSizes[1].evaluate(y,{},B)*O.textScaleFactor],(K[0]>Fc||K[1]>Fc)&&fn(`${i.layerIds[0]}: Value for "text-size" is >= ${sg}. Reduce your "text-size".`)),i.addSymbols(i.text,X,K,x,p,y,I,e,n,w.lineStartIndex,w.lineLength,P,N,B,G,!1);for(let he of S)D[he]=i.text.placedSymbolArray.length-1;return 4*X.length}function K1(i){for(let e in i)return i[e];return null}function Ev(i,e,n,s,c,f,p,y,x,w){let I=p.top,S=p.bottom,D=p.left,P=p.right;if(CC(p)&&p.collisionPadding){let O=p.collisionPadding;D-=O[0],I-=O[1],P+=O[2],S+=O[3]}if(x){let O=new Xe(D,I),N=new Xe(P,I),B=new Xe(D,S),G=new Xe(P,S),X=Sn(x),q=new Xe(0,0);w&&(q=new Xe(w[0],w[1])),O._rotateAround(X,q),N._rotateAround(X,q),B._rotateAround(X,q),G._rotateAround(X,q),D=Math.min(O.x,N.x,B.x,G.x),P=Math.max(O.x,N.x,B.x,G.x),I=Math.min(O.y,N.y,B.y,G.y),S=Math.max(O.y,N.y,B.y,G.y)}return i.emplaceBack(e.x,e.y,e.z,n.x,n.y,D,I,P,S,y,s,c,f),i.length-1}function J1(i){CC(i)&&i.collisionPadding&&(i.top-=i.collisionPadding[1],i.bottom+=i.collisionPadding[3]);let e=i.bottom-i.top;return e>0?Math.max(10,e):null}function NN(i,e,n,s){let c=i.compareText;if(e in c){let f=c[e];for(let p=f.length-1;p>=0;p--)if(s.dist(f[p])<n)return!0}else c[e]=[];return c[e].push(s),!1}function JC(i,e){let n=i.fovAboveCenter,s=i.elevation?i.elevation.getMinElevationBelowMSL()*e:0,c=(i._camera.position[2]*i.worldSize-s)/Math.cos(i._pitch),f=Math.sin(n)*c/Math.sin(Math.max(Math.PI/2-i._pitch-n,.01)),p=Math.sin(i._pitch)*f+c,y=c*(1/i._horizonShift);if(!i.elevation||i.elevation.exaggeration()===0){let x=Math.max(i.zoom-17,0);i.isOrthographic&&(x/=10),p*=1+x}return Math.min(1.01*p,y)}function ag(i,e){if(!e.isReprojectedInTileSpace)return{scale:1<<i.z,x:i.x,y:i.y,x2:i.x+1,y2:i.y+1,projection:e};let n=Math.pow(2,-i.z),s=i.x*n,c=(i.x+1)*n,f=i.y*n,p=(i.y+1)*n,y=Z(s),x=Z(c),w=Y(f),I=Y(p),S=e.project(y,w),D=e.project(x,w),P=e.project(x,I),O=e.project(y,I),N=Math.min(S.x,D.x,P.x,O.x),B=Math.min(S.y,D.y,P.y,O.y),G=Math.max(S.x,D.x,P.x,O.x),X=Math.max(S.y,D.y,P.y,O.y),q=n/16;function K(le,ue,ge,ye,ke,be){let ze=(ge+ke)/2,et=(ye+be)/2,Ue=e.project(Z(ze),Y(et)),Ze=Math.max(0,N-Ue.x,B-Ue.y,Ue.x-G,Ue.y-X);N=Math.min(N,Ue.x),G=Math.max(G,Ue.x),B=Math.min(B,Ue.y),X=Math.max(X,Ue.y),Ze>q&&(K(le,Ue,ge,ye,ze,et),K(Ue,ue,ze,et,ke,be))}K(S,D,s,f,c,f),K(D,P,c,f,c,p),K(P,O,c,p,s,p),K(O,S,s,p,s,f),N-=q,B-=q,G+=q,X+=q;let he=1/Math.max(G-N,X-B);return{scale:he,x:N*he,y:B*he,x2:G*he,y2:X*he,projection:e}}function QC(i,{x:e,y:n},s=0){return new Xe(((e-s)*i.scale-i.x)*st,(n*i.scale-i.y)*st)}let zN=Oe(new Float32Array(16));class kc{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,n){return{x:0,y:0,z:0}}unproject(e,n){return new A(0,0)}projectTilePoint(e,n,s){return{x:e,y:n,z:0}}locationPoint(e,n,s,c=!0){return e._coordinatePoint(e.locationCoordinate(n,s),c)}pixelsPerMeter(e,n){return j(1,e)*n}pixelSpaceConversion(e,n,s){return 1}farthestPixelDistance(e){return JC(e,e.pixelsPerMeter)}pointCoordinate(e,n,s,c){let f=e.horizonLineFromTop(!1),p=new Xe(n,Math.max(f,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(p,c))}pointCoordinate3D(e,n,s){let c=new Xe(n,s);if(e.elevation)return e.elevation.pointCoordinate(c);{let f=this.pointCoordinate(e,c.x,c.y,0);return[f.x,f.y,f.z]}}isPointAboveHorizon(e,n){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,n.x,n.y);let s=e.horizonLineFromTop();return n.y<s}createInversionMatrix(e,n){return zN}createTileMatrix(e,n,s){let c,f,p,y=s.canonical,x=Oe(new Float64Array(16));if(this.isReprojectedInTileSpace){let w=ag(y,this);c=1,f=w.x+s.wrap*w.scale,p=w.y,Nt(x,x,[c/w.scale,c/w.scale,e.pixelsPerMeter/n])}else c=n/e.zoomScale(y.z),f=(y.x+Math.pow(2,y.z)*s.wrap)*c,p=y.y*c;return Ut(x,x,[f,p,0]),Nt(x,x,[c/st,c/st,1]),x}upVector(e,n,s){return[0,0,1]}upVectorScale(e,n,s){return{metersToTile:1}}}class BN extends kc{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];let[n,s]=this.parallels=e.parallels||[29.5,45.5],c=Math.sin(Sn(n));this.n=(c+Math.sin(Sn(s)))/2,this.c=1+c*(2*this.n-c),this.r0=Math.sqrt(this.c)/this.n}project(e,n){let{n:s,c,r0:f}=this,p=Sn(e-this.center[0]),y=Sn(n),x=Math.sqrt(c-2*s*Math.sin(y))/s;return{x:x*Math.sin(p*s),y:x*Math.cos(p*s)-f,z:0}}unproject(e,n){let{n:s,c,r0:f}=this,p=f+n,y=Math.atan2(e,Math.abs(p))*Math.sign(p);p*s<0&&(y-=Math.PI*Math.sign(e)*Math.sign(p));let x=Sn(this.center[0])*s;y=Me(y,-Math.PI-x,Math.PI-x);let w=ne(De(y/s)+this.center[0],-180,180),I=Math.asin(ne((c-(e*e+p*p)*s*s)/(2*s),-1,1)),S=ne(De(I),-re,re);return new A(w,S)}}let lg=1.340264,cg=-.081106,ug=893e-6,dg=.003796,Tv=Math.sqrt(3)/2;class VN extends kc{project(e,n){n=n/180*Math.PI,e=e/180*Math.PI;let s=Math.asin(Tv*Math.sin(n)),c=s*s,f=c*c*c;return{x:.5*(e*Math.cos(s)/(Tv*(lg+3*cg*c+f*(7*ug+9*dg*c)))/Math.PI+.5),y:1-.5*(s*(lg+cg*c+f*(ug+dg*c))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let s=n=(2*(1-n)-1)*Math.PI,c=s*s,f=c*c*c;for(let I,S,D,P=0;P<12&&(S=s*(lg+cg*c+f*(ug+dg*c))-n,D=lg+3*cg*c+f*(7*ug+9*dg*c),I=S/D,s=ne(s-I,-Math.PI/3,Math.PI/3),c=s*s,f=c*c*c,!(Math.abs(I)<1e-12));++P);let p=Tv*e*(lg+3*cg*c+f*(7*ug+9*dg*c))/Math.cos(s),y=Math.asin(Math.sin(s)/Tv),x=ne(180*p/Math.PI,-180,180),w=ne(180*y/Math.PI,-re,re);return new A(x,w)}}class UN extends kc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){return{x:.5+e/360,y:.5-n/360,z:0}}unproject(e,n){let s=360*(e-.5),c=ne(360*(.5-n),-re,re);return new A(s,c)}}let cf=Math.PI/2;function Iv(i){return Math.tan((cf+i)/2)}class jN extends kc{constructor(e){super(e),this.center=e.center||[0,30];let[n,s]=this.parallels=e.parallels||[30,30],c=Sn(n),f=Sn(s);this.southernCenter=c+f<0,this.southernCenter&&(c=-c,f=-f);let p=Math.cos(c),y=Iv(c);this.n=c===f?Math.sin(c):Math.log(p/Math.cos(f))/Math.log(Iv(f)/y),this.f=p*Math.pow(Iv(c),this.n)/this.n}project(e,n){n=Sn(n),this.southernCenter&&(n=-n),e=Sn(e-this.center[0]);let s=1e-6,{n:c,f}=this;f>0?n<-cf+s&&(n=-cf+s):n>cf-s&&(n=cf-s);let p=f/Math.pow(Iv(n),c),y=p*Math.sin(c*e),x=f-p*Math.cos(c*e);return y=.5*(y/Math.PI+.5),x=.5*(x/Math.PI+.5),{x:y,y:this.southernCenter?x:1-x,z:0}}unproject(e,n){e=(2*e-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;let{n:s,f:c}=this,f=c-n,p=Math.sign(f),y=Math.sign(s)*Math.sqrt(e*e+f*f),x=Math.atan2(e,Math.abs(f))*p;f*s<0&&(x-=Math.PI*Math.sign(e)*p);let w=ne(De(x/s)+this.center[0],-180,180),I=ne(De(2*Math.atan(Math.pow(c/y,1/s))-cf),-re,re);return new A(w,this.southernCenter?-I:I)}}class eA extends kc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,n){return{x:z(e),y:H(n),z:0}}unproject(e,n){let s=Z(e),c=Y(n);return new A(s,c)}}let tA=Sn(re);class HN extends kc{project(e,n){let s=(n=Sn(n))*n,c=s*s;return{x:.5*((e=Sn(e))*(.8707-.131979*s+c*(c*(.003971*s-.001529*c)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+s*(.015085+c*(.028874*s-.044475-.005916*c)))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let s=n=(2*(1-n)-1)*Math.PI,c=25,f=0,p=s*s;do{p=s*s;let w=p*p;f=(s*(1.007226+p*(.015085+w*(.028874*p-.044475-.005916*w)))-n)/(1.007226+p*(.045255+w*(.259866*p-.311325-.005916*11*w))),s=ne(s-f,-tA,tA)}while(Math.abs(f)>1e-6&&--c>0);p=s*s;let y=ne(De(e/(.8707+p*(p*(p*p*p*(.003971-.001529*p)-.013791)-.131979))),-180,180),x=De(s);return new A(y,x)}}let nA=Sn(re);class GN extends kc{project(e,n){n=Sn(n),e=Sn(e);let s=Math.cos(n),c=2/Math.PI,f=Math.acos(s*Math.cos(e/2)),p=Math.sin(f)/f,y=.5*(e*c+2*s*Math.sin(e/2)/p)||0,x=.5*(n+Math.sin(n)/p)||0;return{x:.5*(y/Math.PI+.5),y:1-.5*(x/Math.PI+1),z:0}}unproject(e,n){let s=e=(2*e-.5)*Math.PI,c=n=(2*(1-n)-1)*Math.PI,f=25,p=1e-6,y=0,x=0;do{let w=Math.cos(c),I=Math.sin(c),S=2*I*w,D=I*I,P=w*w,O=Math.cos(s/2),N=Math.sin(s/2),B=2*O*N,G=N*N,X=1-P*O*O,q=X?1/X:0,K=X?Math.acos(w*O)*Math.sqrt(1/X):0,he=.5*(2*K*w*N+2*s/Math.PI)-e,le=.5*(K*I+c)-n,ue=.5*q*(P*G+K*w*O*D)+1/Math.PI,ge=q*(B*S/4-K*I*N),ye=.125*q*(S*N-K*I*P*B),ke=.5*q*(D*O+K*G*w)+.5,be=ge*ye-ke*ue;y=(le*ge-he*ke)/be,x=(he*ye-le*ue)/be,s=ne(s-y,-Math.PI,Math.PI),c=ne(c-x,-nA,nA)}while((Math.abs(y)>p||Math.abs(x)>p)&&--f>0);return new A(De(s),De(c))}}class rA extends kc{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Sn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){let{scale:s,cosPhi:c}=this;return{x:Sn(e)*c*s+.5,y:-Math.sin(Sn(n))/c*s+.5,z:0}}unproject(e,n){let{scale:s,cosPhi:c}=this,f=-(n-.5)/s,p=ne(De((e-.5)/s)/c,-180,180),y=Math.asin(ne(f*c,-1,1)),x=ne(De(y),-re,re);return new A(p,x)}}class $N extends eA{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,n,s){let c=km(e,n,s);return Nr(c,c,Qy(ka(s))),{x:c[0],y:c[1],z:c[2]}}locationPoint(e,n,s){let c=E(n.lat,n.lng),f=cr([],c),p=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(n),e._centerAltitude):e._centerAltitude;zi(c,c,f,j(1,0)*st*p);let y=Oe(new Float64Array(16));return Vt(y,e.pixelMatrix,e.globeMatrix),Nr(c,c,y),new Xe(c[0],c[1])}pixelsPerMeter(e,n){return j(1,0)*n}pixelSpaceConversion(e,n,s){let c=j(1,e)*n,f=At(j(1,45)*n,c,s);return this.pixelsPerMeter(e,n)/f}createTileMatrix(e,n,s){let c=a1(ka(s.canonical));return Vt(new Float64Array(16),e.globeMatrix,c)}createInversionMatrix(e,n){let{center:s}=e,c=Qy(ka(n));return ci(c,c,Sn(s.lng)),li(c,c,Sn(s.lat)),Nt(c,c,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(c)}pointCoordinate(e,n,s,c){return CS(e,n,s,!0)||new se(0,0)}pointCoordinate3D(e,n,s){let c=this.pointCoordinate(e,n,s,0);return[c.x,c.y,c.z]}isPointAboveHorizon(e,n){return!CS(e,n.x,n.y,!1)}farthestPixelDistance(e){let n=function(c,f){let p=c.cameraToCenterDistance,y=c._centerAltitude*f,x=c._camera,w=c._camera.forward(),I=mr([],hr([],w,-p),[0,0,y]),S=c.worldSize/(2*Math.PI),D=[0,0,-S],P=c.width/c.height,O=Math.tan(c.fovAboveCenter),N=hr([],x.up(),O),B=hr([],x.right(),O*P),G=cr([],mr([],mr([],w,N),B)),X=[],q;if(new wn(I,G).closestPointOnSphere(D,S,X)){let K=mr([],X,D),he=zr([],K,I);q=Math.cos(c.fovAboveCenter)*Ei(he)}else{let K=zr([],I,D),he=zr([],D,I);cr(he,he);let le=Ei(K)-S;q=Math.sqrt(le*(le+2*S));let ue=Math.acos(q/(S+le))-Math.acos(kr(w,he));q*=Math.cos(ue)}return 1.01*q}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Mc(e.zoom);if(s>0){let c=JC(e,j(1,e.center.lat)*e.worldSize),f=e.worldSize/(2*Math.PI),p=Math.max(e.width,e.height)/e.worldSize*Math.PI;return At(n,c+f*(1-Math.cos(p)),Math.pow(s,10))}return n}upVector(e,n,s){return km(n,s,e,1)}upVectorScale(e){return{metersToTile:Yy(Jy(ka(e)))}}}function iA(i){let e=i.parallels,n=!!e&&Math.abs(e[0]+e[1])<.01;switch(i.name){case"mercator":return new eA(i);case"equirectangular":return new UN(i);case"naturalEarth":return new HN(i);case"equalEarth":return new VN(i);case"winkelTripel":return new GN(i);case"albers":return n?new rA(i):new BN(i);case"lambertConformalConic":return n?new rA(i):new jN(i);case"globe":return new $N(i)}throw new Error(`Invalid projection name: ${i.name}`)}let WN=Se.types,ZN=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Sv(i,e,n,s,c,f,p,y,x,w,I,S,D){let P=y?Math.min(Fc,Math.round(y[0])):0,O=y?Math.min(Fc,Math.round(y[1])):0;i.emplaceBack(e,n,Math.round(32*s),Math.round(32*c),f,p,(P<<1)+(x?1:0),O,16*w,16*I,256*S,256*D)}function Dv(i,e,n){i.emplaceBack(e,n)}function Cv(i,e,n,s,c,f,p){i.emplaceBack(e,n,s,c,f,p)}let Av=(i,e,n,s)=>{for(let c=0;c<e;c++)i.emplaceBack(n[0],n[1],n[2],s[0],s[1],s[2])};function Mv(i,e,n,s,c){i.emplaceBack(e,n,s,c),i.emplaceBack(e,n,s,c),i.emplaceBack(e,n,s,c),i.emplaceBack(e,n,s,c)}function qN(i){for(let e of i.sections)if(Wb(e.text))return!0;return!1}class Q1{constructor(e){this.layoutVertexArray=new Hh,this.indexArray=new dr,this.programConfigurations=e,this.segments=new _r,this.dynamicLayoutVertexArray=new Oa,this.opacityVertexArray=new vm,this.placedSymbolArray=new Ju,this.iconTransitioningVertexArray=new Ds,this.globeExtVertexArray=new bc,this.zOffsetVertexArray=new _l,this.orientationVertexArray=new wm}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,n,s,c,f){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Qk.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,tN.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,ZN,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,iN.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,eN.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||f)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,nN.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,rN.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||c)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}_t(Q1,"SymbolBuffers");class ew{constructor(e,n,s){this.layoutVertexArray=new e,this.layoutAttributes=n,this.indexArray=new s,this.segments=new _r,this.collisionVertexArray=new Ec,this.collisionVertexArrayExt=new Oa}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,oN.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,sN.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}_t(ew,"CollisionBuffers");class Rv{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(p=>p.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Oe([]),this.placementViewportMatrix=Oe([]);let n=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=OC(this.zoom,n["text-size"],this.worldview),this.iconSizeData=OC(this.zoom,n["icon-size"],this.worldview);let s=this.layers[0].layout,c=s.get("symbol-sort-key"),f=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=f!=="viewport-y"&&c.constantOr(1)!==void 0,this.sortFeaturesByY=(f==="viewport-y"||f==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(p=>Bo[p]),this.stateDependentLayerIds=this.layers.filter(p=>p.isStateDependent()).map(p=>p.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new Q1(new Oo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new Q1(new Oo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new Mm,this.lineVertexArray=new zy,this.symbolInstances=new Ny}calculateGlyphDependencies(e,n,s,c,f){for(let p of e){let y=p.codePointAt(0);if(y===void 0)break;if(n[y]=!0,c&&f&&y<=65535){let x=tg[p];x&&(n[x.charCodeAt(0)]=!0)}}}updateFootprints(e,n){}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let s=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!ov(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}populate(e,n,s,c){let f=this.layers[0],p=f.layout,y=this.projection.name==="globe",x=p.get("text-font"),w=p.get("text-field"),I=p.get("icon-image"),[S,D]=p.get("icon-size-scale-range"),P=ne(n.scaleFactor||1,S,D),O=(w.value.kind!=="constant"||w.value.value instanceof Bi&&!w.value.value.isEmpty()||w.value.value.toString().length>0)&&(x.value.kind!=="constant"||x.value.value.length>0),N=I.value.kind!=="constant"||!!I.value.value||Object.keys(I.parameters).length>0,B=p.get("symbol-sort-key");if(this.features=[],!O&&!N)return;let G=n.iconDependencies,X=n.glyphDependencies,q=n.availableImages,K=new jn(this.zoom,{worldview:this.worldview});for(let{feature:he,id:le,index:ue,sourceLayerIndex:ge}of e){let ye=f._featureFilter.needGeometry,ke=Pe(he,ye);if(!f._featureFilter.filter(K,ke,s))continue;if(ye||(ke.geometry=pe(he,s,c)),y&&he.type!==1&&s.z<=5){let Ze=ke.geometry,Je=.98078528056,Le=(qe,we)=>kr(km(qe.x,qe.y,s,1),km(we.x,we.y,s,1))<Je;for(let qe=0;qe<Ze.length;qe++)Ze[qe]=Ae(Ze[qe],Le)}let be,ze;if(O){let Ze=f.getValueAndResolveTokens("text-field",ke,s,q),Je=Bi.factory(Ze);qN(Je)&&(this.hasRTLText=!0),(!this.hasRTLText||hm()==="unavailable"||this.hasRTLText&&Is.isParsed())&&(be=lN(Je,f,ke))}if(N){let Ze=f.getValueAndResolveTokens("icon-image",ke,s,q);ze=typeof Ze=="string"?to.build(Ze):Ze}if(!be&&!ze)continue;let et=this.sortFeaturesByKey?B.evaluate(ke,{},s):void 0,Ue={id:le,text:be,icon:ze,index:ue,sourceLayerIndex:ge,geometry:ke.geometry,properties:he.properties,type:WN[he.type],sortKey:et};if(this.features.push(Ue),ze){let Ze=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Je,iconSecondary:Le}=qC(ze,this.iconSizeData,Ze["icon-size"],s,this.zoom,Ue,this.pixelRatio,P,this.worldview),qe=Je.id.toString();if(G.has(qe)?G.get(qe).push(Je):G.set(qe,[Je]),Le){this.hasAnySecondaryIcon=!0;let we=Le.id.toString();G.has(we)?G.get(we).push(Le):G.set(we,[Le])}}if(be){let Ze=x.evaluate(ke,{},s).join(","),Je=p.get("text-rotation-alignment")==="map"&&p.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Bo.vertical)>=0;for(let Le of be.sections)if(Le.image){let qe=Le.image.getPrimary().scaleSelf(this.pixelRatio),we=qe.id.toString(),Fe=G.get(we)||[];Fe.push(qe),G.set(we,Fe)}else{let qe=lm(be.toString()),we=Le.fontStack||Ze,Fe=X[we]=X[we]||{};this.calculateGlyphDependencies(Le.text,Fe,Je,this.allowVerticalPlacement,qe)}}}if(p.get("symbol-placement")==="line"&&(this.features=function(he){let le={},ue={},ge=[],ye=0;function ke(Ue){ge.push(he[Ue]),ye++}function be(Ue,Ze,Je){let Le=ue[Ue];return delete ue[Ue],ue[Ze]=Le,ge[Le].geometry[0].pop(),ge[Le].geometry[0]=ge[Le].geometry[0].concat(Je[0]),Le}function ze(Ue,Ze,Je){let Le=le[Ze];return delete le[Ze],le[Ue]=Le,ge[Le].geometry[0].shift(),ge[Le].geometry[0]=Je[0].concat(ge[Le].geometry[0]),Le}function et(Ue,Ze,Je){let Le=Je?Ze[0][Ze[0].length-1]:Ze[0][0];return`${Ue}:${Le.x}:${Le.y}`}for(let Ue=0;Ue<he.length;Ue++){let Ze=he[Ue],Je=Ze.geometry,Le=Ze.text?Ze.text.toString():null;if(!Le){ke(Ue);continue}let qe=et(Le,Je),we=et(Le,Je,!0);if(qe in ue&&we in le&&ue[qe]!==le[we]){let Fe=ze(qe,we,Je),rt=be(qe,we,ge[Fe].geometry);delete le[qe],delete ue[we],ue[et(Le,ge[rt].geometry,!0)]=rt,ge[Fe].geometry=null}else qe in ue?be(qe,we,Je):we in le?ze(qe,we,Je):(ke(Ue),le[qe]=ye-1,ue[we]=ye-1)}return ge.filter(Ue=>Ue.geometry)}(this.features)),p.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",n.elevationFeatures){!this.elevationFeatures&&n.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(let he of n.elevationFeatures)this.elevationFeatureIdToIndex.set(he.id,this.elevationFeatures.length),this.elevationFeatures.push(he)}}else p.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((he,le)=>he.sortKey-le.sortKey)}update(e,n,s,c,f,p,y){this.text.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,n,f,s,c,p,y,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let n=!1,s=oe(e),c=1/s,f=!1,p=!1;for(let y=0;y<this.symbolInstances.length;y++){let x=this.symbolInstances.get(y),w=Zr(1,0,0),I=Zr(0,1,0),{numHorizontalGlyphVertices:S,numVerticalGlyphVertices:D,numIconVertices:P,numVerticalIconVertices:O}=x,N=S>0||D>0,B=P>0,G=this.elevationFeatures[x.elevationFeatureIndex];if(G){let X=new Xe(x.tileAnchorX,x.tileAnchorY),q=.075+G.pointElevation(X);x.zOffset!==q&&(n=!0,x.zOffset=q);let K=G.computeSlopeNormal(X,c),he=Gl(Fs(),Zr(0,0,1),K);da(w,w,he),da(I,I,he),w[2]*=s,I[2]*=s,w[0]===1&&w[1]===0&&w[2]===0&&I[0]===0&&I[1]===1&&I[2]===0||(f=f||N,p=p||B)}if(N&&(Av(this.text.orientationVertexArray,S,w,I),Av(this.text.orientationVertexArray,D,w,I)),B){let{placedIconSymbolIndex:X,verticalPlacedIconSymbolIndex:q}=x;X>=0&&Av(this.icon.orientationVertexArray,P,w,I),q>=0&&Av(this.icon.orientationVertexArray,O,w,I)}}f||(this.text.orientationVertexArray=void 0),p||(this.icon.orientationVertexArray=void 0),n&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let e=(f,p,y)=>{s+=p,s>f.length&&f.resize(s);for(let x=-p;x<0;x++)f.emplace(x+s,y)},n=(f,p,y)=>{c+=p,c>f.length&&f.resize(c);for(let x=-p;x<0;x++)f.emplace(x+c,y)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,c=0;for(let f=0;f<this.symbolInstances.length;f++){let p=this.symbolInstances.get(f),{numHorizontalGlyphVertices:y,numVerticalGlyphVertices:x,numIconVertices:w}=p,I=p.zOffset,S=w>0;if((y>0||x>0)&&(e(this.text.zOffsetVertexArray,y,I),e(this.text.zOffsetVertexArray,x,I)),S){let{placedIconSymbolIndex:D,verticalPlacedIconSymbolIndex:P}=p;D>=0&&n(this.icon.zOffsetVertexArray,w,I),P>=0&&n(this.icon.zOffsetVertexArray,p.numVerticalIconVertices,I)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=iA(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,n){let s=this.lineVertexArray.length;if(e.segment!==void 0)for(let{x:c,y:f}of n)this.lineVertexArray.emplaceBack(c,f);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,n,s,c,f,p,y,x,w,I,S,D,P,O,N,B){let G=e.indexArray,X=e.layoutVertexArray,q=e.globeExtVertexArray,K=e.segments.prepareSegment(4*n.length,X,G,this.canOverlap?p.sortKey:void 0),he=this.glyphOffsetArray.length,le=K.vertexLength,ue=this.allowVerticalPlacement&&y===Bo.vertical?Math.PI/2:0,ge=p.text&&p.text.sections;for(let ke=0;ke<n.length;ke++){let{tl:be,tr:ze,bl:et,br:Ue,texPrimary:Ze,texSecondary:Je,pixelOffsetTL:Le,pixelOffsetBR:qe,minFontScaleX:we,minFontScaleY:Fe,glyphOffset:rt,isSDF:Ye,sectionIndex:Et}=n[ke],yt=K.vertexLength,$e=rt[1];if(Sv(X,w.x,w.y,be.x,$e+be.y,Ze.x,Ze.y,s,Ye,Le.x,Le.y,we,Fe),Sv(X,w.x,w.y,ze.x,$e+ze.y,Ze.x+Ze.w,Ze.y,s,Ye,qe.x,Le.y,we,Fe),Sv(X,w.x,w.y,et.x,$e+et.y,Ze.x,Ze.y+Ze.h,s,Ye,Le.x,qe.y,we,Fe),Sv(X,w.x,w.y,Ue.x,$e+Ue.y,Ze.x+Ze.w,Ze.y+Ze.h,s,Ye,qe.x,qe.y,we,Fe),x){let{x:Ke,y:xt,z:pt}=x.anchor,[at,mt,Rt]=x.up;Cv(q,Ke,xt,pt,at,mt,Rt),Cv(q,Ke,xt,pt,at,mt,Rt),Cv(q,Ke,xt,pt,at,mt,Rt),Cv(q,Ke,xt,pt,at,mt,Rt),Mv(e.dynamicLayoutVertexArray,Ke,xt,pt,ue)}else Mv(e.dynamicLayoutVertexArray,w.x,w.y,w.z,ue);if(B){let Ke=Je||Ze;Dv(e.iconTransitioningVertexArray,Ke.x,Ke.y),Dv(e.iconTransitioningVertexArray,Ke.x+Ke.w,Ke.y),Dv(e.iconTransitioningVertexArray,Ke.x,Ke.y+Ke.h),Dv(e.iconTransitioningVertexArray,Ke.x+Ke.w,Ke.y+Ke.h)}G.emplaceBack(yt,yt+1,yt+2),G.emplaceBack(yt+1,yt+2,yt+3),K.vertexLength+=4,K.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(rt[0]),ke!==n.length-1&&Et===n[ke+1].sectionIndex||e.programConfigurations.populatePaintArrays(X.length,p,p.index,{},P,O,N,ge&&ge[Et],this.worldview)}let ye=x?x.anchor:w;e.placedSymbolArray.emplaceBack(ye.x,ye.y,ye.z,w.x,w.y,he,this.glyphOffsetArray.length-he,le,I,S,w.segment,s?s[0]:0,s?s[1]:0,c[0],c[1],y,0,0,0,D,0)}_commitLayoutVertex(e,n,s,c,f,p,y){e.emplaceBack(n,s,c,f,p,Math.round(y.x),Math.round(y.y))}_addCollisionDebugVertices(e,n,s,c,f,p,y){let x=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),w=x.vertexLength,I=y.tileAnchorX,S=y.tileAnchorY;for(let P=0;P<4;P++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,n,e.padding,y.zOffset),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,c,f,p,I,S,new Xe(e.x1,e.y2)),x.vertexLength+=4;let D=s.indexArray;D.emplaceBack(w,w+1),D.emplaceBack(w+1,w+2),D.emplaceBack(w+2,w+3),D.emplaceBack(w+3,w),x.primitiveLength+=4}_addTextDebugCollisionBoxes(e,n,s,c,f,p){for(let y=c;y<f;y++){let x=s.get(y),w=this.getSymbolInstanceTextSize(e,p,n,y);this._addCollisionDebugVertices(x,w,this.textCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,p)}}_addIconDebugCollisionBoxes(e,n,s,c,f,p){for(let y=c;y<f;y++){let x=s.get(y),w=this.getSymbolInstanceIconSize(e,n,p.placedIconSymbolIndex);this._addCollisionDebugVertices(x,w,this.iconCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,p)}}generateCollisionDebugBuffers(e,n,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new ew(Gh,yC.members,Ds),this.iconCollisionBox=new ew(Gh,yC.members,Ds);let c=rg(this.iconSizeData,e),f=rg(this.textSizeData,e,s);for(let p=0;p<this.symbolInstances.length;p++){let y=this.symbolInstances.get(p);this._addTextDebugCollisionBoxes(f,e,n,y.textBoxStartIndex,y.textBoxEndIndex,y),this._addTextDebugCollisionBoxes(f,e,n,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y),this._addIconDebugCollisionBoxes(c,e,n,y.iconBoxStartIndex,y.iconBoxEndIndex,y),this._addIconDebugCollisionBoxes(c,e,n,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y)}}getSymbolInstanceTextSize(e,n,s,c){let f=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:c),p=W1(this.textSizeData,e,f)/gi;return this.tilePixelRatio*p}getSymbolInstanceIconSize(e,n,s){let c=this.icon.placedSymbolArray.get(s),f=W1(this.iconSizeData,e,c);return this.tilePixelRatio*f}_commitDebugCollisionVertexUpdate(e,n,s,c){e.emplaceBack(n,-s,-s,c),e.emplaceBack(n,s,-s,c),e.emplaceBack(n,s,s,c),e.emplaceBack(n,-s,s,c)}_updateTextDebugCollisionBoxes(e,n,s,c,f,p,y){for(let x=c;x<f;x++){let w=s.get(x),I=this.getSymbolInstanceTextSize(e,p,n,x);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,w.padding,p.zOffset)}}_updateIconDebugCollisionBoxes(e,n,s,c,f,p,y){for(let x=c;x<f;x++){let w=s.get(x),I=this.getSymbolInstanceIconSize(e,n,p.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,w.padding,p.zOffset)}}updateCollisionDebugBuffers(e,n,s,c){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let f=rg(this.iconSizeData,e,c),p=rg(this.textSizeData,e,s);for(let y=0;y<this.symbolInstances.length;y++){let x=this.symbolInstances.get(y);this._updateTextDebugCollisionBoxes(p,e,n,x.textBoxStartIndex,x.textBoxEndIndex,x,s),this._updateTextDebugCollisionBoxes(p,e,n,x.verticalTextBoxStartIndex,x.verticalTextBoxEndIndex,x,s),this._updateIconDebugCollisionBoxes(f,e,n,x.iconBoxStartIndex,x.iconBoxEndIndex,x,c),this._updateIconDebugCollisionBoxes(f,e,n,x.verticalIconBoxStartIndex,x.verticalIconBoxEndIndex,x,c)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,n,s,c,f,p,y,x,w){let I={};if(n<s){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K,featureIndex:he}=e.get(n);I.textBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K},I.textFeatureIndex=he}if(c<f){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K,featureIndex:he}=e.get(c);I.verticalTextBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K},I.verticalTextFeatureIndex=he}if(p<y){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K,featureIndex:he}=e.get(p);I.iconBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K},I.iconFeatureIndex=he}if(x<w){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K,featureIndex:he}=e.get(x);I.verticalIconBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:q,tileAnchorY:K},I.verticalIconFeatureIndex=he}return I}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){let s=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,n){let s=e.placedSymbolArray.get(n),c=s.vertexStartIndex+4*s.numGlyphs;for(let f=s.vertexStartIndex;f<c;f+=4)e.indexArray.emplaceBack(f,f+1,f+2),e.indexArray.emplaceBack(f+1,f+2,f+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let n=Math.sin(e),s=Math.cos(e),c=[],f=[],p=[];for(let y=0;y<this.symbolInstances.length;++y){p.push(y);let x=this.symbolInstances.get(y);c.push(0|Math.round(n*x.tileAnchorX+s*x.tileAnchorY)),f.push(x.featureIndex)}return p.sort((y,x)=>c[y]-c[x]||f[x]-f[y]),p}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,n){let s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===n?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let n of this.symbolInstanceIndexes){let s=this.symbolInstances.get(n);this.featureSortOrder.push(s.featureIndex);let{rightJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:f,leftJustifiedTextSymbolIndex:p,verticalPlacedTextSymbolIndex:y,placedIconSymbolIndex:x,verticalPlacedIconSymbolIndex:w}=s;c>=0&&this.addIndicesForPlacedSymbol(this.text,c),f>=0&&f!==c&&this.addIndicesForPlacedSymbol(this.text,f),p>=0&&p!==f&&p!==c&&this.addIndicesForPlacedSymbol(this.text,p),y>=0&&this.addIndicesForPlacedSymbol(this.text,y),x>=0&&this.addIndicesForPlacedSymbol(this.icon,x),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let oA,sA,tw;_t(Rv,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Rv.addDynamicAttributes=Mv;class aA{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Ql,this.defaultValue=e}evaluate(e){if(e.formattedSection){let n=this.defaultValue.property.overrides;if(n&&n.hasOverride(e.formattedSection))return n.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}_t(aA,"FormatSectionOverride",{omit:["defaultValue"]});let nw=()=>tw||(tw={layout:oA||(oA=new Mr({"symbol-placement":new tt(xe.layout_symbol["symbol-placement"]),"symbol-spacing":new tt(xe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new tt(xe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new dt(xe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new tt(xe.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new tt(xe.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new tt(xe.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new tt(xe.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new tt(xe.layout_symbol["icon-ignore-placement"]),"icon-optional":new tt(xe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new tt(xe.layout_symbol["icon-rotation-alignment"]),"icon-size":new dt(xe.layout_symbol["icon-size"]),"icon-size-scale-range":new tt(xe.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new dt(xe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new dt(xe.layout_symbol["icon-text-fit-padding"]),"icon-image":new dt(xe.layout_symbol["icon-image"]),"icon-rotate":new dt(xe.layout_symbol["icon-rotate"]),"icon-padding":new tt(xe.layout_symbol["icon-padding"]),"icon-keep-upright":new tt(xe.layout_symbol["icon-keep-upright"]),"icon-offset":new dt(xe.layout_symbol["icon-offset"]),"icon-anchor":new dt(xe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new tt(xe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new tt(xe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new tt(xe.layout_symbol["text-rotation-alignment"]),"text-field":new dt(xe.layout_symbol["text-field"]),"text-font":new dt(xe.layout_symbol["text-font"]),"text-size":new dt(xe.layout_symbol["text-size"]),"text-size-scale-range":new tt(xe.layout_symbol["text-size-scale-range"]),"text-max-width":new dt(xe.layout_symbol["text-max-width"]),"text-line-height":new dt(xe.layout_symbol["text-line-height"]),"text-letter-spacing":new dt(xe.layout_symbol["text-letter-spacing"]),"text-justify":new dt(xe.layout_symbol["text-justify"]),"text-radial-offset":new dt(xe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new tt(xe.layout_symbol["text-variable-anchor"]),"text-anchor":new dt(xe.layout_symbol["text-anchor"]),"text-max-angle":new tt(xe.layout_symbol["text-max-angle"]),"text-writing-mode":new tt(xe.layout_symbol["text-writing-mode"]),"text-rotate":new dt(xe.layout_symbol["text-rotate"]),"text-padding":new tt(xe.layout_symbol["text-padding"]),"text-keep-upright":new tt(xe.layout_symbol["text-keep-upright"]),"text-transform":new dt(xe.layout_symbol["text-transform"]),"text-offset":new dt(xe.layout_symbol["text-offset"]),"text-allow-overlap":new tt(xe.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new tt(xe.layout_symbol["text-ignore-placement"]),"text-optional":new tt(xe.layout_symbol["text-optional"]),visibility:new tt(xe.layout_symbol.visibility)})),paint:sA||(sA=new Mr({"icon-opacity":new dt(xe.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new dt(xe.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new dt(xe.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new dt(xe.paint_symbol["text-emissive-strength"]),"icon-color":new dt(xe.paint_symbol["icon-color"]),"icon-halo-color":new dt(xe.paint_symbol["icon-halo-color"]),"icon-halo-width":new dt(xe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new dt(xe.paint_symbol["icon-halo-blur"]),"icon-translate":new tt(xe.paint_symbol["icon-translate"]),"icon-translate-anchor":new tt(xe.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new tt(xe.paint_symbol["icon-image-cross-fade"]),"text-opacity":new dt(xe.paint_symbol["text-opacity"]),"text-occlusion-opacity":new dt(xe.paint_symbol["text-occlusion-opacity"]),"text-color":new dt(xe.paint_symbol["text-color"],{runtimeType:po,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new dt(xe.paint_symbol["text-halo-color"]),"text-halo-width":new dt(xe.paint_symbol["text-halo-width"]),"text-halo-blur":new dt(xe.paint_symbol["text-halo-blur"]),"text-translate":new tt(xe.paint_symbol["text-translate"]),"text-translate-anchor":new tt(xe.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new tt(xe.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new tt(xe.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new tt(xe.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new tt(xe.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new dt(xe.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},tw);class Pv extends Li{constructor(e,n,s,c){super(e,nw(),n,s,c),this._colorAdjustmentMatrix=Oe([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,n){super.recalculate(e,n),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let s=this.layout.get("text-writing-mode");if(s){let c=[];for(let f of s)c.indexOf(f)<0&&c.push(f);this.layout._values["text-writing-mode"]=c}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,n,s,c){return this._saturation===e&&this._contrast===n&&this._brightnessMin===s&&this._brightnessMax===c||(this._colorAdjustmentMatrix=function(f,p,y,x){f=Ri(f),p=Qi(p);let w=ht(),I=f/3,S=1-2*I,D=[S,I,I,0,I,S,I,0,I,I,S,0,0,0,0,1],P=.5-.5*p,O=x-y;return Vt(w,[O,0,0,0,0,O,0,0,0,0,O,0,y,y,y,1],[p,0,0,0,0,p,0,0,0,0,p,0,P,P,P,1]),Vt(w,w,D),w}(e,n,s,c),this._saturation=e,this._contrast=n,this._brightnessMin=s,this._brightnessMax=c),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,n,s,c){let f=this.layout.get(e).evaluate(n,{},s,c),p=this._unevaluatedLayout._values[e];return p.isDataDriven()||im(p.value)||!f?f:function(y,x){return x.replace(/{([^{}]+)}/g,(w,I)=>I in y?String(y[I]):"")}(n.properties,f)}createBucket(e){return new Rv(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let e of nw().paint.overridableProperties){if(!Pv.hasPaintOverride(this.layout,e))continue;let n=this.paint.get(e),s=new aA(n),c=new rm(s,n.property.specification,this.scope,this.options),f=null;f=n.value.kind==="constant"||n.value.kind==="source"?new Rh("source",c):new Ca("composite",c,n.value.zoomStops,n.value.interpolationType),this.paint._values[e]=new gl(n.property,f,n.parameters)}}_handleOverridablePaintPropertyUpdate(e,n,s){return!(!this.layout||n.isDataDriven()||s.isDataDriven())&&Pv.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,n){let s=e.get("text-field"),c=nw().paint.properties[n],f=!1,p=y=>{for(let x of y)if(c.overrides&&c.overrides.hasOverride(x))return void(f=!0)};if(s.value.kind==="constant"&&s.value.value instanceof Bi)p(s.value.value.sections);else if(s.value.kind==="source"){let y=w=>{f||(w instanceof Lt&&gt(w.value)===Au?p(w.value.sections):w instanceof tc?p(w.sections):w.eachChild(y))},x=s.value;x._styleExpression&&y(x._styleExpression.expression)}return f}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,n,s){return{config:new ji(this,{zoom:n,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let lA,cA,uA,dA;var rw=gn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Ov(i,e,n,s,c,f,p,y){let x=[i,e,1,n,s,1,c,f,1],w=[p,y,1],I=Ee([],x),[S,D,P]=ua(w,w,I);return Be(x,x,[S,0,0,0,D,0,0,0,P])}function hA(i,e,n,s,c,f,p,y){let x=function(w,I,S,D,P,O,N,B){let G=Ov(0,0,1,0,1,1,0,1),X=Ov(w,I,S,D,P,O,N,B);return Be(X,X,Ee([],G))}(i,e,n,s,c,f,p,y);return[x[2]/x[8]/st,x[5]/x[8]/st]}function Lv(i){return[i[0],Math.min(Math.max(i[1],-re),re)]}class fA extends ol{constructor(e,n,s,c){super(),this.id=e,this.dispatcher=s,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(c),this.options=n,this._dirty=!1}load(e,n){if(this._loaded=n||!1,this.fire(new js("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Iu(this.map._requestManager.transformRequest(this.url,wu.Image),(s,c)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new Co(s)):c&&(this.image=c instanceof HTMLImageElement?cs.getImageData(c):c,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Jm(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new js("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Jm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=e[0][1],s=e[0][1];for(let f of e)f[1]>s&&(s=f[1]),f[1]<n&&(n=f[1]);let c=(s+n)/2;if(c>re?this.onNorthPole=!0:c<-re&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let f=e.map(se.fromLngLat);this.tileID=function(p){let y=1/0,x=1/0,w=-1/0,I=-1/0;for(let N of p)y=Math.min(y,N.x),x=Math.min(x,N.y),w=Math.max(w,N.x),I=Math.max(I,N.y);let S=Math.max(w-y,I-x),D=Math.max(0,Math.floor(-Math.log(S)/Math.LN2)),P=Math.pow(2,D),O=Math.floor((y+w)/2*P);return O>1&&(O-=1),new ko(D,O,Math.floor((x+I)/2*P))}(f),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new js("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Jm||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(let G in this.tiles){let X=this.tiles[G];X.state!=="loaded"&&(X.state="loaded",X.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let n=ag(new ko(0,0,0),this.map.transform.projection),s=[n.projection.project(this.coordinates[0][0],this.coordinates[0][1]),n.projection.project(this.coordinates[1][0],this.coordinates[1][1]),n.projection.project(this.coordinates[2][0],this.coordinates[2][1]),n.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(G){let X=G[1].x-G[0].x,q=G[1].y-G[0].y,K=G[2].x-G[1].x,he=G[2].y-G[1].y,le=G[3].x-G[2].x,ue=G[3].y-G[2].y,ge=G[0].x-G[3].x,ye=G[0].y-G[3].y,ke=X*he-K*q,be=K*ue-le*he,ze=le*ye-ge*ue,et=ge*q-X*ye;return ke>0&&be>0&&ze>0&&et>0||ke<0&&be<0&&ze<0&&et<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let c=ag(this.tileID,this.map.transform.projection),[f,p,y,x]=this.coordinates.map(G=>{let X=c.projection.project(G[0],G[1]);return QC(c,X)._round()});this.perspectiveTransform=hA(f.x,f.y,p.x,p.y,y.x,y.y,x.x,x.y);let w=this._boundsArray=new vc;w.emplaceBack(f.x,f.y,0,0),w.emplaceBack(p.x,p.y,st,0),w.emplaceBack(x.x,x.y,0,st),w.emplaceBack(y.x,y.y,st,st),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(w,rw.members),this.boundsSegments=_r.simpleSegment(0,0,4,2);let I=[],S=[Lv((D=this.coordinates)[0]),Lv(D[1]),Lv(D[2]),Lv(D[3])];var D;let[P,O,N,B]=function(G){let X=G[0][0],q=X,K=G[0][1],he=K;for(let le=1;le<G.length;le++)G[le][0]<X?X=G[le][0]:G[le][0]>q&&(q=G[le][0]),G[le][1]<K?K=G[le][1]:G[le][1]>he&&(he=G[le][1]);return[X,K,q-X,he-K]}(S);{let G=new vc,[X,q,K,he]=function(Le){let qe=Le[0].x,we=qe,Fe=Le[0].y,rt=Fe;for(let Ye=1;Ye<Le.length;Ye++)Le[Ye].x<qe?qe=Le[Ye].x:Le[Ye].x>we&&(we=Le[Ye].x),Le[Ye].y<Fe?Fe=Le[Ye].y:Le[Ye].y>rt&&(rt=Le[Ye].y);return[qe,Fe,we-qe,rt-Fe]}(s),le=Le=>[(Le.x-X)/K,(Le.y-q)/he],[ue,ge,ye,ke]=s.map(le),be=function(Le,qe,we,Fe,rt,Ye,Et,yt){let $e=Ov(0,0,1,0,1,1,0,1);return Be($e,$e,Ee([],Ov(Le,qe,we,Fe,rt,Ye,Et,yt)))}(ue[0],ue[1],ge[0],ge[1],ye[0],ye[1],ke[0],ke[1]);this.elevatedGlobePerspectiveTransform=hA(ue[0],ue[1],ge[0],ge[1],ye[0],ye[1],ke[0],ke[1]);let ze=(Le,qe)=>{I.push(Le.lng);let we=Math.round((Le.lng-P)/N*st),Fe=Math.round((Le.lat-O)/B*st),rt=le(qe),Ye=ua([],[rt[0],rt[1],1],be),Et=Math.round(Ye[0]/Ye[2]*st),yt=Math.round(Ye[1]/Ye[2]*st);G.emplaceBack(we,Fe,Et,yt)},et=s[3].x-s[0].x,Ue=s[3].y-s[0].y,Ze=s[2].x-s[1].x,Je=s[2].y-s[1].y;for(let Le=0;Le<65;Le++){let qe=Le/64,we=[s[0].x+qe*et,s[0].y+qe*Ue],Fe=[s[1].x+qe*Ze,s[1].y+qe*Je],rt=Fe[0]-we[0],Ye=Fe[1]-we[1];for(let Et=0;Et<65;Et++){let yt=Et/64,$e={x:we[0]+rt*yt,y:we[1]+Ye*yt};ze(n.projection.unproject($e.x,$e.y),$e)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(G,rw.members)}{this.maxLongitudeTriangleSize=0;let G=[],X=new dr,q=(K,he,le)=>{X.emplaceBack(K,he,le);let ue=I[K],ge=I[he],ye=I[le],ke=Math.min(Math.min(ue,ge),ye),be=Math.max(Math.max(ue,ge),ye)-ke;be>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=be),G.push(ke+be/2)};for(let K=0;K<64;K++)for(let he=0;he<64;he++){let le=65*K+he,ue=le+1,ge=le+65,ye=ge+1;q(le,ge,ue),q(ue,ge,ye)}[G,X]=function(K,he){let le=Array.from({length:K.length},(ye,ke)=>ke);le.sort((ye,ke)=>K[ye]-K[ke]);let ue=[],ge=new dr;for(let ye=0;ye<le.length;ye++){let ke=le[ye];ue.push(K[ke]);let be=3*ke,ze=be+1;ge.emplaceBack(he.uint16[be],he.uint16[ze],he.uint16[ze+1])}return[ue,ge]}(G,X),this.elevatedGlobeTrianglesCenterLongitudes=G,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(X)}this.elevatedGlobeSegments=_r.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,N/st,0,B/st,0,0,O,P,0])}prepare(){let e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;let n=this.map.painter.context,s=n.gl;!this._dirty||this.texture instanceof Jm||(this.texture?this.texture.update(this.image):(this.texture=new P1(n,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(n)}loadTile(e,n){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},n(null)):(e.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){let n=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!n)return null;let s=this.elevatedGlobeTrianglesCenterLongitudes,c=(f=e+180)+360*Math.round((s[0]-f)/360);var f;let p=new _r,y=(S,D)=>{p.segments.push({vertexOffset:0,primitiveOffset:S,vertexLength:n.segments[0].vertexLength,primitiveLength:D,sortKey:void 0,vaos:{}})},x=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-c)<=x){let S=hi(s,0,s.length,c+x);return S===s.length||y(S,gr(s,S+1,s.length,c+360-x)-S),p}c<s[0]&&(c+=360);let w=gr(s,0,s.length,c-x);if(w===s.length)return y(0,s.length),p;y(0,w-0);let I=hi(s,w+1,s.length,c+x);return I!==s.length&&y(I,s.length-I),p}}let XN=(Math.pow(256,2)-1)/16907520;class pA extends Li{constructor(e,n,s,c){super(e,{layout:uA||(uA=new Mr({visibility:new tt(xe.layout_raster.visibility)})),paint:dA||(dA=new Mr({"raster-opacity":new tt(xe.paint_raster["raster-opacity"]),"raster-color":new pc(xe.paint_raster["raster-color"]),"raster-color-mix":new tt(xe.paint_raster["raster-color-mix"]),"raster-color-range":new tt(xe.paint_raster["raster-color-range"]),"raster-hue-rotate":new tt(xe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new tt(xe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new tt(xe.paint_raster["raster-brightness-max"]),"raster-saturation":new tt(xe.paint_raster["raster-saturation"]),"raster-contrast":new tt(xe.paint_raster["raster-contrast"]),"raster-resampling":new tt(xe.paint_raster["raster-resampling"]),"raster-fade-duration":new tt(xe.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new tt(xe.paint_raster["raster-emissive-strength"]),"raster-array-band":new tt(xe.paint_raster["raster-array-band"]),"raster-elevation":new tt(xe.paint_raster["raster-elevation"]),"raster-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},n,s,c),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof fA&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;let n=this._transitionablePaint._values["raster-color"].value.expression,[s,c]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(c)||s===this._curRampRange[0]&&c===this._curRampRange[1]||(this.colorRamp=Nm({expression:n,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:c}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,c])}}let mA,gA,_A,yA,vA;class xA extends Li{constructor(e,n,s,c){super(e,{layout:mA||(mA=new Mr({visibility:new tt(xe["layout_raster-particle"].visibility)})),paint:gA||(gA=new Mr({"raster-particle-array-band":new tt(xe["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new tt(xe["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new pc(xe["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new tt(xe["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new tt(xe["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new tt(xe["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new tt(xe["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new tt(xe["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},n,s,c),this._updateColorRamp(),this.lastInvalidatedAt=cs.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let e=this._transitionablePaint._values["raster-particle-color"].value.expression,n=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Nm({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:n}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=cs.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class YN extends Li{constructor(e,n){super(e,{},n,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function iw(i,e,n){let s=[0,0,1],c=ks([]);return Hl(c,c,n?-Sn(i)+Math.PI:Sn(i)),Qa(c,c,-Sn(e)),da(s,s,c),cr(s,s)}let bA={None:0,Model:1,Symbol:2,FillExtrusion:4};class Fv{constructor(e,n,s,c){this.message=(e?`${e}: `:"")+s,c&&(this.identifier=c),n!=null&&n.__line__&&(this.line=n.__line__)}}function ow(i,e){let n=i.indexOf("://")===-1;try{return new URL(i,n&&e?"http://example.com":void 0),!0}catch{return!1}}class wA{constructor(e,n){this.feature=e,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class EA{constructor(){this.instancedDataArray=new $h,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class sw{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,n){}populate(e,n,s,c){this.tileToMeter=oe(s);let f=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:p,id:y,index:x,sourceLayerIndex:w}of e){let I=y??(p.properties&&p.properties.hasOwnProperty("id")?p.properties.id:void 0),S=Pe(p,f);if(!this.layers[0]._featureFilter.filter(new jn(this.zoom,{worldview:this.worldview}),S,s))continue;let D={id:I,sourceLayerIndex:w,index:x,geometry:f?S.geometry:pe(p,s,c),properties:p.properties,type:p.type,patterns:{}},P=this.addFeature(D,D.geometry,S);P&&n.featureIndex.insert(p,D.geometry,x,w,this.index,this.instancesPerModel[P].instancedDataArray.length,st/32)}this.lookup=null}update(e,n,s,c){for(let f in this.instancesPerModel){let p=this.instancesPerModel[f];for(let y in e)p.idToFeaturesIndex.hasOwnProperty(y)&&(this.evaluate(p.features[p.idToFeaturesIndex[y]],e[y],p,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];for(let c of s.features){let f=this.layers[0],p=c.feature,y=this.canonical,x=f.paint.get("model-rotation").evaluate(p,{},y),w=f.paint.get("model-scale").evaluate(p,{},y),I=f.paint.get("model-translation").evaluate(p,{},y);qo(c.rotation,x)&&qo(c.scale,w)&&qo(c.translation,I)||(this.evaluate(c,c.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,n,s,c){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let f=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(ov(this.activeReplacements,f))return!1;this.activeReplacements=f;let p=!1;for(let y in this.instancesPerModel){let x=this.instancesPerModel[y],w=x.instancedDataArray;for(let I of x.features){let S=I.instancedDataOffset,D=I.instancedDataCount;for(let P=0;P<D;P++){let O=16*(P+S),N=w.float32[O+0],B=N>st;N=B?N-st:N;let G=Math.floor(N),X=w.float32[O+1],q=!1;for(let K of this.activeReplacements)if(!uD(K,s,bA.Model,c)&&!(K.min.x>G||G>K.max.x||K.min.y>X||X>K.max.y)&&(q=x1(pD(G,X,e.canonical,K.footprintTileId.canonical),K.footprint),q))break;w.float32[O]=q?N+st:N,p=p||q!==B}}}return p}isEmpty(){for(let e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,Ak.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}let e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(let n of this.modelUris)e.removeModel(n,"",!0)}addFeature(e,n,s){let c=this.layers[0],f=c.layout.get("model-id").evaluate(s,{},this.canonical);if(!f)return fn(`modelId is not evaluated for layer ${c.id} and it is not going to get rendered.`),f;(ow(f,!1)||this.styleDefinedModelURLs[f]!==void 0)&&(this.modelUris.includes(f)||this.modelUris.push(f)),this.instancesPerModel[f]||(this.instancesPerModel[f]=new EA);let p=this.instancesPerModel[f],y=p.instancedDataArray,x=new wA(s,y.length);for(let w of n)for(let I of w){if(I.x<0||I.x>=st||I.y<0||I.y>=st)continue;let S=(this.lookupDim-1)/st,D=this.lookupDim*(I.y*S|0)+I.x*S|0;if(this.lookup){if(this.lookup[D]!==0)continue;this.lookup[D]=1}this.instanceCount++;let P=y.length;y.resize(P+1),p.instancesEvaluatedElevation.push(0),y.float32[16*P]=I.x,y.float32[16*P+1]=I.y}return x.instancedDataCount=p.instancedDataArray.length-x.instancedDataOffset,x.instancedDataCount>0&&(e.id&&(p.idToFeaturesIndex[e.id]=p.features.length),p.features.push(x),this.evaluate(x,{},p,!1)),f}getModelUris(){return this.modelUris}evaluate(e,n,s,c){let f=this.layers[0],p=e.feature,y=this.canonical,x=e.rotation=f.paint.get("model-rotation").evaluate(p,n,y),w=e.scale=f.paint.get("model-scale").evaluate(p,n,y),I=e.translation=f.paint.get("model-translation").evaluate(p,n,y),S=f.paint.get("model-color").evaluate(p,n,y);S.a=f.paint.get("model-color-mix-intensity").evaluate(p,n,y);let D=[];this.maxVerticalOffset<I[2]&&(this.maxVerticalOffset=I[2]),this.maxScale=Math.max(Math.max(this.maxScale,w[0]),Math.max(w[1],w[2])),XD(D,x,w);let P=Math.round(100*S.a)+S.b/1.05;for(let O=0;O<e.instancedDataCount;++O){let N=e.instancedDataOffset+O,B=16*N,G=s.instancedDataArray.float32,X=0;c&&(X=G[B+6]-s.instancesEvaluatedElevation[N]);let q=0|G[B+1];G[B]=(0|G[B])+S.r/1.05,G[B+1]=q+S.g/1.05,G[B+2]=P,G[B+3]=1/(y.z>10?this.tileToMeter:oe(y,q)),G[B+4]=I[0],G[B+5]=I[1],G[B+6]=I[2]+X,G[B+7]=D[0],G[B+8]=D[1],G[B+9]=D[2],G[B+10]=D[4],G[B+11]=D[5],G[B+12]=D[6],G[B+13]=D[8],G[B+14]=D[9],G[B+15]=D[10],s.instancesEvaluatedElevation[N]=I[2]}}}let TA,IA;_t(sw,"ModelBucket",{omit:["layers"]}),_t(EA,"PerModelAttributes"),_t(wA,"ModelFeature");class uf{constructor(e,n,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=n,this._offset=s}static create(e,n,s){let c=s||e.findDEMTileFor(n);if(!c||!c.dem)return;let f=c.dem,p=c.tileID,y=1<<n.canonical.z-p.canonical.z;return new uf(c,f.dim/st/y,[(n.canonical.x/y-p.canonical.x)*f.dim,(n.canonical.y/y-p.canonical.y)*f.dim])}tileCoordToPixel(e,n){let s=n*this._scale+this._offset[1];return new Xe(Math.floor(e*this._scale+this._offset[0]),Math.floor(s))}getElevationAt(e,n,s,c){let f=e*this._scale+this._offset[0],p=n*this._scale+this._offset[1],y=Math.floor(f),x=Math.floor(p),w=this._dem;return c=!!c,s?At(At(w.get(y,x,c),w.get(y,x+1,c),p-x),At(w.get(y+1,x,c),w.get(y+1,x+1,c),p-x),f-y):w.get(y,x,c)}getElevationAtPixel(e,n,s){return this._dem.get(e,n,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*j(1,e)*this._dem.stride}}let aw=new Float32Array(262144),ud=new Uint8Array(262144);function SA(i){let e=0;if(i.meshes)for(let n of i.meshes)e=Math.max(e,n.aabb.max[2]);if(i.children)for(let n of i.children)e=Math.max(e,SA(n));return e}function DA(i,e,n){if(i.meshes)for(let s of i.meshes){if(s.aabb.min[0]===1/0)continue;let c=sn.applyTransform(s.aabb,i.matrix);n.insert(e,c.min[0],c.min[1],c.max[0],c.max[1])}if(i.children)for(let s of i.children)DA(s,e,n)}let CA=["","wall","door","roof","window","lamp","logo"];class AA{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:SA(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0,n=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=sn.applyTransformFast(s.aabb,this.node.matrix),n.encapsulate(s.transformedAabb)),e++;this.aabb=n}return this.aabb}}class kv{constructor(e,n,s,c,f,p,y,x){this.id=s,this.layers=e,this.layerIds=this.layers.map(w=>w.fqid),this.stateDependentLayerIds=this.layers.filter(w=>w.isStateDependent()).map(w=>w.id),this.modelTraits|=rf.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,c&&(this.modelTraits|=rf.HasMapboxMeshFeatures),f&&(this.modelTraits|=rf.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=p,this.worldview=x,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(let w of n)this.nodesInfo.push(new AA(w)),DA(w,y.featureIndexArray.length,y.grid),y.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,y.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,n){for(let s of this.getNodesInfo()){let c=s.node;c.footprint&&n.push({footprint:c.footprint,id:e})}}update(e){let n=Object.keys(e).length!==0;if(n&&!this.stateDependentLayers.length)return;let s=n?this.stateDependentLayers:this.layers;if(!Bs(e,this.states))for(let c of s)this.evaluate(c,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;let n=this.getNodesInfo();for(let s of n){let c=s.node;this.uploaded?this.updatePbrBuffer(c):F1(c,e,!0)}for(let s of n)gv(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let n=!1;if(!e.meshes)return n;for(let s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),n=!0);return n}needsReEvaluation(e,n,s){let c=e.transform.projectionOptions,f=e.style.getBrightness(),p=this.brightness!==f;if(!this.uploaded||this.dirty||c.name!==this.projection.name||hg(s.paint.get("model-color").value,p)||hg(s.paint.get("model-color-mix-intensity").value,p)||hg(s.paint.get("model-roughness").value,p)||hg(s.paint.get("model-emissive-strength").value,p)||hg(s.paint.get("model-height-based-emissive-strength-multiplier").value,p)){this.projection=c,this.brightness=f;let y=this.getNodesInfo();for(let x of y)x.state=null;return!0}return!1}evaluateTransform(e,n){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;let s=this.getNodesInfo(),c=this.id.canonical;for(let f of s){let p=f.feature;f.evaluatedTranslation=n.paint.get("model-translation").evaluate(p,{},c),f.evaluatedScale=n.paint.get("model-scale").evaluate(p,{},c)}}evaluate(e,n){let s=this.getNodesInfo();for(let c of s){if(!c.node.meshes)continue;let f=c.feature,p=n&&n[f.id];if(Bs(p,c.state))continue;c.state=structuredClone(p);let y=c.node.meshes&&c.node.meshes[0].featureData,x=c.evaluatedColor[2],w=c.evaluatedRMEA[2],I=this.id.canonical;if(c.hasTranslucentParts=!1,y){for(let S=0;S<CA.length;S++){let D=CA[S];D.length&&(f.properties.part=D);let P=e.paint.get("model-color").evaluate(f,p,I).toPremultipliedRenderColor(null),O=e.paint.get("model-color-mix-intensity").evaluate(f,p,I);c.evaluatedColor[S]=[P.r,P.g,P.b,O],c.evaluatedRMEA[S][0]=e.paint.get("model-roughness").evaluate(f,p,I),c.evaluatedRMEA[S][2]=e.paint.get("model-emissive-strength").evaluate(f,p,I),c.evaluatedRMEA[S][3]=P.a,c.emissionHeightBasedParams[S]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(f,p,I),!c.hasTranslucentParts&&P.a<1&&(c.hasTranslucentParts=!0)}delete f.properties.part,JN(c,x!==c.evaluatedColor[2]||w!==c.evaluatedRMEA[2],this.modelTraits)}else c.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(f,p,I);c.evaluatedTranslation=e.paint.get("model-translation").evaluate(f,p,I),c.evaluatedScale=e.paint.get("model-scale").evaluate(f,p,I),this.updatePbrBuffer(c.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,n,s,c){let f=e.findDEMTileFor(s);if(f&&(f.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(f.dem&&f.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=f.tileID.overscaledZ;let p=uf.create(e,s,f);if(!p)return;this.modelTraits&rf.HasMapboxMeshFeatures&&this.updateDEM(e,p,s,c);for(let y of this.getNodesInfo()){let x=y.node;if(!x.footprint||!x.footprint.vertices||!x.footprint.vertices.length)continue;let w=x.footprint.vertices,I=p.getElevationAt(w[0].x,w[0].y,!0,!0);for(let S=1;S<w.length;S++)I=Math.min(I,p.getElevationAt(w[S].x,w[S].y,!0,!0));x.elevation=I}}this.terrainTile=f.tileID.canonical,this.terrainExaggeration=n}}updateDEM(e,n,s,c){let f=n._dem._modifiedForSources[c];if(f===void 0&&(n._dem._modifiedForSources[c]=[],f=n._dem._modifiedForSources[c]),f.includes(s.canonical))return;let p=n._dem.dim;f.push(s.canonical);let y=!1;for(let x of this.getNodesInfo()){let w=x.node;if(!w.footprint||!w.footprint.grid)continue;let I=w.footprint.grid,S=n.tileCoordToPixel(I.min.x,I.min.y),D=n.tileCoordToPixel(I.max.x,I.max.y),P=Math.min(Math.min(p-D.y,S.x),Math.min(S.y,p-D.x));if(P<0)continue;let O=ne(P,2,5),N=Math.max(0,S.x-O),B=Math.max(0,S.y-O),G=Math.min(D.x+O,p-1),X=Math.min(D.y+O,p-1);for(let le=B;le<=X;++le)for(let ue=N;ue<=G;++ue)ud[le*p+ue]=255;let q=0,K=0;for(let le=0;le<I.cellsY;++le)for(let ue=0;ue<I.cellsX;++ue){if(!I.cells[le*I.cellsX+ue])continue;let ge=n.tileCoordToPixel(I.min.x+ue/I.xScale,I.min.y+le/I.yScale),ye=n.tileCoordToPixel(I.min.x+(ue+1)/I.xScale,I.min.y+(le+1)/I.yScale);for(let ke=ge.y;ke<=Math.min(ye.y+1,p-1);++ke)for(let be=ge.x;be<=Math.min(ye.x+1,p-1);++be)ud[ke*p+be]===255&&(ud[ke*p+be]=0,q+=n.getElevationAtPixel(be,ke),K++)}let he=q/K;N=Math.max(1,S.x-O),B=Math.max(1,S.y-O),G=Math.min(D.x+O,p-2),X=Math.min(D.y+O,p-2),y=!0;for(let le=B;le<=X;++le)for(let ue=N;ue<=G;++ue)ud[le*p+ue]===0&&(aw[le*p+ue]=n._dem.set(ue,le,he));for(let le=1;le<O;++le){N=Math.max(1,S.x-le),B=Math.max(1,S.y-le),G=Math.min(D.x+le,p-2),X=Math.min(D.y+le,p-2);for(let ue=B;ue<=X;++ue)for(let ge=N;ge<=G;++ge){let ye=ue*p+ge;if(ud[ye]===255){let ke=0,be=0,ze=-1,et=-1;for(let Ue=-1;Ue<=1;++Ue)for(let Ze=-1;Ze<=1;++Ze){let Je=(ue+Ue)*p+ge+Ze;if(ud[Je]>=le)continue;let Le=aw[Je],qe=Math.abs(Le);qe>be&&(ke=Le,be=qe,ze=Ze,et=Ue)}if(be>.1){let Ue=1-(le+.5*Math.abs(ze*et))/O,Ze=n._dem.get(ge,ue)+ke*Ue,Je=n._dem.get(ge+ze,ue+et),Le=n._dem.get(ge-ze,ue-et,!0);(Ze-Je)*(Ze-Le)>0&&(Ze=(Je+Le)/2),aw[ye]=n._dem.set(ge,ue,Ze),ud[ye]=le}}}}}y&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=cs.now())}setFilter(e){this.filter=e?mc(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new jn(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){let e=this.getNodesInfo();for(let n of e)gv(n.node),k1(n.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let s=n.getReplacementRegionsForTile(e.toUnwrapped());for(let c of this.getNodesInfo()){let f=c.node.footprint;c.hiddenByReplacement=!!f&&!s.find(p=>p.footprint===f)}}getHeightAtTileCoord(e,n){let s=[],c=[0,0,0],f=Oe([]);for(let p of this.getNodesInfo()){let y=p.node.meshes[0],x=y.transformedAabb;if(e<x.min[0]||n<x.min[1]||e>x.max[0]||n>x.max[1])continue;if(p.node.hidden===!0)return{height:1/0,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};Ct(f,p.node.matrix),c[0]=e,c[1]=n,Nr(c,c,f);let w=(c[0]-y.aabb.min[0])/(y.aabb.max[0]-y.aabb.min[0])*ad|0,I=Math.min(63,(c[1]-y.aabb.min[1])/(y.aabb.max[1]-y.aabb.min[1])*ad|0)*ad+Math.min(63,w),S=y.heightmap[I];if(!(S<0&&p.node.footprint))return p.hiddenByReplacement?void 0:{height:S,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};if(p.node.footprint.grid.query(new Xe(e,n),new Xe(e,n),s),s.length>0)return{height:void 0,maxHeight:p.feature.properties.height,hidden:p.hiddenByReplacement,verticalScale:p.evaluatedScale[2]}}}}function hg(i,e){return i instanceof Rh&&!i.isLightConstant&&e}function KN(i,e,n,s,c,f,p,y){let x=(61440&e|(61440&e)>>4)>>8,w=(3840&e|(3840&e)>>4)>>4,I=240&e|(240&e)>>4;n[3]>0&&(x=At(x,255*n[0],n[3]),w=At(w,255*n[1],n[3]),I=At(I,255*n[2],n[3]));let S=x<<8|w,D=I<<8|Math.floor(255*s[3]),P=function(le){let ue=ne(le,0,2);return Math.min(Math.round(.5*ue*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],O=ne(c[0],0,1),N=ne(c[1],0,1),B=ne(c[2],0,1),G=ne(c[3],0,1),X,q,K,he;if(O!==N&&p!==f&&N!==O){let le=p-f;q=1/(le*(N-O)),K=-(f+le*O)/(le*(N-O));let ue=ne(c[4],-1,1);he=Math.pow(10,ue),X=255*B<<8|255*G}else X=65535,q=0,K=1,he=1;if(i.emplaceBack(S,D,P,X,q,K,he),y){let le=y.length;y.clear();for(let ue=0;ue<le;ue++)y.emplaceBack(S,D,P,X,q,K,he)}}function JN(i,e,n){let s=i.node,c=0,f=n&rf.HasMeshoptCompression;for(let p of s.meshes){if(s.lights&&s.lightMeshIndex===c||!p.featureData)continue;p.featureArray=new Ic,p.featureArray.reserve(p.featureData.length);let y=e;for(let x of p.featureData){let w=f?65535&x:x>>16&65535,I=f?x>>16&65535:65535&x,S=(15&I)<8?15&I:0,D=i.evaluatedRMEA[S],P=i.evaluatedColor[S],O=i.emissionHeightBasedParams[S],N;if(y&&S===2&&s.lights&&(N=new Ic,N.resize(10*s.lights.length)),KN(p.featureArray,w,P,D,O,p.aabb.min[2],p.aabb.max[2],N),N&&y){y=!1;let B=s.meshes[s.lightMeshIndex];B.featureArray=N,B.featureArray._trim()}}p.featureArray._trim(),c++}}function MA(i,e,n,s){let c=1<<i.z;e.lat=Y((s/st+i.y)/c),e.lng=Z((n/st+i.x)/c)}function QN(i,e,n,s){let c=i.getNodesInfo()[e];if(!c||c.hiddenByReplacement||!c.node.meshes)return;let f=Number.MAX_VALUE,p=c.node,y=n.tile,x=s.calculatePosMatrix(y.tileID.toUnwrapped(),s.worldSize),w=c.evaluatedScale,I=0;s.elevation&&p.elevation&&(I=p.elevation*s.elevation.exaggeration()),Ut(x,x,[(p.anchor?p.anchor[0]:0)*(w[0]-1),(p.anchor?p.anchor[1]:0)*(w[1]-1),I]),Nt(x,x,w);let S=n.queryGeometry,D=S.isPointQuery()?S.screenBounds:S.screenGeometry,P=function(N){let B=Vt([],x,N.matrix);Vt(B,s.expandedFarZProjMatrix,B);for(let G=0;G<N.meshes.length;++G){let X=N.meshes[G];if(G===N.lightMeshIndex)continue;let q=YD(D,s,B,X.aabb);q!=null&&(f=Math.min(q,f))}if(N.children)for(let G of N.children)P(G)};if(P(p),f===Number.MAX_VALUE)return;let O=new A(0,0);return MA(y.tileID.canonical,O,c.node.anchor[0],c.node.anchor[1]),{intersectionZ:f,position:O,feature:c.feature}}_t(kv,"Tiled3dModelBucket",{omit:["layers"]}),_t(AA,"Tiled3dModelFeature");let ez={circle:class extends Li{constructor(i,e,n,s){super(i,{layout:Fa||(Fa=new Mr({"circle-sort-key":new dt(xe.layout_circle["circle-sort-key"]),"circle-elevation-reference":new tt(xe.layout_circle["circle-elevation-reference"]),visibility:new tt(xe.layout_circle.visibility)})),paint:Cc||(Cc=new Mr({"circle-radius":new dt(xe.paint_circle["circle-radius"]),"circle-color":new dt(xe.paint_circle["circle-color"]),"circle-blur":new dt(xe.paint_circle["circle-blur"]),"circle-opacity":new dt(xe.paint_circle["circle-opacity"]),"circle-translate":new tt(xe.paint_circle["circle-translate"]),"circle-translate-anchor":new tt(xe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new tt(xe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new tt(xe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new dt(xe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new dt(xe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new dt(xe.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new tt(xe.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}createBucket(i){return new Rn(i)}queryRadius(i){let e=i;return mi("circle-radius",this,e)+mi("circle-stroke-width",this,e)+Lr(this.paint.get("circle-translate"))}queryIntersectsFeature(i,e,n,s,c,f,p,y){let x=vl(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),w=this.paint.get("circle-radius").evaluate(e,n)+this.paint.get("circle-stroke-width").evaluate(e,n);return NS(i,s,f,p,y,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",x,w)}getProgramIds(){return["circle"]}getDefaultProgramParams(i,e,n){let s=kS(this);return{config:new ji(this,{zoom:e,lut:n}),defines:s,overrideFog:!1}}is3D(i){return!i&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends Li{createBucket(i){return new BS(i)}constructor(i,e,n,s){super(i,{layout:VS||(VS=new Mr({visibility:new tt(xe.layout_heatmap.visibility)})),paint:US||(US=new Mr({"heatmap-radius":new dt(xe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new dt(xe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new tt(xe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new pc(xe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new tt(xe.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(i){i==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Nm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(i){return mi("heatmap-radius",this,i)}queryIntersectsFeature(i,e,n,s,c,f,p,y){let x=this.paint.get("heatmap-radius").evaluate(e,n);return NS(i,s,f,p,y,!0,!0,new Xe(0,0),x)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(i,e,n){return i==="heatmap"?{config:new ji(this,{zoom:e,lut:n}),overrideFog:!1}:{}}},hillshade:class extends Li{constructor(i,e,n,s){super(i,{layout:jS||(jS=new Mr({visibility:new tt(xe.layout_hillshade.visibility)})),paint:HS||(HS=new Mr({"hillshade-illumination-direction":new tt(xe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new tt(xe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new tt(xe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new tt(xe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new tt(xe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new tt(xe.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new tt(xe.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(i,e,n){return{overrideFog:!1}}},fill:class extends Li{constructor(i,e,n,s){super(i,{layout:iD||(iD=new Mr({"fill-sort-key":new dt(xe.layout_fill["fill-sort-key"]),visibility:new tt(xe.layout_fill.visibility),"fill-elevation-reference":new tt(xe.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new dt(xe.layout_fill["fill-construct-bridge-guard-rail"])})),paint:oD||(oD=new Mr({"fill-antialias":new tt(xe.paint_fill["fill-antialias"]),"fill-opacity":new dt(xe.paint_fill["fill-opacity"]),"fill-color":new dt(xe.paint_fill["fill-color"]),"fill-outline-color":new dt(xe.paint_fill["fill-outline-color"]),"fill-translate":new tt(xe.paint_fill["fill-translate"]),"fill-translate-anchor":new tt(xe.paint_fill["fill-translate-anchor"]),"fill-pattern":new dt(xe.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new tt(xe.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new tt(xe.paint_fill["fill-emissive-strength"]),"fill-z-offset":new dt(xe.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new dt(xe.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new dt(xe.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}getProgramIds(){let i=this.paint.get("fill-pattern"),e=i&&i.constantOr(1),n=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(i,e,n){return{config:new ji(this,{zoom:e,lut:n}),overrideFog:!1}}recalculate(i,e){super.recalculate(i,e);let n=this.paint._values["fill-outline-color"];n.value.kind==="constant"&&n.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(i){return new _1(i)}queryRadius(){return Lr(this.paint.get("fill-translate"))}queryIntersectsFeature(i,e,n,s,c,f){return!i.queryGeometry.isAboveHorizon&&Br(Fo(i.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(i){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;let e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return i!=null?e&&!i:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends Li{constructor(i,e,n,s){super(i,{layout:CD||(CD=new Mr({visibility:new tt(xe["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new tt(xe["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:AD||(AD=new Mr({"fill-extrusion-opacity":new tt(xe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new dt(xe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new tt(xe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new tt(xe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new dt(xe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new tt(xe["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new dt(xe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new dt(xe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new tt(xe["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new tt(xe["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new tt(xe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new tt(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new tt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new tt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new dt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new dt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new tt(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new tt(xe["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new tt(xe["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new tt(xe["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new dt(xe["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new dt(xe["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new tt(xe["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(i){return new av(i)}queryRadius(){return Lr(this.paint.get("fill-extrusion-translate"))}is3D(i){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(i,e,n,s,c,f,p,y,x){let w=vl(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),I=this.paint.get("fill-extrusion-height").evaluate(e,n),S=this.paint.get("fill-extrusion-base").evaluate(e,n),D=[0,0],P=y&&f.elevation,O=f.elevation?f.elevation.exaggeration():1,N=i.tile.getBucket(this);if(P&&N instanceof av){let K=N.centroidVertexArray,he=x+1;he<K.length&&(D[0]=K.geta_centroid_pos0(he),D[1]=K.geta_centroid_pos1(he))}if(D[0]===0&&D[1]===1)return!1;f.projection.name==="globe"&&(s=DD([s],[new Xe(0,0),new Xe(st,st)],i.tileID.canonical).map(K=>K.polygon).flat());let B=P?y:null,[G,X]=function(K,he,le,ue,ge,ye,ke,be,ze,et,Ue){return K.projection.name==="globe"?function(Ze,Je,Le,qe,we,Fe,rt,Ye,Et,yt,$e){let Ke=[],xt=[],pt=Ze.projection.upVectorScale($e,Ze.center.lat,Ze.worldSize).metersToTile,at=[0,0,0,1],mt=[0,0,0,1],Rt=(qt,Gt,pn,nn)=>{qt[0]=Gt,qt[1]=pn,qt[2]=nn,qt[3]=1},Bt=SD();Le>0&&(Le+=Bt),qe+=Bt;for(let qt of Je){let Gt=[],pn=[];for(let nn of qt){let nr=nn.x+we.x,Q=nn.y+we.y,ee=Ze.projection.projectTilePoint(nr,Q,$e),Re=Ze.projection.upVector($e,nn.x,nn.y),it=Le,ct=qe;if(rt){let lt=FD(nr,Q,Le,qe,rt,Ye,Et,yt);it+=lt.base,ct+=lt.top}Le!==0?Rt(at,ee.x+Re[0]*pt*it,ee.y+Re[1]*pt*it,ee.z+Re[2]*pt*it):Rt(at,ee.x,ee.y,ee.z),Rt(mt,ee.x+Re[0]*pt*ct,ee.y+Re[1]*pt*ct,ee.z+Re[2]*pt*ct),Nr(at,at,Fe),Nr(mt,mt,Fe),Gt.push(new sd(at[0],at[1],at[2])),pn.push(new sd(mt[0],mt[1],mt[2]))}Ke.push(Gt),xt.push(pn)}return[Ke,xt]}(K,he,le,ue,ge,ye,ke,be,ze,et,Ue):ke?function(Ze,Je,Le,qe,we,Fe,rt,Ye,Et){let yt=[],$e=[],Ke=[0,0,0,1];for(let xt of Ze){let pt=[],at=[];for(let mt of xt){let Rt=mt.x+qe.x,Bt=mt.y+qe.y,qt=FD(Rt,Bt,Je,Le,Fe,rt,Ye,Et);Ke[0]=Rt,Ke[1]=Bt,Ke[2]=qt.base,Ke[3]=1,ho(Ke,Ke,we),Ke[3]=Math.max(Ke[3],1e-5);let Gt=new sd(Ke[0]/Ke[3],Ke[1]/Ke[3],Ke[2]/Ke[3]);Ke[0]=Rt,Ke[1]=Bt,Ke[2]=qt.top,Ke[3]=1,ho(Ke,Ke,we),Ke[3]=Math.max(Ke[3],1e-5);let pn=new sd(Ke[0]/Ke[3],Ke[1]/Ke[3],Ke[2]/Ke[3]);pt.push(Gt),at.push(pn)}yt.push(pt),$e.push(at)}return[yt,$e]}(he,le,ue,ge,ye,ke,be,ze,et):function(Ze,Je,Le,qe,we){let Fe=[],rt=[],Ye=we[8]*Je,Et=we[9]*Je,yt=we[10]*Je,$e=we[11]*Je,Ke=we[8]*Le,xt=we[9]*Le,pt=we[10]*Le,at=we[11]*Le;for(let mt of Ze){let Rt=[],Bt=[];for(let qt of mt){let Gt=qt.x+qe.x,pn=qt.y+qe.y,nn=we[0]*Gt+we[4]*pn+we[12],nr=we[1]*Gt+we[5]*pn+we[13],Q=we[2]*Gt+we[6]*pn+we[14],ee=we[3]*Gt+we[7]*pn+we[15],Re=nn+Ye,it=nr+Et,ct=Q+yt,lt=Math.max(ee+$e,1e-5),vt=nn+Ke,Ft=nr+xt,cn=Q+pt,un=Math.max(ee+at,1e-5);Rt.push(new sd(Re/lt,it/lt,ct/lt)),Bt.push(new sd(vt/un,Ft/un,cn/un))}Fe.push(Rt),rt.push(Bt)}return[Fe,rt]}(he,le,ue,ge,ye)}(f,s,S,I,w,p,B,D,O,f.center.lat,i.tileID.canonical),q=i.queryGeometry;return function(K,he,le){let ue=1/0;Br(le,he)&&(ue=LD(le,he[0]));for(let ge=0;ge<he.length;ge++){let ye=he[ge],ke=K[ge];for(let be=0;be<ye.length-1;be++){let ze=ye[be],et=[ze,ye[be+1],ke[be+1],ke[be],ze];Wn(le,et)&&(ue=Math.min(ue,LD(le,et)))}}return ue!==1/0&&ue}(G,X,q.isPointQuery()?q.screenBounds:q.screenGeometry)}},building:class extends Li{constructor(i,e,n,s){super(i,{layout:oC||(oC=new Mr({visibility:new tt(xe.layout_building.visibility),"building-facade":new dt(xe.layout_building["building-facade"]),"building-facade-floors":new dt(xe.layout_building["building-facade-floors"]),"building-facade-window":new dt(xe.layout_building["building-facade-window"]),"building-roof-shape":new dt(xe.layout_building["building-roof-shape"]),"building-height":new dt(xe.layout_building["building-height"]),"building-base":new dt(xe.layout_building["building-base"])})),paint:sC||(sC=new Mr({"building-opacity":new tt(xe.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new tt(xe.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new tt(xe.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new tt(xe.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new tt(xe.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new tt(xe.paint_building["building-vertical-scale"]),"building-cast-shadows":new tt(xe.paint_building["building-cast-shadows"]),"building-color":new dt(xe.paint_building["building-color"]),"building-emissive-strength":new dt(xe.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new tt(xe.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new tt(xe.paint_building["building-cutoff-fade-range"]),"building-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(i){return new iC(i)}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(i){return!0}},line:class extends Li{constructor(i,e,n,s){let c=gC();super(i,c,e,n,s),c.layout&&(this.layout=new hs(c.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(i){if(i==="line-gradient"){let e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Bu,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(i,e){super.recalculate(i,e),this.paint._values["line-floorwidth"]=(()=>{if(eg)return eg;let n=gC();return eg=new Jk(n.paint.properties["line-width"].specification),eg.useIntegerZoom=!0,eg})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,i)}createBucket(i){return new B1(i)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(i,e,n){let s=pC(this);return{config:new ji(this,{zoom:e,lut:n}),defines:s,overrideFog:!1}}queryRadius(i){let e=i,n=_C(mi("line-width",this,e),mi("line-gap-width",this,e)),s=mi("line-offset",this,e);return n/2+Math.abs(s)+Lr(this.paint.get("line-translate"))}queryIntersectsFeature(i,e,n,s,c,f){if(i.queryGeometry.isAboveHorizon)return!1;let p=Fo(i.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),f.angle,i.pixelToTileUnitsFactor),y=i.pixelToTileUnitsFactor/2*_C(this.paint.get("line-width").evaluate(e,n),this.paint.get("line-gap-width").evaluate(e,n)),x=this.paint.get("line-offset").evaluate(e,n);return x&&(s=function(w,I){let S=[],D=new Xe(0,0);for(let P=0;P<w.length;P++){let O=w[P],N=[];for(let B=0;B<O.length;B++){let G=O[B],X=O[B+1],q=B===0?D:G.sub(O[B-1])._unit()._perp(),K=B===O.length-1?D:X.sub(G)._unit()._perp(),he=q._add(K)._unit();he._mult(1/(he.x*K.x+he.y*K.y)),N.push(he._mult(I)._add(G))}S.push(N)}return S}(s,x*i.pixelToTileUnitsFactor)),function(w,I,S){for(let D=0;D<I.length;D++){let P=I[D];if(w.length>=3){for(let O=0;O<P.length;O++)if(Ii(w,P[O]))return!0}if(Wr(w,P,S))return!0}return!1}(p,s,y)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(i){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:Pv,background:class extends Li{constructor(i,e,n,s){super(i,{layout:lA||(lA=new Mr({visibility:new tt(xe.layout_background.visibility)})),paint:cA||(cA=new Mr({"background-pitch-alignment":new tt(xe.paint_background["background-pitch-alignment"]),"background-color":new tt(xe.paint_background["background-color"]),"background-pattern":new tt(xe.paint_background["background-pattern"]),"background-opacity":new tt(xe.paint_background["background-opacity"]),"background-emissive-strength":new tt(xe.paint_background["background-emissive-strength"]),"background-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(i,e,n){return{overrideFog:!1}}is3D(i){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:pA,"raster-particle":xA,sky:class extends Li{constructor(i,e,n,s){super(i,{layout:_A||(_A=new Mr({visibility:new tt(xe.layout_sky.visibility)})),paint:yA||(yA=new Mr({"sky-type":new tt(xe.paint_sky["sky-type"]),"sky-atmosphere-sun":new tt(xe.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new tt(xe.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new tt(xe.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new tt(xe.paint_sky["sky-gradient-radius"]),"sky-gradient":new pc(xe.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new tt(xe.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new tt(xe.paint_sky["sky-atmosphere-color"]),"sky-opacity":new tt(xe.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(i){i==="sky-gradient"?this._updateColorRamp():i!=="sky-atmosphere-sun"&&i!=="sky-atmosphere-halo-color"&&i!=="sky-atmosphere-color"&&i!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Nm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(i){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let e=i.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(i,e){if(this.paint.get("sky-type")==="atmosphere"){let s=this.paint.get("sky-atmosphere-sun"),c=!s,f=i.style.light,p=f.properties.get("position");return c&&f.properties.get("anchor")==="viewport"&&fn("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),c?iw(p.azimuthal,90-p.polar,e):iw(s[0],90-s[1],e)}let n=this.paint.get("sky-gradient-center");return iw(n[0],90-n[1],e)}isSky(){return!0}markSkyboxValid(i){this._skyboxInvalidated=!1,this._lightPosition=i.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let i=this.paint.get("sky-type");return i==="atmosphere"?["skyboxCapture","skybox"]:i==="gradient"?["skyboxGradient"]:null}},slot:class extends Li{constructor(i,e,n,s){super(i,{paint:vA||(vA=new Mr({}))},e,null)}},model:class extends Li{constructor(i,e,n,s){super(i,{layout:TA||(TA=new Mr({visibility:new tt(xe.layout_model.visibility),"model-id":new dt(xe.layout_model["model-id"])})),paint:IA||(IA=new Mr({"model-opacity":new dt(xe.paint_model["model-opacity"]),"model-rotation":new dt(xe.paint_model["model-rotation"]),"model-scale":new dt(xe.paint_model["model-scale"]),"model-translation":new dt(xe.paint_model["model-translation"]),"model-color":new dt(xe.paint_model["model-color"]),"model-color-mix-intensity":new dt(xe.paint_model["model-color-mix-intensity"]),"model-type":new tt(xe.paint_model["model-type"]),"model-cast-shadows":new tt(xe.paint_model["model-cast-shadows"]),"model-receive-shadows":new tt(xe.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new tt(xe.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new dt(xe.paint_model["model-emissive-strength"]),"model-roughness":new dt(xe.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new dt(xe.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new tt(xe.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new tt(xe.paint_model["model-front-cutoff"]),"model-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(i){return new sw(i)}getProgramIds(){return["model"]}is3D(i){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(i){return i instanceof kv?st-1:0}queryIntersectsFeature(i,e,n,s,c,f){if(!this.modelManager)return!1;let p=this.modelManager,y=i.tile.getBucket(this);if(!(y&&y instanceof sw))return!1;for(let x in y.instancesPerModel){let w=y.instancesPerModel[x],I=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(w.idToFeaturesIndex.hasOwnProperty(I)){let S=w.features[w.idToFeaturesIndex[I]],D=p.getModel(x,this.scope);if(!D)return!1;let P=ht(),O=new A(0,0),N=y.canonical,B=Number.MAX_VALUE;for(let G=0;G<S.instancedDataCount;++G){let X=16*(S.instancedDataOffset+G),q=w.instancedDataArray.float32,K=[q[X+4],q[X+5],q[X+6]];MA(N,O,q[X],0|q[X+1]),KD(P,D,f,O,S.rotation,S.scale,K,!1,!1,!1),f.projection.name==="globe"&&(P=L1(P,f));let he=Vt([],f.projMatrix,P),le=i.queryGeometry,ue=YD(le.isPointQuery()?le.screenBounds:le.screenGeometry,f,he,D.aabb);ue!=null&&(B=Math.min(ue,B))}return B!==Number.MAX_VALUE&&B}}return!1}_handleOverridablePaintPropertyUpdate(i,e,n){return!(!this.layout||e.isDataDriven()||n.isDataDriven()||i!=="model-color"&&i!=="model-color-mix-intensity"&&i!=="model-rotation"&&i!=="model-scale"&&i!=="model-translation"&&i!=="model-emissive-strength")}_isPropertyZoomDependent(i){let e=this._transitionablePaint._values[i];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Ca}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Li{constructor(i,e,n,s){super(i,{layout:sD||(sD=new Mr({"clip-layer-types":new tt(xe.layout_clip["clip-layer-types"]),"clip-layer-scope":new tt(xe.layout_clip["clip-layer-scope"])})),paint:aD||(aD=new Mr({}))},e,n,s)}recalculate(i,e){super.recalculate(i,e)}createBucket(i){return new lD(i)}is3D(i){return!0}}},lw=new Ln(0,0,0),cw={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},uw={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},Nv={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},tz={PAINT_ORDER_FILL_AND_STROKE:1},fg={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},RA={MASK_TYPE_LUMINANCE:1};function nz(i,e,n){i===1&&e.icons.push(function(s,c){return function(f){if(f.usvg_tree.height||(f.usvg_tree.height=f.usvg_tree.width),!f.metadata)return f;let{metadata:p}=f;if(p.content_area){let{content_area:y}=p;y.top==null&&(y.top=y.left),y.width==null&&(y.width=f.usvg_tree.width),y.height==null&&(y.height=y.width)}return p.stretch_x&&p.stretch_x.length&&PA(p,"x"),p.stretch_y&&p.stretch_y.length&&PA(p,"y"),f}(s.readFields(rz,{name:void 0},c))}(n,n.readVarint()+n.pos))}function PA(i,e){let n=[],s=i[`stretch_${e}`],c=null;for(let f=0;f<s.length;f++)c===null?c=n.length===0?s[0]:n[n.length-1][1]+s[f]:(n.push([c,c+s[f]]),c=null);i[`stretch_${e}_areas`]=n}function rz(i,e,n){i===1?e.name=n.readString():i===2?e.metadata=function(s,c){return s.readFields(iz,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},c)}(n,n.readVarint()+n.pos):i===3&&(e.usvg_tree=function(s,c){return s.readFields(az,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},c)}(n,n.readVarint()+n.pos),e.data="usvg_tree")}function iz(i,e,n){i===1?e.stretch_x=n.readPackedVarint():i===2?e.stretch_y=n.readPackedVarint():i===3?e.content_area=function(s,c){return s.readFields(oz,{left:0},c)}(n,n.readVarint()+n.pos):i===4&&e.variables.push(function(s,c){return s.readFields(sz,{name:void 0},c)}(n,n.readVarint()+n.pos))}function oz(i,e,n){i===1?e.left=n.readVarint():i===2?e.width=n.readVarint():i===3?e.top=n.readVarint():i===4&&(e.height=n.readVarint())}function sz(i,e,n){i===1?e.name=n.readString():i===2&&(e.rgb_color=Vv(n.readVarint()),e.value="rgb_color")}function az(i,e,n){i===1?e.width=e.height=n.readVarint():i===2?e.height=n.readVarint():i===3?e.children.push(zv(n,n.readVarint()+n.pos)):i===4?e.linear_gradients.push(function(s,c){return s.readFields(pz,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},c)}(n,n.readVarint()+n.pos)):i===5?e.radial_gradients.push(function(s,c){return s.readFields(gz,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},c)}(n,n.readVarint()+n.pos)):i===7?e.clip_paths.push(function(s,c){return s.readFields(_z,{children:[]},c)}(n,n.readVarint()+n.pos)):i===8&&e.masks.push(function(s,c){let f=s.readFields(yz,{left:0,width:20,mask_type:RA.MASK_TYPE_LUMINANCE,children:[]},c);return f.height==null&&(f.height=f.width),f.top==null&&(f.top=f.left),f}(n,n.readVarint()+n.pos))}function zv(i,e){return i.readFields(lz,{},e)}function lz(i,e,n){i===1?(e.group=function(s,c){return s.readFields(cz,{opacity:255,children:[]},c)}(n,n.readVarint()+n.pos),e.node="group"):i===2&&(e.path=function(s,c){return s.readFields(dz,{paint_order:1,commands:[],step:1,diffs:[],rule:cw.PATH_RULE_NON_ZERO},c)}(n,n.readVarint()+n.pos),e.node="path")}function cz(i,e,n){i===1?e.transform=Bv(n,n.readVarint()+n.pos):i===2?e.opacity=n.readVarint():i===5?e.clip_path_idx=n.readVarint():i===6?e.mask_idx=n.readVarint():i===7&&e.children.push(zv(n,n.readVarint()+n.pos))}function Bv(i,e){return i.readFields(uz,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function uz(i,e,n){i===1?e.sx=n.readFloat():i===2?e.ky=n.readFloat():i===3?e.kx=n.readFloat():i===4?e.sy=n.readFloat():i===5?e.tx=n.readFloat():i===6&&(e.ty=n.readFloat())}function dz(i,e,n){i===1?e.fill=function(s,c){return s.readFields(hz,{rgb_color:lw,paint:"rgb_color",opacity:255},c)}(n,n.readVarint()+n.pos):i===2?e.stroke=function(s,c){return s.readFields(fz,{rgb_color:lw,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},c)}(n,n.readVarint()+n.pos):i===3?e.paint_order=n.readVarint():i===5?n.readPackedVarint(e.commands):i===6?e.step=n.readFloat():i===7?n.readPackedSVarint(e.diffs):i===8&&(e.rule=n.readVarint())}function hz(i,e,n){i===1?(e.rgb_color=Vv(n.readVarint()),e.paint="rgb_color"):i===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):i===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):i===5&&(e.opacity=n.readVarint())}function Vv(i){return new Ln((i>>16&255)/255,(i>>8&255)/255,(255&i)/255,1)}function fz(i,e,n){i===1?(e.rgb_color=Vv(n.readVarint()),e.paint="rgb_color"):i===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):i===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):i===5?n.readPackedFloat(e.dasharray):i===6?e.dashoffset=n.readFloat():i===7?e.miterlimit=n.readFloat():i===8?e.opacity=n.readVarint():i===9?e.width=n.readFloat():i===10?e.linecap=n.readVarint():i===11&&(e.linejoin=n.readVarint())}function pz(i,e,n){i===1?e.transform=Bv(n,n.readVarint()+n.pos):i===2?e.spread_method=n.readVarint():i===3?e.stops.push(OA(n,n.readVarint()+n.pos)):i===4?e.x1=n.readFloat():i===5?e.y1=n.readFloat():i===6?e.x2=n.readFloat():i===7&&(e.y2=n.readFloat())}function OA(i,e){return i.readFields(mz,{offset:0,opacity:255,rgb_color:lw},e)}function mz(i,e,n){i===1?e.offset=n.readFloat():i===2?e.opacity=n.readVarint():i===3&&(e.rgb_color=Vv(n.readVarint()))}function gz(i,e,n){i===1?e.transform=Bv(n,n.readVarint()+n.pos):i===2?e.spread_method=n.readVarint():i===3?e.stops.push(OA(n,n.readVarint()+n.pos)):i===4?e.cx=n.readFloat():i===5?e.cy=n.readFloat():i===6?e.r=n.readFloat():i===7?e.fx=n.readFloat():i===8?e.fy=n.readFloat():i===9&&(e.fr=n.readFloat())}function _z(i,e,n){i===1?e.transform=Bv(n,n.readVarint()+n.pos):i===2?e.clip_path_idx=n.readVarint():i===3&&e.children.push(zv(n,n.readVarint()+n.pos))}function yz(i,e,n){i===1?e.left=e.top=n.readFloat():i===2?e.width=e.height=n.readFloat():i===3?e.top=n.readFloat():i===4?e.height=n.readFloat():i===5?e.mask_type=n.readVarint():i===6?e.mask_idx=n.readVarint():i===7&&e.children.push(zv(n,n.readVarint()+n.pos))}class vz{static calculate(e={},n=[]){let s=new Map,c=new Map;if(Object.keys(e).length===0)return s;n.forEach(f=>{c.set(f.name,f.rgb_color||new Ln(0,0,0))});for(let[f,p]of Object.entries(e))c.has(f)?s.set(c.get(f).toString(),p):console.warn(`Ignoring unknown image variable "${f}"`);return s}}function df(i,e=255,n){let s=e/255,c=i.toString(),f=n.has(c)?n.get(c).clone():i.clone();return f.a*=s,f.toString()}function pg(i,e){if(!Jd()){let n=document.createElement("canvas");return n.width=i,n.height=e,n}return new OffscreenCanvas(i,e)}function xz(i,e){let n=vz.calculate(e.params,i.metadata?i.metadata.variables:[]),s=i.usvg_tree,c=s.width,f=s.height,p=e.transform?e.transform:new DOMMatrix,y=Math.max(1,Math.round(c*p.a)),x=Math.max(1,Math.round(f*p.d)),w=new DOMMatrix([y/c,0,0,x/f,0,0]),I=pg(y,x).getContext("2d");return dw(I,w,s,s,n),I.getImageData(0,0,y,x)}function dw(i,e,n,s,c){for(let f of s.children)LA(i,e,n,f,c)}function LA(i,e,n,s,c){s.group?(i.save(),function(f,p,y,x,w){let I=x.mask_idx!=null?y.masks[x.mask_idx]:null,S=x.clip_path_idx!=null?y.clip_paths[x.clip_path_idx]:null;if(x.transform&&(p=hf(x.transform).preMultiplySelf(p)),!function(O,N,B){return O.opacity!==255||N||B}(x,S!=null,I!=null))return void dw(f,p,y,x,w);let D=pg(f.canvas.width,f.canvas.height),P=D.getContext("2d");dw(P,p,y,x,w),S&&UA(P,p,y,S),I&&jA(P,p,y,I,w),f.globalAlpha=x.opacity/255,f.drawImage(D,0,0)}(i,e,n,s.group,c),i.restore()):s.path&&(i.save(),function(f,p,y,x,w){f.setTransform(p),x.paint_order===tz.PAINT_ORDER_FILL_AND_STROKE?(FA(f,y,x,w),NA(f,y,x,w)):(NA(f,y,x,w),FA(f,y,x,w))}(i,e,n,s.path,c),i.restore())}function FA(i,e,n,s){let c=n.fill;if(!c)return;let f=c.opacity/255;switch(i.save(),i.beginPath(),HA(n,i),c.paint){case"rgb_color":i.fillStyle=df(c.rgb_color,c.opacity,s);break;case"linear_gradient_idx":{let p=e.linear_gradients[c.linear_gradient_idx];p.transform&&i.setTransform(hf(p.transform).preMultiplySelf(i.getTransform())),i.fillStyle=zA(i,p,f,s);break}case"radial_gradient_idx":{let p=e.radial_gradients[c.radial_gradient_idx];p.transform&&i.setTransform(hf(p.transform).preMultiplySelf(i.getTransform())),i.fillStyle=BA(i,p,f,s)}}i.fill(kA(n)),i.restore()}function kA(i){return i.rule===cw.PATH_RULE_NON_ZERO?"nonzero":i.rule===cw.PATH_RULE_EVEN_ODD?"evenodd":void 0}function NA(i,e,n,s){let c=n.stroke;if(!c)return;let f=GA(n);i.lineWidth=c.width,i.miterLimit=c.miterlimit,i.setLineDash(c.dasharray),i.lineDashOffset=c.dashoffset;let p=c.opacity/255;switch(c.paint){case"rgb_color":i.strokeStyle=df(c.rgb_color,c.opacity,s);break;case"linear_gradient_idx":i.strokeStyle=zA(i,e.linear_gradients[c.linear_gradient_idx],p,s,!0);break;case"radial_gradient_idx":i.strokeStyle=BA(i,e.radial_gradients[c.radial_gradient_idx],p,s,!0)}switch(c.linejoin){case Nv.LINE_JOIN_MITER_CLIP:case Nv.LINE_JOIN_MITER:i.lineJoin="miter";break;case Nv.LINE_JOIN_ROUND:i.lineJoin="round";break;case Nv.LINE_JOIN_BEVEL:i.lineJoin="bevel"}switch(c.linecap){case uw.LINE_CAP_BUTT:i.lineCap="butt";break;case uw.LINE_CAP_ROUND:i.lineCap="round";break;case uw.LINE_CAP_SQUARE:i.lineCap="square"}i.stroke(f)}function zA(i,e,n,s,c=!1){if(e.stops.length===1){let D=e.stops[0];return df(D.rgb_color,D.opacity*n,s)}let{x1:f,y1:p,x2:y,y2:x}=e,w=new DOMPoint(f,p),I=new DOMPoint(y,x);if(c){let D=hf(e.transform);w=D.transformPoint(w),I=D.transformPoint(I)}let S=i.createLinearGradient(w.x,w.y,I.x,I.y);for(let D of e.stops)S.addColorStop(D.offset,df(D.rgb_color,D.opacity*n,s));return S}function BA(i,e,n,s,c=!1){if(e.stops.length===1){let G=e.stops[0];return df(G.rgb_color,G.opacity*n,s)}let f=hf(e.transform),{fx:p,fy:y,fr:x,cx:w,cy:I,r:S}=e,D=new DOMPoint(p,y),P=new DOMPoint(w,I),O=x,N=S;if(c){D=f.transformPoint(D),P=f.transformPoint(P);let G=(f.a+f.d)/2;O=x*G,N=e.r*G}let B=i.createRadialGradient(D.x,D.y,O,P.x,P.y,N);for(let G of e.stops)B.addColorStop(G.offset,df(G.rgb_color,G.opacity*n,s));return B}function VA(i,e,n,s){let c=s.transform?hf(s.transform).preMultiplySelf(e):e,f=pg(i.canvas.width,i.canvas.height),p=f.getContext("2d");for(let x of s.children)if(x.group)VA(p,c,n,x.group);else if(x.path){let w=x.path,I=new Path2D;I.addPath(GA(w),c),p.fill(I,kA(w))}let y=s.clip_path_idx!=null?n.clip_paths[s.clip_path_idx]:null;y&&UA(p,c,n,y),i.globalCompositeOperation="source-over",i.drawImage(f,0,0)}function UA(i,e,n,s){let c=pg(i.canvas.width,i.canvas.height);VA(c.getContext("2d"),e,n,s),i.globalCompositeOperation="destination-in",i.drawImage(c,0,0)}function jA(i,e,n,s,c){if(s.children.length===0)return;let f=s.mask_idx!=null?n.masks[s.mask_idx]:null;f&&jA(i,e,n,f,c);let p=i.canvas.width,y=i.canvas.height,x=pg(p,y),w=x.getContext("2d"),I=s.width,S=s.height,D=s.left,P=s.top,O=new Path2D,N=new Path2D;N.rect(D,P,I,S),O.addPath(N,e),w.clip(O);for(let X of s.children)LA(w,e,n,X,c);let B=w.getImageData(0,0,p,y),G=B.data;if(s.mask_type===RA.MASK_TYPE_LUMINANCE)for(let X=0;X<G.length;X+=4)G[X+3]=G[X+3]/255*(.2126*G[X]+.7152*G[X+1]+.0722*G[X+2]);w.putImageData(B,0,0),i.globalCompositeOperation="destination-in",i.drawImage(x,0,0)}function hf(i){return i?new DOMMatrix([i.sx,i.ky,i.kx,i.sy,i.tx,i.ty]):new DOMMatrix}function HA(i,e){let n=i.step,s=i.diffs[0]*n,c=i.diffs[1]*n;e.moveTo(s,c);for(let f=0,p=2;f<i.commands.length;f++)switch(i.commands[f]){case fg.PATH_COMMAND_MOVE:s+=i.diffs[p++]*n,c+=i.diffs[p++]*n,e.moveTo(s,c);break;case fg.PATH_COMMAND_LINE:s+=i.diffs[p++]*n,c+=i.diffs[p++]*n,e.lineTo(s,c);break;case fg.PATH_COMMAND_QUAD:{let y=s+i.diffs[p++]*n,x=c+i.diffs[p++]*n;s=y+i.diffs[p++]*n,c=x+i.diffs[p++]*n,e.quadraticCurveTo(y,x,s,c);break}case fg.PATH_COMMAND_CUBIC:{let y=s+i.diffs[p++]*n,x=c+i.diffs[p++]*n,w=y+i.diffs[p++]*n,I=x+i.diffs[p++]*n;s=w+i.diffs[p++]*n,c=I+i.diffs[p++]*n,e.bezierCurveTo(y,x,w,I,s,c);break}case fg.PATH_COMMAND_CLOSE:e.closePath()}return e}function GA(i){return HA(i,new Path2D)}class Uv{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let n=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,n),n}put(e,n){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,n)}delete(e){this.cache.delete(e)}}_t(Uv,"LRUCache");class hw{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Si(e,e.data)}getFromCache(e,n,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new Uv(150)),this.cacheMap.get(s).get(_c(e.toString(),n))}setInCache(e,n,s,c){this.cacheDependenciesMap.has(c)||this.cacheDependenciesMap.set(c,new Map),this.cacheMap.has(c)||this.cacheMap.set(c,new Uv(150));let f=this.cacheDependenciesMap.get(c),p=_c(e.id.toString(),s);f.get(p)||f.set(p,new Set);let y=this.cacheMap.get(c),x=e.toString();f.get(p).add(x),y.put(_c(e.toString(),s),n)}removeImagesFromCacheByIds(e,n,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;let c=this.cacheMap.get(s),f=this.cacheDependenciesMap.get(s);for(let p of e){let y=_c(p.toString(),n);if(f.has(y)){for(let x of f.get(y))c.delete(x);f.delete(y)}}}rasterize(e,n,s,c,f=xz){let p=this.getFromCache(e,s,c);if(p)return p.clone();let y=f(n.icon,e.options),x=hw._getImage(y);return this.setInCache(e,x,s,c),x.clone()}}class $A{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,n){let s=this.toIdx(e,n);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,n){return this.leaves[this.toIdx(e,n)]}toIdx(e,n){return n*this.size+e}}function WA(i,e,n,s){let c=0,f=Number.MAX_VALUE;for(let p=0;p<3;p++)if(Math.abs(s[p])<1e-15){if(n[p]<i[p]||n[p]>e[p])return null}else{let y=1/s[p],x=(i[p]-n[p])*y,w=(e[p]-n[p])*y;if(x>w){let I=x;x=w,w=I}if(x>c&&(c=x),w<f&&(f=w),c>f)return null}return c}function ZA(i,e,n,s,c,f,p,y,x,w,I){let S=s-i,D=c-e,P=f-n,O=p-i,N=y-e,B=x-n,G=I[1]*B-I[2]*N,X=I[2]*O-I[0]*B,q=I[0]*N-I[1]*O,K=S*G+D*X+P*q;if(Math.abs(K)<1e-15)return null;let he=1/K,le=w[0]-i,ue=w[1]-e,ge=w[2]-n,ye=(le*G+ue*X+ge*q)*he;if(ye<0||ye>1)return null;let ke=ue*P-ge*D,be=ge*S-le*P,ze=le*D-ue*S,et=(I[0]*ke+I[1]*be+I[2]*ze)*he;return et<0||ye+et>1?null:(O*ke+N*be+B*ze)*he}function qA(i,e,n){return(i-e)/(n-e)}function XA(i,e,n,s,c,f,p,y,x){let w=1<<n,I=f-s,S=p-c,D=(i+1)/w*I+s,P=(e+0)/w*S+c,O=(e+1)/w*S+c;y[0]=(i+0)/w*I+s,y[1]=P,x[0]=D,x[1]=O}class YA{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let n=function(f){let p=Math.ceil(Math.log2(f.dim/8)),y=[],x=Math.ceil(Math.pow(2,p)),w=1/x,I=(P,O,N,B,G)=>{let X=B?1:0,q=(P+1)*N-X,K=O*N,he=(O+1)*N-X;G[0]=P*N,G[1]=K,G[2]=q,G[3]=he},S=new $A(x),D=[];for(let P=0;P<x*x;P++){I(P%x,Math.floor(P/x),w,!1,D);let O=Nc(D[0],D[1],f),N=Nc(D[2],D[1],f),B=Nc(D[2],D[3],f),G=Nc(D[0],D[3],f);S.minimums.push(Math.min(O,N,B,G)),S.maximums.push(Math.max(O,N,B,G)),S.leaves.push(1)}for(y.push(S),x/=2;x>=1;x/=2){let P=y[y.length-1];S=new $A(x);for(let O=0;O<x*x;O++){I(O%x,Math.floor(O/x),2,!0,D);let N=P.getElevation(D[0],D[1]),B=P.getElevation(D[2],D[1]),G=P.getElevation(D[2],D[3]),X=P.getElevation(D[0],D[3]),q=P.isLeaf(D[0],D[1]),K=P.isLeaf(D[2],D[1]),he=P.isLeaf(D[2],D[3]),le=P.isLeaf(D[0],D[3]),ue=Math.min(N.min,B.min,G.min,X.min),ge=Math.max(N.max,B.max,G.max,X.max),ye=q&&K&&he&&le;S.maximums.push(ge),S.minimums.push(ue),S.leaves.push(ge-ue<=5&&ye?1:0)}y.push(S)}return y}(this.dem),s=n.length-1,c=n[s];this._addNode(c.minimums[0],c.maximums[0],c.leaves[0]),this._construct(n,0,0,s,0)}raycastRoot(e,n,s,c,f,p,y=1){return WA([e,n,-100],[s,c,this.maximums[0]*y],f,p)}raycast(e,n,s,c,f,p,y=1){if(!this.nodeCount)return null;let x=this.raycastRoot(e,n,s,c,f,p,y);if(x==null)return null;let w=[],I=[],S=[],D=[],P=[{idx:0,t:x,nodex:0,nodey:0,depth:0}];for(;P.length>0;){let{idx:O,t:N,nodex:B,nodey:G,depth:X}=P.pop();if(this.leaves[O]){XA(B,G,X,e,n,s,c,S,D);let K=1<<X,he=(B+0)/K,le=(B+1)/K,ue=(G+0)/K,ge=(G+1)/K,ye=Nc(he,ue,this.dem)*y,ke=Nc(le,ue,this.dem)*y,be=Nc(le,ge,this.dem)*y,ze=Nc(he,ge,this.dem)*y,et=ZA(S[0],S[1],ye,D[0],S[1],ke,D[0],D[1],be,f,p),Ue=ZA(D[0],D[1],be,S[0],D[1],ze,S[0],S[1],ye,f,p),Ze=Math.min(et!==null?et:Number.MAX_VALUE,Ue!==null?Ue:Number.MAX_VALUE);if(Ze!==Number.MAX_VALUE)return Ze;{let Je=zi([],f,p,N);if(KA(ye,ke,ze,be,qA(Je[0],S[0],D[0]),qA(Je[1],S[1],D[1]))>=Je[2])return N}continue}let q=0;for(let K=0;K<this._siblingOffset.length;K++){XA((B<<1)+this._siblingOffset[K][0],(G<<1)+this._siblingOffset[K][1],X+1,e,n,s,c,S,D),S[2]=-100,D[2]=this.maximums[this.childOffsets[O]+K]*y;let he=WA(S,D,f,p);if(he!=null){let le=he;w[K]=le;let ue=!1;for(let ge=0;ge<q&&!ue;ge++)le>=w[I[ge]]&&(I.splice(ge,0,K),ue=!0);ue||(I[q]=K),q++}}for(let K=0;K<q;K++){let he=I[K];P.push({idx:this.childOffsets[O]+he,t:w[he],nodex:(B<<1)+this._siblingOffset[he][0],nodey:(G<<1)+this._siblingOffset[he][1],depth:X+1})}}return null}_addNode(e,n,s){return this.minimums.push(e),this.maximums.push(n),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,n,s,c,f){if(e[c].isLeaf(n,s)===1)return;this.childOffsets[f]||(this.childOffsets[f]=this.nodeCount);let p=c-1,y=e[p],x=0,w=0;for(let I=0;I<this._siblingOffset.length;I++){let S=2*n+this._siblingOffset[I][0],D=2*s+this._siblingOffset[I][1],P=y.getElevation(S,D),O=y.isLeaf(S,D),N=this._addNode(P.min,P.max,O);O&&(x|=1<<I),w||(w=N)}for(let I=0;I<this._siblingOffset.length;I++)x&1<<I||this._construct(e,2*n+this._siblingOffset[I][0],2*s+this._siblingOffset[I][1],p,w+I)}}function KA(i,e,n,s,c,f){return At(At(i,n,f),At(e,s,f),c)}function Nc(i,e,n){let s=n.dim,c=ne(i*s-.5,0,s-1),f=ne(e*s-.5,0,s-1),p=Math.floor(c),y=Math.floor(f),x=Math.min(p+1,s-1),w=Math.min(y+1,s-1);return KA(n.get(p,y),n.get(x,y),n.get(p,w),n.get(x,w),c-p,f-y)}let bz={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function wz(i,e,n){return(256*i*256+256*e+n)/10-1e4}function Ez(i,e,n){return 256*i+e+n/256-32768}class jv{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,n,s,c=!1){if(this.uid=e,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void fn(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;let f=this.dim=n.height-2,p=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.floatView=new Float32Array(n.data.buffer),this.borderReady=c,this._modifiedForSources={},!c){for(let x=0;x<f;x++)p[this._idx(-1,x)]=p[this._idx(0,x)],p[this._idx(f,x)]=p[this._idx(f-1,x)],p[this._idx(x,-1)]=p[this._idx(x,0)],p[this._idx(x,f)]=p[this._idx(x,f-1)];p[this._idx(-1,-1)]=p[this._idx(0,0)],p[this._idx(f,-1)]=p[this._idx(f-1,0)],p[this._idx(-1,f)]=p[this._idx(0,f-1)],p[this._idx(f,f)]=p[this._idx(f-1,f-1)]}let y=s==="terrarium"?Ez:wz;for(let x=0;x<p.length;++x){let w=4*x;this.floatView[x]=y(this.pixels[w],this.pixels[w+1],this.pixels[w+2])}this._timestamp=cs.now()}_buildQuadTree(){this._tree=new YA(this)}get(e,n,s=!1){s&&(e=ne(e,-1,this.dim),n=ne(n,-1,this.dim));let c=this._idx(e,n);return this.floatView[c]}set(e,n,s){let c=this._idx(e,n),f=this.floatView[c];return this.floatView[c]=s,s-f}static getUnpackVector(e){return bz[e]}_idx(e,n){if(e<-1||e>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(e+1)}static pack(e,n){let s=[0,0,0,0],c=jv.getUnpackVector(n),f=Math.floor((e+c[3])/c[2]);return s[2]=f%256,f=Math.floor(f/256),s[1]=f%256,f=Math.floor(f/256),s[0]=f,s}getPixels(){return new WS({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,n,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let c=n*this.dim,f=n*this.dim+this.dim,p=s*this.dim,y=s*this.dim+this.dim;switch(n){case-1:c=f-1;break;case 1:f=c+1}switch(s){case-1:p=y-1;break;case 1:y=p+1}let x=-n*this.dim,w=-s*this.dim;for(let I=p;I<y;I++)for(let S=c;S<f;S++){let D=4*this._idx(S,I),P=4*this._idx(S+x,I+w);this.pixels[D+0]=e.pixels[P+0],this.pixels[D+1]=e.pixels[P+1],this.pixels[D+2]=e.pixels[P+2],this.pixels[D+3]=e.pixels[P+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function Tz(i,e,n){i===1?e.headerLength=n.readFixed32():i===2?e.x=n.readVarint():i===3?e.y=n.readVarint():i===4?e.z=n.readVarint():i===5&&e.layers.push(function(s,c){return s.readFields(Az,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},c)}(n,n.readVarint()+n.pos))}function Iz(i,e,n){i===1?(e.delta_filter=function(s,c){return s.readFields(Sz,{blockSize:0},c)}(n,n.readVarint()+n.pos),e.filter="delta_filter"):i===2?(n.readVarint(),e.filter="zigzag_filter"):i===3?(n.readVarint(),e.filter="bitshuffle_filter"):i===4&&(n.readVarint(),e.filter="byteshuffle_filter")}function Sz(i,e,n){i===1&&(e.blockSize=n.readVarint())}function Dz(i,e,n){i===1?(n.readVarint(),e.codec="gzip_data"):i===2?(n.readVarint(),e.codec="jpeg_image"):i===3?(n.readVarint(),e.codec="webp_image"):i===4&&(n.readVarint(),e.codec="png_image")}function Cz(i,e,n){let s=0,c=0;i===1?e.firstByte=n.readFixed64():i===2?e.lastByte=n.readFixed64():i===3?e.filters.push(function(f,p){return f.readFields(Iz,{},p)}(n,n.readVarint()+n.pos)):i===4?e.codec=function(f,p){return f.readFields(Dz,{},p)}(n,n.readVarint()+n.pos):i===5?c=n.readFloat():i===6?s=n.readFloat():i===7?e.bands.push(n.readString()):i===8?e.offset=n.readDouble():i===9&&(e.scale=n.readDouble()),e.offset===0&&(e.offset=c),e.scale===0&&(e.scale=s)}function Az(i,e,n){i===1?e.version=n.readVarint():i===2?e.name=n.readString():i===3?e.units=n.readString():i===4?e.tileSize=n.readVarint():i===5?e.buffer=n.readVarint():i===6?e.pixelFormat=n.readVarint():i===7&&e.dataIndex.push(function(s,c){return s.readFields(Cz,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},c)}(n,n.readVarint()+n.pos))}function Mz(i,e,n){if(i===2)(function(s,c,f){s.readFields(Rz,f,c)})(n,n.readVarint()+n.pos,e);else if(i===3)throw new Error("Not implemented")}function Rz(i,e,n){if(i===1){let s=0,c=n.readVarint()+n.pos;for(;n.pos<c;)e[s++]=n.readVarint()}}function Pz(i,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let n=e[3];for(let s=2;s>=1;s--){let c=s===1?1:0,f=s===2?1:0;for(let p=0;p<e[0];p++){let y=e[1]*p;for(let x=c;x<e[1];x++){let w=e[2]*(x+y);for(let I=f;I<e[2];I++){let S=e[3]*(I+w);for(let D=0;D<e[3];D++){let P=S+D;i[P]+=i[P-n]}}}}n*=e[s]}return i}function Oz(i){for(let e=0,n=i.length;e<n;e++)i[e]=i[e]>>>1^-(1&i[e]);return i}function Lz(i,e){switch(e){case"uint32":return i;case"uint16":for(let n=0;n<i.length;n+=2){let s=i[n],c=i[n+1];i[n]=(240&s)>>4|(61440&s)>>8|(240&c)<<4|61440&c,i[n+1]=15&s|(3840&s)>>4|(15&c)<<8|(3840&c)<<4}return i;case"uint8":for(let n=0;n<i.length;n+=4){let s=i[n],c=i[n+1],f=i[n+2],p=i[n+3];i[n+0]=(192&s)>>6|(192&c)>>4|(192&f)>>2|192&p,i[n+1]=(48&s)>>4|(48&c)>>2|48&f|(48&p)<<2,i[n+2]=(12&s)>>2|12&c|(12&f)<<2|(12&p)<<4,i[n+3]=3&s|(3&c)<<2|(3&f)<<4|(3&p)<<6}return i;default:throw new Error(`Invalid pixel format, "${e}"`)}}_t(jv,"DEMData"),_t(YA,"DemMinMaxQuadTree",{omit:["dem"]});var ps=Uint8Array,mg=Uint16Array,Fz=Int32Array,JA=new ps([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),QA=new ps([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),kz=new ps([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),eM=function(i,e){for(var n=new mg(31),s=0;s<31;++s)n[s]=e+=1<<i[s-1];var c=new Fz(n[30]);for(s=1;s<30;++s)for(var f=n[s];f<n[s+1];++f)c[f]=f-n[s]<<5|s;return{b:n,r:c}},tM=eM(JA,2),nM=tM.b,Nz=tM.r;nM[28]=258,Nz[258]=28;for(var zz=eM(QA,0).b,rM=new mg(32768),oi=0;oi<32768;++oi){var ff=(43690&oi)>>1|(21845&oi)<<1;rM[oi]=((65280&(ff=(61680&(ff=(52428&ff)>>2|(13107&ff)<<2))>>4|(3855&ff)<<4))>>8|(255&ff)<<8)>>1}var gg=function(i,e,n){for(var s=i.length,c=0,f=new mg(e);c<s;++c)i[c]&&++f[i[c]-1];var p,y=new mg(e);for(c=1;c<e;++c)y[c]=y[c-1]+f[c-1]<<1;p=new mg(1<<e);var x=15-e;for(c=0;c<s;++c)if(i[c])for(var w=c<<4|i[c],I=e-i[c],S=y[i[c]-1]++<<I,D=S|(1<<I)-1;S<=D;++S)p[rM[S]>>x]=w;return p},_g=new ps(288);for(oi=0;oi<144;++oi)_g[oi]=8;for(oi=144;oi<256;++oi)_g[oi]=9;for(oi=256;oi<280;++oi)_g[oi]=7;for(oi=280;oi<288;++oi)_g[oi]=8;var iM=new ps(32);for(oi=0;oi<32;++oi)iM[oi]=5;var Bz=gg(_g,9),Vz=gg(iM,5),fw=function(i){for(var e=i[0],n=1;n<i.length;++n)i[n]>e&&(e=i[n]);return e},Xs=function(i,e,n){var s=e/8|0;return(i[s]|i[s+1]<<8)>>(7&e)&n},pw=function(i,e){var n=e/8|0;return(i[n]|i[n+1]<<8|i[n+2]<<16)>>(7&e)},Uz=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ys=function(i,e,n){var s=new Error(e||Uz[i]);if(s.code=i,Error.captureStackTrace&&Error.captureStackTrace(s,Ys),!n)throw s;return s},jz=new ps(0),Hz=typeof TextDecoder<"u"&&new TextDecoder;try{Hz.decode(jz,{stream:!0})}catch{}let Gz={gzip_data:"gzip"};class Ms extends Error{constructor(e){super(e),this.name="MRTError"}}let $z={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},oM={uint32:1,uint16:2,uint8:4},Wz={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},mw;class Hv{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){let n=this.layers[e];if(!n)throw new Ms(`Layer '${e}' not found`);return n}getHeaderLength(e){let n=new Uint8Array(e),s=new DataView(e);if(n[0]!==13)throw new Ms("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){let n=new Uint8Array(e),s=this.getHeaderLength(e);if(n.length<s)throw new Ms(`Expected header with length >= ${s} but got buffer of length ${n.length}`);let c=new mw(n.subarray(0,s)).readFields(Tz,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==c.x||this.y!==c.y||this.z!==c.z))throw new Ms(`Invalid attempt to parse header ${c.z}/${c.x}/${c.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=c.x,this.y=c.y,this.z=c.z;for(let f of c.layers)this.layers[f.name]=new sM(f,{cacheSize:this._cacheSize});return this}createDecodingTask(e){let n=[],s=this.getLayer(e.layerName);for(let c of e.blockIndices){let f=s.dataIndex[c],p=f.firstByte-e.firstByte,y=f.lastByte-e.firstByte;if(s._blocksInProgress.has(c))continue;let x={layerName:s.name,firstByte:p,lastByte:y,pixelFormat:s.pixelFormat,blockIndex:c,blockShape:[f.bands.length].concat(s.bandShape),buffer:s.buffer,codec:f.codec.codec,filters:f.filters.map(w=>w.filter)};s._blocksInProgress.add(c),n.push(x)}return new aM(n,()=>{n.forEach(c=>s._blocksInProgress.delete(c.blockIndex))},(c,f)=>{if(n.forEach(p=>s._blocksInProgress.delete(p.blockIndex)),c)throw c;f.forEach(p=>{this.getLayer(p.layerName).processDecodedData(p)})})}}class sM{constructor({version:e,name:n,units:s,tileSize:c,pixelFormat:f,buffer:p,dataIndex:y},x){if(this.version=e,this.version!==1)throw new Ms(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=n,this.units=s,this.tileSize=c,this.buffer=p,this.pixelFormat=$z[f],this.dataIndex=y,this.bandShape=[c+2*p,c+2*p,oM[this.pixelFormat]],this._decodedBlocks=new Uv(x?x.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return oM[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){let n=e.blockIndex.toString();this._decodedBlocks.get(n)||this._decodedBlocks.put(n,e.data)}getBlockForBand(e){let n=0;switch(typeof e){case"string":for(let[s,c]of this.dataIndex.entries()){for(let[f,p]of c.bands.entries())if(p===e)return{bandIndex:n+f,blockIndex:s,blockBandIndex:f};n+=c.bands.length}break;case"number":for(let[s,c]of this.dataIndex.entries()){if(e>=n&&e<n+c.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-n};n+=c.bands.length}break;default:throw new Ms(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let n=1/0,s=-1/0,c=[],f=new Set;for(let p of e){let{blockIndex:y}=this.getBlockForBand(p);if(y<0)throw new Ms(`Invalid band: ${JSON.stringify(p)}`);let x=this.dataIndex[y];c.includes(y)||c.push(y),f.add(y),n=Math.min(n,x.firstByte),s=Math.max(s,x.lastByte)}if(f.size>this.cacheSize)throw new Ms(`Number of blocks to decode (${f.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:n,lastByte:s,blockIndices:c}}hasBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0}hasDataForBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0&&!!this._decodedBlocks.get(n.toString())}getBandView(e){let{blockIndex:n,blockBandIndex:s}=this.getBlockForBand(e);if(n<0)throw new Ms(`Band not found: ${JSON.stringify(e)}`);let c=this._decodedBlocks.get(n.toString());if(!c)throw new Ms(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);let f=this.dataIndex[n],p=this.bandShape.reduce((w,I)=>w*I,1),y=s*p,x=c.subarray(y,y+p);return{data:x,bytes:new Uint8Array(x.buffer).subarray(x.byteOffset,x.byteOffset+x.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:f.offset,scale:f.scale}}}Hv.setPbf=function(i){mw=i};class aM{constructor(e,n,s){this.tasks=e,this._onCancel=n,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,n){this._finalized||(this._onComplete(e,n),this._finalized=!0)}}Hv.performDecoding=function(i,e){let n=new Uint8Array(i);return Promise.all(e.tasks.map(s=>{let{layerName:c,firstByte:f,lastByte:p,pixelFormat:y,blockShape:x,blockIndex:w,filters:I,codec:S}=s,D=n.subarray(f,p+1),P=new Uint32Array(x[0]*x[1]*x[2]),O;if(S!=="gzip_data")throw new Ms(`Unhandled codec: ${S}`);return O=function(N,B){if(!globalThis.DecompressionStream&&B==="gzip_data")return Promise.resolve(((K=function(ue){ue[0]==31&&ue[1]==139&&ue[2]==8||Ys(6,"invalid gzip data");var ge=ue[3],ye=10;4&ge&&(ye+=2+(ue[10]|ue[11]<<8));for(var ke=(ge>>3&1)+(ge>>4&1);ke>0;ke-=!ue[ye++]);return ye+(2&ge)}(q=N))+8>q.length&&Ys(6,"invalid gzip data"),function(ue,ge,ye,ke){var be=ue.length;if(!be||ge.f&&!ge.l)return ye||new ps(0);var ze=!ye,et=ze||ge.i!=2,Ue=ge.i;ze&&(ye=new ps(3*be));var Ze,Je,Le=function(vr){var rr=ye.length;if(vr>rr){var er=new ps(Math.max(2*rr,vr));er.set(ye),ye=er}},qe=ge.f||0,we=ge.p||0,Fe=ge.b||0,rt=ge.l,Ye=ge.d,Et=ge.m,yt=ge.n,$e=8*be;do{if(!rt){qe=Xs(ue,we,1);var Ke=Xs(ue,we+1,3);if(we+=3,!Ke){var xt=ue[(Q=4+((we+7)/8|0))-4]|ue[Q-3]<<8,pt=Q+xt;if(pt>be){Ue&&Ys(0);break}et&&Le(Fe+xt),ye.set(ue.subarray(Q,pt),Fe),ge.b=Fe+=xt,ge.p=we=8*pt,ge.f=qe;continue}if(Ke==1)rt=Bz,Ye=Vz,Et=9,yt=5;else if(Ke==2){var at=Xs(ue,we,31)+257,mt=Xs(ue,we+10,15)+4,Rt=at+Xs(ue,we+5,31)+1;we+=14;for(var Bt=new ps(Rt),qt=new ps(19),Gt=0;Gt<mt;++Gt)qt[kz[Gt]]=Xs(ue,we+3*Gt,7);we+=3*mt;var pn=fw(qt),nn=(1<<pn)-1,nr=gg(qt,pn);for(Gt=0;Gt<Rt;){var Q,ee=nr[Xs(ue,we,nn)];if(we+=15&ee,(Q=ee>>4)<16)Bt[Gt++]=Q;else{var Re=0,it=0;for(Q==16?(it=3+Xs(ue,we,3),we+=2,Re=Bt[Gt-1]):Q==17?(it=3+Xs(ue,we,7),we+=3):Q==18&&(it=11+Xs(ue,we,127),we+=7);it--;)Bt[Gt++]=Re}}var ct=Bt.subarray(0,at),lt=Bt.subarray(at);Et=fw(ct),yt=fw(lt),rt=gg(ct,Et),Ye=gg(lt,yt)}else Ys(1);if(we>$e){Ue&&Ys(0);break}}et&&Le(Fe+131072);for(var vt=(1<<Et)-1,Ft=(1<<yt)-1,cn=we;;cn=we){var un=(Re=rt[pw(ue,we)&vt])>>4;if((we+=15&Re)>$e){Ue&&Ys(0);break}if(Re||Ys(2),un<256)ye[Fe++]=un;else{if(un==256){cn=we,rt=null;break}var Jt=un-254;un>264&&(Jt=Xs(ue,we,(1<<(Xt=JA[Gt=un-257]))-1)+nM[Gt],we+=Xt);var Hn=Ye[pw(ue,we)&Ft],Er=Hn>>4;if(Hn||Ys(3),we+=15&Hn,lt=zz[Er],Er>3){var Xt=QA[Er];lt+=pw(ue,we)&(1<<Xt)-1,we+=Xt}if(we>$e){Ue&&Ys(0);break}et&&Le(Fe+131072);var ar=Fe+Jt;if(Fe<lt){var Qn=0-lt,kn=Math.min(lt,ar);for(Qn+Fe<0&&Ys(3);Fe<kn;++Fe)ye[Fe]=(void 0)[Qn+Fe]}for(;Fe<ar;++Fe)ye[Fe]=ye[Fe-lt]}}ge.l=rt,ge.p=cn,ge.b=Fe,ge.f=qe,rt&&(qe=1,ge.m=Et,ge.d=Ye,ge.n=yt)}while(!qe);return Fe!=ye.length&&ze?(Ze=ye,((Je=Fe)==null||Je>Ze.length)&&(Je=Ze.length),new ps(Ze.subarray(0,Je))):ye.subarray(0,Fe)}(q.subarray(K,-8),{i:2},new ps(((G=q)[(X=G.length)-4]|G[X-3]<<8|G[X-2]<<16|G[X-1]<<24)>>>0))));var G,X,q,K;let he=Gz[B];if(!he)throw new Error(`Unhandled codec: ${B}`);let le=new globalThis.DecompressionStream(he);return new Response(new Blob([N]).stream().pipeThrough(le)).arrayBuffer().then(ue=>new Uint8Array(ue))}(D,S).then(N=>(function(B,G){B.readFields(Mz,G)}(new mw(N),P),new Wz[y](P.buffer))),O.then(N=>{for(let B=I.length-1;B>=0;B--)switch(I[B]){case"delta_filter":Pz(N,x);break;case"zigzag_filter":Oz(N);break;case"bitshuffle_filter":Lz(N,y);break;default:throw new Ms(`Unhandled filter "${I[B]}"`)}return{layerName:c,blockIndex:w,data:N}}).catch(N=>{throw N})}))},_t(aM,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),_t(Hv,"MapboxRasterTile"),_t(sM,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class lM{constructor(e){this._stringToNumber={},this._numberToString=[];for(let n=0;n<e.length;n++){let s=e[n];this._stringToNumber[s]=n,this._numberToString[n]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}let Zz=["id","tile","layer","source","sourceLayer","state"];class pf{constructor(e,n,s,c,f){this.type="Feature",this._vectorTileFeature=e,this._z=n,this._x=s,this._y=c,this.properties=e.properties,this.id=f}clone(){let e=new pf(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){let e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let n of Zz)this[n]!==void 0&&(e[n]=this[n]);return e}}class cM{constructor(e,n){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Aa(st,16,0),this.featureIndexArray=new By,this.promoteId=n,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,n,s,c,f,p=0,y=0){let x=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,c,f,p);let w=this.grid;for(let I=0;I<n.length;I++){let S=n[I],D=[1/0,1/0,-1/0,-1/0];for(let P=0;P<S.length;P++){let O=S[P];D[0]=Math.min(D[0],O.x),D[1]=Math.min(D[1],O.y),D[2]=Math.max(D[2],O.x),D[3]=Math.max(D[3],O.y)}y!==0&&(D[0]-=y,D[1]-=y,D[2]+=y,D[3]+=y),D[0]<st&&D[1]<st&&D[2]>=0&&D[3]>=0&&w.insert(x,D[0],D[1],D[2],D[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new bt(new _v(this.rawTileData)).layers,this.sourceLayerCoder=new lM(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,n){let{tilespaceGeometry:s,transform:c,tileTransform:f,pixelPosMatrix:p,availableImages:y,worldview:x}=n;this.loadVTLayers(),this.serializedLayersCache.clear();let w=s.bufferedTilespaceBounds,I=this.grid.query(w.min.x,w.min.y,w.max.x,w.max.y,(O,N,B,G)=>Or(s.bufferedTilespaceGeometry,O,N,B,G));I.sort(qz);let S=null;c.elevation&&I.length>0&&(S=uf.create(c.elevation,this.tileID));let D={},P;for(let O=0;O<I.length;O++){let N=I[O];if(N===P)continue;P=N;let B=this.featureIndexArray.get(N),G=null;this.is3DTile?this.loadMatchingModelFeature(D,B,e,s,c,x):this.loadMatchingFeature(D,B,e,y,x,(X,q,K,he=0)=>(G||(G=pe(X,this.tileID.canonical,f)),q.queryIntersectsFeature(s,X,K,G,this.z,c,p,S,he)))}return D}loadMatchingFeature(e,n,s,c,f,p){let{featureIndex:y,bucketIndex:x,sourceLayerIndex:w,layoutVertexArrayOffset:I}=n,S=this.bucketLayerIDs[x],D=s.layers,P=Object.keys(D);if(P.length&&!hn(P,S))return;let O=s.sourceCache,N=this.sourceLayerCoder.decode(w),B=this.vtLayers[N].feature(y),G=this.getId(B,N);for(let X=0;X<S.length;X++){let q=S[X];if(!D[q])continue;let{styleLayer:K,targets:he}=D[q],le={};G!==void 0&&(le=O.getFeatureState(K.sourceLayer,G));let ue=!p||p(B,K,le,I);if(!ue)continue;let ge=new pf(B,this.z,this.x,this.y,G);ge.tile=this.tileID.canonical,ge.state=le;let ye=this.serializedLayersCache.get(q);ye||(ye=K.serialize(),ye.id=q,this.serializedLayersCache.set(q,ye)),ge.source=ye.source,ge.sourceLayer=ye["source-layer"],ge.layer=Ce({},ye),ge.layer.paint=uM(ye.paint,K.paint,B,le,c),ge.layer.layout=uM(ye.layout,K.layout,B,le,c);let ke=!1;for(let be of he){this.updateFeatureProperties(ge,be);let{filter:ze}=be;if(ze){if(B.properties=ge.properties,ze.needGeometry){let et=Pe(B,!0);if(!ze.filter(new jn(this.tileID.overscaledZ,{worldview:f}),et,this.tileID.canonical))continue}else if(!ze.filter(new jn(this.tileID.overscaledZ,{worldview:f}),B))continue}ke=!0,be.targetId&&this.addFeatureVariant(ge,be)}ke&&this.appendToResult(e,q,y,ge,ue)}}loadMatchingModelFeature(e,n,s,c,f,p){let{featureIndex:y,bucketIndex:x}=n,w=this.bucketLayerIDs[x],I=s.layers,S=Object.keys(I);if(!S.length||hn(S,w))for(let D=0;D<w.length;D++){let P=w[D],{styleLayer:O,targets:N}=I[P];if(O.type!=="model")continue;let B=c.tile,G=B.getBucket(O);if(!(G&&G instanceof kv))continue;let X=QN(G,y,c,f);if(!X)continue;let{z:q,x:K,y:he}=B.tileID.canonical,{feature:le,intersectionZ:ue,position:ge}=X,ye={};le.id!==void 0&&(ye=s.sourceCache.getFeatureState(O.sourceLayer,le.id));let ke=new pf({},q,K,he,le.id);ke.tile=this.tileID.canonical,ke.state=ye,ke.properties=le.properties,ke.geometry={type:"Point",coordinates:[ge.lng,ge.lat]};let be=this.serializedLayersCache.get(P);be||(be=O.serialize(),be.id=P,this.serializedLayersCache.set(P,be)),ke.source=be.source,ke.sourceLayer=be["source-layer"],ke.layer=Ce({},be);let ze=!1;for(let et of N){this.updateFeatureProperties(ke,et);let{filter:Ue}=et;if(Ue){if(le.properties=ke.properties,Ue.needGeometry){if(!Ue.filter(new jn(this.tileID.overscaledZ,{worldview:p}),le,this.tileID.canonical))continue}else if(!Ue.filter(new jn(this.tileID.overscaledZ,{worldview:p}),le))continue}ze=!0,et.targetId&&this.addFeatureVariant(ke,et)}ze&&this.appendToResult(e,P,y,ke,ue)}}updateFeatureProperties(e,n,s){if(n.properties){let c={};for(let f in n.properties){let p=n.properties[f].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);p!=null&&(c[f]=p)}e.properties=c}}addFeatureVariant(e,n,s){let c={target:n.target,namespace:n.namespace,uniqueFeatureID:n.uniqueFeatureID};n.properties&&(c.properties=e.properties),e.variants=e.variants||{},e.variants[n.targetId]=e.variants[n.targetId]||[],e.variants[n.targetId].push(c)}appendToResult(e,n,s,c,f){let p=e[n];p===void 0&&(p=e[n]=[]),p.push({featureIndex:s,feature:c,intersectionZ:f})}lookupSymbolFeatures(e,n,s,c,f,p){let y={};this.loadVTLayers();for(let x of e)this.loadMatchingFeature(y,{bucketIndex:n,sourceLayerIndex:s,featureIndex:x,layoutVertexArrayOffset:0},c,f,p);return y}loadFeature(e){let{featureIndex:n,sourceLayerIndex:s}=e;this.loadVTLayers();let c=this.sourceLayerCoder.decode(s),f=this.vtFeatures[c];if(f[n])return f[n];let p=this.vtLayers[c].feature(n);return f[n]=p,p}hasLayer(e){for(let n of this.bucketLayerIDs)for(let s of n)if(e===s)return!0;return!1}getId(e,n){let s=e.id;if(this.promoteId){let c=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[n];if(c!=null)if(Array.isArray(c)){if(!this.promoteIdExpression){let f=pl(c);if(f.result!=="success"){let p=f.value.map(y=>`${y.key}: ${y.message}`).join(", ");return void fn(`Failed to create expression for promoteId: ${p}`)}this.promoteIdExpression=f.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Lu),s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[c];typeof s=="boolean"&&(s=Number(s))}return s}}function uM(i,e,n,s,c){return jt(i,(f,p)=>{let y=e instanceof hs?e.get(p):null;return y&&y.evaluate?y.evaluate(n,s,void 0,c):y})}function qz(i,e){return e-i}_t(cM,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let dM=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class gw{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[n,s]=new Uint8Array(e,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");let c=s>>4;if(c!==1)throw new Error(`Got v${c} data when expected v1.`);let f=dM[15&s];if(!f)throw new Error("Unrecognized array type.");let[p]=new Uint16Array(e,2,1),[y]=new Uint32Array(e,4,1);return new gw(y,p,f,e)}constructor(e,n=64,s=Float64Array,c){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;let f=dM.indexOf(this.ArrayType),p=2*e*this.ArrayType.BYTES_PER_ELEMENT,y=e*this.IndexArrayType.BYTES_PER_ELEMENT,x=(8-y%8)%8;if(f<0)throw new Error(`Unexpected typed array class: ${s}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+x,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+p+y+x),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+x,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+f]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=e)}add(e,n){let s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=n,s}finish(){let e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return _w(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,n,s,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:f,coords:p,nodeSize:y}=this,x=[0,f.length-1,0],w=[];for(;x.length;){let I=x.pop()||0,S=x.pop()||0,D=x.pop()||0;if(S-D<=y){for(let B=D;B<=S;B++){let G=p[2*B],X=p[2*B+1];G>=e&&G<=s&&X>=n&&X<=c&&w.push(f[B])}continue}let P=D+S>>1,O=p[2*P],N=p[2*P+1];O>=e&&O<=s&&N>=n&&N<=c&&w.push(f[P]),(I===0?e<=O:n<=N)&&(x.push(D),x.push(P-1),x.push(1-I)),(I===0?s>=O:c>=N)&&(x.push(P+1),x.push(S),x.push(1-I))}return w}within(e,n,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:c,coords:f,nodeSize:p}=this,y=[0,c.length-1,0],x=[],w=s*s;for(;y.length;){let I=y.pop()||0,S=y.pop()||0,D=y.pop()||0;if(S-D<=p){for(let B=D;B<=S;B++)fM(f[2*B],f[2*B+1],e,n)<=w&&x.push(c[B]);continue}let P=D+S>>1,O=f[2*P],N=f[2*P+1];fM(O,N,e,n)<=w&&x.push(c[P]),(I===0?e-s<=O:n-s<=N)&&(y.push(D),y.push(P-1),y.push(1-I)),(I===0?e+s>=O:n+s>=N)&&(y.push(P+1),y.push(S),y.push(1-I))}return x}}function _w(i,e,n,s,c,f){if(c-s<=n)return;let p=s+c>>1;hM(i,e,p,s,c,f),_w(i,e,n,s,p-1,1-f),_w(i,e,n,p+1,c,1-f)}function hM(i,e,n,s,c,f){for(;c>s;){if(c-s>600){let w=c-s+1,I=n-s+1,S=Math.log(w),D=.5*Math.exp(2*S/3),P=.5*Math.sqrt(S*D*(w-D)/w)*(I-w/2<0?-1:1);hM(i,e,n,Math.max(s,Math.floor(n-I*D/w+P)),Math.min(c,Math.floor(n+(w-I)*D/w+P)),f)}let p=e[2*n+f],y=s,x=c;for(yg(i,e,s,n),e[2*c+f]>p&&yg(i,e,s,c);y<x;){for(yg(i,e,y,x),y++,x--;e[2*y+f]<p;)y++;for(;e[2*x+f]>p;)x--}e[2*s+f]===p?yg(i,e,s,x):(x++,yg(i,e,x,c)),x<=n&&(s=x+1),n<=x&&(c=x-1)}}function yg(i,e,n,s){yw(i,n,s),yw(e,2*n,2*s),yw(e,2*n+1,2*s+1)}function yw(i,e,n){let s=i[e];i[e]=i[n],i[n]=s}function fM(i,e,n,s){let c=i-n,f=e-s;return c*c+f*f}r.$=fi,r.A=js,r.B=Gs,r.C=_c,r.D=Qh,r.E=ol,r.F=2,r.G=ig,r.H=BC,r.I=fo,r.J=va,r.K=class extends Fv{},r.L=sl,r.M=Py,r.N=Ah,r.O=Ch,r.P=Xe,r.Q=by,r.R=wu,r.S=im,r.T=P1,r.U=Zu,r.V=Fv,r.W=om,r.X=pl,r.Y=ph,r.Z=lc,r._=ac,r.a=function(i){return vi.API_CDN_URL_REGEX.test(i)},r.a$=je,r.a0=Dp,r.a1=qu,r.a2=Mh,r.a3=xy,r.a4=function(i){let e=i.value,n=[];if(!e)return n;let s=va(e);return s!=="string"?(n=n.concat([new Fv(i.key,e,`string expected, "${s}" found`)]),n):(ow(e,!0)||(n=n.concat([new Fv(i.key,e,`invalid url "${e}"`)])),n)},r.a5=xe,r.a6=Wu,r.a7=Mr,r.a8=tt,r.a9=class{constructor(i){this.specification=i}possiblyEvaluate(i,e){return Jr(i.expression.evaluate(e))}interpolate(i,e,n){return{x:At(i.x,e.x,n),y:At(i.y,e.y,n),z:At(i.z,e.z,n),azimuthal:At(i.azimuthal,e.azimuthal,n),polar:At(i.polar,e.polar,n)}}},r.aA=ho,r.aB=Fi,r.aC=Ii,r.aD=z,r.aE=me,r.aF=function(i,e){let n={};for(let s=0;s<e.length;s++){let c=e[s];c in i&&(n[c]=i[c])}return n},r.aG=L,r.aH=H,r.aI=class{constructor(i){this.entries={},this.scheduler=i}request(i,e,n,s){let c=this.entries[i]=this.entries[i]||{callbacks:[]};if(c.result){let[f,p]=c.result;return this.scheduler?this.scheduler.add(()=>{s(f,p)},e):s(f,p),()=>{}}return c.callbacks.push(s),c.cancel||(c.cancel=n((f,p)=>{c.result=[f,p];for(let y of c.callbacks)this.scheduler?this.scheduler.add(()=>{y(f,p)},e):y(f,p);setTimeout(()=>delete this.entries[i],3e3)})),()=>{c.result||(c.callbacks=c.callbacks.filter(f=>f!==s),c.callbacks.length||(c.cancel(),delete this.entries[i]))}}},r.aJ=function(i,e,n){let s=JSON.stringify(i.request);return i.data&&(this.deduped.entries[s]={result:[null,i.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:i.isSymbolTile,zoom:i.tileZoom},c=>{let f=Eu(i.request,(p,y,x,w)=>{p?c(p):y&&c(null,{vectorTile:n?void 0:new bt(new _v(y)),rawData:y,cacheControl:x,expires:w})});return()=>{f.cancel(),c()}},e)},r.aK=function(i){wp++,wp>Us&&(i.getActor().send("enforceCacheSizeLimit",us),wp=0)},r.aL=function(i){return i<=1?1:Math.pow(2,Math.floor(Math.log(i)/Math.LN2))},r.aM=ti,r.aN=pA,r.aO=xA,r.aP=fA,r.aQ=function(i,e){let n=document.createElement("video");n.muted=!0,n.onloadstart=function(){e(null,n)};for(let s=0;s<i.length;s++){let c=document.createElement("source");Ib(i[s])||(n.crossOrigin="Anonymous"),c.src=i[s],n.appendChild(c)}return{cancel:()=>{}}},r.aR=Jm,r.aS=function(i){return fetch(i).then(e=>e.arrayBuffer()).then(e=>$D(e,0,i))},r.aT=QD,r.aU=class{constructor(i,e,n,s){this.id=i,this.position=e!=null?new A(e[0],e[1]):new A(0,0),this.orientation=n??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(i,e){if(Vt(i.matrix,e,i.matrix),i.meshes)for(let n of i.meshes){let s=sn.applyTransformFast(n.aabb,i.matrix);this.aabb.encapsulate(s)}if(i.children)for(let n of i.children)this._applyTransformations(n,i.matrix)}computeBoundsAndApplyParent(){let i=Oe([]);for(let e of this.nodes)this._applyTransformations(e,i)}computeModelMatrix(i,e,n,s,c,f,p=!1){KD(this.matrix,this,i.transform,this.position,e,n,s,c,f,p)}upload(i){if(!this.uploaded){for(let e of this.nodes)F1(e,i);for(let e of this.nodes)gv(e);this.uploaded=!0}}destroy(){for(let i of this.nodes)k1(i)}},r.aV=kt,r.aW=ag,r.aX=Z,r.aY=Y,r.aZ=vc,r.a_=dr,r.aa=jn,r.ab=Ca,r.ac=se,r.ad=Nr,r.ae=Ei,r.af=_e,r.ag=hs,r.ah=Mc,r.ai=At,r.aj=st,r.ak=X_,r.al=Sn,r.am=Ln,r.an=class{constructor(i){this.specification=i}possiblyEvaluate(i,e){return function([n,s]){let c=Jr([1,n,s]);return{x:c.x,y:c.y,z:c.z}}(i.expression.evaluate(e))}interpolate(i,e,n){return{x:At(i.x,e.x,n),y:At(i.y,e.y,n),z:At(i.z,e.z,n)}}},r.ao=function(i,e,n=0,s=!0){let c=new Xe(n,n),f=i.sub(c),p=e.add(c),y=[f,new Xe(p.x,f.y),p,new Xe(f.x,p.y)];return s&&y.push(f.clone()),y},r.ap=function(i,e){let n=[];for(let s=0;s<i.length;s++){let c=Me(s-1,-1,i.length-1),f=Me(s+1,-1,i.length-1),p=i[s],y=i[f],x=i[c].sub(p).unit(),w=y.sub(p).unit(),I=w.angleWithSep(x.x,x.y),S=x.add(w).unit().mult(-1*e/Math.sin(I/2));n.push(p.add(S))}return n},r.aq=QC,r.ar=Or,r.as=function(i,e,n=0){return Zr(((e.x-n)*i.scale-i.x)*st,(e.y*i.scale-i.y)*st,J(e.z,e.y))},r.at=zr,r.au=cr,r.av=wn,r.aw=uC,r.ax=function(i){let e=1/0,n=1/0,s=-1/0,c=-1/0;for(let f of i)e=Math.min(e,f.x),n=Math.min(n,f.y),s=Math.max(s,f.x),c=Math.max(c,f.y);return{min:new Xe(e,n),max:new Xe(s,c)}},r.ay=ne,r.az=Vt,r.b=function(i){return vi.API_FONTS_REGEX.test(i)},r.b$=Y1,r.b0=ky,r.b1=Rv,r.b2=function(){Is.isLoading()||Is.isLoaded()||hm()!=="deferred"||Ay()},r.b3=mc,r.b4=Pe,r.b5=pf,r.b6=An,r.b7=B1,r.b8=_1,r.b9=pe,r.bA=function(i,e){let{x:n,y:s}=i.point,c=OS(n,s,i.worldSize/i._pixelsPerMercatorPixel,0,0);return Vt(c,c,a1(ka(e)))},r.bB=U,r.bC=lu,r.bD=function(i,e){return Math.hypot(e[0]-i[0],e[1]-i[1],e[2]-i[2])},r.bE=zi,r.bF=qr,r.bG=kr,r.bH=rg,r.bI=Bo,r.bJ=W1,r.bK=function(i,e,n,s,c){let f=5*e+2;i.float32[f+0]=n,i.float32[f+1]=s,i.float32[f+2]=c},r.bL=Mv,r.bM=Io,r.bN=pa,r.bO=fa,r.bP=So,r.bQ=Me,r.bR=function(i,e,n,s){var c=new k(4);return c[0]=i,c[1]=e,c[2]=n,c[3]=s,c},r.bS=lv,r.bT=Wn,r.bU=gi,r.bV=uD,r.bW=bA,r.bX=pD,r.bY=x1,r.bZ=$1,r.b_=WC,r.ba=io,r.bb=Sm,r.bc=DS,r.bd=_r,r.be=Kh,r.bf=rw,r.bg=function(i,e){let n=Mc(e.zoom);if(n===0)return ka(i);let s=Ky(i),c=s1(s),f=z(s.getWest())*e.worldSize,p=z(s.getEast())*e.worldSize,y=H(s.getNorth())*e.worldSize,x=H(s.getSouth())*e.worldSize,w=[f,y,0],I=[p,y,0],S=[f,x,0],D=[p,x,0],P=Ct([],e.globeMatrix);return Nr(w,w,P),Nr(I,I,P),Nr(S,S,P),Nr(D,D,P),c[0]=bl(c[0],S,n),c[1]=bl(c[1],D,n),c[2]=bl(c[2],I,n),c[3]=bl(c[3],w,n),sn.fromPoints(c)},r.bh=Qy,r.bi=Ct,r.bj=km,r.bk=bl,r.bl=yc,r.bm=SF,r.bn=bs,r.bo=Ut,r.bp=Hv,r.bq=_v,r.br=Eu,r.bs=function(i,e){let n=[];for(let s in i)s in e||n.push(s);return n},r.bt=ve,r.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],r.bv=Bs,r.bw=function(i){var e=new k(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e},r.bx=Oe,r.by=Rr,r.bz=ht,r.c=Xd,r.c$=45,r.c0=gw,r.c1=hr,r.c2=ha,r.c3=ks,r.c4=function(i,e,n){n*=.5;var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x+c*y,i[1]=c*x-s*y,i[2]=f*x+p*y,i[3]=p*x-f*y,i},r.c5=Qa,r.c6=wr,r.c7=function(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i[3]=e[3],i},r.c8=ws,r.c9=function(i,e,n,s,c){var f,p=1/Math.tan(e/2);return i[0]=p/n,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=p,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,c!=null&&c!==1/0?(i[10]=(c+s)*(f=1/(s-c)),i[14]=2*c*s*f):(i[10]=-1,i[14]=-2*s),i},r.cA=ko,r.cB=MS,r.cC=function(i,e,n,s,c,f,p,y,x){if(x.name==="globe")return MS(i,e,new ko(n,s,c),!1);let w=ag({z:n,x:s,y:c},x);return new sn([(f+w.x/w.scale)*e,e*(w.y/w.scale),p],[(f+w.x2/w.scale)*e,e*(w.y2/w.scale),y])},r.cD=function(i,e,n){return i[0]=Math.min(e[0],n[0]),i[1]=Math.min(e[1],n[1]),i[2]=Math.min(e[2],n[2]),i[3]=Math.min(e[3],n[3]),i},r.cE=function(i,e,n){return i[0]=Math.max(e[0],n[0]),i[1]=Math.max(e[1],n[1]),i[2]=Math.max(e[2],n[2]),i[3]=Math.max(e[3],n[3]),i},r.cF=function(i){let e=Math.round((i+45+360)%360/90)%4;return $[e]},r.cG=re,r.cH=Ls,r.cI=d,r.cJ=function(i){let e=Oe(new Float64Array(16));Vt(e,i.pixelMatrix,i.globeMatrix);let n=[0,g,0],s=[0,_,0];return Nr(n,n,e),Nr(s,s,e),[n[0]>0&&n[0]<=i.width&&n[1]>0&&n[1]<=i.height&&!c1(i,new A(i.center.lat,90)),s[0]>0&&s[0]<=i.width&&s[1]>0&&s[1]<=i.height&&!c1(i,new A(i.center.lat,-90))]},r.cK=function(i,e){let{scale:n}=i.tileTransform,s=n*st/(i.tileSize*Math.pow(2,e.zoom-i.tileID.overscaledZ+i.tileID.canonical.z));return function(c,f,p){var y=f[1],x=f[2],w=f[3],I=p[0],S=p[1];return c[0]=f[0]*I,c[1]=y*I,c[2]=x*S,c[3]=w*S,c}(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},r.cL=pv,r.cM=Zd,r.cN=WD,r.cO=function(i){let e=WD(i,!0);return U([],[e[0],e[1],e[4],e[5]])},r.cP=Nt,r.cQ=Dn,r.cR=li,r.cS=function(i){let{x:e,y:n}=i.point,{lng:s,lat:c}=i._center;return OS(e,n,i.worldSize,s,c)},r.cT=au,r.cU=De,r.cV=No,r.cW=Dr,r.cX=qy,r.cY=function(i,e,n){let s=0;for(let c=0;c<2;++c)i[c]>0&&(s+=(i[c]-0)*(i[c]-0)),e[c]<0&&(s+=(0-e[c])*(0-e[c]));return s},r.cZ=function(i){return i*i*i*i*i},r.c_=V,r.ca=function(i,e,n,s,c,f,p){var y=1/(e-n),x=1/(s-c),w=1/(f-p);return i[0]=-2*y,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*x,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*w,i[11]=0,i[12]=(e+n)*y,i[13]=(c+s)*x,i[14]=(p+f)*w,i[15]=1,i},r.cb=j,r.cc=function(i,e,n){i[4*e+0]=n[0],i[4*e+1]=n[1],i[4*e+2]=n[2],i[4*e+3]=n[3]},r.cd=Yh,r.ce=Sc,r.cf=Hr,r.cg=Cs,r.ch=nd,r.ci=A,r.cj=iA,r.ck=function(){var i=new k(4);return k!=Float32Array&&(i[1]=0,i[2]=0),i[0]=1,i[3]=1,i},r.cl=function(i,e,n){var s=e[0],c=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return i[0]=s*x+f*y,i[1]=c*x+p*y,i[2]=s*-y+f*x,i[3]=c*-y+p*x,i},r.cm=function(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]&&i[3]===e[3]},r.cn=qo,r.co=function(i){return Math.hypot(i[0],i[1],i[2],i[3])},r.cp=Ns,r.cq=da,r.cr=As,r.cs=3,r.ct=2,r.cu=7,r.cv=6,r.cw=Yi,r.cx=zn,r.cy=Mn,r.cz=ZD,r.d=function(i){return vi.API_TILEJSON_REGEX.test(i)},r.d$=(i,e,n,s,c,f,p,y,x,w)=>{let I=i.transform,S=I.calculatePixelsToTileUnitsMatrix(e),D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none",P=I.pitch<15?dC(.07,.7,ne((14-I.zoom)/5,0,1)):.07;return{u_matrix:fC(i,e,n,s),u_pixels_to_tile_units:S,u_device_pixel_ratio:f,u_width_scale:p,u_floor_width_scale:y,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:c,u_texsize:mC(n)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:hC(e,i.transform),u_alpha_discard_threshold:0,u_trim_offset:x,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:P,u_tile_to_meter:oe(e.tileID.canonical,0),u_ground_shadow_factor:w}},r.d0=td,r.d1=function(i,e,n){let s=Math.sqrt(i*i+e*e+n*n),c=s>0?Math.acos(n/s)*pu:0,f=i!==0||e!==0?Math.atan2(-e,-i)*pu+90:0;return f<0&&(f+=360),[s,f,c]},r.d2=Zr,r.d3=Jr,r.d4=oe,r.d5=mr,r.d6=sn,r.d7=uo,r.d8=function(i){return[Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)]},r.d9=ow,r.dA=Ky,r.dB=function(i){let e=re-5;i=ne(i,-e,e)/e*90;let n=Math.pow(Math.abs(Math.sin(Sn(i))),3);return Math.round(n*(h.length-1))},r.dC=function(i,e,n,s){let c=e.getNorth(),f=e.getSouth(),p=e.getWest(),y=e.getEast(),x=1<<i.z,w=y-p,I=c-f,S=w/o,D=-I/h[n],P=[0,S,0,D,0,0,c,p,0];if(i.z>0){let O=180/s;Be(P,P,[O/w+1,0,0,0,O/I+1,0,-.5*O/S,.5*O/D,1])}return P[2]=x,P[5]=i.x,P[8]=i.y,P},r.dD=ka,r.dE=function(i,e,n){let s=Oe(new Float64Array(16)),c=(e/(1<<i)-.5)*Math.PI*2;return ci(s,n.globeMatrix,c),Float32Array.from(s)},r.dF=class{isDataAvailableAtPoint(i){let e=this._source();if(this.isUsingMockSource()||!e||i.y<0||i.y>1)return!1;let n=e.getSource().maxzoom,s=1<<n,c=Math.floor(i.x),f=Math.floor((i.x-c)*s),p=Math.floor(i.y*s),y=this.findDEMTileFor(new ti(n,c,n,f,p));return!(!y||!y.dem)}getAtPointOrZero(i,e=0){return this.getAtPoint(i,e)||0}getAtPoint(i,e,n=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);let s=this._source();if(!s||i.y<0||i.y>1)return e;let c=s.getSource().maxzoom,f=1<<c,p=Math.floor(i.x),y=i.x-p,x=new ti(c,p,c,Math.floor(y*f),Math.floor(i.y*f)),w=this.findDEMTileFor(x);if(!w||!w.dem)return e;let I=w.dem,S=1<<w.tileID.canonical.z,D=(y*S-w.tileID.canonical.x)*I.dim,P=(i.y*S-w.tileID.canonical.y)*I.dim,O=Math.floor(D),N=Math.floor(P);return(n?this.exaggeration():1)*At(At(I.get(O,N),I.get(O,N+1),P-N),At(I.get(O+1,N),I.get(O+1,N+1),P-N),D-O)}getAtTileOffset(i,e,n){let s=1<<i.canonical.z;return this.getAtPointOrZero(new se(i.wrap+(i.canonical.x+e/st)/s,(i.canonical.y+n/st)/s))}getAtTileOffsetFunc(i,e,n,s){return c=>{let f=this.getAtTileOffset(i,c.x,c.y),p=s.upVector(i.canonical,c.x,c.y);return hr(p,p,f*s.upVectorScale(i.canonical,e,n).metersToTile),p}}getForTilePoints(i,e,n,s){if(this.isUsingMockSource())return!1;let c=uf.create(this,i,s);return!!c&&(e.forEach(f=>{f[2]=this.exaggeration()*c.getElevationAt(f[0],f[1],n)}),!0)}getMinMaxForTile(i){if(this.isUsingMockSource())return null;let e=this.findDEMTileFor(i);if(!e||!e.dem)return null;let n=e.dem.tree,s=e.tileID,c=1<<i.canonical.z-s.canonical.z,f=i.canonical.x/c-s.canonical.x,p=i.canonical.y/c-s.canonical.y,y=0;for(let x=0;x<i.canonical.z-s.canonical.z&&!n.leaves[y];x++){f*=2,p*=2;let w=2*Math.floor(p)+Math.floor(f);y=n.childOffsets[y]+w,f%=1,p%=1}return{min:this.exaggeration()*n.minimums[y],max:this.exaggeration()*n.maximums[y]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(i,e,n){throw new Error("Pure virtual method called.")}pointCoordinate(i){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(i){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let i=this.visibleDemTiles;if(i.length===0)return null;let e=!1,n=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let c of i){let f=this.getMinMaxForTile(c.tileID);f&&(n=Math.min(n,f.min),s=Math.max(s,f.max),e=!0)}return e?{min:n,max:s}:null}},r.dG=WS,r.dH=Yy,r.dI=function(i,e){return[Math.pow(i[0],2.2)*e,Math.pow(i[1],2.2)*e,Math.pow(i[2],2.2)*e]},r.dJ=ae,r.dK=function(i,e){var n=Math.sin(e),s=Math.cos(e);return i[0]=s,i[1]=n,i[2]=0,i[3]=-n,i[4]=s,i[5]=0,i[6]=0,i[7]=0,i[8]=1,i},r.dL=ua,r.dM=PS,r.dN=Qi,r.dO=Ri,r.dP=256,r.dQ=function(i,e){let n=[0,0,0];return Nr(n,n,Qy(ka(e.canonical))),Nr(n,n,i),n},r.dR=i=>({u_matrix:new nd(i),u_texsize:new Cs(i),u_pixels_to_tile_units:new Lm(i),u_device_pixel_ratio:new Hr(i),u_width_scale:new Hr(i),u_floor_width_scale:new Hr(i),u_image:new Yh(i),u_units_to_pixels:new Cs(i),u_tile_units_to_pixels:new Hr(i),u_alpha_discard_threshold:new Hr(i),u_trim_offset:new Cs(i),u_trim_fade_range:new Cs(i),u_trim_color:new td(i),u_emissive_strength:new Hr(i),u_zbias_factor:new Hr(i),u_tile_to_meter:new Hr(i),u_ground_shadow_factor:new Sc(i),u_pattern_transition:new Hr(i)}),r.dS=i=>({u_matrix:new nd(i),u_pixels_to_tile_units:new Lm(i),u_device_pixel_ratio:new Hr(i),u_width_scale:new Hr(i),u_floor_width_scale:new Hr(i),u_units_to_pixels:new Cs(i),u_dash_image:new Yh(i),u_gradient_image:new Yh(i),u_image_height:new Hr(i),u_texsize:new Cs(i),u_tile_units_to_pixels:new Hr(i),u_alpha_discard_threshold:new Hr(i),u_trim_offset:new Cs(i),u_trim_fade_range:new Cs(i),u_trim_color:new td(i),u_emissive_strength:new Hr(i),u_zbias_factor:new Hr(i),u_tile_to_meter:new Hr(i),u_ground_shadow_factor:new Sc(i)}),r.dT=i=>({u_camera_to_center_distance:new Hr(i),u_extrude_scale:new Lm(i),u_device_pixel_ratio:new Hr(i),u_matrix:new nd(i),u_inv_rot_matrix:new nd(i),u_merc_center:new Cs(i),u_tile_id:new Sc(i),u_zoom_transition:new Hr(i),u_up_dir:new Sc(i),u_emissive_strength:new Hr(i)}),r.dU=wc,r.dV=aN,r.dW=kS,r.dX=(i,e,n,s,c,f)=>{let p=i.transform,y=p.projection.name==="globe",x;if(f.paint.get("circle-pitch-alignment")==="map")if(y){let I=PS(p.zoom,e.canonical)*p._pixelsPerMercatorPixel;x=Float32Array.from([I,0,0,I])}else x=p.calculatePixelsToTileUnitsMatrix(n);else x=new Float32Array([p.pixelsToGLUnits[0],0,0,p.pixelsToGLUnits[1]]);let w={u_camera_to_center_distance:i.transform.getCameraToCenterDistance(p.projection),u_matrix:i.translatePosMatrix(e.projMatrix,n,f.paint.get("circle-translate"),f.paint.get("circle-translate-anchor")),u_device_pixel_ratio:cs.devicePixelRatio,u_extrude_scale:x,u_inv_rot_matrix:RF,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:f.paint.get("circle-emissive-strength")};if(y){w.u_inv_rot_matrix=s,w.u_merc_center=c,w.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],w.u_zoom_transition=Mc(p.zoom);let I=c[0]*st,S=c[1]*st;w.u_up_dir=p.projection.upVector(new ko(0,0,0),I,S)}return w},r.dY=pC,r.dZ=to,r.d_=(i,e,n,s,c,f,p,y,x,w)=>{let I=i.transform,S=I.pitch<15?dC(.07,.7,ne((14-I.zoom)/5,0,1)):.07,D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:fC(i,e,n,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:I.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:c,u_width_scale:f,u_floor_width_scale:p,u_image:0,u_tile_units_to_pixels:hC(e,I),u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:y,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:S,u_tile_to_meter:oe(e.tileID.canonical,0),u_ground_shadow_factor:x,u_pattern_transition:w}},r.da=function(i,e){return i.readFields(nz,{icons:[]},e)},r.db=uv,r.dc=af,r.dd=q1,r.de=Qd,r.df=Cy,r.dg=Xo,r.dh=Kl,r.di=rn,r.dj=function(i){let e=i.indexOf(Xu);return e>=0?i.slice(0,e):i},r.dk=function(i){return i.indexOf(Xu)>=0},r.dl=function(i){let e=i.lastIndexOf(Xu);return e>=0?i.slice(e+1):""},r.dm=function(i){let e=[],n=i.id;return n===void 0&&e.push({message:`layers.${n}: missing required property "id"`}),i.render===void 0&&e.push({message:`layers.${n}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&e.push({message:`layers.${n}: property "renderingMode" must be either "2d" or "3d"`}),e},r.dn=function(i,e,n,s){return i.type==="custom"?new YN(i,e):new ez[i.type](i,e,n,s)},r.dp=dn,r.dq=function(i){let e=i.indexOf(Xu);return e>=0?i.slice(e+1):""},r.dr=class extends pf{constructor(i,e){super(i._vectorTileFeature,i._z,i._x,i._y,i.id),i.state&&(this.state=Object.assign({},i.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=i.source,this.sourceLayer=i.sourceLayer,this.layer=i.layer)}toJSON(){let i=super.toJSON();return i.target=this.target,i.namespace=this.namespace,i}},r.ds=dm,r.dt=Xl,r.du=function(i){return i({pluginStatus:Ui,pluginURL:Ma}),dm.on("pluginStateChange",i),i},r.dv=Om,r.dw=class extends es{constructor(i){super(i),this.current=e1}set(i,e,n){if(this.fetchUniformLocation(i,e)){for(let s=0;s<9;s++)if(n[s]!==this.current[s]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}},r.dx=W,r.dy=function(i,e,n){let s=Mc(n.zoom),c=i.style.map._antialias,f=i.terrain&&i.terrain.exaggeration()>0;return s===0&&!c&&!f},r.dz=function(i){let e=i.pixelsPerMeter,n=e/j(1,i.center.lat),s=Oe(new Float64Array(16));return Ut(s,s,[i.point.x,i.point.y,0]),Nt(s,s,[n,n,e]),Float32Array.from(s)},r.e=vi,r.e$=hm,r.e0=Dt,r.e1=Nm,r.e2=J,r.e3=xl,r.e4=av,r.e5=SD,r.e6=Pc,r.e7=450,r.e8=7,r.e9=de,r.eA=function(i,e,n,s,c,f,p,y,x,w,I,S,D,P,O,N){var B=new k(16);return B[0]=i,B[1]=e,B[2]=n,B[3]=s,B[4]=c,B[5]=f,B[6]=p,B[7]=y,B[8]=x,B[9]=w,B[10]=I,B[11]=S,B[12]=D,B[13]=P,B[14]=O,B[15]=N,B},r.eB=T,r.eC=Tm,r.eD=Ku,r.eE=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Xe(1/0,1/0),max:new Xe(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(i,e=!1){let n=hD(new Xe(0,0),new Xe(st,st),i),s=[];if(e&&!y1(n,this._globalClipBounds))return s;for(let c of this._activeRegions){if(c.hiddenByOverlap||!y1(n,c))continue;let f=ok(c.min,c.max,i);s.push({min:f.min,max:f.max,sourceId:this._sourceIds[c.priority],footprint:c.footprint,footprintTileId:c.tileId,order:c.order,clipMask:c.clipMask,clipScope:c.clipScope})}return s}setSources(i){this._setSources(i.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{let n=[];for(let s of e.cache.getVisibleCoordinates()){let c=e.cache.getTile(s).buckets[e.layer];c&&c.updateFootprints(s.toUnwrapped(),n)}return n},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(i){let e=i.getFootprints();if(e.length===0)return;let n=i.getOrder(),s=i.getClipMask(),c=i.getClipScope();for(let f of e){if(!f.footprint)continue;let p=hD(f.footprint.min,f.footprint.max,f.id);this._activeRegions.push({min:p.min,max:p.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:f.id,footprint:f.footprint,order:n,clipMask:s,clipScope:c})}this._sourceIds.push(i.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,n)=>e.priority-n.priority||iv(e.min,n.min)||iv(e.max,n.max)||e.order-n.order||e.clipMask-n.clipMask||function(s,c){let f=(p,y)=>p+y;return s.length-c.length||s.reduce(f,"").localeCompare(c.reduce(f,""))}(e.clipScope,n.clipScope));let i=this._activeRegions.length!==this._prevRegions.length;if(!i){let e=0;for(;!i&&e!==this._activeRegions.length;){let n=this._activeRegions[e],s=this._prevRegions[e];i=n.priority!==s.priority||!dD(n,s)||n.order!==s.order||n.clipMask!==s.clipMask||!Bs(n.clipScope,s.clipScope),++e}}if(i){++this._updateTime;for(let n of this._activeRegions)n.order!==Hm&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,n.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,n.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,n.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,n.max.y));let e=n=>{let s=this._activeRegions;if(n>=s.length)return n;let c=s[n].priority;for(;n<s.length&&s[n].priority===c;)++n;return n};if(this._sourceIds.length>1){let n=0,s=e(n);for(;n!==s;){let c=n,f=n;for(;c!==s;){let p=this._activeRegions[c];p.hiddenByOverlap=!1;for(let y=0;y<f;y++){let x=this._activeRegions[y];if(!x.hiddenByOverlap&&p.order===Hm&&y1(p,x)&&(p.hiddenByOverlap=fD(p.footprint,p.tileId,x.footprint,x.tileId),p.hiddenByOverlap))break}++c}n=s,s=e(n)}}}}_setSources(i){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=i.length-1;e>=0;e--)this._addSource(i[e]);this._computeReplacement()}},r.eF=Hm,r.eG=class{constructor(i){this._createGrid(i),this._createPoles(i)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let i of this._poleSegments)i.destroy();for(let i of this._gridSegments)i.withSkirts.destroy(),i.withoutSkirts.destroy()}_fillGridMeshWithLods(i,e){let n=new io,s=new dr,c=[],f=i+1+2,p=e[0]+1,y=e[0]+1+(1+e.length),x=(w,I,S)=>{let D=w===f-1?w-2:w===0?w:w-1;return D+=S?24575:0,[D,I]};for(let w=0;w<f;++w)n.emplaceBack(...x(w,0,!0));for(let w=0;w<p;++w)for(let I=0;I<f;++I)n.emplaceBack(...x(I,w,(I===0||I===f-1)&&!0));for(let w=0;w<e.length;++w){let I=e[w];for(let S=0;S<f;++S)n.emplaceBack(...x(S,I,!0))}for(let w=0;w<e.length;++w){let I=s.length,S=e[w]+1+2,D=new dr;for(let N=0;N<S-1;N++){let B=N===S-2,G=B?f*(y-e.length+w-N):f;for(let X=0;X<f-1;X++){let q=N*f+X;N===0||B||X===0||X===f-2?(D.emplaceBack(q+1,q,q+G),D.emplaceBack(q+G,q+G+1,q+1)):(s.emplaceBack(q+1,q,q+G),s.emplaceBack(q+G,q+G+1,q+1))}}let P=_r.simpleSegment(0,I,n.length,s.length-I);for(let N=0;N<D.uint16.length;N+=3)s.emplaceBack(D.uint16[N],D.uint16[N+1],D.uint16[N+2]);let O=_r.simpleSegment(0,I,n.length,s.length-I);c.push({withoutSkirts:P,withSkirts:O})}return{vertices:n,indices:s,segments:c}}_createGrid(i){let e=this._fillGridMeshWithLods(o,h);this._gridSegments=e.segments,this._gridBuffer=i.createVertexBuffer(e.vertices,DS.members),this._gridIndexBuffer=i.createIndexBuffer(e.indices,!0)}_createPoles(i){let e=new dr;for(let p=0;p<=o;p++)e.emplaceBack(0,p+1,p+2);this._poleIndexBuffer=i.createIndexBuffer(e,!0);let n=new yl,s=new yl,c=new yl,f=new yl;this._poleSegments=[];for(let p=0,y=0;p<qy;p++){let x=360/(1<<p);n.emplaceBack(0,-Fi,0,.5,0),s.emplaceBack(0,-Fi,0,.5,1),c.emplaceBack(0,-Fi,0,.5,.5),f.emplaceBack(0,-Fi,0,.5,.5);for(let w=0;w<=o;w++){let I=w/o,S=0,D=At(0,x,I),[P,O,N]=v(AF,MF,D,Fi);n.emplaceBack(P,O,N,I,S),s.emplaceBack(P,O,N,I,1-S);let B=Sn(D);I=.5+.5*Math.sin(B),S=.5+.5*Math.cos(B),c.emplaceBack(P,O,N,I,S),f.emplaceBack(P,O,N,I,1-S)}this._poleSegments.push(_r.simpleSegment(y,0,66,64)),y+=66}this._poleNorthVertexBuffer=i.createVertexBuffer(n,Xy,!1),this._poleSouthVertexBuffer=i.createVertexBuffer(s,Xy,!1),this._texturedPoleNorthVertexBuffer=i.createVertexBuffer(c,Xy,!1),this._texturedPoleSouthVertexBuffer=i.createVertexBuffer(f,Xy,!1)}getGridBuffers(i,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[i].withSkirts:this._gridSegments[i].withoutSkirts]}getPoleBuffers(i,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[i]]}},r.eH=cD,r.eI=te,r.eJ=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},r.eK=fe,r.eL=ie,r.eM=function(i,e,n){return i[0]=e[0]/n[0],i[1]=e[1]/n[1],i[2]=e[2]/n[2],i},r.eN=Ki,r.eO=E,r.eP=qd,r.eQ=jr,r.eR=function([i,e,n]){let s=Math.hypot(i,e,n),c=Math.atan2(i,n),f=.5*Math.PI-Math.acos(-e/s);return new A(De(c),De(f))},r.eS=Eo,r.eT=O1,r.eU=function(i){let e=i.navigator?i.navigator.userAgent:null;return!!function(n){if(Ar==null){let s=n.navigator?n.navigator.userAgent:null;Ar=!!n.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Ar}(i)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},r.eV=function(i,e){us=i,Us=e},r.eW=c1,r.eX=LS,r.eY=function(i){let e=[0,0,0],n=Oe(new Float64Array(16));return Vt(n,i.pixelMatrix,i.globeMatrix),Nr(e,e,n),new Xe(e[0],e[1])},r.eZ=function(){let i=Xm;i&&(i.isPreloaded()&&i.numActive()===1?(i.release(I1),Xm=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},r.e_=function(){uv().acquire(I1)},r.ea=function(i,e){if(i===e){var n=e[1],s=e[2],c=e[3],f=e[6],p=e[7],y=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=n,i[6]=e[9],i[7]=e[13],i[8]=s,i[9]=f,i[11]=e[14],i[12]=c,i[13]=p,i[14]=y}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i},r.eb=XN,r.ec=gn,r.ed=Dm,r.ee=256,r.ef=a1,r.eg=Ro,r.eh=ci,r.ei=function(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[4],i[4]=e[5],i[5]=e[6],i[6]=e[8],i[7]=e[9],i[8]=e[10],i},r.ej=yl,r.ek=Em,r.el=_y,r.em=function(i,e,n,s,c){return ne((i-e)/(n-e)*(c-s)+s,s,c)},r.en=Hl,r.eo=function(i,e){var n=e[0],s=e[1],c=e[2],f=e[3],p=e[4],y=e[5],x=e[6],w=e[7],I=e[8],S=I*p-y*w,D=-I*f+y*x,P=w*f-p*x,O=n*S+s*D+c*P;return O?(i[0]=S*(O=1/O),i[1]=(-I*s+c*w)*O,i[2]=(y*s-c*p)*O,i[3]=D*O,i[4]=(I*n-c*x)*O,i[5]=(-y*n+c*f)*O,i[6]=P*O,i[7]=(-w*n+s*x)*O,i[8]=(p*n-s*f)*O,i):null},r.ep=2,r.eq=ca,r.er=L1,r.es=[1,1,1],r.et=class{constructor(i,e,n,s){this.context=i,this.format=s,this.size=n,this.texture=i.gl.createTexture();let[c,f,p]=this.size,{gl:y}=i;y.bindTexture(y.TEXTURE_3D,this.texture),i.pixelStoreUnpackFlipY.set(!1),i.pixelStoreUnpack.set(1),i.pixelStoreUnpackPremultiplyAlpha.set(!1),y.texImage3D(y.TEXTURE_3D,0,this.format,c,f,p,0,M1(this.format),R1(this.format),e.data)}bind(i,e){let{context:n}=this,{gl:s}=n;s.bindTexture(s.TEXTURE_3D,this.texture),i!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,i),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,i),this.minFilter=i),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){let{gl:i}=this.context;i.deleteTexture(this.texture),this.texture=null}},r.eu=uf,r.ev=cu,r.ew=function(i,e,n,s){var c=e[0],f=e[1],p=e[2],y=e[3];return i[0]=c+s*(n[0]-c),i[1]=f+s*(n[1]-f),i[2]=p+s*(n[2]-p),i[3]=y+s*(n[3]-y),i},r.ex=rf,r.ey=Ds,r.ez=La,r.f=function(i){return btoa(encodeURIComponent(i).replace(/%([0-9A-F]{2})/g,(e,n)=>String.fromCharCode(+("0x"+n))))},r.f0=function(i,e,n=!1){if(Ui===mo.deferred||Ui===mo.loading||Ui===mo.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ma=cs.resolveURL(i),Ui=mo.deferred,cm=e,um(),n||Ay()},r.f1=function(i){ef=cs.resolveURL(i),tf||(tf=new Qh(uv(),new ol)),tf.broadcast("setMeshoptUrl",ef)},r.f2=BD,r.f3=function(i){D1=cs.resolveURL(i),tf||(tf=new Qh(uv(),new ol)),tf.broadcast("setDracoUrl",D1)},r.f4=zD,r.f5=qm,r.f6=function(i){let e=tl();if(!e)return;let n=e.delete(Vs);i&&n.then(()=>i()).catch(i)},r.f7=cv,r.f8=_t,r.f9=Rc,r.fa=qs,r.fb=lM,r.fc=cM,r.fd=aC,r.fe=ft,r.ff="hd_road_elevation",r.fg=yr,r.fh=jt,r.fi=od,r.fj=Z1,r.fk=cd,r.fl=function(i,e,n,s,c,f,p,y=1,x,w,I){i.createArrays(),i.tilePixelRatio=st/(512*i.overscaling),i.compareText={},i.iconsNeedLinear=!1;let S=i.layers[0].layout,D=i.layers[0]._unevaluatedLayout._values,P={};P.scaleFactor=y,P.textSizeScaleRange=S.get("text-size-scale-range"),P.iconSizeScaleRange=S.get("icon-size-scale-range");let[O,N]=P.textSizeScaleRange,[B,G]=P.iconSizeScaleRange;P.textScaleFactor=ne(P.scaleFactor,O,N),P.iconScaleFactor=ne(P.scaleFactor,B,G);let X=D["text-size"],q=D["icon-size"];if(i.textSizeData.kind==="composite"){let{minZoom:ye,maxZoom:ke}=i.textSizeData;P.compositeTextSizes=[X.possiblyEvaluate(new jn(ye,{worldview:I}),f),X.possiblyEvaluate(new jn(ke,{worldview:I}),f)]}if(i.iconSizeData.kind==="composite"){let{minZoom:ye,maxZoom:ke}=i.iconSizeData;P.compositeIconSizes=[q.possiblyEvaluate(new jn(ye,{worldview:I}),f),q.possiblyEvaluate(new jn(ke,{worldview:I}),f)]}P.layoutTextSize=X.possiblyEvaluate(new jn(p+1,{worldview:I}),f),P.layoutIconSize=q.possiblyEvaluate(new jn(p+1,{worldview:I}),f),P.textMaxSize=X.possiblyEvaluate(new jn(18,{worldview:I}),f);let K=S.get("symbol-placement"),he=S.get("text-rotation-alignment")==="map"&&K!=="point",le=S.get("text-size"),ue=!1,ge=[];for(let ye of i.features){let ke=S.get("text-font").evaluate(ye,{},f).join(","),be=le.evaluate(ye,{},f)*P.textScaleFactor,ze=P.layoutTextSize.evaluate(ye,{},f)*P.textScaleFactor,et=P.layoutIconSize.evaluate(ye,{},f)*P.iconScaleFactor,Ue={horizontal:{},vertical:void 0},Ze=ye.text,Je,Le=[0,0];if(Ze){let mt=Ze.toString(),Rt=S.get("text-letter-spacing").evaluate(ye,{},f)*gi,Bt=S.get("text-line-height").evaluate(ye,{},f)*gi,qt=Hb(mt)?Rt:0,Gt=S.get("text-anchor").evaluate(ye,{},f),pn=S.get("text-variable-anchor");if(!pn){let Re=S.get("text-radial-offset").evaluate(ye,{},f);if(Re)Le=WC(Gt,[Re*gi,X1]);else{let it=S.get("text-offset").evaluate(ye,{},f);Le=[it[0]*gi,it[1]*gi]}}let nn=he?"center":S.get("text-justify").evaluate(ye,{},f),nr=K==="point",Q=nr?S.get("text-max-width").evaluate(ye,{},f)*gi:1/0,ee=Re=>{i.allowVerticalPlacement&&lm(mt)&&(Ue.vertical=G1(Ze,e,n,c,ke,Q,Bt,Gt,Re,qt,Le,Bo.vertical,!0,ze,be,x))};if(!he&&pn){let Re=nn==="auto"?pn.map(ct=>Y1(ct)):[nn],it=!1;for(let ct=0;ct<Re.length;ct++){let lt=Re[ct];if(!Ue.horizontal[lt])if(it)Ue.horizontal[lt]=Ue.horizontal[0];else{let vt=G1(Ze,e,n,c,ke,Q,Bt,"center",lt,qt,Le,Bo.horizontal,!1,ze,be,x);vt&&(Ue.horizontal[lt]=vt,it=vt.positionedLines.length===1)}}ee("left")}else{if(nn==="auto"&&(nn=Y1(Gt)),nr||S.get("text-writing-mode").indexOf("horizontal")>=0||!lm(mt)){let Re=G1(Ze,e,n,c,ke,Q,Bt,Gt,nn,qt,Le,Bo.horizontal,!1,ze,be,x);Re&&(Ue.horizontal[nn]=Re)}ee(nr?"left":nn)}}let qe,we,Fe,rt,Ye,Et,yt=!1,$e=S.get("icon-text-fit").evaluate(ye,{},f);if(ye.icon&&ye.icon.hasPrimary()){let mt=qC(ye.icon,i.iconSizeData,D["icon-size"],f,i.zoom,ye,x,P.iconScaleFactor,I);qe=mt.iconPrimary,Fe=mt.iconSecondary;let Rt=qe.toString();if(we=s.get(Rt),we&&(Ye=S.get("icon-offset").evaluate(ye,{},f),Et=S.get("icon-anchor").evaluate(ye,{},f),Je=IN(c.get(Rt),Fe?c.get(Fe.toString()):void 0,Ye,Et),yt=we.sdf,i.sdfIcons===void 0?i.sdfIcons=we.sdf:i.sdfIcons!==we.sdf&&fn("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(we.pixelRatio!==i.pixelRatio||S.get("icon-rotate").constantOr(1)!==0)&&(i.iconsNeedLinear=!0)),Fe){let Bt=Fe.toString();rt=s.get(Bt)}}ue=ue||!(!ye.icon||!ye.icon.hasSecondary());let Ke=K1(Ue.horizontal)||Ue.vertical;i.iconsInText||(i.iconsInText=!!Ke&&Ke.iconsInText);let xt=ze*P.textScaleFactor/gi,{defaultShapedIcon:pt,verticallyShapedIcon:at}=FN(i,Je,S,ye,f,Ue,xt,Ye,$e);$e!=="none"&&Je&&(MC(Je)||RC(Je))&&(wv(0,we,qe,Je,pt,$e,w,s,c),wv(0,rt,Fe,Je,pt,$e,w,s,c),at&&(wv(0,we,qe,Je,at,$e,w,s,c),wv(0,rt,Fe,Je,at,$e,w,s,c))),Je=pt,ge.push({feature:ye,shapedTextOrientations:Ue,shapedText:Ke,shapedIcon:Je,iconPrimary:qe,iconSecondary:Fe,iconOffset:Ye,iconAnchor:Et,verticallyShapedIcon:at,layoutTextSize:ze,layoutIconSize:et,textOffset:Le,isSDFIcon:yt,iconTextFit:$e})}return{featureData:ge,sizes:P,hasAnySecondaryIcon:ue,textAlongLine:he,symbolPlacement:K}},r.fm=VC,r.fn=function(i,e,n,s,c,f,p,y,x,w){let{featureData:I,hasAnySecondaryIcon:S,sizes:D,textAlongLine:P,symbolPlacement:O}=e;for(let N of I){let{shapedIcon:B,verticallyShapedIcon:G,feature:X,shapedTextOrientations:q,shapedText:K,layoutTextSize:he,textOffset:le,isSDFIcon:ue,iconPrimary:ge,iconSecondary:ye,iconTextFit:ke,iconOffset:be}=N;XC(B,w.iconPositions,ge,ye),XC(G,w.iconPositions,ge,ye),LN(q,w.iconPositions),ON(ge,ye,w.iconPositions),(K||B)&&kN(i,X,q,B,G,x,D,he,0,le,ue,s,c,p,y,S,ke,be,P,O)}n&&i.generateCollisionDebugBuffers(f,i.collisionBoxArray,D.textScaleFactor)},r.fo=bt,r.fp=jv,r.fq=Se,r.fr=function(i){let e=0;if(new Uint32Array(i,0,1)[0]!==UD){let n=new Uint32Array(i,0,7),[,,s,c,f,p]=n;e=n.byteLength+c+f+p+f,(s!==i.byteLength||e>=i.byteLength)&&fn("Invalid b3dm header information.")}return $D(i,e)},r.fs=function(i,e){let n=QD(i);for(let s of n){for(let c of s.meshes)kk(c);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(Nk(s.lights,e)))}return n},r.ft=kv,r.fu=$n,r.fv=kD,r.fw=Is,r.fx=mo,r.fy=function(i){Zl(),Es?.then(e=>{e.keys().then(n=>{for(let s=0;s<n.length-i;s++)e.delete(n[s]).catch(c=>fn(c.message))}).catch(n=>fn(n.message))}).catch(e=>fn(e.message))},r.g=function(i,e){return Xl(Ce(i,{method:"GET"}),e)},r.h=Ce,r.i=function(i){return vi.API_STYLE_REGEX.test(i)&&!Xd(i)},r.j=function(i){return i.indexOf("mapbox:")===0},r.k=ga,r.l=Ep,r.m=function(i){return decodeURIComponent(atob(i).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},r.n=function(i,e){return Xl(Ce(i,{type:"json"}),e)},r.o=Iu,r.p=function(i,e){return Xl(Ce(i,{method:"POST"}),e)},r.q=cs,r.r=Si,r.s=function(i){try{let e=self[i];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},r.t=Jd,r.u=function(){return function i(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,i)}()},r.v=function(i){return!!i&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(i)},r.w=fn,r.x=function(){return S1||(S1=new cv),S1},r.y=hw,r.z=Co}),m(["./shared"],function(r){function M(De){let $=De?De.url.toString():void 0;return $?performance.getEntriesByName($):[]}function k(De){if(typeof De=="number"||typeof De=="boolean"||typeof De=="string"||De==null)return JSON.stringify(De);if(Array.isArray(De)){let W="[";for(let te of De)W+=`${k(te)},`;return`${W}]`}let $="{";for(let W of Object.keys(De).sort())$+=`${W}:${k(De[W])},`;return`${$}}`}function U(De){let $="";for(let W of r.bu)$+=`/${k(De[W])}`;return $}class ae{constructor($){this.keyCache={},this._layers={},this._layerConfigs={},$&&this.replace($)}replace($,W){this._layerConfigs={},this._layers={},this.update($,[],W)}update($,W,te){this._options=te;for(let ne of $)this._layerConfigs[ne.id]=ne,(this._layers[ne.id]=r.dn(ne,this.scope,null,this._options)).compileFilter(te),this.keyCache[ne.id]&&delete this.keyCache[ne.id];for(let ne of W)delete this.keyCache[ne],delete this._layerConfigs[ne],delete this._layers[ne];this.familiesBySource={};let fe=function(ne,_e){let Me={};for(let Ce=0;Ce<ne.length;Ce++){let nt=ne[Ce],je=_e&&_e[nt.id];je||(nt.type==="symbol"?je=nt.id:(je=U(nt),nt.type==="line"&&nt.paint&&function kt(jt){return typeof jt=="string"&&jt==="line-progress"||(Array.isArray(jt)?jt.some(kt):!(!jt||typeof jt!="object")&&Object.values(jt).some(kt))}(nt.paint["line-width"])&&(je+=`/${k(nt.paint["line-width"])}`))),_e&&(_e[nt.id]=je);let Dt=Me[je];Dt||(Dt=Me[je]=[]),Dt.push(nt)}let ve=[];for(let Ce in Me)ve.push(Me[Ce]);return ve}(Object.values(this._layerConfigs),this.keyCache);for(let ne of fe){let _e=ne.map(Dt=>this._layers[Dt.id]),Me=_e[0];if(Me.visibility==="none")continue;let ve=Me.source||"",Ce=this.familiesBySource[ve];Ce||(Ce=this.familiesBySource[ve]={});let nt=Me.sourceLayer||"_geojsonTileLayer",je=Ce[nt];je||(je=Ce[nt]=[]),je.push(_e)}}}let Ee=1*r.fa;class Be{constructor($){let W={},te=[];for(let Me in $){let ve=$[Me],Ce=W[Me]={};for(let nt in ve.glyphs){let je=ve.glyphs[+nt];if(!je||je.bitmap.width===0||je.bitmap.height===0)continue;let Dt=je.metrics.localGlyph?Ee:1,kt={x:0,y:0,w:je.bitmap.width+2*Dt,h:je.bitmap.height+2*Dt};te.push(kt),Ce[nt]=kt}}let{w:fe,h:ne}=r.H(te),_e=new r.f9({width:fe||1,height:ne||1});for(let Me in $){let ve=$[Me];for(let Ce in ve.glyphs){let nt=ve.glyphs[+Ce];if(!nt||nt.bitmap.width===0||nt.bitmap.height===0)continue;let je=W[Me][Ce],Dt=nt.metrics.localGlyph?Ee:1;r.f9.copy(nt.bitmap,_e,{x:0,y:0},{x:je.x+Dt,y:je.y+Dt},nt.bitmap)}}this.image=_e,this.positions=W}}r.f8(Be,"GlyphAtlas");class ht{constructor($){this.tileID=new r.aM($.tileID.overscaledZ,$.tileID.wrap,$.tileID.canonical.z,$.tileID.canonical.x,$.tileID.canonical.y),this.tileZoom=$.tileZoom,this.uid=$.uid,this.zoom=$.zoom,this.lut=$.lut,this.canonical=$.tileID.canonical,this.pixelRatio=$.pixelRatio,this.tileSize=$.tileSize,this.source=$.source,this.scope=$.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=$.showCollisionBoxes,this.collectResourceTiming=!!$.request&&$.request.collectResourceTiming,this.promoteId=$.promoteId,this.isSymbolTile=$.isSymbolTile,this.tileTransform=r.aW($.tileID.canonical,$.projection),this.projection=$.projection,this.worldview=$.worldview,this.localizableLayerIds=$.localizableLayerIds,this.brightness=$.brightness,this.extraShadowCaster=!!$.extraShadowCaster,this.tessellationStep=$.tessellationStep,this.scaleFactor=$.scaleFactor,this.worldview=$.worldview}parse($,W,te,fe,ne,_e){this.status="parsing",this.data=$,this.collisionBoxArray=new r.b0;let Me=new r.fb(Object.keys($.layers).sort()),ve=new r.fc(this.tileID,this.promoteId);ve.bucketLayerIDs=[];let Ce={},nt=new r.fd(256,256),je={featureIndex:ve,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:nt,availableImages:te,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Dt=[],kt=W.familiesBySource[this.source];for(let dn in kt){let rn=$.layers[dn];if(!rn)continue;let hn=!1,Kn=!1,fn=!1;for(let $n of kt[dn])$n[0].type==="symbol"?hn=!0:Kn=!0,$n[0].is3D()&&$n[0].type!=="model"&&(fn=!0);if(this.extraShadowCaster&&!fn||this.isSymbolTile===!0&&!hn||this.isSymbolTile===!1&&!Kn)continue;rn.version===1&&r.w(`Vector tile source "${this.source}" layer "${dn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let Pr=Me.encode(dn),ii=[],Jr=!1;for(let $n=0,An=0;$n<rn.length;$n++){let Ar=rn.feature($n),wr=ve.getId(Ar,dn);if(this.localizableLayerIds&&this.localizableLayerIds.has(dn)){let gr=Ar.properties?Ar.properties.worldview:null;if(this.worldview&&typeof gr=="string")if(gr==="all")Ar.properties.$localized=!0;else{if(!gr.split(",").includes(this.worldview))continue;Ar.properties.$localized=!0,Ar.properties.worldview=this.worldview}}!Jr&&Ar.properties&&Ar.properties.hasOwnProperty(r.fe)&&(Jr=!0),ii.push({feature:Ar,id:wr,index:An,sourceLayerIndex:Pr}),An++}Jr&&!je.elevationFeatures&&$.layers.hasOwnProperty(r.ff)&&(je.elevationFeatures=r.fg.parseFrom($.layers[r.ff],this.canonical));for(let $n of kt[dn]){let An=$n[0];if(this.extraShadowCaster&&(!An.is3D()||An.type==="model")||this.isSymbolTile!==void 0&&An.type==="symbol"!==this.isSymbolTile||An.minzoom&&this.zoom<Math.floor(An.minzoom)||An.maxzoom&&this.zoom>=An.maxzoom||An.visibility==="none")continue;Oe($n,this.zoom,je.brightness,te,this.worldview);let Ar=Ce[An.id]=An.createBucket({index:ve.bucketLayerIDs.length,layers:$n,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Pr,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:fe,worldview:this.worldview});ve.bucketLayerIDs.push($n.map(gr=>r.C(gr.id,gr.scope)));let wr=Ar.prepare?Ar.prepare():null;wr!=null?(wr=wr.then(()=>Ar.populate(ii,je,this.tileID.canonical,this.tileTransform)),Dt.push(wr)):Ar.populate(ii,je,this.tileID.canonical,this.tileTransform)}}let jt=()=>{let dn,rn,hn,Kn,fn,Pr;nt.trim();let ii={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Jr=()=>{if(dn)return this.status="done",_e(dn);if(this.extraShadowCaster)this.status="done",_e(null,{buckets:Object.values(Ce).filter(An=>!An.isEmpty()),featureIndex:ve,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:je.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(rn&&hn&&Kn){let An=new Be(rn),Ar=new Map;for(let[hi,Qi]of hn.entries()){let{imagePosition:Ri}=r.fj(hi,Qi,r.fk);Ar.set(hi,Ri)}let wr={};for(let hi in Ce){let Qi=Ce[hi];Qi instanceof r.b1&&(Oe(Qi.layers,this.zoom,je.brightness,te,this.worldview),wr[hi]=r.fl(Qi,rn,An.positions,hn,Ar,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,fn,this.worldview))}let gr={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(ne,hn,fn,()=>{gr.iconsPending=!1,$n(wr,An,gr)}),this.rasterizeIfNeeded(ne,Kn,Pr,()=>{gr.patternsPending=!1,$n(wr,An,gr)})}},$n=(An,Ar,wr,gr)=>{if(wr.iconsPending||wr.patternsPending)return;let hi=new r.fm(hn,Kn,this.lut);for(let Qi in Ce){let Ri=Ce[Qi];if(Qi in An)r.fn(Ri,An[Qi],this.showCollisionBoxes,te,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,hn,hi);else if(Ri.hasPattern&&(Ri instanceof r.b7||Ri instanceof r.b8||Ri instanceof r.e4)){Oe(Ri.layers,this.zoom,je.brightness,te,this.worldview);let mu=Object.fromEntries(hi.patternPositions);Ri.addFeatures(je,this.tileID.canonical,mu,te,this.tileTransform,this.brightness)}}this.status="done",_e(null,{buckets:Object.values(Ce).filter(Qi=>!Qi.isEmpty()),featureIndex:ve,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ar.image,lineAtlas:nt,imageAtlas:hi,brightness:je.brightness})};if(!this.extraShadowCaster){let An=r.fh(je.glyphDependencies,gr=>Object.keys(gr).map(Number));Object.keys(An).length?ne.send("getGlyphs",{uid:this.uid,stacks:An},(gr,hi)=>{dn||(dn=gr,rn=hi,Jr())},void 0,!1,ii):rn={};let Ar=Array.from(je.iconDependencies.keys()).map(gr=>r.I.parse(gr));Ar.length?ne.send("getImages",{images:Ar,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(gr,hi)=>{dn||(dn=gr,hn=new Map,fn=this.updateImageMapAndGetImageTaskQueue(hn,hi,je.iconDependencies),Jr())},void 0,!1,ii):(hn=new Map,fn=new Map);let wr=Array.from(je.patternDependencies.keys()).map(gr=>r.I.parse(gr));wr.length?ne.send("getImages",{images:wr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(gr,hi)=>{dn||(dn=gr,Kn=new Map,Pr=this.updateImageMapAndGetImageTaskQueue(Kn,hi,je.patternDependencies),Jr())},void 0,!1,ii):(Kn=new Map,Pr=new Map)}if(je.elevationFeatures&&je.elevationFeatures.length>0){let An=[];for(let wr of Object.values(Ce))if(wr instanceof r.b8){let gr=wr.getUnevaluatedPortalGraph();gr&&An.push(gr)}let Ar=r.fi.evaluate(An);for(let wr of Object.values(Ce))if(wr instanceof r.b8){let gr=$.layers[Me.decode(wr.sourceLayerIndex)];wr.setEvaluatedPortalGraph(Ar,gr,this.tileID.canonical,je.availableImages,je.brightness)}}Jr()};Dt.length>0?Promise.allSettled(Dt).then(jt).catch(_e):jt()}rasterizeIfNeeded($,W,te,fe){Array.from(W.values()).some(ne=>ne.usvg)?this.rasterize($,W,te,fe):fe()}updateImageMapAndGetImageTaskQueue($,W,te){let fe=new Map;for(let ne of W.keys()){let _e=te.get(ne)||[];for(let Me of _e){let ve=Me.toString(),Ce=W.get(Me.id.toString());Ce.usvg?fe.has(ve)||(fe.set(ve,Me),$.set(ve,Object.assign({},Ce))):$.set(ve,Ce)}}return fe}rasterize($,W,te,fe){this.rasterizeTask=$.send("rasterizeImages",{scope:this.scope,tasks:te},(ne,_e)=>{if(!ne)for(let[Me,ve]of _e.entries()){let Ce=Object.assign(W.get(Me),{data:ve});W.set(Me,Ce)}fe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function Oe(De,$,W,te,fe){let ne=new r.aa($,{brightness:W,worldview:fe});for(let _e of De)_e.recalculate(ne,te)}class Ct extends r.E{constructor($,W,te,fe,ne,_e,Me){super(),this.actor=$,this.layerIndex=W,this.availableImages=te,this.availableModels=fe,this.loadVectorData=_e||r.aJ,this.loading={},this.loaded={},this.deduped=new r.aI($.scheduler),this.isSpriteLoaded=ne,this.scheduler=$.scheduler,this.brightness=Me}loadTile($,W){let te=$.uid,fe=$&&$.request,ne=fe&&fe.collectResourceTiming,_e=this.loading[te]=new ht($);_e.abort=this.loadVectorData($,(Me,ve)=>{let Ce=!this.loading[te];if(delete this.loading[te],_e.cancelRasterize(),Ce||Me||!ve)return _e.status="done",Ce||(this.loaded[te]=_e),W(Me);let nt=ve.rawData,je={};ve.expires&&(je.expires=ve.expires),ve.cacheControl&&(je.cacheControl=ve.cacheControl),_e.vectorTile=ve.vectorTile||new r.fo(new r.bq(nt));let Dt=()=>{_e.parse(_e.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(kt,jt)=>{if(kt||!jt)return W(kt);let dn={};if(ne){let rn=M(fe);rn.length>0&&(dn.resourceTiming=JSON.parse(JSON.stringify(rn)))}W(null,r.h({rawTileData:nt.slice(0)},jt,je,dn))})};this.isSpriteLoaded?Dt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Dt,{type:"parseTile",isSymbolTile:$.isSymbolTile,zoom:$.tileZoom}):Dt()}),this.loaded=this.loaded||{},this.loaded[te]=_e})}reloadTile($,W){let te=this.loaded,fe=$.uid;if(te&&te[fe]){let ne=te[fe];ne.scaleFactor=$.scaleFactor,ne.showCollisionBoxes=$.showCollisionBoxes,ne.projection=$.projection,ne.brightness=$.brightness,ne.tileTransform=r.aW($.tileID.canonical,$.projection),ne.extraShadowCaster=$.extraShadowCaster,ne.lut=$.lut,ne.worldview=$.worldview;let _e=(Me,ve)=>{let Ce=ne.reloadCallback;Ce&&(delete ne.reloadCallback,ne.parse(ne.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ce)),W(Me,ve)};ne.status==="parsing"?ne.reloadCallback=_e:ne.status==="done"&&(ne.vectorTile?ne.parse(ne.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,_e):_e())}else W(null,void 0)}abortTile($,W){let te=$.uid,fe=this.loading[te];fe&&(fe.abort&&fe.abort(),delete this.loading[te]),W()}removeTile($,W){let te=this.loaded,fe=$.uid;te&&te[fe]&&delete te[fe],W()}}class Vt{loadTile($,W){let{uid:te,encoding:fe,rawImageData:ne,padding:_e}=$,Me=ImageBitmap&&ne instanceof ImageBitmap?this.getImageData(ne,_e):ne;W(null,new r.fp(te,Me,fe,_e<1))}reloadTile($,W){W(null,null)}abortTile($,W){W()}removeTile($,W){W()}getImageData($,W){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas($.width,$.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=$.width,this.offscreenCanvas.height=$.height,this.offscreenCanvasContext.drawImage($,0,0,$.width,$.height);let te=this.offscreenCanvasContext.getImageData(-W,-W,$.width+2*W,$.height+2*W);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),te}}r.bp.setPbf(r.bq);class Ut{constructor($){this._mrt=new r.bp($.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=$.uid,this.tileID=$.tileID,this.source=$.source}parse($,W){let te=this._mrt;this.status="parsing",this._entireBuffer=$;try{te.parseHeader($),this._isHeaderLoaded=!0;let fe=[];for(let ne in te.layers){let _e=te.getLayer(ne),Me=_e.getDataRange(_e.getBandList()),ve=te.createDecodingTask(Me),Ce=$.slice(Me.firstByte,Me.lastByte+1),nt=r.bp.performDecoding(Ce,ve).then(je=>ve.complete(null,je)).catch(je=>ve.complete(je,null));fe.push(nt)}Promise.allSettled(fe).then(()=>W(null,te)).catch(ne=>W(ne))}catch(fe){W(fe)}}}class Nt{constructor($){this.actor=$,this.loading={},this.loaded={}}loadTile($,W){let te=$.uid,fe=$.request,ne=this.loading[te]=new Ut($),{cancel:_e}=r.br(fe,(Me,ve,Ce,nt)=>{let je=!this.loading[te];if(delete this.loading[te],je||Me||!ve)return ne.status="done",je||(this.loaded[te]=ne),W(Me);ne.parse(ve,(Dt,kt)=>{if(Dt||!kt)return W(Dt);W(null,kt,Ce,nt)}),this.loaded[te]=ne});ne.abort=_e}reloadTile($,W){W(null,void 0)}abortTile($,W){let te=$.uid,fe=this.loading[te];fe&&(fe.abort&&fe.abort(),delete this.loading[te]),W()}removeTile($,W){let te=$.uid;this.loaded[te]&&delete this.loaded[te],W()}decodeRasterArray($,W){r.bp.performDecoding($.buffer,$.task).then(te=>W(null,te)).catch(te=>W(te))}}let li=r.fq.prototype.toGeoJSON;class ci{constructor($){this._feature=$,this.extent=r.aj,this.type=$.type,this.properties=$.tags,"id"in $&&!isNaN($.id)&&(this.id=parseInt($.id,10))}loadGeometry(){if(this._feature.type===1){let $=[];for(let W of this._feature.geometry)$.push([new r.P(W[0],W[1])]);return $}{let $=[];for(let W of this._feature.geometry){let te=[];for(let fe of W)te.push(new r.P(fe[0],fe[1]));$.push(te)}return $}}toGeoJSON($,W,te){return li.call(this,$,W,te)}}class Rr{constructor($,W){this.name=$,this.extent=r.aj,this.length=W.length,this._jsonFeatures=W}feature($){return new ci(this._jsonFeatures[$])}}class bs{constructor($){this.layers={},this.extent=r.aj;for(let W of Object.keys($))this.layers[W]=new Rr(W,$[W])}}let wo=64/4096,ws=128;class Zd{constructor(){this.features=new Map}clear(){this.features.clear()}load($=[],W){for(let te of $){let fe=te.id;if(fe==null)continue;let ne=this.features.get(fe);ne&&this.updateCache(ne,W),te.geometry?(ne=Ul(te),this.updateCache(ne,W),this.features.set(fe,ne)):this.features.delete(fe),this.updateCache(ne,W)}}updateCache($,W){for(let{canonical:te,uid:fe}of Object.values(W)){let{z:ne,x:_e,y:Me}=te;zn($,Math.pow(2,ne),_e,Me)&&delete W[fe]}}getTile($,W,te){let fe=Math.pow(2,$),ne=[];for(let _e of this.features.values())zn(_e,fe,W,te)&&ne.push(mr(_e,fe,W,te));return{features:ne}}getFeatures(){return[...this.features.values()]}}function zn({minX:De,minY:$,maxX:W,maxY:te},fe,ne,_e){return De<(ne+1+wo)/fe&&$<(_e+1+wo)/fe&&W>(ne-wo)/fe&&te>(_e-wo)/fe}function Ul(De){let{id:$,geometry:W,properties:te}=De;if(!W)return;if(W.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:fe,coordinates:ne}=W,_e={id:$,type:1,geometry:[],tags:te,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Me=_e.geometry;if(fe==="Point")Ei(ne,Me,_e);else if(fe==="MultiPoint")for(let ve of ne)Ei(ve,Me,_e);else if(fe==="LineString")_e.type=2,Zr(ne,Me,_e);else if(fe==="MultiLineString")_e.type=2,jr(ne,Me,_e);else if(fe==="Polygon")_e.type=3,jr(ne,Me,_e,!0);else{if(fe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");_e.type=3;for(let ve of ne)jr(ve,Me,_e,!0)}return _e}function Ei([De,$],W,te){let fe=r.aD(De),ne=r.aH($);ne=ne<0?0:ne>1?1:ne,W.push(fe,ne),te.minX=Math.min(te.minX,fe),te.minY=Math.min(te.minY,ne),te.maxX=Math.max(te.maxX,fe),te.maxY=Math.max(te.maxY,ne)}function Zr(De,$,W,te=!1,fe=!1){let ne=[];for(let _e of De)Ei(_e,ne,W);$.push(ne),te&&function(_e,Me){let ve=0;for(let Ce=0,nt=_e.length,je=nt-2;Ce<nt;je=Ce,Ce+=2)ve+=(_e[Ce]-_e[je])*(_e[Ce+1]+_e[je+1]);if(ve>0===Me)for(let Ce=0,nt=_e.length;Ce<nt/2;Ce+=2){let je=_e[Ce],Dt=_e[Ce+1];_e[Ce]=_e[nt-2-Ce],_e[Ce+1]=_e[nt-1-Ce],_e[nt-2-Ce]=je,_e[nt-1-Ce]=Dt}}(ne,fe)}function jr(De,$,W,te=!1){for(let fe=0;fe<De.length;fe++)Zr(De[fe],$,W,te,fe===0)}function mr(De,$,W,te){let{id:fe,type:ne,geometry:_e,tags:Me}=De,ve=[];if(ne===1)(function(Ce,nt,je,Dt,kt){for(let jt=0;jt<Ce.length;jt+=2){let dn=Math.round(r.aj*(Ce[jt+0]*nt-je)),rn=Math.round(r.aj*(Ce[jt+1]*nt-Dt));kt.push([dn,rn])}})(_e,$,W,te,ve);else for(let Ce of _e)uo(Ce,$,W,te,ve);return{id:fe,type:ne,geometry:ve,tags:Me}}function uo(De,$,W,te,fe){let ne=-ws,_e=r.aj+ws,Me;for(let ve=0;ve<De.length-2;ve+=2){let Ce=Math.round(r.aj*(De[ve+0]*$-W)),nt=Math.round(r.aj*(De[ve+1]*$-te)),je=Math.round(r.aj*(De[ve+2]*$-W)),Dt=Math.round(r.aj*(De[ve+3]*$-te)),kt=je-Ce,jt=Dt-nt;Ce<ne&&je<ne||(Ce<ne?(nt+=Math.round(jt*((ne-Ce)/kt)),Ce=ne):je<ne&&(Dt=nt+Math.round(jt*((ne-Ce)/kt)),je=ne),nt<ne&&Dt<ne||(nt<ne?(Ce+=Math.round(kt*((ne-nt)/jt)),nt=ne):Dt<ne&&(je=Ce+Math.round(kt*((ne-nt)/jt)),Dt=ne),Ce>=_e&&je>=_e||(Ce>=_e?(nt+=Math.round(jt*((_e-Ce)/kt)),Ce=_e):je>=_e&&(Dt=nt+Math.round(jt*((_e-Ce)/kt)),je=_e),nt>=_e&&Dt>=_e||(nt>=_e?(Ce+=Math.round(kt*((_e-nt)/jt)),nt=_e):Dt>=_e&&(je=Ce+Math.round(kt*((_e-nt)/jt)),Dt=_e),Me&&Ce===Me[Me.length-1][0]&&nt===Me[Me.length-1][1]||(Me=[[Ce,nt]],fe.push(Me)),Me.push([je,Dt])))))}}function au({name:De,features:$},W){W.writeStringField(1,De),W.writeVarintField(5,r.aj);let te=new Map,fe=new Map,ne={keys:te,values:fe,feature:null};for(let _e of $)ne.feature=_e,W.writeMessage(2,Os,ne);for(let _e of te.keys())W.writeStringField(3,_e);for(let _e of fe.keys())W.writeMessage(4,qd,_e)}function Os(De,$){let W=De.feature;W.id===void 0||isNaN(+W.id)||$.writeVarintField(1,+W.id),W.tags&&$.writeMessage(2,Zo,De),$.writeVarintField(3,W.type),$.writeMessage(4,jl,W)}function Zo({keys:De,values:$,feature:W},te){for(let fe of Object.keys(W.tags)){let ne=W.tags[fe];if(ne===null)continue;let _e=De.get(fe);_e===void 0&&(_e=De.size,De.set(fe,_e)),te.writeVarint(_e);let Me=typeof ne;Me!=="string"&&Me!=="boolean"&&Me!=="number"&&(ne=JSON.stringify(ne));let ve=$.get(ne);ve===void 0&&(ve=$.size,$.set(ne,ve)),te.writeVarint(ve)}}function hr(De,$){return($<<3)+(7&De)}function zi(De){return De<<1^De>>31}function jl(De,$){let{geometry:W,type:te}=De,fe=0,ne=0;if(te===1){$.writeVarint(hr(1,W.length));for(let _e of W){let Me=_e[0]-fe,ve=_e[1]-ne;$.writeVarint(zi(Me)),$.writeVarint(zi(ve)),fe+=Me,ne+=ve}}else for(let _e of W){$.writeVarint(hr(1,1));let Me=_e.length-(te===3?1:0);for(let ve=0;ve<Me;ve++){ve===1&&$.writeVarint(hr(2,Me-1));let Ce=_e[ve][0]-fe,nt=_e[ve][1]-ne;$.writeVarint(zi(Ce)),$.writeVarint(zi(nt)),fe+=Ce,ne+=nt}te===3&&$.writeVarint(hr(7,1))}}function qd(De,$){let W=typeof De;W==="string"?$.writeStringField(1,De):W==="boolean"?$.writeBooleanField(7,De):W==="number"&&(De%1!=0?$.writeDoubleField(3,De):De<0?$.writeSVarintField(6,De):$.writeVarintField(5,De))}let ca={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:De=>De},cr=Math.fround||(kr=new Float32Array(1),De=>(kr[0]=+De,kr[0]));var kr;let qr=3,Yi=5,Nr=6;class ua{constructor($){this.options=Object.assign(Object.create(ca),$),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load($){let{log:W,minZoom:te,maxZoom:fe}=this.options;W&&console.time("total time");let ne=`prepare ${$.length} points`;W&&console.time(ne),this.points=$;let _e=[];for(let ve=0;ve<$.length;ve++){let Ce=$[ve];if(!Ce.geometry)continue;let[nt,je]=Ce.geometry.coordinates,Dt=cr(qo(nt)),kt=cr(zr(je));_e.push(Dt,kt,1/0,ve,-1,1),this.options.reduce&&_e.push(0)}let Me=this.trees[fe+1]=this._createTree(_e);W&&console.timeEnd(ne);for(let ve=fe;ve>=te;ve--){let Ce=+Date.now();Me=this.trees[ve]=this._createTree(this._cluster(Me,ve)),W&&console.log("z%d: %d clusters in %dms",ve,Me.numItems,+Date.now()-Ce)}return W&&console.timeEnd("total time"),this}getClusters($,W){let te=(($[0]+180)%360+360)%360-180,fe=Math.max(-90,Math.min(90,$[1])),ne=$[2]===180?180:(($[2]+180)%360+360)%360-180,_e=Math.max(-90,Math.min(90,$[3]));if($[2]-$[0]>=360)te=-180,ne=180;else if(te>ne){let je=this.getClusters([te,fe,180,_e],W),Dt=this.getClusters([-180,fe,ne,_e],W);return je.concat(Dt)}let Me=this.trees[this._limitZoom(W)],ve=Me.range(qo(te),zr(_e),qo(ne),zr(fe)),Ce=Me.data,nt=[];for(let je of ve){let Dt=this.stride*je;nt.push(Ce[Dt+Yi]>1?da(Ce,Dt,this.clusterProps):this.points[Ce[Dt+qr]])}return nt}getChildren($){let W=this._getOriginId($),te=this._getOriginZoom($),fe="No cluster with the specified id.",ne=this.trees[te];if(!ne)throw new Error(fe);let _e=ne.data;if(W*this.stride>=_e.length)throw new Error(fe);let Me=this.options.radius/(this.options.extent*Math.pow(2,te-1)),ve=ne.within(_e[W*this.stride],_e[W*this.stride+1],Me),Ce=[];for(let nt of ve){let je=nt*this.stride;_e[je+4]===$&&Ce.push(_e[je+Yi]>1?da(_e,je,this.clusterProps):this.points[_e[je+qr]])}if(Ce.length===0)throw new Error(fe);return Ce}getLeaves($,W,te){let fe=[];return this._appendLeaves(fe,$,W=W||10,te=te||0,0),fe}getTile($,W,te){let fe=this.trees[this._limitZoom($)],ne=Math.pow(2,$),{extent:_e,radius:Me}=this.options,ve=Me/_e,Ce=(te-ve)/ne,nt=(te+1+ve)/ne,je={features:[]};return this._addTileFeatures(fe.range((W-ve)/ne,Ce,(W+1+ve)/ne,nt),fe.data,W,te,ne,je),W===0&&this._addTileFeatures(fe.range(1-ve/ne,Ce,1,nt),fe.data,ne,te,ne,je),W===ne-1&&this._addTileFeatures(fe.range(0,Ce,ve/ne,nt),fe.data,-1,te,ne,je),je.features.length?je:null}getClusterExpansionZoom($){let W=this._getOriginZoom($)-1;for(;W<=this.options.maxZoom;){let te=this.getChildren($);if(W++,te.length!==1)break;$=te[0].properties.cluster_id}return W}_appendLeaves($,W,te,fe,ne){let _e=this.getChildren(W);for(let Me of _e){let ve=Me.properties;if(ve&&ve.cluster?ne+ve.point_count<=fe?ne+=ve.point_count:ne=this._appendLeaves($,ve.cluster_id,te,fe,ne):ne<fe?ne++:$.push(Me),$.length===te)break}return ne}_createTree($){let W=new r.c0($.length/this.stride|0,this.options.nodeSize,Float32Array);for(let te=0;te<$.length;te+=this.stride)W.add($[te],$[te+1]);return W.finish(),W.data=$,W}_addTileFeatures($,W,te,fe,ne,_e){for(let Me of $){let ve=Me*this.stride,Ce=W[ve+Yi]>1,nt,je,Dt;if(Ce)nt=lu(W,ve,this.clusterProps),je=W[ve],Dt=W[ve+1];else{let dn=this.points[W[ve+qr]];nt=dn.properties;let[rn,hn]=dn.geometry.coordinates;je=qo(rn),Dt=zr(hn)}let kt={type:1,geometry:[[Math.round(this.options.extent*(je*ne-te)),Math.round(this.options.extent*(Dt*ne-fe))]],tags:nt},jt;jt=Ce||this.options.generateId?W[ve+qr]:this.points[W[ve+qr]].id,jt!==void 0&&(kt.id=jt),_e.features.push(kt)}}_limitZoom($){return Math.max(this.options.minZoom,Math.min(Math.floor(+$),this.options.maxZoom+1))}_cluster($,W){let{radius:te,extent:fe,reduce:ne,minPoints:_e}=this.options,Me=te/(fe*Math.pow(2,W)),ve=$.data,Ce=[],nt=this.stride;for(let je=0;je<ve.length;je+=nt){if(ve[je+2]<=W)continue;ve[je+2]=W;let Dt=ve[je],kt=ve[je+1],jt=$.within(ve[je],ve[je+1],Me),dn=ve[je+Yi],rn=dn;for(let hn of jt){let Kn=hn*nt;ve[Kn+2]>W&&(rn+=ve[Kn+Yi])}if(rn>dn&&rn>=_e){let hn,Kn=Dt*dn,fn=kt*dn,Pr=-1,ii=(je/nt<<5)+(W+1)+this.points.length;for(let Jr of jt){let $n=Jr*nt;if(ve[$n+2]<=W)continue;ve[$n+2]=W;let An=ve[$n+Yi];Kn+=ve[$n]*An,fn+=ve[$n+1]*An,ve[$n+4]=ii,ne&&(hn||(hn=this._map(ve,je,!0),Pr=this.clusterProps.length,this.clusterProps.push(hn)),ne(hn,this._map(ve,$n)))}ve[je+4]=ii,Ce.push(Kn/rn,fn/rn,1/0,ii,-1,rn),ne&&Ce.push(Pr)}else{for(let hn=0;hn<nt;hn++)Ce.push(ve[je+hn]);if(rn>1)for(let hn of jt){let Kn=hn*nt;if(!(ve[Kn+2]<=W)){ve[Kn+2]=W;for(let fn=0;fn<nt;fn++)Ce.push(ve[Kn+fn])}}}}return Ce}_getOriginId($){return $-this.points.length>>5}_getOriginZoom($){return($-this.points.length)%32}_map($,W,te){if($[W+Yi]>1){let _e=this.clusterProps[$[W+Nr]];return te?Object.assign({},_e):_e}let fe=this.points[$[W+qr]].properties,ne=this.options.map(fe);return te&&ne===fe?Object.assign({},ne):ne}}function da(De,$,W){return{type:"Feature",id:De[$+qr],properties:lu(De,$,W),geometry:{type:"Point",coordinates:[(te=De[$],360*(te-.5)),Ki(De[$+1])]}};var te}function lu(De,$,W){let te=De[$+Yi],fe=te>=1e4?`${Math.round(te/1e3)}k`:te>=1e3?Math.round(te/100)/10+"k":te,ne=De[$+Nr],_e=ne===-1?{}:Object.assign({},W[ne]);return Object.assign(_e,{cluster:!0,cluster_id:De[$+qr],point_count:te,point_count_abbreviated:fe})}function qo(De){return De/360+.5}function zr(De){let $=Math.sin(De*Math.PI/180),W=.5-.25*Math.log((1+$)/(1-$))/Math.PI;return W<0?0:W>1?1:W}function Ki(De){let $=(180-360*De)*Math.PI/180;return 360*Math.atan(Math.exp($))/Math.PI-90}function ha(De,$,W,te){let fe=te,ne=$+(W-$>>1),_e,Me=W-$,ve=De[$],Ce=De[$+1],nt=De[W],je=De[W+1];for(let Dt=$+3;Dt<W;Dt+=3){let kt=cu(De[Dt],De[Dt+1],ve,Ce,nt,je);if(kt>fe)_e=Dt,fe=kt;else if(kt===fe){let jt=Math.abs(Dt-ne);jt<Me&&(_e=Dt,Me=jt)}}fe>te&&(_e-$>3&&ha(De,$,_e,te),De[_e+2]=fe,W-_e>3&&ha(De,_e,W,te))}function cu(De,$,W,te,fe,ne){let _e=fe-W,Me=ne-te;if(_e!==0||Me!==0){let ve=((De-W)*_e+($-te)*Me)/(_e*_e+Me*Me);ve>1?(W=fe,te=ne):ve>0&&(W+=_e*ve,te+=Me*ve)}return _e=De-W,Me=$-te,_e*_e+Me*Me}function Ls(De,$,W,te){let fe={id:De??null,type:$,geometry:W,tags:te,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if($==="Point"||$==="MultiPoint"||$==="LineString")Eo(fe,W);else if($==="Polygon")Eo(fe,W[0]);else if($==="MultiLineString")for(let ne of W)Eo(fe,ne);else if($==="MultiPolygon")for(let ne of W)Eo(fe,ne[0]);return fe}function Eo(De,$){for(let W=0;W<$.length;W+=3)De.minX=Math.min(De.minX,$[W]),De.minY=Math.min(De.minY,$[W+1]),De.maxX=Math.max(De.maxX,$[W]),De.maxY=Math.max(De.maxY,$[W+1])}function ho(De,$,W,te){if(!$.geometry)return;let fe=$.geometry.coordinates;if(fe&&fe.length===0)return;let ne=$.geometry.type,_e=Math.pow(W.tolerance/((1<<W.maxZoom)*W.extent),2),Me=[],ve=$.id;if(W.promoteId?ve=$.properties[W.promoteId]:W.generateId&&(ve=te||0),ne==="Point")Fs(fe,Me);else if(ne==="MultiPoint")for(let Ce of fe)Fs(Ce,Me);else if(ne==="LineString")ks(fe,Me,_e,!1);else if(ne==="MultiLineString"){if(W.lineMetrics){for(let Ce of fe)Me=[],ks(Ce,Me,_e,!1),De.push(Ls(ve,"LineString",Me,$.properties));return}Qa(fe,Me,_e,!1)}else if(ne==="Polygon")Qa(fe,Me,_e,!0);else{if(ne!=="MultiPolygon"){if(ne==="GeometryCollection"){for(let Ce of $.geometry.geometries)ho(De,{id:ve,geometry:Ce,properties:$.properties},W,te);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let Ce of fe){let nt=[];Qa(Ce,nt,_e,!0),Me.push(nt)}}De.push(Ls(ve,ne,Me,$.properties))}function Fs(De,$){$.push(Hl(De[0]),Ji(De[1]),0)}function ks(De,$,W,te){let fe,ne,_e=0;for(let ve=0;ve<De.length;ve++){let Ce=Hl(De[ve][0]),nt=Ji(De[ve][1]);$.push(Ce,nt,0),ve>0&&(_e+=te?(fe*nt-Ce*ne)/2:Math.sqrt(Math.pow(Ce-fe,2)+Math.pow(nt-ne,2))),fe=Ce,ne=nt}let Me=$.length-3;$[2]=1,ha($,0,Me,W),$[Me+2]=1,$.size=Math.abs(_e),$.start=0,$.end=$.size}function Qa(De,$,W,te){for(let fe=0;fe<De.length;fe++){let ne=[];ks(De[fe],ne,W,te),$.push(ne)}}function Hl(De){return De/360+.5}function Ji(De){let $=Math.sin(De*Math.PI/180),W=.5-.25*Math.log((1+$)/(1-$))/Math.PI;return W<0?0:W>1?1:W}function To(De,$,W,te,fe,ne,_e,Me){if(te/=$,ne>=(W/=$)&&_e<te)return De;if(_e<W||ne>=te)return null;let ve=[];for(let Ce of De){let nt=Ce.geometry,je=Ce.type,Dt=fe===0?Ce.minX:Ce.minY,kt=fe===0?Ce.maxX:Ce.maxY;if(Dt>=W&&kt<te){ve.push(Ce);continue}if(kt<W||Dt>=te)continue;let jt=[];if(je==="Point"||je==="MultiPoint")uu(nt,jt,W,te,fe);else if(je==="LineString")Ns(nt,jt,W,te,fe,!1,Me.lineMetrics);else if(je==="MultiLineString")Mi(nt,jt,W,te,fe,!1);else if(je==="Polygon")Mi(nt,jt,W,te,fe,!0);else if(je==="MultiPolygon")for(let dn of nt){let rn=[];Mi(dn,rn,W,te,fe,!0),rn.length&&jt.push(rn)}if(jt.length){if(Me.lineMetrics&&je==="LineString"){for(let dn of jt)ve.push(Ls(Ce.id,je,dn,Ce.tags));continue}je!=="LineString"&&je!=="MultiLineString"||(jt.length===1?(je="LineString",jt=jt[0]):je="MultiLineString"),je!=="Point"&&je!=="MultiPoint"||(je=jt.length===3?"Point":"MultiPoint"),ve.push(Ls(Ce.id,je,jt,Ce.tags))}}return ve.length?ve:null}function uu(De,$,W,te,fe){for(let ne=0;ne<De.length;ne+=3){let _e=De[ne+fe];_e>=W&&_e<=te&&Io($,De[ne],De[ne+1],De[ne+2])}}function Ns(De,$,W,te,fe,ne,_e){let Me=Gl(De),ve=fe===0?fa:zs,Ce,nt,je=De.start;for(let rn=0;rn<De.length-3;rn+=3){let hn=De[rn],Kn=De[rn+1],fn=De[rn+2],Pr=De[rn+3],ii=De[rn+4],Jr=fe===0?hn:Kn,$n=fe===0?Pr:ii,An=!1;_e&&(Ce=Math.sqrt(Math.pow(hn-Pr,2)+Math.pow(Kn-ii,2))),Jr<W?$n>W&&(nt=ve(Me,hn,Kn,Pr,ii,W),_e&&(Me.start=je+Ce*nt)):Jr>te?$n<te&&(nt=ve(Me,hn,Kn,Pr,ii,te),_e&&(Me.start=je+Ce*nt)):Io(Me,hn,Kn,fn),$n<W&&Jr>=W&&(nt=ve(Me,hn,Kn,Pr,ii,W),An=!0),$n>te&&Jr<=te&&(nt=ve(Me,hn,Kn,Pr,ii,te),An=!0),!ne&&An&&(_e&&(Me.end=je+Ce*nt),$.push(Me),Me=Gl(De)),_e&&(je+=Ce)}let Dt=De.length-3,kt=De[Dt],jt=De[Dt+1],dn=fe===0?kt:jt;dn>=W&&dn<=te&&Io(Me,kt,jt,De[Dt+2]),Dt=Me.length-3,ne&&Dt>=3&&(Me[Dt]!==Me[0]||Me[Dt+1]!==Me[1])&&Io(Me,Me[0],Me[1],Me[2]),Me.length&&$.push(Me)}function Gl(De){let $=[];return $.size=De.size,$.start=De.start,$.end=De.end,$}function Mi(De,$,W,te,fe,ne){for(let _e of De)Ns(_e,$,W,te,fe,ne,!1)}function Io(De,$,W,te){De.push($,W,te)}function fa(De,$,W,te,fe,ne){let _e=(ne-$)/(te-$);return Io(De,ne,W+(fe-W)*_e,1),_e}function zs(De,$,W,te,fe,ne){let _e=(ne-W)/(fe-W);return Io(De,$+(te-$)*_e,ne,1),_e}function pa(De,$){let W=[];for(let te=0;te<De.length;te++){let fe=De[te],ne=fe.type,_e;if(ne==="Point"||ne==="MultiPoint"||ne==="LineString")_e=ma(fe.geometry,$);else if(ne==="MultiLineString"||ne==="Polygon"){_e=[];for(let Me of fe.geometry)_e.push(ma(Me,$))}else if(ne==="MultiPolygon"){_e=[];for(let Me of fe.geometry){let ve=[];for(let Ce of Me)ve.push(ma(Ce,$));_e.push(ve)}}W.push(Ls(fe.id,ne,_e,fe.tags))}return W}function ma(De,$){let W=[];W.size=De.size,De.start!==void 0&&(W.start=De.start,W.end=De.end);for(let te=0;te<De.length;te+=3)W.push(De[te]+$,De[te+1],De[te+2]);return W}function $l(De,$){if(De.transformed)return De;let W=1<<De.z,te=De.x,fe=De.y;for(let ne of De.features){let _e=ne.geometry,Me=ne.type;if(ne.geometry=[],Me===1)for(let ve=0;ve<_e.length;ve+=2)ne.geometry.push(ur(_e[ve],_e[ve+1],$,W,te,fe));else for(let ve=0;ve<_e.length;ve++){let Ce=[];for(let nt=0;nt<_e[ve].length;nt+=2)Ce.push(ur(_e[ve][nt],_e[ve][nt+1],$,W,te,fe));ne.geometry.push(Ce)}}return De.transformed=!0,De}function ur(De,$,W,te,fe,ne){return[Math.round(W*(De*te-fe)),Math.round(W*($*te-ne))]}function du(De,$,W,te,fe){let ne=$===fe.maxZoom?0:fe.tolerance/((1<<$)*fe.extent),_e={features:[],numPoints:0,numSimplified:0,numFeatures:De.length,source:null,x:W,y:te,z:$,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let Me of De)hu(_e,Me,ne,fe);return _e}function hu(De,$,W,te){let fe=$.geometry,ne=$.type,_e=[];if(De.minX=Math.min(De.minX,$.minX),De.minY=Math.min(De.minY,$.minY),De.maxX=Math.max(De.maxX,$.maxX),De.maxY=Math.max(De.maxY,$.maxY),ne==="Point"||ne==="MultiPoint")for(let Me=0;Me<fe.length;Me+=3)_e.push(fe[Me],fe[Me+1]),De.numPoints++,De.numSimplified++;else if(ne==="LineString")So(_e,fe,De,W,!1,!1);else if(ne==="MultiLineString"||ne==="Polygon")for(let Me=0;Me<fe.length;Me++)So(_e,fe[Me],De,W,ne==="Polygon",Me===0);else if(ne==="MultiPolygon")for(let Me=0;Me<fe.length;Me++){let ve=fe[Me];for(let Ce=0;Ce<ve.length;Ce++)So(_e,ve[Ce],De,W,!0,Ce===0)}if(_e.length){let Me=$.tags||null;if(ne==="LineString"&&te.lineMetrics){Me={};for(let Ce in $.tags)Me[Ce]=$.tags[Ce];Me.mapbox_clip_start=fe.start/fe.size,Me.mapbox_clip_end=fe.end/fe.size}let ve={geometry:_e,type:ne==="Polygon"||ne==="MultiPolygon"?3:ne==="LineString"||ne==="MultiLineString"?2:1,tags:Me};$.id!==null&&(ve.id=$.id),De.features.push(ve)}}function So(De,$,W,te,fe,ne){let _e=te*te;if(te>0&&$.size<(fe?_e:te))return void(W.numPoints+=$.length/3);let Me=[];for(let ve=0;ve<$.length;ve+=3)(te===0||$[ve+2]>_e)&&(W.numSimplified++,Me.push($[ve],$[ve+1])),W.numPoints++;fe&&function(ve,Ce){let nt=0;for(let je=0,Dt=ve.length,kt=Dt-2;je<Dt;kt=je,je+=2)nt+=(ve[je]-ve[kt])*(ve[je+1]+ve[kt+1]);if(nt>0===Ce)for(let je=0,Dt=ve.length;je<Dt/2;je+=2){let kt=ve[je],jt=ve[je+1];ve[je]=ve[Dt-2-je],ve[je+1]=ve[Dt-1-je],ve[Dt-2-je]=kt,ve[Dt-1-je]=jt}}(Me,ne),De.push(Me)}let fu={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class xp{constructor($,W){let te=(W=this.options=function(ne,_e){for(let Me in _e)ne[Me]=_e[Me];return ne}(Object.create(fu),W)).debug;if(te&&console.time("preprocess data"),W.maxZoom<0||W.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(W.promoteId&&W.generateId)throw new Error("promoteId and generateId cannot be used together.");let fe=function(ne,_e){let Me=[];if(ne.type==="FeatureCollection")for(let ve=0;ve<ne.features.length;ve++)ho(Me,ne.features[ve],_e,ve);else ho(Me,ne.type==="Feature"?ne:{geometry:ne},_e);return Me}($,W);this.tiles={},this.tileCoords=[],te&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",W.indexMaxZoom,W.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),fe=function(ne,_e){let Me=_e.buffer/_e.extent,ve=ne,Ce=To(ne,1,-1-Me,Me,0,-1,2,_e),nt=To(ne,1,1-Me,2+Me,0,-1,2,_e);return(Ce||nt)&&(ve=To(ne,1,-Me,1+Me,0,-1,2,_e)||[],Ce&&(ve=pa(Ce,1).concat(ve)),nt&&(ve=ve.concat(pa(nt,-1)))),ve}(fe,W),fe.length&&this.splitTile(fe,0,0,0),te&&(fe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile($,W,te,fe,ne,_e,Me){let ve=[$,W,te,fe],Ce=this.options,nt=Ce.debug;for(;ve.length;){fe=ve.pop(),te=ve.pop(),W=ve.pop(),$=ve.pop();let je=1<<W,Dt=Wl(W,te,fe),kt=this.tiles[Dt];if(!kt&&(nt>1&&console.time("creation"),kt=this.tiles[Dt]=du($,W,te,fe,Ce),this.tileCoords.push({z:W,x:te,y:fe}),nt)){nt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",W,te,fe,kt.numFeatures,kt.numPoints,kt.numSimplified),console.timeEnd("creation"));let An=`z${W}`;this.stats[An]=(this.stats[An]||0)+1,this.total++}if(kt.source=$,ne==null){if(W===Ce.indexMaxZoom||kt.numPoints<=Ce.indexMaxPoints)continue}else{if(W===Ce.maxZoom||W===ne)continue;if(ne!=null){let An=ne-W;if(te!==_e>>An||fe!==Me>>An)continue}}if(kt.source=null,$.length===0)continue;nt>1&&console.time("clipping");let jt=.5*Ce.buffer/Ce.extent,dn=.5-jt,rn=.5+jt,hn=1+jt,Kn=null,fn=null,Pr=null,ii=null,Jr=To($,je,te-jt,te+rn,0,kt.minX,kt.maxX,Ce),$n=To($,je,te+dn,te+hn,0,kt.minX,kt.maxX,Ce);$=null,Jr&&(Kn=To(Jr,je,fe-jt,fe+rn,1,kt.minY,kt.maxY,Ce),fn=To(Jr,je,fe+dn,fe+hn,1,kt.minY,kt.maxY,Ce),Jr=null),$n&&(Pr=To($n,je,fe-jt,fe+rn,1,kt.minY,kt.maxY,Ce),ii=To($n,je,fe+dn,fe+hn,1,kt.minY,kt.maxY,Ce),$n=null),nt>1&&console.timeEnd("clipping"),ve.push(Kn||[],W+1,2*te,2*fe),ve.push(fn||[],W+1,2*te,2*fe+1),ve.push(Pr||[],W+1,2*te+1,2*fe),ve.push(ii||[],W+1,2*te+1,2*fe+1)}}getTile($,W,te){$=+$,W=+W,te=+te;let fe=this.options,{extent:ne,debug:_e}=fe;if($<0||$>24)return null;let Me=1<<$,ve=Wl($,W=W+Me&Me-1,te);if(this.tiles[ve])return $l(this.tiles[ve],ne);_e>1&&console.log("drilling down to z%d-%d-%d",$,W,te);let Ce,nt=$,je=W,Dt=te;for(;!Ce&&nt>0;)nt--,je>>=1,Dt>>=1,Ce=this.tiles[Wl(nt,je,Dt)];return Ce&&Ce.source?(_e>1&&(console.log("found parent tile z%d-%d-%d",nt,je,Dt),console.time("drilling down")),this.splitTile(Ce.source,nt,je,Dt,$,W,te),_e>1&&console.timeEnd("drilling down"),this.tiles[ve]?$l(this.tiles[ve],ne):null):null}}function Wl(De,$,W){return 32*((1<<De)*W+$)+De}function Xe(De,$){let W=De.tileID.canonical;if(!this._geoJSONIndex)return void $(null,null);let te=this._geoJSONIndex.getTile(W.z,W.x,W.y);if(!te)return void $(null,null);let fe=Ce=>Ce.tags&&"3d_elevation_id"in Ce.tags&&"source"in Ce.tags&&Ce.tags.source==="elevation",ne=te.features.filter(Ce=>fe(Ce)),_e={_geojsonTileLayer:te.features};ne.length>0&&(_e={_geojsonTileLayer:te.features.filter(Ce=>!fe(Ce)),hd_road_elevation:ne});let Me=new bs(_e),ve=function(Ce){let nt=new r.bq;for(let je of Object.keys(Ce))nt.writeMessage(3,au,{name:je,features:Ce[je]});return nt.finish()}(_e).buffer;$(null,{vectorTile:Me,rawData:ve})}class Bs extends Ct{constructor($,W,te,fe,ne,_e,Me){super($,W,te,fe,ne,Xe,Me),_e&&(this.loadGeoJSON=_e),this._dynamicIndex=new Zd}loadData($,W){let te=$&&$.request,fe=te&&te.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON($,(ne,_e)=>{if(ne||!_e)return W(ne);if(typeof _e!="object")return W(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`));{try{if($.filter){let ve=r.X($.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ve.result==="error")throw new Error(ve.value.map(Ce=>`${Ce.key}: ${Ce.message}`).join(", "));_e.features=_e.features.filter(Ce=>ve.value.evaluate({zoom:0},Ce))}$.dynamic?(_e.type==="Feature"&&(_e={type:"FeatureCollection",features:[_e]}),$.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(_e.features,this.loaded),$.cluster&&(_e.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=$.cluster?new ua(function({superclusterOptions:ve,clusterProperties:Ce}){if(!Ce||!ve)return ve;let nt={},je={},Dt={accumulated:null,zoom:0},kt={properties:null},jt=Object.keys(Ce);for(let dn of jt){let[rn,hn]=Ce[dn],Kn=r.X(hn),fn=r.X(typeof rn=="string"?[rn,["accumulated"],["get",dn]]:rn);nt[dn]=Kn.value,je[dn]=fn.value}return ve.map=dn=>{kt.properties=dn;let rn={};for(let hn of jt)rn[hn]=nt[hn].evaluate(Dt,kt);return rn},ve.reduce=(dn,rn)=>{kt.properties=rn;for(let hn of jt)Dt.accumulated=dn[hn],dn[hn]=je[hn].evaluate(Dt,kt)},ve}($)).load(_e.features):$.dynamic?this._dynamicIndex:function(ve,Ce){return new xp(ve,Ce)}(_e,$.geojsonVtOptions)}catch(ve){return W(ve)}let Me={};if(fe){let ve=M(te);ve&&(Me.resourceTiming={},Me.resourceTiming[$.source]=JSON.parse(JSON.stringify(ve)))}W(null,Me)}})}reloadTile($,W){let te=this.loaded;return te&&te[$.uid]?$.partial?W(null,void 0):super.reloadTile($,W):this.loadTile($,W)}loadGeoJSON($,W){if($.request)r.n($.request,W);else{if(typeof $.data!="string")return W(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return W(null,JSON.parse($.data))}catch{return W(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom($,W){try{W(null,this._geoJSONIndex.getClusterExpansionZoom($.clusterId))}catch(te){W(te)}}getClusterChildren($,W){try{W(null,this._geoJSONIndex.getChildren($.clusterId))}catch(te){W(te)}}getClusterLeaves($,W){try{W(null,this._geoJSONIndex.getLeaves($.clusterId,$.limit,$.offset))}catch(te){W(te)}}}class bp{constructor($,W,te){this.tileID=new r.aM($.tileID.overscaledZ,$.tileID.wrap,$.tileID.canonical.z,$.tileID.canonical.x,$.tileID.canonical.y),this.tileZoom=$.tileZoom,this.uid=$.uid,this.zoom=$.zoom,this.canonical=$.tileID.canonical,this.pixelRatio=$.pixelRatio,this.tileSize=$.tileSize,this.source=$.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=$.projection,this.brightness=W,this.worldview=te}parse($,W,te,fe){this.status="parsing";let ne=new r.aM(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),_e=[],Me=W.familiesBySource[te.source],ve=new r.fc(ne,te.promoteId);ve.bucketLayerIDs=[],ve.is3DTile=!0,r.fr($).then(Ce=>{if(!Ce)return fe(new Error("Could not parse tile"));let nt=Ce.json.extensionsUsed&&Ce.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ce.json.asset.extras&&Ce.json.asset.extras.MAPBOX_mesh_features,je=Ce.json.extensionsUsed&&Ce.json.extensionsUsed.includes("EXT_meshopt_compression"),Dt=new r.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(let kt in Me)for(let jt of Me[kt]){let dn=jt[0];ve.bucketLayerIDs.push(jt.map(Kn=>r.C(Kn.id,Kn.scope))),dn.recalculate(Dt,[]);let rn=r.fs(Ce,1/r.d4(te.tileID.canonical)),hn=new r.ft(jt,rn,ne,nt,je,this.brightness,ve,this.worldview);nt||(hn.needsUpload=!0),_e.push(hn),hn.evaluate(dn)}this.status="done",fe(null,{buckets:_e,featureIndex:ve,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ce=>fe(new Error(Ce.message)))}}class pu{constructor($,W,te,fe,ne,_e,Me,ve){this.actor=$,this.layerIndex=W,this.availableImages=te,this.availableModels=fe,this.brightness=Me,this.loading={},this.loaded={},this.worldview=ve}loadTile($,W){let te=$.uid,fe=this.loading[te]=new bp($,this.brightness,this.worldview);r.br($.request,(ne,_e)=>{let Me=!this.loading[te];return delete this.loading[te],Me||ne?(fe.status="done",Me||(this.loaded[te]=fe),W(ne)):_e&&_e.byteLength!==0?void fe.parse(_e,this.layerIndex,$,(ve,Ce)=>{fe.status="done",this.loaded=this.loaded||{},this.loaded[te]=fe,ve||!Ce?W(ve):W(null,Ce)}):(fe.status="done",this.loaded[te]=fe,W())})}reloadTile($,W){let te=this.loaded,fe=$.uid;if(te&&te[fe]){let ne=te[fe];ne.projection=$.projection,ne.brightness=$.brightness;let _e=(Me,ve)=>{ne.reloadCallback&&(delete ne.reloadCallback,this.loadTile($,W)),W(Me,ve)};ne.status==="parsing"?ne.reloadCallback=_e:ne.status==="done"&&this.loadTile($,W)}}abortTile($,W){let te=$.uid;this.loading[te]&&delete this.loading[te],W()}removeTile($,W){let te=this.loaded,fe=$.uid;te&&te[fe]&&delete te[fe],W()}}class Sn{constructor($){this.self=$,this.actor=new r.fv($,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new r.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=r.cj({name:"mercator"}),this.workerSourceTypes={vector:Ct,geojson:Bs,"raster-dem":Vt,"raster-array":Nt,"batched-model":pu},this.workerSources={},this.self.registerWorkerSource=(W,te)=>{if(this.workerSourceTypes[W])throw new Error(`Worker source with name "${W}" already registered.`);this.workerSourceTypes[W]=te},this.self.registerRTLTextPlugin=W=>{if(r.fw.isParsed())throw new Error("RTL text plugin already registered.");r.fw.setState({pluginStatus:r.fx.parsed,pluginURL:r.fw.getPluginURL()}),r.fw.applyArabicShaping=W.applyArabicShaping,r.fw.processBidirectionalText=W.processBidirectionalText,r.fw.processStyledBidirectionalText=W.processStyledBidirectionalText;for(let te of this.rtlPluginParsingListeners)te(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches($,W,te){delete this.layerIndexes[$],delete this.availableImages[$],delete this.availableModels[$],delete this.workerSources[$],te()}checkIfReady($,W,te){te()}setReferrer($,W){this.referrer=W}spriteLoaded($,W){this.isSpriteLoaded[$]||(this.isSpriteLoaded[$]={});let{scope:te,isLoaded:fe}=W;if(this.isSpriteLoaded[$][te]=fe,this.workerSources[$]&&this.workerSources[$][te])for(let ne in this.workerSources[$][te]){let _e=this.workerSources[$][te][ne];for(let Me in _e){let ve=_e[Me];ve instanceof Ct&&(ve.isSpriteLoaded=fe,ve.fire(new r.A("isSpriteLoaded")))}}}setImages($,W,te){this.availableImages[$]||(this.availableImages[$]={});let{scope:fe,images:ne}=W;if(this.availableImages[$][fe]=ne,this.workerSources[$]&&this.workerSources[$][fe]){for(let _e in this.workerSources[$][fe]){let Me=this.workerSources[$][fe][_e];for(let ve in Me)Me[ve].availableImages=ne}te()}else te()}setModels($,{scope:W,models:te},fe){if(this.availableModels[$]||(this.availableModels[$]={}),this.availableModels[$][W]=te,this.workerSources[$]&&this.workerSources[$][W]){for(let ne in this.workerSources[$][W]){let _e=this.workerSources[$][W][ne];for(let Me in _e)_e[Me].availableModels=te}fe()}else fe()}setProjection($,W){this.projections[$]=r.cj(W)}setBrightness($,W,te){this.brightness=W,te()}setWorldview($,W,te){this.worldview=W,te()}setLayers($,W,te){this.getLayerIndex($,W.scope).replace(W.layers,W.options),te()}updateLayers($,W,te){this.getLayerIndex($,W.scope).update(W.layers,W.removedIds,W.options),te()}loadTile($,W,te){W.projection=this.projections[$]||this.defaultProjection,this.getWorkerSource($,W.type,W.source,W.scope).loadTile(W,te)}decodeRasterArray($,W,te){this.getWorkerSource($,W.type,W.source,W.scope).decodeRasterArray(W,te)}reloadTile($,W,te){W.projection=this.projections[$]||this.defaultProjection,this.getWorkerSource($,W.type,W.source,W.scope).reloadTile(W,te)}abortTile($,W,te){this.getWorkerSource($,W.type,W.source,W.scope).abortTile(W,te)}removeTile($,W,te){this.getWorkerSource($,W.type,W.source,W.scope).removeTile(W,te)}removeSource($,W,te){if(!(this.workerSources[$]&&this.workerSources[$][W.scope]&&this.workerSources[$][W.scope][W.type]&&this.workerSources[$][W.scope][W.type][W.source]))return;let fe=this.workerSources[$][W.scope][W.type][W.source];delete this.workerSources[$][W.scope][W.type][W.source],fe.removeSource!==void 0?fe.removeSource(W,te):te()}loadWorkerSource($,W,te){try{this.self.importScripts(W.url),te()}catch(fe){te(fe.toString())}}syncRTLPluginState($,W,te){if(r.fw.isParsed())te(null,!0);else if(r.fw.isParsing())this.rtlPluginParsingListeners.push(te);else try{r.fw.setState(W);let fe=r.fw.getPluginURL();!r.fw.isLoaded()||r.fw.isParsed()||r.fw.isParsing()||fe==null||(r.fw.setState({pluginStatus:r.fx.parsing,pluginURL:r.fw.getPluginURL()}),this.self.importScripts(fe),r.fw.isParsed()?te(null,!0):this.rtlPluginParsingListeners.push(te))}catch(fe){te(fe.toString())}}setDracoUrl($,W){this.dracoUrl=W}getAvailableImages($,W){this.availableImages[$]||(this.availableImages[$]={});let te=this.availableImages[$][W];return te||(te=[]),te}getAvailableModels($,W){this.availableModels[$]||(this.availableModels[$]={});let te=this.availableModels[$][W];return te||(te={}),te}getLayerIndex($,W){this.layerIndexes[$]||(this.layerIndexes[$]={});let te=this.layerIndexes[$][W];return te||(te=this.layerIndexes[$][W]=new ae,te.scope=W),te}getWorkerSource($,W,te,fe){let ne=this.workerSources;return ne[$]||(ne[$]={}),ne[$][fe]||(ne[$][fe]={}),ne[$][fe][W]||(ne[$][fe][W]={}),this.isSpriteLoaded[$]||(this.isSpriteLoaded[$]={}),ne[$][fe][W][te]||(ne[$][fe][W][te]=new this.workerSourceTypes[W]({send:(_e,Me,ve,Ce,nt,je)=>this.actor.send(_e,Me,ve,$,nt,je),scheduler:this.actor.scheduler},this.getLayerIndex($,fe),this.getAvailableImages($,fe),this.getAvailableModels($,fe),this.isSpriteLoaded[$][fe],void 0,this.brightness,this.worldview)),ne[$][fe][W][te]}rasterizeImagesWorker($,W,te){let fe=new Map;for(let[ne,{image:_e,imageVariant:Me}]of W.tasks.entries()){let ve=this.imageRasterizer.rasterize(Me,_e,W.scope,$);fe.set(ne,ve)}te(void 0,fe)}removeRasterizedImages($,W,te){this.imageRasterizer.removeImagesFromCacheByIds(W.imageIds,W.scope,$),te()}enforceCacheSizeLimit($,W){r.fy(W)}getWorkerPerformanceMetrics($,W,te){te(void 0,void 0)}}return r.fu(self)&&(self.worker=new Sn(self)),Sn}),m(["./shared"],function(r){var M="3.14.0";let k={create:"create",load:"load",fullLoad:"fullLoad"},U={mark(d){performance.mark(d)},measure(d,t,o){performance.measure(d,t,o)}};function ae(d){let t=d.name.split("?")[0];return r.a(t)&&t.includes("mapbox-gl.js")?"javascript":r.a(t)&&t.includes("mapbox-gl.css")?"css":r.b(t)?"fontRange":r.c(t)?"sprite":r.i(t)?"style":r.d(t)?"tilejson":"other"}var Ee,Be={},ht=function(){if(Ee)return Be;function d(h){return!t(h)}function t(h){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var _,v,E=new Blob([""],{type:"text/javascript"}),T=URL.createObjectURL(E);try{v=new Worker(T),_=!0}catch{_=!1}return v&&v.terminate(),URL.revokeObjectURL(T),_}()?function(){var _=document.createElement("canvas");_.width=_.height=1;var v=_.getContext("2d");if(!v)return!1;var E=v.getImageData(0,0,1,1);return E&&E.width===_.width}()?(o[g=h&&h.failIfMajorPerformanceCaveat]===void 0&&(o[g]=function(_){var v,E=function(T){var C=document.createElement("canvas"),A=Object.create(d.webGLContextAttributes);return A.failIfMajorPerformanceCaveat=T,C.getContext("webgl2",A)}(_);if(!E)return!1;try{v=E.createShader(E.VERTEX_SHADER)}catch{return!1}return!(!v||E.isContextLost())&&(E.shaderSource(v,"void main() {}"),E.compileShader(v),E.getShaderParameter(v,E.COMPILE_STATUS)===!0)}(g)),o[g]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var g}Ee=1,Be.supported=d,Be.notSupportedReason=t;var o={};return d.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Be}();function Oe(d,t,o){let h=document.createElement(d);return t!=null&&(h.className=t),o&&o.appendChild(h),h}function Ct(d,t,o){let h=document.createElementNS("http://www.w3.org/2000/svg",d);for(let g of Object.keys(t))h.setAttributeNS(null,g,String(t[g]));return o&&o.appendChild(h),h}let Vt=typeof document<"u"?document.documentElement&&document.documentElement.style:null,Ut=Vt&&Vt.userSelect!==void 0?"userSelect":"WebkitUserSelect",Nt;function li(){Vt&&Ut&&(Nt=Vt[Ut],Vt[Ut]="none")}function ci(){Vt&&Ut&&(Vt[Ut]=Nt)}function Rr(d){d.preventDefault(),d.stopPropagation(),window.removeEventListener("click",Rr,!0)}function bs(){window.addEventListener("click",Rr,!0),window.setTimeout(()=>{window.removeEventListener("click",Rr,!0)},0)}function wo(d,t){let o=d.getBoundingClientRect();return zn(d,o,t)}function ws(d,t){let o=d.getBoundingClientRect(),h=[];for(let g=0;g<t.length;g++)h.push(zn(d,o,t[g]));return h}function Zd(d){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&d.button===2&&d.ctrlKey?0:d.button}function zn(d,t,o){let h=d.offsetWidth===t.width?1:d.offsetWidth/t.width;return new r.P((o.clientX-t.left)*h,(o.clientY-t.top)*h)}let Ul="01",Ei="NO_ACCESS_TOKEN";class Zr{constructor(t,o,h){this._transformRequestFn=t,this._customAccessToken=o,this._silenceAuthErrors=!!h,this._createSkuToken()}_createSkuToken(){let t=function(){let o="";for(let h=0;h<10;h++)o+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Ul,o].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,o){return this._transformRequestFn&&this._transformRequestFn(t,o)||{url:t}}normalizeStyleURL(t,o){if(!r.j(t))return t;let h=mr(t);return h.params.push(`sdk=js-${M}`),h.path=`/styles/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeGlyphsURL(t,o){if(!r.j(t))return t;let h=mr(t);return h.path=`/fonts/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeModelURL(t,o){if(!r.j(t))return t;let h=mr(t);return h.path=`/models/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeSourceURL(t,o,h,g){if(!r.j(t))return t;let _=mr(t);return _.path=`/v4/${_.authority}.json`,_.params.push("secure"),h&&_.params.push(`language=${h}`),g&&_.params.push(`worldview=${g}`),this._makeAPIURL(_,this._customAccessToken||o)}normalizeIconsetURL(t,o){let h=mr(t);return r.j(t)?(h.path=`/styles/v1${h.path}/iconset.pbf`,this._makeAPIURL(h,this._customAccessToken||o)):uo(h)}normalizeSpriteURL(t,o,h,g){let _=mr(t);return r.j(t)?(_.path=`/styles/v1${_.path}/sprite${o}${h}`,this._makeAPIURL(_,this._customAccessToken||g)):(_.path+=`${o}${h}`,uo(_))}normalizeTileURL(t,o,h){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!r.j(t))return t;let g=mr(t);g.path=g.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${o||h&&g.authority!=="raster"&&h===512?"@2x":""}${r.l.supported?".webp":"$1"}`),g.authority==="raster"?g.path=`/${r.e.RASTER_URL_PREFIX}${g.path}`:g.authority==="rasterarrays"?g.path=`/${r.e.RASTERARRAYS_URL_PREFIX}${g.path}`:g.authority==="3dtiles"?g.path=`/${r.e.TILES3D_URL_PREFIX}${g.path}`:(g.path=g.path.replace(/^.+\/v4\//,"/"),g.path=`/${r.e.TILE_URL_VERSION}${g.path}`);let _=this._customAccessToken||function(v){for(let E of v){let T=E.match(/^access_token=(.*)$/);if(T)return T[1]}return null}(g.params)||r.e.ACCESS_TOKEN;return r.e.REQUIRE_ACCESS_TOKEN&&_&&this._skuToken&&g.params.push(`sku=${this._skuToken}`),this._makeAPIURL(g,_)}canonicalizeTileURL(t,o){let h=mr(t);if(!h.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!h.path.match(/\.[\w]+$/))return t;let g="mapbox://";h.path.match(/^\/raster\/v1\//)?g+=`raster/${h.path.replace(`/${r.e.RASTER_URL_PREFIX}/`,"")}`:h.path.match(/^\/rasterarrays\/v1\//)?g+=`rasterarrays/${h.path.replace(`/${r.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:g+=`tiles/${h.path.replace(`/${r.e.TILE_URL_VERSION}/`,"")}`;let _=h.params;return o&&(_=_.filter(v=>!v.match(/^access_token=/))),_.length&&(g+=`?${_.join("&")}`),g}canonicalizeTileset(t,o){let h=!!o&&r.j(o),g=[];for(let _ of t.tiles||[])r.k(_)?g.push(this.canonicalizeTileURL(_,h)):g.push(_);return g}_makeAPIURL(t,o){let h="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",g=mr(r.e.API_URL);if(t.protocol=g.protocol,t.authority=g.authority,t.protocol==="http"){let _=t.params.indexOf("secure");_>=0&&t.params.splice(_,1)}if(g.path!=="/"&&(t.path=`${g.path}${t.path}`),!r.e.REQUIRE_ACCESS_TOKEN)return uo(t);if(o=o||r.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!o)throw new Error(`An API access token is required to use Mapbox GL. ${h}`);if(o[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${h}`)}return t.params=t.params.filter(_=>_.indexOf("access_token")===-1),t.params.push(`access_token=${o||""}`),uo(t)}}let jr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function mr(d){let t=d.match(jr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function uo(d){let t=d.params.length?`?${d.params.join("&")}`:"";return`${d.protocol}://${d.authority}${d.path}${t}`}let au="mapbox.eventData";function Os(d){if(!d)return null;let t=d.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(r.m(t[1]))}catch{return null}}class Zo{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){let o=Os(r.e.ACCESS_TOKEN),h="";return h=o&&o.u?r.f(o.u):r.e.ACCESS_TOKEN||"",t?`${au}.${t}:${h}`:`${au}:${h}`}fetchEventData(){let t=r.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid");if(t)try{let g=localStorage.getItem(o);g&&(this.eventData=JSON.parse(g));let _=localStorage.getItem(h);_&&(this.anonId=_)}catch{r.w("Unable to read from LocalStorage")}}saveEventData(){let t=r.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid"),g=this.anonId;if(t&&g)try{localStorage.setItem(h,g),Object.keys(this.eventData).length>=1&&localStorage.setItem(o,JSON.stringify(this.eventData))}catch{r.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,o,h,g){if(!r.e.EVENTS_URL)return;let _=mr(r.e.EVENTS_URL);_.params.push(`access_token=${g||r.e.ACCESS_TOKEN||""}`);let v={event:this.type,created:new Date(t).toISOString()},E=o?r.h(v,o):v,T={url:uo(_),headers:{"Content-Type":"text/plain"},body:JSON.stringify([E])};this.pendingRequest=r.p(T,C=>{this.pendingRequest=null,h(C),this.saveEventData(),this.processRequests(g)})}queueRequest(t,o){this.queue.push(t),this.processRequests(o)}}let hr=new class extends Zo{constructor(d){super("appUserTurnstile"),this._customAccessToken=d}postTurnstileEvent(d,t){r.e.EVENTS_URL&&r.e.ACCESS_TOKEN&&Array.isArray(d)&&d.some(o=>r.j(o)||r.k(o))&&this.queueRequest(Date.now(),t)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let t=Os(r.e.ACCESS_TOKEN),o=t?t.u:r.e.ACCESS_TOKEN,h=o!==this.eventData.tokenU;r.v(this.anonId)||(this.anonId=r.u(),h=!0);let g=this.queue.shift();if(this.eventData.lastSuccess){let _=new Date(this.eventData.lastSuccess),v=new Date(g),E=(g-this.eventData.lastSuccess)/864e5;h=h||E>=1||E<-1||_.getDate()!==v.getDate()}else h=!0;h?this.postEvent(g,{sdkIdentifier:"mapbox-gl-js",sdkVersion:M,skuId:Ul,"enabled.telemetry":!1,userId:this.anonId},_=>{_||(this.eventData.lastSuccess=g,this.eventData.tokenU=o)},d):this.processRequests()}},zi=hr.postTurnstileEvent.bind(hr),jl=new class extends Zo{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(d,t,o,h){this.skuToken=t,this.errorCb=h,r.e.EVENTS_URL&&(o||r.e.ACCESS_TOKEN?this.queueRequest({id:d,timestamp:Date.now()},o):this.errorCb(new Error(Ei)))}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),r.v(this.anonId)||(this.anonId=r.u()),this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:M,skuId:Ul,skuToken:this.skuToken,userId:this.anonId},h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},d))}remove(){this.errorCb=null}},qd=jl.postMapLoadEvent.bind(jl),ca=new class extends Zo{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(d){let t=this.mapInstanceIdMap.get(d);return t||(t=r.u(),this.mapInstanceIdMap.set(d,t)),t}getEventId(d){let t=this.eventIdPerMapInstanceMap.get(d)||0;return this.eventIdPerMapInstanceMap.set(d,t+1),t}postStyleLoadEvent(d,t){let{map:o,style:h,importedStyles:g}=t;if(!r.e.EVENTS_URL||!d&&!r.e.ACCESS_TOKEN)return;let _=this.getMapInstanceId(o),v={mapInstanceId:_,eventId:this.getEventId(_),style:h};g.length&&(v.importedStyles=g),this.queueRequest({timestamp:Date.now(),payload:v},d)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,payload:o}=this.queue.shift();this.postEvent(t,o,()=>{},d)}},cr=ca.postStyleLoadEvent.bind(ca),kr=new class extends Zo{constructor(){super("gljs.performance")}postPerformanceEvent(d,t){r.e.EVENTS_URL&&(d||r.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},d)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,performanceData:o}=this.queue.shift(),h=function(g){let _=performance.getEntriesByType("resource"),v=performance.getEntriesByType("mark"),E=function(F){let V={};if(F){for(let z in F)if(z!=="other")for(let H of F[z]){let j=`${z}ResolveRangeMin`,Z=`${z}ResolveRangeMax`,Y=`${z}RequestCount`,J=`${z}RequestCachedCount`;V[j]=Math.min(V[j]||1/0,H.startTime),V[Z]=Math.max(V[Z]||-1/0,H.responseEnd);let re=ce=>{V[ce]===void 0&&(V[ce]=0),++V[ce]};H.transferSize!==void 0&&H.transferSize===0&&re(J),re(Y)}}return V}(function(F,V){let z={};if(F)for(let H of F){let j=V(H);z[j]===void 0&&(z[j]=[]),z[j].push(H)}return z}(_,ae)),T=window.devicePixelRatio,C=navigator.connection||navigator.mozConnection||navigator.webkitConnection,A=C?C.effectiveType:void 0,L={counters:[],metadata:[],attributes:[]},R=(F,V,z)=>{z!=null&&F.push({name:V,value:z.toString()})};for(let F in E)R(L.counters,F,E[F]);if(g.interactionRange[0]!==1/0&&g.interactionRange[1]!==-1/0&&(R(L.counters,"interactionRangeMin",g.interactionRange[0]),R(L.counters,"interactionRangeMax",g.interactionRange[1])),v)for(let F of Object.keys(k)){let V=k[F],z=v.find(H=>H.name===V);z&&R(L.counters,V,z.startTime)}return R(L.counters,"visibilityHidden",g.visibilityHidden),R(L.attributes,"style",function(F){if(F)for(let V of F){let z=V.name.split("?")[0];if(r.i(z)){let H=z.split("/").slice(-2);if(H.length===2)return`mapbox://styles/${H[0]}/${H[1]}`}}}(_)),R(L.attributes,"terrainEnabled",g.terrainEnabled?"true":"false"),R(L.attributes,"fogEnabled",g.fogEnabled?"true":"false"),R(L.attributes,"projection",g.projection),R(L.attributes,"zoom",g.zoom),R(L.metadata,"devicePixelRatio",T),R(L.metadata,"connectionEffectiveType",A),R(L.metadata,"navigatorUserAgent",navigator.userAgent),R(L.metadata,"screenWidth",window.screen.width),R(L.metadata,"screenHeight",window.screen.height),R(L.metadata,"windowWidth",window.innerWidth),R(L.metadata,"windowHeight",window.innerHeight),R(L.metadata,"mapWidth",g.width/T),R(L.metadata,"mapHeight",g.height/T),R(L.metadata,"webglRenderer",g.renderer),R(L.metadata,"webglVendor",g.vendor),R(L.metadata,"sdkVersion",M),R(L.metadata,"sdkIdentifier","mapbox-gl-js"),L}(o);for(let g of h.metadata);for(let g of h.counters);for(let g of h.attributes);this.postEvent(t,h,()=>{},d)}},qr=kr.postPerformanceEvent.bind(kr),Yi=new class extends Zo{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(d,t,o,h){if(!r.e.API_URL||!r.e.SESSION_PATH)return;let g=mr(r.e.API_URL+r.e.SESSION_PATH);g.params.push(`sku=${t||""}`),g.params.push(`access_token=${h||r.e.ACCESS_TOKEN||""}`);let _={url:uo(g),headers:{"Content-Type":"text/plain"}};this.pendingRequest=r.g(_,v=>{this.pendingRequest=null,o(v),this.saveEventData(),this.processRequests(h)})}getSessionAPI(d,t,o,h){this.skuToken=t,this.errorCb=h,r.e.SESSION_PATH&&r.e.API_URL&&(o||r.e.ACCESS_TOKEN?this.queueRequest({id:d,timestamp:Date.now()},o):this.errorCb(new Error(Ei)))}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||this.getSession(o,this.skuToken,h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},d)}remove(){this.errorCb=null}},Nr=Yi.getSessionAPI.bind(Yi),ua=new Set;function da(d,t){t?ua.add(d):ua.delete(d)}class lu{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,o){this._updatedSourceCaches[t]=o,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){let o=t.scope;this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._updatedLayers[o].add(t.id),this.setDirty()}removeLayer(t){let o=t.scope;this._removedLayers[o]=this._removedLayers[o]||{},this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._removedLayers[o][t.id]=t,this._updatedLayers[o].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){let t={};for(let o in this._updatedLayers)t[o]=t[o]||{},t[o].updatedIds=Array.from(this._updatedLayers[o].values());for(let o in this._removedLayers)t[o]=t[o]||{},t[o].removedIds=Object.keys(this._removedLayers[o]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,o){this._updatedImages[o]=this._updatedImages[o]||new Set,this._updatedImages[o].add(r.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function qo(d){let{userImage:t}=d;return!!(t&&t.render&&t.render())&&(d.data.replace(new Uint8Array(t.data.buffer)),!0)}class zr extends r.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&r.t()&&(this.imageRasterizerDispatcher=new r.D(r.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new r.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);let o=this.atlasTexture.get(t);o&&(o.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,o){this.imageProviders.has(o)||this.imageProviders.set(o,new Map),this.imageProviders.get(o).set(t.id,t)}removeImageProvider(t,o){this.imageProviders.has(o)&&this.imageProviders.get(o).delete(t)}getPendingImageProviders(){let t=[];for(let o of this.imageProviders.values())for(let h of o.values())h.hasPendingRequests()&&t.push(h);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new r.y),this._imageRasterizer}isLoaded(){for(let t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,o){if(this.loaded.get(o)!==t&&(this.loaded.set(o,t),t)){for(let{ids:h,callback:g}of this.requestors)this._notify(h,o,g);this.requestors=[]}}hasImage(t,o){return!!this.getImage(t,o)}getImage(t,o){return this.images.get(o).get(t.toString())}addImage(t,o,h){this._validate(t,h)&&this.images.get(o).set(t.toString(),h)}_validate(t,o){let h=!0;return this._validateStretch(o.stretchX,o.data&&o.data.width)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),h=!1),this._validateStretch(o.stretchY,o.data&&o.data.height)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),h=!1),this._validateContent(o.content,o)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "content" value`))),h=!1),h}_validateStretch(t,o){if(!t)return!0;let h=0;for(let g of t){if(g[0]<h||g[1]<g[0]||o<g[1])return!1;h=g[1]}return!0}_validateContent(t,o){return t?t.length!==4||!o.usvg&&(t[0]<0||o.data.width<t[0]||t[1]<0||o.data.height<t[1]||t[2]<0||o.data.width<t[2]||t[3]<0||o.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,o,h){let g=this.images.get(o).get(t.toString());h.version=g.version+1,this.images.get(o).set(t.toString(),h),this.updatedImages.get(o).add(t),this.removeFromImageRasterizerCache(t,o)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,o){this.spriteFormat!=="raster"&&(r.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:o}):this.imageRasterizer.removeImagesFromCacheByIds([t],o))}removeImage(t,o){let h=this.images.get(o),g=h.get(t.toString());h.delete(t.toString()),this.patterns.get(o).delete(t.toString()),this.removeFromImageRasterizerCache(t,o),g.userImage&&g.userImage.onRemove&&g.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(o=>r.I.from(o))}getImages(t,o,h){let g=[],_=[],v=this.imageProviders.get(o);for(let A of t){if(!A.iconsetId){g.push(A);continue}let L=v.get(A.iconsetId);L&&(this.getImage(A,o)?_.push(A):L.addPendingRequest(A))}if(g.length===0)return void this._notify(_,o,h);let E=!0,T=!!this.loaded.get(o),C=this.images.get(o);if(!T)for(let A of g)C.has(A.toString())||(E=!1);T||E?this._notify(g,o,h):this.requestors.push({ids:g,scope:o,callback:h})}rasterizeImages(t,o){let h=new Map,{tasks:g,scope:_}=t;for(let[v,E]of g.entries()){let T=this.getImage(E.id,_);T&&h.set(v,{image:T,imageVariant:E})}this._rasterizeImages(_,h,o)}_rasterizeImages(t,o,h){if(r.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:o,scope:t},h);else{let g=new Map;for(let[_,{image:v,imageVariant:E}]of o.entries())g.set(_,this.imageRasterizer.rasterize(E,v,t,0));h(void 0,g)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,o,h){let g=this.images.get(o),_=new Map;for(let v of t){if(!g.get(v.toString())){if(v.iconsetId)continue;this.fire(new r.A("styleimagemissing",{id:v.name}))}let E=g.get(v.toString());if(!E){r.w(`Image "${v.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}let T={data:E.usvg?null:E.data.clone(),pixelRatio:E.pixelRatio,sdf:E.sdf,usvg:E.usvg,version:E.version,stretchX:E.stretchX,stretchY:E.stretchY,content:E.content,hasRenderCallback:!!(E.userImage&&E.userImage.render)};E.usvg&&Object.assign(T,{width:E.icon.usvg_tree.width,height:E.icon.usvg_tree.height}),_.set(r.I.toString(v),T)}h(null,_)}getPixelSize(t){let{width:o,height:h}=this.atlasImage.get(t);return{width:o,height:h}}getPattern(t,o,h){let g=t.toString(),_=this.patterns.get(o),v=_.get(g),E=this.getImage(t,o);if(!E)return null;if(v){if(v.position.version===E.version)return v.position;v.position.version=E.version}else{if(E.usvg&&!E.data){let T=this.getPatternInFlightId(g,o);if(this.patternsInFlight.has(T))return null;this.patternsInFlight.add(T);let C=new r.B(t).scaleSelf(r.q.devicePixelRatio),A=new Map([[C.toString(),{image:E,imageVariant:C}]]);return this._rasterizeImages(o,A,(L,R)=>this.storePatternImage(C,o,E,h,R)),null}this.storePattern(t,o,E)}return this._updatePatternAtlas(o,h),_.get(g).position}getPatternInFlightId(t,o){return r.C(t,o)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,o,h,g,_){let v=t.toString(),E=_?_.get(v):void 0;E&&(h.data=E,this.storePattern(t.id,o,h),this._updatePatternAtlas(o,g),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),o)))}storePattern(t,o,h){let g={w:h.data.width+2*r.F,h:h.data.height+2*r.F,x:0,y:0},_=new r.G(g,h,r.F);this.patterns.get(o).set(t.toString(),{bin:g,position:_})}destroyAtlasTextures(){for(let t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,o){let h=t.gl,g=this.atlasTexture.get(o);g?this.dirty&&(g.update(this.atlasImage.get(o)),this.dirty=!1):(g=new r.T(t,this.atlasImage.get(o),h.RGBA8),this.atlasTexture.set(o,g)),g.bind(h.LINEAR,h.CLAMP_TO_EDGE)}_updatePatternAtlas(t,o){let h=this.patterns.get(t),g=Array.from(h.values()).map(({bin:C})=>C),{w:_,h:v}=r.H(g),E=this.atlasImage.get(t);E.resize({width:_||1,height:v||1});let T=this.images.get(t);for(let[C,{bin:A,position:L}]of h.entries()){let R=L.padding,F=A.x+R,V=A.y+R,z=T.get(C).data,H=z.width,j=z.height;R=R>1?R-1:R,r.r.copy(z,E,{x:0,y:0},{x:F,y:V},{width:H,height:j},o),r.r.copy(z,E,{x:0,y:j-R},{x:F,y:V-R},{width:H,height:R},o),r.r.copy(z,E,{x:0,y:0},{x:F,y:V+j},{width:H,height:R},o),r.r.copy(z,E,{x:H-R,y:0},{x:F-R,y:V},{width:R,height:j},o),r.r.copy(z,E,{x:0,y:0},{x:F+H,y:V},{width:R,height:j},o),r.r.copy(z,E,{x:H-R,y:j-R},{x:F-R,y:V-R},{width:R,height:R},o),r.r.copy(z,E,{x:0,y:j-R},{x:F+H,y:V-R},{width:R,height:R},o),r.r.copy(z,E,{x:0,y:0},{x:F+H,y:V+j},{width:R,height:R},o),r.r.copy(z,E,{x:H-R,y:0},{x:F-R,y:V+j},{width:R,height:R},o)}this.dirty=!0}beginFrame(){for(let t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,o){let h=this.images.get(o);for(let g of t){if(this.callbackDispatchedThisFrame.get(o).has(g.toString()))continue;this.callbackDispatchedThisFrame.get(o).add(g.toString());let _=h.get(g.toString());qo(_)&&this.updateImage(g,o,_)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Ki(d){let t=d.key,o=d.value,h=d.valueSpec||{},g=d.objectElementValidators||{},_=d.style,v=d.styleSpec,E=[],T=r.J(o);if(T!=="object")return[new r.V(t,o,`object expected, ${T} found`)];for(let C in o){let A=C.split(".")[0],L;g[A]?L=g[A]:h[A]?L=ur:g["*"]?L=g["*"]:h["*"]&&(L=ur),L?E=E.concat(L({key:(t&&`${t}.`)+C,value:o[C],valueSpec:h[A]||h["*"],style:_,styleSpec:v,object:o,objectKey:C},o)):E.push(new r.K(t,o[C],`unknown property "${C}"`))}for(let C in h)g[C]||h[C].required&&h[C].default===void 0&&o[C]===void 0&&E.push(new r.V(t,o,`missing required property "${C}"`));return E}function ha(d){let t=d.value,o=d.valueSpec,h=d.style,g=d.styleSpec,_=d.key,v=d.arrayElementValidator||ur;if(r.J(t)!=="array")return[new r.V(_,t,`array expected, ${r.J(t)} found`)];if(o.length&&t.length!==o.length)return[new r.V(_,t,`array length ${o.length} expected, length ${t.length} found`)];if(o["min-length"]&&t.length<o["min-length"])return[new r.V(_,t,`array length at least ${o["min-length"]} expected, length ${t.length} found`)];let E={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};g.$version<7&&(E.function=o.function),r.J(o.value)==="object"&&(E=o.value);let T=[];for(let C=0;C<t.length;C++)T=T.concat(v({array:t,arrayIndex:C,value:t[C],valueSpec:E,style:h,styleSpec:g,key:`${_}[${C}]`},!0));return T}function cu(d){let t=d.key,o=d.value,h=d.valueSpec,g=r.J(o);if(g==="number"&&o!=o&&(g="NaN"),g!=="number")return[new r.V(t,o,`number expected, ${g} found`)];if("minimum"in h){let _=h.minimum;if(r.J(h.minimum)==="array"&&(_=h.minimum[d.arrayIndex]),o<_)return[new r.V(t,o,`${o} is less than the minimum value ${_}`)]}if("maximum"in h){let _=h.maximum;if(r.J(h.maximum)==="array"&&(_=h.maximum[d.arrayIndex]),o>_)return[new r.V(t,o,`${o} is greater than the maximum value ${_}`)]}return[]}function Ls(d){let t=d.valueSpec,o=r.M(d.value.type),h,g,_,v={},E=o!=="categorical"&&d.value.property===void 0,T=!E,C=r.J(d.value.stops)==="array"&&r.J(d.value.stops[0])==="array"&&r.J(d.value.stops[0][0])==="object",A=Ki({key:d.key,value:d.value,valueSpec:d.styleSpec.function,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{stops:function(F){if(o==="identity")return[new r.V(F.key,F.value,'identity function may not have a "stops" property')];let V=[],z=F.value;return V=V.concat(ha({key:F.key,value:z,valueSpec:F.valueSpec,style:F.style,styleSpec:F.styleSpec,arrayElementValidator:L})),r.J(z)==="array"&&z.length===0&&V.push(new r.V(F.key,z,"array must have at least one stop")),V},default:function(F){return ur({key:F.key,value:F.value,valueSpec:t,style:F.style,styleSpec:F.styleSpec})}}});return o==="identity"&&E&&A.push(new r.V(d.key,d.value,'missing required property "property"')),o==="identity"||d.value.stops||A.push(new r.V(d.key,d.value,'missing required property "stops"')),o==="exponential"&&d.valueSpec.expression&&!r.N(d.valueSpec)&&A.push(new r.V(d.key,d.value,"exponential functions not supported")),d.styleSpec.$version>=8&&(T&&!r.O(d.valueSpec)?A.push(new r.V(d.key,d.value,"property functions not supported")):E&&!r.Q(d.valueSpec)&&A.push(new r.V(d.key,d.value,"zoom functions not supported"))),o!=="categorical"&&!C||d.value.property!==void 0||A.push(new r.V(d.key,d.value,'"property" property is required')),A;function L(F){let V=[],z=F.value,H=F.key;if(r.J(z)!=="array")return[new r.V(H,z,`array expected, ${r.J(z)} found`)];if(z.length!==2)return[new r.V(H,z,`array length 2 expected, length ${z.length} found`)];if(C){if(r.J(z[0])!=="object")return[new r.V(H,z,`object expected, ${r.J(z[0])} found`)];if(z[0].zoom===void 0)return[new r.V(H,z,"object stop key must have zoom")];if(z[0].value===void 0)return[new r.V(H,z,"object stop key must have value")];let j=r.M(z[0].zoom);if(typeof j!="number")return[new r.V(H,z[0].zoom,"stop zoom values must be numbers")];if(_&&_>j)return[new r.V(H,z[0].zoom,"stop zoom values must appear in ascending order")];j!==_&&(_=j,g=void 0,v={}),V=V.concat(Ki({key:`${H}[0]`,value:z[0],valueSpec:{zoom:{}},style:F.style,styleSpec:F.styleSpec,objectElementValidators:{zoom:cu,value:R}}))}else V=V.concat(R({key:`${H}[0]`,value:z[0],style:F.style,styleSpec:F.styleSpec},z));return r.S(r.U(z[1]))?V.concat([new r.V(`${H}[1]`,z[1],"expressions are not allowed in function stops.")]):V.concat(ur({key:`${H}[1]`,value:z[1],valueSpec:t,style:F.style,styleSpec:F.styleSpec}))}function R(F,V){let z=r.J(F.value),H=r.M(F.value),j=F.value!==null?F.value:V;if(h){if(z!==h)return[new r.V(F.key,j,`${z} stop domain type must match previous stop domain type ${h}`)]}else h=z;if(z!=="number"&&z!=="string"&&z!=="boolean"&&typeof H!="number"&&typeof H!="string"&&typeof H!="boolean")return[new r.V(F.key,j,"stop domain value must be a number, string, or boolean")];if(z!=="number"&&o!=="categorical"){let Z=`number expected, ${z} found`;return r.O(t)&&o===void 0&&(Z+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new r.V(F.key,j,Z)]}return o!=="categorical"||z!=="number"||typeof H=="number"&&isFinite(H)&&Math.floor(H)===H?o!=="categorical"&&z==="number"&&typeof H=="number"&&typeof g=="number"&&g!==void 0&&H<g?[new r.V(F.key,j,"stop domain values must appear in ascending order")]:(g=H,o==="categorical"&&H in v?[new r.V(F.key,j,"stop domain values must be unique")]:(v[H]=!0,[])):[new r.V(F.key,j,`integer expected, found ${String(H)}`)]}}function Eo(d){let t=(d.expressionContext==="property"?r.W:r.X)(r.U(d.value),d.valueSpec);if(t.result==="error")return t.value.map(h=>new r.V(`${d.key}${h.key}`,d.value,h.message));let o=t.value.expression||t.value._styleExpression.expression;if(d.expressionContext==="property"&&d.propertyKey==="text-font"&&!o.outputDefined())return[new r.V(d.key,d.value,`Invalid data expression for "${d.propertyKey}". Output values must be contained as literals within the expression.`)];if(d.expressionContext==="property"&&d.propertyType==="layout"&&!r.Y(o))return[new r.V(d.key,d.value,'"feature-state" data expressions are not supported with layout properties.')];if(d.expressionContext==="filter")return ho(o,d);if(d.expressionContext&&d.expressionContext.indexOf("cluster")===0){if(!r.Z(o,["zoom","feature-state"]))return[new r.V(d.key,d.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(d.expressionContext==="cluster-initial"&&!r._(o))return[new r.V(d.key,d.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ho(d,t){let o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(let g of t.valueSpec.expression.parameters)o.delete(g);if(o.size===0)return[];let h=[];return d instanceof r.$&&o.has(d.name)?[new r.V(t.key,t.value,`["${d.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(d.eachChild(g=>{h.push(...ho(g,t))}),h)}function Fs(d){let t=d.key,o=d.value,h=d.valueSpec,g=[];return Array.isArray(h.values)?h.values.indexOf(r.M(o))===-1&&g.push(new r.V(t,o,`expected one of [${h.values.join(", ")}], ${JSON.stringify(o)} found`)):Object.keys(h.values).indexOf(r.M(o))===-1&&g.push(new r.V(t,o,`expected one of [${Object.keys(h.values).join(", ")}], ${JSON.stringify(o)} found`)),g}function ks(d){return r.a1(r.U(d.value))?Eo(r.L({},d,{expressionContext:"filter",valueSpec:d.styleSpec[`filter_${d.layerType||"fill"}`]})):Qa(d)}function Qa(d){let t=d.value,o=d.key;if(r.J(t)!=="array")return[new r.V(o,t,`array expected, ${r.J(t)} found`)];let h=d.styleSpec,g,_=[];if(t.length<1)return[new r.V(o,t,"filter array must have at least 1 element")];switch(_=_.concat(Fs({key:`${o}[0]`,value:t[0],valueSpec:h.filter_operator,style:d.style,styleSpec:d.styleSpec})),r.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&r.M(t[1])==="$type"&&_.push(new r.V(o,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&_.push(new r.V(o,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(g=r.J(t[1]),g!=="string"&&_.push(new r.V(`${o}[1]`,t[1],`string expected, ${g} found`)));for(let v=2;v<t.length;v++)g=r.J(t[v]),r.M(t[1])==="$type"?_=_.concat(Fs({key:`${o}[${v}]`,value:t[v],valueSpec:h.geometry_type,style:d.style,styleSpec:d.styleSpec})):g!=="string"&&g!=="number"&&g!=="boolean"&&_.push(new r.V(`${o}[${v}]`,t[v],`string, number, or boolean expected, ${g} found`));break;case"any":case"all":case"none":for(let v=1;v<t.length;v++)_=_.concat(Qa({key:`${o}[${v}]`,value:t[v],style:d.style,styleSpec:d.styleSpec}));break;case"has":case"!has":g=r.J(t[1]),t.length!==2?_.push(new r.V(o,t,`filter array for "${t[0]}" operator must have 2 elements`)):g!=="string"&&_.push(new r.V(`${o}[1]`,t[1],`string expected, ${g} found`))}return _}function Hl(d,t){let o=d.key,h=d.style,g=d.layer,_=d.styleSpec,v=d.value,E=d.objectKey,T=_[`${t}_${d.layerType}`];if(!T)return[];let C=E.match(/^(.*)-use-theme$/);if(t==="paint"&&C&&T[C[1]])return r.S(v)?[].concat(ur({key:d.key,value:v,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:h,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:E})):ur({key:o,value:v,valueSpec:{type:"string"},style:h,styleSpec:_});let A=E.match(/^(.*)-transition$/);if(t==="paint"&&A&&T[A[1]]&&T[A[1]].transition)return ur({key:o,value:v,valueSpec:_.transition,style:h,styleSpec:_});let L=d.valueSpec||T[E];if(!L)return[new r.K(o,v,`unknown property "${E}"`)];let R;if(r.J(v)==="string"&&r.O(L)&&!L.tokens&&(R=/^{([^}]+)}$/.exec(v))){let V=`\`{ "type": "identity", "property": ${R?JSON.stringify(R[1]):'"_"'} }\``;return[new r.V(o,v,`"${E}" does not support interpolation syntax
Use an identity property function instead: ${V}.`)]}let F=[];if(d.layerType==="symbol")E!=="text-field"||!h||h.glyphs||h.imports||F.push(new r.V(o,v,'use of "text-field" requires a style "glyphs" property')),E==="text-font"&&r.a2(r.U(v))&&r.M(v.type)==="identity"&&F.push(new r.V(o,v,'"text-font" does not support identity functions'));else if(d.layerType==="model"&&t==="paint"&&g&&g.layout&&g.layout.hasOwnProperty("model-id")&&r.O(L)&&(r.a3(L)||r.Q(L))){let V=r.W(r.U(v),L),z=V.value.expression||V.value._styleExpression.expression;z&&!r.Z(z,["measure-light"])&&(E==="model-emissive-strength"&&r._(z)&&r.Y(z)||F.push(new r.V(o,v,`${E} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return F.concat(ur({key:d.key,value:v,valueSpec:L,style:h,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:E}))}function Ji(d){return Hl(d,"paint")}function To(d){return Hl(d,"layout")}function uu(d){let t=[],o=d.value,h=d.key,g=d.style,_=d.styleSpec;o.type||o.ref||t.push(new r.V(h,o,'either "type" or "ref" is required'));let v=r.M(o.type),E=r.M(o.ref);if(o.id){let T=r.M(o.id);for(let C=0;C<d.arrayIndex;C++){let A=g.layers[C];r.M(A.id)===T&&t.push(new r.V(h,o.id,`duplicate layer id "${o.id}", previously used at line ${A.id.__line__}`))}}if("ref"in o){let T;["type","source","source-layer","filter","layout"].forEach(C=>{C in o&&t.push(new r.V(h,o[C],`"${C}" is prohibited for ref layers`))}),g.layers.forEach(C=>{r.M(C.id)===E&&(T=C)}),T?T.ref?t.push(new r.V(h,o.ref,"ref cannot reference another ref layer")):v=r.M(T.type):typeof E=="string"&&t.push(new r.V(h,o.ref,`ref layer "${E}" not found`))}else if(v!=="background"&&v!=="sky"&&v!=="slot")if(o.source){let T=g.sources&&g.sources[o.source],C=T&&r.M(T.type);T?C==="vector"&&v==="raster"?t.push(new r.V(h,o.source,`layer "${o.id}" requires a raster source`)):C==="raster"&&v!=="raster"?t.push(new r.V(h,o.source,`layer "${o.id}" requires a vector source`)):C!=="vector"||o["source-layer"]?C==="raster-dem"&&v!=="hillshade"?t.push(new r.V(h,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):C!=="raster-array"||["raster","raster-particle"].includes(v)?v==="line"&&o.paint&&(o.paint["line-gradient"]||o.paint["line-trim-offset"])&&C==="geojson"&&!T.lineMetrics?t.push(new r.V(h,o,`layer "${o.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):v==="raster-particle"&&C!=="raster-array"&&t.push(new r.V(h,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):t.push(new r.V(h,o.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new r.V(h,o,`layer "${o.id}" must specify a "source-layer"`)):t.push(new r.V(h,o.source,`source "${o.source}" not found`))}else t.push(new r.V(h,o,'missing required property "source"'));return t=t.concat(Ki({key:h,value:o,valueSpec:_.layer,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ur({key:`${h}.type`,value:o.type,valueSpec:_.layer.type,style:d.style,styleSpec:d.styleSpec,object:o,objectKey:"type"}),filter:T=>ks(r.L({layerType:v},T)),layout:T=>Ki({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":C=>To(r.L({layerType:v},C))}}),paint:T=>Ki({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":C=>Ji(r.L({layerType:v,layer:o},C))}})}})),t}function Ns(d){let t=d.value,o=d.key,h=r.J(t);return h!=="string"?[new r.V(o,t,`string expected, ${h} found`)]:[]}let Gl={promoteId:function d({key:t,value:o}){if(r.J(o)==="string")return Ns({key:t,value:o});if(Array.isArray(o)){let h=[],g=r.U(o),_=r.X(g);return _.result==="error"&&_.value.forEach(v=>{h.push(new r.V(`${t}${v.key}`,null,`${v.message}`))}),r.Z(_.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||h.push(new r.V(`${t}`,null,"promoteId expression should be only feature dependent")),h}{let h=[];for(let g in o)h.push(...d({key:`${t}.${g}`,value:o[g]}));return h}}};function Mi(d){let t=d.value,o=d.key,h=d.styleSpec,g=d.style;if(!t.type)return[new r.V(o,t,'"type" is required')];let _=r.M(t.type),v=[];switch(["vector","raster","raster-dem","raster-array"].includes(_)&&(t.url||t.tiles||v.push(new r.K(o,t,'Either "url" or "tiles" is required.'))),_){case"vector":case"raster":case"raster-dem":case"raster-array":return v=v.concat(Ki({key:o,value:t,valueSpec:h[`source_${_.replace("-","_")}`],style:d.style,styleSpec:h,objectElementValidators:Gl})),v;case"geojson":if(v=Ki({key:o,value:t,valueSpec:h.source_geojson,style:g,styleSpec:h,objectElementValidators:Gl}),t.cluster)for(let E in t.clusterProperties){let[T,C]=t.clusterProperties[E],A=typeof T=="string"?[T,["accumulated"],["get",E]]:T;v.push(...Eo({key:`${o}.${E}.map`,value:C,expressionContext:"cluster-map"})),v.push(...Eo({key:`${o}.${E}.reduce`,value:A,expressionContext:"cluster-reduce"}))}return v;case"video":return Ki({key:o,value:t,valueSpec:h.source_video,style:g,styleSpec:h});case"image":return Ki({key:o,value:t,valueSpec:h.source_image,style:g,styleSpec:h});case"canvas":return[new r.V(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Fs({key:`${o}.type`,value:t.type,valueSpec:{values:Io(h)}})}}function Io(d){return d.source.reduce((t,o)=>{let h=d[o];return h.type.type==="enum"&&(t=t.concat(Object.keys(h.type.values))),t},[])}function fa(d){let t=d.value,o=d.styleSpec,h=o.light,g=d.style,_=[],v=r.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new r.V("light",t,`object expected, ${v} found`)]),_;for(let E in t){let T=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);_=_.concat(C&&h[C[1]]?ur({key:E,value:t[E],valueSpec:{type:"string"},style:g,styleSpec:o}):T&&h[T[1]]&&h[T[1]].transition?ur({key:E,value:t[E],valueSpec:o.transition,style:g,styleSpec:o}):h[E]?ur({key:E,value:t[E],valueSpec:h[E],style:g,styleSpec:o}):[new r.V(E,t[E],`unknown property "${E}"`)])}return _}function zs(d){let t=d.value,o=[];if(!t)return o;let h=r.J(t);if(h!=="object")return o=o.concat([new r.V("light-3d",t,`object expected, ${h} found`)]),o;let g=d.styleSpec,_=g["light-3d"],v=d.key,E=d.style,T=d.style.lights;for(let L of["type","id"])if(!(L in t))return o=o.concat([new r.V("light-3d",t,`missing property ${L} on light`)]),o;if(t.type&&T)for(let L=0;L<d.arrayIndex;L++){let R=r.M(t.type),F=T[L];r.M(F.type)===R&&o.push(new r.V(v,t.id,`duplicate light type "${t.type}", previously defined at line ${F.id.__line__}`))}let C=`properties_light_${t.type}`;if(!(C in g))return o=o.concat([new r.V("light-3d",t,`Invalid light type ${t.type}`)]),o;let A=g[C];for(let L in t)if(L==="properties"){let R=t[L],F=r.J(R);if(F!=="object")return o=o.concat([new r.V("properties",R,`object expected, ${F} found`)]),o;for(let V in R){let z=V.match(/^(.*)-transition$/),H=V.match(/^(.*)-use-theme$/);o=o.concat(H&&A[H[1]]?ur({key:L,value:R[V],valueSpec:{type:"string"},style:E,styleSpec:g}):z&&A[z[1]]&&A[z[1]].transition?ur({key:L,value:t[L],valueSpec:g.transition,style:E,styleSpec:g}):A[V]?ur({key:V,value:R[V],valueSpec:A[V],style:E,styleSpec:g}):[new r.K(d.key,R[V],`unknown property "${V}"`)])}}else o=o.concat(_[L]?ur({key:L,value:t[L],valueSpec:_[L],style:E,styleSpec:g}):[new r.K(L,t[L],`unknown property "${L}"`)]);return o}function pa(d){let t=d.value,o=d.key,h=d.style,g=d.styleSpec,_=g.terrain,v=[],E=r.J(t);if(t===void 0||E==="null")return v;if(E!=="object")return v=v.concat([new r.V("terrain",t,`object expected, ${E} found`)]),v;for(let T in t){let C=T.match(/^(.*)-transition$/),A=T.match(/^(.*)-use-theme$/);v=v.concat(A&&_[A[1]]?ur({key:T,value:t[T],valueSpec:{type:"string"},style:h,styleSpec:g}):C&&_[C[1]]&&_[C[1]].transition?ur({key:T,value:t[T],valueSpec:g.transition,style:h,styleSpec:g}):_[T]?ur({key:T,value:t[T],valueSpec:_[T],style:h,styleSpec:g}):[new r.K(T,t[T],`unknown property "${T}"`)])}if(t.source){let T=h.sources&&h.sources[t.source],C=T&&r.M(T.type);T?C!=="raster-dem"&&v.push(new r.V(o,t.source,`terrain cannot be used with a source of type ${String(C)}, it only be used with a "raster-dem" source type`)):v.push(new r.V(o,t.source,`source "${t.source}" not found`))}else v.push(new r.V(o,t,'terrain is missing required property "source"'));return v}function ma(d){let t=d.value,o=d.style,h=d.styleSpec,g=h.fog,_=[],v=r.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new r.V("fog",t,`object expected, ${v} found`)]),_;for(let E in t){let T=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);_=_.concat(C&&g[C[1]]?ur({key:E,value:t[E],valueSpec:{type:"string"},style:o,styleSpec:h}):T&&g[T[1]]&&g[T[1]].transition?ur({key:E,value:t[E],valueSpec:h.transition,style:o,styleSpec:h}):g[E]?ur({key:E,value:t[E],valueSpec:g[E],style:o,styleSpec:h}):[new r.K(E,t[E],`unknown property "${E}"`)])}return _}let $l={"*":()=>[],array:ha,boolean:function(d){let t=d.value,o=d.key,h=r.J(t);return h!=="boolean"?[new r.V(o,t,`boolean expected, ${h} found`)]:[]},number:cu,color:function(d){let t=d.key,o=d.value,h=r.J(o);return h!=="string"?[new r.V(t,o,`color expected, ${h} found`)]:r.a0.parseCSSColor(o)===null?[new r.V(t,o,`color expected, "${o}" found`)]:[]},enum:Fs,filter:ks,function:Ls,layer:uu,object:Ki,source:Mi,model:r.a4,light:fa,"light-3d":zs,terrain:pa,fog:ma,string:Ns,formatted:function(d){return Ns(d).length===0?[]:Eo(d)},resolvedImage:function(d){return Ns(d).length===0?[]:Eo(d)},projection:function(d){let t=d.value,o=d.styleSpec,h=o.projection,g=d.style,_=[],v=r.J(t);if(v==="object")for(let E in t)_=_.concat(ur({key:E,value:t[E],valueSpec:h[E],style:g,styleSpec:o}));else v!=="string"&&(_=_.concat([new r.V("projection",t,`object or string expected, ${v} found`)]));return _},import:function(d){let{value:t,styleSpec:o}=d,v=t,{data:h}=v,g=$v(v,["data"]);Object.defineProperty(g,"__line__",{value:t.__line__,enumerable:!1});let _=Ki(r.L({},d,{value:g,valueSpec:o.import}));return r.M(g.id)===""&&_.push(new r.V(`${d.key}.id`,g,"import id can't be an empty string")),h&&(_=_.concat(hu(h,o,{key:`${d.key}.data`}))),_},iconset:function(d){let t=d.value,o=d.key,h=d.styleSpec,g=d.style;if(!t.type)return[new r.V(o,t,'"type" is required')];let _=r.M(t.type),v=[];if(v=v.concat(Ki({key:o,value:t,valueSpec:h[`iconset_${_}`],style:g,styleSpec:h})),_==="source"&&t.source){let E=g.sources&&g.sources[t.source],T=E&&r.M(E.type);E?T!=="raster-array"&&v.push(new r.V(o,t.source,`iconset cannot be used with a source of type ${String(T)}, it only be used with a "raster-array" source type`)):v.push(new r.V(o,t.source,`source "${t.source}" not found`))}return v}};function ur(d,t=!1){let o=d.value,h=d.valueSpec,g=d.styleSpec;if(h.expression&&r.a2(r.M(o)))return Ls(d);if(h.expression&&r.S(r.U(o)))return Eo(d);if(h.type&&$l[h.type]){let _=$l[h.type](d);return t===!0&&_.length>0&&r.J(d.value)==="array"?Eo(d):_}return Ki(r.L({},d,{valueSpec:h.type?g[h.type]:h}))}function du(d){let t=d.value,o=d.key,h=Ns(d);return h.length||(t.indexOf("{fontstack}")===-1&&h.push(new r.V(o,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&h.push(new r.V(o,t,'"glyphs" url must include a "{range}" token'))),h}function hu(d,t=r.a5,o={}){return ur({key:o.key||"",value:d,valueSpec:t.$root,styleSpec:t,style:d,objectElementValidators:{glyphs:du,"*":()=>[]}})}function So(d,t=r.a5){return fe(hu(d,t))}let fu=d=>fe(Mi(d)),xp=d=>fe(fa(d)),Wl=d=>fe(zs(d)),Xe=d=>fe(pa(d)),Bs=d=>fe(ma(d)),bp=d=>fe(function(t){let o=t.value,h=t.style,g=t.styleSpec,_=g.snow,v=[],E=r.J(o);if(o===void 0)return v;if(E!=="object")return v=v.concat([new r.V("snow",o,`object expected, ${E} found`)]),v;for(let T in o){let C=T.match(/^(.*)-transition$/);v=v.concat(C&&_[C[1]]&&_[C[1]].transition?ur({key:T,value:o[T],valueSpec:g.transition,style:h,styleSpec:g}):_[T]?ur({key:T,value:o[T],valueSpec:_[T],style:h,styleSpec:g}):[new r.K(T,o[T],`unknown property "${T}"`)])}return v}(d)),pu=d=>fe(function(t){let o=t.value,h=t.style,g=t.styleSpec,_=g.rain,v=[],E=r.J(o);if(o===void 0)return v;if(E!=="object")return v=v.concat([new r.V("rain",o,`object expected, ${E} found`)]),v;for(let T in o){let C=T.match(/^(.*)-transition$/);v=v.concat(C&&_[C[1]]&&_[C[1]].transition?ur({key:T,value:o[T],valueSpec:g.transition,style:h,styleSpec:g}):_[T]?ur({key:T,value:o[T],valueSpec:_[T],style:h,styleSpec:g}):[new r.K(T,o[T],`unknown property "${T}"`)])}return v}(d)),Sn=d=>fe(uu(d)),De=d=>fe(ks(d)),$=d=>fe(Ji(d)),W=d=>fe(To(d)),te=d=>fe(r.a4(d));function fe(d){return d.slice().sort((t,o)=>t.line&&o.line?t.line-o.line:0)}function ne(d,t){let o=!1;if(t&&t.length)for(let h of t)h instanceof r.K?r.w(h.message):(d.fire(new r.z(new Error(h.message))),o=!0);return o}let _e;class Me extends r.E{constructor(t,o="flat"){super(),this._transitionable=new r.a6(_e||(_e=new r.a7({anchor:new r.a8(r.a5.light.anchor),position:new r.a9(r.a5.light.position),color:new r.a8(r.a5.light.color),intensity:new r.a8(r.a5.light.intensity)}))),this.setLight(t,o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,o,h={}){this._validate(xp,t,h)||(this._transitionable.setTransitionOrValue(t),this.id=o)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&ne(this,t.call(So,r.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}}let ve=class extends r.E{constructor(d,t,o,h,g){super(),this.scope=o,this._transitionable=new r.a6(new r.a7({source:new r.a8(r.a5.terrain.source),exaggeration:new r.a8(r.a5.terrain.exaggeration)}),o,h),this._transitionable.setTransitionOrValue(d,h),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=g}get(){return this._transitionable.serialize()}set(d,t){this._transitionable.setTransitionOrValue(d,t)}updateTransitions(d){this._transitioning=this._transitionable.transitioned(d,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(d){this.properties=this._transitioning.possiblyEvaluate(d)}getExaggeration(d){return this._transitioning.possiblyEvaluate(new r.aa(d,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let d=this._transitionable._values.exaggeration;if(!d)return null;let t=d.value.expression;if(!t)return null;let o=-1,h=-1,g=1;for(let _ of t.zoomStops)g=t.evaluate(new r.aa(_,{worldview:this.worldview})),g>.01?(o=_,h=-1):h=_;return g<.01&&o>0&&h>o?[o,h]:null}isZoomDependent(){let d=this._transitionable._values.exaggeration;return d!=null&&d.value!=null&&d.value.expression!=null&&d.value.expression instanceof r.ab}},Ce=45,nt=65,je=.05;function Dt(d,t,o,h){let g=r.af(Ce,nt,o),[_,v]=kt(d,h),E=1-Math.min(1,Math.exp((t-_)/(v-_)*-6));return E*=E*E,E=Math.min(1,1.00747*E),E*g*d.alpha}function kt(d,t){let o=.5/Math.tan(.5*t);return[d.range[0]+o,d.range[1]+o]}function jt(d,t,o,h,g){let _=r.ad([],[t,o,h],g.mercatorFogMatrix);return Dt(d,r.ae(_),g.pitch,g._fov)}function dn(d,t,o,h,g,_,v){let E=[[o,h,0],[g,h,0],[g,_,0],[o,_,0]],T=Number.MAX_VALUE,C=-Number.MAX_VALUE;for(let A of E){let L=r.ad([],A,t),R=r.ae(L);T=Math.min(T,R),C=Math.max(C,R)}return[Dt(d,T,v.pitch,v._fov),Dt(d,C,v.pitch,v._fov)]}class rn extends r.E{constructor(t,o,h,g){super();let _=new r.a7({range:new r.a8(r.a5.fog.range),color:new r.a8(r.a5.fog.color),"color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new r.a8(r.a5.fog["high-color"]),"high-color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new r.a8(r.a5.fog["space-color"]),"space-color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new r.a8(r.a5.fog["horizon-blend"]),"star-intensity":new r.a8(r.a5.fog["star-intensity"]),"vertical-range":new r.a8(r.a5.fog["vertical-range"])});this._transitionable=new r.a6(_,h,new Map(g)),this.set(t,g),this._transitioning=this._transitionable.untransitioned(),this._transform=o,this.properties=new r.ag(_),this.scope=h}get state(){let t=this._transform,o=t.projection.name==="globe",h=r.ah(t.zoom),g=this.properties.get("range"),_=[.5,3];return{range:o?[r.ai(_[0],g[0],h),r.ai(_[1],g[1],h)]:g,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,o,h={}){if(this._validate(Bs,t,h))return;let g=r.h({},t);for(let _ of Object.keys(r.a5.fog))g[_]===void 0&&(g[_]=r.a5.fog[_].default);this._options=g,this._transitionable.setTransitionOrValue(this._options,o)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;let o=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:r.af(Ce,nt,t))*o.a}getOpacityAtLatLng(t,o){return this._transform.projection.supportsFog?function(h,g,_){let v=r.ac.fromLngLat(g),E=_.elevation?_.elevation.getAtPointOrZero(v):0;return jt(h,v.x,v.y,E,_)}(this.state,t,o):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];let o=this._transform.calculateFogTileMatrix(t.toUnwrapped());return dn(this.state,o,0,0,r.aj,r.aj,this._transform)}getOpacityForBounds(t,o,h,g,_){return this._transform.projection.supportsFog?dn(this.state,t,o,h,g,_,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?kt(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;let o=[4,5,6,7];for(let h of o){let g=t.points[h],_;if(g[2]>=0)_=g;else{let v=t.points[h-4];_=r.ak(v,g,v[2]/(v[2]-g[2]))}if(jt(this.state,_[0],_[1],0,this._transform)>=je)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&ne(this,t.call(So,r.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}}let hn,Kn,fn,Pr,ii=class extends r.E{constructor(d,t,o,h){super();let g=hn||(hn=new r.a7({density:new r.a8(r.a5.snow.density),intensity:new r.a8(r.a5.snow.intensity),color:new r.a8(r.a5.snow.color),opacity:new r.a8(r.a5.snow.opacity),vignette:new r.a8(r.a5.snow.vignette),"vignette-color":new r.a8(r.a5.snow["vignette-color"]),"center-thinning":new r.a8(r.a5.snow["center-thinning"]),direction:new r.a8(r.a5.snow.direction),"flake-size":new r.a8(r.a5.snow["flake-size"])}));this._transitionable=new r.a6(g,o,new Map(h)),this.set(d,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new r.ag(g),this.scope=o}get state(){let d=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=r.al(o[0]),g=-Math.max(r.al(o[1]),.01),_=[Math.cos(h)*Math.cos(g),Math.sin(h)*Math.cos(g),Math.sin(g)],v=this.properties.get("vignette"),E=this.properties.get("vignette-color");return E.a=v,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new r.am(t.r,t.g,t.b,t.a*d),direction:_,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:E}}get(){return this._transitionable.serialize()}set(d,t,o={}){if(this._validate(bp,d,o))return;let h=r.h({},d);for(let g of Object.keys(r.a5.snow))h[g]===void 0&&(h[g]=r.a5.snow[g].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(d){this._transitionable.setTransitionOrValue(this._options,new Map(d))}updateTransitions(d){this._transitioning=this._transitionable.transitioned(d,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(d){this.properties=this._transitioning.possiblyEvaluate(d)}_validate(d,t,o){return(!o||o.validate!==!1)&&ne(this,d.call(So,r.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}},Jr=class extends r.E{constructor(d,t,o,h){super();let g=Kn||(Kn=new r.a7({density:new r.a8(r.a5.rain.density),intensity:new r.a8(r.a5.rain.intensity),color:new r.a8(r.a5.rain.color),opacity:new r.a8(r.a5.rain.opacity),vignette:new r.a8(r.a5.rain.vignette),"vignette-color":new r.a8(r.a5.rain["vignette-color"]),"center-thinning":new r.a8(r.a5.rain["center-thinning"]),direction:new r.a8(r.a5.rain.direction),"droplet-size":new r.a8(r.a5.rain["droplet-size"]),"distortion-strength":new r.a8(r.a5.rain["distortion-strength"])}));this._transitionable=new r.a6(g,o,new Map(h)),this.set(d,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new r.ag(g),this.scope=o}get state(){let d=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=r.al(o[0]),g=-Math.max(r.al(o[1]),.01),_=[Math.cos(h)*Math.cos(g),Math.sin(h)*Math.cos(g),Math.sin(g)],v=this.properties.get("vignette-color");return v.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new r.am(t.r,t.g,t.b,t.a*d),direction:_,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:v}}get(){return this._transitionable.serialize()}set(d,t,o={}){if(this._validate(pu,d,o))return;let h=r.h({},d);for(let g of Object.keys(r.a5.rain))h[g]===void 0&&(h[g]=r.a5.rain[g].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(d){this._transitionable.setTransitionOrValue(this._options,new Map(d))}updateTransitions(d){this._transitioning=this._transitionable.transitioned(d,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(d){this.properties=this._transitioning.possiblyEvaluate(d)}_validate(d,t,o){return(!o||o.validate!==!1)&&ne(this,d.call(So,r.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}};class $n extends r.E{constructor(t,o,h,g){super(),this.scope=h,this._options=t,this.properties=new r.ag(o),this._transitionable=new r.a6(o,h,new Map(g)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,o){this._options=t,this._transitionable.setTransitionOrValue(t.properties,o)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class An{constructor(t,o,h){this.screenBounds=t,this.cameraPoint=h.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=o,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,h)}static createFromScreenPoints(t,o){let h,g;if(t instanceof r.P||typeof t[0]=="number"){let _=r.P.convert(t);h=[_],g=o.isPointAboveHorizon(_)}else{let _=r.P.convert(t[0]),v=r.P.convert(t[1]),E=_.add(v)._div(2);h=[_,v],g=r.ao(_,v).every(T=>o.isPointAboveHorizon(T))&&o.isPointAboveHorizon(E)}return new An(h,g,o)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return r.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],g=r.ao(o,h,0,!1);return this.cameraPoint.y>h.y&&(this.cameraPoint.x>o.x&&this.cameraPoint.x<h.x?g.splice(3,0,this.cameraPoint):this.cameraPoint.x>=h.x?g[2]=this.cameraPoint:this.cameraPoint.x<=o.x&&(g[3]=this.cameraPoint)),r.ap(g,t)}bufferedCameraGeometryGlobe(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],g=r.ao(o,h,t),_=this.cameraPoint.clone();switch(3*((_.y>o.y)+(_.y>h.y))+((_.x>o.x)+(_.x>h.x))){case 0:g[0]=_,g[4]=_.clone();break;case 1:g.splice(1,0,_);break;case 2:g[1]=_;break;case 3:g.splice(4,0,_);break;case 5:g.splice(2,0,_);break;case 6:g[3]=_;break;case 7:g.splice(3,0,_);break;case 8:g[2]=_}return g}containsTile(t,o,h,g=0){let _=t.queryPadding/o._pixelsPerMercatorPixel+1,v=h?this._bufferedCameraMercator(_,o):this._bufferedScreenMercator(_,o),E=t.tileID.wrap+(v.unwrapped?g:0),T=v.polygon.map(H=>r.aq(t.tileTransform,H,E));if(!r.ar(T,0,0,r.aj,r.aj))return;E=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?g:0);let C=this.screenGeometryMercator.polygon.map(H=>r.as(t.tileTransform,H,E)),A=C.map(H=>new r.P(H[0],H[1])),L=o.getFreeCameraOptions().position||new r.ac(0,0,0),R=r.as(t.tileTransform,L,E),F=C.map(H=>{let j=r.at(H,H,R);return r.au(j,j),new r.av(R,j)}),V=r.aw(t,1,o.zoom)*o._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:A,tilespaceRays:F,bufferedTilespaceGeometry:T,bufferedTilespaceBounds:(z=r.ax(T),z.min.x=r.ay(z.min.x,0,r.aj),z.min.y=r.ay(z.min.y,0,r.aj),z.max.x=r.ay(z.max.x,0,r.aj),z.max.y=r.ay(z.max.y,0,r.aj),z),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:V};var z}_bufferedScreenMercator(t,o){let h=gr(t);if(this._screenRaycastCache[h])return this._screenRaycastCache[h];{let g;return g=o.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),o):{polygon:this.bufferedScreenGeometry(t).map(_=>o.pointCoordinate3D(_)),unwrapped:!0},this._screenRaycastCache[h]=g,g}}_bufferedCameraMercator(t,o){let h=gr(t);if(this._cameraRaycastCache[h])return this._cameraRaycastCache[h];{let g;return g=o.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),o):{polygon:this.bufferedCameraGeometry(t).map(_=>o.pointCoordinate3D(_)),unwrapped:!0},this._cameraRaycastCache[h]=g,g}}_projectAndResample(t,o){let h=function(_,v){let E=r.az([],v.pixelMatrix,v.globeMatrix),T=[0,-r.aB,0,1],C=[0,r.aB,0,1],A=[0,0,0,1];r.aA(T,T,E),r.aA(C,C,E),r.aA(A,A,E);let L=new r.P(T[0]/T[3],T[1]/T[3]),R=new r.P(C[0]/C[3],C[1]/C[3]),F=r.aC(_,L)&&T[3]<A[3],V=r.aC(_,R)&&C[3]<A[3];if(!F&&!V)return null;let z=function(de,ie,oe){for(let se=1;se<de.length;se++){let Te=wr(ie.pointCoordinate3D(de[se-1]).x),me=wr(ie.pointCoordinate3D(de[se]).x);if(oe<0){if(Te<me)return{idx:se,t:-Te/(me-1-Te)}}else if(me<Te)return{idx:se,t:(1-Te)/(me+1-Te)}}return null}(_,v,F?-1:1);if(!z)return null;let{idx:H,t:j}=z,Z=H>1?Ar(_.slice(0,H),v):[],Y=H<_.length?Ar(_.slice(H),v):[];Z=Z.map(de=>new r.P(wr(de.x),de.y)),Y=Y.map(de=>new r.P(wr(de.x),de.y));let J=[...Z];J.length===0&&J.push(Y[Y.length-1]);let re=r.ai(J[J.length-1].y,(Y.length===0?Z[0]:Y[0]).y,j),ce;return ce=F?[new r.P(0,re),new r.P(0,0),new r.P(1,0),new r.P(1,re)]:[new r.P(1,re),new r.P(1,1),new r.P(0,1),new r.P(0,re)],J.push(...ce),Y.length===0?J.push(Z[0]):J.push(...Y),{polygon:J.map(de=>new r.ac(de.x,de.y)),unwrapped:!1}}(t,o);if(h)return h;let g=function(_,v){let E=!1,T=-1/0,C=0;for(let L=0;L<_.length-1;L++)_[L].x>T&&(T=_[L].x,C=L);for(let L=0;L<_.length-1;L++){let R=(C+L)%(_.length-1),F=_[R],V=_[R+1];Math.abs(F.x-V.x)>.5&&(F.x<V.x?(F.x+=1,R===0&&(_[_.length-1].x+=1)):(V.x+=1,R+1===_.length-1&&(_[0].x+=1)),E=!0)}let A=r.aD(v.center.lng);return E&&A<Math.abs(A-1)&&_.forEach(L=>{L.x-=1}),{polygon:_,unwrapped:E}}(Ar(t,o).map(_=>new r.P(wr(_.x),_.y)),o);return{polygon:g.polygon.map(_=>new r.ac(_.x,_.y)),unwrapped:g.unwrapped}}}function Ar(d,t){return r.aE(d,o=>{let h=t.pointCoordinate3D(o);o.x=h.x,o.y=h.y},1/256)}function wr(d){return d<0?1+d%1:d%1}function gr(d){return 100*d|0}function hi(d,t,o,h,g){let _=function(E,T){if(E)return g(E);if(T){if(d.url&&T.tiles&&d.tiles&&delete d.tiles,T.variants){if(!Array.isArray(T.variants))return g(new Error("variants must be an array"));for(let A of T.variants){if(A==null||typeof A!="object"||A.constructor!==Object)return g(new Error("variant must be an object"));if(!Array.isArray(A.capabilities))return g(new Error("capabilities must be an array"));if(A.capabilities.length===1&&A.capabilities[0]==="meshopt"){T=r.h(T,A);break}}}let C=r.aF(r.h({},T,d),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);C.tiles=t.canonicalizeTileset(C,d.url),g(null,C)}},v=function(E,T,C){if(!E)return null;if(!T&&!C)return E;C=C||E.worldview_default;let A=Object.values(E.language||{});if(A.length===0)return null;let L=Object.values(E.worldview||{});if(L.length===0)return null;let R=A.every(V=>V===T),F=L.every(V=>V===C);return R&&F?E:T in(E.language_options||{})||C in(E.worldview_options||{})?null:E.language_options&&E.worldview_options?E:null}(d.data,o,h);return v?r.q.frame(()=>_(null,v)):d.url?r.n(t.transformRequest(t.normalizeSourceURL(d.url,null,o,h),r.R.Source),_):r.q.frame(()=>{let C=d,{data:E}=C,T=$v(C,["data"]);_(null,T)})}function Qi(d,t){let o=Math.pow(2,t.z),h=Math.floor(r.aD(d.getWest())*o),g=Math.floor(r.aH(d.getNorth())*o),_=Math.ceil(r.aD(d.getEast())*o),v=Math.ceil(r.aH(d.getSouth())*o);return t.x>=h&&t.x<_&&t.y>=g&&t.y<v}class Ri{constructor(t,o,h){this.bounds=t?r.aG.convert(this.validateBounds(t)):null,this.minzoom=o||0,this.maxzoom=h||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(let o of t)this.extraBounds.push(r.aG.convert(this.validateBounds(o)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!Qi(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(let o of this.extraBounds)if(Qi(o,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;let o=new Ri(t.bounds,t.minzoom,t.maxzoom);return o.addExtraBounds(t.extra_bounds),o}}class mu extends r.E{constructor(t,o,h,g){if(super(),this.id=t,this.dispatcher=h,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,r.h(this,r.aF(o,["url","scheme","tileSize","promoteId"])),this._options=r.h({type:"vector"},o),this._collectResourceTiming=!!o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g),this._tileWorkers={},this._deduped=new r.aI}load(t){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));let o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,h=this.map.getWorldview();this._tileJSONRequest=hi(this._options,this.map._requestManager,o,h,(g,_)=>{if(this._tileJSONRequest=null,this._loaded=!0,g)o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),h&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${h}`),this.fire(new r.z(g));else if(_){if(r.h(this,_),this.hasWorldviews=!!_.worldview_options,_.worldview_default&&(this.worldviewDefault=_.worldview_default),_.vector_layers){this.vectorLayers=_.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(let v of _.vector_layers)this.vectorLayerIds.push(v.id),_.worldview&&_.worldview[v.source]&&this.localizableLayerIds.add(v.id)}this.tileBounds=Ri.fromTileJSON(_),zi(_.tiles,this.map._requestManager._customAccessToken),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(g)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return r.h({},this._options)}loadTile(t,o){let h=t.tileID.canonical.url(this.tiles,this.scheme),g=this.map._requestManager.normalizeTileURL(h),_=this.map._requestManager.transformRequest(g,r.R.Tile),v=this.map.style?this.map.style.getLut(this.scope):null,E=v?{image:v.image.clone()}:null,T={request:_,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:E,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:r.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&r.j(h)&&(T.localizableLayerIds=this.localizableLayerIds),T.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=o:t.request=t.actor.send("reloadTile",T,C.bind(this));else if(t.actor=this._tileWorkers[g]=this._tileWorkers[g]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",T,C.bind(this),void 0,!0);else{let A=r.aJ.call({deduped:this._deduped},T,(L,R)=>{L||!R?C.call(this,L):(T.data={cacheControl:R.cacheControl,expires:R.expires,rawData:R.rawData.slice(0)},t.actor&&t.actor.send("loadTile",T,C.bind(this),void 0,!0))},!0);t.request={cancel:A}}function C(A,L){return delete t.request,t.aborted?o(null):A&&A.status!==404?o(A):(L&&L.resourceTiming&&(t.resourceTiming=L.resourceTiming),this.map._refreshExpiredTiles&&L&&t.setExpiryData(L),t.loadVectorData(L,this.map.painter),r.aK(this.dispatcher),o(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class vi extends r.E{constructor(t,o,h,g){super(),this.id=t,this.dispatcher=h,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=r.h({type:"raster"},o),r.h(this,r.aF(o,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));let o=this.map.getWorldview();this._tileJSONRequest=hi(this._options,this.map._requestManager,null,o,(h,g)=>{this._tileJSONRequest=null,this._loaded=!0,h?this.fire(new r.z(h)):g&&(r.h(this,g),g.raster_layers&&(this.rasterLayers=g.raster_layers,this.rasterLayerIds=this.rasterLayers.map(_=>_.id)),this.tileBounds=Ri.fromTileJSON(g),zi(g.tiles),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(h)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return r.h({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,o){let h=r.q.devicePixelRatio>=2,g=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),h,this.tileSize);t.request=r.o(this.map._requestManager.transformRequest(g,r.R.Tile),(_,v,E,T)=>(delete t.request,t.aborted?(t.state="unloaded",o(null)):_?(t.state="errored",o(_)):v?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:E,expires:T}),t.setTexture(v,this.map.painter),t.state="loaded",r.aK(this.dispatcher),void o(null)):o(null)))}abortTile(t,o){t.request&&(t.request.cancel(),delete t.request),o&&o()}unloadTile(t,o){t.texture&&t.texture instanceof r.T?(t.destroy(!0),t.texture&&t.texture instanceof r.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),o&&o()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ga extends vi{constructor(t,o,h,g){super(t,o,h,g),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=r.h({type:"raster-array"},o)}triggerRepaint(t){let o=this.map.painter._terrain,h=this.map.style.getSourceCache(this.id);o&&o.enabled&&h&&o._clearRenderCacheForTile(h.id,t.tileID),this.map.triggerRepaint()}loadTile(t,o){let h=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),g=this.map._requestManager.transformRequest(h,r.R.Tile),_={request:g,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=g,t.actor||(t.actor=this.dispatcher.getActor());let v=(E,T,C,A)=>{if(delete t.request,t.aborted)return t.state="unloaded",o(null);if(E)return E.name==="AbortError"?void 0:(t.state="errored",o(E));if(this.map._refreshExpiredTiles&&T&&t.setExpiryData({cacheControl:C,expires:A}),this.partial)t.state="empty";else{if(!T)return o(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=T}o(null)};t.request=this.partial?t.fetchHeader(void 0,v.bind(this)):t.actor.send("loadTile",_,v.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){let h=t.texturePerLayer;if(t.flushAllQueues(),h.size){t.destroy(!0);for(let g of h.values())this.map.painter.saveTileTexture(g)}else t.destroy()}prepareTile(t,o,h,g){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(o,h,g,(_,v)=>{if(_)return t.state="errored",this.fire(new r.z(_)),void this.triggerRepaint(t);v&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(h,v,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;let o=this.rasterLayers.find(({id:_})=>_===t),h=o&&o.fields,g=h&&h.bands&&h.bands;return g?g[0]:0}getTextureDescriptor(t,o,h){if(!t)return;let g=o.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!g)return;let _=null;o instanceof r.aN?_=o.paint.get("raster-array-band"):o instanceof r.aO&&(_=o.paint.get("raster-particle-array-band"));let v=_||this.getInitialBand(g);if(v==null)return;if(!t.textureDescriptorPerLayer.get(o.id))return void this.prepareTile(t,g,o.id,v);if(t.updateNeeded(o.id,v)&&!h)return;let E=t.textureDescriptorPerLayer.get(o.id);return Object.assign({},E,{texture:t.texturePerLayer.get(o.id)})}getImages(t,o){let h=new Map;for(let g of t)for(let _ of o){let[v,E]=_.split("/"),T=g.getLayer(v);if(!T||!T.hasBand(E)||!T.hasDataForBand(E))continue;let{bytes:C,tileSize:A,buffer:L}=T.getBandView(E),R=A+2*L,F={data:new r.r({width:R,height:R},C),pixelRatio:2,sdf:!1,usvg:!1,version:0};h.set(_,F)}return h}}let Xd={vector:mu,raster:vi,"raster-dem":class extends vi{constructor(d,t,o,h){super(d,t,o,h),this.type="raster-dem",this.maxzoom=22,this._options=r.h({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(d,t){let o=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function h(g,_){g&&(d.state="errored",t(g)),_&&(d.dem=_,d.dem.onDeserialize(),d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0,d.state="loaded",t(null))}d.request=r.o(this.map._requestManager.transformRequest(o,r.R.Tile),(function(g,_,v,E){if(delete d.request,d.aborted)d.state="unloaded",t(null);else if(g)d.state="errored",t(g);else if(_){this.map._refreshExpiredTiles&&d.setExpiryData({cacheControl:v,expires:E});let T=ImageBitmap&&_ instanceof ImageBitmap&&r.t(),C=1-(_.width-r.aL(_.width))/2;C<1||d.neighboringTiles||(d.neighboringTiles=this._getNeighboringTiles(d.tileID));let A=T?_:r.q.getImageData(_,C),L={uid:d.uid,tileID:d.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:A,encoding:this.encoding,padding:C};d.actor&&d.state!=="expired"||(d.actor=this.dispatcher.getActor(),d.actor.send("loadTile",L,h.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(d){let t=d.canonical,o=Math.pow(2,t.z),h=(t.x-1+o)%o,g=t.x===0?d.wrap-1:d.wrap,_=(t.x+1+o)%o,v=t.x+1===o?d.wrap+1:d.wrap,E={};return E[new r.aM(d.overscaledZ,g,t.z,h,t.y).key]={backfilled:!1},E[new r.aM(d.overscaledZ,v,t.z,_,t.y).key]={backfilled:!1},t.y>0&&(E[new r.aM(d.overscaledZ,g,t.z,h,t.y-1).key]={backfilled:!1},E[new r.aM(d.overscaledZ,d.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},E[new r.aM(d.overscaledZ,v,t.z,_,t.y-1).key]={backfilled:!1}),t.y+1<o&&(E[new r.aM(d.overscaledZ,g,t.z,h,t.y+1).key]={backfilled:!1},E[new r.aM(d.overscaledZ,d.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},E[new r.aM(d.overscaledZ,v,t.z,_,t.y+1).key]={backfilled:!1}),E}},"raster-array":ga,geojson:class extends r.E{constructor(d,t,o,h){super(),this.id=d,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(h),this._data=t.data,this._options=r.h({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;let g=r.aj/this.tileSize;this.workerOptions=r.h({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*g,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*g,extent:r.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:r.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*g,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(d){this.map=d,this.setData(this._data)}setData(d){return this._data=d,this._updateWorkerData(),this}updateData(d){if(!this._options.dynamic)return this.fire(new r.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof d!="string"&&(d.type==="Feature"&&(d={type:"FeatureCollection",features:[d]}),d.type!=="FeatureCollection"))return this.fire(new r.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof d!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let t=new Map;for(let o of this._data.features)t.set(o.id,o);for(let o of d.features)t.set(o.id,o);this._data.features=[...t.values()]}else this._data=d;return this._updateWorkerData(!0),this}getClusterExpansionZoom(d,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:d,source:this.id,scope:this.scope},t),this}getClusterChildren(d,t){return this.actor.send("geojson.getClusterChildren",{clusterId:d,source:this.id,scope:this.scope},t),this}getClusterLeaves(d,t,o,h){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:d,limit:t,offset:o},h),this}_updateWorkerData(d=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new r.A("dataloading",{dataType:"source"})),this._loaded=!1;let t=r.h({append:d},this.workerOptions);t.scope=this.scope;let o=this._data;typeof o=="string"?(t.request=this.map._requestManager.transformRequest(r.q.resolveURL(o),r.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(h,g)=>{if(this._loaded=!0,this._pendingLoad=null,h)this.fire(new r.z(h));else{let _={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&g&&g.resourceTiming&&g.resourceTiming[this.id]&&(_.resourceTiming=g.resourceTiming[this.id]),d&&(this._partialReload=!0),this.fire(new r.A("data",_)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(d),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let d=r.C(this.id,this.scope);this.map.style.clearSource(d),this._updateWorkerData()}loadTile(d,t){let o=d.actor?"reloadTile":"loadTile";d.actor=this.actor;let h=this.map.style?this.map.style.getLut(this.scope):null,g=h?{image:h.image.clone()}:null,_=this._partialReload,v={type:this.type,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:g,scope:this.scope,pixelRatio:r.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:d.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:_,worldview:this.map.getWorldview()};d.request=this.actor.send(o,v,(E,T)=>_&&!T?(d.state="loaded",t(null)):(delete d.request,d.destroy(),d.aborted?t(null):E?t(E):(d.loadVectorData(T,this.map.painter,o==="reloadTile"),t(null))),void 0,o==="loadTile")}abortTile(d){d.request&&(d.request.cancel(),delete d.request),d.aborted=!0}unloadTile(d,t){this.actor.send("removeTile",{uid:d.uid,type:this.type,source:this.id,scope:this.scope}),d.destroy()}onRemove(d){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return r.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends r.aP{constructor(d,t,o,h){super(d,t,o,h),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;let d=this.options;this.urls=[];for(let t of d.urls)this.urls.push(this.map._requestManager.transformRequest(t,r.R.Source).url);r.aQ(this.urls,(t,o)=>{this._loaded=!0,t?this.fire(new r.z(t)):o&&(this.video=o,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(d){if(this.video){let t=this.video.seekable;d<t.start(0)||d>t.end(0)?this.fire(new r.z(new r.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=d}}getVideo(){return this.video}onAdd(d){this.map||(this.map=d,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let d=this.map.painter.context,t=d.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new r.T(d,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(d)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:r.aP,model:class extends r.E{constructor(d,t,o,h){super(),this.id=d,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){let d=[];for(let t in this._options.models){let o=this._options.models[t],h=r.aS(this.map._requestManager.transformRequest(o.uri,r.R.Model).url).then(g=>{if(!g)return;let _=r.aT(g),v=new r.aU(t,o.position,o.orientation,_);v.computeBoundsAndApplyParent(),this.models.push(v)}).catch(g=>{this.fire(new r.z(new Error(`Could not load model ${t} from ${o.uri}: ${g.message}`)))});d.push(h)}Promise.allSettled(d).then(()=>{this._loaded=!0,this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new r.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(d){this.map=d,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(d,t){}serialize(){return this._options}},"batched-model":class extends r.E{constructor(d,t,o,h){super(),this.type="batched-model",this.id=d,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=o,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(h)}onAdd(d){this.map=d,this.load()}reload(){this.cancelTileJSONRequest();let d=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(d))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(d){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));let t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=hi(this._options,this.map._requestManager,t,o,(h,g)=>{this._tileJSONRequest=null,this._loaded=!0,h?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),o&&o.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new r.z(h))):g&&(r.h(this,g),g.bounds&&(this.tileBounds=new Ri(g.bounds,this.minzoom,this.maxzoom)),zi(g.tiles,this.map._requestManager._customAccessToken),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))),d&&d(h)})}hasTransition(){return!1}hasTile(d){return!this.tileBounds||this.tileBounds.contains(d.canonical)}loaded(){return this._loaded}loadTile(d,t){let o=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme)),h={request:this.map._requestManager.transformRequest(o,r.R.Tile),data:void 0,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,tileSize:this.tileSize*d.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:d.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:r.q.devicePixelRatio,promoteId:this.promoteId};if(d.actor&&d.state!=="expired")if(d.state==="loading")d.reloadCallback=t;else{if(d.buckets){let _=Object.values(d.buckets);for(let v of _)v.dirty=!0;return void(d.state="loaded")}d.request=d.actor.send("reloadTile",h,g.bind(this))}else d.actor=this.dispatcher.getActor(),d.request=d.actor.send("loadTile",h,g.bind(this),void 0,!0);function g(_,v){return d.aborted?t(null):_&&_.status!==404?t(_):(this.map._refreshExpiredTiles&&v&&d.setExpiryData(v),d.loadModelData(v,this.map.painter),d.state="loaded",void t(null))}}serialize(){return r.h({},this._options)}},canvas:class extends r.aP{constructor(d,t,o,h){super(d,t,o,h),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(g=>!Array.isArray(g)||g.length!==2||g.some(_=>typeof _!="number"))||this.fire(new r.z(new r.V(`sources.${d}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new r.z(new r.V(`sources.${d}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new r.z(new r.V(`sources.${d}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new r.z(new r.V(`sources.${d}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new r.z(new r.V(`sources.${d}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new r.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(d){this.map=d,this.load(),this.canvas&&this.animate&&this.play()}onRemove(d){this.pause()}prepare(){let d=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,d=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,d=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let t=this.map.painter.context;this.texture?!d&&!this._playing||this.texture instanceof r.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new r.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let d of[this.canvas.width,this.canvas.height])if(isNaN(d)||d<=0)return!0;return!1}},custom:class extends r.E{constructor(d,t,o,h){super(),this.id=d,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=t,this.setEventedParent(h),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new r.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new r.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Ri(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),r.h(this,r.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return r.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(d){this.map=d,this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(d),this.load()}onRemove(d){this._implementation.onRemove&&this._implementation.onRemove(d)}hasTile(d){if(this._implementation.hasTile){let{x:t,y:o,z:h}=d.canonical;return this._implementation.hasTile({x:t,y:o,z:h})}return!this.tileBounds||this.tileBounds.contains(d.canonical)}loadTile(d,t){let{x:o,y:h,z:g}=d.tileID.canonical,_=new AbortController;d.request=Promise.resolve(this._implementation.loadTile({x:o,y:h,z:g},{signal:_.signal})).then((function(v){return delete d.request,d.aborted?(d.state="unloaded",t(null)):v===void 0?(d.state="errored",t(null)):v===null?(this.loadTileData(d,{width:this.tileSize,height:this.tileSize,data:null}),d.state="loaded",t(null)):function(E){return E instanceof ImageData||E instanceof HTMLCanvasElement||E instanceof ImageBitmap||E instanceof HTMLImageElement}(v)?(this.loadTileData(d,v),d.state="loaded",void t(null)):(d.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(v=>{v.name!=="AbortError"&&(d.state="errored",t(v))}),d.request.cancel=()=>_.abort()}loadTileData(d,t){d.setTexture(t,this.map.painter)}unloadTile(d,t){if(d.texture&&d.texture instanceof r.T?(d.destroy(!0),d.texture&&d.texture instanceof r.T&&this.map.painter.saveTileTexture(d.texture)):d.destroy(),this._implementation.unloadTile){let{x:o,y:h,z:g}=d.tileID.canonical;this._implementation.unloadTile({x:o,y:h,z:g})}t&&t()}abortTile(d,t){d.request&&d.request.cancel&&(d.request.cancel(),delete d.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(d=>({x:d.canonical.x,y:d.canonical.y,z:d.canonical.z}))}_clearTiles(){let d=r.C(this.id,this.scope);this.map.style.clearSource(d)}_update(){this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}}},gu=function(d,t,o,h){let g=new Xd[t.type](d,t,o,h);if(g.id!==d)throw new Error(`Expected Source id to be ${d} instead of ${g.id}`);return r.aV(["load","abort","unload","serialize","prepare"],g),g};function _u(d,t,o=""){return`${o}:${t.id||""}:${t.layer.id}:${function(h){if("layerId"in h)return`layer:${h.layerId}`;{let{featuresetId:g,importId:_}=h;return`featureset:${g}${_?`:import:${_}`:""}`}}(d.target)}`}function Yd(d,t,o,h=""){if(d.uniqueFeatureID){let g=_u(d,t,h);if(o.has(g))return!0;o.add(g)}return!1}function Kd(d,t,o,h,g=!1){let _=t.sourceCache.transform,v=t.sourceCache.tilesIn(d,t.has3DLayers,g);v.sort(Jd);let E=[];for(let T of v){let C=T.tile.queryRenderedFeatures(t,T,o,h,_,g);Object.keys(C).length&&E.push({wrappedTileID:T.tile.tileID.wrapped().key,queryResults:C})}return E.length===0?{}:function(T){let C={},A={};for(let L of T){let R=L.queryResults,F=L.wrappedTileID,V=A[F]=A[F]||{};for(let z in R){let H=R[z],j=V[z]=V[z]||{},Z=C[z]=C[z]||[];for(let Y of H)j[Y.featureIndex]||(j[Y.featureIndex]=!0,Z.push(Y))}}return C}(E)}function el(d,t,o,h,g,_){let v={},E=h.queryRenderedSymbols(d),T=[];for(let C of Object.keys(E).map(Number))T.push(g[C]);T.sort(Jd);for(let C of T){let A=C.featureIndex.lookupSymbolFeatures(E[C.bucketInstanceId],C.bucketIndex,C.sourceLayerIndex,t,o,_);for(let L in A){let R=v[L]=v[L]||[],F=A[L];F.sort((V,z)=>{let H=C.featureSortOrder;if(H){let j=H.indexOf(V.featureIndex);return H.indexOf(z.featureIndex)-j}return z.featureIndex-V.featureIndex});for(let V of F)R.push(V)}}return v}function yu(d,t){let o=d.getRenderableIds().map(_=>d.getTileByID(_)),h=[],g={};for(let _=0;_<o.length;_++){let v=o[_],E=v.tileID.canonical.key;g[E]||(g[E]=!0,v.querySourceFeatures(h,t))}return h}function Jd(d,t){let o=d.tileID,h=t.tileID;return o.overscaledZ-h.overscaledZ||o.canonical.y-h.canonical.y||o.wrap-h.wrap||o.canonical.x-h.canonical.x}function cs(d,t){let o={};if(!t)return o;for(let h of d){let g=h.layerIds.map(_=>t.getLayer(_)).filter(Boolean);if(g.length!==0){h.layers=g,h.stateDependentLayerIds&&(h.stateDependentLayers=h.stateDependentLayerIds.map(_=>g.filter(v=>v.id===_)[0]));for(let _ of g)o[_.fqid]=h}}return o}let Do=32,Xo=33,Vs=new Uint16Array(8184);for(let d=0;d<2046;d++){let t=d+2,o=0,h=0,g=0,_=0,v=0,E=0;for(1&t?g=_=v=Do:o=h=E=Do;(t>>=1)>1;){let C=o+g>>1,A=h+_>>1;1&t?(g=o,_=h,o=v,h=E):(o=g,h=_,g=v,_=E),v=C,E=A}let T=4*d;Vs[T+0]=o,Vs[T+1]=h,Vs[T+2]=g,Vs[T+3]=_}let us=new Uint16Array(2178),Us=new Uint8Array(1089),vu=new Uint16Array(1089);function Es(d){return d===0?-.03125:d===32?.03125:0}let xu={type:2,extent:r.aj,loadGeometry:()=>[[new r.P(0,0),new r.P(r.aj+1,0),new r.P(r.aj+1,r.aj+1),new r.P(0,r.aj+1),new r.P(0,0)]]};class tl{constructor(t,o,h,g,_,v){this.tileID=t,this.uid=r.a$(),this.uses=0,this.tileSize=o,this.tileZoom=h,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=_,g&&g.style&&(this._lastUpdatedBrightness=g.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",g&&g.transform&&(this.projection=g.transform.projection),this.worldview=v}registerFadeDuration(t){let o=t+this.timeAdded;o<r.q.now()||this.fadeEndTime&&o<this.fadeEndTime||(this.fadeEndTime=o)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=r.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,o,h){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=cs(t.buckets,o.style),this.hasSymbolBuckets=!1;for(let g in this.buckets){let _=this.buckets[g];if(_ instanceof r.b1){if(this.hasSymbolBuckets=!0,!h)break;_.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let g in this.buckets){let _=this.buckets[g];if(_ instanceof r.b1&&_.hasRTLText){this.hasRTLText=!0,r.b2();break}}this.queryPadding=0;for(let g in this.buckets){let _=this.buckets[g],v=o.style.getOwnLayer(g);if(!v)continue;let E=v.queryRadius(_);this.queryPadding=Math.max(this.queryPadding,E)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new r.b0}unloadVectorData(){if(this.hasData()){for(let t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,o,h){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,cs(t.buckets,o.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(let g in this.buckets){let _=this.buckets[g];_.uploadPending()&&_.upload(t)}let o=t.gl,h=this.imageAtlas;h&&!h.uploaded&&(this.imageAtlasTexture=new r.T(t,h.image,o.RGBA8,{useMipmap:!!h.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new r.T(t,this.glyphAtlasImage,o.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new r.T(t,this.lineAtlas.image,o.R8),this.lineAtlas.uploaded=!0)}prepare(t,o,h){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,h),!o||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let g=o.style.getBrightness();(this._lastUpdatedBrightness||g)&&(this._lastUpdatedBrightness&&g&&Math.abs(this._lastUpdatedBrightness-g)<.001||(this.updateBuckets(o,this._lastUpdatedBrightness!==g),this._lastUpdatedBrightness=g))}queryRenderedFeatures(t,o,h,g,_,v){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let E=function(T,C){let A=r.bn([],[.5*T.width,.5*-T.height,1]);return r.bo(A,A,[1,-1,0]),r.az(A,A,T.calculateProjMatrix(C.toUnwrapped())),Float32Array.from(A)}(_,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:o,pixelPosMatrix:E,transform:g,availableImages:h,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,o){let h=this.latestFeatureIndex;if(!h||!h.rawTileData)return;let g=h.loadVTLayers(),_=o?o.sourceLayer:"",v=g._geojsonTileLayer||g[_];if(!v)return;let E=r.b3(o&&o.filter),{z:T,x:C,y:A}=this.tileID.canonical,L={z:T,x:C,y:A};for(let R=0;R<v.length;R++){let F=v.feature(R);if(E.needGeometry){let H=r.b4(F,!0);if(!E.filter(new r.aa(this.tileID.overscaledZ,{worldview:this.worldview}),H,this.tileID.canonical))continue}else if(!E.filter(new r.aa(this.tileID.overscaledZ,{worldview:this.worldview}),F))continue;let V=h.getId(F,_),z=new r.b5(F,T,C,A,V);z.tile=L,t.push(z)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){let o=this.expirationTime;if(t.cacheControl){let h=r.b6(t.cacheControl);h["max-age"]&&(this.expirationTime=Date.now()+1e3*h["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){let h=Date.now(),g=!1;if(this.expirationTime>h)g=!1;else if(o)if(this.expirationTime<o)g=!0;else{let _=this.expirationTime-o;_?this.expirationTime=h+Math.max(_,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,o){if(!this.latestFeatureIndex||!t.style)return;let h=this.latestFeatureIndex.loadVTLayers(),g=t.style.listImages(),_=t.style.getBrightness();for(let v in this.buckets){if(!t.style.hasLayer(v))continue;let E=this.buckets[v],T=E.layers[0],C=T.sourceLayer||"_geojsonTileLayer",A=h[C],L=t.style.getLayerSourceCache(T),R={};L&&(R=L._state.getState(C,void 0));let F=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},V=Object.keys(R).length>0&&!o;V&&!E.stateDependentLayers.length&&!o||E.update(R,A,g,F,V?E.stateDependentLayers:E.layers,o,_),(E instanceof r.b7||E instanceof r.b8)&&t._terrain&&t._terrain.enabled&&L&&E.uploadPending()&&t._terrain._clearRenderCacheForTile(L.id,this.tileID);let z=t&&t.style&&t.style.getOwnLayer(v);z&&(this.queryPadding=Math.max(this.queryPadding,z.queryRadius(E)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<r.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=r.q.now()+t}setTexture(t,o){let h=o.context,g=h.gl;this.texture=this.texture||o.getTileTexture(t.width),this.texture&&this.texture instanceof r.T?this.texture.update(t):(this.texture=new r.T(h,t,g.RGBA8,{useMipmap:!0}),this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE))}setDependencies(t,o){let h={};for(let g of o)h[g]=!0;this.dependencies[t]=h}hasDependency(t,o){for(let h of t){let g=this.dependencies[h];if(g){for(let _ of o)if(g[_])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,o){if(!o||o.name==="mercator"||this._tileDebugBuffer)return;let h=r.b9(xu,this.tileID.canonical,this.tileTransform)[0],g=new r.ba,_=new r.bb;for(let v=0;v<h.length;v++){let{x:E,y:T}=h[v];g.emplaceBack(E,T),_.emplaceBack(v)}_.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(_),this._tileDebugBuffer=t.createVertexBuffer(g,r.bc.members),this._tileDebugSegments=r.bd.simpleSegment(0,0,g.length,_.length)}_makeTileBoundsBuffers(t,o){if(this._tileBoundsBuffer||!o||o.name==="mercator")return;let h=r.b9(xu,this.tileID.canonical,this.tileTransform)[0],g,_;if(this.isRaster){let v=function(E,T){let C=r.aW(E,T),A=Math.pow(2,E.z);for(let H=0;H<Xo;H++)for(let j=0;j<Xo;j++){let Z=r.aX((E.x+(j+Es(j))/Do)/A),Y=r.aY((E.y+(H+Es(H))/Do)/A),J=T.project(Z,Y),re=H*Xo+j;us[2*re+0]=Math.round((J.x*C.scale-C.x)*r.aj),us[2*re+1]=Math.round((J.y*C.scale-C.y)*r.aj)}Us.fill(0),vu.fill(0);for(let H=2045;H>=0;H--){let j=4*H,Z=Vs[j+0],Y=Vs[j+1],J=Vs[j+2],re=Vs[j+3],ce=Z+J>>1,de=Y+re>>1,ie=ce+de-Y,oe=de+Z-ce,se=Y*Xo+Z,Te=re*Xo+J,me=de*Xo+ce,Ne=Math.hypot((us[2*se+0]+us[2*Te+0])/2-us[2*me+0],(us[2*se+1]+us[2*Te+1])/2-us[2*me+1])>=16;Us[me]=Us[me]||(Ne?1:0),H<1022&&(Us[me]=Us[me]||Us[(Y+oe>>1)*Xo+(Z+ie>>1)]||Us[(re+oe>>1)*Xo+(J+ie>>1)])}let L=new r.aZ,R=new r.a_,F=0;function V(H,j){let Z=j*Xo+H;return vu[Z]===0&&(L.emplaceBack(us[2*Z+0],us[2*Z+1],H*r.aj/Do,j*r.aj/Do),vu[Z]=++F),vu[Z]-1}function z(H,j,Z,Y,J,re){let ce=H+Z>>1,de=j+Y>>1;if(Math.abs(H-J)+Math.abs(j-re)>1&&Us[de*Xo+ce])z(J,re,H,j,ce,de),z(Z,Y,J,re,ce,de);else{let ie=V(H,j),oe=V(Z,Y),se=V(J,re);R.emplaceBack(ie,oe,se)}}return z(0,0,Do,Do,Do,0),z(Do,Do,0,0,0,Do),{vertices:L,indices:R}}(this.tileID.canonical,o);g=v.vertices,_=v.indices}else{g=new r.aZ,_=new r.a_;for(let{x:E,y:T}of h)g.emplaceBack(E,T,0,0);let v=r.be(g.int16.subarray(0,4*g.length),void 0,4);for(let E=0;E<v.length;E+=3)_.emplaceBack(v[E],v[E+1],v[E+2])}this._tileBoundsBuffer=t.createVertexBuffer(g,r.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(_),this._tileBoundsSegments=r.bd.simpleSegment(0,0,g.length,_.length)}_makeGlobeTileDebugBuffers(t,o){let h=o.projection;if(!h||h.name!=="globe"||o.freezeTileCoverage)return;let g=this.tileID.canonical,_=r.bg(g,o),v=r.bh(_),E=r.ah(o.zoom),T;E>0&&(T=r.bi(new Float64Array(16),o.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,g,o,v,T,E),this._makeGlobeTileDebugTextBuffer(t,g,o,v,T,E)}_globePoint(t,o,h,g,_,v,E){let T=r.bj(t,o,h);if(v){let C=1<<h.z,A=r.aD(g.center.lng),L=r.aH(g.center.lat),R=(h.x+.5)/C-A,F=0;R>.5?F=-1:R<-.5&&(F=1);let V=(t/r.aj+h.x)/C+F,z=(o/r.aj+h.y)/C;V=(V-A)*g._pixelsPerMercatorPixel+A,z=(z-L)*g._pixelsPerMercatorPixel+L;let H=[V*g.worldSize,z*g.worldSize,0];r.ad(H,H,v),T=r.bk(T,H,E)}return r.ad(T,T,_)}_makeGlobeTileDebugBorderBuffer(t,o,h,g,_,v){let E=new r.ba,T=new r.bb,C=new r.bl,A=(R,F,V,z,H)=>{let j=(V-R)/(H-1),Z=(z-F)/(H-1),Y=E.length;for(let J=0;J<H;J++){let re=R+J*j,ce=F+J*Z;E.emplaceBack(re,ce);let de=this._globePoint(re,ce,o,h,g,_,v);C.emplaceBack(de[0],de[1],de[2]),T.emplaceBack(Y+J)}},L=r.aj;A(0,0,L,0,16),A(L,0,L,L,16),A(L,L,0,L,16),A(0,L,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(T),this._tileDebugBuffer=t.createVertexBuffer(E,r.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(C,r.bm.members),this._tileDebugSegments=r.bd.simpleSegment(0,0,E.length,T.length)}_makeGlobeTileDebugTextBuffer(t,o,h,g,_,v){let E=r.aj/4,T=new r.ba,C=new r.a_,A=new r.bl,L=25;C.reserve(32),T.reserve(L),A.reserve(L);let R=(F,V)=>L*F+V;for(let F=0;F<L;F++){let V=F*E;for(let z=0;z<L;z++){let H=z*E;T.emplaceBack(H,V);let j=this._globePoint(H,V,o,h,g,_,v);A.emplaceBack(j[0],j[1],j[2])}}for(let F=0;F<4;F++)for(let V=0;V<4;V++){let z=R(F,V),H=R(F,V+1),j=R(F+1,V),Z=R(F+1,V+1);C.emplaceBack(z,H,j),C.emplaceBack(j,H,Z)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(C),this._tileDebugTextBuffer=t.createVertexBuffer(T,r.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(A,r.bm.members),this._tileDebugTextSegments=r.bd.simpleSegment(0,0,L,32)}destroy(t=!1){for(let o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof r.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}r.bp.setPbf(r.bq);class Zl extends tl{constructor(t,o,h,g,_){super(t,o,h,g,_),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,o,h){let g=h.context,_=g.gl,v=this.texturePerLayer.get(t)||h.getTileTexture(o.width);v&&v instanceof r.T?v.update(o,{premultiply:!1}):v=new r.T(g,o,_.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,v)}flushQueues(t){let o=this._workQueuePerLayer.get(t)||[],h=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()();for(;h.length;)h.pop()()}flushAllQueues(){for(let t of this._workQueuePerLayer.keys()){let o=this._workQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}for(let t of this._fetchQueuePerLayer.keys()){let o=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}}fetchHeader(t=16384,o){let h=this._mrt=new r.bp(30),g=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=r.br(g,(_,v,E,T)=>{if(_)o(_);else try{let C=h.getHeaderLength(v);if(C>t)return void(this.request=this.fetchHeader(C,o));h.parseHeader(v),this._isHeaderLoaded=!0;let A=0;for(let L of Object.values(h.layers))A=Math.max(A,L.dataIndex[L.dataIndex.length-1].lastByte);v.byteLength>=A&&(this.entireBuffer=v),o(null,this.entireBuffer||v,E,T)}catch(C){o(C)}}),this.request}fetchBand(t,o,h,g){let _=this._mrt;if(!this._isHeaderLoaded||!_)return void g(new Error("Tile header is not ready"));let v=this.actor;if(!v)return void g(new Error("Can't fetch tile band without an actor"));let E,T=(R,F)=>{if(E.complete(R,F),R)return void g(R);this.updateTextureDescriptor(t,o,h);let V=this.textureDescriptorPerLayer.get(o);g(null,V&&V.img)},C=(R,F)=>{if(R)return g(R);let V=v.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:F,task:E},T,void 0,!0),z=this._workQueuePerLayer.get(o)||[];z.push(()=>{V&&V.cancel(),E.cancel()}),this._workQueuePerLayer.has(o)||this._workQueuePerLayer.set(o,z)},A=_.getLayer(t);if(!A)return void g(new Error(`Unknown sourceLayer "${t}"`));if(A.hasDataForBand(h)){this.updateTextureDescriptor(t,o,h);let R=this.textureDescriptorPerLayer.get(o);return void g(null,R?R.img:null)}let L=A.getDataRange([h]);if(E=_.createDecodingTask(L),!E||E.tasks.length)if(this.flushQueues(o),this.entireBuffer)C(null,this.entireBuffer.slice(L.firstByte,L.lastByte+1));else{let R=Object.assign({},this.requestParams,{headers:{Range:`bytes=${L.firstByte}-${L.lastByte}`}}),F=r.br(R,C),V=this._fetchQueuePerLayer.get(o)||[];V.push(()=>{F.cancel(),E.cancel()}),this._fetchQueuePerLayer.has(o)||this._fetchQueuePerLayer.set(o,V)}else g(null)}updateNeeded(t,o){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==o)&&this.state!=="errored"}updateTextureDescriptor(t,o,h){if(!this._mrt)return;let g=this._mrt.getLayer(t);if(!g||!g.hasBand(h)||!g.hasDataForBand(h))return;let{bytes:_,tileSize:v,buffer:E,offset:T,scale:C}=g.getBandView(h),A=v+2*E,L=new r.r({width:A,height:A},_),R=this.texturePerLayer.get(o);R&&R instanceof r.T&&R.update(L,{premultiply:!1}),this.textureDescriptorPerLayer.set(o,{layer:t,band:h,img:L,buffer:E,offset:T,tileSize:v,format:g.pixelFormat,mix:[C,256*C,65536*C,16777216*C]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(let o of this.texturePerLayer.values())o&&o instanceof r.T&&o.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class wp{constructor(t,o){this.max=t,this.onRemove=o,this.reset()}reset(){for(let t in this.data)for(let o of this.data[t])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(t,o,h){let g=t.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);let _={value:o,timeout:void 0};if(h!==void 0&&(_.timeout=setTimeout(()=>{this.remove(t,_)},h)),this.data[g].push(_),this.order.push(g),this.order.length>this.max){let v=this._getAndRemoveByKey(this.order[0]);v&&this.onRemove(v)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){let o=this.data[t].shift();return o.timeout&&clearTimeout(o.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),o.value}getByKey(t){let o=this.data[t];return o?o[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,o){if(!this.has(t))return this;let h=t.wrapped().key,g=o===void 0?0:this.data[h].indexOf(o),_=this.data[h][g];return this.data[h].splice(g,1),_.timeout&&clearTimeout(_.timeout),this.data[h].length===0&&delete this.data[h],this.onRemove(_.value),this.order.splice(this.order.indexOf(h),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){let o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(t){let o=[];for(let h in this.data)for(let g of this.data[h])t(g.value)||o.push(g);for(let h of o)this.remove(h.value.tileID,h)}}class Ep{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,o,h){let g=String(o);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][g]=this.stateChanges[t][g]||{},r.h(this.stateChanges[t][g],h),this.deletedStates[t]===null){this.deletedStates[t]={};for(let _ in this.state[t])_!==g&&(this.deletedStates[t][_]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][g]===null){this.deletedStates[t][g]={};for(let _ in this.state[t][g])h[_]||(this.deletedStates[t][g][_]=null)}else for(let _ in h)this.deletedStates[t]&&this.deletedStates[t][g]&&this.deletedStates[t][g][_]===null&&delete this.deletedStates[t][g][_]}removeFeatureState(t,o,h){if(this.deletedStates[t]===null)return;let g=String(o);if(this.deletedStates[t]=this.deletedStates[t]||{},h&&o!==void 0)this.deletedStates[t][g]!==null&&(this.deletedStates[t][g]=this.deletedStates[t][g]||{},this.deletedStates[t][g][h]=null);else if(o!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][g])for(h in this.deletedStates[t][g]={},this.stateChanges[t][g])this.deletedStates[t][g][h]=null;else this.deletedStates[t][g]=null;else this.deletedStates[t]=null}getState(t,o){let h=this.state[t]||{},g=this.stateChanges[t]||{},_=this.deletedStates[t];if(_===null)return{};if(o!==void 0){let E=String(o),T=r.h({},h[E],g[E]);if(_){let C=_[o];if(C===null)return{};for(let A in C)delete T[A]}return T}let v=r.h({},h,g);if(_)for(let E in _)delete v[E];return v}initializeTileState(t,o){t.refreshFeatureState(o)}coalesceChanges(t,o){let h={};for(let g in this.stateChanges){this.state[g]=this.state[g]||{};let _={};for(let v in this.stateChanges[g])this.state[g][v]||(this.state[g][v]={}),r.h(this.state[g][v],this.stateChanges[g][v]),_[v]=this.state[g][v];h[g]=_}for(let g in this.deletedStates){this.state[g]=this.state[g]||{};let _={};if(this.deletedStates[g]===null)for(let v in this.state[g])_[v]={},this.state[g][v]={};else for(let v in this.deletedStates[g]){if(this.deletedStates[g][v]===null)this.state[g][v]={};else if(this.state[g][v])for(let E of Object.keys(this.deletedStates[g][v]))delete this.state[g][v][E];_[v]=this.state[g][v]}h[g]=h[g]||{},r.h(h[g],_)}if(this.stateChanges={},this.deletedStates={},Object.keys(h).length!==0)for(let g in t)t[g].refreshFeatureState(o)}}class eo extends r.E{constructor(t,o,h){super(),this.id=t,this._onlySymbols=h,o.on("data",g=>{g.dataType==="source"&&g.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&g.dataType==="source"&&g.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),o.on("error",()=>{this._sourceErrored=!0}),this._source=o,this._tiles={},this._cache=new wp(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=o.minTileCacheSize,this._maxTileCacheSize=o.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Ep,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,o){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,o)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let o in this._tiles){let h=this._tiles[o];h.upload(t),h.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(nl).map(t=>t.key)}getRenderableIds(t,o){let h=[];for(let g in this._tiles)this._isIdRenderable(+g,t,o)&&h.push(this._tiles[g]);return t?h.sort((g,_)=>{let v=g.tileID,E=_.tileID,T=new r.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle),C=new r.P(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return v.overscaledZ-E.overscaledZ||C.y-T.y||C.x-T.x}).map(g=>g.tileID.key):h.map(g=>g.tileID).sort(nl).map(g=>g.key)}hasRenderableParent(t){let o=this.findLoadedParent(t,0);return!!o&&this._isIdRenderable(o.tileID.key)}_isIdRenderable(t,o,h){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(o||!this._tiles[t].holdingForFade())&&(h||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,o){let h=this._tiles[t];h&&(h.state!=="loading"&&(h.state=o),this._loadTile(h,this._tileLoaded.bind(this,h,t,o)))}_tileLoaded(t,o,h,g){if(g)if(t.state="errored",g.status!==404)this._source.fire(new r.z(g,{tile:t}));else{if(this._source.fire(new r.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let _=this.map.painter.terrain;this.update(this.transform,_.getScaledDemTileSize(),!0),_.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=r.q.now(),h==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(o,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new r.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){let o=this.getRenderableIds();for(let g=0;g<o.length;g++){let _=o[g];if(t.neighboringTiles&&t.neighboringTiles[_]){let v=this.getTileByID(_);h(t,v),h(v,t)}}function h(g,_){if(!g.dem||g.dem.borderReady)return;g.needsHillshadePrepare=!0,g.needsDEMTextureUpload=!0;let v=_.tileID.canonical.x-g.tileID.canonical.x,E=_.tileID.canonical.y-g.tileID.canonical.y,T=Math.pow(2,g.tileID.canonical.z),C=_.tileID.key;v===0&&E===0||Math.abs(E)>1||(Math.abs(v)>1&&(Math.abs(v+T)===1?v+=T:Math.abs(v-T)===1&&(v-=T)),_.dem&&g.dem&&(g.dem.backfillBorder(_.dem,v,E),g.neighboringTiles&&g.neighboringTiles[C]&&(g.neighboringTiles[C].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,o,h,g){for(let _ in this._tiles){let v=this._tiles[_];if(g[_]||!v.hasData()||v.tileID.overscaledZ<=o||v.tileID.overscaledZ>h)continue;let E=v.tileID;for(;v&&v.tileID.overscaledZ>o+1;){let C=v.tileID.scaledTo(v.tileID.overscaledZ-1);v=this._tiles[C.key],v&&v.hasData()&&(E=C)}let T=E;for(;T.overscaledZ>o;)if(T=T.scaledTo(T.overscaledZ-1),t[T.key]){g[E.key]=E;break}}}findLoadedParent(t,o){if(t.key in this._loadedParentTiles){let h=this._loadedParentTiles[t.key];return h&&h.tileID.overscaledZ>=o?h:null}for(let h=t.overscaledZ-1;h>=o;h--){let g=t.scaledTo(h),_=this._getLoadedTile(g);if(_)return _}}_getLoadedTile(t){let o=this._tiles[t.key];return o&&o.hasData()?o:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,o){o=o||this._source.tileSize;let h=Math.ceil(t.width/o)+1,g=Math.ceil(t.height/o)+1,_=Math.floor(h*g*5),v=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,_):_,E=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,v):v;this._cache.setMaxSize(E)}handleWrapJump(t){let o=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,o){let h={};for(let g in this._tiles){let _=this._tiles[g];_.tileID=_.tileID.unwrapTo(_.tileID.wrap+o),h[_.tileID.key]=_}this._tiles=h;for(let g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(let g in this._tiles)this._setTileReloadTimer(+g,this._tiles[g])}}update(t,o,h,g,_){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!h)return;this.updateCacheSize(t,o),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let v=this._source.type==="batched-model",E,T=this._source.maxzoom,C=this.map&&this.map.painter?this.map.painter._terrain:null;if(C&&C.sourceCache===this&&C.attenuationRange()){let R=C.attenuationRange()[0],F=Math.floor(R)-Math.log2(C.getDemUpscale());T>F&&(T=F)}if(this.used||this.usedForTerrain){if(this._source.tileID)E=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(R=>new r.aM(R.canonical.z,R.wrap,R.canonical.z,R.canonical.x,R.canonical.y));else if(this.tileCoverLift!==0){let R=t.clone();R.tileCoverLift=this.tileCoverLift,E=R.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.minzoom<=1&&t.projection.name==="globe"&&(E.push(new r.aM(1,0,1,0,0)),E.push(new r.aM(1,0,1,1,0)),E.push(new r.aM(1,0,1,0,1)),E.push(new r.aM(1,0,1,1,1)))}else if(E=t.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.hasTile){let R=this._source.hasTile.bind(this._source);E=E.filter(F=>R(F))}}else E=[];if(E.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!bu(this._source.type)){let R=t.coveringZoomLevel({tileSize:o||this._source.tileSize,roundZoom:this._source.roundZoom&&!h}),F=Math.min(R,this._source.maxzoom);if(v){let V=t.extendTileCover(E,F);for(let z of V)E.push(z)}else if(_){let V=t.extendTileCoverToNearPlane(E,this.transform.getFrustum(F),F);for(let z of V)E.push(z)}else if(this.castsShadows&&g){let V=t.extendTileCover(E,F,g);for(let z of V)this._shadowCasterTiles[z.key]=!0,E.push(z)}}let A=this._updateRetainedTiles(E);if(bu(this._source.type)&&E.length!==0){let R={},F={},V=Object.keys(A);for(let H of V){let j=A[H],Z=this._tiles[H];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=r.q.now())continue;let Y=this.findLoadedParent(j,Math.max(j.overscaledZ-eo.maxOverzooming,this._source.minzoom));Y&&(this._addTile(Y.tileID),R[Y.tileID.key]=Y.tileID),F[H]=j}let z=E[E.length-1].overscaledZ;for(let H in this._tiles){let j=this._tiles[H];if(A[H]||!j.hasData())continue;let Z=j.tileID;for(;Z.overscaledZ>z;){Z=Z.scaledTo(Z.overscaledZ-1);let Y=this._tiles[Z.key];if(Y&&Y.hasData()&&F[Z.key]){A[H]=j.tileID;break}}}for(let H in R)A[H]||(this._coveredTiles[H]=!0,A[H]=R[H])}for(let R in A)this._tiles[R].clearFadeHold();let L=r.bs(this._tiles,A);for(let R of L){let F=this._tiles[R];F.hasSymbolBuckets&&!F.holdingForFade()?F.setHoldDuration(this.map._fadeDuration):F.hasSymbolBuckets&&!F.symbolFadeFinished()||this._removeTile(+R)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){let o={};if(t.length===0)return o;let h={},g=t.reduce((C,A)=>Math.min(C,A.overscaledZ),1/0),_=t[0].overscaledZ,v=Math.max(_-eo.maxOverzooming,this._source.minzoom),E=Math.max(_+eo.maxUnderzooming,this._source.minzoom),T={};for(let C of t){let A=this._addTile(C);o[C.key]=C,A.hasData()||g<this._source.maxzoom&&(T[C.key]=C)}this._retainLoadedChildren(T,g,E,o);for(let C of t){let A=this._tiles[C.key];if(A.hasData())continue;if(C.canonical.z>=this._source.maxzoom){let R=C.children(this._source.maxzoom)[0],F=this.getTile(R);if(F&&F.hasData()){o[R.key]=R;continue}}else{let R=C.children(this._source.maxzoom);if(o[R[0].key]&&o[R[1].key]&&o[R[2].key]&&o[R[3].key])continue}let L=A.wasRequested();for(let R=C.overscaledZ-1;R>=v;--R){let F=C.scaledTo(R);if(h[F.key]||(h[F.key]=!0,A=this.getTile(F),!A&&L&&(A=this._addTile(F)),A&&(o[F.key]=F,L=A.wasRequested(),A.hasData())))break}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let t in this._tiles){let o=[],h,g=this._tiles[t].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){h=this._loadedParentTiles[g.key];break}o.push(g.key);let _=g.scaledTo(g.overscaledZ-1);if(h=this._getLoadedTile(_),h)break;g=_}for(let _ of o)this._loadedParentTiles[_]=h}}_addTile(t){let o=this._tiles[t.key];if(o)return o.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),o;o=this._cache.getAndRemove(t),o&&(this._setTileReloadTimer(t.key,o),o.tileID=t,this._state.initializeTileState(o,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,o)));let h=!!o;if(!h){let g=this.map?this.map.painter:null,_=this._source.tileSize*t.overscaleFactor();o=this._source.type==="raster-array"?new Zl(t,_,this.transform.tileZoom,g,this._isRaster):new tl(t,_,this.transform.tileZoom,g,this._isRaster,this._source.worldview),this._loadTile(o,this._tileLoaded.bind(this,o,t.key,o.state))}return o.uses++,this._tiles[t.key]=o,h||this._source.fire(new r.A("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o}_setTileReloadTimer(t,o){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);let h=o.getExpiryTimeout();h&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},h))}_removeTile(t){let o=this._tiles[t];o&&(o.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),o.uses>0||(o.hasData()&&o.state!=="reloading"||o.state==="empty"?this._cache.add(o.tileID,o,o.getExpiryTimeout()):(o.aborted=!0,this._abortTile(o),this._unloadTile(o))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,o,h){let g=[],_=this.transform;if(!_)return g;let v=_.projection.name==="globe",E=r.aD(_.center.lng);for(let T in this._tiles){let C=this._tiles[T];if(h&&C.clearQueryDebugViz(),C.holdingForFade())continue;let A;if(v){let L=C.tileID.canonical;if(L.z===0){let R=[Math.abs(r.ay(E,...ql(L,-1))-E),Math.abs(r.ay(E,...ql(L,1))-E)];A=[0,2*R.indexOf(Math.min(...R))-1]}else{let R=[Math.abs(r.ay(E,...ql(L,-1))-E),Math.abs(r.ay(E,...ql(L,0))-E),Math.abs(r.ay(E,...ql(L,1))-E)];A=[R.indexOf(Math.min(...R))-1]}}else A=[0];for(let L of A){let R=t.containsTile(C,_,o,L);R&&g.push(R)}}return g}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,o){let h=this.getRenderableIds(t,o).map(_=>this._tiles[_].tileID),g=this.transform.projection.name==="globe";for(let _ of h)_.projMatrix=this.transform.calculateProjMatrix(_.toUnwrapped()),_.expandedProjMatrix=g?this.transform.calculateProjMatrix(_.toUnwrapped(),!1,!0):_.projMatrix;return h}sortCoordinatesByDistance(t){let o=t.slice(),h=this.transform._camera.position,g=this.transform._camera.forward(),_={};for(let v of o){let E=1/(1<<v.canonical.z);_[v.key]=((v.canonical.x+.5)*E+v.wrap-h[0])*g[0]+((v.canonical.y+.5)*E-h[1])*g[1]-h[2]*g[2]}return o.sort((v,E)=>_[v.key]-_[E.key]),o}hasTransition(){if(this._source.hasTransition())return!0;if(bu(this._source.type))for(let t in this._tiles){let o=this._tiles[t];if(o.fadeEndTime!==void 0&&o.fadeEndTime>=r.q.now())return!0}return!1}setFeatureState(t,o,h){this._state.updateState(t=t||"_geojsonTileLayer",o,h)}removeFeatureState(t,o,h){this._state.removeFeatureState(t=t||"_geojsonTileLayer",o,h)}getFeatureState(t,o){return this._state.getState(t=t||"_geojsonTileLayer",o)}setDependencies(t,o,h){let g=this._tiles[t];g&&g.setDependencies(o,h)}reloadTilesForDependencies(t,o){for(let h in this._tiles)this._tiles[h].hasDependency(t,o)&&this._reloadTile(+h,"reloading");this._cache.filter(h=>!h.hasDependency(t,o))}_preloadTiles(t,o){if(!this._sourceLoaded){let T=()=>{this._sourceLoaded&&(this._source.off("data",T),this._preloadTiles(t,o))};return void this._source.on("data",T)}let h=new Map,g=Array.isArray(t)?t:[t],_=this.map.painter.terrain,v=this.usedForTerrain&&_?_.getScaledDemTileSize():this._source.tileSize;for(let T of g){let C=T.coveringTiles({tileSize:v,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let A of C)h.set(A.key,A);this.usedForTerrain&&T.updateElevation(!1)}let E=Array.from(h.values());r.bt(E,(T,C)=>{let A=new tl(T,this._source.tileSize*T.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(A,L=>{this._source.type==="raster-dem"&&A.dem&&this._backfillDEM(A),C(L,A)})},o)}}function nl(d,t){let o=Math.abs(2*d.wrap)-+(d.wrap<0),h=Math.abs(2*t.wrap)-+(t.wrap<0);return d.overscaledZ-t.overscaledZ||h-o||t.canonical.y-d.canonical.y||t.canonical.x-d.canonical.x}function bu(d){return d==="raster"||d==="image"||d==="video"||d==="custom"}function ql(d,t){let o=1<<d.z;return[d.x/o+t,(d.x+1)/o+t]}eo.maxOverzooming=10,eo.maxUnderzooming=3;class H_{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let t=!1,o=!1;for(let h in this.style._mergedLayers){let g=this.style._mergedLayers[h];if(g.type==="fill-extrusion"||g.type==="building")this.layers.push({layer:g,visible:t,visibilityChanged:o});else if(g.type==="model"){let _=this.style.getLayerSource(g);_&&_.type==="batched-model"&&this.layers.push({layer:g,visible:t,visibilityChanged:o})}}}onNewFrame(t){this.layersGotHidden=!1;for(let o of this.layers){let h=o.layer,g=!1;h.type==="fill-extrusion"?g=!h.isHidden(t)&&h.paint.get("fill-extrusion-opacity")>0:h.type==="building"?g=!h.isHidden(t)&&h.paint.get("building-opacity")>0:h.type==="model"&&(g=!h.isHidden(t)&&h.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!g&&o.visible,o.visible=g}}updateZOffset(t,o){this.currentBuildingBuckets=[];for(let g of this.layers){let _=g.layer,v=this.style.getLayerSourceCache(_),E=1;_.type==="fill-extrusion"?E=g.visible?_.paint.get("fill-extrusion-vertical-scale"):0:_.type==="building"&&(E=g.visible?_.paint.get("building-vertical-scale"):0);let T=v?v.getTile(o):null;if(!T&&v)for(let C in v._tiles){let A=v._tiles[C];if(o.canonical.isChildOf(A.tileID.canonical)){T=A;break}}this.currentBuildingBuckets.push({bucket:T?T.getBucket(_):null,tileID:T?T.tileID:o,verticalScale:E})}t.hasAnyZOffset=!1;let h=!1;for(let g=0;g<t.symbolInstances.length;g++){let _=t.symbolInstances.get(g),v=_.zOffset,E=this._getHeightAtTileOffset(o,_.tileAnchorX,_.tileAnchorY);_.zOffset=E!==Number.NEGATIVE_INFINITY?E:v,h||v===_.zOffset||(h=!0),t.hasAnyZOffset||_.zOffset===0||(t.hasAnyZOffset=!0)}h&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,o,h,g){let _=o,v=h;if(t.canonical.z!==g.canonical.z){let E=g.canonical,T=1/(1<<t.canonical.z-E.z);_=(o+t.canonical.x*r.aj)*T-E.x*r.aj|0,v=(h+t.canonical.y*r.aj)*T-E.y*r.aj|0}return{tileX:_,tileY:v}}_getHeightAtTileOffset(t,o,h){let g,_;for(let v=0;v<this.layers.length;++v){let E=this.layers[v].layer;if(E.type!=="fill-extrusion"&&E.type!=="building")continue;let{bucket:T,tileID:C,verticalScale:A}=this.currentBuildingBuckets[v];if(!T)continue;let{tileX:L,tileY:R}=this._mapCoordToOverlappingTile(t,o,h,C),F=T.getHeightAtTileCoord(L,R);F&&F.height!==void 0&&(F.hidden?g=F.height:_=Math.max(F.height*A,_||0))}if(_!==void 0)return _;for(let v=0;v<this.layers.length;++v){let E=this.layers[v];if(E.layer.type!=="model"||!E.visible)continue;let{bucket:T,tileID:C}=this.currentBuildingBuckets[v];if(!T)continue;let{tileX:A,tileY:L}=this._mapCoordToOverlappingTile(t,o,h,C),R=T.getHeightAtTileCoord(A,L);if(R&&!R.hidden)return R.height===void 0&&g!==void 0?Math.min(R.maxHeight,g)*R.verticalScale:R.height?R.height*R.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function G_(d,t){let o={};for(let h in d)h!=="ref"&&(o[h]=d[h]);return r.bu.forEach(h=>{h in t&&(o[h]=t[h])}),o}function wu(d){d=d.slice();let t=Object.create(null);for(let o=0;o<d.length;o++)t[d[o].id]=d[o];for(let o=0;o<d.length;o++)"ref"in d[o]&&(d[o]=G_(d[o],t[d[o].ref]));return d}let xn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Qd(d,t,o){o.push({command:xn.addSource,args:[d,t[d]]})}function Xl(d,t,o){t.push({command:xn.removeSource,args:[d]}),o[d]=!0}function Eu(d,t,o,h){Xl(d,o,h),Qd(d,t,o)}function Ib(d,t,o){let h;for(h in d[o])if(d[o].hasOwnProperty(h)&&h!=="data"&&!r.bv(d[o][h],t[o][h]))return!1;for(h in t[o])if(t[o].hasOwnProperty(h)&&h!=="data"&&!r.bv(d[o][h],t[o][h]))return!1;return!0}function Tu(d,t,o,h,g,_){let v;for(v in t=t||{},d=d||{})d.hasOwnProperty(v)&&(r.bv(d[v],t[v])||o.push({command:_,args:[h,v,t[v],g]}));for(v in t)t.hasOwnProperty(v)&&!d.hasOwnProperty(v)&&(r.bv(d[v],t[v])||o.push({command:_,args:[h,v,t[v],g]}))}function rl(d){return d.id}function _a(d,t){return d[t.id]=t,d}function Iu(d,t,o){let h=t.createTileMatrix(d,d.worldSize,o.toUnwrapped());return r.az(new Float32Array(16),d.projMatrix,h)}function $_(d,t,o){if(t.projection.name===o.projection.name)return d.projMatrix;let h=o.clone();return h.setProjection(t.projection),Iu(h,t.getProjection(),d)}function eh(d,t,o){return t.name===o.projection.name?d.projMatrix:Iu(o,t,d)}class W_{constructor(t,o){this.reset(t,o)}reset(t,o){this.points=t||[],this._distances=[0];for(let h=1;h<this.points.length;h++)this._distances[h]=this._distances[h-1]+this.points[h].dist(this.points[h-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(o||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=r.ay(t,0,1);let o=1,h=this._distances[o],g=t*this.paddedLength+this.padding;for(;h<g&&o<this._distances.length;)h=this._distances[++o];let _=o-1,v=this._distances[_],E=h-v,T=E>0?(g-v)/E:0;return this.points[_].mult(1-T).add(this.points[o].mult(T))}}class Yl{constructor(t,o,h){let g=this.boxCells=[],_=this.circleCells=[];this.xCellCount=Math.ceil(t/h),this.yCellCount=Math.ceil(o/h);for(let v=0;v<this.xCellCount*this.yCellCount;v++)g.push([]),_.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=o,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/o,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,o,h,g,_){this._forEachCell(o,h,g,_,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(o),this.bboxes.push(h),this.bboxes.push(g),this.bboxes.push(_)}insertCircle(t,o,h,g){this._forEachCell(o-g,h-g,o+g,h+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(o),this.circles.push(h),this.circles.push(g)}_insertBoxCell(t,o,h,g,_,v){this.boxCells[_].push(v)}_insertCircleCell(t,o,h,g,_,v){this.circleCells[_].push(v)}_query(t,o,h,g,_,v){if(h<0||t>this.width||g<0||o>this.height)return!_&&[];let E=[];if(t<=0&&o<=0&&this.width<=h&&this.height<=g){if(_)return!0;for(let T=0;T<this.boxKeys.length;T++)E.push({key:this.boxKeys[T],x1:this.bboxes[4*T],y1:this.bboxes[4*T+1],x2:this.bboxes[4*T+2],y2:this.bboxes[4*T+3]});for(let T=0;T<this.circleKeys.length;T++){let C=this.circles[3*T],A=this.circles[3*T+1],L=this.circles[3*T+2];E.push({key:this.circleKeys[T],x1:C-L,y1:A-L,x2:C+L,y2:A+L})}return v?E.filter(v):E}return this._forEachCell(t,o,h,g,this._queryCell,E,{hitTest:_,seenUids:{box:{},circle:{}}},v),_?E.length>0:E}_queryCircle(t,o,h,g,_){let v=t-h,E=t+h,T=o-h,C=o+h;if(E<0||v>this.width||C<0||T>this.height)return!g&&[];let A=[];return this._forEachCell(v,T,E,C,this._queryCellCircle,A,{hitTest:g,circle:{x:t,y:o,radius:h},seenUids:{box:{},circle:{}}},_),g?A.length>0:A}query(t,o,h,g,_){return this._query(t,o,h,g,!1,_)}hitTest(t,o,h,g,_){return this._query(t,o,h,g,!0,_)}hitTestCircle(t,o,h,g){return this._queryCircle(t,o,h,!0,g)}_queryCell(t,o,h,g,_,v,E,T){let C=E.seenUids,A=this.boxCells[_];if(A!==null){let R=this.bboxes;for(let F of A)if(!C.box[F]){C.box[F]=!0;let V=4*F;if(t<=R[V+2]&&o<=R[V+3]&&h>=R[V+0]&&g>=R[V+1]&&(!T||T(this.boxKeys[F]))){if(E.hitTest)return v.push(!0),!0;v.push({key:this.boxKeys[F],x1:R[V],y1:R[V+1],x2:R[V+2],y2:R[V+3]})}}}let L=this.circleCells[_];if(L!==null){let R=this.circles;for(let F of L)if(!C.circle[F]){C.circle[F]=!0;let V=3*F;if(this._circleAndRectCollide(R[V],R[V+1],R[V+2],t,o,h,g)&&(!T||T(this.circleKeys[F]))){if(E.hitTest)return v.push(!0),!0;{let z=R[V],H=R[V+1],j=R[V+2];v.push({key:this.circleKeys[F],x1:z-j,y1:H-j,x2:z+j,y2:H+j})}}}}}_queryCellCircle(t,o,h,g,_,v,E,T){let C=E.circle,A=E.seenUids,L=this.boxCells[_];if(L!==null){let F=this.bboxes;for(let V of L)if(!A.box[V]){A.box[V]=!0;let z=4*V;if(this._circleAndRectCollide(C.x,C.y,C.radius,F[z+0],F[z+1],F[z+2],F[z+3])&&(!T||T(this.boxKeys[V])))return v.push(!0),!0}}let R=this.circleCells[_];if(R!==null){let F=this.circles;for(let V of R)if(!A.circle[V]){A.circle[V]=!0;let z=3*V;if(this._circlesCollide(F[z],F[z+1],F[z+2],C.x,C.y,C.radius)&&(!T||T(this.circleKeys[V])))return v.push(!0),!0}}}_forEachCell(t,o,h,g,_,v,E,T){let C=this._convertToXCellCoord(t),A=this._convertToYCellCoord(o),L=this._convertToXCellCoord(h),R=this._convertToYCellCoord(g);for(let F=C;F<=L;F++)for(let V=A;V<=R;V++)if(_.call(this,t,o,h,g,this.xCellCount*V+F,v,E,T))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,o,h,g,_,v){let E=g-t,T=_-o,C=h+v;return C*C>E*E+T*T}_circleAndRectCollide(t,o,h,g,_,v,E){let T=(v-g)/2,C=Math.abs(t-(g+T));if(C>T+h)return!1;let A=(E-_)/2,L=Math.abs(o-(_+A));if(L>A+h)return!1;if(C<=T||L<=A)return!0;let R=C-T,F=L-A;return R*R+F*F<=h*h}}let il={unknown:0,flipRequired:1,flipNotRequired:2},Z_=Math.tan(85*Math.PI/180);function Su(d,t,o,h,g,_,v){let E=r.bz();if(o)if(_.name==="globe"){let T=r.bA(g,t);r.az(E,E,T)}else{let T=r.bB([],v);E[0]=T[0],E[1]=T[1],E[4]=T[2],E[5]=T[3],h||r.by(E,E,g.angle)}else r.az(E,g.labelPlaneMatrix,d);return E}function Kl(d,t,o,h,g,_,v){let E=Su(d,t,o,h,g,_,v);return _.name==="globe"&&o||(E[2]=E[6]=E[10]=E[14]=0),E}function js(d,t,o,h,g,_,v){if(o){if(_.name==="globe"){let E=Su(d,t,o,h,g,_,v);return r.bi(E,E),r.az(E,d,E),E}{let E=r.bw(d),T=r.bx([]);return T[0]=v[0],T[1]=v[1],T[4]=v[2],T[5]=v[3],r.az(E,E,T),h||r.by(E,E,-g.angle),E}}return g.glCoordMatrix}function Co(d,t,o,h){let g=[d,t,o,1];o?r.aA(g,g,h):q_(g,g,h);let _=g[3];return g[0]/=_,g[1]/=_,g[2]/=_,g}function Tp(d,t){return Math.min(.5+d/t*.5,1.5)}function Ip(d,t){let o=d[0]/d[3],h=d[1]/d[3];return o>=-t[0]&&o<=t[0]&&h>=-t[1]&&h<=t[1]}function ol(d,t,o,h,g,_,v,E,T,C){let A=o.transform,L=h?d.textSizeData:d.iconSizeData,R=r.bH(L,o.transform.zoom),F=A.projection.name==="globe",V=[256/o.width*2+1,256/o.height*2+1],z=h?d.text.dynamicLayoutVertexArray:d.icon.dynamicLayoutVertexArray;z.clear();let H=null;F&&(H=h?d.text.globeExtVertexArray:d.icon.globeExtVertexArray);let j=d.lineVertexArray,Z=h?d.text.placedSymbolArray:d.icon.placedSymbolArray,Y=o.transform.width/o.transform.height,J,re=!1;for(let ce=0;ce<Z.length;ce++){let de=Z.get(ce),{numGlyphs:ie,writingMode:oe}=de;if(oe!==r.bI.vertical||re||J===r.bI.horizontal||(re=!0),J=oe,(de.hidden||oe===r.bI.vertical)&&!re){Jl(ie,z);continue}re=!1;let se=new r.P(de.tileAnchorX,de.tileAnchorY),{x:Te,y:me,z:Ne}=A.projection.projectTilePoint(se.x,se.y,C.canonical);if(T){let[bt,St,ft]=T(se);Te+=bt,me+=St,Ne+=ft}let Ae=[Te,me,Ne,1];if(r.aA(Ae,Ae,t),!Ip(Ae,V)){Jl(ie,z);continue}let Ve=Ae[3],Qe=Tp(o.transform.getCameraToCenterDistance(A.projection),Ve),Ie=r.bJ(L,R,de),pe=v?Ie/Qe:Ie*Qe,Pe=Co(Te,me,Ne,g);if(Pe[3]<=0){Jl(ie,z);continue}let Se={},He=r.al(d.layers[0].layout.get("text-max-angle")),Ge=Math.cos(He),We=v?null:T,ot=th(de,pe,!1,E,t,g,_,d.glyphOffsetArray,j,z,H,Pe,se,Se,Y,We,A.projection,C,v,Ge);re=ot.useVertical,We&&ot.needsFlipping&&(Se={}),(ot.notEnoughRoom||re||ot.needsFlipping&&th(de,pe,!0,E,t,g,_,d.glyphOffsetArray,j,z,H,Pe,se,Se,Y,We,A.projection,C,v,Ge).notEnoughRoom)&&Jl(ie,z)}h?(d.text.dynamicLayoutVertexBuffer.updateData(z),H&&d.text.globeExtVertexBuffer&&d.text.globeExtVertexBuffer.updateData(H)):(d.icon.dynamicLayoutVertexBuffer.updateData(z),H&&d.icon.globeExtVertexBuffer&&d.icon.globeExtVertexBuffer.updateData(H))}function fo(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H){let{lineStartIndex:j,glyphStartIndex:Z,segment:Y}=E,J=Z+E.numGlyphs,re=j+E.lineLength,ce=t.getoffsetX(Z),de=t.getoffsetX(J-1),ie=Du(d*ce,o,h,g,_,v,Y,j,re,T,C,A,L,R,!0,F,V,z,H);if(!ie)return null;let oe=Du(d*de,o,h,g,_,v,Y,j,re,T,C,A,L,R,!0,F,V,z,H);return oe?{first:ie,last:oe}:null}function Sp(d,t,o,h){return d===r.bI.horizontal&&Math.abs(h)>Math.abs(o)?{useVertical:!0}:d===r.bI.vertical?h>0?{needsFlipping:!0}:null:t!==il.unknown&&function(g,_){return g===0||Math.abs(_/g)>Z_}(o,h)?t===il.flipRequired?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function th(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j,Z,Y){let J=t/24,re=d.lineOffsetX*J,ce=d.lineOffsetY*J,{lineStartIndex:de,glyphStartIndex:ie,numGlyphs:oe,segment:se,writingMode:Te,flipState:me}=d,Ne=de+d.lineLength,Ae=Ve=>{if(A){let[Pe,Se,He]=Ve.up,Ge=C.length;r.bK(A,Ge+0,Pe,Se,He),r.bK(A,Ge+1,Pe,Se,He),r.bK(A,Ge+2,Pe,Se,He),r.bK(A,Ge+3,Pe,Se,He)}let[Qe,Ie,pe]=Ve.point;r.bL(C,Qe,Ie,pe,Ve.angle)};if(oe>1){let Ve=fo(J,E,re,ce,o,L,R,d,T,_,F,z,!1,H,j,Z,Y);if(!Ve)return{notEnoughRoom:!0};if(h&&!o){let[Qe,Ie,pe]=Ve.first.point,[Pe,Se,He]=Ve.last.point;[Qe,Ie]=Co(Qe,Ie,pe,v),[Pe,Se]=Co(Pe,Se,He,v);let Ge=Sp(Te,me,(Pe-Qe)*V,Se-Ie);if(d.flipState=Ge&&Ge.needsFlipping?il.flipRequired:il.flipNotRequired,Ge)return Ge}Ae(Ve.first);for(let Qe=ie+1;Qe<ie+oe-1;Qe++){let Ie=Du(J*E.getoffsetX(Qe),re,ce,o,L,R,se,de,Ne,T,_,F,z,!1,!1,H,j,Z,Y);if(!Ie)return C.length-=4*(Qe-ie),{notEnoughRoom:!0};Ae(Ie)}Ae(Ve.last)}else{if(h&&!o){let Qe=Co(R.x,R.y,0,g),Ie=de+se+1,pe=new r.P(T.getx(Ie),T.gety(Ie)),Pe=Co(pe.x,pe.y,0,g),Se=Pe[3]>0?Pe:Ln(R,pe,Qe,1,g,void 0,H,j.canonical),He=Sp(Te,me,(Se[0]-Qe[0])*V,Se[1]-Qe[1]);if(d.flipState=He&&He.needsFlipping?il.flipRequired:il.flipNotRequired,He)return He}let Ve=Du(J*E.getoffsetX(ie),re,ce,o,L,R,se,de,Ne,T,_,F,z,!1,!1,H,j,Z,Y);if(!Ve)return{notEnoughRoom:!0};Ae(Ve)}return{}}function Dp(d,t,o,h,g){let{x:_,y:v,z:E}=h.projectTilePoint(d.x,d.y,t);if(!g)return Co(_,v,E,o);let[T,C,A]=g(d);return Co(_+T,v+C,E+A,o)}function Ln(d,t,o,h,g,_,v,E){let T=Dp(d.sub(t)._unit()._add(d),E,g,v,_);return r.at(T,o,T),r.au(T,T),r.bE(T,o,T,h)}function Du(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j,Z){let Y=h?d-t:d+t,J=Y>0?1:-1,re=0;h&&(J*=-1,re=Math.PI),J<0&&(re+=Math.PI);let ce=E+v+(J>0?0:1)|0,de=g,ie=g,oe=0,se=0,Te=Math.abs(Y),me=[],Ne=[],Ae=_,Ve=Ae,Qe=r.bC([]),Ie=()=>Ln(Ve,Ae,ie,Te-oe+1,A,R,z,H.canonical);for(;oe+se<=Te;){if(ce+=J,ce<E||ce>=T)return null;if(ie=de,Ve=Ae,me.push(ie),F&&Ne.push(Ve),Ae=new r.P(C.getx(ce),C.gety(ce)),de=L[ce],!de){let ft=Dp(Ae,H.canonical,A,z,R);de=ft[3]>0?L[ce]=ft:Ie()}oe+=se;let bt=r.at([],de,ie),St=r.bD(ie,de);if(o&&St>0&&se>0&&r.bG(Qe,bt)/(se*St)<Z)return null;se=St,Qe=bt}V&&R&&(L[ce]&&(de=Ie(),se=r.bD(ie,de),Qe=r.at([],de,ie)),L[ce]=de);let pe=(Te-oe)/se,Pe=Ae.sub(Ve)._mult(pe)._add(Ve),Se=r.bE([],ie,Qe,pe),He=[0,0,1],Ge=Qe[0],We=Qe[1];if(j&&(He=z.upVector(H.canonical,Pe.x,Pe.y),He[0]!==0||He[1]!==0||He[2]!==1)){let bt=[He[2],0,-He[0]],St=r.bF([],He,bt);r.au(bt,bt),r.au(St,St),Ge=r.bG(Qe,bt),We=r.bG(Qe,St)}if(o){let bt=r.bF([],He,Qe);r.au(bt,bt),r.bE(Se,Se,bt,o*J)}let ot=re+Math.atan2(We,Ge);return me.push(Se),F&&Ne.push(Pe),{point:Se,angle:ot,path:me,tilePath:Ne,up:He}}function Jl(d,t){let o=t.length,h=o+4*d;t.resize(h),t.float32.fill(-1/0,4*o,4*h)}function q_(d,t,o){let h=t[0],g=t[1];return d[0]=o[0]*h+o[4]*g+o[12],d[1]=o[1]*h+o[5]*g+o[13],d[3]=o[3]*h+o[7]*g+o[15],d}let At=100;class X_{constructor(t,o,h=new Yl(t.width+200,t.height+200,25),g=new Yl(t.width+200,t.height+200,25)){this.transform=t,this.grid=h,this.ignoredGrid=g,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+At,this.screenBottomBoundary=t.height+At,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=o}placeCollisionBox(t,o,h,g,_,v,E,T,C,A,L){let R=h.projectedAnchorX,F=h.projectedAnchorY,V=h.projectedAnchorZ,z=h.tileAnchorX,H=h.tileAnchorY,j=h.elevation,Z=h.tileID,Y=t.getProjection();if(j&&Z){let[Ne,Ae,Ve]=Y.upVector(Z.canonical,h.tileAnchorX,h.tileAnchorY),Qe=Y.upVectorScale(Z.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;R+=Ne*j*Qe,F+=Ae*j*Qe,V+=Ve*j*Qe}let J=t.projection.name==="globe",re=t.projection.name==="globe"?r.ah(this.transform.zoom):0;if(Z&&J&&re<1&&!v){let Ne=1<<Z.canonical.z,Ae=r.bM(z,H);r.bN(Ae,Ae,1/r.aj),r.bO(Ae,Ae,r.bM(Z.canonical.x,Z.canonical.y)),r.bN(Ae,Ae,1/Ne),r.bP(Ae,Ae,r.bM(g[0],g[1])),Ae[0]=r.bQ(Ae[0],-.5,.5),r.bN(Ae,Ae,r.aj);let Ve=r.bR(Ae[0],Ae[1],r.aj/(2*Math.PI),1);r.aA(Ve,Ve,_),R=r.ai(R,Ve[0],re),F=r.ai(F,Ve[1],re),V=r.ai(V,Ve[2],re)}let ce=this.projectAndGetPerspectiveRatio(A,R,F,V,h.tileID,Y.name==="globe"||!!j||this.transform.pitch>0,Y),de=C*ce.perspectiveRatio,ie=(h.x1*o+E.x-h.padding)*de+ce.point.x,oe=(h.y1*o+E.y-h.padding)*de+ce.point.y,se=(h.x2*o+E.x+h.padding)*de+ce.point.x,Te=(h.y2*o+E.y+h.padding)*de+ce.point.y,me=ce.perspectiveRatio<=.55||ce.occluded;return!this.isInsideGrid(ie,oe,se,Te)||!T&&this.grid.hitTest(ie,oe,se,Te,L)||me?{box:[],offscreen:!1,occluded:ce.occluded}:{box:[ie,oe,se,Te],offscreen:this.isOffscreen(ie,oe,se,Te),occluded:!1}}placeCollisionCircles(t,o,h,g,_,v,E,T,C,A,L,R,F,V,z){let H=[],j=this.transform.elevation,Z=t.getProjection(),Y=j?j.getAtTileOffsetFunc(z,this.transform.center.lat,this.transform.worldSize,Z):null,J=new r.P(h.tileAnchorX,h.tileAnchorY),{x:re,y:ce,z:de}=Z.projectTilePoint(J.x,J.y,z.canonical);if(Y){let[He,Ge,We]=Y(J);re+=He,ce+=Ge,de+=We}let ie=Z.name==="globe",oe=this.projectAndGetPerspectiveRatio(E,re,ce,de,z,ie||!!j||this.transform.pitch>0,Z),{perspectiveRatio:se}=oe,Te=(L?v/se:v*se)/r.bU,me=Co(re,ce,de,T),Ne=h.lineOffsetX*Te,Ae=h.lineOffsetY*Te,Ve=r.al(t.layers[0].layout.get("text-max-angle")),Qe=Math.cos(Ve),Ie=oe.signedDistanceFromCamera>0?fo(Te,_,Ne,Ae,!1,me,J,h,g,T,{},j&&!L?Y:null,L&&!!j,Z,z,L,Qe):null,pe=!1,Pe=!1,Se=!0;if(Ie&&!oe.occluded){let He=.5*F*se+V,Ge=new r.P(-100,-100),We=new r.P(this.screenRightBoundary,this.screenBottomBoundary),ot=new W_,{first:bt,last:St}=Ie,ft=bt.path.length,Tt=[];for(let Wt=ft-1;Wt>=1;Wt--)Tt.push(bt.path[Wt]);for(let Wt=1;Wt<St.path.length;Wt++)Tt.push(St.path[Wt]);let wt=2.5*He;C&&(Tt=Tt.map(([Wt,on,bn],Ht)=>(Y&&!ie&&(bn=Y(Ht<ft-1?bt.tilePath[ft-1-Ht]:St.tilePath[Ht-ft+2])[2]),Co(Wt,on,bn,C))),Tt.some(Wt=>Wt[3]<=0)&&(Tt=[]));let zt=[];if(Tt.length>0){let Wt=1/0,on=-1/0,bn=1/0,Ht=-1/0;for(let wn of Tt)Wt=Math.min(Wt,wn[0]),bn=Math.min(bn,wn[1]),on=Math.max(on,wn[0]),Ht=Math.max(Ht,wn[1]);on>=Ge.x&&Wt<=We.x&&Ht>=Ge.y&&bn<=We.y&&(zt=[Tt.map(wn=>new r.P(wn[0],wn[1]))],(Wt<Ge.x||on>We.x||bn<Ge.y||Ht>We.y)&&(zt=r.bS(zt,Ge.x,Ge.y,We.x,We.y)))}for(let Wt of zt){ot.reset(Wt,.25*He);let on=0;on=ot.length<=.5*He?1:Math.ceil(ot.paddedLength/wt)+1;for(let bn=0;bn<on;bn++){let Ht=bn/Math.max(on-1,1),wn=ot.lerp(Ht),Dn=wn.x+At,Xn=wn.y+At;H.push(Dn,Xn,He,0);let tn=Dn-He,En=Xn-He,Tn=Dn+He,Mn=Xn+He;if(Se=Se&&this.isOffscreen(tn,En,Tn,Mn),Pe=Pe||this.isInsideGrid(tn,En,Tn,Mn),!o&&this.grid.hitTestCircle(Dn,Xn,He,R)&&(pe=!0,!A))return{circles:[],offscreen:!1,collisionDetected:pe,occluded:!1}}}}return{circles:!A&&pe||!Pe?[]:H,offscreen:Se,collisionDetected:pe,occluded:oe.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let o=[],h=1/0,g=1/0,_=-1/0,v=-1/0;for(let A of t){let L=new r.P(A.x+At,A.y+At);h=Math.min(h,L.x),g=Math.min(g,L.y),_=Math.max(_,L.x),v=Math.max(v,L.y),o.push(L)}let E=this.grid.query(h,g,_,v).concat(this.ignoredGrid.query(h,g,_,v)),T={},C={};for(let A of E){let L=A.key;if(T[L.bucketInstanceId]===void 0&&(T[L.bucketInstanceId]={}),T[L.bucketInstanceId][L.featureIndex])continue;let R=[new r.P(A.x1,A.y1),new r.P(A.x2,A.y1),new r.P(A.x2,A.y2),new r.P(A.x1,A.y2)];r.bT(o,R)&&(T[L.bucketInstanceId][L.featureIndex]=!0,C[L.bucketInstanceId]===void 0&&(C[L.bucketInstanceId]=[]),C[L.bucketInstanceId].push(L.featureIndex))}return C}insertCollisionBox(t,o,h,g,_){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:h,featureIndex:g,collisionGroupID:_},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,o,h,g,_){let v=o?this.ignoredGrid:this.grid,E={bucketInstanceId:h,featureIndex:g,collisionGroupID:_};for(let T=0;T<t.length;T+=4)v.insertCircle(E,t[T],t[T+1],t[T+2])}projectAndGetPerspectiveRatio(t,o,h,g,_,v,E){let T=[o,h,g,1],C=!1;g||this.transform.pitch>0?(r.aA(T,T,t),this.fogState&&_&&E.name!=="globe"&&(C=function(R,F,V,z,H,j){let Z=j.calculateFogTileMatrix(H),Y=[F,V,z];return r.ad(Y,Y,Z),Dt(R,r.ae(Y),j.pitch,j._fov)}(this.fogState,o,h,g,_.toUnwrapped(),this.transform)>.9)):q_(T,T,t);let A=T[3];return{point:new r.P((T[0]/A+1)/2*this.transform.width+At,(-T[1]/A+1)/2*this.transform.height+At),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(E)/A*.5,1.5),signedDistanceFromCamera:A,occluded:v&&T[2]>A||C}}isOffscreen(t,o,h,g){return h<At||t>=this.screenRightBoundary||g<At||o>this.screenBottomBoundary}isInsideGrid(t,o,h,g){return h>=0&&t<this.gridRightBoundary&&g>=0&&o<this.gridBottomBoundary}getViewportMatrix(){let t=r.bx([]);return r.bo(t,t,[-100,-100,0]),t}}class Cu{constructor(t,o,h,g){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?o:-o))):g&&h?1:0,this.placed=h}isHidden(){return this.opacity===0&&!this.placed}}class sl{constructor(t,o,h,g,_,v=!1){this.text=new Cu(t?t.text:null,o,h,_),this.icon=new Cu(t?t.icon:null,o,g,_),this.clipped=v}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Ao{constructor(t,o,h,g=!1){this.text=t,this.icon=o,this.skipFade=h,this.clipped=g}}class Cp{constructor(){this.invProjMatrix=r.bz(),this.viewportMatrix=r.bz(),this.circles=[]}}class Ql{constructor(t,o,h,g,_){this.bucketInstanceId=t,this.featureIndex=o,this.sourceLayerIndex=h,this.bucketIndex=g,this.tileID=_}}class It{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){let o=++this.maxGroupID;this.collisionGroups[t]={ID:o,predicate:h=>h.collisionGroupID===o}}return this.collisionGroups[t]}}function Pn(d,t,o,h,g){let{horizontalAlign:_,verticalAlign:v}=r.bZ(d),E=-(_-.5)*t,T=-(v-.5)*o,C=r.b_(d,h);return new r.P(E+C[0]*g,T+C[1]*g)}function On(d,t,o,h,g){let _=new r.P(d,t);return o&&_._rotate(h?g:-g),_}class po{constructor(t,o,h,g,_,v){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new X_(this.transform,_),this.buildingIndex=v,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new It(h),this.collisionCircleArrays={},this.prevPlacement=g,g&&(g.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,o,h,g,_=1){let v=h.getBucket(o),E=h.latestFeatureIndex;if(!v||!E||o.fqid!==v.layerIds[0])return;let T=v.layers[0].layout,C=v.layers[0].paint,A=h.collisionBoxArray,L=Math.pow(2,this.transform.zoom-h.tileID.overscaledZ),R=h.tileSize/r.aj,F=h.tileID.toUnwrapped();this.transform.setProjection(v.projection);let V=(z=h.tileID,H=v.getProjection(),j=this.transform,H.name===this.projection?j.calculateProjMatrix(z.toUnwrapped()):Iu(j,H,z));var z,H,j;let Z=T.get("text-pitch-alignment")==="map",Y=T.get("text-rotation-alignment")==="map";o.compileFilter(o.options);let J=o.dynamicFilter(),re=o.dynamicFilterNeedsFeature(),ce=this.transform.calculatePixelsToTileUnitsMatrix(h),de=Kl(V,h.tileID.canonical,Z,Y,this.transform,v.getProjection(),ce),ie=null,oe=v.getProjection().createInversionMatrix(this.transform,h.tileID.canonical);if(Z){let pe=js(V,h.tileID.canonical,Z,Y,this.transform,v.getProjection(),ce);ie=r.az([],this.transform.labelPlaneMatrix,pe)}let se=null;J&&h.latestFeatureIndex&&(se={unwrappedTileID:F,dynamicFilter:J,dynamicFilterNeedsFeature:re}),this.retainedQueryData[v.bucketInstanceId]=new Ql(v.bucketInstanceId,E,v.sourceLayerIndex,v.index,h.tileID);let[Te,me]=v.layers[0].layout.get("text-size-scale-range"),Ne=r.ay(_,Te,me),[Ae,Ve]=T.get("icon-size-scale-range"),Qe=r.ay(_,Ae,Ve),Ie={bucket:v,layout:T,paint:C,posMatrix:V,invMatrix:oe,mercatorCenter:[r.aD(this.transform.center.lng),r.aH(this.transform.center.lat)],textLabelPlaneMatrix:de,labelToScreenMatrix:ie,clippingData:se,scale:L,textPixelRatio:R,holdingForFade:h.holdingForFade(),collisionBoxArray:A,partiallyEvaluatedTextSize:r.bH(v.textSizeData,this.transform.zoom,Ne),partiallyEvaluatedIconSize:r.bH(v.iconSizeData,this.transform.zoom,Qe),collisionGroup:this.collisionGroups.get(v.sourceID),latestFeatureIndex:h.latestFeatureIndex};if(g)for(let pe of v.sortKeyRanges){let{sortKey:Pe,symbolInstanceStart:Se,symbolInstanceEnd:He}=pe;t.push({sortKey:Pe,symbolInstanceStart:Se,symbolInstanceEnd:He,parameters:Ie})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:v.symbolInstances.length,parameters:Ie})}attemptAnchorPlacement(t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j,Z,Y,J,re){let{textOffset0:ce,textOffset1:de,crossTileID:ie}=z,oe=[ce,de],se=Pn(t,v,E,oe,T),Te=this.collisionIndex.placeCollisionBox(j,T,o,h,g,_,On(se.x,se.y,C,A,this.transform.angle),V,L,R,F.predicate);if(Y){let me=j.getSymbolInstanceIconSize(re,this.transform.zoom,z.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(j,me,Y,h,g,_,On(se.x,se.y,C,A,this.transform.angle),V,L,R,F.predicate).box.length===0)return}if(Te.box.length>0){let me;return this.prevPlacement&&this.prevPlacement.variableOffsets[ie]&&this.prevPlacement.placements[ie]&&this.prevPlacement.placements[ie].text&&(me=this.prevPlacement.variableOffsets[ie].anchor),this.variableOffsets[ie]={textOffset:oe,width:v,height:E,anchor:t,textScale:T,prevAnchor:me},this.markUsedJustification(j,t,z,Z),j.allowVerticalPlacement&&(this.markUsedOrientation(j,Z,z),this.placedOrientations[ie]=Z),{shift:se,placedGlyphBoxes:Te}}}placeLayerBucketPart(t,o,h,g,_=1){let{bucket:v,layout:E,paint:T,posMatrix:C,textLabelPlaneMatrix:A,labelToScreenMatrix:L,clippingData:R,textPixelRatio:F,mercatorCenter:V,invMatrix:z,holdingForFade:H,collisionBoxArray:j,partiallyEvaluatedTextSize:Z,partiallyEvaluatedIconSize:Y,collisionGroup:J,latestFeatureIndex:re}=t.parameters,ce=E.get("text-optional"),de=E.get("icon-optional"),ie=E.get("text-allow-overlap"),oe=E.get("icon-allow-overlap"),se=E.get("text-rotation-alignment")==="map",Te=E.get("icon-rotation-alignment")==="map",me=E.get("text-pitch-alignment")==="map",Ne=T.get("symbol-z-offset"),Ae=E.get("symbol-elevation-reference")==="sea",Ve=E.get("symbol-placement"),[Qe,Ie]=E.get("text-size-scale-range"),[pe,Pe]=E.get("icon-size-scale-range"),Se=r.ay(_,Qe,Ie),He=r.ay(_,pe,Pe),Ge=E.get("text-variable-anchor"),We=se&&Ve!=="point",ot=Te&&Ve!=="point",bt=Ge&&v.hasTextData(),St=v.hasIconTextFit()&&bt&&v.hasIconData();this.transform.setProjection(v.projection);let ft=bt||We,Tt=ot||St,wt=ie&&(oe||!v.hasIconData()||de),zt=oe&&(ie||!v.hasTextData()||ce),Wt=!Ne.isConstant();!v.collisionArrays&&j&&v.deserializeCollisionBoxes(j),h&&g&&v.updateCollisionDebugBuffers(this.transform.zoom,j,Se,He);let on=(Ht,wn,Dn)=>{let{crossTileID:Xn,numVerticalGlyphVertices:tn}=Ht,En=null;if(R&&R.dynamicFilterNeedsFeature||Wt){let Or=this.retainedQueryData[v.bucketInstanceId];En=re.loadFeature({featureIndex:Ht.featureIndex,bucketIndex:Or.bucketIndex,sourceLayerIndex:Or.sourceLayerIndex,layoutVertexArrayOffset:0})}if(R&&!(0,R.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},En,this.retainedQueryData[v.bucketInstanceId].tileID.canonical,new r.P(Ht.tileAnchorX,Ht.tileAnchorY),this.transform.calculateDistanceTileData(R.unwrappedTileID)))return this.placements[Xn]=new Ao(!1,!1,!1,!0),void o.add(Xn);let Tn=Ne.evaluate(En,{});if(o.has(Xn))return;if(H)return void(this.placements[Xn]=new Ao(!1,!1,!1));let Mn=!1,sn=!1,Bn=!0,Cn=!1,yr=!1,vn=null,Rn={box:null,offscreen:null,occluded:null},Wn={box:null},Gr=null,Br=null,Wr=null,pi=0,fs=0,Hi=0;Dn.textFeatureIndex?pi=Dn.textFeatureIndex:Ht.useRuntimeCollisionCircles&&(pi=Ht.featureIndex),Dn.verticalTextFeatureIndex&&(fs=Dn.verticalTextFeatureIndex);let go=Or=>{Or.tileID=this.retainedQueryData[v.bucketInstanceId].tileID;let Dr=this.transform.elevation;Or.elevation=Ae?Tn:Tn+(Dr?Dr.getAtTileOffset(Or.tileID,Or.tileAnchorX,Or.tileAnchorY):0),Or.elevation+=Ht.zOffset},Ti=Dn.textBox;if(Ti){go(Ti);let Or=Jn=>{let ei=r.bI.horizontal;if(v.allowVerticalPlacement&&!Jn&&this.prevPlacement){let mi=this.prevPlacement.placedOrientations[Xn];mi&&(this.placedOrientations[Xn]=mi,ei=mi,this.markUsedOrientation(v,ei,Ht))}return ei},Dr=(Jn,ei)=>{if(v.allowVerticalPlacement&&tn>0&&Dn.verticalTextBox){for(let mi of v.writingModes)if(mi===r.bI.vertical?(Rn=ei(),Wn=Rn):Rn=Jn(),Rn&&Rn.box&&Rn.box.length)break}else Rn=Jn()};if(Ge){let Jn=Ge;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Xn]){let Lr=this.prevPlacement.variableOffsets[Xn];Jn.indexOf(Lr.anchor)>0&&(Jn=Jn.filter(Fo=>Fo!==Lr.anchor),Jn.unshift(Lr.anchor))}let ei=(Lr,Fo,vl)=>{let Fa=v.getSymbolInstanceTextSize(Z,Ht,this.transform.zoom,wn),Cc=(Lr.x2-Lr.x1)*Fa+2*Lr.padding,Ac=(Lr.y2-Lr.y1)*Fa+2*Lr.padding,ko=Ht.hasIconTextFit&&!oe?Fo:null;ko&&go(ko);let As={box:[],offscreen:!1,occluded:!1},ti=ie?2*Jn.length:Jn.length;for(let No=0;No<ti;++No){let xl=this.attemptAnchorPlacement(Jn[No%Jn.length],Lr,V,z,ft,Cc,Ac,Fa,se,me,F,C,J,No>=Jn.length,Ht,wn,v,vl,ko,Z,Y);if(xl&&(As=xl.placedGlyphBoxes,As&&As.box&&As.box.length)){Mn=!0,vn=xl.shift;break}}return As};Dr(()=>ei(Ti,Dn.iconBox,r.bI.horizontal),()=>{let Lr=Dn.verticalTextBox;return Lr&&go(Lr),v.allowVerticalPlacement&&!(Rn&&Rn.box&&Rn.box.length)&&tn>0&&Lr?ei(Lr,Dn.verticalIconBox,r.bI.vertical):{box:null,offscreen:null,occluded:null}}),Rn&&(Mn=Rn.box,Bn=Rn.offscreen,Cn=Rn.occluded);let mi=Or(!(!Rn||!Rn.box));if(!Mn&&this.prevPlacement){let Lr=this.prevPlacement.variableOffsets[Xn];Lr&&(this.variableOffsets[Xn]=Lr,this.markUsedJustification(v,Lr.anchor,Ht,mi))}}else{let Jn=(ei,mi)=>{let Lr=v.getSymbolInstanceTextSize(Z,Ht,this.transform.zoom,wn,_),Fo=this.collisionIndex.placeCollisionBox(v,Lr,ei,V,z,ft,new r.P(0,0),ie,F,C,J.predicate);return Fo&&Fo.box&&Fo.box.length&&(this.markUsedOrientation(v,mi,Ht),this.placedOrientations[Xn]=mi),Fo};Dr(()=>Jn(Ti,r.bI.horizontal),()=>{let ei=Dn.verticalTextBox;return v.allowVerticalPlacement&&tn>0&&ei?(go(ei),Jn(ei,r.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Or(!!(Rn&&Rn.box&&Rn.box.length))}}if(Gr=Rn,Mn=Gr&&Gr.box&&Gr.box.length>0,Bn=Gr&&Gr.offscreen,Cn=Gr&&Gr.occluded,Ht.useRuntimeCollisionCircles){let Or=v.text.placedSymbolArray.get(Ht.centerJustifiedTextSymbolIndex>=0?Ht.centerJustifiedTextSymbolIndex:Ht.verticalPlacedTextSymbolIndex),Dr=r.bJ(v.textSizeData,Z,Or),Jn=E.get("text-padding");Br=this.collisionIndex.placeCollisionCircles(v,ie,Or,v.lineVertexArray,v.glyphOffsetArray,Dr,C,A,L,h,me,J.predicate,Ht.collisionCircleDiameter*Dr/r.bU,Jn,this.retainedQueryData[v.bucketInstanceId].tileID),Mn=ie||Br.circles.length>0&&!Br.collisionDetected,Bn=Bn&&Br.offscreen,Cn=Br.occluded}if(Dn.iconFeatureIndex&&(Hi=Dn.iconFeatureIndex),Dn.iconBox){let Or=Dr=>{go(Dr);let Jn=Ht.hasIconTextFit&&vn?On(vn.x,vn.y,se,me,this.transform.angle):new r.P(0,0),ei=v.getSymbolInstanceIconSize(Y,this.transform.zoom,Ht.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(v,ei,Dr,V,z,Tt,Jn,oe,F,C,J.predicate)};Wn&&Wn.box&&Wn.box.length&&Dn.verticalIconBox?(Wr=Or(Dn.verticalIconBox),sn=Wr.box.length>0):(Wr=Or(Dn.iconBox),sn=Wr.box.length>0),Bn=Bn&&Wr.offscreen,yr=Wr.occluded}let Lo=ce||Ht.numHorizontalGlyphVertices===0&&tn===0,ns=de||Ht.numIconVertices===0;if(Lo||ns?ns?Lo||(sn=sn&&Mn):Mn=sn&&Mn:sn=Mn=sn&&Mn,Mn&&Gr&&Gr.box&&this.collisionIndex.insertCollisionBox(Gr.box,E.get("text-ignore-placement"),v.bucketInstanceId,Wn&&Wn.box&&fs?fs:pi,J.ID),sn&&Wr&&this.collisionIndex.insertCollisionBox(Wr.box,E.get("icon-ignore-placement"),v.bucketInstanceId,Hi,J.ID),Br&&(Mn&&this.collisionIndex.insertCollisionCircles(Br.circles,E.get("text-ignore-placement"),v.bucketInstanceId,pi,J.ID),h)){let Or=v.bucketInstanceId,Dr=this.collisionCircleArrays[Or];Dr===void 0&&(Dr=this.collisionCircleArrays[Or]=new Cp);for(let Jn=0;Jn<Br.circles.length;Jn+=4)Dr.circles.push(Br.circles[Jn+0]),Dr.circles.push(Br.circles[Jn+1]),Dr.circles.push(Br.circles[Jn+2]),Dr.circles.push(Br.collisionDetected?1:0)}let Ii=v.projection.name!=="globe";wt=wt&&(Ii||!Cn),zt=zt&&(Ii||!yr),this.placements[Xn]=new Ao(Mn||wt,sn||zt,Bn||v.justReloaded),o.add(Xn)},bn=this.retainedQueryData[v.bucketInstanceId].tileID;if(v.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(v,bn),v.elevationType==="road"&&v.updateRoadElevation(bn.canonical),v.updateZOffset(),v.sortFeaturesByY){let Ht=v.getSortedSymbolIndexes(this.transform.angle);for(let wn=Ht.length-1;wn>=0;--wn){let Dn=Ht[wn];on(v.symbolInstances.get(Dn),Dn,v.collisionArrays[Dn])}v.hasAnyZOffset&&r.w(`${v.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(v.hasAnyZOffset){let Ht=v.getSortedIndexesByZOffset();for(let wn=0;wn<Ht.length;++wn){let Dn=Ht[wn];on(v.symbolInstances.get(Dn),Dn,v.collisionArrays[Dn])}}else for(let Ht=t.symbolInstanceStart;Ht<t.symbolInstanceEnd;Ht++)on(v.symbolInstances.get(Ht),Ht,v.collisionArrays[Ht]);if(h&&v.bucketInstanceId in this.collisionCircleArrays){let Ht=this.collisionCircleArrays[v.bucketInstanceId];r.bi(Ht.invProjMatrix,C),Ht.viewportMatrix=this.collisionIndex.getViewportMatrix()}v.justReloaded=!1}markUsedJustification(t,o,h,g){let{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:v,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:T,crossTileID:C}=h,A=r.b$(o),L=g===r.bI.vertical?T:A==="left"?_:A==="center"?v:A==="right"?E:-1;_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=L>=0&&_!==L?0:C),v>=0&&(t.text.placedSymbolArray.get(v).crossTileID=L>=0&&v!==L?0:C),E>=0&&(t.text.placedSymbolArray.get(E).crossTileID=L>=0&&E!==L?0:C),T>=0&&(t.text.placedSymbolArray.get(T).crossTileID=L>=0&&T!==L?0:C)}markUsedOrientation(t,o,h){let g=o===r.bI.horizontal||o===r.bI.horizontalOnly?o:0,_=o===r.bI.vertical?o:0,{leftJustifiedTextSymbolIndex:v,centerJustifiedTextSymbolIndex:E,rightJustifiedTextSymbolIndex:T,verticalPlacedTextSymbolIndex:C}=h,A=t.text.placedSymbolArray;v>=0&&(A.get(v).placedOrientation=g),E>=0&&(A.get(E).placedOrientation=g),T>=0&&(A.get(T).placedOrientation=g),C>=0&&(A.get(C).placedOrientation=_)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;let o=this.prevPlacement,h=!1;this.prevZoomAdjustment=o?o.zoomAdjustment(this.transform.zoom):0;let g=o?o.symbolFadeChange(t):1,_=o?o.opacities:{},v=o?o.variableOffsets:{},E=o?o.placedOrientations:{};for(let T in this.placements){let C=this.placements[T],A=_[T];A?(this.opacities[T]=new sl(A,g,C.text,C.icon,null,C.clipped),h=h||C.text!==A.text.placed||C.icon!==A.icon.placed):(this.opacities[T]=new sl(null,g,C.text,C.icon,C.skipFade,C.clipped),h=h||C.text||C.icon)}for(let T in _){let C=_[T];if(!this.opacities[T]){let A=new sl(C,g,!1,!1);A.isHidden()||(this.opacities[T]=A,h=h||C.text.placed||C.icon.placed)}}for(let T in v)this.variableOffsets[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.variableOffsets[T]=v[T]);for(let T in E)this.placedOrientations[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.placedOrientations[T]=E[T]);h?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=o?o.lastPlacementChangeTime:t)}updateLayerOpacities(t,o,h,g){let _=new Set;for(let v of o){let E=v.getBucket(t);E&&v.latestFeatureIndex&&t.fqid===E.layerIds[0]&&(this.updateBucketOpacities(E,_,v,v.collisionBoxArray,h,g,v.tileID,t.scope),E.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(E,v.tileID),E.elevationType==="road"&&E.updateRoadElevation(v.tileID.canonical),E.updateZOffset())}}updateBucketOpacities(t,o,h,g,_,v,E,T){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();let C=t.layers[0].layout,A=t.layers[0].paint,L=!!t.layers[0].dynamicFilter(),R=new sl(null,0,!1,!1,!0),F=C.get("text-allow-overlap"),V=C.get("icon-allow-overlap"),z=C.get("text-variable-anchor"),H=C.get("text-rotation-alignment")==="map",j=C.get("text-pitch-alignment")==="map",Z=A.get("symbol-z-offset"),Y=C.get("symbol-elevation-reference")==="sea",J=!Z.isConstant(),re=new sl(null,0,F&&(V||!t.hasIconData()||C.get("icon-optional")),V&&(F||!t.hasTextData()||C.get("text-optional")),!0);!t.collisionArrays&&g&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(g);let ce=(ie,oe,se)=>{for(let Te=0;Te<oe/4;Te++)ie.opacityVertexArray.emplaceBack(se)},de=0;v&&t.updateReplacement(E,v);for(let ie=0;ie<t.symbolInstances.length;ie++){let oe=t.symbolInstances.get(ie),{numHorizontalGlyphVertices:se,numVerticalGlyphVertices:Te,crossTileID:me,numIconVertices:Ne,tileAnchorX:Ae,tileAnchorY:Ve}=oe,Qe=null,Ie=this.retainedQueryData[t.bucketInstanceId];J&&oe&&Ie&&(Qe=h.latestFeatureIndex.loadFeature({featureIndex:oe.featureIndex,bucketIndex:Ie.bucketIndex,sourceLayerIndex:Ie.sourceLayerIndex,layoutVertexArrayOffset:0}));let pe=Z.evaluate(Qe,{}),Pe=o.has(me),Se=this.opacities[me];Pe?Se=R:Se||(Se=re,this.opacities[me]=Se),o.add(me);let He=se>0||Te>0,Ge=Ne>0,We=this.placedOrientations[me],ot=We===r.bI.vertical,bt=We===r.bI.horizontal||We===r.bI.horizontalOnly;!He&&!Ge||Se.isHidden()||de++;let St=!1;if((He||Ge)&&v)for(let ft of t.activeReplacements){if(r.bV(ft,_,r.bW.Symbol,T)||ft.min.x>Ae||Ae>ft.max.x||ft.min.y>Ve||Ve>ft.max.y)continue;let Tt=r.bX(Ae,Ve,E.canonical,ft.footprintTileId.canonical);if(St=r.bY(Tt,ft.footprint),St)break}if(He){let ft=St?ya:ec(Se.text);ce(t.text,se,ot?ya:ft),ce(t.text,Te,bt?ya:ft);let Tt=Se.text.isHidden(),{leftJustifiedTextSymbolIndex:wt,centerJustifiedTextSymbolIndex:zt,rightJustifiedTextSymbolIndex:Wt,verticalPlacedTextSymbolIndex:on}=oe,bn=t.text.placedSymbolArray,Ht=Tt||ot?1:0;wt>=0&&(bn.get(wt).hidden=Ht),zt>=0&&(bn.get(zt).hidden=Ht),Wt>=0&&(bn.get(Wt).hidden=Ht),on>=0&&(bn.get(on).hidden=Tt||bt?1:0);let wn=this.variableOffsets[me];wn&&this.markUsedJustification(t,wn.anchor,oe,We);let Dn=this.placedOrientations[me];Dn&&(this.markUsedJustification(t,"left",oe,Dn),this.markUsedOrientation(t,Dn,oe))}if(Ge){let ft=St?ya:ec(Se.icon),{placedIconSymbolIndex:Tt,verticalPlacedIconSymbolIndex:wt}=oe,zt=t.icon.placedSymbolArray,Wt=Se.icon.isHidden()?1:0;Tt>=0&&(ce(t.icon,Ne,ot?ya:ft),zt.get(Tt).hidden=Wt),wt>=0&&(ce(t.icon,oe.numVerticalIconVertices,bt?ya:ft),zt.get(wt).hidden=Wt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){let ft=t.collisionArrays[ie];if(ft){let Tt=new r.P(0,0),wt=!0;if(ft.textBox||ft.verticalTextBox){if(z){let Wt=this.variableOffsets[me];Wt?(Tt=Pn(Wt.anchor,Wt.width,Wt.height,Wt.textOffset,Wt.textScale),H&&Tt._rotate(j?this.transform.angle:-this.transform.angle)):wt=!1}L&&(wt=!Se.clipped),ft.textBox&&Hs(t.textCollisionBox.collisionVertexArray,Se.text.placed,!wt||ot,pe,Y,Tt.x,Tt.y),ft.verticalTextBox&&Hs(t.textCollisionBox.collisionVertexArray,Se.text.placed,!wt||bt,pe,Y,Tt.x,Tt.y)}let zt=wt&&!!(!bt&&ft.verticalIconBox);ft.iconBox&&Hs(t.iconCollisionBox.collisionVertexArray,Se.icon.placed,zt,pe,Y,oe.hasIconTextFit?Tt.x:0,oe.hasIconTextFit?Tt.y:0),ft.verticalIconBox&&Hs(t.iconCollisionBox.collisionVertexArray,Se.icon.placed,!zt,pe,Y,oe.hasIconTextFit?Tt.x:0,oe.hasIconTextFit?Tt.y:0)}}}if(t.fullyClipped=de===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){let ie=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=ie.invProjMatrix,t.placementViewportMatrix=ie.viewportMatrix,t.collisionCircleArray=ie.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,o){let h=this.zoomAtLastRecencyCheck===o?1-this.zoomAdjustment(o):1;return this.zoomAtLastRecencyCheck=o,this.commitTime+this.fadeDuration*h>t}setStale(){this.stale=!0}}function Hs(d,t,o,h,g,_,v){d.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0),d.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0),d.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0),d.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,g?1:0)}let Fn=Math.pow(2,25),nh=Math.pow(2,24),Au=Math.pow(2,17),Mu=Math.pow(2,16),Pi=Math.pow(2,9),Qr=Math.pow(2,8),Sb=Math.pow(2,1);function ec(d){if(d.opacity===0&&!d.placed)return 0;if(d.opacity===1&&d.placed)return 4294967295;let t=d.placed?1:0,o=Math.floor(127*d.opacity);return o*Fn+t*nh+o*Au+t*Mu+o*Pi+t*Qr+o*Sb+t}let ya=0;class Ru{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,o,h,g,_,v){let E=this._bucketParts;for(;this._currentTileIndex<t.length;)if(o.getBucketParts(E,g,t[this._currentTileIndex],this._sortAcrossTiles,v),this._currentTileIndex++,_())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((T,C)=>T.sortKey-C.sortKey));this._currentPartIndex<E.length;){let T=E[this._currentPartIndex];if(o.placeLayerBucketPart(T,this._seenCrossTileIDs,h,T.symbolInstanceStart===0,v),this._currentPartIndex++,_())return!0}return!1}}class rh{constructor(t,o,h,g,_,v,E,T,C){this.placement=new po(t,_,v,E,T,C),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=h,this._showCollisionBoxes=g,this._done=!1}isDone(){return this._done}continuePlacement(t,o,h,g,_){let v=r.q.now(),E=()=>{let T=r.q.now()-v;return!this._forceFullPlacement&&T>2};for(;this._currentPlacementIndex>=0;){let T=o[t[this._currentPlacementIndex]],C=this.placement.collisionIndex.transform.zoom;if(T.type==="symbol"&&(!T.minzoom||T.minzoom<=C)&&(!T.maxzoom||T.maxzoom>C)){let A=T,L=A.layout.get("symbol-z-elevate"),R=A.layout.get("symbol-sort-key").constantOr(1)!==void 0,F=A.layout.get("symbol-z-order"),V=F==="viewport-y"||F==="auto"&&!(F!=="viewport-y"&&R),z=A.layout.get("text-allow-overlap")||A.layout.get("icon-allow-overlap")||A.layout.get("text-ignore-placement")||A.layout.get("icon-ignore-placement"),H=V&&z,j=this._inProgressLayer=this._inProgressLayer||new Ru(A),Z=r.C(T.source,T.scope);if(j.continuePlacement(L||H?g[Z]:h[Z],this.placement,this._showCollisionBoxes,T,E,_))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}let Pu=512/r.aj/2;class ih{constructor(t,o,h){this.tileID=t,this.bucketInstanceId=h,this.index=new r.c0(o.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let g=t.canonical.x*r.aj,_=t.canonical.y*r.aj;for(let v=0;v<o.length;v++){let{key:E,crossTileID:T,tileAnchorX:C,tileAnchorY:A}=o.get(v),L=Math.floor((g+C)*Pu),R=Math.floor((_+A)*Pu);this.index.add(L,R),this.keys.push(E),this.crossTileIDs.push(T)}this.index.finish()}findMatches(t,o,h){let g=this.tileID.canonical.z<o.canonical.z?1:Math.pow(2,this.tileID.canonical.z-o.canonical.z),_=Pu/Math.pow(2,o.canonical.z-this.tileID.canonical.z),v=o.canonical.x*r.aj,E=o.canonical.y*r.aj;for(let T=0;T<t.length;T++){let C=t.get(T);if(C.crossTileID)continue;let{key:A,tileAnchorX:L,tileAnchorY:R}=C,F=Math.floor((v+L)*_),V=Math.floor((E+R)*_),z=this.index.range(F-g,V-g,F+g,V+g).sort((H,j)=>H-j);for(let H of z){let j=this.crossTileIDs[H];if(this.keys[H]===A&&!h.has(j)){h.add(j),C.crossTileID=j;break}}}}}class Bi{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Gs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){let o=Math.round((t-this.lng)/360);if(o!==0)for(let h in this.indexes){let g=this.indexes[h],_={};for(let v in g){let E=g[v];E.tileID=E.tileID.unwrapTo(E.tileID.wrap+o),_[E.tileID.key]=E}this.indexes[h]=_}this.lng=t}addBucket(t,o,h){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===o.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let _=0;_<o.symbolInstances.length;_++)o.symbolInstances.get(_).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);let g=this.usedCrossTileIDs[t.overscaledZ];for(let _ in this.indexes){let v=this.indexes[_];if(Number(_)>t.overscaledZ)for(let E in v){let T=v[E];T.tileID.isChildOf(t)&&T.findMatches(o.symbolInstances,t,g)}else{let E=v[t.scaledTo(Number(_)).key];E&&E.findMatches(o.symbolInstances,t,g)}}for(let _=0;_<o.symbolInstances.length;_++){let v=o.symbolInstances.get(_);v.crossTileID||(v.crossTileID=h.generate(),g.add(v.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new ih(t,o.symbolInstances,o.bucketInstanceId),!0}removeBucketCrossTileIDs(t,o){for(let h of o.crossTileIDs)this.usedCrossTileIDs[t].delete(h)}removeStaleBuckets(t){let o=!1;for(let h in this.indexes){let g=this.indexes[h];for(let _ in g)t[g[_].bucketInstanceId]||(this.removeBucketCrossTileIDs(h,g[_]),delete g[_],o=!0)}return o}}class to{constructor(){this.layerIndexes={},this.crossTileIDs=new Bi,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,o,h,g){let _=this.layerIndexes[t.fqid];_===void 0&&(_=this.layerIndexes[t.fqid]=new Gs);let v=!1,E={};g.name!=="globe"&&_.handleWrapJump(h);for(let T of o){let C=T.getBucket(t);C&&t.fqid===C.layerIds[0]&&(C.bucketInstanceId||(C.bucketInstanceId=++this.maxBucketInstanceId),_.addBucket(T.tileID,C,this.crossTileIDs)&&(v=!0),E[C.bucketInstanceId]=!0)}return _.removeStaleBuckets(E)&&(v=!0),v}pruneUnusedLayers(t){let o={};t.forEach(h=>{o[h]=!0});for(let h in this.layerIndexes)o[h]||delete this.layerIndexes[h]}}let al=771;class Yt{constructor(t,o,h,g){this.blendFunction=t,this.blendColor=o.toNonPremultipliedRenderColor(null),this.mask=h,this.blendEquation=g}}Yt.Replace=[1,0,1,0],Yt.disabled=new Yt(Yt.Replace,r.am.transparent,[!1,!1,!1,!1]),Yt.unblended=new Yt(Yt.Replace,r.am.transparent,[!0,!0,!0,!0]),Yt.alphaBlended=new Yt([1,al,1,al],r.am.transparent,[!0,!0,!0,!0]),Yt.alphaBlendedNonPremultiplied=new Yt([770,al,770,al],r.am.transparent,[!0,!0,!0,!0]),Yt.multiply=new Yt([774,0,774,0],r.am.transparent,[!0,!0,!0,!0]);class gt{constructor(t,o,h){this.func=t,this.mask=o,this.range=h}}gt.ReadOnly=!1,gt.ReadWrite=!0,gt.disabled=new gt(519,gt.ReadOnly,[0,1]);let Yo=7680;class Lt{constructor(t,o,h,g,_,v){this.test=t,this.ref=o,this.mask=h,this.fail=g,this.depthFail=_,this.pass=v}}Lt.disabled=new Lt({func:519,mask:0},0,0,Yo,Yo,Yo);let Xr=1029,Ou=2305;class Mt{constructor(t,o,h){this.enable=t,this.mode=o,this.frontFace=h}}function tc(d,t){let o=r.c6(d,3);r.c8(d,t),r.cc(d,3,o)}function nc(d,t){let o=r.c3([]);return r.c4(o,o,-t),r.c5(o,o,-d),o}function va(d,t){let o=[d[0],d[1],0],h=[t[0],t[1],0];if(r.ae(o)>=1e-15){let v=r.au([],o);r.c1(h,v,r.bG(h,v)),t[0]=h[0],t[1]=h[1]}let g=r.bF([],t,d);if(r.c2(g)<1e-15)return null;let _=Math.atan2(-g[1],g[0]);return nc(Math.atan2(Math.sqrt(d[0]*d[0]+d[1]*d[1]),-d[2]),_)}Mt.disabled=new Mt(!1,Xr,Ou),Mt.backCCW=new Mt(!0,Xr,Ou),Mt.backCW=new Mt(!0,Xr,2304),Mt.frontCW=new Mt(!0,1028,2304),Mt.frontCCW=new Mt(!0,1028,Ou);class Y_{constructor(t,o){this.position=t,this.orientation=o}get position(){return this._position}set position(t){if(t){let o=t instanceof r.ac?t:new r.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(o.x=r.bQ(o.x,0,1)),this._position=o}else this._position=null}lookAtPoint(t,o){if(this.orientation=null,!this.position)return;let h=this.position,g=this._elevation?this._elevation.getAtPointOrZero(r.ac.fromLngLat(t)):0,_=r.ac.fromLngLat(t,g),v=[_.x-h.x,_.y-h.y,_.z-h.z];o||(o=[0,0,1]),o[2]=Math.abs(o[2]),this.orientation=va(v,o)}setPitchBearing(t,o){this.orientation=nc(r.al(t),r.al(-o))}}class Ko{constructor(t,o){this._transform=r.bx([]),this.orientation=o,this.position=t}get mercatorPosition(){let t=this.position;return new r.ac(t[0],t[1],t[2])}get position(){let t=r.c6(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var o;t&&r.cc(this._transform,3,[(o=t)[0],o[1],o[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||r.c3([]),t&&tc(this._transform,this._orientation)}getPitchBearing(){let t=this.forward(),o=this.right();return{bearing:Math.atan2(-o[1],o[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,o){this._orientation=nc(t,o),tc(this._transform,this._orientation)}forward(){let t=r.c6(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){let t=r.c6(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){let t=r.c6(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,o){let h=new Float64Array(16);return r.bi(h,this.getWorldToCamera(t,o)),h}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,o,h){let g=this.position;r.c1(g,g,-t);let _=new Float64Array(16);return r.bn(_,[h,h,h]),r.bo(_,_,g),_[10]*=o,_}getWorldToCamera(t,o){let h=new Float64Array(16),g=new Float64Array(4),_=this.position;return r.c7(g,this._orientation),r.c1(_,_,-t),r.c8(h,g),r.bo(h,h,_),h[1]*=-1,h[5]*=-1,h[9]*=-1,h[13]*=-1,h[8]*=o,h[9]*=o,h[10]*=o,h[11]*=o,h}getCameraToClipPerspective(t,o,h,g){let _=new Float64Array(16);return r.c9(_,t,o,h,g),_}getCameraToClipOrthographic(t,o,h,g,_,v){let E=new Float64Array(16);return r.ca(E,t,o,h,g,_,v),E}getDistanceToElevation(t,o=!1){let h=t===0?0:r.cb(t,o?r.aY(this.position[1]):this.position[1]),g=this.forward();return(h-this.position[2])/g[2]}clone(){return new Ko([...this.position],[...this.orientation])}}let Vi={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Lu{constructor(t=0,o=0,h=0,g=0){if(isNaN(t)||t<0||isNaN(o)||o<0||isNaN(h)||h<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=o,this.left=h,this.right=g}interpolate(t,o,h){return o.top!=null&&t.top!=null&&(this.top=r.ai(t.top,o.top,h)),o.bottom!=null&&t.bottom!=null&&(this.bottom=r.ai(t.bottom,o.bottom,h)),o.left!=null&&t.left!=null&&(this.left=r.ai(t.left,o.left,h)),o.right!=null&&t.right!=null&&(this.right=r.ai(t.right,o.right,h)),this}getCenter(t,o){let h=r.ay((this.left+t-this.right)/2,0,t),g=r.ay((this.top+o-this.bottom)/2,0,o);return new r.P(h,g)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Lu(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let fi=15;class Ap{constructor(t,o,h,g,_,v,E){this.tileSize=512,this._renderWorldCopies=_===void 0||_,this._minZoom=t||0,this._maxZoom=o||22,this._minPitch=h??0,this._maxPitch=g??60,this.setProjection(v),this.setMaxBounds(E),this.width=0,this.height=0,this._center=new r.ci(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Lu,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Ko,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let t=new Ap(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<fi}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,o=!1){let h=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||h)&&this._updateCameraOnTerrain(),(t||h)&&this._constrainCamera(o),this._calcMatrices()}getProjection(){return r.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};let o=this.projection?this.getProjection():void 0;this.projection=r.cj(this.projectionOptions);let h=this.getProjection(),g=!r.bv(o,h);return g&&this._calcMatrices(),this.mercatorFromTransition=!1,g}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){let t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=r.cj({name:"mercator"});let o=t!==this.projection.name;return o&&this._calcMatrices(),o}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return r.cb(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new r.P(this.width,this.height)}get bearing(){return r.bQ(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){let o=-t*Math.PI/180;this.angle!==o&&(this._unmodified=!1,this.angle=o,this._calcMatrices(),this.rotationMatrix=r.ck(),r.cl(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){let o=r.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==o&&(this._unmodified=!1,this._pitch=o,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=r.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){let o=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==o&&(this._unmodified=!1,this._setZoom(o),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){let t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,o=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!o||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let h=this._elevation;o||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&h.exaggeration()&&this._centerAltitudeValidForExaggeration!==h.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*h.exaggeration(),this._centerAltitudeValidForExaggeration=h.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=h.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;let t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;let t=this._elevation,o=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],h=this.horizonLineFromTop(),g=0,_=0;for(let v=0;v<o.length;v++){let E=new r.P(o[v][0]*this.width,h+o[v][1]*(this.height-h)),T=t.pointCoordinate(E);if(!T)continue;let C=1/Math.hypot(T[0]-this._camera.position[0],T[1]-this._camera.position[1]);g+=T[3]*C,_+=C}return _===0?NaN:g/_}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let t=this._seaLevelZoom,o=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),h=this.pixelsPerMeter/this.worldSize*o,g=this._mercatorZfromZoom(t),_=this._mercatorZfromZoom(this._maxZoom),v=Math.max(g-h,_);this._setZoom(this._zoomFromMercatorZ(v))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){let o=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude())),h;h=t.z<this._camera.position[2]?[o.x,o.y,o.z]:[t.x,t.y,t.z];let g=r.ae(r.at([],this._camera.position,h));return r.ay(this._zoomFromMercatorZ(g),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let o=!1;if(t.orientation&&!r.cm(t.orientation,this._camera.orientation)&&(o=this._setCameraOrientation(t.orientation)),t.position){let h=[t.position.x,t.position.y,t.position.z];r.cn(h,this._camera.position)||(this._setCameraPosition(h),o=!0)}o&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let t=this._camera.position,o=new Y_;return o.position=new r.ac(t[0],t[1],t[2]),o.orientation=this._camera.orientation,o._elevation=this.elevation,o._renderWorldCopies=this.renderWorldCopies,o}_setCameraOrientation(t){if(!r.co(t))return!1;r.cp(t,t);let o=r.cq([],[0,0,-1],t),h=r.cq([],[0,-1,0],t);if(h[2]<0)return!1;let g=va(o,h);return!!g&&(this._camera.orientation=g,!0)}_setCameraPosition(t){let o=this.zoomScale(this.minZoom)*this.tileSize,h=this.zoomScale(this.maxZoom)*this.tileSize,g=this.cameraToCenterDistance;t[2]=r.ay(t[2],g/h,g/o),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,o,h){this._unmodified=!1,this._edgeInsets.interpolate(t,o,h),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){let o=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,o)}getVisibleUnwrappedCoordinates(t){let o=[new r.cr(0,t)];if(this.renderWorldCopies){let h=this.pointCoordinate(new r.P(0,0)),g=this.pointCoordinate(new r.P(this.width,0)),_=this.pointCoordinate(new r.P(this.width,this.height)),v=this.pointCoordinate(new r.P(0,this.height)),E=Math.floor(Math.min(h.x,g.x,_.x,v.x)),T=Math.floor(Math.max(h.x,g.x,_.x,v.x)),C=1;for(let A=E-C;A<=T+C;A++)A!==0&&o.push(new r.cr(A,t))}return o}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,o,h){let g=[],_=h!=null,v=!_;if(v&&this.zoom<o||_&&h[0]===0&&h[1]===0)return g;let E=new Set,T=(A,L,R,F,V)=>{let z=r.cV(L,A,R,F,V);E.has(z)||(g.push(new r.aM(A,L,R,F,V)),E.add(z))};for(let A=0;A<t.length;A++){let L=t[A];if(v&&L.canonical.z!==o)continue;let R=L.canonical,F=L.overscaledZ,V=L.wrap,z=1<<R.z,H=R.x+1<z,j=R.x>0,Z=R.y+1<z,Y=R.y>0,J=L.wrap-(j?0:1),re=L.wrap+(H?0:1),ce=j?R.x-1:z-1,de=H?R.x+1:0;if(_)h[0]<0?(T(F,re,R.z,de,R.y),h[1]<0&&Z&&(T(F,V,R.z,R.x,R.y+1),T(F,re,R.z,de,R.y+1)),h[1]>0&&Y&&(T(F,V,R.z,R.x,R.y-1),T(F,re,R.z,de,R.y-1))):h[0]>0?(T(F,J,R.z,ce,R.y),h[1]<0&&Z&&(T(F,V,R.z,R.x,R.y+1),T(F,J,R.z,ce,R.y+1)),h[1]>0&&Y&&(T(F,V,R.z,R.x,R.y-1),T(F,J,R.z,ce,R.y-1))):h[1]<0&&Z?T(F,V,R.z,R.x,R.y+1):Y&&T(F,V,R.z,R.x,R.y-1);else{let ie=L.visibleQuadrants;1&ie&&(T(F,J,R.z,ce,R.y),Y&&(T(F,V,R.z,R.x,R.y-1),T(F,J,R.z,ce,R.y-1))),2&ie&&(T(F,re,R.z,de,R.y),Y&&(T(F,V,R.z,R.x,R.y-1),T(F,re,R.z,de,R.y-1))),4&ie&&(T(F,J,R.z,ce,R.y),Z&&(T(F,V,R.z,R.x,R.y+1),T(F,J,R.z,ce,R.y+1))),8&ie&&(T(F,re,R.z,de,R.y),Z&&(T(F,V,R.z,R.x,R.y+1),T(F,re,R.z,de,R.y+1)))}}let C=[];for(let A of g)g.some(L=>A.isChildOf(L))||C.push(A);if(g=C.filter(A=>!t.some(L=>!!(A.overscaledZ<o&&L.isChildOf(A))||A.equals(L)||A.isChildOf(L))),v){let A=1<<o,L=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),R=[A*L.x,A*L.y],F=4,V=F*F;g=g.filter(z=>{let H=z.canonical.x+.5-R[0],j=z.canonical.y+.5-R[1];return H*H+j*j<V})}return g}extendTileCoverToNearPlane(t,o,h){let g=[],_=new Set;for(let Z of t)_.add(Z.key);let v=(Z,Y,J,re,ce)=>{let de=r.cV(Y,Z,J,re,ce);_.has(de)||(g.push(new r.aM(Z,Y,J,re,ce)),_.add(de))},E=t.reduce((Z,Y)=>Math.max(Z,Y.overscaledZ),h),T=1<<h,C=[new r.P(0,0),new r.P(r.aj,0),new r.P(r.aj,r.aj),new r.P(0,r.aj)],A=new r.P(0,0),L=new r.P(0,0),R=(Z,Y)=>{let J=Math.floor(Z[0]),re=Math.floor(Z[1]),ce=(Z[0]-J)*r.aj,de=(Z[1]-re)*r.aj,ie=Math.floor(Y[0]),oe=Math.floor(Y[1]),se=(Y[0]-ie)*r.aj,Te=(Y[1]-oe)*r.aj;for(let me=-1;me<=1;me++){let Ne=J+me;if(!(Ne<0||Ne>=T)){A.x=ce-me*r.aj,L.x=se-(Ne-ie)*r.aj;for(let Ae=-1;Ae<=1;Ae++){let Ve=re+Ae;A.y=de-Ae*r.aj,L.y=Te-(Ve-oe)*r.aj,r.cW(A,L,C)&&v(E,0,h,Ne,Ve)}}}},F=o.points,V=F[r.cs],z=F[r.ct],H=this._projectToGround(V,F[r.cu]),j=this._projectToGround(z,F[r.cv]);return R(V,H),R(z,j),g}_projectToGround(t,o){return r.cw(r.cx(),t,o,t[2]/(t[2]-o[2]))}coveringTiles(t){let o=this.coveringZoomLevel(t),h=o,g=this.elevation&&this.elevation.exaggeration(),_=g&&!t.isTerrainDEM,v=this.projection.name==="mercator";if(t.minzoom!==void 0&&o<t.minzoom)return[];t.maxzoom!==void 0&&o>t.maxzoom&&(o=t.maxzoom);let E=this.locationCoordinate(this.center),T=this.center.lat,C=1<<o,A=[C*E.x,C*E.y,0],L=this.projection.name==="globe",R=!L,F=r.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,R),V=L?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),z=C*r.cb(1,this.center.lat),H=this._camera.position[2]/r.cb(1,this.center.lat),j=[C*V.x,C*V.y,H*(R?1:z)],Z=L||g,Y=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),J=this.isLODDisabled(!0)?o:0,re;if(this._elevation&&t.isTerrainDEM)re=1e4*this._elevation.exaggeration();else if(this._elevation){let pe=this._elevation.getMinMaxForVisibleTiles();re=pe?pe.max:this._centerAltitude}else re=this._centerAltitude;let ce=t.isTerrainDEM?-re:this._elevation?this._elevation.getMinElevationBelowMSL():0,de=this.projection.isReprojectedInTileSpace?r.cz(this):1,ie=pe=>{let Se=new r.ac(pe.x+25e-6,pe.y,pe.z),He=new r.ac(pe.x,pe.y+25e-6,pe.z),Ge=pe.toLngLat(),We=Se.toLngLat(),ot=He.toLngLat(),bt=this.locationCoordinate(Ge),St=this.locationCoordinate(We),ft=this.locationCoordinate(ot),Tt=Math.hypot(St.x-bt.x,St.y-bt.y),wt=Math.hypot(ft.x-bt.x,ft.y-bt.y);return Math.sqrt(Tt*wt)*de/25e-6},oe=pe=>{let Pe=re,Se=ce;return{aabb:r.cC(this,C,0,0,0,pe,Se,Pe,this.projection),zoom:0,x:0,y:0,minZ:Se,maxZ:Pe,wrap:pe,fullyVisible:!1}},se=[],Te=[],me=o,Ne=t.reparseOverscaled?h:o,Ae=(H-this._centerAltitude)*z,Ve=pe=>{if(!this._elevation||!pe.tileID||!v)return;let Pe=this._elevation.getMinMaxForTile(pe.tileID),Se=pe.aabb;Pe?(Se.min[2]=Pe.min,Se.max[2]=Pe.max,Se.center[2]=(Se.min[2]+Se.max[2])/2):(pe.shouldSplit=Ie(pe),pe.shouldSplit||(Se.min[2]=Se.max[2]=Se.center[2]=this._centerAltitude))},Qe=(pe,Pe)=>{if(.707*Pe<pe)return 1;let Se=Pe/pe;return Se/(1.4144271570014144+(Math.pow(1.1,Se-1.4144271570014144+1)-1)/(1.1-1)-1)},Ie=pe=>{if(pe.zoom<J)return!0;if(pe.zoom===me)return!1;if(pe.shouldSplit!=null)return pe.shouldSplit;let Pe=pe.aabb.distanceX(j),Se=pe.aabb.distanceY(j),He=Ae,Ge=1;if(L){He=pe.aabb.distanceZ(j);let wt=Math.pow(2,pe.zoom),zt=r.aY((pe.y+1)/wt),Wt=r.aY(pe.y/wt),on=Math.min(Math.max(T,zt),Wt),bn=r.c_(on)/r.c_(T);if(Ge=on===T?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,bn/this._mercatorScaleRatio),this.zoom<=r.cX&&pe.zoom===me-1&&bn>=.9)return!0}else if(_&&(He=pe.aabb.distanceZ(j)*z),this.projection.isReprojectedInTileSpace&&h<=5){let wt=Math.pow(2,pe.zoom),zt=ie(new r.ac((pe.x+.5)/wt,(pe.y+.5)/wt));Ge=zt>.85?1:zt}if(!v){let wt=Math.sqrt(Pe*Pe+Se*Se+He*He),zt=(1<<me-pe.zoom)*Y*Ge;return zt*=Qe(Math.max(He,Ae),wt),wt<zt}let We=Number.MAX_VALUE,ot=0,bt=pe.aabb.getCorners(),St=[];for(let wt of bt){r.at(St,wt,j),L||(_?St[2]*=z:St[2]=Ae);let zt=r.bG(St,this._camera.forward());zt<We&&(We=zt,ot=Math.abs(St[2]))}let ft=(1<<me-pe.zoom)*Y*Ge;if(ft*=Qe(Math.max(ot,Ae),We),We<ft)return!0;let Tt=pe.aabb.closestPoint(A);return Tt[0]===A[0]&&Tt[1]===A[1]};if(this.renderWorldCopies)for(let pe=1;pe<=3;pe++)se.push(oe(-pe)),se.push(oe(pe));for(se.push(oe(0));se.length>0;){let pe=se.pop(),Pe=pe.x,Se=pe.y,He=pe.fullyVisible,Ge=()=>this.projection.name==="globe"&&(pe.y===0||pe.y===(1<<pe.zoom)-1);if(!He){let We=Z?pe.aabb.intersects(F):pe.aabb.intersectsFlat(F);if(We===0&&Ge()){let ot=new r.cA(pe.zoom,Pe,Se);We=r.cB(this,C,ot,!0).intersects(F)}if(We===0)continue;He=We===2}if(pe.zoom!==me&&Ie(pe))for(let We=0;We<4;We++){let ot=(Pe<<1)+We%2,bt=(Se<<1)+(We>>1),St={aabb:v?pe.aabb.quadrant(We):r.cC(this,C,pe.zoom+1,ot,bt,pe.wrap,pe.minZ,pe.maxZ,this.projection),zoom:pe.zoom+1,x:ot,y:bt,wrap:pe.wrap,fullyVisible:He,tileID:void 0,shouldSplit:void 0,minZ:pe.minZ,maxZ:pe.maxZ};_&&!L&&(St.tileID=new r.aM(pe.zoom+1===me?Ne:pe.zoom+1,pe.wrap,pe.zoom+1,ot,bt),Ve(St)),se.push(St)}else{let We=pe.zoom===me?Ne:pe.zoom;if(t.minzoom&&t.minzoom>We)continue;let ot=0;if(!He){let Tt=Z?pe.aabb.intersectsPrecise(F):pe.aabb.intersectsPreciseFlat(F);if(Tt===0&&Ge()){let wt=new r.cA(pe.zoom,Pe,Se);Tt=r.cB(this,C,wt,!0).intersectsPrecise(F)}if(Tt===0)continue;if(t.calculateQuadrantVisibility)if(F.containsPoint(pe.aabb.center))ot=15;else for(let wt=0;wt<4;wt++)pe.aabb.quadrant(wt).intersects(F)!==0&&(ot|=1<<wt)}let bt=A[0]-(.5+Pe+(pe.wrap<<pe.zoom))*(1<<o-pe.zoom),St=A[1]-.5-Se,ft=pe.tileID?pe.tileID:new r.aM(We,pe.wrap,pe.zoom,Pe,Se);t.calculateQuadrantVisibility&&(ft.visibleQuadrants=ot),Te.push({tileID:ft,distanceSq:bt*bt+St*St})}}if(this.fogCullDistSq){let pe=this.fogCullDistSq,Pe=this.horizonLineFromTop();Te=Te.filter(Se=>{let He=[0,0,0,1],Ge=[r.aj,r.aj,0,1],We=this.calculateFogTileMatrix(Se.tileID.toUnwrapped());r.aA(He,He,We),r.aA(Ge,Ge,We);let ot=r.cD([],He,Ge),bt=r.cE([],He,Ge),St=r.cY(ot,bt);if(St===0)return!0;let ft=!1,Tt=this._elevation;if(Tt&&St>pe&&Pe!==0){let wt=this.calculateProjMatrix(Se.tileID.toUnwrapped()),zt;t.isTerrainDEM||(zt=Tt.getMinMaxForTile(Se.tileID)),zt||(zt={min:ce,max:re});let Wt=r.cF(this.rotation),on=[Wt[0]*r.aj,Wt[1]*r.aj,zt.max];r.ad(on,on,wt),ft=(1-on[1])*this.height*.5<Pe}return St<pe||ft})}return Te.sort((pe,Pe)=>pe.distanceSq-Pe.distanceSq).map(pe=>pe.tileID)}resize(t,o){this.width=t,this.height=o,this.pixelsToGLUnits=[2/t,-2/o],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){let o=r.ay(t.lat,-r.cG,r.cG),h=this.projection.project(t.lng,o);return new r.P(h.x*this.worldSize,h.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/r.cb(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,o){let h,g,_=this.centerPoint;if(this.projection.name==="globe"){let E=this.worldSize;h=(o.x-_.x)/E,g=(o.y-_.y)/E}else{let E=this.pointCoordinate(o),T=this.pointCoordinate(_);h=E.x-T.x,g=E.y-T.y}let v=this.locationCoordinate(t);this.setLocation(new r.ac(v.x-h,v.y-g))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,o){return this.projection.locationPoint(this,t,o)}locationPoint3D(t,o){return this.projection.locationPoint(this,t,o,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,o){return this.coordinateLocation(this.pointCoordinate3D(t,o))}locationCoordinate(t,o){let h=o?r.cb(o,t.lat):void 0,g=this.projection.project(t.lng,t.lat);return new r.ac(g.x,g.y,h)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,o){let h=o??this._centerAltitude,g=[t.x,t.y,0,1],_=[t.x,t.y,1,1];r.aA(g,g,this.pixelMatrixInverse),r.aA(_,_,this.pixelMatrixInverse);let v=_[3];r.cH(g,g,1/g[3]),r.cH(_,_,1/v);let E=g[2],T=_[2];return{p0:g,p1:_,t:E===T?0:(h-E)/(T-E)}}screenPointToMercatorRay(t){let o=[t.x,t.y,0,1],h=[t.x,t.y,1,1];return r.aA(o,o,this.pixelMatrixInverse),r.aA(h,h,this.pixelMatrixInverse),r.cH(o,o,1/o[3]),r.cH(h,h,1/h[3]),o[2]=r.cb(o[2],this._center.lat)*this.worldSize,h[2]=r.cb(h[2],this._center.lat)*this.worldSize,r.cH(o,o,1/this.worldSize),r.cH(h,h,1/this.worldSize),new r.av([o[0],o[1],o[2]],r.au([],r.at([],h,o)))}rayIntersectionCoordinate(t){let{p0:o,p1:h,t:g}=t,_=r.cb(o[2],this._center.lat),v=r.cb(h[2],this._center.lat);return new r.ac(r.ai(o[0],h[0],g)/this.worldSize,r.ai(o[1],h[1],g)/this.worldSize,r.ai(_,v,g))}pointCoordinate(t,o=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,o)}pointCoordinate3D(t,o){if(!this.elevation)return this.pointCoordinate(t,o);let h=this.projection.pointCoordinate3D(this,t.x,t.y);if(h)return new r.ac(h[0],h[1],h[2]);let g=0,_=this.horizonLineFromTop();if(t.y>_)return this.pointCoordinate(t,o);let v=.02*_,E=t.clone();for(let T=0;T<10&&_-g>v;T++){E.y=r.ai(g,_,.66);let C=this.projection.pointCoordinate3D(this,E.x,E.y);C?(_=E.y,h=C):g=E.y}return h?new r.ac(h[0],h[1],h[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=r.cI)return!this.isPointAboveHorizon(t);let o=this.pointCoordinate(t);return o.y>=0&&o.y<=1}_coordinatePoint(t,o){let h=o&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,g=[t.x*this.worldSize,t.y*this.worldSize,h+t.toAltitude(),1];return r.aA(g,g,this.pixelMatrix),g[3]>0?new r.P(g[0]/g[3],g[1]/g[3]):new r.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:t,left:o}=this._edgeInsets,h=this.height-this._edgeInsets.bottom,g=this.width-this._edgeInsets.right,_=this.pointLocation3D(new r.P(o,t)),v=this.pointLocation3D(new r.P(g,t)),E=this.pointLocation3D(new r.P(g,h)),T=this.pointLocation3D(new r.P(o,h)),C=Math.min(_.lng,v.lng,E.lng,T.lng),A=Math.max(_.lng,v.lng,E.lng,T.lng),L=Math.min(_.lat,v.lat,E.lat,T.lat),R=Math.max(_.lat,v.lat,E.lat,T.lat),F=Math.pow(2,-this.zoom)/16*270,V=this.projection.name==="globe"?1:4,z=(H,j,Z,Y,J)=>{let re=(H+Z)/2,ce=(j+Y)/2,de=new r.P(re,ce),{lng:ie,lat:oe}=this.pointLocation3D(de),se=Math.max(0,C-ie,L-oe,ie-A,oe-R);C=Math.min(C,ie),A=Math.max(A,ie),L=Math.min(L,oe),R=Math.max(R,oe),(J<V||se>F)&&(z(H,j,re,ce,J+1),z(re,ce,Z,Y,J+1))};if(z(o,t,g,t,1),z(g,t,g,h,1),z(g,h,o,h,1),z(o,h,o,t,1),this.projection.name==="globe"){let[H,j]=r.cJ(this);H?(R=90,A=180,C=-180):j&&(L=-90,A=180,C=-180)}return new r.aG(new r.ci(C,L),new r.ci(A,R))}_getBoundsRectangular(t,o){let{top:h,left:g}=this._edgeInsets,_=this.height-this._edgeInsets.bottom,v=this.width-this._edgeInsets.right,E=new r.P(g,h),T=new r.P(v,h),C=new r.P(v,_),A=new r.P(g,_),L=this.pointCoordinate(E,t),R=this.pointCoordinate(T,t),F=this.pointCoordinate(C,o),V=this.pointCoordinate(A,o),z=(H,j)=>(j.y-H.y)/(j.x-H.x);return L.y>1&&R.y>=0?L=new r.ac((1-V.y)/z(V,L)+V.x,1):L.y<0&&R.y<=1&&(L=new r.ac(-V.y/z(V,L)+V.x,0)),R.y>1&&L.y>=0?R=new r.ac((1-F.y)/z(F,R)+F.x,1):R.y<0&&L.y<=1&&(R=new r.ac(-F.y/z(F,R)+F.x,0)),new r.aG().extend(this.coordinateLocation(L)).extend(this.coordinateLocation(R)).extend(this.coordinateLocation(V)).extend(this.coordinateLocation(F))}_getBoundsRectangularTerrain(){let t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);let o=t.visibleDemTiles.reduce((h,g)=>{if(g.dem){let _=g.dem.tree;h.min=Math.min(h.min,_.minimums[0]),h.max=Math.max(h.max,_.maximums[0])}return h},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(o.min*t.exaggeration(),o.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){let o=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,h=this.height/2-o*(1-this._horizonShift);return t?Math.max(0,h):h}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-r.cG,this.maxLat=r.cG,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=r.aD(this.minLng)*this.tileSize,this.worldMaxX=r.aD(this.maxLng)*this.tileSize,this.worldMinY=r.aH(this.maxLat)*this.tileSize,this.worldMaxY=r.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,o){return this.projection.createTileMatrix(this,o,t)}calculateDistanceTileData(t){let o=t.key,h=this._distanceTileDataCache;if(h[o])return h[o];let g=t.canonical,_=1/this.height,v=this.cameraWorldSize,E=v/this.zoomScale(g.z),T=(g.x+Math.pow(2,g.z)*t.wrap)*E,C=g.y*E,A=this.point;A.x*=v/this.worldSize,A.y*=v/this.worldSize;let L=this.angle,R=Math.sin(-L),F=-Math.cos(-L);return h[o]={bearing:[R,F],center:[(A.x-T)*_,(A.y-C)*_],scale:E/r.aj*_},h[o]}calculateFogTileMatrix(t){let o=t.key,h=this._fogTileMatrixCache;if(h[o])return h[o];let g=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return r.az(g,this.worldToFogMatrix,g),h[o]=new Float32Array(g),h[o]}calculateProjMatrix(t,o=!1,h=!1){let g=t.key,_;if(_=h?this._expandedProjMatrixCache:o?this._alignedProjMatrixCache:this._projMatrixCache,_[g])return _[g];let v=this.calculatePosMatrix(t,this.worldSize),E;return E=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:h?this.expandedFarZProjMatrix:o?this.alignedProjMatrix:this.projMatrix,r.az(v,E,v),_[g]=new Float32Array(v),_[g]}calculatePixelsToTileUnitsMatrix(t){let o=t.tileID.key,h=this._pixelsToTileUnitsCache;if(h[o])return h[o];let g=r.cK(t,this);return h[o]=g,h[o]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let t=1/this.worldSize,o=r.bn([],[t,t,t]);return r.az(o,o,this.globeMatrix),o}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let t=this._elevation;this._updateCameraState();let o=r.cb(1,this._center.lat)*this.worldSize,h=this._computeCameraPosition(o),g=this._camera.forward(),_=r.cb(1,this._center.lat);h[2]/=_,g[2]/=_,r.au(g,g);let v=t.raycast(h,g,t.exaggeration());if(v){let E=r.bE([],h,g,v),T=new r.ac(E[0],E[1],r.cb(E[2],r.aY(E[1]))),C=(T.z+r.ae([T.x-h[0],T.y-h[1],T.z-h[2]*_]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(C),this._centerAltitude=T.toAltitude(),this._center=this.coordinateLocation(T),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;let o=this._elevation,h=r.cb(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(h),_=o.getAtPointOrZero(new r.ac(...g)),v=this.pixelsPerMeter/this.worldSize*_,E=this._minimumHeightOverTerrain(),T=g[2]-v;if(T<=E)if(T<0||t){let C=this.locationCoordinate(this._center,this._centerAltitude),A=[g[0],g[1],C.z-g[2]],L=r.ae(A);A[2]-=(E-T)/this._pixelsPerMercatorPixel;let R=r.ae(A);if(R===0)return;r.c1(A,A,L/R*this._pixelsPerMercatorPixel),this._camera.position=[g[0],g[1],C.z*this._pixelsPerMercatorPixel-A[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){let R=this.center;return R.lat=r.ay(R.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(R.lng=r.ay(R.lng,this.minLng,this.maxLng)),this.center=R,void(this._constraining=!1)}let o=this._unmodified,{x:h,y:g}=this.point,_=0,v=h,E=g,T=this.width/2,C=this.height/2,A=this.worldMinY*this.scale,L=this.worldMaxY*this.scale;if(g-C<A&&(E=A+C),g+C>L&&(E=L-C),L-A<this.height&&(_=Math.max(_,this.height/(L-A)),E=(L+A)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let R=this.worldMinX*this.scale,F=this.worldMaxX*this.scale,V=this.worldSize/2-(R+F)/2;v=(h+V+this.worldSize)%this.worldSize-V,v-T<R&&(v=R+T),v+T>F&&(v=F-T),F-R<this.width&&(_=Math.max(_,this.width/(F-R)),v=(F+R)/2)}v===h&&E===g||this._allowWorldUnderZoom||(this.center=this.unproject(new r.P(v,E))),_&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(_)),this._constrainCamera(),this._unmodified=o,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let t=this.centerOffset,o=this.projection.name==="globe",h=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=r.cb(1,this.center.lat)/r.cb(1,r.c$));let g=r.cL(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,g),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let _=this.projection.zAxisUnit==="meters"?h:1,v=this._camera.getWorldToCamera(this.worldSize,_),E,T=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(T[8]=2*-t.x/this.width,T[9]=2*t.y/this.height,this.isOrthographic){let oe=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),se=oe*this.aspect,Te=-se,me=-oe;se-=t.x,Te-=t.x,oe+=t.y,me+=t.y,E=this._camera.getCameraToClipOrthographic(Te,se,me,oe,this._nearZ,this._farZ),((Ne,Ae,Ve,Qe)=>{for(let Ie=0;Ie<16;Ie++)Ne[Ie]=r.ai(Ae[Ie],Ve[Ie],Qe)})(E,E,T,r.cZ(this.pitch>=fi?1:this.pitch/fi))}else E=T;let C=r.cM([],T,v),A=r.cM([],E,v);if(this.projection.isReprojectedInTileSpace){let oe=this.locationCoordinate(this.center),se=r.bx([]);r.bo(se,se,[oe.x*this.worldSize,oe.y*this.worldSize,0]),r.az(se,se,r.cN(this)),r.bo(se,se,[-oe.x*this.worldSize,-oe.y*this.worldSize,0]),r.az(A,A,se),r.az(C,C,se),this.inverseAdjustmentMatrix=r.cO(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=r.cP([],A,[this.worldSize,this.worldSize,this.worldSize/_,1]),this.projMatrix=A,this.invProjMatrix=r.bi(new Float64Array(16),this.projMatrix),o){let oe=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);oe[8]=2*-t.x/this.width,oe[9]=2*t.y/this.height,this.expandedFarZProjMatrix=r.cM([],oe,v)}else this.expandedFarZProjMatrix=this.projMatrix;let L=r.bi([],E);this.frustumCorners=r.cQ.fromInvProjectionMatrix(L,this.horizonLineFromTop(),this.height),this.cameraFrustum=r.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!o);let R=new Float32Array(16);r.bx(R),r.cP(R,R,[1,-1,1]),r.cR(R,R,this._pitch),r.by(R,R,this.angle);let F=r.c9(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=r.bw(F);let V=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;F[8]=2*-t.x/this.width,F[9]=2*(t.y+V)/this.height,this.skyboxMatrix=r.az(R,F,R);let z=this.point,H=z.x,j=z.y,Z=this.width%2/2,Y=this.height%2/2,J=Math.cos(this.angle),re=Math.sin(this.angle),ce=H-Math.round(H)+J*Z+re*Y,de=j-Math.round(j)+J*Y+re*Z,ie=new Float64Array(A);if(r.bo(ie,ie,[ce>.5?ce-1:ce,de>.5?de-1:de,0]),this.alignedProjMatrix=ie,A=r.bz(),r.cP(A,A,[this.width/2,-this.height/2,1]),r.bo(A,A,[1,-1,0]),this.labelPlaneMatrix=A,A=r.bz(),r.cP(A,A,[1,-1,1]),r.bo(A,A,[-1,-1,0]),r.cP(A,A,[2/this.width,2/this.height,1]),this.glCoordMatrix=A,this.pixelMatrix=r.az(new Float64Array(16),this.labelPlaneMatrix,C),this._calcFogMatrices(),this._distanceTileDataCache={},A=r.bi(new Float64Array(16),this.pixelMatrix),!A)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=A,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=r.cS(this);let oe=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=r.ad(oe,oe,v),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=A;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let t=this.cameraWorldSizeForFog,o=this.cameraPixelsPerMeter,h=this._camera.position,g=1/this.height/this._pixelsPerMercatorPixel,_=[t,t,o];r.c1(_,_,g),r.c1(h,h,-1),r.cT(h,h,_);let v=r.bz();r.bo(v,v,h),r.cP(v,v,_),this.mercatorFogMatrix=v,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,o,g)}_computeCameraPosition(t){let o=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,h=this._camera.forward(),g=this.point,_=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*o-t/this.worldSize*this._centerAltitude;return[g.x/this.worldSize-h[0]*_,g.y/this.worldSize-h[1]*_,t/this.worldSize*this._centerAltitude-h[2]*_]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){let o=this._maxCameraBoundsDistance()*Math.cos(this._pitch),h=this._camera.position[2],g=t[2],_=1;this.projection.wrap&&(this.center=this.center.wrap()),g>0&&(_=Math.min((o-h)/g,1)),this._camera.position=r.bE([],this._camera.position,t,_),this._updateStateFromCamera()}_updateStateFromCamera(){let t=this._camera.position,o=this._camera.forward(),{pitch:h,bearing:g}=this._camera.getPitchBearing(),_=r.cb(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,v=this._mercatorZfromZoom(this._maxZoom)*Math.cos(r.al(this._maxPitch)),E=Math.max((t[2]-_)/Math.cos(h),v),T=this._zoomFromMercatorZ(E);r.bE(t,t,o,E),this._pitch=r.ay(h,r.al(this.minPitch),r.al(this.maxPitch)),this.angle=r.bQ(g,-Math.PI,Math.PI),this._setZoom(r.ay(T,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new r.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){let t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let o=0,h=r.cI,g=0,_=1/0;for(;h-o>1e-6&&h>o;){let v=o+.5*(h-o),E=this.tileSize*Math.pow(2,v),T=this.getCameraToCenterDistance(this.projection,v,E),C=this.scaleZoom(T/(Math.max(0,t)*this.tileSize)),A=Math.abs(v-C);A<_&&(_=A,g=v),v<C?o=v:h=v}return g}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(r.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,o){let h=Math.min(t.x,o.x),g=Math.max(t.x,o.x),_=Math.min(t.y,o.y),v=Math.max(t.y,o.y);if(_<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let E=[new r.P(h,_),new r.P(g,v),new r.P(h,v),new r.P(g,_)],T=this.renderWorldCopies?-3:0,C=this.renderWorldCopies?4:1;for(let A of E){let L=this.pointRayIntersection(A);if(L.t<0)return!0;let R=this.rayIntersectionCoordinate(L);if(R.x<T||R.y<0||R.x>C||R.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+r.cU(this.fovAboveCenter)>88||this.anyCornerOffEdge(new r.P(0,0),new r.P(this.width,this.height))}zoomDeltaToMovement(t,o){let h=r.ae(r.at([],this._camera.position,t)),g=this._zoomFromMercatorZ(h)+o;return h-this._mercatorZfromZoom(g)}getCameraPoint(){if(this.projection.name==="globe"){let t=function([o,h,g],_){let v=[o,h,g,1];r.aA(v,v,_);let E=v[3]=Math.max(v[3],1e-6);return v[0]/=E,v[1]/=E,v[2]/=E,v}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new r.P(t[0],t[1])}{let t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new r.P(0,t))}}getCameraToCenterDistance(t,o=this.zoom,h=this.worldSize){let g=r.cL(t,o,this.width,this.height,1024),_=t.pixelSpaceConversion(this.center.lat,h,g),v=.5/Math.tan(.5*this._fov)*this.height*_;return this.isOrthographic&&(v=r.ai(1,v,r.cZ(this.pitch>=fi?1:this.pitch/fi))),v}getWorldToCameraMatrix(){let t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&r.az(t,t,this.globeMatrix),t}getFrustum(t){return r.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}let Ts=(d,t)=>{if(t>0&&d.terrain&&r.w("Cutoff is currently disabled on terrain"),t<=0||d.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let o=d.transform,h=Math.max(Math.abs(o._zoom-(d.minCutoffZoom-1)),1),g=o.isLODDisabled(!1)?r.af(60,45,o.pitch):r.af(30,15,o.pitch),_=o._farZ-o._nearZ,v=t*o.height,E=((1-(T=g))*o.cameraToCenterDistance+T*(o._farZ+v))*h;var T;return{shouldRenderCutoff:g<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(E-o._nearZ)/_,(E-v-o._nearZ)/_]}}},Oi={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Fu{constructor(t,o){this.aabb=t,this.lastCascade=o}}class Db{add(t,o){let h=this.receivers[t.key];h!==void 0?(h.aabb.min[0]=Math.min(h.aabb.min[0],o.min[0]),h.aabb.min[1]=Math.min(h.aabb.min[1],o.min[1]),h.aabb.min[2]=Math.min(h.aabb.min[2],o.min[2]),h.aabb.max[0]=Math.max(h.aabb.max[0],o.max[0]),h.aabb.max[1]=Math.max(h.aabb.max[1],o.max[1]),h.aabb.max[2]=Math.max(h.aabb.max[2],o.max[2])):this.receivers[t.key]=new Fu(o,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,o,h){let g=r.d6.fromPoints(t.points),_=0;for(let v in this.receivers){let E=this.receivers[v];if(!E||!g.intersectsAabb(E.aabb))continue;E.aabb.min=g.closestPoint(E.aabb.min),E.aabb.max=g.closestPoint(E.aabb.max);let T=E.aabb.getCorners();for(let C=0;C<h.length;C++){let A=!0;for(let L of T){let R=[L[0]*o,L[1]*o,L[2]];if(r.ad(R,R,h[C].matrix),R[0]<-1||R[0]>1||R[1]<-1||R[1]>1){A=!1;break}}if(E.lastCascade=C,_=Math.max(_,C),A)break}}return _+1}}class Cb{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Db,this._depthMode=new gt(t.context.gl.LEQUAL,gt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(Oi,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(Oi,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(Oi,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,o){let h=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!o||!o.properties)return;let g=o.properties.get("shadow-intensity");if(!o.shadowsEnabled()||g<=0||(this._shadowLayerCount=h.style.order.reduce((V,z)=>{let H=h.style._mergedLayers[z];return V+(H.hasShadowPass()&&!H.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let _=h.context,v=Oi.shadowMapResolution,E=Oi.shadowMapResolution;if(this._cascades.length===0||Oi.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let V=0;V<Oi.cascadeCount;++V){let z=h._shadowMapDebug,H=_.gl,j=_.createFramebuffer(v,E,z,"texture"),Z=new r.T(_,{width:v,height:E,data:null},H.DEPTH_COMPONENT16);if(j.depthAttachment.set(Z.texture),z){let Y=new r.T(_,{width:v,height:E,data:null},H.RGBA8);j.colorAttachment.set(Y.texture)}this._cascades.push({framebuffer:j,texture:Z,matrix:[],far:0,boundingSphereRadius:0,frustum:new r.cy,scale:0})}}this.shadowDirection=rc(o);let T=0;if(t.elevation){let V=t.elevation,z=[1e4,-1e4];V.visibleDemTiles.filter(H=>H.dem).forEach(H=>{let j=H.dem.tree;z[0]=Math.min(z[0],j.minimums[0]),z[1]=Math.max(z[1],j.maximums[0])}),z[0]!==1e4&&(T=(z[1]-z[0])*V.exaggeration())}let C=1.5*t.cameraToCenterDistance,A=3*C,L=new Float64Array(16);for(let V=0;V<this._cascades.length;++V){let z=this._cascades[V],H=t.height/50,j=1;Oi.cascadeCount===1?j=A:V===0?j=C:(H=C,j=A);let[Z,Y]=ic(t,this.shadowDirection,H,j,Oi.shadowMapResolution,T);z.scale=t.scale,z.matrix=Z,z.boundingSphereRadius=Y,r.bi(L,z.matrix),z.frustum=r.cy.fromInvProjectionMatrix(L,1,0,!0),z.far=j}let R=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[R].far,this._cascades[R].far],this._uniformValues.u_shadow_intensity=g,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Oi.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Oi.shadowMapResolution,this._uniformValues.u_shadowmap_0=Vi.ShadowMap0,this._uniformValues.u_shadowmap_1=Vi.ShadowMap0+1,this._groundShadowTiles=h.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let F=h.transform.elevation;for(let V of this._groundShadowTiles){let z={min:0,max:0};if(F){let H=F.getMinMaxForTile(V);H&&(z=H)}this.addShadowReceiver(V.toUnwrapped(),z.min,z.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,o){if(!this.enabled)return;let h=this.painter,g=h.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(h.transform.getFrustum(0),h.transform.worldSize,this._cascades),g.viewport.set([0,0,Oi.shadowMapResolution,Oi.shadowMapResolution]);for(let _=0;_<this._numCascadesToRender;++_){h.currentShadowCascade=_,g.bindFramebuffer.set(this._cascades[_].framebuffer.framebuffer),g.clear({color:r.am.white,depth:1});for(let v of t.order){let E=t._mergedLayers[v];if(!E.hasShadowPass()||E.isHidden(h.transform.zoom))continue;let T=t.getLayerSourceCache(E),C=T?o[T.id]:void 0;(E.type==="model"||C&&C.length)&&h.renderLayer(h,T,E,C)}}h.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let t=this.painter,o=t.style,h=t.context,g=h.gl,_=o.directionalLight,v=o.ambientLight;if(!_||!v)return;let E=[],T=Ts(t,t.longestCutoffRange);T.shouldRenderCutoff&&E.push("RENDER_CUTOFF"),E.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&E.push("NORMAL_OFFSET");let C=ll(o,_,v),A=new gt(g.LEQUAL,gt.ReadOnly,t.depthRangeFor3D),L=new Lt({func:g.EQUAL,mask:255},0,255,g.KEEP,g.KEEP,g.KEEP);for(let R of this._groundShadowTiles){let F=R.toUnwrapped(),V=t.isTileAffectedByFog(R),z=t.getOrCreateProgram("groundShadow",{defines:E,overrideFog:V});this.setupShadows(F,z),t.uploadCommonUniforms(h,z,F,null,T);let H={u_matrix:t.transform.calculateProjMatrix(F),u_ground_shadow_factor:C};z.draw(t,g.TRIANGLES,A,L,Yt.multiply,Mt.disabled,H,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Yt.unblended:Yt.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){let o=this.painter.transform,h=o.calculatePosMatrix(t,o.worldSize);return r.az(h,this._cascades[this.painter.currentShadowCascade].matrix,h),Float32Array.from(h)}calculateShadowPassMatrixFromMatrix(t){return r.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,o,h){if(!this.enabled)return;let g=this.painter.transform,_=this.painter.context,v=_.gl,E=this._uniformValues,T=new Float64Array(16),C=g.calculatePosMatrix(t,g.worldSize);for(let A=0;A<this._cascades.length;A++)r.az(T,this._cascades[A].matrix,C),E[A===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(T),_.activeTexture.set(v.TEXTURE0+Vi.ShadowMap0+A),this._cascades[A].texture.bindExtraParam(v.LINEAR,v.LINEAR,v.CLAMP_TO_EDGE,v.CLAMP_TO_EDGE,v.GREATER);if(this.useNormalOffset=!!h,this.useNormalOffset){let A=r.d4(t.canonical),L=2/g.tileSize*r.aj/Oi.shadowMapResolution,R=L*this._cascades[0].boundingSphereRadius,F=L*this._cascades[this._cascades.length-1].boundingSphereRadius,V=(h==="vector-tile"?1:3)*function(z,H,j,Z,Y){let J=r.ay((z-22)/-22,0,1);return .125*(1-J)+4*J}(g.zoom);E.u_shadow_normal_offset=[A,R*V,F*V],E.u_shadow_bias=[1e-4,.0012,.012]}else E.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(_,E)}setupShadowsFromMatrix(t,o,h=!1){if(!this.enabled)return;let g=this.painter.context,_=g.gl,v=this._uniformValues,E=new Float64Array(16);for(let T=0;T<Oi.cascadeCount;T++)r.az(E,this._cascades[T].matrix,t),v[T===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(E),g.activeTexture.set(_.TEXTURE0+Vi.ShadowMap0+T),this._cascades[T].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=h,h){let T=Oi.normalOffset;v.u_shadow_normal_offset=[1,T,T],v.u_shadow_bias=[6e-5,.0012,.012]}else v.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(g,v)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,o,h,g){if(g[2]>=0)return{};let _=function(T,C,A){let L=A/(1<<T.canonical.z);return new r.d6([T.canonical.x*L+T.wrap*A,T.canonical.y*L+T.wrap*A,0],[(T.canonical.x+1)*L+T.wrap*A,(T.canonical.y+1)*L+T.wrap*A,C])}(t,o,h).getCorners(),v=o/-g[2];g[0]<0?(r.d5(_[0],_[0],[g[0]*v,0,0]),r.d5(_[3],_[3],[g[0]*v,0,0])):g[0]>0&&(r.d5(_[1],_[1],[g[0]*v,0,0]),r.d5(_[2],_[2],[g[0]*v,0,0])),g[1]<0?(r.d5(_[0],_[0],[0,g[1]*v,0]),r.d5(_[1],_[1],[0,g[1]*v,0])):g[1]>0&&(r.d5(_[2],_[2],[0,g[1]*v,0]),r.d5(_[3],_[3],[0,g[1]*v,0]));let E={};return E.vertices=_,E.planes=[xa(_[1],_[0],_[4]),xa(_[2],_[1],_[5]),xa(_[3],_[2],_[6]),xa(_[0],_[3],_[7])],E}addShadowReceiver(t,o,h){this._receivers.add(t,r.d6.fromTileIdAndHeight(t,o,h))}getMaxCascadeForTile(t){let o=this._receivers.get(t);return o&&o.lastCascade?o.lastCascade:0}}function xa(d,t,o){let h=r.at([],o,t),g=r.at([],d,t),_=r.bF([],h,g),v=r.ae(_);return v===0?[0,0,1,0]:(r.c1(_,_,1/v),[_[0],_[1],_[2],-r.bG(_,t)])}function rc(d){let t=d.properties.get("direction"),o=r.d1(t.x,t.y,t.z);o[2]=r.ay(o[2],0,75);let h=r.d3([o[0],o[1],o[2]]);return r.d2(h.x,h.y,h.z)}function ll(d,t,o){let h=t.properties.get("color-use-theme")==="none",g=t.properties.get("color"),_=t.properties.get("intensity"),v=t.properties.get("direction"),E=[v.x,v.y,v.z],T=o.properties.get("color-use-theme")==="none",C=o.properties.get("color"),A=o.properties.get("intensity"),L=Math.max(r.bG([0,0,1],E),0),R=[0,0,0];r.c1(R,C.toPremultipliedRenderColor(T?null:d.getLut(t.scope)).toArray01Linear().slice(0,3),A);let F=[0,0,0];return r.c1(F,g.toPremultipliedRenderColor(h?null:d.getLut(o.scope)).toArray01Linear().slice(0,3),L*_),r.d8([R[0]>0?R[0]/(R[0]+F[0]):0,R[1]>0?R[1]/(R[1]+F[1]):0,R[2]>0?R[2]/(R[2]+F[2]):0])}function ic(d,t,o,h,g,_){let v=d.zoom,E=d.scale,T=d.worldSize,C=1/T,A=d.aspect,L=Math.sqrt(1+A*A)*Math.tan(.5*d.fovX),R=L*L,F=h-o,V=h+o,z,H;R>F/V?(z=h,H=h*L):(z=.5*V*(1+R),H=.5*Math.sqrt(F*F+2*(h*h+o*o)*R+V*V*R*R));let j=d.projection.pixelsPerMeter(d.center.lat,T),Z=d._camera.getCameraToWorldMercator(),Y=[0,0,-z*C];r.ad(Y,Y,Z);let J=H*C,re=d._edgeInsets;if(!(re.left===0&&re.top===0&&re.right===0&&re.bottom===0||re.left===re.right&&re.top===re.bottom)){let He=d._camera.getWorldToCamera(d.worldSize,d.projection.zAxisUnit==="meters"?j:1),Ge=d._camera.getCameraToClipPerspective(d._fov,d.width/d.height,o,h);Ge[8]=2*-d.centerOffset.x/d.width,Ge[9]=2*d.centerOffset.y/d.height;let We=new Float64Array(16);r.cM(We,Ge,He);let ot=new Float64Array(16);r.bi(ot,We);let bt=r.cy.fromInvProjectionMatrix(ot,T,v,!0);for(let St of bt.points){let ft=((ce=St)[0]/=E,ce[1]/=E,ce[2]=r.cb(ce[2],d._center.lat),ce);J=Math.max(J,r.c2(r.d7([],Y,ft)))}}var ce;J*=g/(g-1);let de=Math.acos(t[2]),ie=Math.atan2(-t[0],-t[1]),oe=new Ko;oe.position=Y,oe.setPitchBearing(de,ie);let se=oe.getWorldToCamera(T,j),Te=J*T,me=Math.min(d._mercatorZfromZoom(17)*T*-2,-2*Te),Ne=oe.getCameraToClipOrthographic(-Te,Te,-Te,Te,me,(Te+_*j)/t[2]),Ae=new Float64Array(16);r.az(Ae,Ne,se);let Ve=r.d2(Math.floor(1e6*Y[0])/1e6*T,Math.floor(1e6*Y[1])/1e6*T,0),Qe=.5*g,Ie=[0,0,0];r.ad(Ie,Ve,Ae),r.c1(Ie,Ie,Qe);let pe=[Math.floor(Ie[0]),Math.floor(Ie[1]),Math.floor(Ie[2])],Pe=[0,0,0];r.at(Pe,Ie,pe),r.c1(Pe,Pe,-1/Qe);let Se=new Float64Array(16);return r.bx(Se),r.bo(Se,Se,Pe),r.az(Ae,Se,Ae),[Ae,Te]}class K_ extends r.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,o){return r.aS(this.requestManager.transformRequest(o,r.R.Model).url).then(h=>{if(!h)return;let g=r.aT(h),_=new r.aU(t,void 0,void 0,g);return _.computeBoundsAndApplyParent(),_}).catch(h=>{if(h&&h.status===404)return null;this.fire(new r.z(new Error(`Could not load model ${t} from ${o}: ${h.message}`)))})}load(t,o,h={forceReload:!1}){this.models[o]||(this.models[o]={});let g=Object.keys(t),_=[],v=[];for(let E of g){let T=t[E];this.hasURLBeenRequested(T)&&!h.forceReload||(this.modelByURL[T]={modelId:E,scope:o},_.push(this.loadModel(E,T)),v.push(E)),this.models[o][E]||(this.models[o][E]={model:null,numReferences:1})}this.numModelsLoading[o]=(this.numModelsLoading[o]||0)+v.length,Promise.allSettled(_).then(E=>{for(let T=0;T<E.length;T++){let{status:C}=E[T];if(C==="rejected")continue;let{value:A}=E[T];this.models[o][v[T]]||(this.models[o][v[T]]={model:null,numReferences:1}),this.models[o][v[T]].model=A}this.numModelsLoading[o]-=v.length,this.fire(new r.A("data",{dataType:"style"}))}).catch(E=>{this.fire(new r.z(new Error(`Could not load models: ${E.message}`)))})}isLoaded(){for(let t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,o,h={exactIdMatch:!1}){return!!(h.exactIdMatch?this.getModel(t,o):this.getModelByURL(this.modelUris[o][t]))}getModel(t,o){return this.models[o]||(this.models[o]={}),this.models[o][t]?this.models[o][t].model:void 0}getModelByURL(t){if(!t)return null;let o=this.modelByURL[t];return o?this.models[o.scope][o.modelId].model:null}hasModelBeenAdded(t,o){return this.models[o]&&this.models[o][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,o,h){this.models[h]||(this.models[h]={}),this.modelUris[h]||(this.modelUris[h]={});let g=this.requestManager.normalizeModelURL(o);if((this.hasModel(t,h,{exactIdMatch:!0})||this.hasModelBeenAdded(t,h))&&this.modelUris[h][t]===g)this.models[h][t].numReferences++;else if(this.hasURLBeenRequested(g)){let{scope:_,modelId:v}=this.modelByURL[g];this.models[_][v].numReferences++}else this.modelUris[h][t]=g,this.load({[t]:this.modelUris[h][t]},h)}addModelURLs(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h=this.modelUris[o];for(let g in t)h[g]=this.requestManager.normalizeModelURL(t[g])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h={};for(let g of t)this.hasModel(g,o,{exactIdMatch:!0})||this.hasURLBeenRequested(g)?this.models[o][g].numReferences++:this.modelUris[o][g]&&!this.hasURLBeenRequested(g)?h[g]=this.modelUris[o][g]:!this.hasURLBeenRequested(g)&&r.d9(g,!1)&&(this.modelUris[o][g]=this.requestManager.normalizeModelURL(g),h[g]=this.modelUris[o][g]);this.load(h,o)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,o,h=!1,g=!1){if(this.models[o]&&this.models[o][t]&&(this.models[o][t].numReferences--,this.models[o][t].numReferences===0||g)){let _=this.modelUris[o][t];h||delete this.modelUris[o][t],delete this.modelByURL[_];let v=this.models[o][t].model;if(!v)return;delete this.models[o][t],v.destroy()}}destroy(){for(let t of Object.keys(this.models))for(let o of Object.keys(this.models[t])){let h=this.models[t][o].model;delete this.models[t][o],h&&h.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,o){this.models[o]||(this.models[o]={});for(let h in this.models[o])this.models[o][h].model&&this.models[o][h].model.upload(t.context)}}let oh=new r.a7({data:new r.a8(r.a5.colorTheme.data)});class Mp{constructor(t){this._scope=t,this._buildingQueryParams={target:{featuresetId:"building-outline",importId:this._scope}},this._floorQueryParams={target:{featuresetId:"floor-outline",importId:this._scope}}}execute(t){let o=this._makeBuildingsQueryArea(t),h=this._makeFloorsQueryArea(t),g=t.queryRenderedFeatures(o,this._buildingQueryParams).filter(E=>E.properties.shape_type==="building").reduce((E,T)=>{let C=T.properties.id;return T.properties.shape_type!=="building"||E.some(A=>A.properties.id===C)||E.push(T),E},[]),_=t.queryRenderedFeatures(h,this._floorQueryParams).filter(E=>E.properties.shape_type==="floor").reduce((E,T)=>{let C=T.properties.id;return T.properties.shape_type!=="floor"||E.some(A=>A.properties.id===C)||E.push(T),E},[]),v=[t.getCenter().lng,t.getCenter().lat];return{floors:_,building:this._findBuildingAtCenter(v,g)||(g.length>0?g[0]:null)}}_makeBuildingsQueryArea(t){let o=t.transform.width,h=t.transform.height,g=Math.min(o,h),_=g*(1/8),v=g*(1/8),E=.5*(o-_),T=.5*(h-v);return[new r.P(E,T),new r.P(E+_,T+v)]}_makeFloorsQueryArea(t){let o=t.transform.width,h=t.transform.height,g=o*(2/3),_=h*(2/3),v=.5*(o-g),E=.5*(h-_);return[new r.P(v,E),new r.P(v+g,E+_)]}_findBuildingAtCenter(t,o){for(let h of o)if(h.geometry.type==="Polygon"&&this._pointInPolygon(t,h.geometry.coordinates[0]))return h;return null}_pointInPolygon(t,o){let h=!1;for(let g=0,_=o.length-1;g<o.length;_=g++){let v=o[g][0],E=o[g][1],T=o[_][1];E>t[1]!=T>t[1]&&t[0]<(o[_][0]-v)*(t[1]-E)/(T-E)+v&&(h=!h)}return h}}class ba{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}setBuildingId(t){this._selectedBuildingId=t}setFloors(t){if(this._floors=t.filter(o=>o.properties.building_id===this._selectedBuildingId),!this._selectedFloorId||!this._floors.map(o=>o.properties.id).includes(this._selectedFloorId)){let o=this._floors.map(h=>({id:h.properties.id,level:h.properties.floor_level})).reduce((h,g)=>{let _=Math.abs(h.level-1),v=Math.abs(g.level-1);return v<_||v===_&&g.level>h.level?g:h});this._selectedFloorId=o.id}}setFloorId(t){this._selectedFloorId=t}getSelectedFloorId(){return this._selectedFloorId}getCurrentBuildingFloors(){return this._floors}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}}let Ab={"mbx-indoor-level-selected":{default:["literal",[]]}};function J_(d){return d=d||{},Object.assign(d,Ab)}class Mb extends r.E{constructor(t){super(),r.aV(["_onLoad","_onMove"],this),this._map=t,this._floorSelectionState=new ba,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=null,this._floorSelectionState=null}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new r.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=t.scope,this._indoorDataQuery=new Mp(this._scope)))}),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<16)return void this._clearIndoorData();let t=this._indoorDataQuery.execute(this._map);t&&t.floors.length!==0?(this._floorSelectionState.getSelectedFloorId()||this._map._addIndoorControl(),this._selectFloors(t)):this._clearIndoorData()}_selectFloors(t){if(t.building)this._floorSelectionState.setBuildingId(t.building.properties.id),this._floorSelectionState.setFloors(t.floors),this._updateUI();else{let o=this._floorSelectionState.getSelectedFloorId();if(o&&t.floors.some(h=>h.properties.id===o))return;this._clearIndoorData()}}_clearIndoorData(){this._floorSelectionState.reset(),this._map._removeIndoorControl(),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[]])}_updateUI(){let t=this._floorSelectionState.getCurrentBuildingFloors().map(h=>({id:h.properties.id,name:h.properties.name,shortName:h.properties.floor_level,levelOrder:h.properties.floor_level})),o=this._floorSelectionState.getSelectedFloorId();o?(this._updateIndoorConfig(),this.fire(new r.A("indoorupdate",{selectedFloorId:o,floors:t}))):console.warn("IndoorManager: Selected floor is not set")}_updateIndoorConfig(){let t=this._floorSelectionState.getSelectedFloorId();t?this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[t]]):console.warn("IndoorManager: Selected floor is not set")}selectFloor(t){this._floorSelectionState.setFloorId(t),this._updateIndoorConfig()}}function Q_(d){if(!d.metadata||!d.metadata.content_area)return;let t=r.q.devicePixelRatio,{left:o,top:h,width:g,height:_}=d.metadata.content_area,v=o*t,E=h*t;return[v,E,v+g*t,E+_*t]}function ey(d){if(d)return d.map(([t,o])=>[t*r.q.devicePixelRatio,o*r.q.devicePixelRatio])}class Rp{constructor(t,o,h){this.id=t,this.scope=o,this.sourceCache=h,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){let t=new Map;if(!this.sourceCache.loaded())return t;let o=this.sourceCache.getVisibleCoordinates();if(o.length===0)return t;let h=this.sourceCache.getSource();if(!(h instanceof ga))return t;let g=o.map(v=>this.sourceCache.getTile(v)),_=h.getImages(g,Array.from(this.pendingRequests));for(let[v,E]of _)t.set(r.I.from({name:v,iconsetId:this.id}),E),this.pendingRequests.delete(v);for(let v of this.pendingRequests)this.missingRequests.add(v);return this.pendingRequests.clear(),t}}let wa=(d,t)=>ne(d,t&&t.filter(o=>o.identifier!=="source.canvas")),ty=r.aF(xn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),ny=r.aF(xn,["setCenter","setZoom","setBearing","setPitch"]),sh=new Set(["background","sky","slot","custom"]),Ea={version:8,layers:[],sources:{}},ku={duration:300,delay:0};class Jo extends r.E{constructor(t,o={}){super(),this.map=t,this.scope=o.scope||"",this.globalId=null,this.fragments=[],this.importDepth=o.importDepth||0,this.importsCache=o.importsCache||new Map,this.resolvedImports=o.resolvedImports||new Set,this.transition=r.h({},ku),this._buildingIndex=new H_(this),this.crossTileSymbolIndex=new to,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=o.styleChanges||new lu,this.dispatcher=o.dispatcher?o.dispatcher:new r.D(r.db(),this),o.imageManager?this.imageManager=o.imageManager:(this.imageManager=new zr(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=o.glyphManager?o.glyphManager:new r.dc(t._requestManager,o.localFontFamily?r.dd.all:o.localIdeographFontFamily?r.dd.ideographs:r.dd.none,o.localFontFamily||o.localIdeographFontFamily),o.modelManager?this.modelManager=o.modelManager:(this.modelManager=new K_(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=o.configOptions?o.configOptions:new Map,this._configDependentLayers=o.configDependentLayers?o.configDependentLayers:new Set,this._config=o.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:o.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=o.initialConfig,this.dispatcher.broadcast("setReferrer",r.de());let h=this;this._rtlTextPluginCallback=Jo.registerForPluginStateChange(g=>{h.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:g.pluginStatus,pluginURL:g.pluginURL},(_,v)=>{if(r.df(_),v&&v.every(E=>E))for(let E in h._sourceCaches){let T=h._sourceCaches[E],C=T.getSource().type;C!=="vector"&&C!=="geojson"||T.reload()}})}),this.on("data",g=>{if(g.dataType!=="source"||g.sourceDataType!=="metadata")return;let _=this.getOwnSource(g.sourceId);if(_&&_.vectorLayerIds)for(let v in this._layers){let E=this._layers[v];E.source===_.id&&this._validateLayer(E)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(r.j(t))return t;let o=r.dg(t);if(!o.startsWith("http"))try{return new URL(o,location.href).toString()}catch{return o}return o}return`json://${r.dh(JSON.stringify(t))}`}_diffStyle(t,o,h){this.globalId=this._getGlobalId(t);let g=(_,v)=>{try{v(null,this.setState(_,h))}catch(E){v(E,!1)}};if(typeof t=="string"){let _=this.map._requestManager.normalizeStyleURL(t),v=this.map._requestManager.transformRequest(_,r.R.Style);r.n(v,(E,T)=>{E?this.fire(new r.z(E)):T&&g(T,o)})}else typeof t=="object"&&g(t,o)}loadURL(t,o={}){this.fire(new r.A("dataloading",{dataType:"style"}));let h=typeof o.validate=="boolean"?o.validate:!r.j(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,o.accessToken),this.resolvedImports.add(t);let g=this.importsCache.get(t);if(g)return this._load(g,h);let _=this.map._requestManager.transformRequest(t,r.R.Style);this._request=r.n(_,(v,E)=>{if(this._request=null,v)this.fire(new r.z(v));else if(E)return this.importsCache.set(t,E),this._load(E,h)})}loadJSON(t,o={}){this.fire(new r.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=r.q.frame(()=>{this._request=null,this._load(t,o.validate!==!1)})}loadEmpty(){this.fire(new r.A("dataloading",{dataType:"style"})),this._load(Ea,!1)}_loadImports(t,o,h){if(this.importDepth>=4)return r.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let g=[];for(let _ of t){let v=this._createFragmentStyle(_),E=new Promise(A=>{v.once("style.import.load",A),v.once("error",A)}).then(()=>this.mergeAll());if(g.push(E),this.resolvedImports.has(_.url)){v.loadEmpty();continue}let T=_.data||this.importsCache.get(_.url);T?(v.loadJSON(T,{validate:o}),this._isInternalStyle(T)&&(v.globalId=null)):_.url?v.loadURL(_.url,{validate:o}):v.loadEmpty();let C={style:v,id:_.id,config:_.config};if(h){let A=this.fragments.findIndex(({id:L})=>L===h);this.fragments=this.fragments.slice(0,A).concat(C).concat(this.fragments.slice(A))}else this.fragments.push(C)}return Promise.allSettled(g)}getImportGlobalIds(t=this,o=new Set){for(let h of t.fragments)h.style.globalId&&o.add(h.style.globalId),this.getImportGlobalIds(h.style,o);return[...o.values()]}_createFragmentStyle(t){let o=this.scope?r.C(t.id,this.scope):t.id,h,g=this._initialConfig&&this._initialConfig[o];(t.config||g)&&(h=r.h({},t.config,g));let _=new Jo(this.map,{scope:o,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:h,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return _.setEventedParent(this.map,{style:_}),_}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,o){let h=t.indoor?J_(t.schema):t.schema;if(this._isInternalStyle(t)){let v=r.h({},Ea,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(v,o)}if(this.updateConfig(this._config,h),o&&wa(this,So(t)))return;this._loaded=!0,this.stylesheet=r.di(t);let g=()=>{for(let C in t.sources)this.addSource(C,t.sources[C],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(let C in t.iconsets)this.addIconset(C,t.iconsets[C]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);let v=wu(this.stylesheet.layers);if(this._order=v.map(C=>C.id),this.stylesheet.light&&r.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let C=this.stylesheet.lights[0];this.light=new Me(C.properties,C.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Me(this.stylesheet.light)),this._layers={};for(let C of v){let A=r.dn(C,this.scope,this._styleColorTheme.lut,this.options);A.configDependencies.size!==0&&this._configDependentLayers.add(A.fqid),A.setEventedParent(this,{layer:{id:A.id}}),this._layers[A.id]=A;let L=this.getOwnLayerSourceCache(A),R=!!this.directionalLight&&this.directionalLight.shadowsEnabled();L&&A.canCastShadows()&&R&&(L.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);let E=this.stylesheet.terrain;E&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(E,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new r.A("data",{dataType:"style"}));let T=this.isRootStyle();t.imports?this._loadImports(t.imports,o).then(()=>{this._reloadImports(),this.fire(new r.A(T?"style.load":"style.import.load"))}).catch(C=>{this.fire(new r.z(new Error("Failed to load imports",C))),this.fire(new r.A(T?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new r.A(T?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let _=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(_){let v=this._evaluateColorThemeData(_);this._loadColorTheme(v).then(()=>{g()}).catch(E=>{r.w(`Couldn't load color theme from the stylesheet: ${E}`),g()})}else this._styleColorTheme.lut=null,g()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,o,h,g,_,v,E,T,C,A,L={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(R=>{if(R.stylesheet){if(R.light!=null&&(t=R.light),R.stylesheet.lights)for(let F of R.stylesheet.lights)F.type==="ambient"&&R.ambientLight!=null&&(o=R.ambientLight),F.type==="directional"&&R.directionalLight!=null&&(h=R.directionalLight);g=this._prioritizeTerrain(g,R.terrain,R.stylesheet.terrain),R.stylesheet.fog&&R.fog!=null&&(_=R.fog),R.stylesheet.snow&&R.snow!=null&&(v=R.snow),R.stylesheet.rain&&R.rain!=null&&(E=R.rain),R.stylesheet.camera!=null&&(A=R.stylesheet.camera),R.stylesheet.projection!=null&&(T=R.stylesheet.projection),R.stylesheet.transition!=null&&(C=R.stylesheet.transition),L[R.scope]=R._styleColorTheme}}),this.light=t,this.ambientLight=o,this.directionalLight=h,this.fog=_,this.snow=v,this.rain=E,this._styleColorThemeForScope=L,g===null?delete this.terrain:this.terrain=g,this.camera=A||{"camera-projection":"perspective"},this.projection=T||{name:"mercator"},this.transition=r.h({},ku,C),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){let o=h=>{for(let g of h.fragments)o(g.style);t(h)};o(this)}_prioritizeTerrain(t,o,h){let g=t&&t.drapeRenderMode===0;return h===null?o&&o.drapeRenderMode===0?o:g?t:null:o!=null&&(!t||g||o&&o.drapeRenderMode===1)?o:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(o=>{t=this._prioritizeTerrain(t,o.terrain,o.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(o=>{o.stylesheet.projection!=null&&(t=o.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){let t={},o={},h={};this.forEachFragmentStyle(g=>{for(let _ in g._sourceCaches){let v=r.C(_,g.scope);t[v]=g._sourceCaches[_]}for(let _ in g._otherSourceCaches){let v=r.C(_,g.scope);o[v]=g._otherSourceCaches[_]}for(let _ in g._symbolSourceCaches){let v=r.C(_,g.scope);h[v]=g._symbolSourceCaches[_]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=o,this._mergedSymbolSourceCaches=h}mergeLayers(){let t={},o=[],h={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(_=>{for(let v of _._order){let E=_._layers[v];if(E.type==="slot"){let T=r.dj(v);if(t[T])continue;t[T]=[]}E.slot&&t[E.slot]?t[E.slot].push(E):o.push(E)}}),this._mergedOrder=[];let g=(_=[])=>{for(let v of _)if(v.type==="slot"){let E=r.dj(v.id);t[E]&&g(t[E]),this._mergedSlots.push(E)}else{let E=r.C(v.id,v.scope);this._mergedOrder.push(E),h[E]=v,v.is3D(!!this.terrain)&&(this._has3DLayers=!0),v.type==="circle"&&(this._hasCircleLayers=!0),v.type==="symbol"&&(this._hasSymbolLayers=!0),v.type==="clip"&&(this._clipLayerPresent=!0)}};g(o),this._mergedOrder.sort((_,v)=>{let E=h[_],T=h[v];return E.hasInitialOcclusionOpacityProperties?T.is3D(!!this.terrain)?1:0:E.is3D(!!this.terrain)&&T.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=h,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=r.h({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(o,h,g,_){let v=r.h({},h);for(let T of Object.keys(r.a5.colorTheme))v[T]===void 0&&(v[T]=r.a5.colorTheme[T].default);let E=new r.a6(oh,o,new Map(g));return E.setTransitionOrValue(v,g),E.untransitioned().possiblyEvaluate(new r.aa(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let o=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((h,g)=>{let _="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void h();let v=t;v.startsWith(_)||(v=_+v);let E=r.I.from("mapbox-reserved-lut"),T=new Image;T.src=v,T.onerror=()=>{this._styleColorTheme.lutLoading=!1,g(new Error("Failed to load image data"))},T.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==o)return void h();this._styleColorTheme.lutLoading=!1;let{width:C,height:A,data:L}=r.q.getImageData(T);if(A>32)return void g(new Error("The height of the image must be less than or equal to 32 pixels."));if(C!==A*A)return void g(new Error("The width of the image must be equal to the height squared."));this.getImage(E)&&this.removeImage(E),this.addImage(E,{data:new r.r({width:C,height:A},L),pixelRatio:1,sdf:!1,usvg:!1,version:0});let R=this.imageManager.getImage(E,this.scope);R?(this._styleColorTheme.lut={image:R.data,data:t},h()):g(new Error("Missing LUT image."))}})}getLut(t){let o=this._styleColorThemeForScope[t];return o?o.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(o,h,g){let _,v,E,T=r.q.devicePixelRatio>1?"@2x":"",C=r.n(h.transformRequest(h.normalizeSpriteURL(o,T,".json"),r.R.SpriteJSON),(R,F)=>{C=null,E||(E=R,_=F,L())}),A=r.o(h.transformRequest(h.normalizeSpriteURL(o,T,".png"),r.R.SpriteImage),(R,F)=>{A=null,E||(E=R,v=F,L())});function L(){if(E)g(E);else if(_&&v){let R=r.q.getImageData(v),F={};for(let V in _){let{width:z,height:H,x:j,y:Z,sdf:Y,pixelRatio:J,stretchX:re,stretchY:ce,content:de}=_[V],ie=new r.r({width:z,height:H});r.r.copy(R,ie,{x:j,y:Z},{x:0,y:0},{width:z,height:H},null),F[V]={data:ie,pixelRatio:J,sdf:Y,stretchX:re,stretchY:ce,content:de,usvg:!1}}g(null,F)}}return{cancel(){C&&(C.cancel(),C=null),A&&(A.cancel(),A=null)}}}(t,this.map._requestManager,(o,h)=>{if(this._spriteRequest=null,o)this.fire(new r.z(o));else if(h){let g=new Map;for(let _ in h)g.set(r.I.from(_),h[_]);this.addImages(g)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new r.A("data",{dataType:"style"}))})}addIconset(t,o){if(o.type==="sprite")return void this._loadSprite(o.url);let h=this.getOwnSourceCache(o.source);if(!h)return void this.fire(new r.z(new Error(`Source "${o.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));let g=h.getSource();if(g.type!=="raster-array")return void this.fire(new r.z(new Error(`Source "${o.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));g.partial=!1;let _=new Rp(t,this.scope,h);this.imageManager.addImageProvider(_,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!r.j(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);let o=this.map._spriteFormat==="auto";var h,g;this._spriteRequest=(g=(_,v)=>{if(this._spriteRequest=null,_)o?this._loadSprite(t):this.fire(new r.z(_));else if(v){let E=new Map;for(let T in v)E.set(r.I.from(T),v[T]);this.addImages(E)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new r.A("data",{dataType:"style"}))},r.br((h=this.map._requestManager).transformRequest(h.normalizeIconsetURL(t),r.R.Iconset),(_,v)=>{if(_)return void g(_);let E={},T=r.da(new r.bq(v));for(let C of T.icons){let A={version:1,pixelRatio:r.q.devicePixelRatio,content:Q_(C),stretchX:C.metadata?ey(C.metadata.stretch_x_areas):void 0,stretchY:C.metadata?ey(C.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:C};E[C.name]=A}g(null,E)}))}_validateLayer(t){let o=this.getOwnSource(t.source);if(!o)return;let h=t.sourceLayer;h&&(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(h)===-1)&&this.fire(new r.z(new Error(`Source layer "${h}" does not exist on source "${o.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,o)=>{let h=this.fragments[o];return h&&h.style&&(t.data=h.style.serialize()),t})}_serializeSources(){let t={};for(let o in this._sourceCaches){let h=this._sourceCaches[o].getSource();t[h.id]||(t[h.id]=h.serialize())}return t}_serializeLayers(t){let o=[];for(let h of t){let g=this._layers[h];g&&g.type!=="custom"&&o.push(g.serialize())}return o}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(let t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){let o=this.getOwnLayer(t);if(o)return o;this.fire(new r.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){let o=this.getOwnSource(t);if(o)return o;this.fire(new r.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,o){let h=this.map.painter;if(h)for(let g=t.minzoom||0;g<(t.maxzoom||25.5);g++){let _=t.getProgramIds();if(_)for(let v of _){let E=t.getDefaultProgramParams(v,o.zoom,this._styleColorTheme.lut);E&&(h.style=this,this.fog&&(h._fogVisible=!0,E.overrideFog=!0,h.getOrCreateProgram(v,E)),h._fogVisible=!1,E.overrideFog=!1,h.getOrCreateProgram(v,E),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(E.overrideRtt=!0,h.getOrCreateProgram(v,E)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);let o=this.calculateLightsBrightness();t.brightness=o||0,o!==this._brightness&&(this._brightness=o,this.dispatcher.broadcast("setBrightness",o)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));let h=this._changes.isDirty(),g=!1;if(this._changes.isDirty()){let E=this._changes.getLayerUpdatesByScope();for(let T in E){let{updatedIds:C,removedIds:A}=E[T];(C||A)&&(this._updateWorkerLayers(T,C,A),g=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}let _={};for(let E in this._mergedSourceCaches){let T=this._mergedSourceCaches[E];_[E]=T.used,T.used=!1,T.tileCoverLift=0}for(let E of this._mergedOrder){let T=this._mergedLayers[E];if(T.recalculate(t,this._availableImages),!T.isHidden(t.zoom)){let C=this.getLayerSourceCache(T);C&&(C.used=!0,C.tileCoverLift=Math.max(C.tileCoverLift,T.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(T,t)}):this.precompilePrograms(T,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&g&&this.mergeLayers();let v=this.imageManager.getPendingImageProviders();for(let E of v)E.sourceCache.used=!0;for(let E in _){let T=this._mergedSourceCaches[E];_[E]!==T.used&&T.getSource().fire(new r.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:T.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),h&&this.fire(new r.A("data",{dataType:"style"}))}updateImageProviders(){let t=this.imageManager.getPendingImageProviders();for(let o of t){let h=o.resolvePendingRequests(),g=this.getFragmentStyle(o.scope);g&&g.addImages(h)}}_updateTilesForChangedImages(){let t={};for(let o in this._mergedSourceCaches){let h=this._mergedSourceCaches[o].getSource().scope;t[h]=t[h]||this._changes.getUpdatedImages(h),t[h].length!==0&&this._mergedSourceCaches[o].reloadTilesForDependencies(["icons","patterns"],t[h])}for(let o in t)this._changes.resetUpdatedImages(o)}_updateWorkerLayers(t,o,h){let g=this.getFragmentStyle(t);g&&this.dispatcher.broadcast("updateLayers",{layers:o?g._serializeLayers(o):[],scope:t,removedIds:h||[],options:g.options})}setState(t,o){if(this._checkLoaded(),wa(this,So(t)))return!1;(t=r.di(t)).layers=wu(t.layers);let h=function(v,E){if(!v)return[{command:xn.setStyle,args:[E]}];let T=[];try{if(!r.bv(v.version,E.version))return[{command:xn.setStyle,args:[E]}];if(r.bv(v.center,E.center)||T.push({command:xn.setCenter,args:[E.center]}),r.bv(v.zoom,E.zoom)||T.push({command:xn.setZoom,args:[E.zoom]}),r.bv(v.bearing,E.bearing)||T.push({command:xn.setBearing,args:[E.bearing]}),r.bv(v.pitch,E.pitch)||T.push({command:xn.setPitch,args:[E.pitch]}),r.bv(v.sprite,E.sprite)||T.push({command:xn.setSprite,args:[E.sprite]}),r.bv(v.glyphs,E.glyphs)||T.push({command:xn.setGlyphs,args:[E.glyphs]}),r.bv(v.imports,E.imports)||function(F=[],V=[],z){V=V||[];let H=(F=F||[]).map(rl),j=V.map(rl),Z=F.reduce(_a,{}),Y=V.reduce(_a,{}),J=H.slice(),re,ce,de,ie;for(re=0,ce=0;re<H.length;re++)de=H[re],Y.hasOwnProperty(de)?ce++:(z.push({command:xn.removeImport,args:[de]}),J.splice(J.indexOf(de,ce),1));for(re=0,ce=0;re<j.length;re++)de=j[j.length-1-re],J[J.length-1-re]!==de&&(Z.hasOwnProperty(de)?(z.push({command:xn.removeImport,args:[de]}),J.splice(J.lastIndexOf(de,J.length-ce),1)):ce++,ie=J[J.length-re],z.push({command:xn.addImport,args:[Y[de],ie]}),J.splice(J.length-re,0,de));for(let oe of V){let se=Z[oe.id];se&&(delete se.data,r.bv(se,oe)||z.push({command:xn.updateImport,args:[oe.id,oe]}))}}(v.imports,E.imports,T),r.bv(v.transition,E.transition)||T.push({command:xn.setTransition,args:[E.transition]}),r.bv(v.light,E.light)||T.push({command:xn.setLight,args:[E.light]}),r.bv(v.fog,E.fog)||T.push({command:xn.setFog,args:[E.fog]}),r.bv(v.snow,E.snow)||T.push({command:xn.setSnow,args:[E.snow]}),r.bv(v.rain,E.rain)||T.push({command:xn.setRain,args:[E.rain]}),r.bv(v.projection,E.projection)||T.push({command:xn.setProjection,args:[E.projection]}),r.bv(v.lights,E.lights)||T.push({command:xn.setLights,args:[E.lights]}),r.bv(v.camera,E.camera)||T.push({command:xn.setCamera,args:[E.camera]}),r.bv(v.iconsets,E.iconsets)||function(F,V,z){let H;for(H in V=V||{},F=F||{})F.hasOwnProperty(H)&&(V.hasOwnProperty(H)||z.push({command:xn.removeIconset,args:[H]}));for(H in V){if(!V.hasOwnProperty(H))continue;let j=V[H];F.hasOwnProperty(H)?r.bv(F[H],j)||(z.push({command:xn.removeIconset,args:[H]}),z.push({command:xn.addIconset,args:[H,j]})):z.push({command:xn.addIconset,args:[H,j]})}}(v.iconsets,E.iconsets,T),!r.bv(v["color-theme"],E["color-theme"]))return[{command:xn.setStyle,args:[E]}];let C={},A=[];(function(F,V,z,H){let j;for(j in V=V||{},F=F||{})F.hasOwnProperty(j)&&(V.hasOwnProperty(j)||Xl(j,z,H));for(j in V){if(!V.hasOwnProperty(j))continue;let Z=V[j];F.hasOwnProperty(j)?r.bv(F[j],Z)||(F[j].type==="geojson"&&Z.type==="geojson"&&Ib(F,V,j)?z.push({command:xn.setGeoJSONSourceData,args:[j,Z.data]}):Eu(j,V,z,H)):Qd(j,V,z)}})(v.sources,E.sources,A,C);let L=[];v.layers&&v.layers.forEach(F=>{F.source&&C[F.source]?T.push({command:xn.removeLayer,args:[F.id]}):L.push(F)});let R=v.terrain;R&&C[R.source]&&(T.push({command:xn.setTerrain,args:[void 0]}),R=void 0),T=T.concat(A),r.bv(R,E.terrain)||T.push({command:xn.setTerrain,args:[E.terrain]}),function(F,V,z){V=V||[];let H=(F=F||[]).map(rl),j=V.map(rl),Z=F.reduce(_a,{}),Y=V.reduce(_a,{}),J=H.slice(),re=Object.create(null),ce,de,ie,oe,se,Te,me;for(ce=0,de=0;ce<H.length;ce++)ie=H[ce],Y.hasOwnProperty(ie)?de++:(z.push({command:xn.removeLayer,args:[ie]}),J.splice(J.indexOf(ie,de),1));for(ce=0,de=0;ce<j.length;ce++)ie=j[j.length-1-ce],J[J.length-1-ce]!==ie&&(Z.hasOwnProperty(ie)?(z.push({command:xn.removeLayer,args:[ie]}),J.splice(J.lastIndexOf(ie,J.length-de),1)):de++,Te=J[J.length-ce],z.push({command:xn.addLayer,args:[Y[ie],Te]}),J.splice(J.length-ce,0,ie),re[ie]=!0);for(ce=0;ce<j.length;ce++)if(ie=j[ce],oe=Z[ie],se=Y[ie],!re[ie]&&!r.bv(oe,se))if(r.bv(oe.source,se.source)&&r.bv(oe["source-layer"],se["source-layer"])&&r.bv(oe.type,se.type)){for(me in Tu(oe.layout,se.layout,z,ie,null,xn.setLayoutProperty),Tu(oe.paint,se.paint,z,ie,null,xn.setPaintProperty),r.bv(oe.slot,se.slot)||z.push({command:xn.setSlot,args:[ie,se.slot]}),r.bv(oe.filter,se.filter)||z.push({command:xn.setFilter,args:[ie,se.filter]}),r.bv(oe.minzoom,se.minzoom)&&r.bv(oe.maxzoom,se.maxzoom)||z.push({command:xn.setLayerZoomRange,args:[ie,se.minzoom,se.maxzoom]}),oe)oe.hasOwnProperty(me)&&me!=="layout"&&me!=="paint"&&me!=="filter"&&me!=="metadata"&&me!=="minzoom"&&me!=="maxzoom"&&me!=="slot"&&(me.indexOf("paint.")===0?Tu(oe[me],se[me],z,ie,me.slice(6),xn.setPaintProperty):r.bv(oe[me],se[me])||z.push({command:xn.setLayerProperty,args:[ie,me,se[me]]}));for(me in se)se.hasOwnProperty(me)&&!oe.hasOwnProperty(me)&&me!=="layout"&&me!=="paint"&&me!=="filter"&&me!=="metadata"&&me!=="minzoom"&&me!=="maxzoom"&&me!=="slot"&&(me.indexOf("paint.")===0?Tu(oe[me],se[me],z,ie,me.slice(6),xn.setPaintProperty):r.bv(oe[me],se[me])||z.push({command:xn.setLayerProperty,args:[ie,me,se[me]]}))}else z.push({command:xn.removeLayer,args:[ie]}),Te=J[J.lastIndexOf(ie)+1],z.push({command:xn.addLayer,args:[se,Te]})}(L,E.layers,T)}catch(C){console.warn("Unable to compute style diff:",C),T=[{command:xn.setStyle,args:[E]}]}return T}(this.serialize(),t).filter(v=>!(v.command in ny));if(h.length===0)return!1;let g=h.filter(v=>!(v.command in ty));if(g.length>0)throw new Error(`Unimplemented: ${g.map(v=>v.command).join(", ")}.`);let _=[];return h.forEach(v=>{_.push(this[v.command](...v.args))}),o&&Promise.all(_).then(o).catch(o),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(let[o,h]of t.entries()){if(this.getImage(o))return this.fire(new r.z(new Error(`An image with the name "${o.name}" already exists.`)));this.imageManager.addImage(o,this.scope,h),this._changes.updateImage(o,this.scope)}return this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this}addImage(t,o){return this.getImage(t)?this.fire(new r.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,o),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this)}updateImage(t,o,h=!1){this.imageManager.updateImage(t,this.scope,o),h&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this):this.fire(new r.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new r.A("data",{dataType:"style"})),this}addModel(t,o,h={}){return this._checkLoaded(),this._validate(te,`models.${t}`,o,null,h)||(this.modelManager.addModel(t,o,this.scope),this.fire(new r.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new r.A("data",{dataType:"style"})),this):this.fire(new r.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,o,h={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!o.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(o).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(o.type)>=0&&this._validate(fu,`sources.${t}`,o,null,h))return;this.map&&this.map._collectResourceTiming&&(o.collectResourceTiming=!0);let g=gu(t,o,this.dispatcher,this);g.scope=this.scope,g.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(g.id),source:g.serialize(),sourceId:g.id}));let _=v=>{let E=(v?"symbol:":"other:")+g.id,T=r.C(E,this.scope),C=this._sourceCaches[E]=new eo(T,g,v);(v?this._symbolSourceCaches:this._otherSourceCaches)[g.id]=C,C.onAdd(this.map)};_(!1),o.type!=="vector"&&o.type!=="geojson"||_(!0),g.onAdd&&g.onAdd(this.map),h.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();let o=this.getOwnSource(t);if(!o)throw new Error("There is no source with this ID");for(let g in this._layers)if(this._layers[g].source===t)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while layer "${g}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){let g=Object.entries(this.stylesheet.iconsets).find(([_,v])=>v.type==="source"&&v.source===t);if(g)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while iconset "${g[0]}" is using it.`)))}let h=this.getOwnSourceCaches(t);for(let g of h){let _=r.dj(g.id);delete this._sourceCaches[_],this._changes.discardSourceCacheUpdate(g.id),g.fire(new r.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:g.getSource().id})),g.setEventedParent(null),g.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),o.setEventedParent(null),o.onRemove&&o.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,o){this._checkLoaded(),this.getOwnSource(t).setData(o),this._changes.setDirty()}getOwnSource(t){let o=this.getOwnSourceCache(t);return o&&o.getSource()}getOwnSources(){let t=[];for(let o in this._otherSourceCaches){let h=this.getOwnSourceCache(o);h&&t.push(h.getSource())}return t}areTilesLoaded(){let t=this._mergedSourceCaches;for(let o in t){let h=t[o]._tiles;for(let g in h){let _=h[g];if(_.state!=="loaded"&&_.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;let o=this._getTransitionParameters();for(let _ of t){if(this._validate(Wl,"lights",_))return;switch(_.type){case"ambient":if(this.ambientLight){let v=this.ambientLight;v.set(_),v.updateTransitions(o)}else this.ambientLight=new $n(_,fn||(fn=new r.a7({color:new r.a8(r.a5.properties_light_ambient.color),"color-use-theme":new r.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new r.a8(r.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let v=this.directionalLight;v.set(_),v.updateTransitions(o)}else this.directionalLight=new $n(_,Pr||(Pr=new r.a7({direction:new r.an(r.a5.properties_light_directional.direction),color:new r.a8(r.a5.properties_light_directional.color),"color-use-theme":new r.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new r.a8(r.a5.properties_light_directional.intensity),"cast-shadows":new r.a8(r.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new r.a8(r.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new r.a8(r.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let h=Object.assign(o,{worldview:this.map.getWorldview()}),g=new r.aa(this.z||0,h);this.ambientLight&&this.ambientLight.recalculate(g),this.directionalLight&&this.directionalLight.recalculate(g),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let t=this.directionalLight,o=this.ambientLight;if(!t||!o)return;let h=R=>.2126*(R[0]<=.03928?R[0]/12.92:Math.pow((R[0]+.055)/1.055,2.4))+.7152*(R[1]<=.03928?R[1]/12.92:Math.pow((R[1]+.055)/1.055,2.4))+.0722*(R[2]<=.03928?R[2]/12.92:Math.pow((R[2]+.055)/1.055,2.4)),g=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),_=t.properties.get("intensity"),v=t.properties.get("direction"),E=1-r.d1(v.x,v.y,v.z)[2]/90,T=h(g)*_*E,C=o.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),A=o.properties.get("intensity"),L=h(C)*A;return Number(((T+L)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(r.dk(t)){let o=r.dl(t),h=this.fragments.find(({id:_})=>_===o);if(!h)return;let g=r.dj(t);return h.style.getFragmentStyle(g)}{let o=this.fragments.find(({id:h})=>h===t);return o?o.style:void 0}}setFeaturesetSelectors(t){if(!t)return;let o={},h=(g,_="")=>`${g}::${_}`;this._featuresetSelectors={};for(let g in t){let _=this._featuresetSelectors[g]=[];for(let v of t[g].selectors){if(v.featureNamespace){let T=this.getOwnLayer(v.layer);if(!T){r.w(`Layer is undefined for selector: ${v.layer}`);continue}let C=h(T.source,T.sourceLayer);if(C in o&&o[C]!==v.featureNamespace){r.w(`"featureNamespace ${v.featureNamespace} of featureset ${g}'s selector is not associated to the same source, skip this selector`);continue}o[C]=v.featureNamespace}let E;if(v.properties)for(let T in v.properties){let C=r.X(v.properties[T]);C.result==="success"&&(E=E||{},E[T]=C.value)}_.push({layerId:v.layer,namespace:v.featureNamespace,properties:E,uniqueFeatureID:v._uniqueFeatureID})}}}getFeaturesetDescriptors(t){let o=this.getFragmentStyle(t);if(!o||!o.stylesheet.featuresets)return[];let h=[];for(let g in o.stylesheet.featuresets)h.push({featuresetId:g,importId:o.scope?o.scope:void 0});return h}getFeaturesetLayers(t,o){let h=this.getFragmentStyle(o),g=h.stylesheet.featuresets;if(!g||!g[t])return this.fire(new r.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];let _=[];for(let v of g[t].selectors){let E=h.getOwnLayer(v.layer);E&&_.push(E)}return _}getConfigProperty(t,o){let h=this.getFragmentStyle(t);if(!h)return null;let g=r.C(o,h.scope),_=h.options.get(g),v=_?_.value||_.default:null;return v?v.serialize():null}setConfigProperty(t,o,h){let g=this.getFragmentStyle(t);if(!g)return;let _=g.stylesheet.indoor?J_(g.stylesheet.schema):g.stylesheet.schema;if(!_||!_[o])return;let v=r.X(h);if(v.result!=="success")return void wa(this,v.value);let E=v.value.expression,T=r.C(o,g.scope),C=g.options.get(T);if(!C)return;let A,{minValue:L,maxValue:R,stepValue:F,type:V,values:z}=_[o],H=r.X(_[o].default);H.result==="success"&&(A=H.value.expression),A?(this.options.set(T,Object.assign({},C,{value:E,default:A,minValue:L,maxValue:R,stepValue:F,type:V,values:z})),this.updateConfigDependencies(o)):this.fire(new r.z(new Error(`No schema defined for the config option "${o}" in the "${t}" fragment.`)))}getConfig(t){let o=this.getFragmentStyle(t);if(!o)return null;let h=o.stylesheet.schema;if(!h)return null;let g={};for(let _ in h){let v=r.C(_,o.scope),E=o.options.get(v),T=E?E.value||E.default:null;g[_]=T?T.serialize():null}return g}setConfig(t,o){let h=this.getFragmentStyle(t);h&&(h.updateConfig(o,h.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){let o=this.getFragmentStyle(t);return o?o.stylesheet.schema:null}setSchema(t,o){let h=this.getFragmentStyle(t);h&&(h.stylesheet.schema=o,h.updateConfig(h._config,o),this.updateConfigDependencies())}updateConfig(t,o){if(this._config=t,t||o)if(o)for(let h in o){let g,_,v=r.X(o[h].default);if(v.result==="success"&&(g=v.value.expression),t&&t[h]!==void 0){let R=r.X(t[h]);R.result==="success"&&(_=R.value.expression)}let{minValue:E,maxValue:T,stepValue:C,type:A,values:L}=o[h];if(g){let R=r.C(h,this.scope);this.options.set(R,{default:g,value:_,minValue:E,maxValue:T,stepValue:C,type:A,values:L})}else this.fire(new r.z(new Error(`No schema defined for config option "${h}".`)))}else this.fire(new r.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(let o of this._configDependentLayers){let h=this.getLayer(o);if(h){if(t&&!h.configDependencies.has(t))continue;h.possiblyEvaluateVisibility(),this._updateLayer(h)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(o=>{let h=o._styleColorTheme.colorThemeOverride?o._styleColorTheme.colorThemeOverride:o._styleColorTheme.colorTheme;if(h){let g=o._evaluateColorThemeData(h);(!o._styleColorTheme.lut&&g!==""||o._styleColorTheme.lut&&g!==o._styleColorTheme.lut.data)&&o.setColorTheme(h)}}),this._changes.setDirty()}addLayer(t,o,h={}){this._checkLoaded();let g=t.id;if(this._layers[g])return void this.fire(new r.z(new Error(`Layer with id "${g}" already exists on this map`)));let _;if(t.type==="custom"){if(wa(this,r.dm(t)))return;_=r.dn(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(g,t.source),t=r.di(t),t=r.h(t,{source:g})),this._validate(Sn,`layers.${g}`,t,{arrayIndex:-1},h))return;_=r.dn(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(_),_.setEventedParent(this,{layer:{id:g}})}_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid);let v=this._order.length;if(o){let A=this._order.indexOf(o);if(A===-1)return void this.fire(new r.z(new Error(`Layer with id "${o}" does not exist on this map.`)));_.slot===this._layers[o].slot?v=A:r.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,g),this._layerOrderChanged=!0,this._layers[g]=_;let E=this.getOwnLayerSourceCache(_),T=!!this.directionalLight&&this.directionalLight.shadowsEnabled();E&&_.canCastShadows()&&T&&(E.castsShadows=!0);let C=this._changes.getRemovedLayer(_);if(C&&_.source&&E&&_.type!=="custom"){this._changes.discardLayerRemoval(_);let A=r.C(_.source,_.scope);C.type!==_.type?this._changes.updateSourceCache(A,"clear"):(this._changes.updateSourceCache(A,"reload"),E.pause())}this._updateLayer(_),_.onAdd&&_.onAdd(this.map),_.scope=this.scope,this.mergeLayers()}moveLayer(t,o){this._checkLoaded();let h=this._checkLayer(t);if(!h||t===o)return;let g=this._order.indexOf(t);this._order.splice(g,1);let _=this._order.length;if(o){let v=this._order.indexOf(o);if(v===-1)return void this.fire(new r.z(new Error(`Layer with id "${o}" does not exist on this map.`)));h.slot===this._layers[o].slot?_=v:r.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();let o=this._checkLayer(t);if(!o)return;o.setEventedParent(null);let h=this._order.indexOf(t);this._order.splice(h,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(o.fqid),this._changes.removeLayer(o);let g=this.getOwnLayerSourceCache(o);if(g&&g.castsShadows){let _=!1;for(let v in this._layers)if(this._layers[v].source===o.source&&this._layers[v].canCastShadows()){_=!0;break}g.castsShadows=_}o.onRemove&&o.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(let o in this._layers)if(this._layers[o].type===t)return!0;return!1}setLayerZoomRange(t,o,h){this._checkLoaded();let g=this._checkLayer(t);g&&(g.minzoom===o&&g.maxzoom===h||(o!=null&&(g.minzoom=o),h!=null&&(g.maxzoom=h),this._updateLayer(g)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,o){this._checkLoaded();let h=this._checkLayer(t);h&&h.slot!==o&&(h.slot=o,this._updateLayer(h))}setFilter(t,o,h={}){this._checkLoaded();let g=this._checkLayer(t);if(g&&!r.bv(g.filter,o))return o==null?(g.filter=void 0,void this._updateLayer(g)):void(this._validate(De,`layers.${g.id}.filter`,o,{layerType:g.type},h)||(g.filter=r.di(o),this._updateLayer(g)))}getFilter(t){let o=this._checkLayer(t);if(o)return r.di(o.filter)}setLayoutProperty(t,o,h,g={}){this._checkLoaded();let _=this._checkLayer(t);if(_&&!r.bv(_.getLayoutProperty(o),h)){if(h!=null&&(!g||g.validate!==!1)&&wa(_,W.call(So,{key:`layers.${t}.layout.${o}`,layerType:_.type,objectKey:o,value:h,styleSpec:r.a5,style:{glyphs:!0,sprite:!0}})))return;_.setLayoutProperty(o,h),_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),this._updateLayer(_)}}getLayoutProperty(t,o){let h=this._checkLayer(t);if(h)return h.getLayoutProperty(o)}setPaintProperty(t,o,h,g={}){this._checkLoaded();let _=this._checkLayer(t);if(!_||r.bv(_.getPaintProperty(o),h)||h!=null&&(!g||g.validate!==!1)&&wa(_,$.call(So,{key:`layers.${t}.paint.${o}`,layerType:_.type,objectKey:o,value:h,styleSpec:r.a5})))return;let v=_.setPaintProperty(o,h);_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),v&&this._updateLayer(_),this._changes.updatePaintProperties(_)}getPaintProperty(t,o){let h=this._checkLayer(t);if(h)return h.getPaintProperty(o)}setFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:C}=t.target,A=this.getFragmentStyle(C),L=A.getFeaturesetLayers(T);for(let{source:R,sourceLayer:F}of L)A.setFeatureState({id:t.id,source:R,sourceLayer:F},o)}else if("layerId"in t.target){let{layerId:T}=t.target,C=this.getLayer(T);this.setFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},o)}return}let h=t.source,g=t.sourceLayer,_=this._checkSource(h);if(!_)return;let v=_.type;if(v==="geojson"&&g)return void this.fire(new r.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(v==="vector"&&!g)return void this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new r.z(new Error("The feature id parameter must be provided.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.setFeatureState(g,t.id,o)}removeFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:C}=t.target,A=this.getFragmentStyle(C),L=A.getFeaturesetLayers(T);for(let{source:R,sourceLayer:F}of L)A.removeFeatureState({id:t.id,source:R,sourceLayer:F},o)}else if("layerId"in t.target){let{layerId:T}=t.target,C=this.getLayer(T);this.removeFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},o)}return}let h=t.source,g=this._checkSource(h);if(!g)return;let _=g.type,v=_==="vector"?t.sourceLayer:void 0;if(_==="vector"&&!v)return void this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(o&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new r.z(new Error("A feature id is required to remove its specific state property.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.removeFeatureState(v,t.id,o)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let _;if("featuresetId"in t.target){let{featuresetId:v,importId:E}=t.target,T=this.getFragmentStyle(E),C=T.getFeaturesetLayers(v);for(let{source:A,sourceLayer:L}of C){let R=T.getFeatureState({id:t.id,source:A,sourceLayer:L});if(R&&!_)_=R;else if(!r.bv(_,R))return void this.fire(new r.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){let{layerId:v}=t.target,E=this.getLayer(v);_=this.getFeatureState({id:t.id,source:E.source,sourceLayer:E.sourceLayer})}return _}let o=t.source,h=t.sourceLayer,g=this._checkSource(o);if(g){if(g.type!=="vector"||h)return t.id===void 0&&this.fire(new r.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(o)[0].getFeatureState(h,t.id);this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=r.h({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return r.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();let t=this.getTerrain(),o=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return r.dp({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:o,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},h=>h!==void 0)}_updateFilteredLayers(t){for(let o of Object.values(this._mergedLayers))t(o)&&this._updateLayer(o)}_updateLayer(t){this._changes.updateLayer(t);let o=this.getLayerSourceCache(t),h=r.C(t.source,t.scope),g=this._changes.getUpdatedSourceCaches();t.source&&!g[h]&&o&&o.getSource().type!=="raster"&&(this._changes.updateSourceCache(h,"reload"),o.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){let o=E=>this._mergedLayers[E].is3D(!!this.terrain),h=this.order,g={},_=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T)){g[T]=E;for(let C of t){let A=C[T];if(A)for(let L of A)_.push(L)}}}_.sort((E,T)=>T.intersectionZ-E.intersectionZ);let v=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T))for(let C=_.length-1;C>=0;C--){let A=_[C].feature;if(A.layer&&g[A.layer.id]<E)break;v.push(A),_.pop()}else for(let C of t){let A=C[T];if(A)for(let L of A)v.push(L.feature)}}return v}queryRenderedFeatures(t,o,h){let g;o&&!Array.isArray(o)&&o.filter&&(this._validate(De,"queryRenderedFeatures.filter",o.filter,null,o),g=r.b3(o.filter));let _={},v=A=>{if(sh.has(A.type))return;let L=this.getOwnLayerSourceCache(A),R=_[L.id]=_[L.id]||{sourceCache:L,layers:{},has3DLayers:!1};A.is3D(!!this.terrain)&&(R.has3DLayers=!0),R.layers[A.fqid]=R.layers[A.fqid]||{styleLayer:A,targets:[]},R.layers[A.fqid].targets.push({filter:g})};if(o&&o.layers){if(!Array.isArray(o.layers))return this.fire(new r.z(new Error("parameters.layers must be an Array."))),[];for(let A of o.layers){let L=this._layers[A];if(!L)return this.fire(new r.z(new Error(`The layer '${A}' does not exist in the map's style and cannot be queried for features.`))),[];v(L)}}else for(let A in this._layers)v(this._layers[A]);let E=this._queryRenderedFeatures(t,_,h),T=this._flattenAndSortRenderedFeatures(E),C=[];for(let A of T)r.dq(A.layer.id)===this.scope&&C.push(A);return C}queryRenderedFeatureset(t,o,h){let g;o&&!Array.isArray(o)&&o.filter&&(this._validate(De,"queryRenderedFeatures.filter",o.filter,null,o),g=r.b3(o.filter));let _="mock",v=[];if(o&&o.target)v.push(Object.assign({},o,{targetId:_,filter:g}));else{let A=this.getFeaturesetDescriptors();for(let L of A)v.push({targetId:_,filter:g,target:L});for(let{style:L}of this.fragments){let R=L.getFeaturesetDescriptors();for(let F of R)v.push({targetId:_,filter:g,target:F})}}let E=this.queryRenderedTargets(t,v,h),T=[],C=new Set;for(let A of E)for(let L of A.variants[_])Yd(L,A,C)||T.push(new r.dr(A,L));return T}queryRenderedTargets(t,o,h){let g={},_=(E,T,C,A)=>{let L=g[T.id]=g[T.id]||{sourceCache:T,layers:{},has3DLayers:!1};if(L.layers[E.fqid]=L.layers[E.fqid]||{styleLayer:E,targets:[]},E.is3D(!!this.terrain)&&(L.has3DLayers=!0),!A)return C.uniqueFeatureID=!1,void L.layers[E.fqid].targets.push(C);L.layers[E.fqid].targets.push(Object.assign({},C,{namespace:A.namespace,properties:A.properties,uniqueFeatureID:A.uniqueFeatureID}))};for(let E of o)if("featuresetId"in E.target){let{featuresetId:T,importId:C}=E.target,A=this.getFragmentStyle(C);if(!A||!A._featuresetSelectors)continue;let L=A._featuresetSelectors[T];if(!L){this.fire(new r.z(new Error(`The featureset '${T}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let R of L){let F=A.getOwnLayer(R.layerId);F&&!sh.has(F.type)&&_(F,A.getOwnLayerSourceCache(F),E,R)}}else if("layerId"in E.target){let{layerId:T}=E.target,C=this.getLayer(T);if(!C||sh.has(C.type))continue;_(C,this.getLayerSourceCache(C),E)}let v=this._queryRenderedFeatures(t,g,h);return this._flattenAndSortRenderedFeatures(v)}_queryRenderedFeatures(t,o,h){let g=[],_=!!this.map._showQueryGeometry,v=An.createFromScreenPoints(t,h);for(let E in o){let T=Kd(v,o[E],this._availableImages,h,_);Object.keys(T).length&&g.push(T)}if(this.placement)for(let E in o){if(!o[E].sourceCache._onlySymbols)continue;let T=el(v.screenGeometry,o[E],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(T).length&&g.push(T)}return g}querySourceFeatures(t,o){let h=o&&o.filter;h&&this._validate(De,"querySourceFeatures.filter",h,null,o);let g=[],_=this.getOwnSourceCaches(t);for(let v of _)g=g.concat(yu(v,o));return g}addSourceType(t,o,h){return Jo.getSourceType(t)?h(new Error(`A source type called "${t}" already exists.`)):(Jo.setSourceType(t,o),o.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:o.workerSourceURL},h):h(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,o,h={}){this._checkLoaded();let g=this.light.getLight(),_=!1;for(let E in t)if(!r.bv(t[E],g[E])){_=!0;break}if(!_)return;let v=this._getTransitionParameters();this.light.setLight(t,o,h),this.light.updateTransitions(v)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=r.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&r.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,o=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),o===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let h=t,g=t.source==null;if(o===1){if(this.disableElevatedTerrain)return;if(typeof h.source=="object"){let E="terrain-dem-src";this.addSource(E,h.source),h=r.di(h),h=r.h(h,{source:E})}let _=r.h({},h),v={};if(this.terrain&&g){_.source=this.terrain.get().source;let E=this.terrain?this.getFragmentStyle(this.terrain.scope):null;E&&(v.style=E.serialize())}if(this._validate(Xe,"terrain",_,v))return}if(!this.terrain||this.terrain.scope!==this.scope&&!g||this.terrain&&o!==this.terrain.drapeRenderMode){if(!h)return;this._createTerrain(h,o),this.fire(new r.A("data",{dataType:"style"}))}else{let _=this.terrain,v=_.get();for(let E of Object.keys(r.a5.terrain))!h.hasOwnProperty(E)&&r.a5.terrain[E].default&&(h[E]=r.a5.terrain[E].default);for(let E in t)if(!r.bv(t[E],v[E])){_.set(t,this.options),this.stylesheet.terrain=t;let T=this._getTransitionParameters({duration:0});_.updateTransitions(T),this.fire(new r.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){let o=this.fog=new rn(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createSnow(t){let o=this.snow=new ii(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createRain(t){let o=this.rain=new Jr(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let o=this.fog;if(!r.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let o=this.snow;if(!r.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let o=this.rain;if(!r.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){let t=()=>{for(let g in this._layers)this._layers[g].lut=this._styleColorTheme.lut;for(let g in this._sourceCaches)this._sourceCaches[g].clearTiles()},o=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!o)return this._styleColorTheme.lut=null,void t();let h=this._evaluateColorThemeData(o);this._loadColorTheme(h).then(()=>{this.fire(new r.A("colorthemeset")),t()}).catch(g=>{r.w(`Couldn't set color theme: ${g}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&r.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,o){let h=this.getFragmentStyle(t);h&&(h._styleColorTheme.colorThemeOverride=o,h._reloadColorTheme())}_getTransitionParameters(t){return{now:r.q.now(),transition:r.h(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;let t=[],o=[];for(let h of this._mergedOrder)this.isLayerDraped(this._mergedLayers[h])?t.push(h):o.push(h);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...o)}_createTerrain(t,o){let h=this.terrain=new ve(t,o,this.scope,this.options,this.map.getWorldview());o===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let g=this._getTransitionParameters({duration:0});h.updateTransitions(g)}_force3DLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="fill-extrusion"&&this._updateLayer(o)}}_forceSymbolLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="symbol"&&this._updateLayer(o)}}_validate(t,o,h,g,_={}){if(_&&_.validate===!1)return!1;let v=r.h({},this.serialize());return wa(this,t.call(So,r.h({key:o,style:v,value:h,styleSpec:r.a5},g)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),r.ds.off("pluginStateChange",this._rtlTextPluginCallback);for(let t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){let o=this.getSourceCaches(t);for(let h of o)h.clearTiles()}clearSources(){for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(let t in this._mergedLayers){let o=this._mergedLayers[t];o._clear&&o._clear()}}reloadSource(t){let o=this.getSourceCaches(t);for(let h of o)h.resume(),h.reload()}reloadSources(){for(let t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let o;this.directionalLight&&(o=rc(this.directionalLight));let h=new Set;for(let g in this._mergedLayers){let _=this._mergedLayers[g];_.hasElevation()&&!h.has(_.source)&&h.add(_.source)}for(let g in this._mergedSourceCaches){let _=this._mergedSourceCaches[g],v=h.has(_._source.id);_.update(t,void 0,void 0,o,v)}}_generateCollisionBoxes(){for(let t in this._sourceCaches){let o=this._sourceCaches[t];o.resume(),o.reload()}}_updatePlacement(t,o,h,g,_,v,E=!1){let T=!1,C=!1,A={},L={};for(let R of this._mergedOrder){let F=this._mergedLayers[R];if(F.type!=="symbol")continue;let V=r.C(F.source,F.scope),z=A[V];if(!z){let j=this.getLayerSourceCache(F);if(!j)continue;let Z=j.getRenderableIds(!0).map(Y=>j.getTileByID(Y));L[V]=Z.slice(),z=A[V]=Z.sort((Y,J)=>J.tileID.overscaledZ-Y.tileID.overscaledZ||(Y.tileID.isLessThan(J.tileID)?-1:1))}let H=this.crossTileSymbolIndex.addLayer(F,z,o.center.lng,o.projection);T=T||H}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),E=E||this._layerOrderChanged||g===0,this._layerOrderChanged&&this.fire(new r.A("neworder")),(E||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(r.q.now(),o.zoom))&&(this.pauseablePlacement=new rh(o,this._mergedOrder,E,h,g,_,this.placement,this.fog&&o.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,A,L,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(r.q.now()),C=!0),T&&this.pauseablePlacement.placement.setStale()),C||T){this._buildingIndex.onNewFrame(o.zoom);for(let R=0;R<this._mergedOrder.length;R++){let F=this._mergedLayers[this._mergedOrder[R]];if(F.type!=="symbol")continue;let V=this.isLayerClipped(F);this.placement.updateLayerOpacities(F,A[r.C(F.source,F.scope)],R,V?v:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(r.q.now())}}_releaseSymbolFadeTiles(){for(let t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,o){this._checkLoaded();let h=this.stylesheet.imports=this.stylesheet.imports||[];if(h.findIndex(({id:_})=>_===t.id)!==-1)return void this.fire(new r.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!o)return h.push(t),this._loadImports([t],!0);let g=h.findIndex(({id:_})=>_===o);return g===-1&&this.fire(new r.z(new Error(`Import with id "${o}" does not exist on this map.`))),this.stylesheet.imports=h.slice(0,g).concat(t).concat(h.slice(g)),this._loadImports([t],!0,o)}updateImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);return g===-1?this:typeof o=="string"?(this.setImportUrl(t,o),this):(o.url&&o.url!==h[g].url&&this.setImportUrl(t,o.url),r.bv(o.config,h[g].config)||this.setImportConfig(t,o.config,o.data.schema),r.bv(o.data,h[g].data)||this.setImportData(t,o.data),this)}moveImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);if(g===-1)return this;let _=this.getImportIndex(o);if(_===-1)return this;let v=h[g],E=this.fragments[g];return h=h.filter(({id:T})=>T!==t),this.fragments=this.fragments.filter(({id:T})=>T!==t),this.stylesheet.imports=h.slice(0,_).concat(v).concat(h.slice(_)),this.fragments=this.fragments.slice(0,_).concat(E).concat(this.fragments.slice(_)),this.mergeLayers(),this}setImportUrl(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);if(g===-1)return this;h[g].url=o;let _=this.fragments[g];return _.style=this._createFragmentStyle(h[g]),_.style.on("style.import.load",()=>this.mergeAll()),_.style.loadURL(o),this}setImportData(t,o){this._checkLoaded();let h=this.getImportIndex(t),g=this.stylesheet.imports||[];return h===-1?this:o?(this.fragments[h].style.setState(o),this._reloadImports(),this):(delete g[h].data,this.setImportUrl(t,g[h].url))}setImportConfig(t,o,h){this._checkLoaded();let g=this.getImportIndex(t),_=this.stylesheet.imports||[];if(g===-1)return this;o?_[g].config=o:delete _[g].config;let v=this.fragments[g];h&&v.style.stylesheet&&(v.style.stylesheet.schema=h);let E=v.style.stylesheet&&v.style.stylesheet.schema;return v.config=o,v.style.updateConfig(o,E),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();let o=this.stylesheet.imports||[],h=this.getImportIndex(t);h!==-1&&(o.splice(h,1),this.fragments[h].style._remove(),this.fragments.splice(h,1),this._reloadImports())}getImportIndex(t){let o=(this.stylesheet.imports||[]).findIndex(h=>h.id===t);return o===-1&&this.fire(new r.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),o}getLayer(t){return this._mergedLayers[t]}getSources(){let t=[];for(let o in this._mergedOtherSourceCaches){let h=this._mergedOtherSourceCaches[o];h&&t.push(h.getSource())}return t}getSource(t,o){let h=this.getSourceCache(t,o);return h&&h.getSource()}getLayerSource(t){let o=this.getLayerSourceCache(t);return o&&o.getSource()}getSourceCache(t,o){let h=r.C(t,o);return this._mergedOtherSourceCaches[h]}getLayerSourceCache(t){let o=r.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[o]:this._mergedOtherSourceCaches[o]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);let o=[];return this._mergedOtherSourceCaches[t]&&o.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&o.push(this._mergedSymbolSourceCaches[t]),o}updateSourceCaches(){let t=this._changes.getUpdatedSourceCaches();for(let o in t){let h=t[o];h==="reload"?this.reloadSource(o):h==="clear"&&this.clearSource(o)}}updateLayers(t){let o=this._changes.getUpdatedPaintProperties();for(let h of o){let g=this.getLayer(h);g&&g.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,o,h){this.imageManager.getImages(o.images,o.scope,h),this._updateTilesForChangedImages();let g=v=>{if(v){let E=o.images.map(T=>r.I.toString(T));v.setDependencies(o.tileID.key,o.type,E)}},_=r.C(o.source,o.scope);g(this._mergedOtherSourceCaches[_]),g(this._mergedSymbolSourceCaches[_]),o.images.some(v=>v.iconsetId)&&this.fire(new r.A("data",{dataType:"style"}))}rasterizeImages(t,o,h){this.imageManager.rasterizeImages(o,h)}getGlyphs(t,o,h){this.glyphManager.getGlyphs(o.stacks,h)}getResource(t,o,h){return r.dt(o,h)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){let o=[];return this._otherSourceCaches[t]&&o.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&o.push(this._symbolSourceCaches[t]),o}_isSourceCacheLoaded(t){let o=this.getOwnSourceCaches(t);return o.length===0?(this.fire(new r.z(new Error(`There is no source with ID '${t}'`))),!1):o.every(h=>h.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,o){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;let h=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),g=t.type==="building";if(t.is3D(!!this.terrain)){if(h||g||o&&o.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Jo.getSourceType=function(d){return Xd[d]},Jo.setSourceType=function(d,t){Xd[d]=t},Jo.registerForPluginStateChange=r.du;var Pp=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,oc=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,sc=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,Op="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",ah=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Mo=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,lh=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,st=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Lp=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,ch=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,uh=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let Nu=[];ds(Pp,Nu),ds(sc,Nu),ds(oc,Nu);let cl={"_prelude_fog.vertex.glsl":Mo,"_prelude_terrain.vertex.glsl":ah,"_prelude_shadow.vertex.glsl":ch,"_prelude_fog.fragment.glsl":lh,"_prelude_shadow.fragment.glsl":uh,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":st,"_prelude_raster_particle.glsl":Lp},Qo={};mn("",ah),mn(lh,Mo),mn(uh,ch),mn(st,""),mn(Lp,"");let dh=mn(oc,sc),Ta=Pp;var zu={background:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,base_color.rgb,emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color.rgb=linearTosRGB(color.rgb);color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:mn(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:mn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:mn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:mn(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:mn(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:mn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:mn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:mn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:mn(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:mn(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:mn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:mn(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:mn(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:mn(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:mn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:mn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:mn(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:mn(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:mn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:mn(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Op),skyboxGradient:mn(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Op),skyboxCapture:mn(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:mn(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:mn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:mn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:mn(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:mn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:mn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:mn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:mn("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function ds(d,t){let o=d.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let h of o)if(h=h.trim(),h[0]==="#"&&h.includes("if")&&!h.includes("endif")){h=h.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let g=h.split(" ");for(let _ of g)t.includes(_)||t.push(_)}}function mn(d,t){let o=/#include\s+"([^"]+)"/g,h=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,g=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);g&&(g=g.map(C=>{let A=C.split(" ");return A[A.length-1]}),g=[...new Set(g)]);let _={},v=[],E=[];if(d=d.replace(o,(C,A)=>(E.push(A),"")),(t=t.replace(o,(C,A)=>(v.push(A),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let T=[...Nu];ds(d,T),ds(t,T);for(let C of[...v,...E])cl[C]||console.error(`Undefined include: ${C}`),Qo[C]||(Qo[C]=[],ds(cl[C],Qo[C])),T=[...T,...Qo[C]];return{fragmentSource:d=d.replace(h,(C,A,L,R,F)=>(_[F]=!0,A==="define"?`
#ifndef HAS_UNIFORM_u_${F}
in ${L} ${R} ${F};
#else
uniform ${L} ${R} u_${F};
#endif
`:A==="initialize"?`
#ifdef HAS_UNIFORM_u_${F}
    ${L} ${R} ${F} = u_${F};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    in ${L} ${R} ${F};
#endif
`:A==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(h,(C,A,L,R,F)=>{let V=R==="float"?"vec2":R,z=F.match(/color/)?"color":V;return A==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${F}
in ${L} ${R} a_${F};
#endif
`:_[F]?A==="define"?`
#ifndef HAS_UNIFORM_u_${F}
uniform lowp float u_${F}_t;
in ${L} ${V} a_${F};
out ${L} ${R} ${F};
#else
uniform ${L} ${R} u_${F};
#endif
`:A==="initialize"?z==="vec4"?`
#ifndef HAS_UNIFORM_u_${F}
    ${F} = a_${F};
#else
    ${L} ${R} ${F} = u_${F};
#endif
`:`
#ifndef HAS_UNIFORM_u_${F}
    ${F} = unpack_mix_${z}(a_${F}, u_${F}_t);
#else
    ${L} ${R} ${F} = u_${F};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    in ${L} ${R} a_${F};
    out ${L} ${R} ${F};
#endif
`:A==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    ${F} = a_${F};
#endif
`:void 0:A==="define"?`
#ifndef HAS_UNIFORM_u_${F}
uniform lowp float u_${F}_t;
in ${L} ${V} a_${F};
#else
uniform ${L} ${R} u_${F};
#endif
`:A==="define-instanced"?z==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${F}0;
in vec4 a_${F}1;
in vec4 a_${F}2;
in vec4 a_${F}3;
#else
uniform ${L} ${R} u_${F};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${L} ${V} a_${F};
#else
uniform ${L} ${R} u_${F};
#endif
`:A==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    ${L} ${R} ${F} = a_${F};
#endif
`:z==="vec4"?`
#ifndef HAS_UNIFORM_u_${F}
    ${L} ${R} ${F} = a_${F};
#else
    ${L} ${R} ${F} = u_${F};
#endif
`:`
#ifndef HAS_UNIFORM_u_${F}
    ${L} ${R} ${F} = unpack_mix_${z}(a_${F}, u_${F}_t);
#else
    ${L} ${R} ${F} = u_${F};
#endif
`}),staticAttributes:g,usedDefines:T,vertexIncludes:v,fragmentIncludes:E}}class Rb{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,o,h,g,_,v,E,T){this.context=t;let C=this.boundPaintVertexBuffers.length!==g.length;for(let L=0;!C&&L<g.length;L++)this.boundPaintVertexBuffers[L]!==g[L]&&(C=!0);let A=this.boundDynamicVertexBuffers.length!==E.length;for(let L=0;!A&&L<E.length;L++)this.boundDynamicVertexBuffers[L]!==E[L]&&(A=!0);if(!this.vao||this.boundProgram!==o||this.boundLayoutVertexBuffer!==h||C||A||this.boundIndexBuffer!==_||this.boundVertexOffset!==v)this.freshBind(o,h,g,_,v,E,T);else{t.bindVertexArrayOES.set(this.vao);for(let L of E)L&&(L.bind(),T&&L.instanceCount&&L.setVertexAttribDivisor(t.gl,o,T));_&&_.dynamicDraw&&_.bind()}}freshBind(t,o,h,g,_,v,E){let T=t.numAttributes,C=this.context,A=C.gl;this.vao&&this.destroy(),this.vao=C.gl.createVertexArray(),C.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=o,this.boundPaintVertexBuffers=h,this.boundIndexBuffer=g,this.boundVertexOffset=_,this.boundDynamicVertexBuffers=v,o.enableAttributes(A,t),o.bind(),o.setVertexAttribPointers(A,t,_);for(let L of h)L.enableAttributes(A,t),L.bind(),L.setVertexAttribPointers(A,t,_);for(let L of v)L&&(L.enableAttributes(A,t),L.bind(),L.setVertexAttribPointers(A,t,_),E&&L.instanceCount&&L.setVertexAttribDivisor(A,t,E));g&&g.bind(),C.currentNumAttributes=T}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Fp(d,t){let o=Math.pow(2,t.canonical.z),h=t.canonical.y;return[new r.ac(0,h/o).toLngLat().lat,new r.ac(0,(h+1)/o).toLngLat().lat]}function Pb(d,t,o,h,g,_,v){let E=d.context,T=E.gl,C=o.hillshadeFBO;if(!C)return;d.prepareDrawTile();let A=d.isTileAffectedByFog(t),L=d.getOrCreateProgram("hillshade",{overrideFog:A});E.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,C.colorAttachment.get());let R=((H,j,Z,Y)=>{let J=Z.paint.get("hillshade-shadow-color"),re=Z.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",ce=Z.paint.get("hillshade-highlight-color"),de=Z.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",ie=Z.paint.get("hillshade-accent-color"),oe=Z.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",se=Z.paint.get("hillshade-emissive-strength"),Te=r.al(Z.paint.get("hillshade-illumination-direction"));if(Z.paint.get("hillshade-illumination-anchor")==="viewport")Te-=H.transform.angle;else if(H.style&&H.style.enable3dLights()&&H.style.directionalLight){let Ne=H.style.directionalLight.properties.get("direction"),Ae=r.d1(Ne.x,Ne.y,Ne.z);Te=r.al(Ae[1])}let me=!H.options.moving;return{u_matrix:Y||H.transform.calculateProjMatrix(j.tileID.toUnwrapped(),me),u_image:0,u_latrange:Fp(0,j.tileID),u_light:[Z.paint.get("hillshade-exaggeration"),Te],u_shadow:J.toPremultipliedRenderColor(re?null:Z.lut),u_highlight:ce.toPremultipliedRenderColor(de?null:Z.lut),u_emissive_strength:se,u_accent:ie.toPremultipliedRenderColor(oe?null:Z.lut)}})(d,o,h,d.terrain?t.projMatrix:null);d.uploadCommonUniforms(E,L,t.toUnwrapped());let{tileBoundsBuffer:F,tileBoundsIndexBuffer:V,tileBoundsSegments:z}=d.getTileBoundsBuffers(o);L.draw(d,T.TRIANGLES,g,_,v,Mt.disabled,R,h.id,F,V,z)}function kp(d,t,o){if(!t.needsDEMTextureUpload)return;let h=d.context,g=h.gl;h.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||d.getTileTexture(o.stride);let _=o.getPixels();t.demTexture?t.demTexture.update(_,{premultiply:!1}):t.demTexture=new r.T(h,_,g.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function ry(d,t,o){let h=d.context,g=h.gl;if(!t.dem)return;let _=t.dem;if(h.activeTexture.set(g.TEXTURE1),kp(d,t,_),!t.demTexture)return;t.demTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE);let v=_.dim;h.activeTexture.set(g.TEXTURE0);let E=t.hillshadeFBO;if(!E){let R=new r.T(h,{width:v,height:v,data:null},g.RGBA8);R.bind(g.LINEAR,g.CLAMP_TO_EDGE),E=t.hillshadeFBO=h.createFramebuffer(v,v,!0,"renderbuffer"),E.colorAttachment.set(R.texture)}h.bindFramebuffer.set(E.framebuffer),h.viewport.set([0,0,v,v]);let{tileBoundsBuffer:T,tileBoundsIndexBuffer:C,tileBoundsSegments:A}=d.getMercatorTileBoundsBuffers(),L=[];d.linearFloatFilteringSupported()&&L.push("TERRAIN_DEM_FLOAT_FORMAT"),d.getOrCreateProgram("hillshadePrepare",{defines:L}).draw(d,g.TRIANGLES,gt.disabled,Lt.disabled,Yt.unblended,Mt.disabled,((R,F)=>{let V=F.stride,z=r.bz();return r.ca(z,0,r.aj,-r.aj,0,0,1),r.bo(z,z,[0,-r.aj,0]),{u_matrix:z,u_image:1,u_dimension:[V,V],u_zoom:R.overscaledZ}})(t.tileID,_),o.id,T,C,A),t.needsHillshadePrepare=!1}class fr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ob extends fr{getDefault(){return r.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Lb extends fr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Fb extends fr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class kb extends fr{getDefault(){return[!0,!0,!0,!0]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class iy extends fr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Nb extends fr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class hh extends fr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){let o=this.current;(t.func!==o.func||t.ref!==o.ref||t.mask!==o.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class zb extends fr{getDefault(){let t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class oy extends fr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),this.current=t,this.dirty=!1}}class Np extends fr{getDefault(){return[0,1]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class fh extends fr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.current=t,this.dirty=!1}}class zp extends fr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class ul extends fr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.BLEND):o.disable(o.BLEND),this.current=t,this.dirty=!1}}class ac extends fr{getDefault(){let t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class ph extends fr{getDefault(){return r.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class mh extends fr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class lc extends fr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.CULL_FACE):o.disable(o.CULL_FACE),this.current=t,this.dirty=!1}}class sy extends fr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Bp extends fr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let ay=class extends fr{getDefault(){return null}set(d){(d!==this.current||this.dirty)&&(this.gl.useProgram(d),this.current=d,this.dirty=!1)}};class cc extends fr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class gh extends fr{getDefault(){let t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class _h extends fr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Vp extends fr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindRenderbuffer(o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class yh extends fr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindTexture(o.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Bu extends fr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class ly extends fr{getDefault(){return null}set(t){let o=this.gl;o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class cy extends fr{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class uy extends fr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class uc extends fr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class dy extends fr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Up extends fr{constructor(t,o){super(t),this.context=t,this.parent=o}getDefault(){return null}}class Bb extends Up{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class hy extends Up{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferRenderbuffer(o.FRAMEBUFFER,this.attachment(),o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class jp extends Up{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,this.attachment(),o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Hp extends hy{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let Gp=(d,t,o)=>({u_matrix:d,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:o}),vh=(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z)=>({u_proj_matrix:Float32Array.from(d),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(h),u_merc_matrix:o,u_zoom_transition:g,u_merc_center:_,u_image0:0,u_frustum_tl:v,u_frustum_tr:E,u_frustum_br:T,u_frustum_bl:C,u_globe_pos:A,u_globe_radius:L,u_viewport:R,u_grid_matrix:z?Float32Array.from(z):new Float32Array(9),u_skirt_height:F,u_far_z_cutoff:V});function $p(d,t){return d!=null&&t!=null&&!(!d.hasData()||!t.hasData())&&d.demTexture!=null&&t.demTexture!=null&&d.tileID.key!==t.tileID.key}let dl=new class{constructor(){this.operations={}}newMorphing(d,t,o,h,g){if(d in this.operations){let _=this.operations[d];_.to.tileID.key!==o.tileID.key&&(_.queued=o)}else this.operations[d]={startTime:h,phase:0,duration:g,from:t,to:o,queued:null}}getMorphValuesForProxy(d){if(!(d in this.operations))return null;let t=this.operations[d];return{from:t.from,to:t.to,phase:t.phase}}update(d){for(let t in this.operations){let o=this.operations[t];for(o.phase=(d-o.startTime)/o.duration;o.phase>=1||!this._validOp(o);)if(!this._nextOp(o,d)){delete this.operations[t];break}}}_nextOp(d,t){return!!d.queued&&(d.from=d.to,d.to=d.queued,d.queued=null,d.phase=0,d.startTime=t,!0)}_validOp(d){return d.from.hasData()&&d.to.hasData()}},fy={0:null,1:"TERRAIN_VERTEX_MORPHING"};function dc(d,t,o){if(t===0)return 0;let h=t<1&&o===514?.25/t:1;return 6*Math.pow(1.5,22-d)*Math.max(t,1)*h}function Vu(d,t){let o=1<<d.z;return!t&&(d.x===0||d.x===o-1)||d.y===0||d.y===o-1}let xh=d=>({u_matrix:d});function no(d,t,o,h,g){if(g>0){let _=r.q.now(),v=(_-d.timeAdded)/g,E=t?(_-t.timeAdded)/g:-1,T=o.getSource(),C=h.coveringZoomLevel({tileSize:T.tileSize,roundZoom:T.roundZoom}),A=!t||Math.abs(t.tileID.overscaledZ-C)>Math.abs(d.tileID.overscaledZ-C),L=A&&d.refreshedUponExpiration?1:r.ay(A?v:1-E,0,1);return d.refreshedUponExpiration&&v>=1&&(d.refreshedUponExpiration=!1),t?{opacity:1,mix:1-L}:{opacity:L,mix:0}}return{opacity:1,mix:0}}class Wp extends eo{constructor(t){let o=gu("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",o,!1),o.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,o){t.state="loaded",o(null)}}class bh extends eo{constructor(t){let o=gu("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",o,!1),o.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,o,h){if(t.freezeTileCoverage)return;this.transform=t;let g=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((_,v)=>{if(_[v.key]="",!this._tiles[v.key]){let E=new tl(v,this._source.tileSize*v.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);E.state="loaded",this._tiles[v.key]=E}return _},{});for(let _ in this._tiles)_ in g||(this.freeFBO(_),this._tiles[_].unloadVectorData(),delete this._tiles[_])}freeFBO(t){let o=this.proxyCachedFBO[t];if(o!==void 0){let h=Object.values(o);this.renderCachePool.push(...h),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Uu extends r.aM{constructor(t,o,h){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=o,this.projMatrix=h}}class wh extends r.dF{constructor(t,o){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[h,g,_]=function(T){let C=new r.ba,A=new r.a_,L=131;C.reserve(17161),A.reserve(33800);let R=r.aj/128,F=r.aj+R/2,V=F+R;for(let H=-R;H<V;H+=R)for(let j=-R;j<V;j+=R){let Z=j<0||j>F||H<0||H>F?24575:0,Y=r.ay(Math.round(j),0,r.aj),J=r.ay(Math.round(H),0,r.aj);C.emplaceBack(Y+Z,J)}let z=(H,j)=>{let Z=j*L+H;A.emplaceBack(Z+1,Z,Z+L),A.emplaceBack(Z+L,Z+L+1,Z+1)};for(let H=1;H<129;H++)for(let j=1;j<129;j++)z(j,H);return[0,129].forEach(H=>{for(let j=0;j<130;j++)z(j,H),z(H,j)}),[C,A,32768]}(),v=t.context;this.gridBuffer=v.createVertexBuffer(h,r.bc.members),this.gridIndexBuffer=v.createIndexBuffer(g),this.gridSegments=r.bd.simpleSegment(0,0,h.length,g.length),this.gridNoSkirtSegments=r.bd.simpleSegment(0,0,h.length,_),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new bh(o.map),this.orthoMatrix=r.bz(),r.ca(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,r.aj,0,r.aj,0,1);let E=v.gl;this._overlapStencilMode=new Lt({func:E.GEQUAL,mask:255},0,255,E.KEEP,E.KEEP,E.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=o,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Wp(o.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,o,h){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);let g=t.terrain.properties,_=t.terrain.drapeRenderMode===0,v=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=r.q.now();let E=t.terrain&&t.terrain.scope,T=g.get("source"),C=_?this._mockSourceCache:t.getSourceCache(T,E);if(!C)return void r.w(`Couldn't find terrain source "${T}".`);if(this.sourceCache=C,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=v?this.calculateExaggeration(o):g.get("exaggeration"),!o.projection.requiresDraping&&v&&this._exaggeration===0)return void this._disable();this.enabled=!0;let A=()=>{this.sourceCache.used&&r.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let L=this.getScaledDemTileSize();this.sourceCache.update(o,L,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,A(),this._initializing=!0),A(),o.updateElevation(!0,h),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(o),this._emptyDEMTextureDirty=!0,this._previousZoom=o.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);let o=this._previousCameraAltitude,h=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=h;let g=o!=null?h-o:Number.MAX_VALUE;if(Math.abs(g)<2)return this._exaggeration;let _=t.zoom,v=this._style.terrain;if(!this._previousUpdateTimestamp)return v.getExaggeration(_);let E=_-this._previousZoom,T=this._previousUpdateTimestamp,C=_;this._evaluationZoom!=null&&(C=this._evaluationZoom,Math.abs(_-C)>.5&&(E=.5*(_-C+E)),E*g<0&&(C+=E)),this._evaluationZoom=C;let A=v.getExaggeration(C),L=A===v.getExaggeration(Math.max(0,C-.1));if(L&&Math.abs(A-this._exaggeration)<.01)return A;let R=Math.min(.1,.00375*(this._updateTimestamp-T));return(L||A<.1||Math.abs(E)<1e-4)&&(R=Math.min(.2,4*R)),r.ai(this._exaggeration,A,R)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let o=this.proxySourceCache,h=this.painter.transform;this._initializing&&(this._initializing=h._centerAltitude===0&&this.getAtPointOrZero(r.ac.fromLngLat(h.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let g=this.proxyCoords=o.getIds().map(T=>{let C=o.getTileByID(T).tileID;return C.projMatrix=h.calculateProjMatrix(C.toUnwrapped()),C});(function(T,C){let A=C.transform.pointCoordinate(C.transform.getCameraPoint()),L=new r.P(A.x,A.y);T.sort((R,F)=>{if(F.overscaledZ-R.overscaledZ)return F.overscaledZ-R.overscaledZ;let V=new r.P(R.canonical.x+(1<<R.canonical.z)*R.wrap,R.canonical.y),z=new r.P(F.canonical.x+(1<<F.canonical.z)*F.wrap,F.canonical.y),H=L.mult(1<<R.canonical.z);return H.x-=.5,H.y-=.5,H.distSqr(V)-H.distSqr(z)})})(g,this.painter);let _=this.proxyToSource||{};this.proxyToSource={},g.forEach(T=>{this.proxyToSource[T.key]={}}),this.terrainTileForTile={};let v=this._style._mergedSourceCaches;for(let T in v){let C=v[T];if(!C.used||(C!==this.sourceCache&&this.resetTileLookupCache(C.id),this._setupProxiedCoordsForOrtho(C,t[T],_),C.usedForTerrain))continue;let A=t[T];C.getSource().reparseOverscaled&&this._assignTerrainTiles(A)}this.proxiedCoords[o.id]=g.map(T=>new Uu(T,T.key,this.orthoMatrix)),this._assignTerrainTiles(g),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(_),this.renderingToTexture=!1;let E={};this._visibleDemTiles=[];for(let T of this.proxyCoords){let C=this.terrainTileForTile[T.key];if(!C)continue;let A=C.tileID.key;A in E||(this._visibleDemTiles.push(C),E[A]=A)}}_assignTerrainTiles(t){this._initializing||t.forEach(o=>{if(this.terrainTileForTile[o.key])return;let h=this._findTileCoveringTileID(o,this.sourceCache);h&&(this.terrainTileForTile[o.key]=h)})}_prepareDEMTextures(){let t=this.painter.context,o=t.gl;for(let h in this.terrainTileForTile){let g=this.terrainTileForTile[h],_=g.dem;!_||g.demTexture&&!g.needsDEMTextureUpload||(t.activeTexture.set(o.TEXTURE1),kp(this.painter,g,_))}}_prepareDemTileUniforms(t,o,h,g){if(!o||o.demTexture==null)return!1;let _=t.tileID.canonical,v=Math.pow(2,o.tileID.canonical.z-_.z),E=g||"";return h[`u_dem_tl${E}`]=[_.x*v%1,_.y*v%1],h[`u_dem_scale${E}`]=v,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0,o=this._visibleDemTiles.reduce((h,g)=>{if(!g.dem)return h;let _=g.dem.tree.minimums[0];return _>0&&t++,h+_},0);return t?o/t:0}_updateEmptyDEMTexture(){let t=this.painter.context,o=t.gl;t.activeTexture.set(o.TEXTURE2);let h=this._getLoadedAreaMinimum(),g=new r.dG({width:1,height:1},new Float32Array([h]));this._emptyDEMTextureDirty=!1;let _=this._emptyDEMTexture;return _?_.update(g,{premultiply:!1}):_=this._emptyDEMTexture=new r.T(t,g,o.R32F,{premultiply:!1}),_}setupElevationDraw(t,o,h){let g=this.painter.context,_=g.gl,v={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};v.u_exaggeration=this.exaggeration();let E=null,T=null,C=1;if(h&&h.morphing&&this._useVertexMorphing){let F=h.morphing.srcDemTile,V=h.morphing.dstDemTile;C=h.morphing.phase,F&&V&&(this._prepareDemTileUniforms(t,F,v,"_prev")&&(T=F),this._prepareDemTileUniforms(t,V,v)&&(E=V))}let A=F=>F&&F.demTexture&&this.painter.linearFloatFilteringSupported()?_.LINEAR:_.NEAREST,L=null;var R;if(this.enabled?T&&E?(L=E.demTexture,g.activeTexture.set(_.TEXTURE4),T.demTexture.bind(A(T),_.CLAMP_TO_EDGE),v.u_dem_lerp=C):(E=this.terrainTileForTile[t.tileID.key],L=this._prepareDemTileUniforms(t,E,v)?E.demTexture:this.emptyDEMTexture):L=this.emptyDEMTexture,g.activeTexture.set(_.TEXTURE2),L&&(v.u_dem_size=(R=L).size[0]===1?1:R.size[0]-2,L.bind(A(E),_.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(h&&h.useDepthForOcclusion,o,v),h&&h.useMeterToDem&&E){let F=(1<<E.tileID.canonical.z)*r.cb(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;v.u_meter_to_dem=F}if(h&&h.labelPlaneMatrixInv&&(v.u_label_plane_matrix_inv=h.labelPlaneMatrixInv),o.setTerrainUniformValues(g,v),this.painter.transform.projection.name==="globe"){let F=this.globeUniformValues(this.painter.transform,t.tileID.canonical,h&&h.useDenormalizedUpVectorScale);o.setGlobeUniformValues(g,F)}}globeUniformValues(t,o,h){let g=t.projection;return{u_tile_tl_up:g.upVector(o,0,0),u_tile_tr_up:g.upVector(o,r.aj,0),u_tile_br_up:g.upVector(o,r.aj,r.aj),u_tile_bl_up:g.upVector(o,0,r.aj),u_tile_up_scale:h?r.dH(1):g.upVectorScale(o,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){let o=this.painter,h=this.painter.context;t.length!==0&&(h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),o.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(g,_,v,E,T){if(g.transform.projection.name==="globe")(function(C,A,L,R,F){let V=C.context,z=V.gl,H,j,Z=C.transform,Y=r.dy(C,V,Z),J=(Ne,Ae)=>{if(j===Ae)return;let Ve=[fy[Ae],"PROJECTION_GLOBE_VIEW"];Y&&Ve.push("CUSTOM_ANTIALIASING");let Qe=C.isTileAffectedByFog(Ne);H=C.getOrCreateProgram("globeRaster",{defines:Ve,overrideFog:Qe}),j=Ae},re=C.colorModeForRenderPass(),ce=new gt(z.LEQUAL,gt.ReadWrite,C.depthRangeFor3D);dl.update(F);let de=r.dz(Z),ie=[r.aD(Z.center.lng),r.aH(Z.center.lat)],oe=C.globeSharedBuffers,se=[Z.width*r.q.devicePixelRatio,Z.height*r.q.devicePixelRatio],Te=Float32Array.from(Z.globeMatrix),me={useDenormalizedUpVectorScale:!0};{let Ne=C.transform,Ae=dc(Ne.zoom,A.exaggeration(),A.sourceCache._source.tileSize);j=-1;let Ve=z.TRIANGLES;for(let Qe of R){let Ie=L.getTile(Qe),pe=Lt.disabled,Pe=A.prevTerrainTileForTile[Qe.key],Se=A.terrainTileForTile[Qe.key];$p(Pe,Se)&&dl.newMorphing(Qe.key,Pe,Se,F,250),V.activeTexture.set(z.TEXTURE0),Ie.texture&&Ie.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);let He=dl.getMorphValuesForProxy(Qe.key),Ge=He?1:0;He&&r.L(me,{morphing:{srcDemTile:He.from,dstDemTile:He.to,phase:r.dx(He.phase)}});let We=r.dA(Qe.canonical),ot=r.dB(We.getCenter().lat),bt=r.dC(Qe.canonical,We,ot,Ne.worldSize/Ne._pixelsPerMercatorPixel),St=r.bh(r.dD(Qe.canonical)),ft=vh(Ne.expandedFarZProjMatrix,Te,de,St,r.ah(Ne.zoom),ie,Ne.frustumCorners.TL,Ne.frustumCorners.TR,Ne.frustumCorners.BR,Ne.frustumCorners.BL,Ne.globeCenterInViewSpace,Ne.globeRadius,se,Ae,Ne._farZ,bt);if(J(Qe,Ge),H&&(A.setupElevationDraw(Ie,H,me),C.uploadCommonUniforms(V,H,Qe.toUnwrapped()),oe)){let[Tt,wt,zt]=oe.getGridBuffers(ot,Ae!==0);H.draw(C,Ve,ce,pe,re,Mt.backCCW,ft,"globe_raster",Tt,wt,zt)}}}if(oe&&(C.renderDefaultNorthPole||C.renderDefaultSouthPole)){let Ne=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Y&&Ne.push("CUSTOM_ANTIALIASING"),H=C.getOrCreateProgram("globeRaster",{defines:Ne});for(let Ae of R){let{x:Ve,y:Qe,z:Ie}=Ae.canonical,pe=Qe===0,Pe=Qe===(1<<Ie)-1,[Se,He,Ge,We]=oe.getPoleBuffers(Ie,!1);if(We&&(pe||Pe)){let ot=L.getTile(Ae);V.activeTexture.set(z.TEXTURE0),ot.texture&&ot.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);let bt=r.dE(Ie,Ve,Z),St=r.bh(r.dD(Ae.canonical)),ft=(Tt,wt)=>Tt.draw(C,z.TRIANGLES,ce,Lt.disabled,re,Mt.disabled,vh(Z.expandedFarZProjMatrix,bt,bt,St,0,ie,Z.frustumCorners.TL,Z.frustumCorners.TR,Z.frustumCorners.BR,Z.frustumCorners.BL,Z.globeCenterInViewSpace,Z.globeRadius,se,0,Z._farZ),"globe_pole_raster",wt,Ge,We);A.setupElevationDraw(ot,H,me),C.uploadCommonUniforms(V,H,Ae.toUnwrapped()),pe&&C.renderDefaultNorthPole&&ft(H,Se),Pe&&C.renderDefaultSouthPole&&(bt=r.cP(r.bz(),bt,[1,-1,1]),ft(H,He))}}}})(g,_,v,E,T);else{let C=g.context,A=C.gl,L,R,F=g.shadowRenderer,V=Ts(g,g.longestCutoffRange),z=re=>{if(R===re)return;let ce=[];ce.push(fy[re]),V.shouldRenderCutoff&&ce.push("RENDER_CUTOFF"),F&&(ce.push("RENDER_SHADOWS","DEPTH_TEXTURE"),F.useNormalOffset&&ce.push("NORMAL_OFFSET")),L=g.getOrCreateProgram("terrainRaster",{defines:ce}),R=re},H=g.colorModeForRenderPass(),j=new gt(A.LEQUAL,gt.ReadWrite,g.depthRangeFor3D);dl.update(T);let Z=g.transform,Y=dc(Z.zoom,_.exaggeration(),_.sourceCache._source.tileSize),J=[0,0,0];if(F){let re=g.style.directionalLight,ce=g.style.ambientLight;re&&ce&&(J=ll(g.style,re,ce))}{R=-1;let re=A.TRIANGLES,[ce,de]=[_.gridIndexBuffer,_.gridSegments];for(let ie of E){let oe=v.getTile(ie),se=Lt.disabled,Te=_.prevTerrainTileForTile[ie.key],me=_.terrainTileForTile[ie.key];$p(Te,me)&&dl.newMorphing(ie.key,Te,me,T,250),C.activeTexture.set(A.TEXTURE0),oe.texture&&oe.texture.bind(A.LINEAR,A.CLAMP_TO_EDGE);let Ne=dl.getMorphValuesForProxy(ie.key),Ae=Ne?1:0,Ve;Ne&&(Ve={morphing:{srcDemTile:Ne.from,dstDemTile:Ne.to,phase:r.dx(Ne.phase)}});let Qe=Gp(ie.projMatrix,Vu(ie.canonical,Z.renderWorldCopies)?Y/10:Y,J);if(z(Ae),!L)continue;_.setupElevationDraw(oe,L,Ve);let Ie=ie.toUnwrapped();F&&F.setupShadows(Ie,L),g.uploadCommonUniforms(C,L,Ie,null,V),L.draw(g,re,j,se,H,Mt.backCCW,Qe,"terrain_raster",_.gridBuffer,ce,de)}}}}(o,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,o.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;let o=this.painter,h=this.painter.context,g=this.proxySourceCache,_=this.proxiedCoords[g.id],v=this._drapedRenderBatches.shift(),E=o.style.order,T=[],C=0;for(let A of _){let L=g.getTileByID(A.proxyTileKey),R=g.proxyCachedFBO[A.key]?g.proxyCachedFBO[A.key][t]:void 0,F=R!==void 0?g.renderCache[R]:this.pool[C++],V=R!==void 0;if(L.texture=F.tex,V&&!F.dirty){T.push(L.tileID);continue}let z;h.bindFramebuffer.set(F.fb.framebuffer),this.renderedToTile=!1,F.dirty&&(h.clear({color:r.am.transparent,stencil:0}),F.dirty=!1);for(let H=v.start;H<=v.end;++H){let j=o.style._mergedLayers[E[H]];if(j.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(j),Y=Z?this.proxyToSource[A.key][Z.id]:[A];if(!Y)continue;let J=Y;h.viewport.set([0,0,F.fb.width,F.fb.height]),z!==(Z?Z.id:null)&&(this._setupStencil(F,Y,j,Z),z=Z?Z.id:null),o.renderLayer(o,Z,j,J)}if(this._drapedRenderBatches.length===0)for(let H of this._pendingGroundEffectLayers){let j=o.style._mergedLayers[E[H]];if(j.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(j),Y=Z?this.proxyToSource[A.key][Z.id]:[A];if(!Y)continue;let J=Y;h.viewport.set([0,0,F.fb.width,F.fb.height]),z!==(Z?Z.id:null)&&(this._setupStencil(F,Y,j,Z),z=Z?Z.id:null),o.renderLayer(o,Z,j,J)}this.renderedToTile?(F.dirty=!0,T.push(L.tileID)):V||--C,C===5&&(C=0,this.renderToBackBuffer(T))}return this.renderToBackBuffer(T),this.renderingToTexture=!1,h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),v.end+1}postRender(){}isLayerOrderingCorrect(t){let o=t.order.length,h=-1,g=o;for(let _=0;_<o;++_)this._style.isLayerDraped(t._mergedLayers[t.order[_]])?h=Math.max(h,_):g=Math.min(g,_);return g>h}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(o=>o.dem).forEach(o=>{t=Math.min(t,o.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,o,h){if(!this._visibleDemTiles)return null;let g=this._visibleDemTiles.filter(_=>_.dem).map(_=>{let v=_.tileID,E=1<<v.overscaledZ,{x:T,y:C}=v.canonical,A=T/E,L=(T+1)/E,R=C/E,F=(C+1)/E;return{minx:A,miny:R,maxx:L,maxy:F,t:_.dem.tree.raycastRoot(A,R,L,F,t,o,h),tile:_}});g.sort((_,v)=>(_.t!==null?_.t:Number.MAX_VALUE)-(v.t!==null?v.t:Number.MAX_VALUE));for(let _ of g){if(_.t==null)return null;let v=_.tile.dem.tree.raycast(_.minx,_.miny,_.maxx,_.maxy,t,o,h);if(v!=null)return v}return null}_createFBO(){let t=this.painter.context,o=t.gl,h=this.drapeBufferSize;t.activeTexture.set(o.TEXTURE0);let g=new r.T(t,{width:h[0],height:h[1],data:null},o.RGBA8);g.bind(o.LINEAR,o.CLAMP_TO_EDGE);let _=t.createFramebuffer(h[0],h[1],!0,null);return _.colorAttachment.set(g.texture),_.depthAttachment=new Hp(t,_.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,h[0],h[1]),this._stencilRef=0,_.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):_.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:_,tex:g,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{let o=this._style._mergedLayers[t],h=o.isHidden(this.painter.transform.zoom);return o.type==="hillshade"||o.type==="custom"?!h&&o.shouldRedrape():!h&&o.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(let h of this._style.getSources())if(h instanceof mu){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let g=this._style._mergedLayers[this._style.order[h]],_=this._style.getLayerSourceCache(g);if(_&&!o[_.id]&&!g.isHidden(this.painter.transform.zoom)&&g.type==="line"&&g.widthExpression()instanceof r.ab){o[_.id]=!0;for(let v of this.proxyCoords){let E=this.proxyToSource[v.key][_.id];if(E)for(let T of E)this._clearRenderCacheForTile(_.id,T)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(let h in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[h]._source instanceof vi){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let g=this._style._mergedLayers[this._style.order[h]],_=this._style.getLayerSourceCache(g);if(!_||o[_.id]||g.isHidden(this.painter.transform.zoom)||g.type!=="raster")continue;let v=g.paint.get("raster-fade-duration");for(let E of this.proxyCoords){let T=this.proxyToSource[E.key][_.id];if(T)for(let C of T){let A=no(_.getTile(C),_.findLoadedParent(C,0),_,this.painter.transform,v);(A.opacity!==1||A.mix!==0)&&this._clearRenderCacheForTile(_.id,C)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let t=this._style.order,o=t.length;if(o===0)return;let h=[];this._pendingGroundEffectLayers=[];let g,_=0,v=this._style._mergedLayers[t[_]];for(;!this._style.isLayerDraped(v)&&v.isHidden(this.painter.transform.zoom)&&++_<o;)v=this._style._mergedLayers[t[_]];for(;_<o;++_){let E=this._style._mergedLayers[t[_]];E.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(E)?g===void 0&&(g=_):(E.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(_),g!==void 0&&(h.push({start:g,end:_-1}),g=void 0)))}if(g!==void 0&&h.push({start:g,end:_-1}),h.length!==0){let E=h[h.length-1];this._pendingGroundEffectLayers.every(T=>T>E.end)||r.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=h}_setupRenderCache(t){let o=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,o.renderCache.length>o.renderCachePool.length){let v=Object.values(o.proxyCachedFBO);o.proxyCachedFBO={};for(let E=0;E<v.length;++E){let T=Object.values(v[E]);o.renderCachePool.push(...T)}}return}this._clearRasterLayersFromRenderCache();let h=this.proxyCoords,g=this._tilesDirty;for(let v=h.length-1;v>=0;v--){let E=h[v];if(o.getTileByID(E.key),o.proxyCachedFBO[E.key]!==void 0){let T=t[E.key],C=this.proxyToSource[E.key],A=0;for(let L in C){let R=C[L],F=T[L];if(!F||F.length!==R.length||R.some((V,z)=>V!==F[z]||g[L]&&g[L].hasOwnProperty(V.key))){A=-1;break}++A}for(let L in o.proxyCachedFBO[E.key])o.renderCache[o.proxyCachedFBO[E.key][L]].dirty=A<0||A!==Object.values(T).length}}let _=[...this._drapedRenderBatches];_.sort((v,E)=>E.end-E.start-(v.end-v.start));for(let v of _)for(let E of h){if(o.proxyCachedFBO[E.key])continue;let T=o.renderCachePool.pop();T===void 0&&o.renderCache.length<50&&(T=o.renderCache.length,o.renderCache.push(this._createFBO())),T!==void 0&&(o.proxyCachedFBO[E.key]={},o.proxyCachedFBO[E.key][v.start]=T,o.renderCache[T].dirty=!0)}this._tilesDirty={}}_setupStencil(t,o,h,g){if(!g||!this._sourceTilesOverlap[g.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let _=this.painter.context,v=_.gl;if(o.length<=1)return void(this._overlapStencilType=!1);let E;if(h.isTileClipped())E=o.length,this._overlapStencilMode.test={func:v.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(o[0].overscaledZ>o[o.length-1].overscaledZ))return void(this._overlapStencilType=!1);E=1,this._overlapStencilMode.test={func:v.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+E>255&&(_.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=E,this._overlapStencilMode.ref=this._stencilRef,h.isTileClipped()&&this._renderTileClippingMasks(o,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Lt.disabled}_renderTileClippingMasks(t,o){let h=this.painter,g=this.painter.context,_=g.gl;h._tileClippingMaskIDs={},g.setColorMode(Yt.disabled),g.setDepthMode(gt.disabled);let v=h.getOrCreateProgram("clippingMask");for(let E of t){let T=h._tileClippingMaskIDs[E.key]=--o;v.draw(h,_.TRIANGLES,gt.disabled,new Lt({func:_.ALWAYS,mask:0},T,255,_.KEEP,_.KEEP,_.REPLACE),Yt.disabled,Mt.disabled,xh(E.projMatrix),"$clipping",h.tileExtentBuffer,h.quadTriangleIndexBuffer,h.tileExtentSegments)}}pointCoordinate(t){let o=this.painter.transform;if(t.x<0||t.x>o.width||t.y<0||t.y>o.height)return null;let h=[t.x,t.y,1,1];r.aA(h,h,o.pixelMatrixInverse),r.cH(h,h,1/h[3]),h[0]/=o.worldSize,h[1]/=o.worldSize;let g=o._camera.position,_=r.cb(1,o.center.lat),v=[g[0],g[1],g[2]/_,0],E=r.d7([],h.slice(0,3),v);r.au(E,E);let T=this.raycast(v,E,this._exaggeration);return T!==null&&T?(r.bE(v,v,E,T),v[3]=v[2],v[2]*=_,v):null}_setupProxiedCoordsForOrtho(t,o,h){if(t.getSource()instanceof r.aP)return this._setupProxiedCoordsForImageSource(t,o,h);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};let g=this.proxiedCoords[t.id]=[],_=this.proxyCoords;for(let T=0;T<_.length;T++){let C=_[T],A=this._findTileCoveringTileID(C,t);if(A){let L=this._createProxiedId(C,A,h[C.key]&&h[C.key][t.id]);g.push(L),this.proxyToSource[C.key][t.id]=[L]}}let v=!1,E=new Set;for(let T=0;T<o.length;T++){let C=t.getTile(o[T]);if(!C||!C.hasData())continue;let A=this._findTileCoveringTileID(C.tileID,this.proxySourceCache);if(A&&A.tileID.canonical.z!==C.tileID.canonical.z){let L=this.proxyToSource[A.tileID.key][t.id],R=this._createProxiedId(A.tileID,C,h[A.tileID.key]&&h[A.tileID.key][t.id]);L?L.splice(L.length-1,0,R):this.proxyToSource[A.tileID.key][t.id]=[R];let F=this.proxyToSource[A.tileID.key][t.id];E.has(F)||E.add(F),g.push(R),v=!0}}if(this._sourceTilesOverlap[t.id]=v,v&&this._debugParams.sortTilesHiZFirst)for(let T of E)T.sort((C,A)=>A.overscaledZ-C.overscaledZ)}_setupProxiedCoordsForImageSource(t,o,h){if(!t.getSource().loaded())return;let g=this.proxiedCoords[t.id]=[],_=this.proxyCoords,v=t.getSource(),E=v.tileID;if(!E)return;let T=new r.P(E.x,E.y)._div(1<<E.z),C=v.coordinates.map(r.ac.fromLngLat).reduce((L,R)=>(L.min.x=Math.min(L.min.x,R.x-T.x),L.min.y=Math.min(L.min.y,R.y-T.y),L.max.x=Math.max(L.max.x,R.x-T.x),L.max.y=Math.max(L.max.y,R.y-T.y),L),{min:new r.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new r.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),A=(L,R)=>{let F=L.wrap+L.canonical.x/(1<<L.canonical.z),V=L.canonical.y/(1<<L.canonical.z),z=r.aj/(1<<L.canonical.z),H=R.wrap+R.canonical.x/(1<<R.canonical.z),j=R.canonical.y/(1<<R.canonical.z);return F+z<H+C.min.x||F>H+C.max.x||V+z<j+C.min.y||V>j+C.max.y};for(let L=0;L<_.length;L++){let R=_[L];for(let F=0;F<o.length;F++){let V=t.getTile(o[F]);if(!V||!V.hasData()||A(R,V.tileID))continue;let z=this._createProxiedId(R,V,h[R.key]&&h[R.key][t.id]),H=this.proxyToSource[R.key][t.id];H?H.push(z):this.proxyToSource[R.key][t.id]=[z],g.push(z)}}}_createProxiedId(t,o,h){let g=this.orthoMatrix;if(h){let _=h.find(v=>v.key===o.tileID.key);if(_)return _}if(o.tileID.key!==t.key){let _=t.canonical.z-o.tileID.canonical.z,v,E,T;g=r.bz();let C=o.tileID.wrap-t.wrap<<t.overscaledZ;_>0?(v=r.aj>>_,E=v*((o.tileID.canonical.x<<_)-t.canonical.x+C),T=v*((o.tileID.canonical.y<<_)-t.canonical.y)):(v=r.aj<<-_,E=r.aj*(o.tileID.canonical.x-(t.canonical.x+C<<-_)),T=r.aj*(o.tileID.canonical.y-(t.canonical.y<<-_))),r.ca(g,0,v,0,v,0,1),r.bo(g,g,[E,T,0])}return new Uu(o.tileID,t.key,g)}_findTileCoveringTileID(t,o){let h=o.getTile(t);if(h&&h.hasData())return h;let g=this._findCoveringTileCache[o.id],_=g[t.key];if(h=_?o.getTileByID(_):null,h&&h.hasData()||_===null)return h;let v=h?h.tileID:t,E=v.overscaledZ,T=o.getSource().minzoom,C=[];if(!_){let L=o.getSource().maxzoom;if(t.canonical.z>=L){let R=t.canonical.z-L;o.getSource().reparseOverscaled?(E=Math.max(t.canonical.z+2,o.transform.tileZoom),v=new r.aM(E,t.wrap,L,t.canonical.x>>R,t.canonical.y>>R)):R!==0&&(E=L,v=new r.aM(E,t.wrap,L,t.canonical.x>>R,t.canonical.y>>R))}v.key!==t.key&&(C.push(v.key),h=o.getTile(v))}let A=L=>{C.forEach(R=>{g[R]=L}),C.length=0};for(E-=1;E>=T&&(!h||!h.hasData());E--){h&&A(h.tileID.key);let L=v.calculateScaledKey(E);if(h=o.getTileByID(L),h&&h.hasData())break;let R=g[L];if(R===null)break;R===void 0?C.push(L):h=o.getTileByID(R)}return A(h?h.tileID.key:null),h&&h.hasData()?h:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,o){let h=this._tilesDirty[t];h||(h=this._tilesDirty[t]={}),h[o.key]=!0}}function Zp(d,t,o){let h=function(E,T,C){let A=r.bG(T,E),L=r.bG(C,[.2126,.7152,.0722]),R=(V,z,H)=>(1-H)*V+H*z,F=R(1-.3*Math.min(L,1),1,Math.min(A+1,1));return R(.92,1,Math.asin(r.ay(T[2],-1,1))/Math.PI+.5)*F}(d,[0,0,1],t),g=[0,0,0];r.c1(g,o.slice(0,3),h);let _=[0,0,0];r.c1(_,t.slice(0,3),d[2]);let v=[0,0,0];return r.d5(v,g,_),r.d8(v)}let qp=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Eh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Th{static cacheKey(t,o,h,g){let _=`${o}${g?g.cacheKey:""}`;for(let v of h)t.usedDefines.includes(v)&&(_+=`/${v}`);return _}constructor(t,o,h,g,_,v){let E=t.gl;this.program=E.createProgram(),this.configuration=g,this.name=o,this.fixedDefines=[...v];let T=g?g.getBinderAttributes():[],C=(h.staticAttributes||[]).concat(T),A=g?g.defines():[];A=A.concat(v.map(H=>`#define ${H}`));let L=`#version 300 es
`,R=L+A.concat("precision mediump float;",Ta,dh.fragmentSource).join(`
`);for(let H of h.fragmentIncludes)R+=`
${cl[H]}`;R+=`
${h.fragmentSource}`;let F=L+A.concat("precision highp float;",Ta,dh.vertexSource).join(`
`);for(let H of h.vertexIncludes)F+=`
${cl[H]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&h.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(F+=`
uniform int u_instanceID;
`),F+=`
${h.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(F=F.replaceAll("gl_InstanceID","u_instanceID"));let V=E.createShader(E.FRAGMENT_SHADER);if(E.isContextLost())return void(this.failedToCreate=!0);E.shaderSource(V,R),E.compileShader(V),E.attachShader(this.program,V);let z=E.createShader(E.VERTEX_SHADER);if(E.isContextLost())this.failedToCreate=!0;else{E.shaderSource(z,F),E.compileShader(z),E.attachShader(this.program,z),this.attributes={},this.numAttributes=C.length;for(let H=0;H<this.numAttributes;H++)if(C[H]){let j=C[H].startsWith("a_")?C[H]:`a_${C[H]}`;E.bindAttribLocation(this.program,H,j),this.attributes[j]=H}E.linkProgram(this.program),E.deleteShader(z),E.deleteShader(V),this.fixedUniforms=_(t),this.binderUniforms=g?g.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(H=>({u_instanceID:new r.cd(H)}))(t)),(v.includes("TERRAIN")||o.indexOf("symbol")!==-1||o.indexOf("circle")!==-1)&&(this.terrainUniforms=(H=>({u_dem:new r.cd(H),u_dem_prev:new r.cd(H),u_dem_tl:new r.cg(H),u_dem_scale:new r.cf(H),u_dem_tl_prev:new r.cg(H),u_dem_scale_prev:new r.cf(H),u_dem_size:new r.cf(H),u_dem_lerp:new r.cf(H),u_exaggeration:new r.cf(H),u_depth:new r.cd(H),u_depth_size_inv:new r.cg(H),u_depth_range_unpack:new r.cg(H),u_occluder_half_size:new r.cf(H),u_occlusion_depth_offset:new r.cf(H),u_meter_to_dem:new r.cf(H),u_label_plane_matrix_inv:new r.ch(H)}))(t)),v.includes("GLOBE")&&(this.globeUniforms=(H=>({u_tile_tl_up:new r.ce(H),u_tile_tr_up:new r.ce(H),u_tile_br_up:new r.ce(H),u_tile_bl_up:new r.ce(H),u_tile_up_scale:new r.cf(H)}))(t)),v.includes("FOG")&&(this.fogUniforms=(H=>({u_fog_matrix:new r.ch(H),u_fog_range:new r.cg(H),u_fog_color:new r.d0(H),u_fog_horizon_blend:new r.cf(H),u_fog_vertical_limit:new r.cg(H),u_fog_temporal_offset:new r.cf(H),u_frustum_tl:new r.ce(H),u_frustum_tr:new r.ce(H),u_frustum_br:new r.ce(H),u_frustum_bl:new r.ce(H),u_globe_pos:new r.ce(H),u_globe_radius:new r.cf(H),u_globe_transition:new r.cf(H),u_is_globe:new r.cd(H),u_viewport:new r.cg(H)}))(t)),v.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(H=>({u_cutoff_params:new r.d0(H)}))(t)),v.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(H=>({u_lighting_ambient_color:new r.ce(H),u_lighting_directional_dir:new r.ce(H),u_lighting_directional_color:new r.ce(H),u_ground_radiance:new r.ce(H)}))(t)),v.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(H=>({u_light_matrix_0:new r.ch(H),u_light_matrix_1:new r.ch(H),u_fade_range:new r.cg(H),u_shadow_normal_offset:new r.ce(H),u_shadow_intensity:new r.cf(H),u_shadow_texel_size:new r.cf(H),u_shadow_map_resolution:new r.cf(H),u_shadow_direction:new r.ce(H),u_shadow_bias:new r.ce(H),u_shadowmap_0:new r.cd(H),u_shadowmap_1:new r.cd(H)}))(t))}}setTerrainUniformValues(t,o){if(!this.terrainUniforms)return;let h=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g]&&h[g].set(this.program,g,o[g])}}setGlobeUniformValues(t,o){if(!this.globeUniforms)return;let h=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g]&&h[g].set(this.program,g,o[g])}}setFogUniformValues(t,o){if(!this.fogUniforms)return;let h=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setCutoffUniformValues(t,o){if(!this.cutoffUniforms)return;let h=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setLightsUniformValues(t,o){if(!this.lightsUniforms)return;let h=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setShadowUniformValues(t,o){if(this.failedToCreate||!this.shadowUniforms)return;let h=this.shadowUniforms;t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}_drawDebugWireframe(t,o,h,g,_,v,E,T,C,A){let L=t.options.wireframe;if(L.terrain===!1&&L.layers2D===!1&&L.layers3D===!1)return;let R=t.context;if(!(!(!L.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!L.layers2D||t._terrain&&t._terrain.renderingToTexture||!qp.includes(this.name))||!(!L.layers3D||!Eh.includes(this.name))))return;let F=R.gl,V=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,_,R);if(!V)return;let z=[...this.fixedDefines];z.push("DEBUG_WIREFRAME");let H=t.getOrCreateProgram(this.name,{config:this.configuration,defines:z});R.program.set(H.program);let j=(J,re,ce)=>{if(re[J]&&ce[J])for(let de in re[J])ce[J][de]&&ce[J][de].set(ce.program,de,re[J][de].current)};C&&C.setUniforms(H.program,R,H.binderUniforms,E,{zoom:T}),j("fixedUniforms",this,H),j("terrainUniforms",this,H),j("globeUniforms",this,H),j("fogUniforms",this,H),j("lightsUniforms",this,H),j("shadowUniforms",this,H),V.bind(),R.setColorMode(new Yt([F.ONE,F.ONE_MINUS_SRC_ALPHA,F.ZERO,F.ONE],r.am.transparent,[!0,!0,!0,!1])),R.setDepthMode(new gt(o.func===F.LESS?F.LEQUAL:o.func,gt.ReadOnly,o.range)),R.setStencilMode(Lt.disabled);let Z=3*v.primitiveLength*2,Y=3*v.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){let J=A||1;for(let re=0;re<J;++re)H.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",re),F.drawElements(F.LINES,Z,F.UNSIGNED_SHORT,Y)}else A&&A>1?F.drawElementsInstanced(F.LINES,Z,F.UNSIGNED_SHORT,Y,A):F.drawElements(F.LINES,Z,F.UNSIGNED_SHORT,Y);_.bind(),R.program.set(this.program),R.setDepthMode(o),R.setStencilMode(h),R.setColorMode(g)}checkUniforms(t,o,h){if(this.fixedDefines.includes(o)){for(let g of Object.keys(h))if(!h[g].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${g} not set but required by ${o} being defined`)}}draw(t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H){let j=t.context,Z=j.gl;if(this.failedToCreate)return;j.program.set(this.program),j.setDepthMode(h),j.setStencilMode(g),j.setColorMode(_),j.setCullFace(v);for(let re of Object.keys(this.fixedUniforms))this.fixedUniforms[re].set(this.program,re,E[re]);V&&V.setUniforms(this.program,j,this.binderUniforms,R,{zoom:F});let Y={[Z.POINTS]:1,[Z.LINES]:2,[Z.TRIANGLES]:3,[Z.LINE_STRIP]:1}[o];this.checkUniforms(T,"RENDER_SHADOWS",this.shadowUniforms);let J=H&&H>0?1:void 0;for(let re of L.get()){let ce=re.vaos||(re.vaos={});if((ce[T]||(ce[T]=new Rb)).bind(j,this,C,V?V.getPaintVertexBuffers():[],A,re.vertexOffset,z||[],J),this.forceManualRenderingForInstanceIDShaders){let de=H||1;for(let ie=0;ie<de;++ie)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ie),A?Z.drawElements(o,re.primitiveLength*Y,Z.UNSIGNED_SHORT,re.primitiveOffset*Y*2):Z.drawArrays(o,re.vertexOffset,re.vertexLength)}else H&&H>1?Z.drawElementsInstanced(o,re.primitiveLength*Y,Z.UNSIGNED_SHORT,re.primitiveOffset*Y*2,H):A?Z.drawElements(o,re.primitiveLength*Y,Z.UNSIGNED_SHORT,re.primitiveOffset*Y*2):Z.drawArrays(o,re.vertexOffset,re.vertexLength);o===Z.TRIANGLES&&A&&this._drawDebugWireframe(t,h,g,_,A,re,R,F,V,H)}}}function Ih(d,t,o=0){let h=Math.pow(2,t.tileID.overscaledZ),g=t.tileSize*Math.pow(2,d.transform.tileZoom)/h,_=g*(t.tileID.canonical.x+t.tileID.wrap*h),v=g*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/r.aw(t,1,d.transform.tileZoom),u_pixel_coord_upper:[_>>16,v>>16],u_pixel_coord_lower:[65535&_,65535&v],u_pattern_transition:o}}let hl={terrain:0,flat:1},Xp=r.bz(),Yp=(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j)=>{let Z=t.style.light,Y=Z.properties.get("position"),J=[Y.x,Y.y,Y.z],re=r.dJ();Z.properties.get("anchor")==="viewport"&&(r.dK(re,-t.transform.angle),r.dL(J,J,re));let ce=Z.properties.get("color").toPremultipliedRenderColor(null),de=t.transform,ie={u_matrix:d,u_lightpos:J,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[ce.r,ce.g,ce.b],u_vertical_gradient:+o,u_opacity:h,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Xp,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:hl[C],u_base_type:hl[A],u_ao:g,u_edge_radius:_,u_width_scale:v,u_flood_light_color:V,u_vertical_scale:z,u_flood_light_intensity:H,u_ground_shadow_factor:j};return de.projection.name==="globe"&&(ie.u_tile_id=[E.canonical.x,E.canonical.y,1<<E.canonical.z],ie.u_zoom_transition=L,ie.u_inv_rot_matrix=F,ie.u_merc_center=R,ie.u_up_dir=de.projection.upVector(new r.cA(0,0,0),R[0]*r.aj,R[1]*r.aj),ie.u_height_lift=T),ie},py=(d,t,o,h,g,_)=>({u_matrix:d,u_edge_radius:t,u_width_scale:o,u_vertical_scale:h,u_height_type:hl[g],u_base_type:hl[_]}),hc=(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j)=>{let Z=Yp(d,t,o,h,g,_,v,E,C,A,L,R,F,V,z,H,1,[0,0,0]),Y={u_height_factor:-Math.pow(2,E.overscaledZ)/T.tileSize/8};return r.h(Z,Ih(t,T,j),Y)},my=(d,t,o)=>({u_matrix:d,u_emissive_strength:t,u_ground_shadow_factor:o}),gy=(d,t,o,h,g,_=0)=>r.h(my(d,t,g),Ih(o,h,_)),Vb=(d,t,o,h)=>({u_matrix:d,u_world:o,u_emissive_strength:t,u_ground_shadow_factor:h}),Ub=(d,t,o,h,g,_,v=0)=>r.h(gy(d,t,o,h,_,v),{u_world:g}),jb=(d,t)=>({u_matrix:d,u_ground_shadow_factor:t}),Sh=(d,t,o,h,g)=>({u_matrix:d,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:o,u_height_scale:h,u_reset_depth:g}),Kp=(d,t)=>({u_matrix:d,u_normal_matrix:t,u_opacity:1}),Jp=d=>({u_matrix:d}),_y=d=>({u_matrix:d}),fc=(d,t,o,h,g,_,v,E)=>{let T=r.aj/_.tileSize;return{u_matrix:d,u_inv_rot_matrix:t,u_camera_to_center_distance:o.getCameraToCenterDistance(E),u_extrude_scale:[o.pixelsToGLUnits[0]/T,o.pixelsToGLUnits[1]/T],u_zoom_transition:h,u_tile_id:v,u_merc_center:g}},Qp=(d,t,o=1)=>({u_matrix:d,u_color:t,u_overlay:0,u_overlay_scale:o}),yy=r.bz(),vy=(d,t,o,h,g,_,v)=>{let E=d.transform,T=E.projection.name==="globe",C=T?r.dM(E.zoom,t.canonical)*E._pixelsPerMercatorPixel:r.aw(o,1,_),A={u_matrix:t.projMatrix,u_extrude_scale:C,u_intensity:v,u_inv_rot_matrix:yy,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(T){A.u_inv_rot_matrix=h,A.u_merc_center=g,A.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],A.u_zoom_transition=r.ah(E.zoom);let L=g[0]*r.aj,R=g[1]*r.aj;A.u_up_dir=E.projection.upVector(new r.cA(0,0,0),L,R)}return A};function Dh(d,[t,o,h,g],[_,v]){if(_===v)return[0,0,0,0];let E=255*(d-1)/(d*(v-_));return[t*E,o*E,h*E,g*E]}function Ia(d,t,[o,h]){return o===h?0:.5/d+(t-o)*(d-1)/(d*(h-o))}let em=(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j,Z,Y,J)=>({u_matrix:d,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:g,u_tl_parent:_,u_scale_parent:C,u_fade_t:A.mix,u_opacity:A.opacity*L.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:L.paint.get("raster-brightness-min"),u_brightness_high:L.paint.get("raster-brightness-max"),u_saturation_factor:r.dO(L.paint.get("raster-saturation")),u_contrast_factor:r.dN(L.paint.get("raster-contrast")),u_spin_weights:Sa(L.paint.get("raster-hue-rotate")),u_perspective_transform:R,u_raster_elevation:F,u_zoom_transition:v,u_merc_center:E,u_cutoff_params:T,u_colorization_mix:Dh(r.dP,z,j),u_colorization_offset:Ia(r.dP,H,j),u_color_ramp:V,u_texture_offset:[Y/(Z+2*Y),Z/(Z+2*Y)],u_texture_res:[Z+2*Y,Z+2*Y],u_emissive_strength:J});function Sa(d){d*=Math.PI/180;let t=Math.sin(d),o=Math.cos(d);return[(2*o+1)/3,(-Math.sqrt(3)*t-o+1)/3,(Math.sqrt(3)*t-o+1)/3]}let Da=.05,Ch=(d,t,o,h,g,_,v,E,T,C,A,L)=>({u_matrix:d,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:g,u_tl_parent:_,u_scale_parent:C,u_fade_t:A.mix,u_opacity:A.opacity,u_image0:0,u_image1:1,u_raster_elevation:L,u_zoom_transition:v,u_merc_center:E,u_cutoff_params:T}),xy=(d,t,o,h,g,_,v,E,T,C)=>({u_particle_texture:d,u_particle_texture_side_len:t,u_tile_offset:o,u_velocity:h,u_color_ramp:_,u_velocity_res:g,u_max_speed:v,u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[Da,Da]}),by=(d,t,o,h,g,_,v,E,T,C)=>({u_particle_texture:d,u_particle_texture_side_len:t,u_velocity:o,u_velocity_res:h,u_max_speed:g,u_speed_factor:_,u_reset_rate:v,u_rand_seed:Math.random(),u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[Da,Da]}),Ah=r.bz(),Mh=(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j,Z,Y,J,re,ce,de)=>{let ie=g.transform,oe={u_is_size_zoom_constant:+(d==="constant"||d==="source"),u_is_size_feature_constant:+(d==="constant"||d==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:ie.getCameraToCenterDistance(Z),u_rotate_symbol:+o,u_aspect_ratio:ie.width/ie.height,u_fade_change:g.options.fadeDuration?g.symbolFadeChange:1,u_matrix:_,u_label_plane_matrix:v,u_coord_matrix:E,u_is_text:+C,u_elevation_from_sea:T?1:0,u_pitch_with_map:+h,u_texsize:A,u_texsize_icon:L,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Ah,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Ah,u_up_vector:[0,-1,0],u_color_adj_mat:re,u_icon_transition:ce||0,u_gamma_scale:h?g.transform.getCameraToCenterDistance(Z)*Math.cos(g.terrain?0:g.transform._pitch):1,u_device_pixel_ratio:r.q.devicePixelRatio,u_is_halo:1,u_scale_factor:de||1,u_ground_shadow_factor:Y,u_inv_matrix:r.bi(r.bz(),v),u_normal_scale:J};return Z.name==="globe"&&(oe.u_tile_id=[F.canonical.x,F.canonical.y,1<<F.canonical.z],oe.u_zoom_transition=V,oe.u_inv_rot_matrix=H,oe.u_merc_center=z,oe.u_camera_forward=ie._camera.forward(),oe.u_ecef_origin=r.dQ(ie.globeMatrix,F.toUnwrapped()),oe.u_tile_matrix=Float32Array.from(ie.globeMatrix),oe.u_up_vector=j),oe},wy=(d,t,o,h)=>({u_matrix:d,u_emissive_strength:t,u_opacity:o,u_color:h}),tm=(d,t,o,h,g,_,v,E,T)=>r.h(function(C,A,L,R,F,V){let{width:z,height:H}=R.imageManager.getPixelSize(A),j=Math.pow(2,V.tileID.overscaledZ),Z=V.tileSize*Math.pow(2,R.transform.tileZoom)/j,Y=Z*(V.tileID.canonical.x+V.tileID.wrap*j),J=Z*V.tileID.canonical.y;return{u_image:0,u_pattern_tl:L.tl,u_pattern_br:L.br,u_texsize:[z,H],u_pattern_size:L.displaySize,u_pattern_units_to_pixels:F?[R.transform.width,-1*R.transform.height]:[1/r.aw(V,1,R.transform.tileZoom),1/r.aw(V,1,R.transform.tileZoom)],u_pixel_coord_upper:[Y>>16,J>>16],u_pixel_coord_lower:[65535&Y,65535&J]}}(0,_,v,h,E,T),{u_matrix:d,u_emissive_strength:t,u_opacity:o}),fl=new Float32Array(r.bx([])),nm=(d,t,o,h,g,_,v,E,T,C,A,L,R,F=[0,0,0],V)=>{let z=g.style.light,H=z.properties.get("position"),j=[-H.x,-H.y,H.z],Z=r.dJ();z.properties.get("anchor")==="viewport"&&(r.dK(Z,-g.transform.angle),r.dL(j,j,Z));let Y=A.alphaMode==="MASK",J=z.properties.get("color").toNonPremultipliedRenderColor(null),re=R.paint.get("model-ambient-occlusion-intensity"),ce=R.paint.get("model-color").constantOr(r.am.white).toNonPremultipliedRenderColor(null);return ce.a=R.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:d,u_lighting_matrix:t,u_normal_matrix:o,u_node_matrix:h||fl,u_lightpos:j,u_lightintensity:z.properties.get("intensity"),u_lightcolor:[J.r,J.g,J.b],u_camera_pos:F,u_opacity:_,u_baseTextureIsAlpha:0,u_alphaMask:+Y,u_alphaCutoff:A.alphaCutoff,u_baseColorFactor:v.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:E.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:T,u_roughnessFactor:C,u_baseColorTexture:Vi.BaseColor,u_metallicRoughnessTexture:Vi.MetallicRoughness,u_normalTexture:Vi.Normal,u_occlusionTexture:Vi.Occlusion,u_emissionTexture:Vi.Emission,u_lutTexture:Vi.LUT,u_color_mix:ce.toArray01(),u_aoIntensity:re,u_emissive_strength:L,u_occlusionTextureTransform:V||[0,0,0,0]}},Ey=(d,t=fl,o=fl)=>({u_matrix:d,u_instance:t,u_node_matrix:o}),Ty={fillExtrusion:d=>({u_matrix:new r.ch(d),u_lightpos:new r.ce(d),u_lightintensity:new r.cf(d),u_lightcolor:new r.ce(d),u_vertical_gradient:new r.cf(d),u_opacity:new r.cf(d),u_edge_radius:new r.cf(d),u_width_scale:new r.cf(d),u_ao:new r.cg(d),u_height_type:new r.cd(d),u_base_type:new r.cd(d),u_tile_id:new r.ce(d),u_zoom_transition:new r.cf(d),u_inv_rot_matrix:new r.ch(d),u_merc_center:new r.cg(d),u_up_dir:new r.ce(d),u_height_lift:new r.cf(d),u_flood_light_color:new r.ce(d),u_vertical_scale:new r.cf(d),u_flood_light_intensity:new r.cf(d),u_ground_shadow_factor:new r.ce(d)}),fillExtrusionDepth:d=>({u_matrix:new r.ch(d),u_edge_radius:new r.cf(d),u_width_scale:new r.cf(d),u_vertical_scale:new r.cf(d),u_height_type:new r.cd(d),u_base_type:new r.cd(d)}),fillExtrusionPattern:d=>({u_matrix:new r.ch(d),u_lightpos:new r.ce(d),u_lightintensity:new r.cf(d),u_lightcolor:new r.ce(d),u_vertical_gradient:new r.cf(d),u_height_factor:new r.cf(d),u_edge_radius:new r.cf(d),u_width_scale:new r.cf(d),u_ao:new r.cg(d),u_height_type:new r.cd(d),u_base_type:new r.cd(d),u_tile_id:new r.ce(d),u_zoom_transition:new r.cf(d),u_inv_rot_matrix:new r.ch(d),u_merc_center:new r.cg(d),u_up_dir:new r.ce(d),u_height_lift:new r.cf(d),u_image:new r.cd(d),u_texsize:new r.cg(d),u_pixel_coord_upper:new r.cg(d),u_pixel_coord_lower:new r.cg(d),u_tile_units_to_pixels:new r.cf(d),u_opacity:new r.cf(d),u_pattern_transition:new r.cf(d)}),fillExtrusionGroundEffect:d=>({u_matrix:new r.ch(d),u_opacity:new r.cf(d),u_ao_pass:new r.cf(d),u_meter_to_tile:new r.cf(d),u_ao:new r.cg(d),u_flood_light_intensity:new r.cf(d),u_flood_light_color:new r.ce(d),u_attenuation:new r.cf(d),u_edge_radius:new r.cf(d),u_fb:new r.cd(d),u_fb_size:new r.cf(d),u_dynamic_offset:new r.cf(d)}),fill:d=>({u_matrix:new r.ch(d),u_emissive_strength:new r.cf(d),u_ground_shadow_factor:new r.ce(d)}),fillPattern:d=>({u_matrix:new r.ch(d),u_emissive_strength:new r.cf(d),u_image:new r.cd(d),u_texsize:new r.cg(d),u_pixel_coord_upper:new r.cg(d),u_pixel_coord_lower:new r.cg(d),u_tile_units_to_pixels:new r.cf(d),u_ground_shadow_factor:new r.ce(d),u_pattern_transition:new r.cf(d)}),fillOutline:d=>({u_matrix:new r.ch(d),u_emissive_strength:new r.cf(d),u_world:new r.cg(d),u_ground_shadow_factor:new r.ce(d)}),fillOutlinePattern:d=>({u_matrix:new r.ch(d),u_emissive_strength:new r.cf(d),u_world:new r.cg(d),u_image:new r.cd(d),u_texsize:new r.cg(d),u_pixel_coord_upper:new r.cg(d),u_pixel_coord_lower:new r.cg(d),u_tile_units_to_pixels:new r.cf(d),u_ground_shadow_factor:new r.ce(d),u_pattern_transition:new r.cf(d)}),building:d=>({u_matrix:new r.ch(d),u_normal_matrix:new r.ch(d),u_opacity:new r.cf(d)}),buildingBloom:d=>({u_matrix:new r.ch(d)}),buildingDepth:d=>({u_matrix:new r.ch(d)}),elevatedStructuresDepth:d=>({u_matrix:new r.ch(d),u_depth_bias:new r.cf(d)}),elevatedStructures:d=>({u_matrix:new r.ch(d),u_ground_shadow_factor:new r.ce(d)}),elevatedStructuresDepthReconstruct:d=>({u_matrix:new r.ch(d),u_camera_pos:new r.ce(d),u_depth_bias:new r.cf(d),u_height_scale:new r.cf(d),u_reset_depth:new r.cf(d)}),circle:r.dT,collisionBox:d=>({u_matrix:new r.ch(d),u_inv_rot_matrix:new r.ch(d),u_camera_to_center_distance:new r.cf(d),u_extrude_scale:new r.cg(d),u_zoom_transition:new r.cf(d),u_merc_center:new r.cg(d),u_tile_id:new r.ce(d)}),collisionCircle:d=>({u_matrix:new r.ch(d),u_inv_matrix:new r.ch(d),u_camera_to_center_distance:new r.cf(d),u_viewport_size:new r.cg(d)}),debug:d=>({u_color:new r.dv(d),u_matrix:new r.ch(d),u_overlay:new r.cd(d),u_overlay_scale:new r.cf(d)}),clippingMask:d=>({u_matrix:new r.ch(d)}),heatmap:d=>({u_extrude_scale:new r.cf(d),u_intensity:new r.cf(d),u_matrix:new r.ch(d),u_inv_rot_matrix:new r.ch(d),u_merc_center:new r.cg(d),u_tile_id:new r.ce(d),u_zoom_transition:new r.cf(d),u_up_dir:new r.ce(d)}),heatmapTexture:d=>({u_image:new r.cd(d),u_color_ramp:new r.cd(d),u_opacity:new r.cf(d)}),hillshade:d=>({u_matrix:new r.ch(d),u_image:new r.cd(d),u_latrange:new r.cg(d),u_light:new r.cg(d),u_shadow:new r.dv(d),u_highlight:new r.dv(d),u_emissive_strength:new r.cf(d),u_accent:new r.dv(d)}),hillshadePrepare:d=>({u_matrix:new r.ch(d),u_image:new r.cd(d),u_dimension:new r.cg(d),u_zoom:new r.cf(d)}),line:r.dS,linePattern:r.dR,raster:d=>({u_matrix:new r.ch(d),u_normalize_matrix:new r.ch(d),u_globe_matrix:new r.ch(d),u_merc_matrix:new r.ch(d),u_grid_matrix:new r.dw(d),u_tl_parent:new r.cg(d),u_scale_parent:new r.cf(d),u_fade_t:new r.cf(d),u_opacity:new r.cf(d),u_image0:new r.cd(d),u_image1:new r.cd(d),u_brightness_low:new r.cf(d),u_brightness_high:new r.cf(d),u_saturation_factor:new r.cf(d),u_contrast_factor:new r.cf(d),u_spin_weights:new r.ce(d),u_perspective_transform:new r.cg(d),u_raster_elevation:new r.cf(d),u_zoom_transition:new r.cf(d),u_merc_center:new r.cg(d),u_cutoff_params:new r.d0(d),u_colorization_mix:new r.d0(d),u_colorization_offset:new r.cf(d),u_color_ramp:new r.cd(d),u_texture_offset:new r.cg(d),u_texture_res:new r.cg(d),u_emissive_strength:new r.cf(d)}),rasterParticle:d=>({u_matrix:new r.ch(d),u_normalize_matrix:new r.ch(d),u_globe_matrix:new r.ch(d),u_merc_matrix:new r.ch(d),u_grid_matrix:new r.dw(d),u_tl_parent:new r.cg(d),u_scale_parent:new r.cf(d),u_fade_t:new r.cf(d),u_opacity:new r.cf(d),u_image0:new r.cd(d),u_image1:new r.cd(d),u_raster_elevation:new r.cf(d),u_zoom_transition:new r.cf(d),u_merc_center:new r.cg(d),u_cutoff_params:new r.d0(d)}),rasterParticleTexture:d=>({u_texture:new r.cd(d),u_opacity:new r.cf(d)}),rasterParticleDraw:d=>({u_particle_texture:new r.cd(d),u_particle_texture_side_len:new r.cf(d),u_tile_offset:new r.cg(d),u_velocity:new r.cd(d),u_color_ramp:new r.cd(d),u_velocity_res:new r.cg(d),u_max_speed:new r.cf(d),u_uv_offset:new r.cg(d),u_data_scale:new r.cg(d),u_data_offset:new r.cf(d),u_particle_pos_scale:new r.cf(d),u_particle_pos_offset:new r.cg(d)}),rasterParticleUpdate:d=>({u_particle_texture:new r.cd(d),u_particle_texture_side_len:new r.cf(d),u_velocity:new r.cd(d),u_velocity_res:new r.cg(d),u_max_speed:new r.cf(d),u_speed_factor:new r.cf(d),u_reset_rate:new r.cf(d),u_rand_seed:new r.cf(d),u_uv_offset:new r.cg(d),u_data_scale:new r.cg(d),u_data_offset:new r.cf(d),u_particle_pos_scale:new r.cf(d),u_particle_pos_offset:new r.cg(d)}),symbol:d=>({u_is_size_zoom_constant:new r.cd(d),u_is_size_feature_constant:new r.cd(d),u_size_t:new r.cf(d),u_size:new r.cf(d),u_camera_to_center_distance:new r.cf(d),u_rotate_symbol:new r.cd(d),u_aspect_ratio:new r.cf(d),u_fade_change:new r.cf(d),u_matrix:new r.ch(d),u_label_plane_matrix:new r.ch(d),u_coord_matrix:new r.ch(d),u_is_text:new r.cd(d),u_elevation_from_sea:new r.cd(d),u_pitch_with_map:new r.cd(d),u_texsize:new r.cg(d),u_texsize_icon:new r.cg(d),u_texture:new r.cd(d),u_texture_icon:new r.cd(d),u_gamma_scale:new r.cf(d),u_device_pixel_ratio:new r.cf(d),u_tile_id:new r.ce(d),u_zoom_transition:new r.cf(d),u_inv_rot_matrix:new r.ch(d),u_merc_center:new r.cg(d),u_camera_forward:new r.ce(d),u_tile_matrix:new r.ch(d),u_up_vector:new r.ce(d),u_ecef_origin:new r.ce(d),u_is_halo:new r.cd(d),u_icon_transition:new r.cf(d),u_color_adj_mat:new r.ch(d),u_scale_factor:new r.cf(d),u_ground_shadow_factor:new r.ce(d),u_inv_matrix:new r.ch(d),u_normal_scale:new r.cf(d)}),background:d=>({u_matrix:new r.ch(d),u_emissive_strength:new r.cf(d),u_opacity:new r.cf(d),u_color:new r.dv(d)}),backgroundPattern:d=>({u_matrix:new r.ch(d),u_emissive_strength:new r.cf(d),u_opacity:new r.cf(d),u_image:new r.cd(d),u_pattern_tl:new r.cg(d),u_pattern_br:new r.cg(d),u_texsize:new r.cg(d),u_pattern_size:new r.cg(d),u_pixel_coord_upper:new r.cg(d),u_pixel_coord_lower:new r.cg(d),u_pattern_units_to_pixels:new r.cg(d)}),terrainRaster:d=>({u_matrix:new r.ch(d),u_image0:new r.cd(d),u_skirt_height:new r.cf(d),u_ground_shadow_factor:new r.ce(d)}),skybox:d=>({u_matrix:new r.ch(d),u_sun_direction:new r.ce(d),u_cubemap:new r.cd(d),u_opacity:new r.cf(d),u_temporal_offset:new r.cf(d)}),skyboxGradient:d=>({u_matrix:new r.ch(d),u_color_ramp:new r.cd(d),u_center_direction:new r.ce(d),u_radius:new r.cf(d),u_opacity:new r.cf(d),u_temporal_offset:new r.cf(d)}),skyboxCapture:d=>({u_matrix_3f:new r.dw(d),u_sun_direction:new r.ce(d),u_sun_intensity:new r.cf(d),u_color_tint_r:new r.d0(d),u_color_tint_m:new r.d0(d),u_luminance:new r.cf(d)}),globeRaster:d=>({u_proj_matrix:new r.ch(d),u_globe_matrix:new r.ch(d),u_normalize_matrix:new r.ch(d),u_merc_matrix:new r.ch(d),u_zoom_transition:new r.cf(d),u_merc_center:new r.cg(d),u_image0:new r.cd(d),u_grid_matrix:new r.dw(d),u_skirt_height:new r.cf(d),u_far_z_cutoff:new r.cf(d),u_frustum_tl:new r.ce(d),u_frustum_tr:new r.ce(d),u_frustum_br:new r.ce(d),u_frustum_bl:new r.ce(d),u_globe_pos:new r.ce(d),u_globe_radius:new r.cf(d),u_viewport:new r.cg(d)}),globeAtmosphere:d=>({u_frustum_tl:new r.ce(d),u_frustum_tr:new r.ce(d),u_frustum_br:new r.ce(d),u_frustum_bl:new r.ce(d),u_horizon:new r.cf(d),u_transition:new r.cf(d),u_fadeout_range:new r.cf(d),u_color:new r.d0(d),u_high_color:new r.d0(d),u_space_color:new r.d0(d),u_temporal_offset:new r.cf(d),u_horizon_angle:new r.cf(d)}),model:d=>({u_matrix:new r.ch(d),u_lighting_matrix:new r.ch(d),u_normal_matrix:new r.ch(d),u_node_matrix:new r.ch(d),u_lightpos:new r.ce(d),u_lightintensity:new r.cf(d),u_lightcolor:new r.ce(d),u_camera_pos:new r.ce(d),u_opacity:new r.cf(d),u_baseColorFactor:new r.d0(d),u_emissiveFactor:new r.d0(d),u_metallicFactor:new r.cf(d),u_roughnessFactor:new r.cf(d),u_baseTextureIsAlpha:new r.cd(d),u_alphaMask:new r.cd(d),u_alphaCutoff:new r.cf(d),u_baseColorTexture:new r.cd(d),u_metallicRoughnessTexture:new r.cd(d),u_normalTexture:new r.cd(d),u_occlusionTexture:new r.cd(d),u_emissionTexture:new r.cd(d),u_lutTexture:new r.cd(d),u_color_mix:new r.d0(d),u_aoIntensity:new r.cf(d),u_emissive_strength:new r.cf(d),u_occlusionTextureTransform:new r.d0(d)}),modelDepth:d=>({u_matrix:new r.ch(d),u_instance:new r.ch(d),u_node_matrix:new r.ch(d)}),groundShadow:d=>({u_matrix:new r.ch(d),u_ground_shadow_factor:new r.ce(d)}),stars:d=>({u_matrix:new r.ch(d),u_up:new r.ce(d),u_right:new r.ce(d),u_intensity_multiplier:new r.cf(d)}),snowParticle:d=>({u_modelview:new r.ch(d),u_projection:new r.ch(d),u_time:new r.cf(d),u_cam_pos:new r.ce(d),u_velocityConeAperture:new r.cf(d),u_velocity:new r.cf(d),u_horizontalOscillationRadius:new r.cf(d),u_horizontalOscillationRate:new r.cf(d),u_boxSize:new r.cf(d),u_billboardSize:new r.cf(d),u_simpleShapeParameters:new r.cg(d),u_screenSize:new r.cg(d),u_thinningCenterPos:new r.cg(d),u_thinningShape:new r.ce(d),u_thinningAffectedRatio:new r.cf(d),u_thinningParticleOffset:new r.cf(d),u_particleColor:new r.d0(d),u_direction:new r.ce(d)}),rainParticle:d=>({u_modelview:new r.ch(d),u_projection:new r.ch(d),u_time:new r.cf(d),u_cam_pos:new r.ce(d),u_texScreen:new r.cd(d),u_velocityConeAperture:new r.cf(d),u_velocity:new r.cf(d),u_boxSize:new r.cf(d),u_rainDropletSize:new r.cg(d),u_distortionStrength:new r.cf(d),u_rainDirection:new r.ce(d),u_color:new r.d0(d),u_screenSize:new r.cg(d),u_thinningCenterPos:new r.cg(d),u_thinningShape:new r.ce(d),u_thinningAffectedRatio:new r.cf(d),u_thinningParticleOffset:new r.cf(d),u_shapeDirectionalPower:new r.cf(d),u_shapeNormalPower:new r.cf(d),u_mode:new r.cf(d)}),vignette:d=>({u_vignetteShape:new r.ce(d),u_vignetteColor:new r.d0(d)}),occlusion:d=>({u_matrix:new r.ch(d),u_anchorPos:new r.ce(d),u_screenSizePx:new r.cg(d),u_occluderSizePx:new r.cg(d),u_color:new r.d0(d)})},Iy=(()=>{class d{constructor(o,h,g,_){this.id=d.uniqueIdxCounter,d.uniqueIdxCounter++,this.context=o;let v=o.gl;this.buffer=v.createBuffer(),this.dynamicDraw=!!g,this.context.unbindVAO(),o.bindElementBuffer.set(this.buffer),v.bufferData(v.ELEMENT_ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?v.DYNAMIC_DRAW:v.STATIC_DRAW),this.dynamicDraw||_||h.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(o){this.id=d.uniqueIdxCounter,d.uniqueIdxCounter++;let h=this.context.gl;this.context.unbindVAO(),this.bind(),h.bufferSubData(h.ELEMENT_ARRAY_BUFFER,0,o.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return d.uniqueIdxCounter=0,d})(),rm={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class im{constructor(t,o,h,g,_,v){this.length=o.length,this.attributes=h,this.itemSize=o.bytesPerElement,this.dynamicDraw=g,this.instanceCount=v,this.context=t;let E=t.gl;this.buffer=E.createBuffer(),t.bindVertexBuffer.set(this.buffer),E.bufferData(E.ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?E.DYNAMIC_DRAW:E.STATIC_DRAW),this.dynamicDraw||_||o.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){let o=this.context.gl;this.bind(),o.bufferSubData(o.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,o){for(let h=0;h<this.attributes.length;h++){let g=o.attributes[this.attributes[h].name];g!==void 0&&t.enableVertexAttribArray(g)}}setVertexAttribPointers(t,o,h){for(let g=0;g<this.attributes.length;g++){let _=this.attributes[g],v=o.attributes[_.name];v!==void 0&&t.vertexAttribPointer(v,_.components,t[rm[_.type]],!1,this.itemSize,_.offset+this.itemSize*(h||0))}}setVertexAttribDivisor(t,o,h){for(let g=0;g<this.attributes.length;g++){let _=o.attributes[this.attributes[g].name];_!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(_,h)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class pl{constructor(t,o,h,g,_){this.context=t,this.width=o,this.height=h;let v=this.framebuffer=t.gl.createFramebuffer();g&&(this.colorAttachment=new Bb(t,v)),_&&(this.depthAttachmentType=_,this.depthAttachment=_==="renderbuffer"?new hy(t,v):new jp(t,v))}destroy(){let t=this.context.gl;if(this.colorAttachment){let o=this.colorAttachment.get();o&&t.deleteTexture(o)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let o=this.depthAttachment.get();o&&t.deleteRenderbuffer(o)}else{let o=this.depthAttachment.get();o&&t.deleteTexture(o)}t.deleteFramebuffer(this.framebuffer)}}class Rh{constructor(t,o){this.gl=t,this.clearColor=new Ob(this),this.clearDepth=new Lb(this),this.clearStencil=new Fb(this),this.colorMask=new kb(this),this.depthMask=new iy(this),this.stencilMask=new Nb(this),this.stencilFunc=new hh(this),this.stencilOp=new zb(this),this.stencilTest=new oy(this),this.depthRange=new Np(this),this.depthTest=new fh(this),this.depthFunc=new zp(this),this.blend=new ul(this),this.blendFunc=new ac(this),this.blendColor=new ph(this),this.blendEquation=new mh(this),this.cullFace=new lc(this),this.cullFaceSide=new sy(this),this.frontFace=new Bp(this),this.program=new ay(this),this.activeTexture=new cc(this),this.viewport=new gh(this),this.bindFramebuffer=new _h(this),this.bindRenderbuffer=new Vp(this),this.bindTexture=new yh(this),this.bindVertexBuffer=new Bu(this),this.bindElementBuffer=new ly(this),this.bindVertexArrayOES=new cy(this),this.pixelStoreUnpack=new uy(this),this.pixelStoreUnpackPremultiplyAlpha=new uc(this),this.pixelStoreUnpackFlipY=new dy(this),this.options=o?Object.assign({},o):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=o&&!!o.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,o,h){return new Iy(this,t,o,h)}createVertexBuffer(t,o,h,g,_){return new im(this,t,o,h,g,_)}createRenderbuffer(t,o,h){let g=this.gl,_=g.createRenderbuffer();return this.bindRenderbuffer.set(_),g.renderbufferStorage(g.RENDERBUFFER,t,o,h),this.bindRenderbuffer.set(null),_}createFramebuffer(t,o,h,g){return new pl(this,t,o,h,g)}clear({color:t,depth:o,stencil:h,colorMask:g}){let _=this.gl,v=0;t&&(v|=_.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(g||[!0,!0,!0,!0])),o!==void 0&&(v|=_.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(o),this.depthMask.set(!0)),h!==void 0&&(v|=_.STENCIL_BUFFER_BIT,this.clearStencil.set(h),this.stencilMask.set(255)),_.clear(v)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){r.bv(t.blendFunction,Yt.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Ca;function om(d,t,o,h,g,_,v){let E=d.context,T=E.gl,C=d.transform,A=[r.aD(C.center.lng),r.aH(C.center.lat)],L=o.layout.get("symbol-placement"),R=o.layout.get("text-variable-anchor"),F=o.layout.get("icon-rotation-alignment")==="map",V=o.layout.get("text-rotation-alignment")==="map",z=L!=="point",H=[],j=0,Z=0;for(let oe=0;oe<h.length;oe++){let se=h[oe],Te=t.getTile(se),me=Te.getBucket(o);if(!me)continue;let Ne=me.getProjection().createInversionMatrix(C,se.canonical),Ae=[],Ve=$_(se,me,C),Qe=!v&&F&&z,Ie=v&&V&&z,pe=R&&me.hasTextData(),Pe=me.hasIconTextFit()&&pe&&me.hasIconData(),Se=Qe||Ie||v&&pe||Pe,He=me.projection.name==="globe",Ge=He?r.ah(C.zoom):0;He&&(Ae.push("PROJECTION_GLOBE_VIEW"),Se&&Ae.push("PROJECTED_POS_ON_VIEWPORT"));let We=d.getOrCreateProgram("collisionBox",{defines:Ae}),ot=Ve;g[0]===0&&g[1]===0||(ot=d.translatePosMatrix(Ve,Te,g,_));let bt=v?me.textCollisionBox:me.iconCollisionBox,St=me.collisionCircleArray;if(St.length>0){let Tt=r.bz(),wt=ot;r.cM(Tt,me.placementInvProjMatrix,C.glCoordMatrix),r.cM(Tt,Tt,me.placementViewportMatrix),H.push({circleArray:St,circleOffset:Z,transform:wt,invTransform:Tt,projection:me.getProjection()}),j+=St.length/4,Z=j}if(!bt)continue;d.terrain&&d.terrain.setupElevationDraw(Te,We);let ft=He?[se.canonical.x,se.canonical.y,1<<se.canonical.z]:[0,0,0];We.draw(d,T.LINES,gt.disabled,Lt.disabled,d.colorModeForRenderPass(),Mt.disabled,fc(ot,Ne,C,Ge,A,Te,ft,me.getProjection()),o.id,bt.layoutVertexBuffer,bt.indexBuffer,bt.segments,null,C.zoom,null,[bt.collisionVertexBuffer,bt.collisionVertexBufferExt])}if(!v||!H.length)return;let Y=d.getOrCreateProgram("collisionCircle"),J=new r.dU;J.resize(4*j),J._trim();let re=0;for(let oe of H)for(let se=0;se<oe.circleArray.length/4;se++){let Te=4*se,me=oe.circleArray[Te+0],Ne=oe.circleArray[Te+1],Ae=oe.circleArray[Te+2],Ve=oe.circleArray[Te+3];J.emplace(re++,me,Ne,Ae,Ve,0),J.emplace(re++,me,Ne,Ae,Ve,1),J.emplace(re++,me,Ne,Ae,Ve,2),J.emplace(re++,me,Ne,Ae,Ve,3)}(!Ca||Ca.length<2*j)&&(Ca=function(oe){let se=2*oe,Te=new r.a_;Te.resize(se),Te._trim();for(let me=0;me<se;me++){let Ne=6*me;Te.uint16[Ne+0]=4*me+0,Te.uint16[Ne+1]=4*me+1,Te.uint16[Ne+2]=4*me+2,Te.uint16[Ne+3]=4*me+2,Te.uint16[Ne+4]=4*me+3,Te.uint16[Ne+5]=4*me+0}return Te}(j));let ce=E.createIndexBuffer(Ca,!0),de=E.createVertexBuffer(J,r.dV.members,!0);for(let oe of H){let se={u_matrix:oe.transform,u_inv_matrix:oe.invTransform,u_camera_to_center_distance:(ie=C).getCameraToCenterDistance(oe.projection),u_viewport_size:[ie.width,ie.height]};Y.draw(d,T.TRIANGLES,gt.disabled,Lt.disabled,d.colorModeForRenderPass(),Mt.disabled,se,o.id,de,ce,r.bd.simpleSegment(0,2*oe.circleOffset,oe.circleArray.length,oe.circleArray.length/2),null,C.zoom)}var ie;de.destroy(),ce.destroy()}let ml=r.bz();function ju(d){let t=d._camera.getWorldToCamera(d.worldSize,1),o=r.az([],t,d.globeMatrix);r.bi(o,o);let h=[0,0,0],g=[0,1,0,0];return r.aA(g,g,o),h[0]=g[0],h[1]=g[1],h[2]=g[2],r.au(h,h),h}function sm({width:d,height:t,anchor:o,textOffset:h,textScale:g},_){let{horizontalAlign:v,verticalAlign:E}=r.bZ(o),T=-(v-.5)*d,C=-(E-.5)*t,A=r.b_(o,h);return new r.P((T/g+A[0])*_,(C/g+A[1])*_)}function Sy(d,t,o,h,g,_,v,E,T,C){let A=d.text.placedSymbolArray,L=d.text.dynamicLayoutVertexArray,R=d.icon.dynamicLayoutVertexArray,F={},V=d.getProjection(),z=eh(v,V,g),H=g.elevation,j=V.upVectorScale(v.canonical,g.center.lat,g.worldSize).metersToTile;L.clear();for(let Z=0;Z<A.length;Z++){let Y=A.get(Z),{tileAnchorX:J,tileAnchorY:re,numGlyphs:ce}=Y,de=Y.hidden||!Y.crossTileID||d.allowVerticalPlacement&&!Y.placedOrientation?null:h[Y.crossTileID];if(de){let ie=0,oe=0,se=0;if(H){let Pe=H?H.getAtTileOffset(v,J,re):0,[Se,He,Ge]=V.upVector(v.canonical,J,re);ie=Pe*Se*j,oe=Pe*He*j,se=Pe*Ge*j}let[Te,me,Ne,Ae]=Co(Y.projectedAnchorX+ie,Y.projectedAnchorY+oe,Y.projectedAnchorZ+se,o?z:_),Ve=Tp(g.getCameraToCenterDistance(V),Ae),Qe=r.bJ(d.textSizeData,T,Y)*Ve/r.bU;o&&(Qe*=d.tilePixelRatio/E);let Ie=sm(de,Qe);o?({x:Te,y:me,z:Ne}=V.projectTilePoint(J+Ie.x,re+Ie.y,v.canonical),[Te,me,Ne]=Co(Te+ie,me+oe,Ne+se,_)):(t&&Ie._rotate(-g.angle),Te+=Ie.x,me+=Ie.y,Ne=0);let pe=d.allowVerticalPlacement&&Y.placedOrientation===r.bI.vertical?Math.PI/2:0;for(let Pe=0;Pe<ce;Pe++)r.bL(L,Te,me,Ne,pe);C&&Y.associatedIconIndex>=0&&(F[Y.associatedIconIndex]={x:Te,y:me,z:Ne,angle:pe})}else Jl(ce,L)}if(C){R.clear();let Z=d.icon.placedSymbolArray;for(let Y=0;Y<Z.length;Y++){let J=Z.get(Y),{numGlyphs:re}=J,ce=F[Y];if(J.hidden||!ce)Jl(re,R);else{let{x:de,y:ie,z:oe,angle:se}=ce;for(let Te=0;Te<re;Te++)r.bL(R,de,ie,oe,se)}}d.icon.dynamicLayoutVertexBuffer.updateData(R)}d.text.dynamicLayoutVertexBuffer.updateData(L)}function am(d,t,o,h,g,_,v={}){let E=o.paint.get("icon-translate"),T=o.paint.get("text-translate"),C=o.paint.get("icon-translate-anchor"),A=o.paint.get("text-translate-anchor"),L=o.layout.get("icon-rotation-alignment"),R=o.layout.get("text-rotation-alignment"),F=o.layout.get("icon-pitch-alignment"),V=o.layout.get("text-pitch-alignment"),z=o.layout.get("icon-keep-upright"),H=o.layout.get("text-keep-upright"),j=o.paint.get("icon-color-saturation"),Z=o.paint.get("icon-color-contrast"),Y=o.paint.get("icon-color-brightness-min"),J=o.paint.get("icon-color-brightness-max"),re=o.layout.get("symbol-elevation-reference")==="sea",ce=d.context,de=ce.gl,ie=d.transform,oe=L==="map",se=R==="map",Te=F==="map",me=V==="map",Ne=o.layout.get("symbol-sort-key").constantOr(1)!==void 0,Ae=!1,Ve=d.depthModeForSublayer(0,gt.ReadOnly),Qe=new gt(d.context.gl.LEQUAL,gt.ReadOnly,d.depthRangeFor3D),Ie=[r.aD(ie.center.lng),r.aH(ie.center.lat)],pe=o.layout.get("text-variable-anchor"),Pe=ie.projection.name==="globe",Se=[],He=[0,-1,0];for(let Ge of h){let We=t.getTile(Ge),ot=We.getBucket(o);if(!ot||ot.projection.name==="mercator"&&Pe||ot.fullyClipped)continue;let bt=ot.projection.name==="globe",St=bt?r.ah(ie.zoom):0,ft=eh(Ge,ot.getProjection(),ie),Tt=ie.calculatePixelsToTileUnitsMatrix(We),wt=pe&&ot.hasTextData(),zt=ot.hasIconTextFit()&&wt&&ot.hasIconData(),Wt=ot.getProjection().createInversionMatrix(ie,Ge.canonical),on=(1<<We.tileID.canonical.z)*r.aj/d.transform.worldSize,bn=Bn=>{let Cn=[0,0,0];if(Bn){let yr=d.style.directionalLight,vn=d.style.ambientLight;yr&&vn&&(Cn=ll(d.style,yr,vn))}return Cn},Ht=Bn=>{ie.depthOcclusionForSymbolsAndCircles&&(o.hasInitialOcclusionOpacityProperties||d.terrain)&&(Bn.push("DEPTH_D24"),Bn.push("DEPTH_OCCLUSION"))},wn=()=>{let Bn=oe&&o.layout.get("symbol-placement")!=="point",Cn=[];Ht(Cn);let yr=Bn||zt,vn=ot.elevationType==="road",Rn=d.shadowRenderer,Wn=vn&&Te&&!!Rn&&Rn.enabled,Gr=bn(Wn),Br=vn&&Te&&!d.terrain?Qe:Ve,Wr=o.paint.get("icon-image-cross-fade");d.terrainRenderModeElevated()&&Te&&Cn.push("PITCH_WITH_MAP_TERRAIN"),bt&&(Cn.push("PROJECTION_GLOBE_VIEW"),yr&&Cn.push("PROJECTED_POS_ON_VIEWPORT")),Wr>0&&ot.hasAnySecondaryIcon&&Cn.push("ICON_TRANSITION"),!ot.icon.zOffsetVertexBuffer||vn&&d.terrain||Cn.push("Z_OFFSET"),j===0&&Z===0&&Y===0&&J===1||Cn.push("COLOR_ADJUSTMENT"),ot.sdfIcons&&Cn.push("RENDER_SDF"),Wn&&Cn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),vn&&Te&&!d.terrain&&ot.icon.orientationVertexBuffer&&Cn.push("ELEVATED_ROADS");let pi=ot.icon.programConfigurations.get(o.id),fs=d.getOrCreateProgram("symbol",{config:pi,defines:Cn}),Hi=We.imageAtlasTexture?We.imageAtlasTexture.size:[0,0],go=ot.iconSizeData,Ti=r.bH(go,ie.zoom),Lo=Te||!ie.isOrthographic,ns=Su(ft,We.tileID.canonical,Te,oe,ie,ot.getProjection(),Tt),Ii=js(ft,We.tileID.canonical,Te,oe,ie,ot.getProjection(),Tt),Or=d.translatePosMatrix(Ii,We,E,C,!0),Dr=d.translatePosMatrix(ft,We,E,C),Jn=yr?ml:ns,ei=oe&&!Te&&!Bn,mi=He;!Pe&&!ie.mercatorFromTransition||oe||(mi=ju(ie));let Lr=bt?mi:He,Fo=o.getColorAdjustmentMatrix(j,Z,Y,J),vl=Mh(go.kind,Ti,ei,Te,d,Dr,Jn,Or,re,!1,Hi,[0,0],0,Ge,St,Ie,Wt,Lr,ot.getProjection(),Gr,on,Fo,Wr,null),Fa=We.imageAtlasTexture?We.imageAtlasTexture:null,Cc=o.layout.get("icon-size").constantOr(0)!==1||ot.iconsNeedLinear,Ac=ot.sdfIcons||d.options.rotating||d.options.zooming||Cc||Lo?de.LINEAR:de.NEAREST,ko=ot.sdfIcons&&o.paint.get("icon-halo-width").constantOr(1)!==0,As=d.terrain&&Te&&Bn?r.bi(r.bz(),ns):ml;if(Bn&&ot.icon){let ti=ie.elevation,No=ti?ti.getAtTileOffsetFunc(Ge,ie.center.lat,ie.worldSize,ot.getProjection()):null,xl=Kl(ft,We.tileID.canonical,Te,oe,ie,ot.getProjection(),Tt);ol(ot,ft,d,!1,xl,Ii,Te,z,No,Ge)}return{program:fs,buffers:ot.icon,uniformValues:vl,atlasTexture:Fa,atlasTextureIcon:null,atlasInterpolation:Ac,atlasInterpolationIcon:null,isSDF:ot.sdfIcons,hasHalo:ko,depthMode:Br,tile:We,renderWithShadows:Wn,labelPlaneMatrixInv:As}},Dn=()=>{let Bn=se&&o.layout.get("symbol-placement")!=="point",Cn=[],yr=Bn||pe||zt,vn=ot.elevationType==="road",Rn=d.shadowRenderer,Wn=vn&&me&&!!Rn&&Rn.enabled,Gr=bn(Wn),Br=vn&&me&&!d.terrain?Qe:Ve;d.terrainRenderModeElevated()&&me&&Cn.push("PITCH_WITH_MAP_TERRAIN"),bt&&(Cn.push("PROJECTION_GLOBE_VIEW"),yr&&Cn.push("PROJECTED_POS_ON_VIEWPORT")),!ot.text.zOffsetVertexBuffer||vn&&d.terrain||Cn.push("Z_OFFSET"),ot.iconsInText&&Cn.push("RENDER_TEXT_AND_SYMBOL"),Cn.push("RENDER_SDF"),Wn&&Cn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),vn&&me&&!d.terrain&&ot.text.orientationVertexBuffer&&Cn.push("ELEVATED_ROADS"),Ht(Cn);let Wr=ot.text.programConfigurations.get(o.id),pi=d.getOrCreateProgram("symbol",{config:Wr,defines:Cn}),fs,Hi=[0,0],go=null,Ti=ot.textSizeData;ot.iconsInText&&(Hi=We.imageAtlasTexture?We.imageAtlasTexture.size:[0,0],go=We.imageAtlasTexture?We.imageAtlasTexture:null,fs=me||!ie.isOrthographic||d.options.rotating||d.options.zooming||Ti.kind==="composite"||Ti.kind==="camera"?de.LINEAR:de.NEAREST);let Lo=We.glyphAtlasTexture?We.glyphAtlasTexture.size:[0,0],ns=o.layout.get("text-size-scale-range"),Ii=r.ay(d.scaleFactor,ns[0],ns[1]),Or=r.bH(Ti,ie.zoom,Ii),Dr=Su(ft,We.tileID.canonical,me,se,ie,ot.getProjection(),Tt),Jn=js(ft,We.tileID.canonical,me,se,ie,ot.getProjection(),Tt),ei=d.translatePosMatrix(Jn,We,T,A,!0),mi=d.translatePosMatrix(ft,We,T,A),Lr=yr?ml:Dr,Fo=se&&!me&&!Bn,vl=He;!Pe&&!ie.mercatorFromTransition||se||(vl=ju(ie));let Fa=Mh(Ti.kind,Or,Fo,me,d,mi,Lr,ei,re,!0,Lo,Hi,0,Ge,St,Ie,Wt,bt?vl:He,ot.getProjection(),Gr,on,null,null,Ii),Cc=We.glyphAtlasTexture?We.glyphAtlasTexture:null,Ac=de.LINEAR,ko=o.paint.get("text-halo-width").constantOr(1)!==0,As=d.terrain&&me&&Bn?r.bi(r.bz(),Dr):ml;if(Bn&&ot.text){let ti=ie.elevation,No=ti?ti.getAtTileOffsetFunc(Ge,ie.center.lat,ie.worldSize,ot.getProjection()):null,xl=Kl(ft,We.tileID.canonical,me,se,ie,ot.getProjection(),Tt);ol(ot,ft,d,!0,xl,Jn,me,H,No,Ge)}return{program:pi,buffers:ot.text,uniformValues:Fa,atlasTexture:Cc,atlasTextureIcon:go,atlasInterpolation:Ac,atlasInterpolationIcon:fs,isSDF:!0,hasHalo:ko,depthMode:Br,tile:We,renderWithShadows:Wn,labelPlaneMatrixInv:As}},Xn=ot.icon.segments.get().length,tn=ot.text.segments.get().length,En=Xn&&!v.onlyText?wn():null,Tn=tn&&!v.onlyIcons?Dn():null,Mn=o.paint.get("icon-opacity").constantOr(1),sn=o.paint.get("text-opacity").constantOr(1);if(Ne&&ot.canOverlap){Ae=!0;let Bn=Mn&&!v.onlyText?ot.icon.segments.get():[],Cn=sn&&!v.onlyIcons?ot.text.segments.get():[];for(let yr of Bn)Se.push({segments:new r.bd([yr]),sortKey:yr.sortKey,state:En});for(let yr of Cn)Se.push({segments:new r.bd([yr]),sortKey:yr.sortKey,state:Tn})}else v.onlyText||Se.push({segments:Mn?ot.icon.segments:new r.bd([]),sortKey:0,state:En}),v.onlyIcons||Se.push({segments:sn?ot.text.segments:new r.bd([]),sortKey:0,state:Tn})}Ae&&Se.sort((Ge,We)=>Ge.sortKey-We.sortKey);for(let Ge of Se){let We=Ge.state;if(We)if(d.terrain?d.terrain.setupElevationDraw(We.tile,We.program,{useDepthForOcclusion:ie.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:We.labelPlaneMatrixInv}):d.setupDepthForOcclusion(ie.depthOcclusionForSymbolsAndCircles,We.program),ce.activeTexture.set(de.TEXTURE0),We.atlasTexture&&We.atlasTexture.bind(We.atlasInterpolation,de.CLAMP_TO_EDGE,!0),We.atlasTextureIcon&&(ce.activeTexture.set(de.TEXTURE1),We.atlasTextureIcon&&We.atlasTextureIcon.bind(We.atlasInterpolationIcon,de.CLAMP_TO_EDGE,!0)),We.renderWithShadows&&d.shadowRenderer.setupShadows(We.tile.tileID.toUnwrapped(),We.program,"vector-tile"),d.uploadCommonLightUniforms(d.context,We.program),We.hasHalo){let ot=We.uniformValues;ot.u_is_halo=1,Aa(We.buffers,Ge.segments,o,d,We.program,We.depthMode,g,_,ot,2),ot.u_is_halo=0}else{if(We.isSDF){let ot=We.uniformValues;We.hasHalo&&(ot.u_is_halo=1,Aa(We.buffers,Ge.segments,o,d,We.program,We.depthMode,g,_,ot,1)),ot.u_is_halo=0}Aa(We.buffers,Ge.segments,o,d,We.program,We.depthMode,g,_,We.uniformValues,1)}}}function Aa(d,t,o,h,g,_,v,E,T,C){let A=[d.dynamicLayoutVertexBuffer,d.opacityVertexBuffer,d.iconTransitioningVertexBuffer,d.globeExtVertexBuffer,d.zOffsetVertexBuffer,d.orientationVertexBuffer];g.draw(h,h.context.gl.TRIANGLES,_,v,E,Mt.disabled,T,o.id,d.layoutVertexBuffer,d.indexBuffer,t,o.paint,h.transform.zoom,d.programConfigurations.get(o.id),A,C)}function Hu(d,t){let o=1<<d.canonical.z,h=(t.x*o-d.canonical.x-d.wrap*o)*r.aj,g=(t.y*o-d.canonical.y)*r.aj,_=r.e2(t.z,t.y);return r.d2(h,g,_)}function _t(d,t,o,h,g){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let _=d.context.gl,v=new gt(d.context.gl.LEQUAL,gt.ReadWrite,d.depthRangeFor3D),E=new gt(d.context.gl.GREATER,gt.ReadWrite,d.depthRangeFor3D),T=function(F){let V=r.cU(F.pitch),z=.01;return F.isOrthographic&&(z=r.ai(1e-4,z,r.cZ(V>=fi?1:V/fi))),2*z}(d.transform),C=d.transform.getFreeCameraOptions().position,A="elevatedStructuresDepthReconstruct",L=d.getOrCreateProgram(A,{defines:["DEPTH_RECONSTRUCTION"]}),R=d.getOrCreateProgram(A);for(let F of h){let V=t.getTile(F),z=V.getBucket(o);if(!z)continue;let H=z.elevatedStructures;if(!H)continue;let j=z.elevationBufferData.heightRange,Z=Hu(F.toUnwrapped(),C),Y=d.translatePosMatrix(F.projMatrix,V,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),J,re,ce,de;if(g==="initialize"){if(!j||j.min>=1||H.depthSegments.segments[0].primitiveLength===0)continue;J=Sh(Y,Z,T,1,0),re=v,ce=H.depthSegments,de=L}else if(g==="reset"){if(!j||j.min>=0||H.maskSegments.segments[0].primitiveLength===0)continue;J=Sh(Y,Z,0,0,1),re=E,ce=H.maskSegments,de=L}else if(g==="geometry"){if(H.depthSegments.segments[0].primitiveLength===0)continue;J=Sh(Y,Z,T,1,0),re=v,ce=H.depthSegments,de=R}de.draw(d,_.TRIANGLES,re,Lt.disabled,Yt.disabled,Mt.disabled,J,o.id,H.vertexBuffer,H.indexBuffer,ce,o.paint,d.transform.zoom)}}function Ph(d,t,o){let{painter:h,sourceCache:g,layer:_,coords:v,colorMode:E,elevationType:T,terrainEnabled:C,pass:A}=d,L=h.context.gl,R=_.paint.get("fill-pattern"),F=_.paint.get("fill-pattern-cross-fade"),V=R.constantOr(null),z=T;T!=="road"||t&&!C||(z="none");let H=z==="road",j=d.painter.shadowRenderer,Z=H&&!!j&&j.enabled,Y=new gt(h.context.gl.LEQUAL,gt.ReadOnly,h.depthRangeFor3D),J=[0,0,0];if(Z){let de=h.style.directionalLight,ie=h.style.ambientLight;de&&ie&&(J=ll(h.style,de,ie))}let re=R&&R.constantOr(1),ce=(de,ie)=>{let oe,se,Te,me,Ne;ie?(oe=re&&!_.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Te=L.LINES):(oe=re?"fillPattern":"fill",Te=L.TRIANGLES);for(let Ae of v){let Ve=g.getTile(Ae);if(re&&!Ve.patternsLoaded())continue;let Qe=Ve.getBucket(_);if(!Qe)continue;let Ie=t?Qe.elevationBufferData:Qe.bufferData;if(Ie.isEmpty())continue;h.prepareDrawTile();let pe=Ie.programConfigurations.get(_.id),Pe=h.isTileAffectedByFog(Ae),Se=[],He=[];H&&(Se.push("ELEVATED_ROADS"),He.push(Ie.elevatedLayoutVertexBuffer)),Z&&Se.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),re&&(h.context.activeTexture.set(L.TEXTURE0),Ve.imageAtlasTexture&&Ve.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),pe.updatePaintBuffers());let Ge=!1;if(V&&Ve.imageAtlas){let ft=Ve.imageAtlas,Tt=r.dZ.from(V),wt=Tt.getPrimary().scaleSelf(r.q.devicePixelRatio).toString(),zt=Tt.getSecondary(),Wt=ft.patternPositions.get(wt),on=zt?ft.patternPositions.get(zt.scaleSelf(r.q.devicePixelRatio).toString()):null;Ge=!!Wt&&!!on,Wt&&pe.setConstantPatternPositions(Wt,on)}F>0&&(Ge||pe.getPatternTransitionVertexBuffer("fill-pattern"))&&Se.push("FILL_PATTERN_TRANSITION");let We=h.getOrCreateProgram(oe,{config:pe,overrideFog:Pe,defines:Se}),ot=h.translatePosMatrix(Ae.projMatrix,Ve,_.paint.get("fill-translate"),_.paint.get("fill-translate-anchor"));Z&&j.setupShadows(Ve.tileID.toUnwrapped(),We,"vector-tile");let bt=_.paint.get("fill-emissive-strength");if(ie){me=Ie.lineIndexBuffer,Ne=Ie.lineSegments;let ft=h.terrain&&h.terrain.renderingToTexture?h.terrain.drapeBufferSize:[L.drawingBufferWidth,L.drawingBufferHeight];se=oe==="fillOutlinePattern"&&re?Ub(ot,bt,h,Ve,ft,J,F):Vb(ot,bt,ft,J)}else me=Ie.indexBuffer,Ne=Ie.triangleSegments,se=re?gy(ot,bt,h,Ve,J,F):my(ot,bt,J);h.uploadCommonUniforms(h.context,We,Ae.toUnwrapped());let St=de;(T==="road"&&!C||T==="offset")&&(St=Y),We.draw(h,Te,St,o||h.stencilModeForClipping(Ae),E,Mt.disabled,se,_.id,Ie.layoutVertexBuffer,me,Ne,_.paint,h.transform.zoom,pe,He)}};h.renderPass===A&&ce(h.depthModeForSublayer(1,h.renderPass==="opaque"?gt.ReadWrite:gt.ReadOnly),!1),z==="none"&&h.renderPass==="translucent"&&_.paint.get("fill-antialias")&&ce(h.depthModeForSublayer(_.getPaintProperty("fill-outline-color")?2:0,gt.ReadOnly),!0)}function Gu(d,t,o,h,g,_,v,E){o.resetLayerRenderingStats(d);let T=d.context,C=T.gl,A=d.transform,L=o.paint.get("fill-extrusion-pattern"),R=o.paint.get("fill-extrusion-pattern-cross-fade"),F=L.constantOr(null),V=L.constantOr(1),z=o.paint.get("fill-extrusion-opacity"),H=d.style.enable3dLights(),j=o.paint.get(H&&!V?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Z=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),j],Y=o.layout.get("fill-extrusion-edge-radius"),J=Y>0&&!o.paint.get("fill-extrusion-rounded-roof"),re=J?0:Y,ce=A.projection.name==="globe"?r.e5():0,de=A.projection.name==="globe",ie=de?r.ah(A.zoom):0,oe=[r.aD(A.center.lng),r.aH(A.center.lat)],se=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Te=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(se?null:o.lut).toArray01().slice(0,3),me=o.paint.get("fill-extrusion-flood-light-intensity"),Ne=o.paint.get("fill-extrusion-vertical-scale"),Ae=o.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Ve=o.paint.get("fill-extrusion-height-alignment"),Qe=o.paint.get("fill-extrusion-base-alignment"),Ie=Ts(d,o.paint.get("fill-extrusion-cutoff-fade-range")),pe=[],Pe;de&&pe.push("PROJECTION_GLOBE_VIEW"),Z[0]>0&&pe.push("FAUX_AO"),J&&pe.push("ZERO_ROOF_RADIUS"),E&&pe.push("HAS_CENTROID"),me>0&&pe.push("FLOOD_LIGHT"),Ie.shouldRenderCutoff&&pe.push("RENDER_CUTOFF"),Ae&&pe.push("RENDER_WALL_MODE");let Se=d.renderPass==="shadow",He=d.shadowRenderer,Ge=Se&&!!He,We=Se?Mt.disabled:Mt.backCCW;d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!0);let ot=[0,0,0];if(He){let ft=d.style.directionalLight,Tt=d.style.ambientLight;ft&&Tt&&(ot=ll(d.style,ft,Tt)),Se||(pe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),He.useNormalOffset&&pe.push("NORMAL_OFFSET")),Pe=pe.concat(["SHADOWS_SINGLE_CASCADE"])}let bt=Ge?"fillExtrusionDepth":V?"fillExtrusionPattern":"fillExtrusion",St=o.getLayerRenderingStats();for(let ft of h){let Tt=t.getTile(ft),wt=Tt.getBucket(o);if(!wt||wt.projection.name!==A.projection.name)continue;let zt=!1;He&&(zt=He.getMaxCascadeForTile(ft.toUnwrapped())===0);let Wt=d.isTileAffectedByFog(ft),on=wt.programConfigurations.get(o.id),bn=!1;if(F&&Tt.imageAtlas){let Tn=Tt.imageAtlas,Mn=r.dZ.from(F),sn=Mn.getPrimary().scaleSelf(r.q.devicePixelRatio).toString(),Bn=Mn.getSecondary(),Cn=Tn.patternPositions.get(sn),yr=Bn?Tn.patternPositions.get(Bn.scaleSelf(r.q.devicePixelRatio).toString()):null;bn=!!Cn&&!!yr,Cn&&on.setConstantPatternPositions(Cn,yr)}R>0&&(bn||on.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&pe.push("FILL_EXTRUSION_PATTERN_TRANSITION");let Ht=d.getOrCreateProgram(bt,{config:on,defines:zt?Pe:pe,overrideFog:Wt});if(d.terrain&&d.terrain.setupElevationDraw(Tt,Ht,{useMeterToDem:!0}),!wt.centroidVertexBuffer){let Tn=Ht.attributes.a_centroid_pos;Tn!==void 0&&C.vertexAttrib2f(Tn,0,0)}!Se&&He&&He.setupShadows(Tt.tileID.toUnwrapped(),Ht,"vector-tile"),V&&(d.context.activeTexture.set(C.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),on.updatePaintBuffers());let wn=o.paint.get("fill-extrusion-vertical-gradient"),Dn=1/wt.tileToMeter,Xn;if(Se&&He){if(Oh(Tt.tileID,wt.maxHeight,d))continue;let Tn=He.calculateShadowPassMatrixFromTile(Tt.tileID.toUnwrapped());Xn=py(Tn,re,Dn,Ne,Ve,Qe)}else{let Tn=d.translatePosMatrix(ft.expandedProjMatrix,Tt,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),Mn=A.projection.createInversionMatrix(A,ft.canonical);Xn=V?hc(Tn,d,wn,z,Z,re,Dn,ft,Tt,ce,Ve,Qe,ie,oe,Mn,Te,Ne,R):Yp(Tn,d,wn,z,Z,re,Dn,ft,ce,Ve,Qe,ie,oe,Mn,Te,Ne,me,ot)}d.uploadCommonUniforms(T,Ht,ft.toUnwrapped(),null,Ie);let tn=wt.segments;if(A.projection.name==="mercator"&&!Se&&(tn=wt.getVisibleSegments(Tt.tileID,d.terrain,d.transform.getFrustum(0)),!tn.get().length))continue;if(St)if(Se)for(let Tn of tn.get())St.numRenderedVerticesInShadowPass+=Tn.primitiveLength;else for(let Tn of tn.get())St.numRenderedVerticesInTransparentPass+=Tn.primitiveLength;let En=[];(d.terrain||E)&&En.push(wt.centroidVertexBuffer),de&&En.push(wt.layoutVertexExtBuffer),Ae&&En.push(wt.wallVertexBuffer),Ht.draw(d,T.gl.TRIANGLES,g,_,v,We,Xn,o.id,wt.layoutVertexBuffer,wt.indexBuffer,tn,o.paint,d.transform.zoom,on,En)}d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!1)}class $s{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function ro(d,t,o,h,g,_,v,E,T,C,A,L,R,F,V,z,H,j,Z,Y){let J=t.context,re=J.gl,ce=t.transform,de=t.transform.zoom,ie=[],oe=d.translate,se=d.translateAnchor,Te=d.edgeRadius,me=Ts(t,d.cutoffFadeRange);A==="clear"?(ie.push("CLEAR_SUBPASS"),Y&&(ie.push("CLEAR_FROM_TEXTURE"),J.activeTexture.set(re.TEXTURE0),Y.bind(re.LINEAR,re.CLAMP_TO_EDGE))):A==="sdf"&&ie.push("SDF_SUBPASS"),j&&ie.push("HAS_CENTROID"),me.shouldRenderCutoff&&ie.push("RENDER_CUTOFF");let Ne=(Ae,Ve,Qe,Ie,pe)=>{let Pe=Ve.programConfigurations.get(h.id),Se=t.isTileAffectedByFog(Ae),He=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:Pe,defines:ie,overrideFog:Se}),Ge=((ot,bt,St,ft,Tt,wt,zt,Wt,on,bn,Ht)=>({u_matrix:bt,u_opacity:St,u_ao_pass:ft?1:0,u_meter_to_tile:Tt,u_ao:wt,u_flood_light_intensity:zt,u_flood_light_color:Wt,u_attenuation:on,u_edge_radius:bn,u_fb:0,u_fb_size:Ht,u_dynamic_offset:1}))(0,Ie,L,C,pe,[R,F*pe],V,z,H,de>=17?0:Te*pe,Y?Y.size[0]:0),We=[];j&&We.push(Ve.hiddenByLandmarkVertexBuffer),t.uploadCommonUniforms(J,He,Ae.toUnwrapped(),null,me),He.draw(t,J.gl.TRIANGLES,_,v,E,T,Ge,h.id,Ve.vertexBuffer,Ve.indexBuffer,Qe,h.paint,de,Pe,We)};for(let Ae of g){let Ve=o.getTile(Ae),Qe=Ve.getBucket(h);if(!Qe||Qe.projection.name!==ce.projection.name||!Qe.groundEffect||Qe.groundEffect&&!Qe.groundEffect.hasData())continue;let Ie=Qe.groundEffect,pe=1/Qe.tileToMeter;{let Pe=t.translatePosMatrix(Ae.projMatrix,Ve,oe,se),Se=Ie.getDefaultSegment();Ne(Ae,Ie,Se,Pe,pe)}if(Z)for(let Pe=0;Pe<4;Pe++){let Se=r.e3[Pe](Ae),He=o.getTile(Se);if(!He)continue;let Ge=He.getBucket(h);if(!Ge||Ge.projection.name!==ce.projection.name||!Ge.groundEffect||Ge.groundEffect&&!Ge.groundEffect.hasData())continue;let We=Ge.groundEffect,ot,bt;Pe===0?(ot=[-r.aj,0,0],bt=1):Pe===1?(ot=[r.aj,0,0],bt=0):Pe===2?(ot=[0,-r.aj,0],bt=3):(ot=[0,r.aj,0],bt=2);let St=We.regionSegments[bt];if(!St)continue;let ft=new Float32Array(16);r.bo(ft,Ae.projMatrix,ot),Ne(Ae,We,St,t.translatePosMatrix(ft,Ve,oe,se),pe)}}}function Pt(d,t,o,h,g,_,v){h.centroidVertexArray.length===0&&h.createCentroidsBuffer();let E=_?_.findDEMTileFor(o):null;if(!(E&&E.dem||v))return;_&&E&&E.dem&&h.selfDEMTileTimestamp!==E.dem._timestamp&&(h.borderDoneWithNeighborZ=[-1,-1,-1,-1],h.selfDEMTileTimestamp=E.dem._timestamp);let T=j=>new r.P(Math.ceil((j+r.e7)*r.e8),0),C=j=>{let Z=t.getSource().minzoom,Y=re=>{let ce=t.getTileByID(re);if(ce&&ce.hasData())return ce.getBucket(g)},J=[0,-1,1];for(let re of J){if(j.overscaledZ+re<Z)continue;let ce=Y(j.calculateScaledKey(j.overscaledZ+re));if(ce)return ce}},A=[0,0,0],L=(j,Z)=>(A[0]=Math.min(j.min.y,Z.min.y),A[1]=Math.max(j.max.y,Z.max.y),A[2]=r.aj-Z.min.x>j.max.x?Z.min.x-r.aj:j.max.x,A),R=(j,Z)=>(A[0]=Math.min(j.min.x,Z.min.x),A[1]=Math.max(j.max.x,Z.max.x),A[2]=r.aj-Z.min.y>j.max.y?Z.min.y-r.aj:j.max.y,A),F=[(j,Z)=>L(j,Z),(j,Z)=>L(Z,j),(j,Z)=>R(j,Z),(j,Z)=>R(Z,j)],V=(j,Z,Y,J,re,ce,de)=>{if(!_)return 0;let ie=[[ce?Y:j,ce?j:Y,0],[ce?Y:Z,ce?Z:Y,0]],oe=de<0?r.aj+de:de,se=[ce?oe:(j+Z)/2,ce?(j+Z)/2:oe,0];return Y===0&&de<0||Y!==0&&de>0?_.getForTilePoints(re,[se],!0,J):ie.push(se),_.getForTilePoints(o,ie,!0,E),Math.max(ie[0][2],ie[1][2],se[2])/_.exaggeration()};for(let j=0;j<4;j++){let Z=h.borderFeatureIndices[j];if(Z.length===0)continue;let Y=r.e3[j](o),J=C(Y);if(!(J&&J instanceof r.e4))continue;let re=_?_.findDEMTileFor(Y):null;if(!(re&&re.dem||v)||(_&&re&&re.dem&&h.borderDEMTileTimestamp[j]!==re.dem._timestamp&&(h.borderDoneWithNeighborZ[j]=-1,h.borderDEMTileTimestamp[j]=re.dem._timestamp),h.borderDoneWithNeighborZ[j]===J.canonical.z))continue;J.centroidVertexArray.length===0&&J.createCentroidsBuffer();let ce=(j<2?1:5)-j,de=J.borderDoneWithNeighborZ[ce]!==h.canonical.z,ie=J.borderFeatureIndices[ce],oe=0;if(h.canonical.z!==J.canonical.z){for(let se of Z)h.showCentroid(h.featuresOnBorder[se]);if(de)for(let se of ie)J.showCentroid(J.featuresOnBorder[se]);h.borderDoneWithNeighborZ[j]=J.canonical.z,J.borderDoneWithNeighborZ[ce]=h.canonical.z}for(let se of Z){let Te=h.featuresOnBorder[se],me=h.centroidData[Te.centroidDataIndex],Ne=Te.borders[j],Ae;for(;oe<ie.length;){Ae=J.featuresOnBorder[ie[oe]];let Ve=Ae.borders[ce];if(Ve[1]>Ne[0]+3||Ve[0]>Ne[0]-3)break;J.showCentroid(Ae),oe++}if(Ae&&oe<ie.length){let Ve=oe,Qe=0;for(;!(Ae.borders[ce][0]>Ne[1]-3)&&(Qe++,++oe!==ie.length);)Ae=J.featuresOnBorder[ie[oe]];Ae=J.featuresOnBorder[ie[Ve]];let Ie=!1;if(Qe>=1){let Se=Ae.borders[ce];Math.abs(Ne[0]-Se[0])<3&&Math.abs(Ne[1]-Se[1])<3&&(Qe=1,Ie=!0,oe=Ve+1)}else if(Qe===0){h.showCentroid(Te);continue}let pe=J.centroidData[Ae.centroidDataIndex];v&&Ie&&(((z=me).flags|(H=pe).flags)&r.e6?(z.flags|=r.e6,H.flags|=r.e6):(z.flags&=~r.e6,H.flags&=~r.e6));let Pe=Te.intersectsCount()>1||Ae.intersectsCount()>1;if(Qe>1)oe=Ve,me.centroidXY=pe.centroidXY=new r.P(0,0);else if(re&&re.dem&&!Pe){let Se=F[j](me,pe),He=j%2?r.aj-1:0,Ge=V(Se[0],Math.min(r.aj-1,Se[1]),He,re,Y,j<2,Se[2]);me.centroidXY=pe.centroidXY=T(Ge)}else Pe?me.centroidXY=pe.centroidXY=new r.P(0,0):(me.centroidXY=h.encodeBorderCentroid(Te),pe.centroidXY=J.encodeBorderCentroid(Ae));h.writeCentroidToBuffer(me),J.writeCentroidToBuffer(pe)}else h.showCentroid(Te)}h.borderDoneWithNeighborZ[j]=J.canonical.z,J.borderDoneWithNeighborZ[ce]=h.canonical.z}var z,H;(h.needsCentroidUpdate||!h.centroidVertexBuffer&&h.centroidVertexArray.length!==0)&&h.uploadCentroid(d)}let lm=[1,0,0],Hb=[0,1,0],Gb=[0,0,1];function Oh(d,t,o){let h=o.transform,g=o.shadowRenderer;if(!g)return!0;let _=d.toUnwrapped(),v=h.tileSize*g._cascades[o.currentShadowCascade].scale,E=t;if(h.elevation){let z=h.elevation.getMinMaxForTile(d);z&&(E+=z.max)}let T=[...g.shadowDirection];T[2]=-T[2];let C=g.computeSimplifiedTileShadowVolume(_,E,v,T);if(!C)return!1;let A=[lm,Hb,Gb,T,[T[0],0,T[2]],[0,T[1],T[2]]],L=h.projection.name==="globe",R=h.scaleZoom(v),F=r.cy.fromInvProjectionMatrix(h.invProjMatrix,h.worldSize,R,!L),V=g.getCurrentCascadeFrustum();return F.intersectsPrecise(C.vertices,C.planes,A)===0||V.intersectsPrecise(C.vertices,C.planes,A)===0}function Lh(d){let{painter:t,source:o,layer:h,coords:g}=d,_=d.defines,v=t.context,E=t.renderPass==="shadow",T=t.renderPass==="light-beam",C=t.shadowRenderer,A;C&&(A=_.concat(["SHADOWS_SINGLE_CASCADE"]));let L=r.e9(t.transform.center.lat,t.transform.zoom);for(let R of g){let F=o.getTile(R),V=F.getBucket(h);if(!V)continue;let z=!1;C&&(z=C.getMaxCascadeForTile(R.toUnwrapped())===0);let H=V.programConfigurations.get(h.id),j,Z,Y=t.translatePosMatrix(R.expandedProjMatrix,F,[0,0],"map");if(Y=r.cP(r.bz(),Y,[1,1,d.verticalScale]),E&&C){if(Oh(F.tileID,V.maxHeight*L,t))continue;let J=C.calculateShadowPassMatrixFromTile(F.tileID.toUnwrapped());J=r.cP(r.bz(),J,[1,1,d.verticalScale]),Z=_y(J),j=t.getOrCreateProgram("buildingDepth",{config:H,defines:z?A:_,overrideFog:!1})}else if(T)j=t.getOrCreateProgram("buildingBloom",{config:H,defines:z?A:_,overrideFog:!1}),Z=Jp(Y);else{let J=t.transform.calculatePosMatrix(R.toUnwrapped(),t.transform.worldSize);r.cP(J,J,[1,1,d.verticalScale]);let re=r.bz();r.cP(re,J,[1,-1,1/L]),r.bi(re,re),r.ea(re,re),Z=Kp(Y,re),j=t.getOrCreateProgram("building",{config:H,defines:z?A:_,overrideFog:!1}),C&&C.setupShadowsFromMatrix(J,j,!0)}if(t.uploadCommonUniforms(v,j,R.toUnwrapped(),null,null),T){let J=V.bloomGeometry;j.draw(t,v.gl.TRIANGLES,d.depthMode,Lt.disabled,d.blendMode,Mt.disabled,Z,h.id,J.layoutVertexBuffer,J.indexBuffer,J.segmentsBucket,h.paint,t.transform.zoom,H,[J.layoutAttenuationBuffer,J.layoutColorBuffer])}else j.draw(t,v.gl.TRIANGLES,d.depthMode,Lt.disabled,d.blendMode,E?Mt.disabled:Mt.backCW,Z,h.id,V.layoutVertexBuffer,V.indexBuffer,V.segments,h.paint,t.transform.zoom,H,[V.layoutNormalBuffer,V.layoutColorBuffer])}}function Dy(d){return[d[0]*r.eb,d[1]*r.eb,d[2]*r.eb,0]}function Fh(d,t,o,h,g,_,v,E,T){let C=h.getSource(),A=o.globeSharedBuffers;if(!A)return;let L,R,F;if(t&&(L=h.getTile(t)),C instanceof r.aP?(R=C.texture,F=r.dE(0,0,o.transform)):L&&t&&(R=L.texture,F=r.dE(t.canonical.z,t.canonical.x,o.transform)),!R||!F)return;d||(F=r.cP(r.bz(),F,[1,-1,1]));let V=o.context,z=V.gl,H=g.paint.get("raster-resampling")==="nearest"?z.NEAREST:z.LINEAR,j=o.colorModeForDrapableLayerRenderPass(_),Z=v.defines;Z.push("GLOBE_POLES");let Y=new gt(z.LEQUAL,gt.ReadWrite,o.depthRangeFor3D),J=Float32Array.from(o.transform.expandedFarZProjMatrix),re=Float32Array.from(r.bh(r.dD(new r.cA(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),V.activeTexture.set(z.TEXTURE0),R.bind(H,z.CLAMP_TO_EDGE),V.activeTexture.set(z.TEXTURE1),R.bind(H,z.CLAMP_TO_EDGE),"useMipmap"in R&&V.extTextureFilterAnisotropic&&o.transform.pitch>20&&z.texParameterf(z.TEXTURE_2D,V.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,V.extTextureFilterAnisotropicMax);let[ce,de,ie,oe]=t?A.getPoleBuffers(t.canonical.z,!1):A.getPoleBuffers(0,!0),se=g.paint.get("raster-elevation"),Te;d?(Te=ce,o.renderDefaultNorthPole=se!==0):(Te=de,o.renderDefaultSouthPole=se!==0);let me=Dy(v.mix),Ne=((Ve,Qe,Ie,pe,Pe,Se,He,Ge,We,ot,bt,St,ft)=>em(Ve,Qe,Ie,new Float32Array(16),new Float32Array(9),[0,0],pe,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Se,[0,0],Ge,2,ot,bt,St,1,0,ft))(J,re,F,r.ah(o.transform.zoom),0,g,0,se,0,me,v.offset,v.range,_),Ae=o.getOrCreateProgram("raster",{defines:Z});o.uploadCommonUniforms(V,Ae,null),Ae.draw(o,z.TRIANGLES,Y,T,j,E,Ne,g.id,Te,ie,oe)}function $b(d){let t=d._nearZ,o=d.projection.farthestPixelDistance(d),h=o-t,g=.2*d.height,_=t+g;return[t,o,(_-g-t)/h,(_-t)/h]}function Wb(d,t,o,h){if(d)return t instanceof ga&&d instanceof Zl?t.getTextureDescriptor(d,o,!0):{texture:d.texture,mix:Dy(h.mix),offset:h.offset,buffer:0,tileSize:1}}var mo=r.ec([{name:"a_index",type:"Int16",components:1}]);class cm{constructor(t,o,h,g){let _={width:h[0],height:h[1],data:null},v=t.gl;this.targetColorTexture=new r.T(t,_,v.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new r.T(t,_,v.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(o,g),this.lastInvalidatedAt=0}updateParticleTexture(t,o){if(this.particleTextureDimension===o.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let h=this.context.gl,g=o.width*o.height;this.particleTexture0=new r.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new r.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1});let _=new r.ed;_.reserve(g);for(let v=0;v<g;v++)_.emplaceBack(v);this.particleIndexBuffer=this.context.createVertexBuffer(_,mo.members,!0),this.particleSegment=r.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=o.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=r.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Ui(d,t,o){if(!d)return null;let h=t.getTextureDescriptor(d,o,!0);if(!h)return null;let{texture:g,mix:_,offset:v,tileSize:E,buffer:T,format:C}=h;if(!g||!C)return null;let A=!1;return C==="uint32"&&(A=!0,_[3]=0,_=Dh(r.ee,_,[0,o.paint.get("raster-particle-max-speed")]),v=Ia(r.ee,v,[0,o.paint.get("raster-particle-max-speed")])),{texture:g,textureOffset:[T/(E+2*T),E/(E+2*T)],tileSize:E,scalarData:A,scale:_,offset:v,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[C]]}}function Ma(d){let t=d._nearZ,o=d.projection.farthestPixelDistance(d),h=o-t,g=.2*d.height,_=t+g;return[t,o,(_-g-t)/h,(_-t)/h]}let Cy=new r.am(1,0,0,1),um=new r.am(0,1,0,1),dm=new r.am(0,0,1,1),hm=new r.am(1,0,1,1),Ay=new r.am(0,1,1,1);function Is(d,t,o,h,g,_){for(let v=0;v<o.length;v++)if(g){let C=new r.am(h.r*.8,h.g*.8,h.b*.8,1);jn(d,t,o[v],h,-1,-1,_),jn(d,t,o[v],h,-1,1,_),jn(d,t,o[v],h,1,1,_),jn(d,t,o[v],h,1,-1,_),jn(d,t,o[v],C,0,0,_)}else jn(d,t,o[v],h,0,0,_)}function jn(d,t,o,h,g,_,v){let E=d.context,T=d.transform,C=E.gl,A=T.projection.name==="globe",L=A?["PROJECTION_GLOBE_VIEW"]:[],R=r.bw(o.projMatrix);if(A&&r.ah(T.zoom)>0){let me=r.bg(o.canonical,T),Ne=r.ef(me);R=r.az(new Float32Array(16),T.globeMatrix,Ne),r.az(R,T.projMatrix,R)}let F=r.bz();F[12]+=2*g/(r.q.devicePixelRatio*T.width),F[13]+=2*_/(r.q.devicePixelRatio*T.height),r.az(R,F,R);let V=d.getOrCreateProgram("debug",{defines:L}),z=t.getTileByID(o.key);d.terrain&&d.terrain.setupElevationDraw(z,V);let H=gt.disabled,j=Lt.disabled,Z=d.colorModeForRenderPass(),Y="$debug";E.activeTexture.set(C.TEXTURE0),d.emptyTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),A?z._makeGlobeTileDebugBuffers(d.context,T):z._makeDebugTileBoundsBuffers(d.context,T.projection);let J=z._tileDebugBuffer||d.debugBuffer,re=z._tileDebugIndexBuffer||d.debugIndexBuffer,ce=z._tileDebugSegments||d.debugSegments;if(V.draw(d,C.LINE_STRIP,H,j,Z,Mt.disabled,Qp(R,h.toPremultipliedRenderColor(null)),Y,J,re,ce,null,null,null,[z._globeTileDebugBorderBuffer]),v){let me=z.latestRawTileData,Ne=Math.floor((me&&me.byteLength||0)/1024),Ae=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(Ae+=` => ${o.overscaledZ}`),Ae+=` ${z.state}`,Ae+=` ${Ne}kb`,function(Ve,Qe){Ve.initDebugOverlayCanvas();let Ie=Ve.debugOverlayCanvas,pe=Ve.context.gl,Pe=Ve.debugOverlayCanvas.getContext("2d");Pe.clearRect(0,0,Ie.width,Ie.height),Pe.shadowColor="white",Pe.shadowBlur=2,Pe.lineWidth=1.5,Pe.strokeStyle="white",Pe.textBaseline="top",Pe.font="bold 36px Open Sans, sans-serif",Pe.fillText(Qe,5,5),Pe.strokeText(Qe,5,5),Ve.debugOverlayTexture.update(Ie),Ve.debugOverlayTexture.bind(pe.LINEAR,pe.CLAMP_TO_EDGE)}(d,Ae)}let de=t.getTile(o).tileSize,ie=512/Math.min(de,512)*(o.overscaledZ/T.zoom)*.5,oe=z._tileDebugTextBuffer||d.debugBuffer,se=z._tileDebugTextIndexBuffer||d.quadTriangleIndexBuffer,Te=z._tileDebugTextSegments||d.debugSegments;V.draw(d,C.TRIANGLES,H,j,Yt.alphaBlended,Mt.disabled,Qp(R,r.am.transparent.toPremultipliedRenderColor(null),ie),Y,oe,se,Te,null,null,null,[z._globeTileDebugTextBuffer])}function $u(d,t,o,h){Wu(d,0,t+o/2,d.transform.width,o,h)}function kh(d,t,o,h){Wu(d,t-o/2,0,o,d.transform.height,h)}function Wu(d,t,o,h,g,_){let v=d.context,E=v.gl;E.enable(E.SCISSOR_TEST),E.scissor(t*r.q.devicePixelRatio,o*r.q.devicePixelRatio,h*r.q.devicePixelRatio,g*r.q.devicePixelRatio),v.clear({color:_}),E.disable(E.SCISSOR_TEST)}let My=r.ec([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Ry}=My;function Ra(d,t,o,h){d.emplaceBack(t,o,h)}class gl{constructor(t){this.vertexArray=new r.eg,this.indices=new r.a_,Ra(this.vertexArray,-1,-1,1),Ra(this.vertexArray,1,-1,1),Ra(this.vertexArray,-1,1,1),Ra(this.vertexArray,1,1,1),Ra(this.vertexArray,-1,-1,-1),Ra(this.vertexArray,1,-1,-1),Ra(this.vertexArray,-1,1,-1),Ra(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Ry),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=r.bd.simpleSegment(0,0,36,12)}}function hs(d,t,o,h,g,_){let v=d.context.gl,E=t.paint.get("sky-atmosphere-color"),T=t.paint.get("sky-atmosphere-halo-color"),C=t.paint.get("sky-atmosphere-sun-intensity"),A=((L,R,F,V,z)=>({u_matrix_3f:L,u_sun_direction:R,u_sun_intensity:F,u_color_tint_r:[V.r,V.g,V.b,V.a],u_color_tint_m:[z.r,z.g,z.b,z.a],u_luminance:5e-5}))(r.ei(r.dJ(),h),g,C,E.toPremultipliedRenderColor(null),T.toPremultipliedRenderColor(null));v.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,v.TEXTURE_CUBE_MAP_POSITIVE_X+_,t.skyboxTexture,0),o.draw(d,v.TRIANGLES,gt.disabled,Lt.disabled,Yt.unblended,Mt.frontCW,A,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}let tt=r.ec([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class dt{constructor(t){let o=new r.ej;o.emplaceBack(-1,1,1,0,0),o.emplaceBack(1,1,1,1,0),o.emplaceBack(1,-1,1,1,1),o.emplaceBack(-1,-1,1,0,1);let h=new r.a_;h.emplaceBack(0,1,2),h.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(o,tt.members),this.indexBuffer=t.createIndexBuffer(h),this.segments=r.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let pc=r.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Mr{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class xe{constructor(t){this.colorModeAlphaBlendedWriteRGB=new Yt([1,al,1,al],r.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Yt([1,0,1,0],r.am.transparent,[!1,!1,!1,!0]),this.params=new Mr,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){let o=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new dt(o);let h=this.params.sizeRange,g=this.params.intensityRange,_=function(A){let L=r.el(30),R=[];for(let F=0;F<A;++F){let V=2*Math.PI*L(),z=Math.acos(1-2*L())-.5*Math.PI;R.push(r.d2(Math.cos(z)*Math.cos(V),Math.cos(z)*Math.sin(V),Math.sin(z)))}return R}(this.params.starsCount),v=r.el(300),E=new r.ek,T=new r.a_,C=0;for(let A=0;A<_.length;++A){let L=r.c1([],_[A],200),R=Math.max(0,1+.01*h*(1*v()-.5)),F=Math.max(0,1+.01*g*(1*v()-.5));E.emplaceBack(L[0],L[1],L[2],-1,-1,R,F),E.emplaceBack(L[0],L[1],L[2],1,-1,R,F),E.emplaceBack(L[0],L[1],L[2],1,1,R,F),E.emplaceBack(L[0],L[1],L[2],-1,1,R,F),T.emplaceBack(C+0,C+1,C+2),T.emplaceBack(C+0,C+2,C+3),C+=4}this.starsVx=o.createVertexBuffer(E,pc.members),this.starsIdx=o.createIndexBuffer(T),this.starsSegments=r.bd.simpleSegment(0,0,E.length,T.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,o){let h=t.context,g=h.gl,_=t.transform,v=new gt(g.LEQUAL,gt.ReadOnly,[0,1]),E=r.ah(_.zoom),T=t.style.getLut(o.scope),C=o.properties.get("color-use-theme")==="none",A=o.properties.get("color").toNonPremultipliedRenderColor(C?null:T).toArray01(),L=o.properties.get("high-color-use-theme")==="none",R=o.properties.get("high-color").toNonPremultipliedRenderColor(L?null:T).toArray01(),F=o.properties.get("space-color-use-theme")==="none",V=o.properties.get("space-color").toNonPremultipliedRenderColor(F?null:T).toArray01(),z=5e-4,H=r.em(o.properties.get("horizon-blend"),0,1,z,.25),j=r.dy(t,h,_)&&H===z?_.worldSize/(2*Math.PI*1.025)-1:_.globeRadius,Z=t.frameCounter/1e3%1,Y=r.ae(_.globeCenterInViewSpace),J=Math.sqrt(Math.pow(Y,2)-Math.pow(j,2)),re=Math.acos(J/Y),ce=de=>{let ie=_.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];de&&ie.push("ALPHA_PASS");let oe=t.getOrCreateProgram("globeAtmosphere",{defines:ie}),se=((me,Ne,Ae,Ve,Qe,Ie,pe,Pe,Se,He,Ge,We)=>({u_frustum_tl:me,u_frustum_tr:Ne,u_frustum_br:Ae,u_frustum_bl:Ve,u_horizon:Qe,u_transition:Ie,u_fadeout_range:pe,u_color:Pe,u_high_color:Se,u_space_color:He,u_temporal_offset:Ge,u_horizon_angle:We}))(_.frustumCorners.TL,_.frustumCorners.TR,_.frustumCorners.BR,_.frustumCorners.BL,_.frustumCorners.horizon,E,H,A,R,V,Z,re);t.uploadCommonUniforms(h,oe);let Te=this.atmosphereBuffer;Te&&oe.draw(t,g.TRIANGLES,v,Lt.disabled,de?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Mt.backCW,se,de?"atmosphere_glow_alpha":"atmosphere_glow",Te.vertexBuffer,Te.indexBuffer,Te.segments)};ce(!1),ce(!0)}drawStars(t,o){let h=r.ay(o.properties.get("star-intensity"),0,1);if(h===0)return;let g=t.context,_=g.gl,v=t.transform,E=t.getOrCreateProgram("stars"),T=r.c3([]);r.c5(T,T,-v._pitch),r.c4(T,T,-v.angle),r.c5(T,T,r.al(v._center.lat)),r.en(T,T,-r.al(v._center.lng));let C=r.c8(new Float32Array(16),T),A=r.az([],v.starsProjMatrix,C),L=r.ei([],C),R=r.eo([],L),F=[0,1,0];r.dL(F,F,R),r.c1(F,F,this.params.sizeMultiplier);let V=[1,0,0];r.dL(V,V,R),r.c1(V,V,this.params.sizeMultiplier);let z=(H=F,j=V,Z=h,{u_matrix:Float32Array.from(A),u_up:H,u_right:j,u_intensity_multiplier:Z});var H,j,Z;t.uploadCommonUniforms(g,E),this.starsVx&&this.starsIdx&&E.draw(t,_.TRIANGLES,gt.disabled,Lt.disabled,this.colorModeAlphaBlendedWriteRGB,Mt.disabled,z,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class Py{constructor(){this.visibleTiles=[]}updateBorders(t,o){let h=[],g=[],_=t._getRenderableCoordinates(!1,!0);for(let T of _){let C=t.getTile(T);if(!C.hasData())continue;let A=C.getBucket(o);A&&(A.isEmpty()||(h.push(T.key),g.push({bucket:A,tileID:T.canonical})))}let v=h.length!==this.visibleTiles.length;if(!v){h.sort();for(let T=0;T<h.length;T++)if(h[T]!==this.visibleTiles[T]){v=!0;break}}if(!v)return;let E=new Set;this.visibleTiles=h,g.sort((T,C)=>T.tileID.z-C.tileID.z||T.tileID.x-C.tileID.x||T.tileID.y-C.tileID.y);for(let T of g){let C=new Array,A=new Array,L=T.bucket;for(let R of L.featuresOnBorder)E.has(R.featureId)?A.push(R.footprintIndex):(E.add(R.featureId),C.push(R.footprintIndex));L.updateFootprintHiddenFlags(C,r.ep,!1),L.updateFootprintHiddenFlags(A,r.ep,!0)}}}function Zu(d,t){let o=[...d],h=t.cameraWorldSizeForFog/t.worldSize,g=r.bx([]);return r.cP(g,g,[h,h,1]),r.az(o,g,o),r.az(o,t.worldToFogMatrix,o),o}function qu(d,t,o,h,g){let _=o.material,v=h.context,{baseColorTexture:E,metallicRoughnessTexture:T}=_.pbrMetallicRoughness,{normalTexture:C,occlusionTexture:A,emissionTexture:L}=_;function R(V,z,H){if(V&&(d.push(z),v.activeTexture.set(v.gl.TEXTURE0+H),V.gfxTexture)){let{minFilter:j,magFilter:Z,wrapS:Y,wrapT:J}=V.sampler;V.gfxTexture.bindExtraParam(j,Z,Y,J)}}R(E,"HAS_TEXTURE_u_baseColorTexture",Vi.BaseColor),R(T,"HAS_TEXTURE_u_metallicRoughnessTexture",Vi.MetallicRoughness),R(C,"HAS_TEXTURE_u_normalTexture",Vi.Normal),R(A,"HAS_TEXTURE_u_occlusionTexture",Vi.Occlusion),R(L,"HAS_TEXTURE_u_emissionTexture",Vi.Emission),g&&(g.texture||(g.texture=new r.et(h.context,g.image,[g.image.height,g.image.height,g.image.height],v.gl.RGBA8)),v.activeTexture.set(v.gl.TEXTURE0+Vi.LUT),g.texture&&g.texture.bind(v.gl.LINEAR,v.gl.CLAMP_TO_EDGE),d.push("APPLY_LUT_ON_GPU")),o.texcoordBuffer&&(d.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(o.texcoordBuffer)),o.colorBuffer&&(d.push(o.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(o.colorBuffer)),o.normalBuffer&&(d.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(o.normalBuffer)),o.pbrBuffer&&(d.push("HAS_ATTRIBUTE_a_pbr"),d.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(o.pbrBuffer)),_.alphaMode!=="OPAQUE"&&_.alphaMode!=="MASK"||d.push("UNPREMULT_TEXTURE_IN_SHADER"),_.defined||d.push("DIFFUSE_SHADED");let F=h.shadowRenderer;F&&(d.push("RENDER_SHADOWS","DEPTH_TEXTURE"),F.useNormalOffset&&d.push("NORMAL_OFFSET"))}function mc(d,t,o,h,g,_){let v=o.paint.get("model-opacity").constantOr(1),E=t.context,T=new gt(t.context.gl.LEQUAL,gt.ReadWrite,t.depthRangeFor3D),C=t.transform,A=d.mesh,L=A.material,R=L.pbrMetallicRoughness,F=t.style.fog,V;V=t.transform.projection.zAxisUnit==="pixels"?[...d.nodeModelMatrix]:r.az([],h.zScaleMatrix,d.nodeModelMatrix),r.az(V,h.negCameraPosMatrix,V);let z=r.bi([],V);r.ea(z,z);let H=o.paint.get("model-color-use-theme").constantOr("default")==="none",j=o.paint.get("model-emissive-strength").constantOr(0),Z=nm(new Float32Array(d.worldViewProjection),new Float32Array(V),new Float32Array(z),null,t,v,R.baseColorFactor,L.emissiveFactor,R.metallicFactor,R.roughnessFactor,L,j,o),Y={defines:[]},J=[],re=t.shadowRenderer;re&&(re.useNormalOffset=!1),qu(Y.defines,J,A,t,H?null:o.lut);let ce=null;if(F){let oe=Zu(d.nodeModelMatrix,t.transform);if(ce=new Float32Array(oe),C.projection.name!=="globe"){let se=A.aabb.min,Te=A.aabb.max,[me,Ne]=F.getOpacityForBounds(oe,se[0],se[1],Te[0],Te[1]);Y.overrideFog=me>=je||Ne>=je}}let de=Ts(t,o.paint.get("model-cutoff-fade-range"));de.shouldRenderCutoff&&Y.defines.push("RENDER_CUTOFF");let ie=t.getOrCreateProgram("model",Y);t.uploadCommonUniforms(E,ie,null,ce,de),t.renderPass!=="shadow"&&re&&re.setupShadowsFromMatrix(d.nodeModelMatrix,ie),ie.draw(t,E.gl.TRIANGLES,T,g,_,A.material.doubleSided?Mt.disabled:Mt.backCCW,Z,o.id,A.vertexBuffer,A.indexBuffer,A.segments,o.paint,t.transform.zoom,void 0,J)}function fm(d,t,o,h,g,_,v){let E;E=d.projection.name==="globe"?r.er(o,d):[...o],r.az(E,E,t.matrix);let T=r.az([],h,E);if(t.meshes)for(let C of t.meshes){if(C.material.alphaMode!=="BLEND"){v.push({mesh:C,depth:0,modelIndex:g,worldViewProjection:T,nodeModelMatrix:E});continue}let A=r.ad([],C.centroid,T);!d.isOrthographic&&A[2]<=0||_.push({mesh:C,depth:A[2],modelIndex:g,worldViewProjection:T,nodeModelMatrix:E})}if(t.children)for(let C of t.children)fm(d,C,o,h,g,_,v)}function Nh(d,t,o,h){let g=o.shadowRenderer;if(!g)return;let _=g.getShadowPassDepthMode(),v=g.getShadowPassColorMode(),E=g.calculateShadowPassMatrixFromMatrix(t),T=Ey(E);o.getOrCreateProgram("modelDepth",{defines:o._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(o,o.context.gl.TRIANGLES,_,Lt.disabled,v,Mt.backCCW,T,h.id,d.vertexBuffer,d.indexBuffer,d.segments,h.paint,o.transform.zoom,void 0,void 0)}function gc(d,t,o){let h=t.updateZoomBasedPaintProperties(),g=function(_,v,E){let T,C,A,L=_.terrain?_.terrain.exaggeration():0;if(_.terrain&&L>0){let R=_.terrain,F=R.findDEMTileFor(E);F&&F.dem?T=r.eu.create(R,E,F):L=0}if(L===0&&(v.terrainElevationMin=0,v.terrainElevationMax=0),L===v.validForExaggeration&&(L===0||T&&T._demTile&&T._demTile.tileID===v.validForDEMTile.id&&T._dem._timestamp===v.validForDEMTile.timestamp))return!1;for(let R in v.instancesPerModel){let F=v.instancesPerModel[R];for(let V=0;V<F.instancedDataArray.length;++V){let z=(T?L*T.getElevationAt(0|F.instancedDataArray.float32[16*V],0|F.instancedDataArray.float32[16*V+1],!0,!0):0)+F.instancesEvaluatedElevation[V];F.instancedDataArray.float32[16*V+6]=z,C=C?Math.min(v.terrainElevationMin,z):z,A=A?Math.max(v.terrainElevationMax,z):z}}return v.terrainElevationMin=C||0,v.terrainElevationMax=A||0,v.validForExaggeration=L,v.validForDEMTile=T&&T._demTile?{id:T._demTile.tileID,timestamp:T._dem._timestamp}:{id:void 0,timestamp:0},!0}(d,t,o);(h||g)&&(t.uploaded=!1,t.upload(d.context))}let Ss={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new r.d6([0,0,0],[r.aj,r.aj,0])};function Zb(d,t){let o=1<<d.canonical.z,h=t.getFreeCameraOptions().position,g=t.elevation,_=d.canonical.x/o,v=(d.canonical.x+1)/o,E=d.canonical.y/o,T=(d.canonical.y+1)/o,C=t._centerAltitude;if(g){let F=g.getMinMaxForTile(d);F&&F.max>C&&(C=F.max)}let A=r.ay(h.x,_,v)-h.x,L=r.ay(h.y,E,T)-h.y,R=r.cb(C,t.center.lat)-h.z;return t._zoomFromMercatorZ(Math.sqrt(A*A+L*L+R*R))}function pm(d,t,o,h,g,_,v){let E=d.context,T=d.renderPass==="shadow",C=d.shadowRenderer,A=T&&C?C.getShadowPassDepthMode():new gt(E.gl.LEQUAL,gt.ReadWrite,d.depthRangeFor3D),L=d.isTileAffectedByFog(_);if(o.meshes)for(let R of o.meshes){let F=["MODEL_POSITION_ON_GPU"],V=[],z,H,j;h.instancedDataArray.length>20&&F.push("INSTANCED_ARRAYS");let Z=Ts(d,t.paint.get("model-cutoff-fade-range"));if(Z.shouldRenderCutoff&&F.push("RENDER_CUTOFF"),T&&C)z=d.getOrCreateProgram("modelDepth",{defines:F}),H=Ey(v.shadowTileMatrix,v.shadowTileMatrix,Float32Array.from(o.matrix)),j=C.getShadowPassColorMode();else{qu(F,V,R,d,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),z=d.getOrCreateProgram("model",{defines:F,overrideFog:L});let J=R.material,re=J.pbrMetallicRoughness,ce=t.paint.get("model-opacity").constantOr(1),de=t.paint.get("model-emissive-strength").constantOr(0);H=nm(_.expandedProjMatrix,Float32Array.from(o.matrix),new Float32Array(16),null,d,ce,re.baseColorFactor,J.emissiveFactor,re.metallicFactor,re.roughnessFactor,J,de,t,g),C&&(v.shadowUniformsInitialized?z.setShadowUniformValues(E,C.getShadowUniformValues()):(C.setupShadows(_.toUnwrapped(),z,"model-tile"),v.shadowUniformsInitialized=!0)),j=Z.shouldRenderCutoff||ce<1||J.alphaMode!=="OPAQUE"?Yt.alphaBlended:Yt.unblended}d.uploadCommonUniforms(E,z,_.toUnwrapped(),null,Z);let Y=R.material.doubleSided?Mt.disabled:Mt.backCCW;if(h.instancedDataArray.length>20)V.push(h.instancedDataBuffer),z.draw(d,E.gl.TRIANGLES,A,Lt.disabled,j,Y,H,t.id,R.vertexBuffer,R.indexBuffer,R.segments,t.paint,d.transform.zoom,void 0,V,h.instancedDataArray.length);else{let J=T?"u_instance":"u_normal_matrix";for(let re=0;re<h.instancedDataArray.length;++re)H[J]=new Float32Array(h.instancedDataArray.arrayBuffer,64*re,16),z.draw(d,E.gl.TRIANGLES,A,Lt.disabled,j,Y,H,t.id,R.vertexBuffer,R.indexBuffer,R.segments,t.paint,d.transform.zoom,void 0,V)}}if(o.children)for(let R of o.children)pm(d,t,R,h,g,_,v)}let zh=[1,-1,1];function mm(d,t,o,h){if(!o.modelManager)return!0;let g=o.modelManager;if(!o.shadowRenderer)return!0;let _=o.shadowRenderer,v=t.aabb,E=!0,T=d.maxHeight;if(T===0){let A=0;for(let L in d.instancesPerModel){let R=g.getModel(L,h);R?A=Math.max(A,Math.max(Math.max(R.aabb.max[0],R.aabb.max[1]),R.aabb.max[2])):E=!1}T=d.maxScale*A*1.41+d.maxVerticalOffset,E&&(d.maxHeight=T)}v.max[2]=T,v.min[2]+=d.terrainElevationMin,v.max[2]+=d.terrainElevationMax,r.ad(v.min,v.min,t.tileMatrix),r.ad(v.max,v.max,t.tileMatrix);let C=v.intersects(_.getCurrentCascadeFrustum());return o.currentShadowCascade===0&&(d.isInsideFirstShadowMapFrustum=C===2),C===0}function Oy(d,t){let o=d.uniformValues.u_cutoff_params[0],h=d.uniformValues.u_cutoff_params[1],g=d.uniformValues.u_cutoff_params[2],_=d.uniformValues.u_cutoff_params[3];return h===o||_===g?1:r.ay(((t-o)/(h-o)-g)/(_-g),0,1)}function Ly(d,t,o,h){if(t.pitch<20)return 1;let g=t.getWorldToCameraMatrix();r.az(g,g,d);let _=r.bR(o.min[0],o.min[1],o.min[2],1),v=r.aA(r.ev(),_,g),E=v,T=v;_[1]=o.max[1],v=r.aA(r.ev(),_,g),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T,_[0]=o.max[0],v=r.aA(r.ev(),_,g),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T,_[1]=o.min[1],v=r.aA(r.ev(),_,g),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T;let C=r.ay(h[0],0,1),A=100*t.pixelsPerMeter*r.ay(h[1],0,1),L=r.ay(h[2],0,1),R=r.ew(r.ev(),E,T,C),F=Math.tan(.5*t.fovX),V=-R[2]*F;if(A===0)return R[1]<-Math.abs(V)?L:1;let z=(-Math.abs(V)-R[1])/A,H=(Z,Y,J)=>(1-J)*Z+J*Y,j=r.ay(H(1,L,z),L,1);return H(1,j,r.ay((t.pitch-20)/20,0,1))}class Bh{}class Xu{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,o,h){{let L=this._storage.get(o.id);if(L)return L.lastUsedFrameIdx=t,L.buf}let g=h.gl,_=g.getBufferParameter(g.ELEMENT_ARRAY_BUFFER,g.BUFFER_SIZE),v=new ArrayBuffer(_),E=new Int16Array(v);g.getBufferSubData(g.ELEMENT_ARRAY_BUFFER,0,new Int16Array(v));let T=new r.ey;for(let L=0;L<_/2;L+=3){let R=E[L],F=E[L+1],V=E[L+2];T.emplaceBack(R,F),T.emplaceBack(F,V),T.emplaceBack(V,R)}let C=h.bindVertexArrayOES.current,A=new Bh;return A.buf=new Iy(h,T),A.lastUsedFrameIdx=t,this._storage.set(o.id,A),h.bindVertexArrayOES.set(C),A.buf}update(t){for(let[o,h]of this._storage)t-h.lastUsedFrameIdx>30&&(h.buf.destroy(),this._storage.delete(o))}destroy(){for(let[t,o]of this._storage)o.buf.destroy(),this._storage.delete(t)}}class _c{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let Fy=r.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class qb{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Li{constructor(t,o){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...o,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...o,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}let Xb=r.ec([{type:"Float32",name:"a_pos_2f",components:2}]);class Yu{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,o){let h=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let v=new r.ez,E=new r.a_;v.emplaceBack(-1,-1),v.emplaceBack(1,-1),v.emplaceBack(1,1),v.emplaceBack(-1,1),E.emplaceBack(0,1,2),E.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(v,Xb.members),this.vignetteIdx=t.context.createIndexBuffer(E)}let g=r.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,h);let v={u_vignetteShape:(_={vignetteShape:[o.start,o.range,Math.pow(10,o.fadePower)],vignetteColor:[o.color.r,o.color.g,o.color.b,o.color.a*o.strength]}).vignetteShape,u_vignetteColor:_.vignetteColor};h.draw(t,t.context.gl.TRIANGLES,gt.disabled,Lt.disabled,Yt.alphaBlended,Mt.disabled,v,"vignette",this.vignetteVx,this.vignetteIdx,g)}var _}}class sr{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,o){let h=t.getFreeCameraOptions().position,g=h.toAltitude(),_=h.toLngLat(),v=r.al(_.lng),E=r.al(_.lat),T=t.pixelsPerMeter/o,C=v*r.eB,A=r.eB*Math.log(Math.tan(Math.PI/4+E/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let L=-this._offsetYPrev+A,R=-this._elevationPrev+g;this._accumulatedOffsetX+=(-this._offsetXPrev+C)*T,this._accumulatedOffsetY+=L*T,this._accumulatedElevation+=R*T,this._offsetXPrev=C,this._offsetYPrev=A,this._elevationPrev=g}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function gn(d,t){return[-(d[0]-Math.floor(d[0]/t)*t),-(d[1]-Math.floor(d[1]/t)*t),-(d[2]-Math.floor(d[2]/t)*t)]}function gm(d){let t=r.el(1323123451230),o=[];for(let h=0;h<d;++h){let g=2*t()-1,_=2*t()-1,v=2*t()-1;o.push(r.d2(g,_,v))}return o}function io(d,t,o,h,g){let _=r.ay((g-o)/(h-o),0,1);return(1-_)*d+_*t}class yc{constructor(t){this._movement=new sr,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Yu,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,o){let h=t.transform;this._movement.update(h,this._ppmScaleFactor);let g=h.starsProjMatrix,_=r.c3([]);r.c5(_,_,r.al(90)-h._pitch),r.c4(_,_,-h.angle);let v=r.c8(new Float32Array(16),_),E=r.eA(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),T=r.ea([],E),C=r.az([],T,v),A=Date.now()/1e3;return this._accumulatedTimeFromStart+=(A-this._prevTime)*o,this._prevTime=A,{projectionMatrix:g,modelviewMatrix:C}}}class vc extends yc{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Li(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=gm(this.particlesCount),g=new r.eC,_=new r.a_,v=0,E=r.el(1323123451230);for(let T=0;T<h.length;++T){let C=h[T],A=[2*E()-1,E(),E(),E()];g.emplaceBack(C[0],C[1],C[2],-1,-1,...A),g.emplaceBack(C[0],C[1],C[2],1,-1,...A),g.emplaceBack(C[0],C[1],C[2],1,1,...A),g.emplaceBack(C[0],C[1],C[2],-1,1,...A),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=o.createVertexBuffer(g,Fy.members),this.particlesIdx=o.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;let o=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},h=t.transform.zoom;if(o.revealStart>h)return;let g=io(0,1,o.revealStart,o.revealStart+o.revealRange,h);if(!this.particlesVx||!this.particlesIdx)return;let _=structuredClone(this._params),v=[-_.direction.x,_.direction.y,-100];r.au(v,v);let E=structuredClone(this._vignetteParams);E.strength*=g,_.overrideStyleParameters||(_.intensity=t.style.rain.state.density,_.timeFactor=t.style.rain.state.intensity,_.color=structuredClone(t.style.rain.state.color),v=structuredClone(t.style.rain.state.direction),_.screenThinning.intensity=t.style.rain.state.centerThinning,_.dropletSizeX=t.style.rain.state.dropletSize[0],_.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],_.distortionStrength=100*t.style.rain.state.distortionStrength,E.strength=1,E.color=structuredClone(t.style.rain.state.vignetteColor));let T=this.updateOnRender(t,_.timeFactor),C=t.context,A=C.gl,L=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new r.T(C,{width:t.width,height:t.height,data:null},A.RGBA8)),_.distortionStrength>0&&(C.activeTexture.set(A.TEXTURE0),this.screenTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),A.copyTexSubImage2D(A.TEXTURE_2D,0,0,0,0,0,t.width,t.height));let R=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(C,R),C.activeTexture.set(A.TEXTURE0),this.screenTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE);let F=[_.color.r,_.color.g,_.color.b,_.color.a],V=(z,H)=>{let j=gn(this._movement.getPosition(),z),Z=_.dropletSizeX,Y=_.dropletSizeX*_.dropletSizeYScale,J=t.width/2,re=t.height/2,ce=io(0,_.screenThinning.start,0,1,_.screenThinning.intensity),de=io(.001,_.screenThinning.range,0,1,_.screenThinning.intensity),ie=io(0,_.screenThinning.particleOffset,0,1,_.screenThinning.intensity),oe=(se={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:j,velocityConeAperture:_.velocityConeAperture,velocity:_.velocity,boxSize:z,rainDropletSize:[Z,Y],distortionStrength:_.distortionStrength,rainDirection:v,color:F,screenSize:[L.width,L.height],thinningCenterPos:[J,re],thinningShape:[ce,de,Math.pow(10,_.screenThinning.fadePower)],thinningAffectedRatio:_.screenThinning.affectedRatio,thinningParticleOffset:ie,shapeDirectionalPower:_.shapeDirPower,shapeNormalPower:_.shapeNormalPower,mode:H?0:1},{u_modelview:Float32Array.from(se.modelview),u_projection:Float32Array.from(se.projection),u_time:se.time,u_cam_pos:se.camPos,u_texScreen:0,u_velocityConeAperture:se.velocityConeAperture,u_velocity:se.velocity,u_boxSize:se.boxSize,u_rainDropletSize:se.rainDropletSize,u_distortionStrength:se.distortionStrength,u_rainDirection:se.rainDirection,u_color:se.color,u_screenSize:se.screenSize,u_thinningCenterPos:se.thinningCenterPos,u_thinningShape:se.thinningShape,u_thinningAffectedRatio:se.thinningAffectedRatio,u_thinningParticleOffset:se.thinningParticleOffset,u_shapeDirectionalPower:se.shapeDirectionalPower,u_shapeNormalPower:se.shapeNormalPower,u_mode:se.mode});var se;let Te=Math.round(_.intensity*this.particlesCount),me=r.bd.simpleSegment(0,0,4*Te,2*Te);R.draw(t,A.TRIANGLES,gt.disabled,Lt.disabled,Yt.alphaBlended,Mt.disabled,oe,"rain_particles",this.particlesVx,this.particlesIdx,me)};_.distortionStrength>0&&V(_.boxSize,!0),V(_.boxSize,!1),this._vignette.draw(t,E)}}let _l=r.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class _m extends yc{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Li(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=gm(this.particlesCount),g=new r.eD,_=new r.a_,v=0,E=r.el(1323123451230);for(let T=0;T<h.length;++T){let C=h[T],A=E(),L=E(),R=E(),F=[T/h.length,A,L,R],V=[E(),E()];g.emplaceBack(C[0],C[1],C[2],-1,-1,...F,...V),g.emplaceBack(C[0],C[1],C[2],1,-1,...F,...V),g.emplaceBack(C[0],C[1],C[2],1,1,...F,...V),g.emplaceBack(C[0],C[1],C[2],-1,1,...F,...V),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=o.createVertexBuffer(g,_l.members),this.particlesIdx=o.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;let o=structuredClone(this._params),h=[-o.direction.x,o.direction.y,-100];r.au(h,h);let g=structuredClone(this._vignetteParams),_=o.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},v=t.transform.zoom;if(_.revealStart>v)return;let E=io(0,1,_.revealStart,_.revealStart+_.revealRange,v);g.strength*=E,o.overrideStyleParameters||(o.intensity=t.style.snow.state.density,o.timeFactor=t.style.snow.state.intensity,o.color=structuredClone(t.style.snow.state.color),h=structuredClone(t.style.snow.state.direction),o.screenThinning.intensity=t.style.snow.state.centerThinning,o.billboardSize=2.79*t.style.snow.state.flakeSize,g.strength=1,g.color=structuredClone(t.style.snow.state.vignetteColor));let T=this.updateOnRender(t,o.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let C=t.context,A=C.gl,L=t.transform,R=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(C,R),((F,V,z)=>{let H=gn(this._movement.getPosition(),F),j=L.width/2,Z=L.height/2,Y=io(0,z.screenThinning.start,0,1,z.screenThinning.intensity),J=io(.001,z.screenThinning.range,0,1,z.screenThinning.intensity),re=io(0,z.screenThinning.particleOffset,0,1,z.screenThinning.intensity),ce=(de={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:H,velocityConeAperture:z.velocityConeAperture,velocity:z.velocity,horizontalOscillationRadius:z.horizontalOscillationRadius,horizontalOscillationRate:z.horizontalOscillationRate,boxSize:F,billboardSize:1*z.billboardSize,simpleShapeParameters:[z.shapeFadeStart,z.shapeFadePower],screenSize:[L.width,L.height],thinningCenterPos:[j,Z],thinningShape:[Y,J,Math.pow(10,z.screenThinning.fadePower)],thinningAffectedRatio:z.screenThinning.affectedRatio,thinningParticleOffset:re,color:[z.color.r,z.color.g,z.color.b,z.color.a],direction:h},{u_modelview:Float32Array.from(de.modelview),u_projection:Float32Array.from(de.projection),u_time:de.time,u_cam_pos:de.camPos,u_velocityConeAperture:de.velocityConeAperture,u_velocity:de.velocity,u_horizontalOscillationRadius:de.horizontalOscillationRadius,u_horizontalOscillationRate:de.horizontalOscillationRate,u_boxSize:de.boxSize,u_billboardSize:de.billboardSize,u_simpleShapeParameters:de.simpleShapeParameters,u_screenSize:de.screenSize,u_thinningCenterPos:de.thinningCenterPos,u_thinningShape:de.thinningShape,u_thinningAffectedRatio:de.thinningAffectedRatio,u_thinningParticleOffset:de.thinningParticleOffset,u_particleColor:de.color,u_direction:de.direction});var de;let ie=Math.round(z.intensity*this.particlesCount),oe=r.bd.simpleSegment(0,0,4*ie,2*ie);this.particlesVx&&this.particlesIdx&&R.draw(t,A.TRIANGLES,gt.disabled,Lt.disabled,Yt.alphaBlended,Mt.disabled,ce,"snow_particles",this.particlesVx,this.particlesIdx,oe)})(o.boxSize,0,o),this._vignette.draw(t,g)}}let ym={symbol:function(d,t,o,h,g){if(d.renderPass!=="translucent")return;let _=Lt.disabled,v=d.colorModeForRenderPass(),E=o.layout.get("text-variable-anchor"),T=o.layout.get("text-size-scale-range"),C=r.ay(d.scaleFactor,T[0],T[1]);E&&function(R,F,V,z,H,j,Z,Y){let J=F.transform,re=H==="map",ce=j==="map";for(let de of R){let ie=z.getTile(de),oe=ie.getBucket(V);if(!oe||!oe.text||!oe.text.segments.get().length)continue;let se=r.bH(oe.textSizeData,J.zoom,Y),Te=eh(de,oe.getProjection(),J),me=J.calculatePixelsToTileUnitsMatrix(ie),Ne=Su(Te,ie.tileID.canonical,ce,re,J,oe.getProjection(),me),Ae=oe.hasIconTextFit()&&oe.hasIconData();se&&Sy(oe,re,ce,Z,J,Ne,de,Math.pow(2,J.zoom-ie.tileID.overscaledZ),se,Ae)}}(h,d,o,t,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),g,C);let A=o.paint.get("icon-opacity").constantOr(1)!==0,L=o.paint.get("text-opacity").constantOr(1)!==0;o.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(A||L)?am(d,t,o,h,_,v):(A&&am(d,t,o,h,_,v,{onlyIcons:!0}),L&&am(d,t,o,h,_,v,{onlyText:!0})),t.map.showCollisionBoxes&&(om(d,t,o,h,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),om(d,t,o,h,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(d,t,o,h){if(d.renderPass!=="translucent")return;let g=o.paint.get("circle-opacity"),_=o.paint.get("circle-stroke-width"),v=o.paint.get("circle-stroke-opacity"),E=o.layout.get("circle-sort-key").constantOr(1)!==void 0,T=o.paint.get("circle-emissive-strength");if(g.constantOr(1)===0&&(_.constantOr(1)===0||v.constantOr(1)===0))return;let C=d.context,A=C.gl,L=d.transform,R=!(!d.terrain||!d.terrain.enabled),F=o.layout.get("circle-elevation-reference"),V=d.depthModeForSublayer(0,gt.ReadOnly),z=new gt(d.context.gl.LEQUAL,gt.ReadOnly,d.depthRangeFor3D),H=F==="none"||R?V:z,j=Lt.disabled,Z=d.colorModeForDrapableLayerRenderPass(T),Y=L.projection.name==="globe",J=[r.aD(L.center.lng),r.aH(L.center.lat)],re=[];for(let de=0;de<h.length;de++){let ie=h[de],oe=t.getTile(ie),se=oe.getBucket(o);if(!se||se.projection.name!==L.projection.name)continue;let Te=se.programConfigurations.get(o.id),me=se.layoutVertexBuffer,Ne=se.globeExtVertexBuffer,Ae=se.indexBuffer,Ve=r.dW(o),Qe=[Ne],Ie=d.isTileAffectedByFog(ie);Y&&Ve.push("PROJECTION_GLOBE_VIEW"),Ve.push("DEPTH_D24"),d.terrain&&L.depthOcclusionForSymbolsAndCircles&&Ve.push("DEPTH_OCCLUSION"),se.hasElevation&&!d.terrain&&(Ve.push("ELEVATED_ROADS"),Qe.push(se.elevatedLayoutVertexBuffer));let pe=d.getOrCreateProgram("circle",{config:Te,defines:Ve,overrideFog:Ie}),Pe=L.projection.createInversionMatrix(L,ie.canonical),Se={programConfiguration:Te,program:pe,layoutVertexBuffer:me,dynamicBuffers:Qe,indexBuffer:Ae,uniformValues:r.dX(d,ie,oe,Pe,J,o),tile:oe};if(E){let He=se.segments.get();for(let Ge of He)re.push({segments:new r.bd([Ge]),sortKey:Ge.sortKey,state:Se})}else re.push({segments:se.segments,sortKey:0,state:Se})}E&&re.sort((de,ie)=>de.sortKey-ie.sortKey);let ce={useDepthForOcclusion:L.depthOcclusionForSymbolsAndCircles};for(let de of re){let{programConfiguration:ie,program:oe,layoutVertexBuffer:se,dynamicBuffers:Te,indexBuffer:me,uniformValues:Ne,tile:Ae}=de.state,Ve=de.segments;d.terrain&&d.terrain.setupElevationDraw(Ae,oe,ce),d.uploadCommonUniforms(C,oe,Ae.tileID.toUnwrapped()),oe.draw(d,A.TRIANGLES,H,j,Z,Mt.disabled,Ne,o.id,se,me,Ve,o.paint,L.zoom,ie,Te)}},heatmap:function(d,t,o,h){if(o.paint.get("heatmap-opacity")!==0)if(d.renderPass==="offscreen"){let g=d.context,_=g.gl,v=Lt.disabled,E=new Yt([_.ONE,_.ONE,_.ONE,_.ONE],r.am.transparent,[!0,!0,!0,!0]);(function(F,V,z,H){let j=F.gl,Z=V.width*H,Y=V.height*H;F.activeTexture.set(j.TEXTURE1),F.viewport.set([0,0,Z,Y]);let J=z.heatmapFbo;if(!J||J&&(J.width!==Z||J.height!==Y)){J&&J.destroy();let re=j.createTexture();j.bindTexture(j.TEXTURE_2D,re),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MIN_FILTER,j.LINEAR),j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MAG_FILTER,j.LINEAR),J=z.heatmapFbo=F.createFramebuffer(Z,Y,!0,null),function(ce,de,ie,oe,se,Te){let me=ce.gl;me.texImage2D(me.TEXTURE_2D,0,ce.extRenderToTextureHalfFloat?me.RGBA16F:me.RGBA,se,Te,0,me.RGBA,ce.extRenderToTextureHalfFloat?me.HALF_FLOAT:me.UNSIGNED_BYTE,null),oe.colorAttachment.set(ie)}(F,0,re,J,Z,Y)}else j.bindTexture(j.TEXTURE_2D,J.colorAttachment.get()),F.bindFramebuffer.set(J.framebuffer)})(g,d,o,d.transform.projection.name==="globe"?.5:.25),g.clear({color:r.am.transparent});let T=d.transform,C=T.projection.name==="globe",A=C?["PROJECTION_GLOBE_VIEW"]:[],L=C?Mt.frontCCW:Mt.disabled,R=[r.aD(T.center.lng),r.aH(T.center.lat)];for(let F=0;F<h.length;F++){let V=h[F];if(t.hasRenderableParent(V))continue;let z=t.getTile(V),H=z.getBucket(o);if(!H||H.projection.name!==T.projection.name)continue;let j=d.isTileAffectedByFog(V),Z=H.programConfigurations.get(o.id),Y=d.getOrCreateProgram("heatmap",{config:Z,defines:A,overrideFog:j}),{zoom:J}=d.transform;d.terrain&&d.terrain.setupElevationDraw(z,Y),d.uploadCommonUniforms(g,Y,V.toUnwrapped());let re=T.projection.createInversionMatrix(T,V.canonical);Y.draw(d,_.TRIANGLES,gt.disabled,v,E,L,vy(d,V,z,re,R,J,o.paint.get("heatmap-intensity")),o.id,H.layoutVertexBuffer,H.indexBuffer,H.segments,o.paint,d.transform.zoom,Z,C?[H.globeExtVertexBuffer]:null)}g.viewport.set([0,0,d.width,d.height])}else d.renderPass==="translucent"&&(d.context.setColorMode(d.colorModeForRenderPass()),function(g,_){let v=g.context,E=v.gl,T=_.heatmapFbo;if(!T)return;v.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,T.colorAttachment.get()),v.activeTexture.set(E.TEXTURE1);let C=_.colorRampTexture;C||(C=_.colorRampTexture=new r.T(v,_.colorRamp,E.RGBA8)),C.bind(E.LINEAR,E.CLAMP_TO_EDGE),g.getOrCreateProgram("heatmapTexture").draw(g,E.TRIANGLES,gt.disabled,Lt.disabled,g.colorModeForRenderPass(),Mt.disabled,((A,L,R,F)=>({u_image:0,u_color_ramp:1,u_opacity:L.paint.get("heatmap-opacity")}))(0,_),_.id,g.viewportBuffer,g.quadTriangleIndexBuffer,g.viewportSegments,_.paint,g.transform.zoom)}(d,o))},line:function(d,t,o,h){if(d.renderPass!=="translucent")return;let g=o.paint.get("line-opacity"),_=o.paint.get("line-width");if(g.constantOr(1)===0||_.constantOr(1)===0)return;let v=o.paint.get("line-emissive-strength"),E=o.paint.get("line-occlusion-opacity"),T=o.layout.get("line-elevation-reference"),C=o.layout.get("line-width-unit")==="meters",A=T==="sea",L=!(!d.terrain||!d.terrain.enabled),R=d.context,F=R.gl;if(o.hasElevatedBuckets&&d.transform.projection.name==="globe")return;let V=o.layout.get("line-cross-slope"),z=V!==void 0,H=V<1,j=d.colorModeForDrapableLayerRenderPass(v),Z=d.terrain&&d.terrain.renderingToTexture,Y=Z?1:r.q.devicePixelRatio,J=o.paint.get("line-dasharray"),re=J.constantOr(1),ce=o.layout.get("line-cap"),de=J.constantOr(null),ie=ce.constantOr(null),oe=o.paint.get("line-pattern"),se=oe.constantOr(1),Te=o.paint.get("line-pattern-cross-fade"),me=oe.constantOr(null),Ne=o.paint.get("line-opacity").constantOr(1),Ae=!se&&Ne!==1||d.depthOcclusion&&E>0&&E<1,Ve=o.paint.get("line-gradient"),Qe=se?"linePattern":"line",Ie=r.dY(o),pe;if(Z&&d.terrain&&d.terrain.clipOrMaskOverlapStencilType()&&(Ae=!1),E!==0&&d.depthOcclusion){let Ge=o.paint._values["line-opacity"];Ge&&Ge.value&&Ge.value.kind==="constant"?pe=Ge.value:r.w(`Occlusion opacity for layer ${o.id} is supported only when line-opacity isn't data-driven.`)}_.value.kind!=="constant"&&_.value.isLineProgressConstant===!1&&Ie.push("VARIABLE_LINE_WIDTH");let Pe=(Ge,We,ot,bt,St,ft)=>{for(let Tt of Ge){let wt=t.getTile(Tt);if(se&&!wt.patternsLoaded())continue;let zt=wt.getBucket(o);if(!zt||zt.elevationType!=="none"&&!St||zt.elevationType==="none"&&St)continue;d.prepareDrawTile();let Wt=[...We],on=d.shadowRenderer,bn=zt.elevationType==="road"&&!!on&&on.enabled,Ht=[0,0,0];if(bn){let vn=d.style.directionalLight,Rn=d.style.ambientLight;vn&&Rn&&(Ht=ll(d.style,vn,Rn)),Wt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}let wn=zt.programConfigurations.get(o.id),Dn=!1;if(me&&wt.imageAtlas){let vn=r.dZ.from(me),Rn=vn.getPrimary().scaleSelf(Y).toString(),Wn=wt.imageAtlas.patternPositions.get(Rn),Gr=vn.getSecondary(),Br=Gr?wt.imageAtlas.patternPositions.get(Gr.scaleSelf(Y).toString()):null;Dn=!!Wn&&!!Br,Wn&&wn.setConstantPatternPositions(Wn,Br)}Te>0&&(Dn||wn.getPatternTransitionVertexBuffer("line-pattern"))&&Wt.push("LINE_PATTERN_TRANSITION");let Xn=d.isTileAffectedByFog(Tt),tn=d.getOrCreateProgram(Qe,{config:wn,defines:Wt,overrideFog:Xn});if(!se&&de&&ie&&wt.lineAtlas){let vn=wt.lineAtlas.getDash(de,ie);vn&&wn.setConstantPatternPositions(vn)}bn&&on.setupShadows(wt.tileID.toUnwrapped(),tn,"vector-tile");let[En,Tn]=o.paint.get("line-trim-offset");(ie==="round"||ie==="square")&&En!==Tn&&(En===0&&(En-=1),Tn===1&&(Tn+=1));let Mn=Z?Tt.projMatrix:null,sn=C?1/zt.tileToMeter/r.aw(wt,1,d.transform.zoom):1,Bn=C?1/zt.tileToMeter/r.aw(wt,1,Math.floor(d.transform.zoom)):1,Cn=se?r.d_(d,wt,o,Mn,Y,sn,Bn,[En,Tn],Ht,Te):r.d$(d,wt,o,Mn,zt.lineClipsArray.length,Y,sn,Bn,[En,Tn],Ht);if(Ve){let vn=zt.gradients[o.id],Rn=vn.texture;if(o.gradientVersion!==vn.version){let Wn=256;if(o.stepInterpolant){let Gr=t.getSource().maxzoom,Br=Tt.canonical.z===Gr?Math.ceil(1<<d.transform.maxZoom-Tt.canonical.z):1;Wn=r.ay(r.e0(zt.maxLineLength/r.aj*1024*Br),256,R.maxTextureSize)}vn.gradient=r.e1({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:Wn,image:vn.gradient||void 0,clips:zt.lineClipsArray}),vn.texture?vn.texture.update(vn.gradient):vn.texture=new r.T(R,vn.gradient,F.RGBA8),vn.version=o.gradientVersion,Rn=vn.texture}R.activeTexture.set(F.TEXTURE1),Rn.bind(o.stepInterpolant?F.NEAREST:F.LINEAR,F.CLAMP_TO_EDGE)}re&&(R.activeTexture.set(F.TEXTURE0),wt.lineAtlasTexture&&wt.lineAtlasTexture.bind(F.LINEAR,F.REPEAT),wn.updatePaintBuffers()),se&&(R.activeTexture.set(F.TEXTURE0),wt.imageAtlasTexture&&wt.imageAtlasTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),wn.updatePaintBuffers()),St&&!A&&d.terrain.setupElevationDraw(wt,tn),d.uploadCommonUniforms(R,tn,Tt.toUnwrapped());let yr=vn=>{pe!=null&&(pe.value=Ne*E),tn.draw(d,F.TRIANGLES,ot,vn,j,Mt.disabled,Cn,o.id,zt.layoutVertexBuffer,zt.indexBuffer,zt.segments,o.paint,d.transform.zoom,wn,[zt.layoutVertexBuffer2,zt.patternVertexBuffer,zt.zOffsetVertexBuffer]),pe!=null&&(pe.value=Ne)};if(Ae&&!St){let vn=d.stencilModeForClipping(Tt).ref;vn===0&&Z&&R.clear({stencil:0});let Rn={func:F.EQUAL,mask:255};Cn.u_alpha_discard_threshold=.8,yr(new Lt(Rn,vn,255,F.KEEP,F.KEEP,F.INVERT)),Cn.u_alpha_discard_threshold=0,yr(new Lt(Rn,vn,255,F.KEEP,F.KEEP,F.KEEP))}else Cn.u_alpha_discard_threshold=Ae&&St&&ft?.8:0,yr(St?bt:d.stencilModeForClipping(Tt))}},Se=d.depthModeForSublayer(0,gt.ReadOnly),He=new gt(d.depthOcclusion?F.GREATER:F.LEQUAL,gt.ReadOnly,d.depthRangeFor3D);if(o.hasNonElevatedBuckets){let Ge=!Z&&d.terrain;E!==0&&Ge?r.w(`Occlusion opacity for layer ${o.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ge?r.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${o.id}.`):Pe(h,Ie,Se,Lt.disabled,!1,!0)}if(o.hasElevatedBuckets){T==="hd-road-markup"?L||(Se=He,Ie.push("ELEVATED_ROADS")):(Ie.push("ELEVATED"),Se=He,z&&Ie.push(H?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),A&&Ie.push("ELEVATION_REFERENCE_SEA"));let Ge=Ae?d.stencilModeFor3D():Lt.disabled;d.forceTerrainMode=!0,Pe(h,Ie,Se,Ge,!0,!0),Ae&&Pe(h,Ie,Se,Ge,!0,!1),d.forceTerrainMode=!1}Ae&&(d.resetStencilClippingMasks(),Z&&R.clear({stencil:0})),E===0||d.depthOcclusion||Z||d.layersWithOcclusionOpacity.push(d.currentLayer)},fill:function(d,t,o,h){let g=o.paint.get("fill-color"),_=o.paint.get("fill-opacity");if(_.constantOr(1)===0)return;let v=o.paint.get("fill-emissive-strength"),E=d.colorModeForDrapableLayerRenderPass(v),T=o.paint.get("fill-pattern"),C=d.opaquePassEnabledForLayer()&&!T.constantOr(1)&&g.constantOr(r.am.transparent).a===1&&_.constantOr(0)===1?"opaque":"translucent",A="none";o.layout.get("fill-elevation-reference")!=="none"?A="road":o.paint.get("fill-z-offset").constantOr(1)!==0&&(A="offset");let L=!(!d.terrain||!d.terrain.enabled),R={painter:d,sourceCache:t,layer:o,coords:h,colorMode:E,elevationType:A,terrainEnabled:L,pass:C};if(d.renderPass!=="shadow")if(A!=="offset"){if(Ph(R,!1),A==="road"){let F=!L&&d.renderPass==="translucent";F&&_t(d,t,o,h,"geometry"),Ph(R,!0,Lt.disabled),F&&function(V){let{painter:z,sourceCache:H,layer:j,coords:Z,colorMode:Y}=V,J=z.context.gl,re=V.painter.shadowRenderer,ce=!!re&&re.enabled,de=new gt(z.context.gl.LEQUAL,gt.ReadOnly,z.depthRangeFor3D),ie=[0,0,0];if(ce){let se=z.style.directionalLight,Te=z.style.ambientLight;se&&Te&&(ie=ll(z.style,se,Te))}let oe=se=>{for(let Te of Z){let me=H.getTile(Te),Ne=me.getBucket(j);if(!Ne)continue;let Ae=Ne.elevatedStructures;if(!Ae)continue;let Ve,Qe;if(se?(Ve=Ae.renderableBridgeSegments,Qe=Ae.bridgeProgramConfigurations.get(j.id)):(Ve=Ae.renderableTunnelSegments,Qe=Ae.tunnelProgramConfigurations.get(j.id)),!Ve||Ve.segments[0].primitiveLength===0)continue;Qe.updatePaintBuffers(),z.prepareDrawTile();let Ie=z.isTileAffectedByFog(Te),pe=[];ce&&pe.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let Pe=z.getOrCreateProgram("elevatedStructures",{config:Qe,overrideFog:Ie,defines:pe}),Se=z.translatePosMatrix(Te.projMatrix,me,j.paint.get("fill-translate"),j.paint.get("fill-translate-anchor"));ce&&re.setupShadows(me.tileID.toUnwrapped(),Pe,"vector-tile");let He=jb(Se,ie);z.uploadCommonUniforms(z.context,Pe,Te.toUnwrapped()),Pe.draw(z,J.TRIANGLES,de,Lt.disabled,Y,Mt.backCCW,He,j.id,Ae.vertexBuffer,Ae.indexBuffer,Ve,j.paint,z.transform.zoom,Qe,[Ae.vertexBufferNormal])}};oe(!0),oe(!1)}(R)}}else Ph(R,!1,d.stencilModeFor3D());else d.shadowRenderer&&A==="road"&&!L&&function(F){let{painter:V,sourceCache:z,layer:H,coords:j}=F,Z=V.context.gl,Y=F.painter.shadowRenderer;for(let J of j){let re=z.getTile(J),ce=re.getBucket(H);if(!ce)continue;let de=ce.elevatedStructures;if(!de||!de.shadowCasterSegments||de.shadowCasterSegments.segments[0].primitiveLength===0)continue;V.prepareDrawTile();let ie=ce.bufferData.programConfigurations.get(H.id),oe=V.isTileAffectedByFog(J),se=V.getOrCreateProgram("elevatedStructuresDepth",{config:ie,overrideFog:oe}),Te=Y.calculateShadowPassMatrixFromTile(re.tileID.toUnwrapped());V.uploadCommonUniforms(V.context,se,J.toUnwrapped());let me={u_matrix:Te,u_depth_bias:0};se.draw(V,Z.TRIANGLES,Y.getShadowPassDepthMode(),Lt.disabled,Y.getShadowPassColorMode(),Mt.disabled,me,H.id,de.vertexBuffer,de.indexBuffer,de.shadowCasterSegments,H.paint,V.transform.zoom,ie)}}(R)},"fill-extrusion":function(d,t,o,h){let g=o.paint.get("fill-extrusion-opacity"),_=d.context,v=_.gl,E=d.terrain,T=E&&E.renderingToTexture;if(g===0)return;let C=d.conflationActive&&d.style.isLayerClipped(o,t.getSource()),A=d.style.order.indexOf(o.fqid);if(C&&function(L,R,F,V,z){for(let H of V){let j=R.getTile(H).getBucket(F);j&&(j.updateReplacement(H,L.replacementSource,z),j.uploadCentroid(L.context))}}(d,t,o,h,A),E||C)for(let L of h){let R=t.getTile(L).getBucket(o);R&&Pt(d.context,t,L,R,o,E,C)}if(d.renderPass==="shadow"&&d.shadowRenderer){let L=d.shadowRenderer;if(E&&g<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof r.ab)return;let R=L.getShadowPassDepthMode(),F=L.getShadowPassColorMode();Gu(d,t,o,h,R,Lt.disabled,F,C)}else if(d.renderPass==="translucent"){let L=!o.paint.get("fill-extrusion-pattern").constantOr(1),R=o.paint.get("fill-extrusion-color").constantOr(r.am.white);if(!T&&R.a!==0){let F=new gt(d.context.gl.LEQUAL,gt.ReadWrite,d.depthRangeFor3D);g===1&&L?Gu(d,t,o,h,F,Lt.disabled,Yt.unblended,C):(Gu(d,t,o,h,F,Lt.disabled,Yt.disabled,C),Gu(d,t,o,h,F,d.stencilModeFor3D(),d.colorModeForRenderPass(),C),d.resetStencilClippingMasks())}if(d.style.enable3dLights()&&L&&(!E&&d.transform.projection.name!=="globe"||T)){let F=o.paint.get("fill-extrusion-opacity"),V=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),z=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),H=o.paint.get("fill-extrusion-flood-light-intensity"),j=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Z=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(j?null:o.lut).toArray01().slice(0,3),Y=V>0&&z>0,J=H>0,re=(ie,oe,se)=>(1-se)*ie+se*oe,ce=new $s;ce.translate=o.paint.get("fill-extrusion-translate"),ce.translateAnchor=o.paint.get("fill-extrusion-translate-anchor"),ce.edgeRadius=o.layout.get("fill-extrusion-edge-radius"),ce.cutoffFadeRange=o.paint.get("fill-extrusion-cutoff-fade-range");let de=ie=>{let oe=d.depthModeForSublayer(1,gt.ReadOnly,v.LEQUAL,!0),se=o.paint.get(ie?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Te=re(.1,3,se),me=d._showOverdrawInspector;if(!me){let Ne=new Lt({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),Ae=new Yt([v.ONE,v.ONE,v.ONE,v.ONE],r.am.transparent,[!1,!1,!1,!0],v.MIN);ro(ce,d,t,o,h,oe,Ne,Ae,Mt.disabled,ie,"sdf",F,V,z,H,Z,Te,C,!1)}{let Ne=me?Lt.disabled:new Lt({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),Ae=me?d.colorModeForRenderPass():new Yt([v.ONE_MINUS_DST_ALPHA,v.DST_ALPHA,v.ONE,v.ONE],r.am.transparent,[!0,!0,!0,!0]);ro(ce,d,t,o,h,oe,Ne,Ae,Mt.disabled,ie,"color",F,V,z,H,Z,Te,C,!1)}};if(T){let ie=(oe,se,Te)=>{let me=d.depthModeForSublayer(1,gt.ReadOnly,v.LEQUAL,!1),Ne=o.paint.get(oe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ae=re(.1,3,Ne);{let Ve=new Yt([v.ONE,v.ONE,v.ONE,v.ONE],r.am.transparent,[!1,!1,!1,!0]);ro(ce,d,t,o,h,me,Lt.disabled,Ve,Mt.disabled,oe,"clear",F,V,z,H,Z,Ae,C,se)}{let Ve=new Lt({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),Qe=new Yt([v.ONE,v.ONE,v.ONE,v.ONE],r.am.transparent,[!1,!1,!1,!0],v.MIN);ro(ce,d,t,o,h,me,Ve,Qe,Mt.disabled,oe,"sdf",F,V,z,H,Z,Ae,C,se)}{let Ve=oe?v.ZERO:v.ONE_MINUS_DST_ALPHA,Qe=new Lt({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),Ie=new Yt([Ve,v.DST_ALPHA,v.ONE_MINUS_DST_ALPHA,v.ZERO],r.am.transparent,[!0,!0,!0,!0]);ro(ce,d,t,o,h,me,Qe,Ie,Mt.disabled,oe,"color",F,V,z,H,Z,Ae,C,se)}{let Ve=new Yt([v.ONE,v.ONE,v.ONE,oe?v.ZERO:v.ONE],r.am.transparent,[!1,!1,!1,!0],oe?v.FUNC_ADD:v.MAX);ro(ce,d,t,o,h,me,Lt.disabled,Ve,Mt.disabled,oe,"clear",F,V,z,H,Z,Ae,C,se,Te)}};if(Y||J){let oe;if(d.prepareDrawTile(),E){let se=E.drapeBufferSize[0],Te=E.drapeBufferSize[1];oe=E.framebufferCopyTexture,oe&&(!oe||oe.size[0]===se&&oe.size[1]===Te)||(oe&&oe.destroy(),oe=E.framebufferCopyTexture=new r.T(_,new r.r({width:se,height:Te}),v.RGBA8)),oe.bind(v.LINEAR,v.CLAMP_TO_EDGE),v.copyTexSubImage2D(v.TEXTURE_2D,0,0,0,0,0,se,Te)}Y&&ie(!0,!1,oe),J&&ie(!1,!0,oe)}}else Y&&de(!0),J&&de(!1),(Y||J)&&d.resetStencilClippingMasks()}}},building:function(d,t,o,h){d.currentLayer<d.firstLightBeamLayer&&(d.firstLightBeamLayer=d.currentLayer);let g=o.paint.get("building-ambient-occlusion-ground-intensity"),_=o.paint.get("building-ambient-occlusion-ground-radius"),v=o.paint.get("building-ambient-occlusion-ground-attenuation"),E=g>0&&_>0,T=!0,C=o.paint.get("building-vertical-scale");C<1&&(T=!1);let A=d.conflationActive&&d.style.isLayerClipped(o,t.getSource()),L=d.style.order.indexOf(o.fqid);if(function(R,F,V,z,H,j){for(let Z of j){let Y=F.getTile(Z).getBucket(V);Y&&(H&&Y.updateReplacement(Z,R.replacementSource,z),Y.uploadUpdatedIndexBuffer(R.context))}}(d,t,o,L,A,h),function(R,F,V,z){for(let H of z){let j=F.getTile(H).getBucket(V);j&&j.needsEvaluation(R,V)&&(j.evaluate(V),j.uploadUpdatedColorBuffer(R.context))}}(d,t,o,h),o.resetLayerRenderingStats(d),d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!0),d.renderPass==="shadow"&&d.shadowRenderer){let R=d.shadowRenderer,F=[],V=R.getShadowPassDepthMode();Lh({painter:d,source:t,layer:o,coords:h,defines:F,blendMode:R.getShadowPassColorMode(),depthMode:V,verticalScale:C})}else if(d.renderPass==="translucent"){E&&function(z,H,j,Z,Y,J,re,ce,de,ie,oe,se,Te){let me=z.context.gl,Ne=z.depthModeForSublayer(1,gt.ReadOnly,me.LEQUAL,!0),Ae=.1*(1-(Ve=oe))+3*Ve;var Ve;let Qe=z._showOverdrawInspector,Ie=se,pe=new $s;Qe||ro(pe,z,H,j,Z,Ne,new Lt({func:me.ALWAYS,mask:255},255,255,me.KEEP,me.KEEP,me.REPLACE),new Yt([me.ONE,me.ONE,me.ONE,me.ONE],r.am.transparent,[!1,!1,!1,!0],me.MIN),Mt.disabled,Y,"sdf",1,re,ce,0,ie,Ae,Ie,!1);{let Pe=Qe?Lt.disabled:new Lt({func:me.EQUAL,mask:255},255,255,me.KEEP,me.DECR,me.DECR),Se=Qe?z.colorModeForRenderPass():new Yt([me.ONE_MINUS_DST_ALPHA,me.DST_ALPHA,me.ONE,me.ONE],r.am.transparent,[!0,!0,!0,!0]);ro(pe,z,H,j,Z,Ne,Pe,Se,Mt.disabled,Y,"color",1,re,ce,0,ie,Ae,Ie,!1)}}(d,t,o,h,!0,0,g,_,0,[0,0,0],v,A);let R=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];T&&(R=R.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),d.shadowRenderer.useNormalOffset&&(R=R.concat("NORMAL_OFFSET"));let F=new gt(d.context.gl.LEQUAL,gt.ReadWrite,d.depthRangeFor3D),V=d.colorModeForRenderPass();Lh({painter:d,source:t,layer:o,coords:h,defines:R,blendMode:V,depthMode:F,verticalScale:C})}else if(d.renderPass==="light-beam"){let R=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],F=new gt(d.context.gl.LEQUAL,gt.ReadOnly,d.depthRangeFor3D);Lh({painter:d,source:t,layer:o,coords:h,defines:R,blendMode:Yt.alphaBlended,depthMode:F,verticalScale:C})}d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!1),d.resetStencilClippingMasks()},hillshade:function(d,t,o,h){if(d.renderPass!=="offscreen"&&d.renderPass!=="translucent"||d.style.disableElevatedTerrain)return;let g=d.context,_=d.terrain&&d.terrain.renderingToTexture,[v,E]=d.renderPass!=="translucent"||_?[{},h]:d.stencilConfigForOverlap(h);for(let T of E){let C=t.getTile(T);if(C.needsHillshadePrepare&&d.renderPass==="offscreen")ry(d,C,o);else if(d.renderPass==="translucent"){let A=d.depthModeForSublayer(0,gt.ReadOnly),L=o.paint.get("hillshade-emissive-strength"),R=d.colorModeForDrapableLayerRenderPass(L),F=_&&d.terrain?d.terrain.stencilModeForRTTOverlap(T):v[T.overscaledZ];Pb(d,T,C,o,A,F,R)}}g.viewport.set([0,0,d.width,d.height]),d.resetStencilClippingMasks()},raster:function(d,t,o,h,g,_){if(d.renderPass!=="translucent"||o.paint.get("raster-opacity")===0)return;let v=d.transform.projection.name==="globe",E=o.paint.get("raster-elevation")!==0,T=E&&v;if(d.renderElevatedRasterBackface&&!T)return;let C=d.context,A=C.gl,L=t.getSource(),R=function(ce,de,ie,oe){let se=de.paint.get("raster-color"),Te=ce.type==="raster-array",me=[],Ne=de.paint.get("raster-resampling"),Ae=de.paint.get("raster-color-mix"),Ve=de.paint.get("raster-color-range"),Qe=[Ae[0],Ae[1],Ae[2],0],Ie=Ae[3],pe=Ne==="nearest"?oe.NEAREST:oe.LINEAR;if(Te&&(me.push("RASTER_ARRAY"),se||me.push("RASTER_COLOR"),Ne==="linear"&&me.push("RASTER_ARRAY_LINEAR"),pe=oe.NEAREST,!Ve&&ce.rasterLayers)){let Pe=ce.rasterLayers.find(({id:Se})=>Se===de.sourceLayer);Pe&&Pe.fields&&Pe.fields.range&&(Ve=Pe.fields.range)}if(Ve=Ve||[0,1],se){me.push("RASTER_COLOR"),ie.activeTexture.set(oe.TEXTURE2),de.updateColorRamp(Ve);let Pe=de.colorRampTexture;Pe||(Pe=de.colorRampTexture=new r.T(ie,de.colorRamp,oe.RGBA8)),Pe.bind(oe.LINEAR,oe.CLAMP_TO_EDGE)}return{mix:Qe,range:Ve,offset:Ie,defines:me,resampling:pe}}(L,o,C,A);if(L instanceof r.aP&&!h.length&&!v)return;let F=o.paint.get("raster-emissive-strength"),V=d.colorModeForDrapableLayerRenderPass(F),z=d.terrain&&d.terrain.renderingToTexture,H=!d.options.moving,j=o.paint.get("raster-resampling")==="nearest"?A.NEAREST:A.LINEAR;if(L instanceof r.aP&&!h.length&&(L.onNorthPole||L.onSouthPole)){let ce=E?d.stencilModeFor3D():Lt.disabled;return void Fh(!!L.onNorthPole,null,d,t,o,F,R,Mt.disabled,ce)}if(!h.length)return;let[Z,Y]=L instanceof r.aP||z?[{},h]:d.stencilConfigForOverlap(h),J=Y[Y.length-1].overscaledZ;T&&R.defines.push("PROJECTION_GLOBE_VIEW"),E&&R.defines.push("RENDER_CUTOFF");let re=(ce,de,ie)=>{for(let oe of ce){let se=oe.toUnwrapped(),Te=t.getTile(oe);if(z&&(!Te||!Te.hasData()))continue;C.activeTexture.set(A.TEXTURE0);let me=Wb(Te,L,o,R);if(!me||!me.texture)continue;let{texture:Ne,mix:Ae,offset:Ve,tileSize:Qe,buffer:Ie}=me,pe,Pe;z?(pe=gt.disabled,Pe=oe.projMatrix):E?(pe=new gt(A.LEQUAL,gt.ReadWrite,d.depthRangeFor3D),Pe=v?Float32Array.from(d.transform.expandedFarZProjMatrix):d.transform.calculateProjMatrix(se,H)):(pe=d.depthModeForSublayer(oe.overscaledZ-J,o.paint.get("raster-opacity")===1?gt.ReadWrite:gt.ReadOnly,A.LESS),Pe=d.transform.calculateProjMatrix(se,H));let Se=d.terrain&&z?d.terrain.stencilModeForRTTOverlap(oe):Z[oe.overscaledZ],He=_?0:o.paint.get("raster-fade-duration");Te.registerFadeDuration(He);let Ge=t.findLoadedParent(oe,0),We=no(Te,Ge,t,d.transform,He),ot,bt;d.terrain&&d.terrain.prepareDrawTile(),C.activeTexture.set(A.TEXTURE0),Ne.bind(j,A.CLAMP_TO_EDGE),C.activeTexture.set(A.TEXTURE1),Ge?(Ge.texture&&Ge.texture.bind(j,A.CLAMP_TO_EDGE),ot=Math.pow(2,Ge.tileID.overscaledZ-Te.tileID.overscaledZ),bt=[Te.tileID.canonical.x*ot%1,Te.tileID.canonical.y*ot%1]):Ne.bind(j,A.CLAMP_TO_EDGE),"useMipmap"in Ne&&C.extTextureFilterAnisotropic&&d.transform.pitch>20&&A.texParameterf(A.TEXTURE_2D,C.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,C.extTextureFilterAnisotropicMax);let St=d.transform,ft,Tt=E?$b(St):[0,0,0,0],wt,zt,Wt,on,bn,Ht=0;if(T&&L instanceof r.aP&&L.coordinates.length>3)wt=Float32Array.from(r.bh(r.dD(new r.cA(0,0,0)))),zt=Float32Array.from(St.globeMatrix),Wt=Float32Array.from(r.dz(St)),on=[r.aD(St.center.lng),r.aH(St.center.lat)],ft=L.elevatedGlobePerspectiveTransform,bn=L.elevatedGlobeGridMatrix||new Float32Array(9);else if(T){let tn=r.dA(oe.canonical);Ht=r.dB(tn.getCenter().lat),wt=Float32Array.from(r.bh(r.dD(oe.canonical))),zt=Float32Array.from(St.globeMatrix),Wt=Float32Array.from(r.dz(St)),on=[r.aD(St.center.lng),r.aH(St.center.lat)],ft=[0,0],bn=Float32Array.from(r.dC(oe.canonical,tn,Ht,St.worldSize/St._pixelsPerMercatorPixel))}else ft=L instanceof r.aP?L.perspectiveTransform:[0,0],wt=new Float32Array(16),zt=new Float32Array(9),Wt=new Float32Array(16),on=[0,0],bn=new Float32Array(9);let wn=em(Pe,wt,zt,Wt,bn,bt||[0,0],r.ah(d.transform.zoom),on,Tt,ot||1,We,o,ft,E?o.paint.get("raster-elevation"):0,2,Ae,Ve,R.range,Qe,Ie,F),Dn=d.isTileAffectedByFog(oe),Xn=d.getOrCreateProgram("raster",{defines:R.defines,overrideFog:Dn});if(d.uploadCommonUniforms(C,Xn,se),L instanceof r.aP){let tn=L.elevatedGlobeVertexBuffer,En=L.elevatedGlobeIndexBuffer;if(z||!v)L.boundsBuffer&&L.boundsSegments&&Xn.draw(d,A.TRIANGLES,pe,Lt.disabled,V,Mt.disabled,wn,o.id,L.boundsBuffer,d.quadTriangleIndexBuffer,L.boundsSegments);else if(tn&&En){let Tn=St.zoom<=r.cX?L.elevatedGlobeSegments:L.getSegmentsForLongitude(St.center.lng);Tn&&Xn.draw(d,A.TRIANGLES,pe,Lt.disabled,V,de,wn,o.id,tn,En,Tn)}}else if(T){pe=new gt(A.LEQUAL,gt.ReadOnly,d.depthRangeFor3D);let tn=d.globeSharedBuffers;if(tn){let[En,Tn,Mn]=tn.getGridBuffers(Ht,!1);Xn.draw(d,A.TRIANGLES,pe,ie||Se,d.colorModeForRenderPass(),de,wn,o.id,En,Tn,Mn)}}else{let{tileBoundsBuffer:tn,tileBoundsIndexBuffer:En,tileBoundsSegments:Tn}=d.getTileBoundsBuffers(Te);Xn.draw(d,A.TRIANGLES,pe,Se,V,Mt.disabled,wn,o.id,tn,En,Tn)}}if(!(L instanceof r.aP)&&T)for(let oe of ce){let se=oe.canonical.y===(1<<oe.canonical.z)-1;oe.canonical.y===0&&Fh(!0,oe,d,t,o,F,R,de,ie||Lt.disabled),se&&Fh(!1,oe,d,t,o,F,R,de===Mt.frontCW?Mt.backCW:Mt.frontCW,ie||Lt.disabled)}};T?re(Y,d.renderElevatedRasterBackface?Mt.backCW:Mt.frontCW,d.stencilModeFor3D()):re(Y,Mt.disabled,void 0),d.resetStencilClippingMasks()},"raster-particle":function(d,t,o,h,g,_){d.renderPass==="offscreen"&&function(v,E,T,C){if(!C.length)return;let A=v.context,L=A.gl,R=E.getSource();if(!(R instanceof ga))return;let F=Math.ceil(Math.sqrt(T.paint.get("raster-particle-count"))),V=T.particlePositionRGBAImage;if(!V||V.width!==F){let Y=function(J){let re=J*J,ce=new Uint8Array(4*re),de=function(oe){return oe|=0,oe=Math.imul(2747636419^oe,2654435769),oe=Math.imul(oe^oe>>>16,2654435769),((oe=Math.imul(oe^oe>>>16,2654435769))>>>0)/4294967296},ie=1/1.1;for(let oe=0;oe<re;oe++){let se=ie*(de(2*oe+0)+Da),Te=ie*(de(2*oe+1)+Da),me=255*se%1,Ne=255*Te%1,Ae=me,Ve=Te-Ne/255,Qe=Ne;ce[4*oe+0]=255*(se-me/255),ce[4*oe+1]=255*Ae,ce[4*oe+2]=255*Ve,ce[4*oe+3]=255*Qe}return ce}(F);V=T.particlePositionRGBAImage=new r.r({width:F,height:F},Y)}let z=T.particleFramebuffer;z?z.width!==F&&(z.destroy(),z=T.particleFramebuffer=A.createFramebuffer(F,F,!0,null)):z=T.particleFramebuffer=A.createFramebuffer(F,F,!0,null);let H=[];for(let Y of C){let J=E.getTile(Y);if(!(J instanceof Zl))continue;let re=Ui(J,R,T);if(!re)continue;let ce=[J.tileSize,J.tileSize],de=T.tileFramebuffer;de||(de=T.tileFramebuffer=A.createFramebuffer(ce[0],ce[1],!0,null));let ie=J.rasterParticleState;ie||(ie=J.rasterParticleState=new cm(A,Y,ce,V));let oe=ie.update(T.lastInvalidatedAt);ie.particleTextureDimension!==F&&ie.updateParticleTexture(Y,V);let se=ie.targetColorTexture;ie.targetColorTexture=ie.backgroundColorTexture,ie.backgroundColorTexture=se;let Te=ie.particleTexture0;ie.particleTexture0=ie.particleTexture1,ie.particleTexture1=Te,H.push([Y,re,ie,oe])}if(H.length===0)return;let j=r.q.now(),Z=T.previousDrawTimestamp?.001*(j-T.previousDrawTimestamp):.0167;if(T.previousDrawTimestamp=j,T.hasColorMap()){A.activeTexture.set(L.TEXTURE0+2);let Y=T.colorRampTexture;Y||(Y=T.colorRampTexture=new r.T(A,T.colorRamp,L.RGBA8)),Y.bind(L.LINEAR,L.CLAMP_TO_EDGE)}A.bindFramebuffer.set(T.tileFramebuffer.framebuffer),function(Y,J,re){let ce=Y.context,de=ce.gl,ie=J.tileFramebuffer;ce.activeTexture.set(de.TEXTURE0);let oe={u_texture:0,u_opacity:1.05*(Te=J.paint.get("raster-particle-fade-opacity-factor"))/(Te+.05)},se=Y.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Te;for(let me of re){let[,,Ne,Ae]=me;ie.colorAttachment.set(Ne.targetColorTexture.texture),ce.viewport.set([0,0,ie.width,ie.height]),ce.clear({color:r.am.transparent}),Ae&&(Ne.backgroundColorTexture.bind(de.NEAREST,de.CLAMP_TO_EDGE),se.draw(Y,de.TRIANGLES,gt.disabled,Lt.disabled,Yt.alphaBlended,Mt.disabled,oe,J.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments))}}(v,T,H),function(Y,J,re,ce){let de=Y.context,ie=de.gl,oe=re.tileFramebuffer,se=Y.transform.projection.name==="globe",Te=re.paint.get("raster-particle-max-speed");for(let me of ce){let[Ne,Ae,Ve]=me;de.activeTexture.set(ie.TEXTURE0+0),Ae.texture.bind(ie.LINEAR,ie.CLAMP_TO_EDGE),oe.colorAttachment.set(Ve.targetColorTexture.texture);let Qe=Y.getOrCreateProgram("rasterParticleDraw",{defines:Ae.defines,overrideFog:!1});de.activeTexture.set(ie.TEXTURE0+1);let Ie=Ae.scalarData?[]:[0,1,2,3].map(Se=>r.e3[Se](Ne));Ie.push(Ne);let pe=Ne.canonical.x,Pe=Ne.canonical.y;for(let Se of Ie){let He=J.getTile(se?Se.wrapped():Se);if(!He)continue;let Ge=He.rasterParticleState;if(!Ge)continue;let We=Se.canonical.x+(1<<Se.canonical.z)*(Se.wrap-Ne.wrap),ot=Se.canonical.y;Ge.particleTexture0.bind(ie.NEAREST,ie.CLAMP_TO_EDGE);let bt=xy(1,Ge.particleTexture0.size[0],[We-pe,ot-Pe],0,Ae.texture.size,2,Te,Ae.textureOffset,Ae.scale,Ae.offset);Qe.draw(Y,ie.POINTS,gt.disabled,Lt.disabled,Yt.alphaBlended,Mt.disabled,bt,re.id,Ge.particleIndexBuffer,void 0,Ge.particleSegment)}}}(v,E,T,H),A.bindFramebuffer.set(T.particleFramebuffer.framebuffer),function(Y,J,re,ce){let de=Y.context,ie=de.gl,oe=J.paint.get("raster-particle-max-speed"),se=ce*J.paint.get("raster-particle-speed-factor")*.15,Te=function(Ne){return Math.pow(Ne,6)}(.01+1*J.paint.get("raster-particle-reset-rate-factor")),me=J.particleFramebuffer;de.viewport.set([0,0,me.width,me.height]);for(let Ne of re){let[,Ae,Ve]=Ne;de.activeTexture.set(ie.TEXTURE0+0),Ae.texture.bind(ie.LINEAR,ie.CLAMP_TO_EDGE),de.activeTexture.set(ie.TEXTURE0+1);let Qe=Ve.particleTexture0;Qe.bind(ie.NEAREST,ie.CLAMP_TO_EDGE);let Ie=by(1,Qe.size[0],0,Ae.texture.size,oe,se,Te,Ae.textureOffset,Ae.scale,Ae.offset);me.colorAttachment.set(Ve.particleTexture1.texture),de.clear({color:r.am.transparent}),Y.getOrCreateProgram("rasterParticleUpdate",{defines:Ae.defines}).draw(Y,ie.TRIANGLES,gt.disabled,Lt.disabled,Yt.unblended,Mt.disabled,Ie,J.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments)}}(v,T,H,Z)}(d,t,o,h),d.renderPass==="translucent"&&(function(v,E,T,C,A){let L=v.context,R=L.gl,F=E.getSource().tileSize,V=5*(1-r.af(r.cI,r.cI+1,v.transform.zoom))*F+T.paint.get("raster-particle-elevation"),z=!v.options.moving,H=v.transform.projection.name==="globe";if(!C.length)return;let[j,Z]=v.stencilConfigForOverlap(C),Y=[];H&&Y.push("PROJECTION_GLOBE_VIEW");let J=v.stencilModeFor3D();for(let re of Z){let ce=re.toUnwrapped(),de=E.getTile(re);if(!de.rasterParticleState)continue;let ie=de.rasterParticleState,oe=100;de.registerFadeDuration(oe);let se=E.findLoadedParent(re,0),Te=no(de,se,E,v.transform,oe),me,Ne;v.terrain&&v.terrain.prepareDrawTile(),L.activeTexture.set(R.TEXTURE0),ie.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),L.activeTexture.set(R.TEXTURE1),se&&se.rasterParticleState?(se.rasterParticleState.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),me=Math.pow(2,se.tileID.overscaledZ-de.tileID.overscaledZ),Ne=[de.tileID.canonical.x*me%1,de.tileID.canonical.y*me%1]):ie.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE);let Ae=H?Float32Array.from(v.transform.expandedFarZProjMatrix):v.transform.calculateProjMatrix(ce,z),Ve=v.transform,Qe=Ma(Ve),Ie=r.dA(re.canonical),pe=r.dB(Ie.getCenter().lat),Pe,Se,He,Ge,We;H?(Pe=Float32Array.from(r.bh(r.dD(re.canonical))),Se=Float32Array.from(Ve.globeMatrix),He=Float32Array.from(r.dz(Ve)),Ge=[r.aD(Ve.center.lng),r.aH(Ve.center.lat)],We=Float32Array.from(r.dC(re.canonical,Ie,pe,Ve.worldSize/Ve._pixelsPerMercatorPixel))):(Pe=new Float32Array(16),Se=new Float32Array(9),He=new Float32Array(16),Ge=[0,0],We=new Float32Array(9));let ot=Ch(Ae,Pe,Se,He,We,Ne||[0,0],r.ah(v.transform.zoom),Ge,Qe,me||1,Te,V),bt=v.isTileAffectedByFog(re),St=v.getOrCreateProgram("rasterParticle",{defines:Y,overrideFog:bt});if(v.uploadCommonUniforms(L,St,ce),H){let ft=new gt(R.LEQUAL,gt.ReadOnly,v.depthRangeFor3D),Tt=0,wt=v.globeSharedBuffers;if(wt){let[zt,Wt,on]=wt.getGridBuffers(pe,Tt!==0);St.draw(v,R.TRIANGLES,ft,J,Yt.alphaBlended,v.renderElevatedRasterBackface?Mt.frontCCW:Mt.backCCW,ot,T.id,zt,Wt,on)}}else{let ft=v.depthModeForSublayer(0,gt.ReadOnly),Tt=j[re.overscaledZ],{tileBoundsBuffer:wt,tileBoundsIndexBuffer:zt,tileBoundsSegments:Wt}=v.getTileBoundsBuffers(de);St.draw(v,R.TRIANGLES,ft,Tt,Yt.alphaBlended,Mt.disabled,ot,T.id,wt,zt,Wt)}}v.resetStencilClippingMasks()}(d,t,o,h),d.style.map.triggerRepaint())},background:function(d,t,o,h){let g=o.paint.get("background-color"),_=o.paint.get("background-color-use-theme").constantOr("default")==="none",v=o.paint.get("background-opacity"),E=o.paint.get("background-emissive-strength"),T=o.paint.get("background-pitch-alignment")==="viewport";if(v===0)return;let C=d.context,A=C.gl,L=d.transform,R=L.tileSize,F=o.paint.get("background-pattern"),V;if(F!==void 0&&(F===null||(V=d.imageManager.getPattern(r.I.from(F.toString()),o.scope,d.style.getLut(o.scope)),!V)))return;let z=!F&&g.a===1&&v===1&&d.opaquePassEnabledForLayer()?"opaque":"translucent";if(d.renderPass!==z)return;let H=Lt.disabled,j=d.depthModeForSublayer(0,z==="opaque"?gt.ReadWrite:gt.ReadOnly),Z=d.colorModeForDrapableLayerRenderPass(E),Y=F?"backgroundPattern":"background",J,re=h;if(re||(J=d.getBackgroundTiles(),re=Object.values(J).map(ce=>ce.tileID)),F&&(C.activeTexture.set(A.TEXTURE0),d.imageManager.bind(d.context,o.scope)),T){let ce=d.getOrCreateProgram(Y,{overrideFog:!1,overrideRtt:!0}),de=new Float32Array(r.bx([])),ie=new r.aM(0,0,0,0,0),oe=F?tm(de,E,v,d,0,o.scope,V,T,{tileID:ie,tileSize:R}):wy(de,E,v,g.toPremultipliedRenderColor(_?null:o.lut));ce.draw(d,A.TRIANGLES,j,H,Z,Mt.disabled,oe,o.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments)}else for(let ce of re){let de=d.isTileAffectedByFog(ce),ie=d.getOrCreateProgram(Y,{overrideFog:de}),oe=ce.toUnwrapped(),se=h?ce.projMatrix:d.transform.calculateProjMatrix(oe);d.prepareDrawTile();let Te=t?t.getTile(ce):J?J[ce.key]:new tl(ce,R,L.zoom,d),me=F?tm(se,E,v,d,0,o.scope,V,T,{tileID:ce,tileSize:R}):wy(se,E,v,g.toPremultipliedRenderColor(_?null:o.lut));d.uploadCommonUniforms(C,ie,oe);let{tileBoundsBuffer:Ne,tileBoundsIndexBuffer:Ae,tileBoundsSegments:Ve}=d.getTileBoundsBuffers(Te);ie.draw(d,A.TRIANGLES,j,H,Z,Mt.disabled,me,o.id,Ne,Ae,Ve)}},sky:function(d,t,o){let h=d._atmosphere?r.ah(d.transform.zoom):1,g=o.paint.get("sky-opacity")*h;if(g===0)return;let _=d.context,v=o.paint.get("sky-type"),E=new gt(_.gl.LEQUAL,gt.ReadOnly,[0,1]),T=d.frameCounter/1e3%1;v==="atmosphere"?d.renderPass==="offscreen"?o.needsSkyboxCapture(d)&&(function(C,A,L,R){let F=C.context,V=F.gl,z=A.skyboxFbo;if(!z){z=A.skyboxFbo=F.createFramebuffer(32,32,!0,null),A.skyboxGeometry=new gl(F),A.skyboxTexture=F.gl.createTexture(),V.bindTexture(V.TEXTURE_CUBE_MAP,A.skyboxTexture),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_WRAP_S,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_WRAP_T,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_MIN_FILTER,V.LINEAR),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_MAG_FILTER,V.LINEAR);for(let Y=0;Y<6;++Y)V.texImage2D(V.TEXTURE_CUBE_MAP_POSITIVE_X+Y,0,V.RGBA,32,32,0,V.RGBA,V.UNSIGNED_BYTE,null)}F.bindFramebuffer.set(z.framebuffer),F.viewport.set([0,0,32,32]);let H=A.getCenter(C,!0),j=C.getOrCreateProgram("skyboxCapture"),Z=new Float64Array(16);r.bx(Z),r.eh(Z,Z,.5*-Math.PI),hs(C,A,j,Z,H,0),r.bx(Z),r.eh(Z,Z,.5*Math.PI),hs(C,A,j,Z,H,1),r.bx(Z),r.cR(Z,Z,.5*-Math.PI),hs(C,A,j,Z,H,2),r.bx(Z),r.cR(Z,Z,.5*Math.PI),hs(C,A,j,Z,H,3),r.bx(Z),hs(C,A,j,Z,H,4),r.bx(Z),r.eh(Z,Z,Math.PI),hs(C,A,j,Z,H,5),F.viewport.set([0,0,C.width,C.height])}(d,o),o.markSkyboxValid(d)):d.renderPass==="sky"&&function(C,A,L,R,F){let V=C.context,z=V.gl,H=C.transform,j=C.getOrCreateProgram("skybox");V.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_CUBE_MAP,A.skyboxTexture);let Z=((Y,J,re,ce,de)=>({u_matrix:Y,u_sun_direction:J,u_cubemap:0,u_opacity:ce,u_temporal_offset:de}))(H.skyboxMatrix,A.getCenter(C,!1),0,R,F);C.uploadCommonUniforms(V,j),j.draw(C,z.TRIANGLES,L,Lt.disabled,C.colorModeForRenderPass(),Mt.backCW,Z,"skybox",A.skyboxGeometry.vertexBuffer,A.skyboxGeometry.indexBuffer,A.skyboxGeometry.segment)}(d,o,E,g,T):v==="gradient"&&d.renderPass==="sky"&&function(C,A,L,R,F){let V=C.context,z=V.gl,H=C.transform,j=C.getOrCreateProgram("skyboxGradient");A.skyboxGeometry||(A.skyboxGeometry=new gl(V)),V.activeTexture.set(z.TEXTURE0);let Z=A.colorRampTexture;Z||(Z=A.colorRampTexture=new r.T(V,A.colorRamp,z.RGBA8)),Z.bind(z.LINEAR,z.CLAMP_TO_EDGE);let Y=((J,re,ce,de,ie)=>({u_matrix:J,u_color_ramp:0,u_center_direction:re,u_radius:r.al(ce),u_opacity:de,u_temporal_offset:ie}))(H.skyboxMatrix,A.getCenter(C,!1),A.paint.get("sky-gradient-radius"),R,F);C.uploadCommonUniforms(V,j),j.draw(C,z.TRIANGLES,L,Lt.disabled,C.colorModeForRenderPass(),Mt.backCW,Y,"skyboxGradient",A.skyboxGeometry.vertexBuffer,A.skyboxGeometry.indexBuffer,A.skyboxGeometry.segment)}(d,o,E,g,T)},custom:function(d,t,o,h){let g=d.context,_=o.implementation;if(!d.transform.projection.unsupportedLayers||!d.transform.projection.unsupportedLayers.includes("custom")||d.terrain&&(d.terrain.renderingToTexture||d.renderPass==="offscreen")&&o.isDraped(t)){if(d.renderPass==="offscreen"){let v=_.prerender;if(v){if(d.setCustomLayerDefaults(),g.setColorMode(d.colorModeForRenderPass()),d.transform.projection.name==="globe"){let E=d.transform.pointMerc;v.call(_,g.gl,d.transform.customLayerMatrix(),d.transform.getProjection(),d.transform.globeToMercatorMatrix(),r.ah(d.transform.zoom),[E.x,E.y],d.transform.pixelsPerMeterRatio)}else v.call(_,g.gl,d.transform.customLayerMatrix());g.setDirty(),d.setBaseState()}}else if(d.renderPass==="translucent"){if(d.terrain&&d.terrain.renderingToTexture){let E=_.renderToTile;if(E){let T=h[0].canonical,C={x:T.x+h[0].wrap*(_.wrapTileId?0:1<<T.z),y:T.y,z:T.z};g.setDepthMode(gt.disabled),g.setStencilMode(Lt.disabled),g.setColorMode(d.colorModeForRenderPass()),d.setCustomLayerDefaults(),E.call(_,g.gl,C),g.setDirty(),d.setBaseState()}return}d.setCustomLayerDefaults(),g.setColorMode(d.colorModeForRenderPass()),g.setStencilMode(Lt.disabled);let v=_.renderingMode==="3d"?new gt(d.context.gl.LEQUAL,gt.ReadWrite,d.depthRangeFor3D):d.depthModeForSublayer(0,gt.ReadOnly);if(g.setDepthMode(v),d.transform.projection.name==="globe"){let E=d.transform.pointMerc;_.render(g.gl,d.transform.customLayerMatrix(),d.transform.getProjection(),d.transform.globeToMercatorMatrix(),r.ah(d.transform.zoom),[E.x,E.y],d.transform.pixelsPerMeterRatio)}else _.render(g.gl,d.transform.customLayerMatrix());g.setDirty(),d.setBaseState(),g.bindFramebuffer.set(null)}}else r.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(d,t,o,h){if(d.renderPass==="opaque")return;let g=o.paint.get("model-opacity").constantOr(1);if(g===0)return;let _=o.paint.get("model-cast-shadows");if(d.renderPass==="shadow"&&(!_||d.terrain&&g<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof r.ab))return;let v=d.shadowRenderer,E=o.paint.get("model-receive-shadows");v&&(v.useNormalOffset=!0,E||(v.enabled=!1));let T=()=>{v&&(v.useNormalOffset=!0,E||(v.enabled=!0))},C=t.getSource();if(d.renderPass==="light-beam"&&C.type!=="batched-model")return;if(C.type==="vector"||C.type==="geojson")return function(j,Z,Y,J,re){let ce=j.transform;if(ce.projection.name!=="mercator")return void r.w(`Drawing 3D models for ${ce.projection.name} projection is not yet implemented`);let de=ce.getFreeCameraOptions().position;if(!j.modelManager)return;let ie=j.modelManager;Y.modelManager=ie;let oe=j.shadowRenderer;if(!Y._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let se=Y._unevaluatedLayout._values["model-id"],Te=Object.assign({},Y.layout.get("model-id").parameters),me=j.style.order.indexOf(Y.fqid);for(let Ne of J){let Ae=Z.getTile(Ne).getBucket(Y);if(!Ae||Ae.projection.name!==ce.projection.name)continue;let Ve=Ae.getModelUris();Ve&&!Ae.modelsRequested&&(ie.addModelsFromBucket(Ve,re),Ae.modelsRequested=!0);let Qe=Zb(Ne,ce);Te.zoom=Qe;let Ie=se.possiblyEvaluate(Te);if(gc(j,Ae,Ne),Ss.shadowUniformsInitialized=!1,Ss.useSingleShadowCascade=!!oe&&oe.getMaxCascadeForTile(Ne.toUnwrapped())===0,j.renderPass==="shadow"&&oe){if(j.currentShadowCascade===1&&Ae.isInsideFirstShadowMapFrustum)continue;let Se=ce.calculatePosMatrix(Ne.toUnwrapped(),ce.worldSize);if(Ss.tileMatrix.set(Se),Ss.shadowTileMatrix=Float32Array.from(oe.calculateShadowPassMatrixFromMatrix(Se)),Ss.aabb.min.fill(0),Ss.aabb.max[0]=Ss.aabb.max[1]=r.aj,Ss.aabb.max[2]=0,mm(Ae,Ss,j,Y.scope))continue}let pe=1<<Ne.canonical.z,Pe=[((de.x-Ne.wrap)*pe-Ne.canonical.x)*r.aj,(de.y*pe-Ne.canonical.y)*r.aj,de.z*pe*r.aj];j.conflationActive&&Object.keys(Ae.instancesPerModel).length>0&&j.style.isLayerClipped(Y,Z.getSource())&&Ae.updateReplacement(Ne,j.replacementSource,me,re)&&(Ae.uploaded=!1,Ae.upload(j.context));for(let Se in Ae.instancesPerModel){let He=Ae.instancesPerModel[Se];He.features.length>0&&(Se=Ie.evaluate(He.features[0].feature,{}));let Ge=ie.getModel(Se,re);if(Ge||ie.hasURLBeenRequested(Se)||Ae.modelUris.includes(Se)||(Ae.modelUris.push(Se),Ae.modelsRequested=!1),Ge&&Ge.uploaded)for(let We of Ge.nodes)pm(j,Y,We,He,Pe,Ne,Ss)}}}(d,t,o,h,C.type==="vector"?o.scope:""),void T();if(!C.loaded())return;if(C.type==="batched-model")return function(j,Z,Y,J){Y.resetLayerRenderingStats(j);let re=j.context,ce=j.transform,de=j.style.fog,ie=j.shadowRenderer;if(ce.projection.name!=="mercator")return void r.w(`Drawing 3D landmark models for ${ce.projection.name} projection is not yet implemented`);let oe=j.transform.getFreeCameraOptions().position,se=r.c1([],[oe.x,oe.y,oe.z],j.transform.worldSize),Te=r.eq([],se),me=r.bx([]),Ne=r.e9(ce.center.lat,ce.zoom),Ae=r.bn([],[1,1,1/Ne]);r.bo(me,me,Te);let Ve=Y.paint.get("model-opacity").constantOr(1),Qe=new gt(re.gl.LEQUAL,gt.ReadWrite,j.depthRangeFor3D),Ie=new gt(re.gl.LEQUAL,gt.ReadOnly,j.depthRangeFor3D),pe=new r.d6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Pe=j.renderPass==="shadow",Se=Pe&&ie?ie.getCurrentCascadeFrustum():ce.getFrustum(ce.scaleZoom(ce.worldSize)),He=Y.paint.get("model-front-cutoff"),Ge=He[2]<1,We=Ts(j,Y.paint.get("model-cutoff-fade-range")),ot=Y.getLayerRenderingStats();(function(bt,St,ft,Tt){let wt=bt.terrain?bt.terrain.exaggeration():0,zt=bt.transform.zoom;for(let Wt of Tt){let on=St.getTile(Wt).getBucket(ft);on&&(on.setFilter(ft.filter),bt.conflationActive&&on.updateReplacement(Wt,bt.replacementSource),on.evaluateTransform(bt,ft),bt.terrain&&wt>0&&on.elevationUpdate(bt.terrain,wt,Wt,ft.source),on.needsReEvaluation(bt,zt,ft)&&on.evaluate(ft))}})(j,Z,Y,J),function(){let bt,St,ft;Ge?(bt=J.length-1,St=-1,ft=-1):(bt=0,St=J.length,ft=1);let Tt=new Float64Array(16),wt=r.cx(),zt=new r.P(0,0);for(let Wt=bt;Wt!==St;Wt+=ft){let on=J[Wt],bn=Z.getTile(on).getBucket(Y);if(!bn||!bn.uploaded)continue;let Ht=!1;ie&&(Ht=ie.getMaxCascadeForTile(on.toUnwrapped())===0);let wn=ce.calculatePosMatrix(on.toUnwrapped(),ce.worldSize),Dn=bn.modelTraits;!Pe&&Ge&&(r.bi(Tt,wn),r.ad(wt,se,Tt),zt.x=wt[0],zt.y=wt[1]);let Xn=[];bn.setFilter(Y.filter);for(let tn of bn.getNodesInfo()){if(tn.hiddenByReplacement||!tn.node.meshes)continue;let En=tn.node,Tn=0;j.terrain&&En.elevation&&(Tn=En.elevation*j.terrain.exaggeration());let Mn=(()=>{let pi=tn.aabb;return pe.min=[...pi.min],pe.max=[...pi.max],pe.min[2]+=Tn,pe.max[2]+=Tn,r.ad(pe.min,pe.min,wn),r.ad(pe.max,pe.max,wn),pe})(),sn=tn.evaluatedScale;if(sn[0]<=1&&sn[1]<=1&&sn[2]<=1&&Mn.intersects(Se)===0)continue;if(!Pe&&Ge){let pi=.16666666666666666;tn.cameraCollisionOpacity=se[0]>Mn.min[0]&&se[0]<Mn.max[0]&&se[1]>Mn.min[1]&&se[1]<Mn.max[1]&&se[2]*Ne<Mn.max[2]&&En.footprint&&r.bY(zt,En.footprint)?Math.max(tn.cameraCollisionOpacity-pi,0):Math.min(1,tn.cameraCollisionOpacity+pi)}let Bn=[...wn],Cn=1/r.d4(on.canonical),yr=En.anchor?En.anchor[0]:0,vn=En.anchor?En.anchor[1]:0;r.bo(Bn,Bn,[yr*(sn[0]-1)+tn.evaluatedTranslation[0]*Cn,vn*(sn[1]-1)+tn.evaluatedTranslation[1]*Cn,Tn+tn.evaluatedTranslation[2]]),r.cn(sn,r.es)||r.cP(Bn,Bn,sn);let Rn=r.az([],Bn,En.matrix),Wn=r.az([],ce.expandedFarZProjMatrix,Rn),Gr=r.az([],ce.expandedFarZProjMatrix,Bn),Br=r.aA([],[yr,vn,Tn,1],Wn)[2];En.hidden=!1;let Wr=Ve;Pe||(Ge&&(Wr*=tn.cameraCollisionOpacity,Wr*=Ly(Bn,ce,tn.aabb,He)),Wr*=Oy(We,Br)),Wr!==0?Xn.push({nodeInfo:tn,depth:Br,opacity:Wr,wvpForNode:Wn,wvpForTile:Gr,nodeModelMatrix:Rn,tileModelMatrix:Bn}):En.hidden=!0}Pe||Xn.sort((tn,En)=>!Ge||tn.opacity===1&&En.opacity===1?tn.depth<En.depth?-1:1:tn.opacity===1?-1:En.opacity===1?1:tn.depth>En.depth?-1:1);for(let tn of Xn){let En=tn.nodeInfo,Tn=En.node,Mn=r.az([],Ae,tn.tileModelMatrix);r.az(Mn,me,Mn);let sn=r.bi([],Mn);r.ea(sn,sn),r.cP(sn,sn,zh),Mn=r.az(Mn,Mn,Tn.matrix);let Bn=j.renderPass==="light-beam",Cn=Y.paint.get("model-color-use-theme").constantOr("default")==="none",yr=Dn&r.ex.HasMapboxMeshFeatures,vn=yr?0:En.evaluatedRMEA[0][2];for(let Rn=0;Rn<Tn.meshes.length;++Rn){let Wn=Tn.meshes[Rn],Gr=Rn===Tn.lightMeshIndex,Br=tn.wvpForNode;if(Gr){if(!Bn&&!j.terrain&&j.shadowRenderer){j.currentLayer<j.firstLightBeamLayer&&(j.firstLightBeamLayer=j.currentLayer);continue}Br=tn.wvpForTile}else if(Bn)continue;let Wr={defines:[]},pi=[];if(!Pe&&ie&&(ie.useNormalOffset=!!Wn.normalBuffer),qu(Wr.defines,pi,Wn,j,Cn?null:Y.lut),yr||Wr.defines.push("DIFFUSE_SHADED"),Ht&&Wr.defines.push("SHADOWS_SINGLE_CASCADE"),ot&&(Pe?ot.numRenderedVerticesInShadowPass+=Wn.vertexArray.length:ot.numRenderedVerticesInTransparentPass+=Wn.vertexArray.length),Pe){Nh(Wn,tn.nodeModelMatrix,j,Y);continue}let fs=null;if(de){let Ii=Zu(tn.nodeModelMatrix,j.transform);if(fs=new Float32Array(Ii),ce.projection.name!=="globe"){let Or=Wn.aabb.min,Dr=Wn.aabb.max,[Jn,ei]=de.getOpacityForBounds(Ii,Or[0],Or[1],Dr[0],Dr[1]);Wr.overrideFog=Jn>=je||ei>=je}}let Hi=Wn.material,go;Hi.occlusionTexture&&Hi.occlusionTexture.offsetScale&&(go=Hi.occlusionTexture.offsetScale,Wr.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let Ti=j.getOrCreateProgram("model",Wr);!Pe&&ie&&ie.setupShadowsFromMatrix(tn.tileModelMatrix,Ti,ie.useNormalOffset),j.uploadCommonUniforms(re,Ti,null,fs);let Lo=Hi.pbrMetallicRoughness;Lo.metallicFactor=.9,Lo.roughnessFactor=.5;let ns=nm(new Float32Array(Br),new Float32Array(Mn),new Float32Array(sn),new Float32Array(Tn.matrix),j,tn.opacity,Lo.baseColorFactor,Hi.emissiveFactor,Lo.metallicFactor,Lo.roughnessFactor,Hi,vn,Y,[0,0,0],go);!Gr&&(En.hasTranslucentParts||tn.opacity<1)&&Ti.draw(j,re.gl.TRIANGLES,Qe,Lt.disabled,Yt.disabled,Mt.backCCW,ns,Y.id,Wn.vertexBuffer,Wn.indexBuffer,Wn.segments,Y.paint,j.transform.zoom,void 0,pi),Ti.draw(j,re.gl.TRIANGLES,Gr?Ie:Qe,Lt.disabled,Gr||tn.opacity<1||En.hasTranslucentParts?Yt.alphaBlended:Yt.unblended,Mt.backCCW,ns,Y.id,Wn.vertexBuffer,Wn.indexBuffer,Wn.segments,Y.paint,j.transform.zoom,void 0,pi)}}}}()}(d,t,o,h),void T();if(C.type!=="model")return;let A=C.getModels(),L=[],R=d.transform.getFreeCameraOptions().position,F=r.c1([],[R.x,R.y,R.z],d.transform.worldSize);r.eq(F,F);let V=[],z=[],H=0;for(let j of A){let Z=o.paint.get("model-rotation").constantOr(null),Y=o.paint.get("model-scale").constantOr(null),J=o.paint.get("model-translation").constantOr(null);j.computeModelMatrix(d,Z,Y,J,!0,!0,!1);let re=r.bx([]),ce=r.e9(j.position.lat,d.transform.zoom),de=r.bn([],[1,1,1/ce]);r.bo(re,re,F),L.push({zScaleMatrix:de,negCameraPosMatrix:re});for(let ie of j.nodes)fm(d.transform,ie,j.matrix,d.transform.expandedFarZProjMatrix,H,V,z);H++}if(V.sort((j,Z)=>Z.depth-j.depth),d.renderPass!=="shadow"){if(g===1)for(let j of z)mc(j,d,o,L[j.modelIndex],Lt.disabled,d.colorModeForRenderPass());else{for(let j of z)mc(j,d,o,L[j.modelIndex],Lt.disabled,Yt.disabled);for(let j of z)mc(j,d,o,L[j.modelIndex],d.stencilModeFor3D(),d.colorModeForRenderPass());d.resetStencilClippingMasks()}for(let j of V)mc(j,d,o,L[j.modelIndex],Lt.disabled,d.colorModeForRenderPass());T()}else{for(let j of z)Nh(j.mesh,j.nodeModelMatrix,d,o);for(let j of V)Nh(j.mesh,j.nodeModelMatrix,d,o);T()}}},Vh={line:function(d,t,o){if(d.hasElevatedBuckets=!1,d.hasNonElevatedBuckets=!1,d._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||d._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){let h=t.getVisibleCoordinates();for(let g of h){let _=t.getTile(g).getBucket(d);if(_&&(_.elevationType!=="none"?d.hasElevatedBuckets=!0:d.hasNonElevatedBuckets=!0,d.hasElevatedBuckets&&d.hasNonElevatedBuckets))break}}}else d.hasNonElevatedBuckets=!0},model:function(d,t,o){let h=t.getSource();if(!h.loaded())return;if(h.type==="vector"||h.type==="geojson")return void(o.modelManager&&o.modelManager.upload(o,h.type==="vector"?d.scope:""));if(h.type==="batched-model"||h.type!=="model")return;let g=h.getModels();for(let _ of g)_.upload(o.context)},raster:function(d,t,o){let h=t.getSource();if(!(h instanceof ga&&h.loaded()))return;let g=d.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!g)return;let _=d.paint.get("raster-array-band")||h.getInitialBand(g);if(_==null)return;let v=t.getIds().map(E=>t.getTileByID(E));for(let E of v)E.updateNeeded(d.id,_)&&h.prepareTile(E,g,d.id,_)},"raster-particle":function(d,t,o){let h=t.getSource();if(!(h instanceof ga&&h.loaded()))return;let g=d.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!g)return;let _=d.paint.get("raster-particle-array-band")||h.getInitialBand(g);if(_==null)return;let v=t.getIds().map(E=>t.getTileByID(E));for(let E of v)E.updateNeeded(d.id,_)&&h.prepareTile(E,g,d.id,_)}},Uh={fill:_t},Ro={fill:function(d,t,o,h){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let g=d.context.gl,_=new gt(g.LEQUAL,gt.ReadOnly,d.depthRangeFor3D),v=new Lt({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),E=d.transform.getFreeCameraOptions().position,T=d.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(let C of h){let A=t.getTile(C),L=A.getBucket(o);if(!L)continue;let R=L.elevatedStructures;if(!R||R.depthSegments.segments[0].primitiveLength===0)continue;let F=Hu(C.toUnwrapped(),E),V=d.translatePosMatrix(C.projMatrix,A,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),z=Sh(V,F,0,1,0);T.draw(d,g.TRIANGLES,_,v,Yt.disabled,Mt.disabled,z,o.id,R.vertexBuffer,R.indexBuffer,R.depthSegments,o.paint,d.transform.zoom)}}};class Pa{constructor(t,o,h,g,_,v){this.context=new Rh(t,o),this.transform=h,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=_,this._timeStamp=r.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let E=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(let C of E)this._debugParams.enabledLayers[C]=!0;_.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),_.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),_.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),_.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let C of E)_.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],C);this.occlusionParams=new _c(_),this.setup(),this.numSublayers=eo.maxUnderzooming+eo.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new r.eE,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Cb(this),this._wireframeDebugCache=new Xu,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let T=new r.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new r.T(this.context,T,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=g,this.worldview=v}updateTerrain(t,o){let h=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(h||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new wh(this,t));let g=this._terrain;this.transform.elevation=h?g:null,g.update(t,this.transform,o),this.transform.elevation&&!g.enabled&&(this.transform.elevation=null)}_updateFog(t){let o=t.fog;if(!o||this.transform.projection.name==="globe"||o.getOpacity(this.transform.pitch)<1||o.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[h,g]=o.getFovAdjustedRange(this.transform._fov);if(h>g)return void(this.transform.fogCullDistSq=null);let _=h+.78*(g-h);this.transform.fogCullDistSq=_*_}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new wh(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,o){if(this.width=t*r.q.devicePixelRatio,this.height=o*r.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let h of this.style.order)this.style._mergedLayers[h].resize()}setup(){let t=this.context,o=new r.ba;o.emplaceBack(0,0),o.emplaceBack(r.aj,0),o.emplaceBack(0,r.aj),o.emplaceBack(r.aj,r.aj),this.tileExtentBuffer=t.createVertexBuffer(o,r.bc.members),this.tileExtentSegments=r.bd.simpleSegment(0,0,4,2);let h=new r.ba;h.emplaceBack(0,0),h.emplaceBack(r.aj,0),h.emplaceBack(0,r.aj),h.emplaceBack(r.aj,r.aj),this.debugBuffer=t.createVertexBuffer(h,r.bc.members),this.debugSegments=r.bd.simpleSegment(0,0,4,5);let g=new r.ba;g.emplaceBack(-1,-1),g.emplaceBack(1,-1),g.emplaceBack(-1,1),g.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(g,r.bc.members),this.viewportSegments=r.bd.simpleSegment(0,0,4,2);let _=new r.aZ;_.emplaceBack(0,0,0,0),_.emplaceBack(r.aj,0,r.aj,0),_.emplaceBack(0,r.aj,0,r.aj),_.emplaceBack(r.aj,r.aj,r.aj,r.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(_,r.bf.members),this.mercatorBoundsSegments=r.bd.simpleSegment(0,0,4,2);let v=new r.a_;v.emplaceBack(0,1,2),v.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(v);let E=new r.bb;for(let C of[0,1,3,2,0])E.emplaceBack(C);this.debugIndexBuffer=t.createIndexBuffer(E),this.emptyTexture=new r.T(t,new r.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=r.bz();let T=this.context.gl;this.stencilClearMode=new Lt({func:T.ALWAYS,mask:0},0,255,T.ZERO,T.ZERO,T.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,gt.disabled,this.stencilClearMode,Yt.disabled,Mt.disabled,xh(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,o,h){if(!o||this.currentStencilSource===o.id||!t.isTileClipped()||!h||h.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let E=!1;for(let T of h)if(this._tileClippingMaskIDs[T.key]===void 0){E=!0;break}if(!E)return}this.currentStencilSource=o.id;let g=this.context,_=g.gl;this.nextStencilID+h.length>256&&this.clearStencil(),g.setColorMode(Yt.disabled),g.setDepthMode(gt.disabled);let v=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let E of h){let T=o.getTile(E),C=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,{tileBoundsBuffer:A,tileBoundsIndexBuffer:L,tileBoundsSegments:R}=this.getTileBoundsBuffers(T);v.draw(this,_.TRIANGLES,gt.disabled,new Lt({func:_.ALWAYS,mask:0},C,255,_.KEEP,_.KEEP,_.REPLACE),Yt.disabled,Mt.disabled,xh(E.projMatrix),"$clipping",A,L,R)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let t=this.nextStencilID++,o=this.context.gl;return new Lt({func:o.NOTEQUAL,mask:255},t,255,o.KEEP,o.KEEP,o.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);let o=this.context.gl;return new Lt({func:o.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,o.KEEP,o.KEEP,o.REPLACE)}stencilConfigForOverlap(t){let o=this.context.gl,h=t.sort((v,E)=>E.overscaledZ-v.overscaledZ),g=h[h.length-1].overscaledZ,_=h[0].overscaledZ-g+1;if(_>1){this.currentStencilSource=void 0,this.nextStencilID+_>256&&this.clearStencil();let v={};for(let E=0;E<_;E++)v[E+g]=new Lt({func:o.GEQUAL,mask:255},E+this.nextStencilID,255,o.KEEP,o.KEEP,o.REPLACE);return this.nextStencilID+=_,[v,h]}return[{[g]:Lt.disabled},h]}colorModeForRenderPass(){let t=this.context.gl;return this._showOverdrawInspector?new Yt([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new r.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Yt.unblended:Yt.alphaBlended}colorModeForDrapableLayerRenderPass(t){let o=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new Yt([o.ONE,o.ONE_MINUS_SRC_ALPHA,o.CONSTANT_ALPHA,o.ONE_MINUS_SRC_ALPHA],new r.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,o,h,g=!1){if(this.depthOcclusion)return new gt(this.context.gl.GREATER,gt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!g)return gt.disabled;let _=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new gt(h||this.context.gl.LEQUAL,o,[_,_])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let t=this.context.gl,o=Math.ceil(this.width),h=Math.ceil(this.height),g=this.context.bindFramebuffer.get(),_=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===o&&this.depthFBO.height===h||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),o!==0&&h!==0&&(this.depthFBO=new pl(this.context,o,h,!1,"texture"),this.depthTexture=new r.T(this.context,{width:o,height:h,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(g),t.bindTexture(t.TEXTURE_2D,_),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,o,h,0,0,o,h,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,o)=>t+o/this._fpsHistory.length,0))}render(t,o){let h=r.q.now();this._dt=h-this._timeStamp,this._timeStamp=h,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=o;let g=this.style._mergedLayers,_=!(!this.terrain||!this.terrain.enabled),v=()=>this.style._getOrder(_).filter(Ie=>{let pe=g[Ie];return!(pe.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[pe.type]}),E=v(),T=!1,C=!1,A=null;for(let Ie of E){let pe=g[Ie];pe.type==="circle"?T=!0:pe.type==="building"?A=pe:pe.type==="symbol"&&(pe.hasInitialOcclusionOpacityProperties?C=!0:T=!0)}let L=E.map(Ie=>g[Ie]),R=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(r.q.now()),this.imageManager.beginFrame();let F=0,V=!1;for(let Ie in R){let pe=R[Ie];pe.used&&(pe.prepare(this.context),pe.getSource().usedInConflation&&++F)}let z=!1;for(let Ie of L)Ie.isHidden(this.transform.zoom)||(Ie.type==="clip"&&(z=!0),this.prepareLayer(Ie));let H={},j={},Z={},Y={},J={};for(let Ie in R){let pe=R[Ie];H[Ie]=pe.getVisibleCoordinates(),j[Ie]=H[Ie].slice().reverse(),Z[Ie]=pe.getVisibleCoordinates(!0).reverse(),Y[Ie]=pe.getShadowCasterCoordinates(),J[Ie]=pe.sortCoordinatesByDistance(H[Ie])}let re=Ie=>{let pe=this.style.getLayerSourceCache(Ie);return pe&&pe.used?pe.getSource():null};if(F||z||this._clippingActiveLastFrame){let Ie=[],pe=[],Pe=0;for(let Se of L)this.isSourceForClippingOrConflation(Se,re(Se))&&(Ie.push(Se),pe.push(Pe)),Pe++;if(Ie&&(z||Ie.length>1)||this._clippingActiveLastFrame){z=!1;let Se=[];for(let He=0;He<Ie.length;He++){let Ge=Ie[He],We=pe[He],ot=this.style.getLayerSourceCache(Ge);if(!ot||!ot.used||!ot.getSource().usedInConflation&&Ge.type!=="clip"&&Ge.type!=="building")continue;let bt=r.eF,St=r.bW.None,ft=[],Tt=!0;if(Ge.type==="building")bt=r.eH;else if(Ge.type==="clip"){bt=We;for(let wt of Ge.layout.get("clip-layer-types"))St|=wt==="model"?r.bW.Model:wt==="symbol"?r.bW.Symbol:r.bW.FillExtrusion;for(let wt of Ge.layout.get("clip-layer-scope"))ft.push(wt);Ge.isHidden(this.transform.zoom)?Tt=!1:z=!0}Tt&&Se.push({layer:Ge.fqid,cache:ot,order:bt,clipMask:St,clipScope:ft})}this.replacementSource.setSources(Se),V=!0}}this._clippingActiveLastFrame=z,V||this.replacementSource.clear(),this.conflationActive=V,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Ie=0;Ie<L.length;Ie++){let pe=L[Ie],Pe=pe.cutoffRange();if(this.longestCutoffRange=Math.max(Pe,this.longestCutoffRange),Pe>0){let Se=re(pe);Se&&(this.minCutoffZoom=Math.max(Se.minzoom,this.minCutoffZoom)),pe.minzoom&&(this.minCutoffZoom=Math.max(pe.minzoom,this.minCutoffZoom))}pe.is3D(_)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Ie),this._lastOcclusionLayer=Ie)}let ce=this.style&&this.style.fog;ce?(this._fogVisible=ce.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=ce.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Z),this.opaquePassCutoff=0,E=v(),L=E.map(Ie=>g[Ie]));let de=this._shadowRenderer;if(de){de.updateShadowParameters(this.transform,this.style.directionalLight);for(let Ie in R)for(let pe of H[Ie]){let Pe={min:0,max:0};this.terrain&&(Pe=this.terrain.getMinMaxForTile(pe)||Pe),de.addShadowReceiver(pe.toUnwrapped(),Pe.min,Pe.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new r.eG(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new xe(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let ie=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),oe=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(ie&&!this._snow&&(this._snow=new _m(this)),!ie&&this._snow&&(this._snow.destroy(),delete this._snow),oe&&!this._rain&&(this._rain=new vc(this)),!oe&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),A){this.buildingTileBorderManager||(this.buildingTileBorderManager=new Py);let Ie=this.style.getLayerSourceCache(A);this.buildingTileBorderManager.updateBorders(Ie,A)}if(!ua.has(this.context.gl))return;this.renderPass="offscreen";for(let Ie of L){let pe=t.getLayerSourceCache(Ie);if(!Ie.hasOffscreenPass()||Ie.isHidden(this.transform.zoom))continue;let Pe=pe?j[pe.id]:void 0;(Ie.type==="custom"||Ie.type==="raster"||Ie.type==="raster-particle"||Ie.isSky()||Pe&&Pe.length)&&this.renderLayer(this,pe,Ie,Pe)}this.depthRangeFor3D=[0,1-(L.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Y)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let se=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Te=(()=>{if(o.showOverdrawInspector)return r.am.black;let Ie=this.style.fog;if(Ie&&this.transform.projection.supportsFog){let pe=this.style.getLut(Ie.scope);if(!se){let Pe=Ie.properties.get("color-use-theme")==="none",Se=Ie.properties.get("color").toNonPremultipliedRenderColor(Pe?null:pe).toArray01();return new r.am(...Se)}if(se){let Pe=Ie.properties.get("space-color-use-theme")==="none",Se=Ie.properties.get("space-color").toNonPremultipliedRenderColor(Pe?null:pe).toArray01();return new r.am(...Se)}}return r.am.transparent})();if(this.context.clear({color:Te,depth:1}),this.clearStencil(),this._showOverdrawInspector=o.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&se&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=E.length-1;this.currentLayer>=0;this.currentLayer--){let Ie=L[this.currentLayer],pe=t.getLayerSourceCache(Ie);if(Ie.isSky())continue;let Pe=pe?(Ie.is3D(_)?J:j)[pe.id]:void 0;this._renderTileClippingMasks(Ie,pe,Pe),this.renderLayer(this,pe,Ie,Pe)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&se&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||r.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<E.length;this.currentLayer++){let Ie=L[this.currentLayer],pe=t.getLayerSourceCache(Ie);Ie.isSky()&&this.renderLayer(this,pe,Ie,pe?j[pe.id]:void 0)}function me(Ie,pe){let Pe;return pe&&(Pe=(Ie.type==="symbol"?Z:Ie.is3D(_)?J:j)[pe.id]),Pe}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<E.length;){let Ie=L[this.currentLayer];if(Ie.type==="raster"||Ie.type==="raster-particle"){let pe=t.getLayerSourceCache(Ie);this.renderLayer(this,pe,Ie,me(Ie,pe))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ne=0;de&&(Ne=de.getShadowCastingLayerCount());let Ae=!1,Ve=-1;for(let Ie=0;Ie<E.length;++Ie){let pe=L[Ie];pe.isHidden(this.transform.zoom)||pe.is3D(_)&&(Ve=Ie)}C&&Ve===-1&&(T=!0);let Qe=!1;for(;this.currentLayer<E.length;){let Ie=L[this.currentLayer],pe=t.getLayerSourceCache(Ie);if(Ie.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Ie)){if(Ie.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Qe&&Ie.is3D(_)&&!_){let Pe=this.currentLayer,Se=He=>{for(this.currentLayer=0;this.currentLayer<L.length;this.currentLayer++){let Ge=L[this.currentLayer];if(Uh[Ge.type]){let We=this.style.getLayerSourceCache(Ge);Uh[Ge.type](this,We,Ge,me(Ge,We),He)}}};Se("initialize"),Se("reset"),this.currentLayer=Pe,Qe=!0}if(T&&!Ae&&this.terrain&&!this.transform.isOrthographic&&(Ae=!0,this.blitDepth()),C&&Ve!==-1&&this.currentLayer===Ve+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Ie,pe,pe?H[pe.id]:void 0),this.renderLayer(this,pe,Ie,me(Ie,pe)),!this.terrain&&de&&Ne>0&&Ie.hasShadowPass()&&--Ne==0){{this.clearStencil(),this.resetStencilClippingMasks();let Pe=this.currentLayer;for(this.currentLayer=0;this.currentLayer<L.length;this.currentLayer++){let Se=L[this.currentLayer];if(Ro[Se.type]){let He=this.style.getLayerSourceCache(Se);Ro[Se.type](this,He,Se,me(Se,He))}}this.currentLayer=Pe}if(de.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){let Pe=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Pe;this.currentLayer++){let Se=L[this.currentLayer];if(!Se.hasLightBeamPass())continue;let He=t.getLayerSourceCache(Se);this.renderLayer(this,He,Se,He?j[He.id]:void 0)}this.currentLayer=Pe,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let Pe=this.currentLayer;this.depthOcclusion=!0;for(let Se of this.layersWithOcclusionOpacity){this.currentLayer=Se;let He=L[this.currentLayer],Ge=t.getLayerSourceCache(He),We=Ge?j[Ge.id]:void 0;this.terrain||this._renderTileClippingMasks(He,Ge,Ge?H[Ge.id]:void 0),this.renderLayer(this,Ge,He,We)}this.depthOcclusion=!1,this.currentLayer=Pe,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Ie=null;L.forEach(pe=>{let Pe=t.getLayerSourceCache(pe);Pe&&!pe.isHidden(this.transform.zoom)&&Pe.getVisibleCoordinates().length&&(!Ie||Ie.getSource().maxzoom<Pe.getSource().maxzoom)&&(Ie=Pe)}),Ie&&this.options.showTileBoundaries&&Is(this,Ie,Ie.getVisibleCoordinates(),r.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Is(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new r.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Ie){let pe=Ie.transform.padding;$u(Ie,Ie.transform.height-(pe.top||0),3,Cy),$u(Ie,pe.bottom||0,3,um),kh(Ie,pe.left||0,3,dm),kh(Ie,Ie.transform.width-(pe.right||0),3,hm);let Pe=Ie.transform.centerPoint;(function(Se,He,Ge,We){Wu(Se,He-1,Ge-10,2,20,We),Wu(Se,He-10,Ge-1,20,2,We)})(Ie,Pe.x,Ie.transform.height-Pe.y,Ay)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),V||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);let{unsupportedLayers:o}=this.transform.projection,h=!o||!o.includes(t.type);if(Vh[t.type]&&(h||this.terrain&&t.type==="custom")){let g=this.style.getLayerSourceCache(t);Vh[t.type](t,g,this)}this.gpuTimingEnd()}renderLayer(t,o,h,g){h.isHidden(this.transform.zoom)||(h.type==="background"||h.type==="sky"||h.type==="custom"||h.type==="model"||h.type==="raster"||h.type==="raster-particle"||g&&g.length)&&(this.id=h.id,this.gpuTimingStart(h),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(h.type)&&(!t.terrain||h.type!=="custom")||h.type==="clip"||ym[h.type](t,o,h,g,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;let o=this.context.extTimerQuery,h=this.context.gl,g=this.gpuTimers[t.id];g||(g=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:h.createQuery()}),g.calls++,h.beginQuery(o.TIME_ELAPSED_EXT,g.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let t=this.context.extTimerQuery,o=this.context.gl,h=o.createQuery();this.deferredRenderGpuTimeQueries.push(h),o.beginQuery(t.TIME_ELAPSED_EXT,h)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){let t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){let o={};for(let h in t){let g=t[h],_=this.context.extTimerQuery,v=_.getQueryParameter(g.query,this.context.gl.QUERY_RESULT)/1e6;_.deleteQueryEXT(g.query),o[h]=v}return o}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;let o=this.context.gl,h=0;for(let g of t)h+=o.getQueryParameter(g,o.QUERY_RESULT)/1e6,o.deleteQuery(g);return h}translatePosMatrix(t,o,h,g,_){if(!h[0]&&!h[1])return t;let v=_?g==="map"?this.transform.angle:0:g==="viewport"?-this.transform.angle:0;if(v){let C=Math.sin(v),A=Math.cos(v);h=[h[0]*A-h[1]*C,h[0]*C+h[1]*A]}let E=[_?h[0]:r.aw(o,h[0],this.transform.zoom),_?h[1]:r.aw(o,h[1],this.transform.zoom),0],T=new Float32Array(16);return r.bo(T,t,E),T}saveTileTexture(t){if(t.context!==this.context)return;let o=t.size[0],h=this._tileTextures[o];h?h.push(t):this._tileTextures[o]=[t]}getTileTexture(t){let o=this._tileTextures[t];return o&&o.length>0?o.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,o,h){let g=h===void 0?this.terrain&&this.terrain.renderingToTexture:h,_=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(_.push("LIGHTING_3D_MODE"),_.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):g||_.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||_.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(_.push("TERRAIN"),this.linearFloatFilteringSupported()&&_.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&_.push("GLOBE"),!this._fogVisible||g||o!==void 0&&!o||_.push("FOG","FOG_DITHERING"),g&&_.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&_.push("OVERDRAW_INSPECTOR"),_}getOrCreateProgram(t,o){this.cache=this.cache||{};let h=o&&o.defines||[],g=o&&o.config,_=this.currentGlobalDefines(t,o&&o.overrideFog,o&&o.overrideRtt).concat(h),v=Th.cacheKey(zu[t],t,_,g);return this.cache[v]||(this.cache[v]=new Th(this.context,t,zu[t],g,Ty[t],_)),this.cache[v]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new r.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,o){if(this.style.enable3dLights()){let h=this.style.directionalLight,g=this.style.ambientLight;if(h&&g){let _=((v,E,T)=>{let C=v.properties.get("direction"),A=v.properties.get("color-use-theme")==="none",L=v.properties.get("color").toNonPremultipliedRenderColor(A?null:T.getLut(v.scope)).toArray01(),R=v.properties.get("intensity"),F=E.properties.get("color-use-theme")==="none",V=E.properties.get("color").toNonPremultipliedRenderColor(F?null:T.getLut(E.scope)).toArray01(),z=E.properties.get("intensity"),H=[C.x,C.y,C.z],j=r.dI(V,z),Z=r.dI(L,R);return{u_lighting_ambient_color:j,u_lighting_directional_dir:H,u_lighting_directional_color:Z,u_ground_radiance:Zp(H,Z,j)}})(h,g,this.style);o.setLightsUniformValues(t,_)}}}uploadCommonUniforms(t,o,h,g,_){if(this.uploadCommonLightUniforms(t,o),this.terrain&&this.terrain.renderingToTexture)return;let v=this.style.fog;if(v){let E=v.getOpacity(this.transform.pitch),T=((C,A,L,R,F,V,z,H,j,Z,Y,J)=>{let re=C.transform,ce=A.properties.get("color-use-theme")==="none",de=A.properties.get("color").toNonPremultipliedRenderColor(ce?null:C.style.getLut(A.scope)).toArray01();de[3]=R;let ie=C.frameCounter/1e3%1,[oe,se]=A.properties.get("vertical-range");return{u_fog_matrix:L?re.calculateFogTileMatrix(L):J||C.identityMat,u_fog_range:A.getFovAdjustedRange(re._fov),u_fog_color:de,u_fog_horizon_blend:A.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(oe,se),se],u_fog_temporal_offset:ie,u_frustum_tl:F,u_frustum_tr:V,u_frustum_br:z,u_frustum_bl:H,u_globe_pos:j,u_globe_radius:Z,u_viewport:Y,u_globe_transition:r.ah(re.zoom),u_is_globe:+(re.projection.name==="globe")}})(this,v,h,E,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*r.q.devicePixelRatio,this.transform.height*r.q.devicePixelRatio],g);o.setFogUniformValues(t,T)}_&&o.setCutoffUniformValues(t,_.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){let t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){let t=this.context.gl,o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),o}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let t=this._backgroundTiles,o=this._backgroundTiles={},h=this.transform.coveringTiles({tileSize:512});for(let g of h)o[g.key]=t[g.key]||new tl(g,512,this.transform.tileZoom,this,void 0,this.worldview);return o}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,o){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!o||o.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let o=this._cachedTileFogOpacities[t.key];return o||(this._cachedTileFogOpacities[t.key]=o=this.style.fog.getOpacityForTile(t)),o[0]>=je||o[1]>=je}setupDepthForOcclusion(t,o,h){let g=this.context,_=g.gl,v=!!h;var E;h||(h={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),g.activeTexture.set(_.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),h.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],h.u_depth_range_unpack=[2/((E=this.depthRangeFor3D)[1]-E[0]),-1-2*E[0]/(E[1]-E[0])],h.u_occluder_half_size=.5*this.occlusionParams.occluderSize,h.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),g.activeTexture.set(_.TEXTURE0),v||o.setTerrainUniformValues(g,h)}}function xc(d,t){let o=!1,h=null,g=()=>{h=null,o&&(d(),h=setTimeout(g,t),o=!1)};return()=>(o=!0,h||g(),h)}class jh{constructor(t){this._hashName=t&&encodeURIComponent(t),r.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=xc(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let t=this._map;if(!t)return"";let o=Hh(t);if(this._hashName){let h=this._hashName,g=!1,_=location.hash.slice(1).split("&").map(v=>{let E=v.split("=")[0];return E===h?(g=!0,`${E}=${o}`):v}).filter(v=>v);return g||_.push(`${h}=${o}`),`#${_.join("&")}`}return`#${o}`}_getCurrentHash(){let t=location.hash.replace("#","");if(this._hashName){let o;return t.split("&").map(h=>h.split("=")).forEach(h=>{h[0]===this._hashName&&(o=h)}),(o&&o[1]||"").split("/")}return t.split("/")}_onHashChange(){let t=this._map;if(!t)return!1;let o=this._getCurrentHash();if(o.length>=3&&!o.some(h=>isNaN(Number(h)))){let h=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(o[3]||0):t.getBearing();return t.jumpTo({center:[+o[2],+o[1]],zoom:+o[0],bearing:h,pitch:+(o[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Hh(d,t){let o=d.getCenter(),h=Math.round(100*d.getZoom())/100,g=Math.ceil((h*Math.LN2+Math.log(512/360/.5))/Math.LN10),_=Math.pow(10,g),v=Math.round(o.lng*_)/_,E=Math.round(o.lat*_)/_,T=d.getBearing(),C=d.getPitch(),A=t?`/${v}/${E}/${h}`:`${h}/${E}/${v}`;return(T||C)&&(A+="/"+Math.round(10*T)/10),C&&(A+=`/${Math.round(C)}`),A}let bc={linearity:.3,easing:r.eI(0,0,.3,1)},Oa=r.h({deceleration:2500,maxSpeed:1400},bc),vm=r.h({deceleration:20,maxSpeed:1400},bc),Ds=r.h({deceleration:1e3,maxSpeed:360},bc),xm=r.h({deceleration:1e3,maxSpeed:90},bc);class Gh{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:r.q.now(),settings:t})}_drainInertiaBuffer(){let t=this._inertiaBuffer,o=r.q.now();for(;t.length>0&&o-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let o={zoom:0,bearing:0,pitch:0,pan:new r.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:_}of this._inertiaBuffer)o.zoom+=_.zoomDelta||0,o.bearing+=_.bearingDelta||0,o.pitch+=_.pitchDelta||0,_.panDelta&&o.pan._add(_.panDelta),_.around&&(o.around=_.around),_.pinchAround&&(o.pinchAround=_.pinchAround);let h=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(o.pan.mag()){let _=Ec(o.pan.mag(),h,r.h({},Oa,t||{}));g.offset=o.pan.mult(_.amount/o.pan.mag()),g.center=this._map.transform.center,wc(g,_)}if(o.zoom){let _=Ec(o.zoom,h,vm);g.zoom=this._map.transform.zoom+_.amount,wc(g,_)}if(o.bearing){let _=Ec(o.bearing,h,Ds);g.bearing=this._map.transform.bearing+r.ay(_.amount,-179,179),wc(g,_)}if(o.pitch){let _=Ec(o.pitch,h,xm);g.pitch=this._map.transform.pitch+_.amount,wc(g,_)}if(g.zoom||g.bearing){let _=o.pinchAround===void 0?o.around:o.pinchAround;g.around=_?this._map.unproject(_):this._map.getCenter()}return this.clear(),g.noMoveStart=!0,g}}function wc(d,t){(!d.duration||d.duration<t.duration)&&(d.duration=t.duration,d.easing=t.easing)}function Ec(d,t,o){let{maxSpeed:h,linearity:g,deceleration:_}=o,v=r.ay(d*g/(t/1e3),-h,h),E=Math.abs(v)/(_*g);return{easing:o.easing,duration:1e3*E,amount:v*(E/2)}}class dr extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h,g={}){let _=wo(o.getCanvasContainer(),h),v=o.unproject(_);super(t,r.h({point:_,lngLat:v,originalEvent:h},g)),this._defaultPrevented=!1,this.target=o}}class Tc extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h){let g=t==="touchend"?h.changedTouches:h.touches,_=ws(o.getCanvasContainer(),g),v=_.map(T=>o.unproject(T)),E=_.reduce((T,C,A,L)=>T.add(C.div(L.length)),new r.P(0,0));super(t,{points:_,point:E,lngLats:v,lngLat:o.unproject(E),originalEvent:h}),this._defaultPrevented=!1}}class bm extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o){super("wheel",{originalEvent:o}),this._defaultPrevented=!1}}class wm{constructor(t,o){this._map=t,this._clickTolerance=o.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new bm(this._map,t))}mousedown(t,o){return this._mousedownPos=o,this._firePreventable(new dr(t.type,this._map,t))}mouseup(t){this._map.fire(new dr(t.type,this._map,t))}preclick(t){let o=r.h({},t);o.type="preclick",this._map.fire(new dr(o.type,this._map,o))}click(t,o){this._mousedownPos&&this._mousedownPos.dist(o)>=this._clickTolerance||(this.preclick(t),this._map.fire(new dr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new dr(t.type,this._map,t))}mouseover(t){this._map.fire(new dr(t.type,this._map,t))}mouseout(t){this._map.fire(new dr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Tc(t.type,this._map,t))}touchmove(t){this._map.fire(new Tc(t.type,this._map,t))}touchend(t){this._map.fire(new Tc(t.type,this._map,t))}touchcancel(t){this._map.fire(new Tc(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class yl{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new dr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new dr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new dr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Em{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=o.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,o){this.isEnabled()&&t.shiftKey&&t.button===0&&(li(),this._startPos=this._lastPos=o,this._active=!0)}mousemoveWindow(t,o){if(!this._active)return;let h=o,g=this._startPos,_=this._lastPos;if(!g||!_||_.equals(h)||!this._box&&h.dist(g)<this._clickTolerance)return;this._lastPos=h,this._box||(this._box=Oe("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));let v=Math.min(g.x,h.x),E=Math.max(g.x,h.x),T=Math.min(g.y,h.y),C=Math.max(g.y,h.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${v}px,${T}px)`,this._box.style.width=E-v+"px",this._box.style.height=C-T+"px")})}mouseupWindow(t,o){if(!this._active)return;let h=this._startPos,g=o;if(h&&t.button===0){if(this.reset(),bs(),h.x!==g.x||h.y!==g.y)return this._map.fire(new r.A("boxzoomend",{originalEvent:t})),{cameraAnimation:_=>_.fitScreenCoordinates(h,g,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),ci(),delete this._startPos,delete this._lastPos}_fireEvent(t,o){return this._map.fire(new r.A(t,{originalEvent:o}))}}function Ku(d,t){let o={};for(let h=0;h<d.length;h++)o[d[h].identifier]=t[h];return o}class Tm{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,o,h){(this.centroid||h.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),h.length===this.numTouches&&(this.centroid=function(g){let _=new r.P(0,0);for(let v of g)_._add(v);return _.div(g.length)}(o),this.touches=Ku(h,o)))}touchmove(t,o,h){if(this.aborted||!this.centroid)return;let g=Ku(h,o);for(let _ in this.touches){let v=g[_];(!v||v.dist(this.touches[_])>30)&&(this.aborted=!0)}}touchend(t,o,h){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),h.length===0){let g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class La{constructor(t){this.singleTap=new Tm(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,o,h){this.singleTap.touchstart(t,o,h)}touchmove(t,o,h){this.singleTap.touchmove(t,o,h)}touchend(t,o,h){let g=this.singleTap.touchend(t,o,h);if(g){let _=t.timeStamp-this.lastTime<500,v=!this.lastTap||this.lastTap.dist(g)<30;if(_&&v||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class Im{constructor(){this._zoomIn=new La({numTouches:1,numTaps:2}),this._zoomOut=new La({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,o,h){this._zoomIn.touchstart(t,o,h),this._zoomOut.touchstart(t,o,h)}touchmove(t,o,h){this._zoomIn.touchmove(t,o,h),this._zoomOut.touchmove(t,o,h)}touchend(t,o,h){let g=this._zoomIn.touchend(t,o,h),_=this._zoomOut.touchend(t,o,h);return g?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()+1,around:v.unproject(g)},{originalEvent:t})}):_?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()-1,around:v.unproject(_)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let Sm={0:1,2:2},$h={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Ic{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,o){return!1}_move(t,o){return{}}mousedown(t,o){if(this._lastPoint)return;let h=Zd(t);this._correctButton(t,h)&&(this._lastPoint=o,this._eventButton=h)}mousemoveWindow(t,o){let h=this._lastPoint;if(h){if(t.preventDefault(),this._eventButton!=null&&function(g,_){let v=Sm[_];return g.buttons===void 0||(g.buttons&v)!==v}(t,this._eventButton))this.reset();else if(this._moved||!(o.dist(h)<this._clickTolerance))return this._moved=!0,this._lastPoint=o,this._move(h,o)}}mouseupWindow(t){this._lastPoint&&Zd(t)===this._eventButton&&(this._moved&&bs(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Dm extends Ic{mousedown(t,o){super.mousedown(t,o),this._lastPoint&&(this._active=!0)}_correctButton(t,o){return o===0&&!t.ctrlKey}_move(t,o){return{around:o,panDelta:o.sub(t)}}}class Wh extends Ic{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?$h[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=.8*(o.x-t.x);if(h)return this._active=!0,{bearingDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Cm extends Ic{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?$h[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=-.5*(o.y-t.y);if(h)return this._active=!0,{pitchDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class ky{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=o.clickTolerance||1,this.reset(),r.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new r.P(0,0)}touchstart(t,o,h){return this._calculateTransform(t,o,h)}touchmove(t,o,h){if(this._active&&!(h.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(h.length===1&&!r.eJ())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,o,h)}}touchend(t,o,h){this._calculateTransform(t,o,h),this._active&&h.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,o,h){h.length>0&&(this._active=!0);let g=Ku(h,o),_=new r.P(0,0),v=new r.P(0,0),E=0;for(let C in g){let A=g[C],L=this._touches[C];L&&(_._add(A),v._add(A.sub(L)),E++,g[C]=A)}if(this._touches=g,E<this._minTouches||!v.mag())return;let T=v.div(E);return this._sum._add(T),this._sum.mag()<this._clickTolerance?void 0:{around:_.div(E),panDelta:T}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Oe("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Zh{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,o,h){return{}}touchstart(t,o,h){this._firstTwoTouches||h.length<2||(this._firstTwoTouches=[h[0].identifier,h[1].identifier],this._start([o[0],o[1]]))}touchmove(t,o,h){let g=this._firstTwoTouches;if(!g)return;t.preventDefault();let[_,v]=g,E=Ju(h,o,_),T=Ju(h,o,v);if(!E||!T)return;let C=this._aroundCenter?null:E.add(T).div(2);return this._move([E,T],C,t)}touchend(t,o,h){if(!this._firstTwoTouches)return;let[g,_]=this._firstTwoTouches,v=Ju(h,o,g),E=Ju(h,o,_);v&&E||(this._active&&bs(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ju(d,t,o){for(let h=0;h<d.length;h++)if(d[h].identifier===o)return t[h]}function Am(d,t){return Math.log(d/t)/Math.LN2}class Ny extends Zh{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,o){let h=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(Am(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Am(this._distance,h),pinchAround:o}}}function Mm(d,t){return 180*d.angleWith(t)/Math.PI}class zy extends Zh{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,o){let h=this._vector;if(this._vector=t[0].sub(t[1]),h&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Mm(this._vector,h),pinchAround:o}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());let o=25/(Math.PI*this._minDiameter)*360,h=this._startVector;if(!h)return!1;let g=Mm(t,h);return Math.abs(g)<o}}function qh(d){return Math.abs(d.y)>Math.abs(d.x)}class By extends Zh{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,qh(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,o,h){let g=this._lastPoints;if(!g)return;let _=t[0].sub(g[0]),v=t[1].sub(g[1]);return this._map._cooperativeGestures&&!r.eJ()&&h.touches.length<3||(this._valid=this.gestureBeginsVertically(_,v,h.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(_.y+v.y)/2*-.5})}gestureBeginsVertically(t,o,h){if(this._valid!==void 0)return this._valid;let g=t.mag()>=2,_=o.mag()>=2;if(!g&&!_)return;if(!g||!_)return this._firstMove==null&&(this._firstMove=h),h-this._firstMove<100&&void 0;let v=t.y>0==o.y>0;return qh(t)&&qh(o)&&v}}let Vy={panStep:100,bearingStep:15,pitchStep:10};class Uy{constructor(){let t=Vy;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let o=0,h=0,g=0,_=0,v=0;switch(t.keyCode){case 61:case 107:case 171:case 187:o=1;break;case 189:case 109:case 173:o=-1;break;case 37:t.shiftKey?h=-1:(t.preventDefault(),_=-1);break;case 39:t.shiftKey?h=1:(t.preventDefault(),_=1);break;case 38:t.shiftKey?g=1:(t.preventDefault(),v=-1);break;case 40:t.shiftKey?g=-1:(t.preventDefault(),v=1);break;default:return}return this._rotationDisabled&&(h=0,g=0),{cameraAnimation:E=>{let T=E.getZoom();E.easeTo({duration:300,easeId:"keyboardHandler",easing:jy,zoom:o?Math.round(T)+o*(t.shiftKey?2:1):T,bearing:E.getBearing()+h*this._bearingStep,pitch:E.getPitch()+g*this._pitchStep,offset:[-_*this._panStep,-v*this._panStep],center:E.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function jy(d){return d*(2-d)}let Hy=4.000244140625,Yb=1/450;class Kb{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._handler=o,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Yb,r.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||r.eJ()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let o=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY,h=r.q.now(),g=h-(this._lastWheelEventTime||0);this._lastWheelEventTime=h,o!==0&&o%Hy==0?this._type="wheel":o!==0&&Math.abs(o)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=o,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(g*o)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,o+=this._lastValue)),t.shiftKey&&o&&(o/=4),this._type&&(this._lastWheelEvent=t,this._delta-=o,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let o=wo(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:o,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let o=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){let C=this._type==="wheel"&&Math.abs(this._delta)>Hy?this._wheelZoomRate:this._defaultZoomRate,A=2/(1+Math.exp(-Math.abs(this._delta*C)));this._delta<0&&A!==0&&(A=1/A);let L=o(),R=Math.pow(2,L),F=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):R;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(F*A))),this._type==="wheel"&&(this._startZoom=L,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let h=typeof this._targetZoom=="number"?this._targetZoom:o(),g=this._startZoom,_=this._easing,v,E=!1;if(this._type==="wheel"&&g&&_){let C=Math.min((r.q.now()-this._lastWheelEventTime)/200,1),A=_(C);v=r.ai(g,h,A),C<1?this._frameId||(this._frameId=!0):E=!0}else v=h,E=!0;this._active=!0,E&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let T=v-o();return T*this._lastDelta<0&&(T=0),{noInertia:!0,needsRenderFrame:!E,zoomDelta:T,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let o=r.eK;if(this._prevEase){let h=this._prevEase,g=(r.q.now()-h.start)/h.duration,_=h.easing(g+.01)-h.easing(g),v=.27/Math.sqrt(_*_+1e-4)*.01,E=Math.sqrt(.0729-v*v);o=r.eI(v,E,.25,1)}return this._prevEase={start:r.q.now(),duration:t,easing:o},o}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Oe("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class _r{constructor(t,o){this._clickZoom=t,this._tapZoom=o}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Gy{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,o){return t.preventDefault(),{cameraAnimation:h=>{h.easeTo({duration:300,zoom:h.getZoom()+(t.shiftKey?-1:1),around:h.unproject(o)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Jb{constructor(){this._tap=new La({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,o,h){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?h.length>0&&(this._swipePoint=o[0],this._swipeTouch=h[0].identifier):this._tap.touchstart(t,o,h))}touchmove(t,o,h){if(this._tapTime){if(this._swipePoint){if(h[0].identifier!==this._swipeTouch)return;let g=o[0],_=g.y-this._swipePoint.y;return this._swipePoint=g,t.preventDefault(),this._active=!0,{zoomDelta:_/128}}}else this._tap.touchmove(t,o,h)}touchend(t,o,h){this._tapTime?this._swipePoint&&h.length===0&&this.reset():this._tap.touchend(t,o,h)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Rm{constructor(t,o,h){this._el=t,this._mousePan=o,this._touchPan=h}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Qb{constructor(t,o,h){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=o,this._mousePitch=h}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Qu{constructor(t,o,h,g){this._el=t,this._touchZoom=o,this._touchRotate=h,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let ed=d=>d.zoom||d.drag||d.pitch||d.rotate;class Pm extends r.A{}class Xh{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,o){let h=r.at([],o,t);this.radius=r.ae(h[2]<0?r.eM([],h,this.constants):[h[0],h[1],0])}projectRay(t){r.eM(t,t,this.constants),r.au(t,t),r.eN(t,t,this.constants);let o=r.c1([],t,this.radius);if(o[2]>0){let h=r.c1([],[0,0,1],r.bG(o,[0,0,1])),g=r.c1([],r.au([],[o[0],o[1],0]),this.radius),_=r.d5([],o,r.c1([],r.at([],r.d5([],g,h),o),2));o[0]=_[0],o[1]=_[1]}return o}}function es(d){return d.panDelta&&d.panDelta.mag()||d.zoomDelta||d.bearingDelta||d.pitchDelta}class Yh{constructor(t,o){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Gh(t),this._bearingSnap=o.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Xh,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(o),r.aV(["handleEvent","handleWindowEvent"],this);let h=this._el;this._listeners=[[h,"touchstart",{passive:!0}],[h,"touchmove",{passive:!1}],[h,"touchend",void 0],[h,"touchcancel",void 0],[h,"mousedown",void 0],[h,"mousemove",void 0],[h,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[h,"mouseover",void 0],[h,"mouseout",void 0],[h,"dblclick",void 0],[h,"click",void 0],[h,"keydown",{capture:!1}],[h,"keyup",void 0],[h,"wheel",{passive:!1}],[h,"contextmenu",void 0],[window,"blur",void 0]];for(let[g,_,v]of this._listeners){let E=g===document?this.handleWindowEvent:this.handleEvent;g.addEventListener(_,E,v)}}destroy(){for(let[t,o,h]of this._listeners){let g=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(o,g,h)}}_addDefaultHandlers(t){let o=this._map,h=o.getCanvasContainer();this._add("mapEvent",new wm(o,t));let g=o.boxZoom=new Em(o,t);this._add("boxZoom",g);let _=new Im,v=new Gy;o.doubleClickZoom=new _r(v,_),this._add("tapZoom",_),this._add("clickZoom",v);let E=new Jb;this._add("tapDragZoom",E);let T=o.touchPitch=new By(o);this._add("touchPitch",T);let C=new Wh(t),A=new Cm(t);o.dragRotate=new Qb(t,C,A),this._add("mouseRotate",C,["mousePitch"]),this._add("mousePitch",A,["mouseRotate"]);let L=new Dm(t),R=new ky(o,t);o.dragPan=new Rm(h,L,R),this._add("mousePan",L),this._add("touchPan",R,["touchZoom","touchRotate"]);let F=new zy,V=new Ny;o.touchZoomRotate=new Qu(h,V,F,E),this._add("touchRotate",F,["touchPan","touchZoom"]),this._add("touchZoom",V,["touchPan","touchRotate"]),this._add("blockableMapEvent",new yl(o));let z=o.scrollZoom=new Kb(o,this);this._add("scrollZoom",z,["mousePan"]);let H=o.keyboard=new Uy;this._add("keyboard",H);for(let j of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[j]&&o[j].enable(t[j])}_add(t,o,h){this._handlers.push({handlerName:t,handler:o,allowed:h}),this._handlersById[t]=o}stop(t){if(!this._updatingCamera){for(let{handler:o}of this._handlers)o.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!ed(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,o,h){for(let g in t)if(g!==h&&(!o||o.indexOf(g)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){let o=[];for(let h of t)this._el.contains(h.target)&&o.push(h);return o}handleEvent(t,o){this._updatingCamera=!0;let h=t.type==="renderFrame",g=h?void 0:t,_={needsRenderFrame:!1},v={},E={},T=t.touches?this._getMapTouches(t.touches):void 0,C=T?ws(this._el,T):h?void 0:wo(this._el,t);for(let{handlerName:R,handler:F,allowed:V}of this._handlers){if(!F.isEnabled())continue;let z;this._blockedByActive(E,V,R)?F.reset():F[o||t.type]&&(z=F[o||t.type](t,C,T),this.mergeHandlerResult(_,v,z,R,g),z&&z.needsRenderFrame&&this._triggerRenderFrame()),(z||F.isActive())&&(E[R]=F)}let A={};for(let R in this._previousActiveHandlers)E[R]||(A[R]=g);this._previousActiveHandlers=E,(Object.keys(A).length||es(_))&&(this._changes.push([_,v,A]),this._triggerRenderFrame()),(Object.keys(E).length||es(_))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:L}=_;L&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],L(this._map))}mergeHandlerResult(t,o,h,g,_){if(!h)return;r.h(t,h);let v={handlerName:g,originalEvent:h.originalEvent||_};h.zoomDelta!==void 0&&(o.zoom=v),h.panDelta!==void 0&&(o.drag=v),h.pitchDelta!==void 0&&(o.pitch=v),h.bearingDelta!==void 0&&(o.rotate=v)}_applyChanges(){let t={},o={},h={};for(let[g,_,v]of this._changes)g.panDelta&&(t.panDelta=(t.panDelta||new r.P(0,0))._add(g.panDelta)),g.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+g.pitchDelta),g.around!==void 0&&(t.around=g.around),g.aroundCoord!==void 0&&(t.aroundCoord=g.aroundCoord),g.pinchAround!==void 0&&(t.pinchAround=g.pinchAround),g.noInertia&&(t.noInertia=g.noInertia),r.h(o,_),r.h(h,v);this._updateMapTransform(t,o,h),this._changes=[]}_updateMapTransform(t,o,h){let g=this._map,_=g.transform,v=Z=>[Z.x,Z.y,Z.z];if((Z=>{let Y=this._eventsInProgress.drag;return Y&&!this._handlersById[Y.handlerName].isActive()})()&&!es(t)){let Z=_.zoom;_.cameraElevationReference="sea",this._originalZoom!=null&&_._orthographicProjectionAtLowPitch&&_.projection.name!=="globe"&&_.pitch===0?(_.cameraElevationReference="ground",_.zoom=this._originalZoom):(_.recenterOnTerrain(),_.cameraElevationReference="ground"),Z!==_.zoom&&this._map._update(!0)}if(_._isCameraConstrained&&g._stop(!0),!es(t))return void this._fireEvents(o,h,!0);let{panDelta:E,zoomDelta:T,bearingDelta:C,pitchDelta:A,around:L,aroundCoord:R,pinchAround:F}=t;_._isCameraConstrained&&(T>0&&(T=0),_._isCameraConstrained=!1),F!==void 0&&(L=F),(T||(Z=>o[Z]&&!this._eventsInProgress[Z])("drag"))&&L&&(this._dragOrigin=v(_.pointCoordinate3D(L)),this._originalZoom=_.zoom,this._trackingEllipsoid.setup(_._camera.position,this._dragOrigin)),_.cameraElevationReference="sea",g._stop(!0),L=L||g.transform.centerPoint,C&&(_.bearing+=C),A&&(_.pitch+=A),_._updateCameraState();let V=[0,0,0];if(E)if(_.projection.name==="mercator"){let Z=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(L).dir),Y=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(L.sub(E)).dir);V[0]=Y[0]-Z[0],V[1]=Y[1]-Z[1]}else{let Z=_.pointCoordinate(L);if(_.projection.name==="globe"){E=E.rotate(-_.angle);let Y=_._pixelsPerMercatorPixel/_.worldSize;V[0]=-E.x*r.eL(r.aY(Z.y))*Y,V[1]=-E.y*r.eL(_.center.lat)*Y}else{let Y=_.pointCoordinate(L.sub(E));Z&&Y&&(V[0]=Y.x-Z.x,V[1]=Y.y-Z.y)}}let z=_.zoom,H=[0,0,0];if(T){let Z=v(R||_.pointCoordinate3D(L)),Y={dir:r.au([],r.at([],Z,_._camera.position))};if(Y.dir[2]<0){let J=_.zoomDeltaToMovement(Z,T);r.c1(H,Y.dir,J)}}let j=r.d5(V,V,H);_._translateCameraConstrained(j),T&&Math.abs(_.zoom-z)>1e-4&&_.recenterOnTerrain(),_.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(o,h,!0)}_fireEvents(t,o,h){let g=ed(this._eventsInProgress),_=ed(t),v={};for(let A in t){let{originalEvent:L}=t[A];this._eventsInProgress[A]||(v[`${A}start`]=L),this._eventsInProgress[A]=t[A]}!g&&_&&this._fireEvent("movestart",_.originalEvent);for(let A in v)this._fireEvent(A,v[A]);_&&this._fireEvent("move",_.originalEvent);for(let A in t){let{originalEvent:L}=t[A];this._fireEvent(A,L)}let E={},T;for(let A in this._eventsInProgress){let{handlerName:L,originalEvent:R}=this._eventsInProgress[A];this._handlersById[L].isActive()||(delete this._eventsInProgress[A],T=o[L]||R,E[`${A}end`]=T)}for(let A in E)this._fireEvent(A,E[A]);let C=ed(this._eventsInProgress);if(h&&(g||_)&&!C){this._updatingCamera=!0;let A=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),L=R=>R!==0&&-this._bearingSnap<R&&R<this._bearingSnap;A?(L(A.bearing||this._map.getBearing())&&(A.bearing=0),this._map.easeTo(A,{originalEvent:T})):(this._map.fire(new r.A("moveend",{originalEvent:T})),L(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,o){this._map.fire(new r.A(t,o?{originalEvent:o}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new Pm("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let Hr="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Cs extends r.E{constructor(t,o){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=o.bearingSnap,this._respectPrefersReducedMotion=o.respectPrefersReducedMotion!==!1,r.aV(["_renderFrameCallback"],this)}getCenter(){return new r.ci(this.transform.center.lng,this.transform.center.lat)}setCenter(t,o){return this.jumpTo({center:t},o)}panBy(t,o,h){return t=r.P.convert(t).mult(-1),this.panTo(this.transform.center,r.h({offset:t},o),h)}panTo(t,o,h){return this.easeTo(r.h({center:t},o),h)}getZoom(){return this.transform.zoom}setZoom(t,o){return this.jumpTo({zoom:t},o),this}zoomTo(t,o,h){return this.easeTo(r.h({zoom:t},o),h)}zoomIn(t,o){return this.zoomTo(this.getZoom()+1,t,o),this}zoomOut(t,o){return this.zoomTo(this.getZoom()-1,t,o),this}getBearing(){return this.transform.bearing}setBearing(t,o){return this.jumpTo({bearing:t},o),this}getPadding(){return this.transform.padding}setPadding(t,o){return this.jumpTo({padding:t},o),this}rotateTo(t,o,h){return this.easeTo(r.h({bearing:t},o),h)}resetNorth(t,o){return this.rotateTo(0,r.h({duration:1e3},t),o),this}resetNorthPitch(t,o){return this.easeTo(r.h({bearing:0,pitch:0,duration:1e3},t),o),this}snapToNorth(t,o){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,o):this}getPitch(){return this.transform.pitch}setPitch(t,o){return this.jumpTo({pitch:t},o),this}cameraForBounds(t,o){t=r.aG.convert(t);let h=o&&o.bearing||0,g=o&&o.pitch||0,_=t.getNorthWest(),v=t.getSouthEast();return this._cameraForBounds(this.transform,_,v,h,g,o)}_extendPadding(t){let o={top:0,right:0,bottom:0,left:0};return t==null?r.h({},o,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:r.h({},o,t)}_extendCameraOptions(t){return(t=r.h({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,o){let h=o.max[0]-o.min[0],g=o.max[1]-o.min[1];return h/g>t.aspect?h/(2*Math.tan(.5*t.fovX)*t.aspect):g/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,o,h,g,_,v){let E=t.clone(),T=this._extendCameraOptions(v);E.bearing=g,E.pitch=_;let C=r.ci.convert(o),A=r.ci.convert(h),L=.5*(C.lat+A.lat),R=.5*(C.lng+A.lng),F=r.eO(L,R),V=r.au([],F),z=r.au([],r.bF([],V,[0,1,0])),H=r.bF([],z,V),j=[z[0],z[1],z[2],0,H[0],H[1],H[2],0,V[0],V[1],V[2],0,0,0,0,1],Z=[F,r.eO(C.lat,C.lng),r.eO(A.lat,C.lng),r.eO(A.lat,A.lng),r.eO(C.lat,A.lng),r.eO(L,C.lng),r.eO(L,A.lng),r.eO(C.lat,R),r.eO(A.lat,R)],Y=r.d6.fromPoints(Z.map(Se=>[r.bG(z,Se),r.bG(H,Se),r.bG(V,Se)])),J=r.ad([],Y.center,j);r.eP(J)===0&&r.eQ(J,0,0,1),r.au(J,J),r.c1(J,J,r.aB),E.center=r.eR(J);let re=E.getWorldToCameraMatrix(),ce=r.bi(new Float64Array(16),re);Y=r.d6.applyTransform(Y,r.az([],re,j));let de=this._extendAABB(Y,E,T,g);if(!de)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Y=de,r.ad(J,J,re);let ie=.5*(Y.max[2]-Y.min[2]),oe=this._minimumAABBFrustumDistance(E,Y),se=r.c1([],[0,0,1],ie),Te=r.d5(se,J,se),me=oe+(E.pitch===0?0:r.bD(J,Te)),Ne=E.globeCenterInViewSpace,Ae=r.at([],J,[Ne[0],Ne[1],Ne[2]]);r.au(Ae,Ae),r.c1(Ae,Ae,me);let Ve=r.d5([],J,Ae);r.ad(Ve,Ve,ce);let Qe=r.eB/r.aB,Ie=r.ae(Ve),pe=r.cb(Math.max(Ie*Qe-r.eB,Number.EPSILON),0),Pe=Math.min(E.zoomFromMercatorZAdjusted(pe),T.maxZoom);return Pe>.5*(r.cX+r.cI)?(E.setProjection({name:"mercator"}),E.zoom=Pe,this._cameraForBounds(E,o,h,g,_,v)):{center:E.center,zoom:Pe,bearing:g,pitch:_}}_extendAABB(t,o,h,g){let _=.5*((h.padding.left||0)+(h.padding.right||0)),v=.5*((h.padding.top||0)+(h.padding.bottom||0)),E=v,T=_,C=_,A=v,L=o.width-(T+C),R=o.height-(E+A),F=r.at([],t.max,t.min),V=Math.min(L/F[0],R/F[1]),z=Math.min(o.scaleZoom(o.scale*V),h.maxZoom);if(isNaN(z))return null;let H=o.scale/o.zoomScale(z),j=new r.d6([t.min[0]-T*H,t.min[1]-A*H,t.min[2]],[t.max[0]+C*H,t.max[1]+E*H,t.max[2]]),Z=(typeof h.offset.x=="number"&&typeof h.offset.y=="number"?new r.P(h.offset.x,h.offset.y):r.P.convert(h.offset)).rotate(-r.al(g));return j.center[0]-=Z.x*H,j.center[1]+=Z.y*H,j}queryTerrainElevation(t,o){let h=this.transform.elevation;return h?(o=r.h({},{exaggerated:!0},o),h.getAtPoint(r.ac.fromLngLat(t),null,o.exaggerated)):null}_cameraForBounds(t,o,h,g,_,v){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,o,h,g,_,v);let E=t.clone(),T=this._extendCameraOptions(v);E.bearing=g,E.pitch=_;let C=r.ci.convert(o),A=r.ci.convert(h),L=new r.ci(C.lng,A.lat),R=new r.ci(A.lng,C.lat),F=E.project(C),V=E.project(A),z=this.queryTerrainElevation(C),H=this.queryTerrainElevation(A),j=this.queryTerrainElevation(L),Z=this.queryTerrainElevation(R),Y=[[F.x,F.y,Math.min(z||0,H||0,j||0,Z||0)],[V.x,V.y,Math.max(z||0,H||0,j||0,Z||0)]],J=r.d6.fromPoints(Y),re=E.getWorldToCameraMatrix(),ce=r.bi(new Float64Array(16),re);J=r.d6.applyTransform(J,re);let de=this._extendAABB(J,E,T,g);if(!de)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");J=de;let ie=.5*r.at([],J.max,J.min)[2],oe=this._minimumAABBFrustumDistance(E,J),se=[0,0,1,0];r.aA(se,se,re),r.eS(se,se);let Te=r.c1([],se,oe+ie),me=r.d5([],J.center,Te);r.ad(J.center,J.center,ce),r.ad(me,me,ce);let Ne=E.unproject(new r.P(J.center[0],J.center[1])),Ae=r.eT(E.projection,Ne),Ve=Math.pow(2,Ae),Qe=Math.min(E._zoomFromMercatorZ(me[2]*E.pixelsPerMeter*Ve/E.worldSize),T.maxZoom);return E.mercatorFromTransition&&Qe<.5*(r.cX+r.cI)?(E.setProjection({name:"globe"}),E.zoom=Qe,this._cameraForBounds(E,o,h,g,_,v)):{center:Ne,zoom:Qe,bearing:g,pitch:_}}fitBounds(t,o,h){let g=this.cameraForBounds(t,o);return this._fitInternal(g,o,h)}fitScreenCoordinates(t,o,h,g,_){let v=r.P.convert(t),E=r.P.convert(o),T=new r.P(Math.min(v.x,E.x),Math.min(v.y,E.y)),C=new r.P(Math.max(v.x,E.x),Math.max(v.y,E.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(v,E))return this;let A=this.transform.pointLocation3D(T),L=this.transform.pointLocation3D(C),R=this.transform.pointLocation3D(new r.P(T.x,C.y)),F=this.transform.pointLocation3D(new r.P(C.x,T.y)),V=[Math.min(A.lng,L.lng,R.lng,F.lng),Math.min(A.lat,L.lat,R.lat,F.lat)],z=[Math.max(A.lng,L.lng,R.lng,F.lng),Math.max(A.lat,L.lat,R.lat,F.lat)],H=g&&g.pitch?g.pitch:this.getPitch(),j=this._cameraForBounds(this.transform,V,z,h,H,g);return this._fitInternal(j,g,_)}_fitInternal(t,o,h){return t?(o=r.h(t,o)).linear?this.easeTo(o,h):this.flyTo(o,h):this}jumpTo(t,o){this.stop();let h=t.preloadOnly?this.transform.clone():this.transform,g=!1,_=!1,v=!1;"zoom"in t&&h.zoom!==+t.zoom&&(g=!0,h.zoom=+t.zoom),t.center!==void 0&&(h.center=r.ci.convert(t.center)),"bearing"in t&&h.bearing!==+t.bearing&&(_=!0,h.bearing=+t.bearing),"pitch"in t&&h.pitch!==+t.pitch&&(v=!0,h.pitch=+t.pitch);let E=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!h.isPaddingEqual(E))if(t.retainPadding===!1){let T=h.clone();T.padding=E,h.setLocationAtPoint(h.center,T.centerPoint)}else h.padding=E;return t.preloadOnly?(this._preloadTiles(h),this):(this.fire(new r.A("movestart",o)).fire(new r.A("move",o)),g&&this.fire(new r.A("zoomstart",o)).fire(new r.A("zoom",o)).fire(new r.A("zoomend",o)),_&&this.fire(new r.A("rotatestart",o)).fire(new r.A("rotate",o)).fire(new r.A("rotateend",o)),v&&this.fire(new r.A("pitchstart",o)).fire(new r.A("pitch",o)).fire(new r.A("pitchend",o)),this.fire(new r.A("moveend",o)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||r.w(Hr),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,o){let h=this.transform;if(!h.projection.supportsFreeCamera)return r.w(Hr),this;this.stop();let g=h.zoom,_=h.pitch,v=h.bearing;h.setFreeCameraOptions(t);let E=g!==h.zoom,T=_!==h.pitch,C=v!==h.bearing;return this.fire(new r.A("movestart",o)).fire(new r.A("move",o)),E&&this.fire(new r.A("zoomstart",o)).fire(new r.A("zoom",o)).fire(new r.A("zoomend",o)),C&&this.fire(new r.A("rotatestart",o)).fire(new r.A("rotate",o)).fire(new r.A("rotateend",o)),T&&this.fire(new r.A("pitchstart",o)).fire(new r.A("pitch",o)).fire(new r.A("pitchend",o)),this.fire(new r.A("moveend",o)),this}easeTo(t,o){this._stop(!1,t.easeId),((t=r.h({offset:[0,0],duration:500,easing:r.eK},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);let h=this.transform,g=this.getZoom(),_=this.getBearing(),v=this.getPitch(),E=this.getPadding(),T="zoom"in t?+t.zoom:g,C="bearing"in t?this._normalizeBearing(t.bearing,_):_,A="pitch"in t?+t.pitch:v,L=this._extendPadding(t.padding),R=r.P.convert(t.offset),F,V,z;if(h.projection.name==="globe"){let se=r.ac.fromLngLat(h.center),Te=R.rotate(-h.angle);se.x+=Te.x/h.worldSize,se.y+=Te.y/h.worldSize;let me=se.toLngLat(),Ne=r.ci.convert(t.center||me);this._normalizeCenter(Ne),F=h.centerPoint.add(Te),V=new r.P(se.x,se.y).mult(h.worldSize),z=new r.P(r.aD(Ne.lng),r.aH(Ne.lat)).mult(h.worldSize).sub(V)}else{F=h.centerPoint.add(R);let se=h.pointLocation(F),Te=r.ci.convert(t.center||se);this._normalizeCenter(Te),V=h.project(se),z=h.project(Te).sub(V)}let H=h.zoomScale(T-g),j,Z;t.around&&(j=r.ci.convert(t.around),Z=h.locationPoint(j));let Y=this._zooming||T!==g,J=this._rotating||_!==C,re=this._pitching||A!==v,ce=!h.isPaddingEqual(L),de=t.retainPadding===!1?h.clone():h,ie=se=>Te=>{if(Y&&(se.zoom=r.ai(g,T,Te)),J&&(se.bearing=r.ai(_,C,Te)),re&&(se.pitch=r.ai(v,A,Te)),ce&&(de.interpolatePadding(E,L,Te),F=de.centerPoint.add(R)),j)se.setLocationAtPoint(j,Z);else{let me=se.zoomScale(se.zoom-g),Ne=T>g?Math.min(2,H):Math.max(.5,H),Ae=Math.pow(Ne,1-Te),Ve=se.unproject(V.add(z.mult(Te*Ae)).mult(me));se.setLocationAtPoint(se.renderWorldCopies?Ve.wrap():Ve,F)}return t.preloadOnly||this._fireMoveEvents(o),se};if(t.preloadOnly){let se=this._emulate(ie,t.duration,h);return this._preloadTiles(se),this}let oe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Y,this._rotating=J,this._pitching=re,this._padding=ce,this._easeId=t.easeId,this._prepareEase(o,t.noMoveStart,oe),this._ease(ie(h),se=>{h.cameraElevationReference==="sea"&&h.recenterOnTerrain(),this._afterEase(o,se)},t),this}_prepareEase(t,o,h={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),o||h.moving||this.fire(new r.A("movestart",t)),this._zooming&&!h.zooming&&this.fire(new r.A("zoomstart",t)),this._rotating&&!h.rotating&&this.fire(new r.A("rotatestart",t)),this._pitching&&!h.pitching&&this.fire(new r.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new r.A("move",t)),this._zooming&&this.fire(new r.A("zoom",t)),this._rotating&&this.fire(new r.A("rotate",t)),this._pitching&&this.fire(new r.A("pitch",t))}_afterEase(t,o){if(this._easeId&&o&&this._easeId===o)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let h=this._zooming,g=this._rotating,_=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,h&&this.fire(new r.A("zoomend",t)),g&&this.fire(new r.A("rotateend",t)),_&&this.fire(new r.A("pitchend",t)),this.fire(new r.A("moveend",t))}flyTo(t,o){if(this._prefersReducedMotion(t)){let Se=r.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Se,o)}this.stop(),t=r.h({offset:[0,0],speed:1.2,curve:1.42,easing:r.eK},t);let h=this.transform,g=this.getZoom(),_=this.getBearing(),v=this.getPitch(),E=this.getPadding(),T="zoom"in t?r.ay(+t.zoom,h.minZoom,h.maxZoom):g,C="bearing"in t?this._normalizeBearing(t.bearing,_):_,A="pitch"in t?+t.pitch:v,L=this._extendPadding(t.padding),R=h.zoomScale(T-g),F=r.P.convert(t.offset),V=h.centerPoint.add(F),z=h.pointLocation(V),H=r.ci.convert(t.center||z);this._normalizeCenter(H);let j=h.project(z),Z=h.project(H).sub(j),Y=t.curve,J=Math.max(h.width,h.height),re=J/R,ce=Z.mag();if("minZoom"in t){let Se=r.ay(Math.min(t.minZoom,g,T),h.minZoom,h.maxZoom),He=J/h.zoomScale(Se-g);Y=Math.sqrt(He/ce*2)}let de=Y*Y;function ie(Se){let He=(re*re-J*J+(Se?-1:1)*de*de*ce*ce)/(2*(Se?re:J)*de*ce);return Math.log(Math.sqrt(He*He+1)-He)}function oe(Se){return(Math.exp(Se)-Math.exp(-Se))/2}function se(Se){return(Math.exp(Se)+Math.exp(-Se))/2}let Te=ie(0),me=function(Se){return se(Te)/se(Te+Y*Se)},Ne=function(Se){return J*((se(Te)*(oe(He=Te+Y*Se)/se(He))-oe(Te))/de)/ce;var He},Ae=(ie(1)-Te)/Y;if(Math.abs(ce)<1e-6||!isFinite(Ae)){if(Math.abs(J-re)<1e-6)return this.easeTo(t,o);let Se=re<J?-1:1;Ae=Math.abs(Math.log(re/J))/Y,Ne=function(){return 0},me=function(He){return Math.exp(Se*Y*He)}}t.duration="duration"in t?+t.duration:1e3*Ae/("screenSpeed"in t?+t.screenSpeed/Y:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);let Ve=_!==C,Qe=A!==v,Ie=!h.isPaddingEqual(L),pe=t.retainPadding===!1?h.clone():h,Pe=Se=>He=>{let Ge=He*Ae,We=1/me(Ge);Se.zoom=He===1?T:g+Se.scaleZoom(We),Ve&&(Se.bearing=r.ai(_,C,He)),Qe&&(Se.pitch=r.ai(v,A,He)),Ie&&(pe.interpolatePadding(E,L,He),V=pe.centerPoint.add(F));let ot=He===1?H:Se.unproject(j.add(Z.mult(Ne(Ge))).mult(We));return Se.setLocationAtPoint(Se.renderWorldCopies?ot.wrap():ot,V),Se._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(o),Se};if(t.preloadOnly){let Se=this._emulate(Pe,t.duration,h);return this._preloadTiles(Se),this}return this._zooming=!0,this._rotating=Ve,this._pitching=Qe,this._padding=Ie,this._prepareEase(o,!1),this._ease(Pe(h),()=>this._afterEase(o),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,o){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let h=this._onEaseEnd;this._onEaseEnd=void 0,h.call(this,o)}if(!t){let h=this.handlers;h&&h.stop(!1)}return this}_ease(t,o,h){h.animate===!1||h.duration===0?(t(1),o()):(this._easeStart=r.q.now(),this._easeOptions=h,this._onEaseFrame=t,this._onEaseEnd=o,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let t=Math.min((r.q.now()-this._easeStart)/this._easeOptions.duration,1),o=this._onEaseFrame;o&&o(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,o){t=r.bQ(t,-180,180);let h=Math.abs(t-o);return Math.abs(t-360-o)<h&&(t-=360),Math.abs(t+360-o)<h&&(t+=360),t}_normalizeCenter(t){let o=this.transform;if(o.maxBounds||o.projection.name!=="globe"&&!o.renderWorldCopies)return;let h=t.lng-o.center.lng;t.lng+=h>180?-360:h<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&r.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,o,h){let g=Math.ceil(15*o/1e3),_=[],v=t(h.clone());for(let E=0;E<=g;E++){let T=v(E/g);_.push(T.clone())}return _}_preloadTiles(t,o){}}class Sc{constructor(t={}){this.options=t,r.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){let o=this.options&&this.options.compact,h=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=Oe("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Oe("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",h);let g=Oe("span","mapboxgl-ctrl-icon",this._compactButton);return g.setAttribute("aria-hidden","true"),g.setAttribute("title",h),this._innerContainer=Oe("div","mapboxgl-ctrl-attrib-inner",this._container),o&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),o===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));let o=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||r.e.ACCESS_TOKEN}];if(t){let h=o.reduce((g,_,v)=>(_.value&&(g+=`${_.key}=${_.value}${v<o.length-1?"&":""}`),g),"?");t.href=`${r.e.FEEDBACK_URL}/${h}#${Hh(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){let g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}let o=this._map.style._mergedSourceCaches;for(let g in o){let _=o[g];if(_.used){let v=_.getSource();v.attribution&&t.indexOf(v.attribution)<0&&t.push(v.attribution)}}t.sort((g,_)=>g.length-_.length),t=t.filter((g,_)=>{for(let v=_+1;v<t.length;v++)if(t[v].indexOf(g)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));let h=t.join(" | ");h!==this._attribHTML&&(this._attribHTML=h,t.length?(this._innerContainer.innerHTML=h,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class td{constructor(){r.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=Oe("div","mapboxgl-ctrl");let o=Oe("a","mapboxgl-ctrl-logo");return o.target="_blank",o.rel="noopener nofollow",o.href="https://www.mapbox.com/",o.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),o.setAttribute("rel","noopener nofollow"),this._container.appendChild(o),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(let o in t){let h=t[o].getSource();if(h.hasOwnProperty("mapbox_logo")&&!h.mapbox_logo)return!1}return!0}_updateCompact(){let t=this._container.children;if(t.length){let o=t[0];this._map.getCanvasContainer().offsetWidth<250?o.classList.add("mapboxgl-compact"):o.classList.remove("mapboxgl-compact")}}}class Om{constructor(){r.aV(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=Oe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",o=>this._onIndoorUpdate({selectedFloorId:o.selectedFloorId,floors:o.floors})),this._container}_createButton(t,o){let h=Oe("button",t,this._container);return h.type="button",h.addEventListener("click",o),h}_setButtonTitle(t,o){this._map&&(t.setAttribute("aria-label",o),t.innerHTML=`<strong>${o}</strong>`,t.firstElementChild&&t.firstElementChild.setAttribute("title",o))}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return void(this._container.style.display="none");let o=this._model;this._model=t,this._container.style.display="inline-block";let h=t.floors.sort((g,_)=>g.levelOrder-_.levelOrder);o?(Array.from(this._container.children).forEach(g=>g.remove()),this.addCurrentFloors(h)):this.addCurrentFloors(h)}addCurrentFloors(t){for(let o of t){let h=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(o.id),Array.from(this._container.children).forEach(g=>{g.classList.remove("mapboxgl-ctrl-level-button-selected")}),h.classList.add("mapboxgl-ctrl-level-button-selected")});this._setButtonTitle(h,o.shortName),this._model&&o.id===this._model.selectedFloorId&&(this._map._selectIndoorFloor(o.id),h.classList.add("mapboxgl-ctrl-level-button-selected")),this._container.append(h)}}}class $y{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){let o=++this._id;return this._queue.push({callback:t,id:o,cancelled:!1}),o}remove(t){let o=this._currentlyRunning,h=o?this._queue.concat(o):this._queue;for(let g of h)if(g.id===t)return void(g.cancelled=!0)}run(t=0){let o=this._currentlyRunning=this._queue;this._queue=[];for(let h of o)if(!h.cancelled&&(h.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class nd{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;let o=r.dx((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-o)+this._end*o}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,o,h){this._start=this.getValue(o),this._end=t,this._startTime=o,this._endTime=o+h}}let e1={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Wy extends r.A{constructor(t,o,h,g){let{point:_,lngLat:v,originalEvent:E,target:T}=t;super(t.type,{point:_,lngLat:v,originalEvent:E,target:T}),this.preventDefault=()=>{t.preventDefault()},this.id=o,this.interaction=h,this.feature=g}}class Lm{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,o){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);let h=o.filter,g=o.type;h&&this.filters.set(t,r.b3(h)),g==="mouseover"&&(g="mouseenter"),g==="mouseout"&&(g="mouseleave");let _=this.interactionsByType.get(g)||new Map;g==="mouseenter"||g==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,o)):_.size===0&&this.map.on(g,this.handleType),_.size===0&&this.interactionsByType.set(g,_),_.set(t,o),this.typeById.set(t,g)}get(t){let o=this.typeById.get(t);if(!o)return;let h=this.interactionsByType.get(o);return h?h.get(t):void 0}remove(t){let o=this.typeById.get(t);if(!o)return;this.typeById.delete(t),this.filters.delete(t);let h=this.interactionsByType.get(o);h&&(h.delete(t),o==="mouseenter"||o==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):h.size===0&&this.map.off(o,this.handleType))}queryTargets(t,o){let h=[];for(let[g,_]of o)_.target&&h.push({targetId:g,target:_.target,filter:this.filters.get(g)});return this.map.style.queryRenderedTargets(t,h,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let o=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());o.length&&(t.type="mouseenter",this.handleType(t,o));let h=new Map;for(let[g,{feature:_}]of this.prevHoveredFeatures)this.hoveredFeatures.has(g)||h.set(_.id,_);h.size&&(t.type="mouseleave",this.handleType(t,Array.from(h.values())))}handleOut(t){let o=Array.from(this.hoveredFeatures.values()).map(({feature:h})=>h);o.length&&(t.type="mouseleave",this.handleType(t,o)),this.hoveredFeatures.clear()}handleType(t,o){let h=t.type==="mouseenter";if(h&&!this.interactionsByType.has(t.type))return void r.w("mouseenter interaction required for mouseleave to work.");let g=Array.from(this.interactionsByType.get(t.type)).reverse(),_=!!o;o=o||this.queryTargets(t.point,g);let v=!1,E=new Set;for(let T of o){for(let[C,A]of g){if(!A.target)continue;let L=T.variants?T.variants[C]:null;if(L){for(let R of L){if(Yd(R,T,E,C))continue;let F=new r.dr(T,R),V=_u(R,T,C);_&&(F.state=this.map.getFeatureState(F));let z=h?this.prevHoveredFeatures.get(V):null,H=new Wy(t,C,A,F),j=z?z.stop:A.handler(H);if(h&&this.hoveredFeatures.set(V,{feature:T,stop:j}),j!==!1){v=!0;break}}if(v)break}}if(v)break}if(!v)for(let[T,C]of g){let{handler:A,target:L}=C;if(!L&&A(new Wy(t,T,C,null))!==!1)break}}}function Fm(d,t){if(Array.isArray(d)&&Array.isArray(t)){let o=new Set(d),h=new Set(t);return o.size===h.size&&d.every(g=>h.has(g))}return r.bv(d,t)}let rd={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Dc={showCompass:!0,showZoom:!0,visualizePitch:!1};class Ws{constructor(t,o,h=!1){this._clickTolerance=10,this.element=o,this.mouseRotate=new Wh({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,h&&(this.mousePitch=new Cm({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),r.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),o.addEventListener("mousedown",this.mousedown),o.addEventListener("touchstart",this.touchstart,{passive:!1}),o.addEventListener("touchmove",this.touchmove),o.addEventListener("touchend",this.touchend),o.addEventListener("touchcancel",this.reset)}down(t,o){this.mouseRotate.mousedown(t,o),this.mousePitch&&this.mousePitch.mousedown(t,o),li()}move(t,o){let h=this.map,g=this.mouseRotate.mousemoveWindow(t,o),_=g&&g.bearingDelta;if(_&&h.setBearing(h.getBearing()+_),this.mousePitch){let v=this.mousePitch.mousemoveWindow(t,o),E=v&&v.pitchDelta;E&&h.setPitch(h.getPitch()+E)}}off(){let t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){ci(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(r.h({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),wo(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,wo(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=ws(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=ws(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function ts(d,t,o){if(d=new r.ci(d.lng,d.lat),t){let h=new r.ci(d.lng-360,d.lat),g=new r.ci(d.lng+360,d.lat),_=360*Math.ceil(Math.abs(d.lng-o.center.lng)/360),v=o.locationPoint3D(d).distSqr(t),E=t.x<0||t.y<0||t.x>o.width||t.y>o.height;o.locationPoint3D(h).distSqr(t)<v&&(E||Math.abs(h.lng-o.center.lng)<_)?d=h:o.locationPoint3D(g).distSqr(t)<v&&(E||Math.abs(g.lng-o.center.lng)<_)&&(d=g)}for(;Math.abs(d.lng-o.center.lng)>180;){let h=o.locationPoint3D(d);if(h.x>=0&&h.y>=0&&h.x<=o.width&&h.y<=o.height)break;d.lng>o.center.lng?d.lng-=360:d.lng+=360}return d}let Po={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},ji={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Oo extends r.E{constructor(t,o){super(),(t instanceof HTMLElement||o)&&(t=r.h({element:t},o)),r.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);let{anchor:h="center",color:g="#3FB1CE",scale:_=1,draggable:v=!1,clickTolerance:E=0,rotation:T=ji.rotation,rotationAlignment:C=ji.rotationAlignment,pitchAlignment:A=ji.pitchAlignment,occludedOpacity:L=ji.occludedOpacity,altitude:R=ji.altitude}=t||{};this._anchor=h,this._color=g,this._scale=_,this._draggable=v,this._clickTolerance=E,this._rotation=T,this._rotationAlignment=C,this._pitchAlignment=A,this._occludedOpacity=L,this._altitude=R,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=r.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=r.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",z=>{z.preventDefault()}),this._element.addEventListener("mousedown",z=>{z.preventDefault()});let F=this._element.classList;for(let z in Po)F.remove(`mapboxgl-marker-anchor-${z}`);F.add(`mapboxgl-marker-anchor-${this._anchor}`);let V=t&&t.className?t.className.trim().split(/\s+/):[];F.add(...V),this._popup=null}_createDefaultMarker(){let t=Oe("div"),o=Ct("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){let h=Ct("radialGradient",{id:"shadowGradient"},Ct("defs",{},o));Ct("stop",{offset:"10%","stop-opacity":.4},h),Ct("stop",{offset:"100%","stop-opacity":.05},h),Ct("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},o)}return Ct("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},o),Ct("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},o),Ct("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},o),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){let t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=r.ci.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||ji.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){let g=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){let o=t.code,h=t.charCode||t.keyCode;o!=="Space"&&o!=="Enter"&&h!==32&&h!==13||this.togglePopup()}_onMapClick(t){let o=t.originalEvent.target,h=this._element;this._popup&&(o===h||h.contains(o))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let t=this._map,o=this._pos;if(!t||!o)return!1;let h=t.unproject(o,this._altitude),g=t.getFreeCameraOptions();if(!g.position)return!1;let _=g.position.toLngLat();return _.distanceTo(h)<.9*_.distanceTo(this._lngLat)}_evaluateOpacity(){let t=this._map;if(!t)return;let o=this._pos;if(!o||o.x<0||o.x>t.transform.width||o.y<0||o.y>t.transform.height)return void this._clearFadeTimer();let h=t.unproject(o,this._altitude),g;t._showingGlobe()&&r.eW(t.transform,this._lngLat)?g=0:(g=1-t._queryFogOpacity(h),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(g*=this._occludedOpacity)),this._element.style.opacity=`${g}`,this._element.style.pointerEvents=g>0?"auto":"none",this._popup&&this._popup._setOpacity(g),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let t=this._pos;if(!t||!this._map)return;let o=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Po[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${o.x}px,${o.y}px)
        `}_calculateXYTransform(){let t=this._pos,o=this._map,h=this.getPitchAlignment();if(!o||!t||h!=="map")return"";if(!o._showingGlobe()){let T=o.getPitch();return T?`rotateX(${T}deg)`:""}let g=r.cU(r.eX(o.transform,this._lngLat)),_=t.sub(r.eY(o.transform)),v=Math.abs(_.x)+Math.abs(_.y);if(v===0)return"";let E=g/v;return`rotateX(${-_.y*E}deg) rotateY(${_.x*E}deg)`}_calculateZTransform(){let t=this._pos,o=this._map;if(!o||!t)return"";let h=0,g=this.getRotationAlignment();if(g==="map")if(o._showingGlobe()){let _=o.project(new r.ci(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),v=o.project(new r.ci(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(_);h=r.cU(Math.atan2(v.y,v.x))-90}else h=-o.getBearing();else if(g==="horizon"){let _=r.af(4,6,o.getZoom()),v=r.eY(o.transform);v.y+=_*o.transform.height;let E=t.sub(v),T=r.cU(Math.atan2(E.y,E.x));h=(T>90?T-270:T+90)*(1-_)}return h+=this._rotation,h?`rotateZ(${h}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);let o=this._map;o&&(o.transform.renderWorldCopies&&(this._lngLat=ts(this._lngLat,this._pos,o.transform)),this._pos=o.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),o._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(o._showingGlobe()||o.getTerrain()||o.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=r.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){let o=this._map;if(!o)return;let h=this._pointerdownPos,g=this._positionDelta;if(h&&g){if(!this._isDragging){let _=this._clickTolerance||o._clickTolerance;if(t.point.dist(h)<_)return;this._isDragging=!0}this._pos=t.point.sub(g),this._lngLat=o.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new r.A("dragstart"))),this.fire(new r.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new r.A("dragend")),this._state="inactive"}_addDragHandler(t){let o=this._map,h=this._pos;o&&h&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(h),this._pointerdownPos=t.point,this._state="pending",o.on("mousemove",this._onMove),o.on("touchmove",this._onMove),o.once("mouseup",this._onUp),o.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;let o=this._map;return o&&(t?(o.on("mousedown",this._addDragHandler),o.on("touchstart",this._addDragHandler)):(o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||ji.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||ji.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||ji.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||ji.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let t1={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},n1={maxWidth:100,unit:"metric"},r1={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},i1={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},Zy=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Fi(d=new r.P(0,0),t="bottom"){if(typeof d=="number"){let o=Math.round(Math.sqrt(.5*Math.pow(d,2)));switch(t){case"top":return new r.P(0,d);case"top-left":return new r.P(o,o);case"top-right":return new r.P(-o,o);case"bottom":return new r.P(0,-d);case"bottom-left":return new r.P(o,-o);case"bottom-right":return new r.P(-o,-o);case"left":return new r.P(d,0);case"right":return new r.P(-d,0)}return new r.P(0,0)}return d instanceof r.P||Array.isArray(d)?r.P.convert(d):r.P.convert(d[t]||[0,0])}return{version:M,supported:ht.supported,setRTLTextPlugin:r.f0,getRTLTextPluginStatus:r.e$,Map:class extends Cs{constructor(d){U.mark(k.create);let t=d;if((d=r.h({},rd,d)).minZoom!=null&&d.maxZoom!=null&&d.minZoom>d.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(d.minPitch!=null&&d.maxPitch!=null&&d.minPitch>d.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(d.minPitch!=null&&d.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(d.maxPitch!=null&&d.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(d.antialias&&r.eU(window)&&(d.antialias=!1,r.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Ap(d.minZoom,d.maxZoom,d.minPitch,d.maxPitch,d.renderWorldCopies,null,null),d),this._repaint=!!d.repaint,this._interactive=d.interactive,this._minTileCacheSize=d.minTileCacheSize,this._maxTileCacheSize=d.maxTileCacheSize,this._failIfMajorPerformanceCaveat=d.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=d.preserveDrawingBuffer,this._antialias=d.antialias,this._trackResize=d.trackResize,this._bearingSnap=d.bearingSnap,this._refreshExpiredTiles=d.refreshExpiredTiles,this._fadeDuration=d.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=d.crossSourceCollisions,this._collectResourceTiming=d.collectResourceTiming,this._language=this._parseLanguage(d.language),this._worldview=d.worldview,this._renderTaskQueue=new $y,this._domRenderTaskQueue=new $y,this._controls=[],this._markers=[],this._popups=[],this._mapId=r.a$(),this._locale=r.h({},e1,d.locale),this._clickTolerance=d.clickTolerance,this._cooperativeGestures=d.cooperativeGestures,this._performanceMetricsCollection=d.performanceMetricsCollection,this._tessellationStep=d.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=d.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new nd(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=d.scaleFactor,this._requestManager=new Zr(d.transformRequest,d.accessToken,d.testMode),this._silenceAuthErrors=!!d.testMode,this._contextCreateOptions=d.contextCreateOptions?Object.assign({},d.contextCreateOptions):{},typeof d.container=="string"){let o=document.getElementById(d.container);if(!o)throw new Error(`Container '${d.container.toString()}' not found.`);this._container=o}else{if(!(d.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=d.container}if(this._container.childNodes.length>0&&r.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),d.maxBounds&&this.setMaxBounds(d.maxBounds),this._spriteFormat=d.spriteFormat,r.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new qb),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Yh(this,d),this._localFontFamily=d.localFontFamily,this._localIdeographFontFamily=d.localIdeographFontFamily,(d.style||!d.testMode)&&this.setStyle(d.style||r.e.DEFAULT_STYLE,{config:d.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),d.projection&&this.setProjection(d.projection),this.indoor=new Mb(this),d.hash&&(this._hash=new jh(typeof d.hash=="string"&&d.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:d.center,zoom:d.zoom,bearing:d.bearing,pitch:d.pitch});let o=d.bounds;o&&(this.resize(),this.fitBounds(o,r.h({},d.fitBoundsOptions,{duration:0})))}this.resize(),d.attributionControl&&this.addControl(new Sc({customAttribution:d.customAttribution})),this._logoControl=new td,this.addControl(this._logoControl,d.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new r.A(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new r.A(`${o.dataType}dataloading`,o))}),this._interactions=new Lm(this)}_getMapId(){return this._mapId}addControl(d,t){if(t===void 0&&(t=d.getDefaultPosition?d.getDefaultPosition():"top-right"),!d||!d.onAdd)return this.fire(new r.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let o=d.onAdd(this);this._controls.push(d);let h=this._controlPositions[t];return t.indexOf("bottom")!==-1?h.insertBefore(o,h.firstChild):h.appendChild(o),this}removeControl(d){if(!d||!d.onRemove)return this.fire(new r.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let t=this._controls.indexOf(d);return t>-1&&this._controls.splice(t,1),d.onRemove(this),this}hasControl(d){return this._controls.indexOf(d)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(d){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let t=!this._moving;return t&&this.fire(new r.A("movestart",d)).fire(new r.A("move",d)),this.fire(new r.A("resize",d)),t&&this.fire(new r.A("moveend",d)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(d){return this.transform.setMaxBounds(r.aG.convert(d)),this._update()}setMinZoom(d){if((d=d??-2)>=-2&&d<=this.transform.maxZoom)return this.transform.minZoom=d,this._update(),this.getZoom()<d?this.setZoom(d):this.fire(new r.A("zoomstart")).fire(new r.A("zoom")).fire(new r.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(d){if((d=d??22)>=this.transform.minZoom)return this.transform.maxZoom=d,this._update(),this.getZoom()>d?this.setZoom(d):this.fire(new r.A("zoomstart")).fire(new r.A("zoom")).fire(new r.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(d){if((d=d??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(d>=0&&d<=this.transform.maxPitch)return this.transform.minPitch=d,this._update(),this.getPitch()<d?this.setPitch(d):this.fire(new r.A("pitchstart")).fire(new r.A("pitch")).fire(new r.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(d){if((d=d??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(d>=this.transform.minPitch)return this.transform.maxPitch=d,this._update(),this.getPitch()>d?this.setPitch(d):this.fire(new r.A("pitchstart")).fire(new r.A("pitch")).fire(new r.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(d){return this._scaleFactor=d,this.painter.scaleFactor=d,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(d){return this.transform.renderWorldCopies=d,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(d){return d==="auto"?navigator.language:Array.isArray(d)?d.length===0?void 0:d.map(t=>t==="auto"?navigator.language:t):d}setLanguage(d){let t=this._parseLanguage(d);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(let o of this._controls)o._setLanguage&&o._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(d){return this.style&&d!==this._worldview?(this._worldview=d,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(d){return this._lazyInitEmptyStyle(),d?typeof d=="string"&&(d={name:d}):d=null,this._useExplicitProjection=!!d,this._prioritizeAndUpdateProjection(d,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let d=this.transform,t=d.projection.name,o;t==="globe"&&d.zoom>=r.cI?(d.setMercatorFromTransition(),o=!0):t==="mercator"&&d.zoom<r.cI&&(d.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(d,t){return this._updateProjection(d||t||{name:"mercator"})}_updateProjection(d){let t;return t=d.name==="globe"&&this.transform.zoom>=r.cI?this.transform.setMercatorFromTransition():this.transform.setProjection(d),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(d,t){return this.transform.locationPoint3D(r.ci.convert(d),t)}unproject(d,t){return this.transform.pointLocation3D(r.P.convert(d),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(d,t,o){let h=g=>{let _=[];if(Array.isArray(t)){let v=t.filter(E=>this.getLayer(E));_=v.length?this.queryRenderedFeatures(g,{layers:v}):[]}else _=this.queryRenderedFeatures(g,{target:t});return _};if(d==="mouseenter"||d==="mouseover"){let g=!1;return{listener:o,targets:t,delegates:{mousemove:v=>{let E=h(v.point);E.length?g||(g=!0,o.call(this,new dr(d,this,v.originalEvent,{features:E}))):g=!1},mouseout:()=>{g=!1}}}}if(d==="mouseleave"||d==="mouseout"){let g=!1;return{listener:o,targets:t,delegates:{mousemove:E=>{h(E.point).length?g=!0:g&&(g=!1,o.call(this,new dr(d,this,E.originalEvent)))},mouseout:E=>{g&&(g=!1,o.call(this,new dr(d,this,E.originalEvent)))}}}}{let g=_=>{let v=h(_.point);v.length&&(_.features=v,o.call(this,_),delete _.features)};return{listener:o,targets:t,delegates:{[d]:g}}}}on(d,t,o){if(typeof t=="function"||o===void 0)return super.on(d,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(d,t,o);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[d]=this._delegatedListeners[d]||[],this._delegatedListeners[d].push(h);for(let g in h.delegates)this.on(g,h.delegates[g]);return this}once(d,t,o){if(typeof t=="function"||o===void 0)return super.once(d,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(d,t,o);for(let g in h.delegates)this.once(g,h.delegates[g]);return this}off(d,t,o){if(typeof t=="function"||o===void 0)return super.off(d,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._delegatedListeners?this._delegatedListeners[d]:void 0;return h&&(g=>{for(let _=0;_<g.length;_++){let v=g[_];if(v.listener===o&&Fm(v.targets,t)){for(let E in v.delegates)this.off(E,v.delegates[E]);return g.splice(_,1),this}}})(h),this}queryRenderedFeatures(d,t){if(!this.style)return[];if(d===void 0||d instanceof r.P||Array.isArray(d)||t!==void 0||(t=d,d=void 0),d=d||[[0,0],[this.transform.width,this.transform.height]],!t){let _=this.style.queryRenderedFeatures(d,void 0,this.transform),v=this.style.queryRenderedFeatureset(d,void 0,this.transform);return _.concat(v)}let o=!0;if(t.target&&(o=this._isTargetValid(t.target),o&&!t.layers))return this.style.queryRenderedFeatureset(d,t,this.transform);let h=!0;if(t.layers&&Array.isArray(t.layers)){for(let _ of t.layers)if(!this._isValidId(_)){h=!1;break}if(h&&!t.target)return this.style.queryRenderedFeatures(d,t,this.transform)}let g=[];return h&&(g=g.concat(this.style.queryRenderedFeatures(d,t,this.transform))),o&&(g=g.concat(this.style.queryRenderedFeatureset(d,t,this.transform))),g}querySourceFeatures(d,t){return!d||typeof d=="string"&&!this._isValidId(d)?[]:this.style.querySourceFeatures(d,t)}isPointOnSurface(d){let{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&r.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(r.P.convert(d))}addInteraction(d,t){return this._interactions.add(d,t),this}removeInteraction(d){return this._interactions.remove(d),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(d){return this._cooperativeGestures=d,this}setStyle(d,t){return t=r.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&d&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(d,(o,h)=>{if(o){let g=typeof o=="string"?o:o instanceof Error?o.message:o.error;r.w(`Unable to perform style diff: ${g}. Rebuilding the style from scratch.`),this._updateStyle(d,t)}else h&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(d,t))}_getUIString(d){let t=this._locale[d];if(t==null)throw new Error(`Missing UI string '${d}'`);return t}_updateStyle(d,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),d){let o=r.h({},t);t&&t.config&&(o.initialConfig=t.config,delete o.config),this.style=new Jo(this,o).load(d),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Jo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(r.w("There is no style added to the map."),!1)}_isValidId(d){return d==null?(this.fire(new r.z(new Error("IDs can't be empty."))),!1):!r.dk(d)||(this.fire(new r.z(new Error(`IDs can't contain special symbols: "${d}".`))),!1)}_isTargetValid(d){return"featuresetId"in d?this._isValidId("importId"in d?d.importId:d.featuresetId):"layerId"in d&&this._isValidId(d.layerId)}_areTargetsValid(d){if(Array.isArray(d)){for(let t of d)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(d)}addSource(d,t){return this._isValidId(d)?(this._lazyInitEmptyStyle(),this.style.addSource(d,t),this._update(!0)):this}isSourceLoaded(d){return!!this._isValidId(d)&&!!this.style&&this.style._isSourceCacheLoaded(d)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(d,t,o){this._lazyInitEmptyStyle(),this.style.addSourceType(d,t,o)}removeSource(d){return this._isValidId(d)?(this.style.removeSource(d),this._updateTerrain(),this._update(!0)):this}getSource(d){return this._isValidId(d)?this.style.getOwnSource(d):null}addImage(d,t,{pixelRatio:o=1,sdf:h=!1,stretchX:g,stretchY:_,content:v}={}){this._lazyInitEmptyStyle();let E=r.I.from(d);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){let{width:T,height:C,data:A}=r.q.getImageData(t);this.style.addImage(E,{data:new r.r({width:T,height:C},A),pixelRatio:o,stretchX:g,stretchY:_,content:v,sdf:h,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new r.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:T,height:C}=t,A=t;this.style.addImage(E,{data:new r.r({width:T,height:C},new Uint8Array(A.data)),pixelRatio:o,stretchX:g,stretchY:_,content:v,sdf:h,usvg:!1,version:0,userImage:A}),A.onAdd&&A.onAdd(this,d)}}updateImage(d,t){this._lazyInitEmptyStyle();let o=r.I.from(d),h=this.style.getImage(o);if(!h)return void this.fire(new r.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let g=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?r.q.getImageData(t):t,{width:_,height:v,data:E}=g;if(_===void 0||v===void 0)return void this.fire(new r.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(_!==(h.usvg?h.icon.usvg_tree.width:h.data.width)||v!==(h.usvg?h.icon.usvg_tree.height:h.data.height))return void this.fire(new r.z(new Error(`The width and height of the updated image (${_}, ${v})
                must be that same as the previous version of the image
                (${h.data.width}, ${h.data.height})`)));let T=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap),C=!1;h.usvg?(h.data=new r.r({width:_,height:v},new Uint8Array(E)),h.usvg=!1,h.icon=void 0,C=!0):h.data.replace(E,T),this.style.updateImage(o,h,C)}hasImage(d){return d?!!this.style&&!!this.style.getImage(r.I.from(d)):(this.fire(new r.z(new Error("Missing required image id"))),!1)}removeImage(d){this.style.removeImage(r.I.from(d))}loadImage(d,t){r.o(this._requestManager.transformRequest(d,r.R.Image),(o,h)=>{t(o,h instanceof HTMLImageElement?r.q.getImageData(h):h)})}listImages(){return this.style.listImages().map(d=>d.name)}addModel(d,t){this._lazyInitEmptyStyle(),this.style.addModel(d,t)}hasModel(d){return d?this.style.hasModel(d):(this.fire(new r.z(new Error("Missing required model id"))),!1)}removeModel(d){this.style.removeModel(d)}listModels(){return this.style.listModels()}addLayer(d,t){return this._isValidId(d.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(d,t),this._update(!0)):this}getSlot(d){let t=this.getLayer(d);return t&&t.slot||null}setSlot(d,t){return this.style.setSlot(d,t),this.style.mergeLayers(),this._update(!0)}addImport(d,t){return this.style.addImport(d,t).catch(o=>this.fire(new r.z(new Error("Failed to add import",o)))),this}updateImport(d,t){return typeof t!="string"&&t.id!==d?(this.removeImport(d),this.addImport(t)):(this.style.updateImport(d,t),this._update(!0))}removeImport(d){return this.style.removeImport(d),this}moveImport(d,t){return this.style.moveImport(d,t),this._update(!0)}moveLayer(d,t){return this._isValidId(d)?(this.style.moveLayer(d,t),this._update(!0)):this}removeLayer(d){return this._isValidId(d)?(this.style.removeLayer(d),this._update(!0)):this}getLayer(d){if(!this._isValidId(d))return null;let t=this.style.getOwnLayer(d);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(d,t,o){return this._isValidId(d)?(this.style.setLayerZoomRange(d,t,o),this._update(!0)):this}setFilter(d,t,o={}){return this._isValidId(d)?(this.style.setFilter(d,t,o),this._update(!0)):this}getFilter(d){return this._isValidId(d)?this.style.getFilter(d):null}setPaintProperty(d,t,o,h={}){return this._isValidId(d)?(this.style.setPaintProperty(d,t,o,h),this._update(!0)):this}getPaintProperty(d,t){return this._isValidId(d)?this.style.getPaintProperty(d,t):null}setLayoutProperty(d,t,o,h={}){return this._isValidId(d)?(this.style.setLayoutProperty(d,t,o,h),this._update(!0)):this}getLayoutProperty(d,t){return this._isValidId(d)?this.style.getLayoutProperty(d,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(d){return this.style.setGlyphsUrl(d),this._update(!0)}getSchema(d){return this.style.getSchema(d)}setSchema(d,t){return this.style.setSchema(d,t),this._update(!0)}getConfig(d){return this.style.getConfig(d)}setConfig(d,t){return this.style.setConfig(d,t),this._update(!0)}getConfigProperty(d,t){return this.style.getConfigProperty(d,t)}setConfigProperty(d,t,o){return this.style.setConfigProperty(d,t,o),this._update(!0)}getFeaturesetDescriptors(d){return this.style.getFeaturesetDescriptors(d)}setLights(d){if(this._lazyInitEmptyStyle(),d&&d.length===1&&d[0].type==="flat"){let t=d[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(d),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let d=this.style.getLights()||[];return d.length===0&&d.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),d}setLight(d,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:d}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(d){return this._lazyInitEmptyStyle(),!d&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(d),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(d){return this._lazyInitEmptyStyle(),this.style.setFog(d),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(d){return this._lazyInitEmptyStyle(),this.style.setSnow(d),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(d){return this._lazyInitEmptyStyle(),this.style.setRain(d),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(d){return this._lazyInitEmptyStyle(),this.style.setColorTheme(d),this._update(!0)}setImportColorTheme(d,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(d,t),this._update(!0)}setCamera(d){return this.style.setCamera(d),this._triggerCameraUpdate(d)}_triggerCameraUpdate(d){return this._update(this.transform.setOrthographicProjectionAtLowPitch(d["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(d){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(r.ci.convert(d),this.transform):0}setFeatureState(d,t){return d.source&&!this._isValidId(d.source)?this:(this.style.setFeatureState(d,t),this._update())}removeFeatureState(d,t){return d.source&&!this._isValidId(d.source)?this:(this.style.removeFeatureState(d,t),this._update())}getFeatureState(d){return d.source&&!this._isValidId(d.source)?null:this.style.getFeatureState(d)}_selectIndoorFloor(d){this.indoor.selectFloor(d)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Om),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;let d=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300,o,h,g,_=this._container;for(;_&&(!h||!g);){let v=window.getComputedStyle(_).transform;v&&v!=="none"&&(o=v.match(/matrix.*\((.+)\)/)[1].split(", "),o[0]&&o[0]!=="0"&&o[0]!=="1"&&(h=o[0]),o[3]&&o[3]!=="0"&&o[3]!=="1"&&(g=o[3])),_=_.parentElement}this._containerWidth=h?Math.abs(d/h):d,this._containerHeight=g?Math.abs(t/g):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&r.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let d=this._container;d.classList.add("mapboxgl-map"),(this._missingCSSCanary=Oe("div","mapboxgl-canary",d)).style.visibility="hidden",this._detectMissingCSS();let t=this._canvasContainer=Oe("div","mapboxgl-canvas-container",d);this._canvas=Oe("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let o=this._controlContainer=Oe("div","mapboxgl-control-container",d),h=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(g=>{h[g]=Oe("div",`mapboxgl-ctrl-${g}`,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(d,t){let o=r.q.devicePixelRatio||1;this._canvas.width=o*Math.ceil(d),this._canvas.height=o*Math.ceil(t),this._canvas.style.width=`${d}px`,this._canvas.style.height=`${t}px`}_addMarker(d){this._markers.push(d)}_removeMarker(d){let t=this._markers.indexOf(d);t!==-1&&this._markers.splice(t,1)}_addPopup(d){this._popups.push(d)}_removePopup(d){let t=this._popups.indexOf(d);t!==-1&&this._popups.splice(t,1)}_setupPainter(){let d=r.h({},ht.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",d);t?(da(t,!0),this.painter=new Pa(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",o=>{o.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),r.l.testSupport(t)):this.fire(new r.z(new Error("Failed to initialize WebGL")))}_contextLost(d){d.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new r.A("webglcontextlost",{originalEvent:d}))}_contextRestored(d){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new r.A("webglcontextrestored",{originalEvent:d}))}_onMapScroll(d){if(d.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(d){return this.style?(this._styleDirty=this._styleDirty||d,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(d){return this._update(),this._renderTaskQueue.add(d)}_cancelRenderFrame(d){this._renderTaskQueue.remove(d)}_requestDomTask(d){!this.loaded()||this.loaded()&&!this.isMoving()?d():this._domRenderTaskQueue.add(d)}_render(d){let t;this.fire(new r.A("renderstart")),++this._frameId;let o=this.painter.context.extTimerQuery,h=r.q.now(),g=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=g.createQuery(),g.beginQuery(o.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(d),this._domRenderTaskQueue.run(d),this._removed)return;this._updateProjectionTransition();let _=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let C=this.transform.zoom,A=this.transform.pitch,L=r.q.now(),R=new r.aa(C,{now:L,fadeDuration:_,pitch:A,transition:this.style.transition,worldview:this._worldview});this.style.update(R)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let v=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),v=this._updateAverageElevation(h),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):v=this._updateAverageElevation(h);let E=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,_,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),E&&(this._placementDirty=E.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:_,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new r.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,U.mark(k.load),this.fire(new r.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){let C=r.q.now()-h;g.endQuery(o.TIME_ELAPSED_EXT),setTimeout(()=>{let A=g.getQueryParameter(t,g.QUERY_RESULT)/1e6;g.deleteQuery(t),this.fire(new r.A("gpu-timing-frame",{cpuTime:C,gpuTime:A}))},50)}if(this.listens("gpu-timing-layer")){let C=this.painter.collectGpuTimers();setTimeout(()=>{let A=this.painter.queryGpuTimers(C);this.fire(new r.A("gpu-timing-layer",{layerTimes:A}))},50)}if(this.listens("gpu-timing-deferred-render")){let C=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let A=this.painter.queryGpuTimeDeferredRender(C);this.fire(new r.A("gpu-timing-deferred-render",{gpuTime:A}))},50)}let T=this._sourcesDirty||this._styleDirty||this._placementDirty||v;if(T||this._repaint)this.triggerRepaint();else{let C=this.idle();if(C&&(v=this._updateAverageElevation(h,!0)),v)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new r.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let A=this._calculateSpeedIndex();this.fire(new r.A("speedindexcompleted",{speedIndex:A})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||T||(this._fullyLoaded=!0,U.mark(k.fullLoad),this._performanceMetricsCollection&&qr(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(d){for(let t of this._markers)d&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(let t of this._popups)!d||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(d,t=!1){let o=g=>(this.transform.averageElevation=g,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&o(0);let h=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(h||(t||d-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(d)){let g=this.transform.averageElevation,_=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(_)?_=0:this._averageElevationLastSampledAt=d;let v=Math.abs(g-_);if(v>1){if(this._isInitialLoad||h)return this._averageElevation.jumpTo(_),o(_);this._averageElevation.easeTo(_,d,300)}else if(v>1e-4)return this._averageElevation.jumpTo(_),o(_)}return!!this._averageElevation.isEasing(d)&&o(this._averageElevation.getValue(d))}_authenticate(){Nr(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,d=>{if(d&&(d.message===Ei||d.status===401)){let t=this.painter.context.gl;da(t,!1),this._logoControl instanceof td&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new r.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),qd(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&cr(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let d=this._isDragging();this.painter.updateTerrain(this.style,d)}_calculateSpeedIndex(){let d=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());let o=this.painter.context.gl,h=o.createFramebuffer();function g(_){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,_,0);let v=new Uint8Array(o.drawingBufferWidth*o.drawingBufferHeight*4);return o.readPixels(0,0,o.drawingBufferWidth,o.drawingBufferHeight,o.RGBA,o.UNSIGNED_BYTE,v),v}return o.bindFramebuffer(o.FRAMEBUFFER,h),this._canvasPixelComparison(g(d),t.canvasCopies.map(g),t.timeStamps)}_canvasPixelComparison(d,t,o){let h=o[1]-o[0],g=d.length/4;for(let _=0;_<t.length;_++){let v=t[_],E=0;for(let T=0;T<v.length;T+=4)v[T]===d[T]&&v[T+1]===d[T+1]&&v[T+2]===d[T+2]&&v[T+3]===d[T+3]&&(E+=1);h+=(o[_+2]-o[_+1])*(1-E/g)}return h}remove(){this._hash&&this._hash.remove();for(let t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let d=this.painter.context.gl.getExtension("WEBGL_lose_context");d&&d.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),ua.delete(this.painter.context.gl),Yi.remove(),jl.remove(),this._removed=!0,this.fire(new r.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(d){this._renderNextFrame=this._renderNextFrame||d,this.style&&!this._frame&&(this._frame=r.q.frame(t=>{let o=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,o&&this._render(t)}))}_preloadTiles(d){let t=this.style?this.style.getSourceCaches():[];return r.bt(t,(o,h)=>o._preloadTiles(d,h),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(d){this._trackResize&&this.resize({originalEvent:d})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(d){this._showTileBoundaries!==d&&(this._showTileBoundaries=d,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(d){this._showParseStatus!==d&&(this._showParseStatus=d,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(d){this._showTerrainWireframe!==d&&(this._showTerrainWireframe=d,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(d){this._showLayers2DWireframe!==d&&(this._showLayers2DWireframe=d,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(d){this._showLayers3DWireframe!==d&&(this._showLayers3DWireframe=d,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(d){this._speedIndexTiming!==d&&(this._speedIndexTiming=d,this._update())}get showPadding(){return!!this._showPadding}set showPadding(d){this._showPadding!==d&&(this._showPadding=d,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(d){this._showCollisionBoxes!==d&&(this._showCollisionBoxes=d,this._tp.refreshUI(),d?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(d){this._showOverdrawInspector!==d&&(this._showOverdrawInspector=d,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(d){this._repaint!==d&&(this._repaint=d,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(d){this._vertices=d,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(d){this._showTileAABBs!==d&&(this._showTileAABBs=d,this._tp.refreshUI(),d&&this._update())}_setCacheLimits(d,t){r.eV(d,t)}get version(){return M}},NavigationControl:class{constructor(d={}){this.options=r.h({},Dc,d),this._container=Oe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(r.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),Oe("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),Oe("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(r.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{let o=this._map;o&&(this.options.visualizePitch?o.resetNorthPitch({},{originalEvent:t}):o.resetNorth({},{originalEvent:t}))}),this._compassIcon=Oe("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let d=this._map;if(!d)return;let t=d.getZoom(),o=t===d.getMaxZoom(),h=t===d.getMinZoom();this._zoomInButton.disabled=o,this._zoomOutButton.disabled=h,this._zoomInButton.setAttribute("aria-disabled",o.toString()),this._zoomOutButton.setAttribute("aria-disabled",h.toString())}_rotateCompassArrow(){let d=this._map;if(!d)return;let t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(d.transform.pitch*(Math.PI/180)),.5)}) rotateX(${d.transform.pitch}deg) rotateZ(${d.transform.angle*(180/Math.PI)}deg)`:`rotate(${d.transform.angle*(180/Math.PI)}deg)`;d._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(d){return this._map=d,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),d.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&d.on("pitch",this._rotateCompassArrow),d.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Ws(d,this._compass,this.options.visualizePitch)),this._container}onRemove(){let d=this._map;d&&(this._container.remove(),this.options.showZoom&&d.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&d.off("pitch",this._rotateCompassArrow),d.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(d,t){let o=Oe("button",d,this._container);return o.type="button",o.addEventListener("click",t),o}_setButtonTitle(d,t){if(!this._map)return;let o=this._map._getUIString(`NavigationControl.${t}`);d.setAttribute("aria-label",o),d.firstElementChild&&d.firstElementChild.setAttribute("title",o)}},GeolocateControl:class extends r.E{constructor(d={}){super();let t=navigator.geolocation;this.options=r.h({geolocation:t},t1,d),r.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=xc(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(d){return this._map=d,this._container=Oe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(d){let t=(o=!!this.options.geolocation)=>{this._supportsGeolocation=o,d(o)};this._supportsGeolocation!==void 0?d(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(o=>t(o.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(d){let t=this._map.getMaxBounds(),o=d.coords;return!!t&&(o.longitude<t.getWest()||o.longitude>t.getEast()||o.latitude<t.getSouth()||o.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(d){if(this._map){if(this._isOutOfMapMaxBounds(d))return this._setErrorState(),this.fire(new r.A("outofmaxbounds",d)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=d,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(d),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(d),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.A("geolocate",d)),this._finish()}}_updateCamera(d){let t=new r.ci(d.coords.longitude,d.coords.latitude),o=d.coords.accuracy,h=this._map.getBearing(),g=r.h({bearing:h},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(o),g,{geolocateSource:!0})}_updateMarker(d){if(d){let t=new r.ci(d.coords.longitude,d.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=d.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let d=this._map.transform,t=r.cb(1,d._center.lat)*d.worldSize,o=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(d){if(this._map){if(this.options.trackUserLocation)if(d.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(d.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.A("error",d)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(d){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=Oe("button","mapboxgl-ctrl-geolocate",this._container),Oe("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",d===!1){r.w("Geolocation support is not available so the GeolocateControl will be disabled.");let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{let t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Oe("div","mapboxgl-user-location"),this._dotElement.appendChild(Oe("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Oe("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Oo({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Oe("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Oo({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new r.A("trackuserlocationend")))})}}_onDeviceOrientation(d){this._userLocationDotMarker&&(d.webkitCompassHeading?this._heading=d.webkitCompassHeading:d.absolute===!0&&(this._heading=-1*d.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return r.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new r.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new r.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new r.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let d;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(d={maximumAge:6e5,timeout:0},this._noTimeout=!0):(d=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,d),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let d=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&d()}).catch(console.error):d()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Sc,ScaleControl:class{constructor(d={}){this.options=r.h({},n1,d),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),r.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let d=this.options.maxWidth||100,t=this._map,o=t._containerHeight/2,h=t._containerWidth/2-d/2,g=t.unproject([h,o]),_=t.unproject([h+d,o]),v=g.distanceTo(_);if(this.options.unit==="imperial"){let E=3.2808*v;E>5280?this._setScale(d,E/5280,"mile"):this._setScale(d,E,"foot")}else this.options.unit==="nautical"?this._setScale(d,v/1852,"nautical-mile"):v>=1e3?this._setScale(d,v/1e3,"kilometer"):this._setScale(d,v,"meter")}_setScale(d,t,o){this._map._requestDomTask(()=>{let h=function(_){let v=Math.pow(10,`${Math.floor(_)}`.length-1),E=_/v;return E=E>=10?10:E>=5?5:E>=3?3:E>=2?2:E>=1?1:function(T){let C=Math.pow(10,Math.ceil(-Math.log(T)/Math.LN10));return Math.round(T*C)/C}(E),v*E}(t),g=h/t;this._container.innerHTML=this._isNumberFormatSupported&&o!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:o}).format(h):`${h}&nbsp;${r1[o]}`,this._container.style.width=d*g+"px"})}onAdd(d){return this._map=d,this._language=d.getLanguage(),this._container=Oe("div","mapboxgl-ctrl mapboxgl-ctrl-scale",d.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(d){this._language=d,this._update()}setUnit(d){this.options.unit=d,this._update()}},FullscreenControl:class{constructor(d={}){this._fullscreen=!1,d&&d.container&&(d.container instanceof HTMLElement?this._container=d.container:r.w("Full screen control 'container' must be a DOM element.")),r.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(d){return this._map=d,this._container||(this._container=this._map.getContainer()),this._controlContainer=Oe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",r.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let d=this._fullscreenButton=Oe("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Oe("span","mapboxgl-ctrl-icon",d).setAttribute("aria-hidden","true"),d.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let d=this._getTitle();this._fullscreenButton.setAttribute("aria-label",d),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",d)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Om,Popup:class extends r.E{constructor(d){super(),this.options=r.h(Object.create(i1),d),this._altitude=this.options.altitude,r.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(d&&d.className?d.className.trim().split(/\s+/):[])}addTo(d){return this._map&&this.remove(),this._map=d,this.options.closeOnClick&&d.on("preclick",this._onClose),this.options.closeOnMove&&d.on("move",this._onClose),d.on("remove",this.remove),this._update(),d._addPopup(this),this._focusFirstElement(),this._trackPointer?(d.on("mousemove",this._onMouseEvent),d.on("mouseup",this._onMouseEvent),d._canvasContainer.classList.add("mapboxgl-track-pointer")):d.on("move",this._update),this.fire(new r.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let d=this._map;return d&&(d.off("move",this._update),d.off("move",this._onClose),d.off("preclick",this._onClose),d.off("click",this._onClose),d.off("remove",this.remove),d.off("mousemove",this._onMouseEvent),d.off("mouseup",this._onMouseEvent),d.off("drag",this._onMouseEvent),d._canvasContainer&&d._canvasContainer.classList.remove("mapboxgl-track-pointer"),d._removePopup(this),this._map=void 0),this.fire(new r.A("close")),this}getLngLat(){return this._lngLat}setLngLat(d){this._lngLat=r.ci.convert(d),this._pos=null,this._trackPointer=!1,this._update();let t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(d){return this._altitude=d,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let d=this._map;return d&&(d.off("move",this._update),d.on("mousemove",this._onMouseEvent),d.on("drag",this._onMouseEvent),d._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(d){return this.setDOMContent(document.createTextNode(d))}setHTML(d){let t=document.createDocumentFragment(),o=document.createElement("body"),h;for(o.innerHTML=d;h=o.firstChild,h;)t.appendChild(h);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(d){return this.options.maxWidth=d,this._update(),this}setDOMContent(d){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=Oe("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(d),this.options.closeButton){let o=this._closeButton=Oe("button","mapboxgl-popup-close-button",t);o.type="button",o.setAttribute("aria-label","Close popup"),o.innerHTML='<span aria-hidden="true">&#215;</span>',o.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(d){return this._classList.add(d),this._updateClassList(),this}removeClassName(d){return this._classList.delete(d),this._updateClassList(),this}setOffset(d){return this.options.offset=d,this._update(),this}toggleClassName(d){let t;return this._classList.delete(d)?t=!1:(this._classList.add(d),t=!0),this._updateClassList(),t}_onMouseEvent(d){this._update(d.point)}_getAnchor(d){if(this.options.anchor)return this.options.anchor;let t=this._map,o=this._container,h=this._pos;if(!t||!o||!h)return"bottom";let g=o.offsetWidth,_=o.offsetHeight,v=h.x<g/2,E=h.x>t.transform.width-g/2;if(h.y+d<_)return v?"top-left":E?"top-right":"top";if(h.y>t.transform.height-_){if(v)return"bottom-left";if(E)return"bottom-right"}return v?"left":E?"right":"bottom"}_updateClassList(){let d=this._container;if(!d)return;let t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),d.className=t.join(" ")}_update(d){let t=this._map,o=this._content;if(!t||!this._lngLat&&!this._trackPointer||!o)return;let h=this._container;if(h||(h=this._container=Oe("div","mapboxgl-popup",t.getContainer()),this._tip=Oe("div","mapboxgl-popup-tip",h),h.appendChild(o)),this.options.maxWidth&&h.style.maxWidth!==this.options.maxWidth&&(h.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=ts(this._lngLat,this._pos,t.transform)),!this._trackPointer||d){let g=this._pos=this._trackPointer&&d instanceof r.P?d:t.project(this._lngLat,this._altitude),_=Fi(this.options.offset),v=this._anchor=this._getAnchor(_.y),E=Fi(this.options.offset,v),T=g.add(E).round();t._requestDomTask(()=>{this._container&&v&&(this._container.style.transform=`${Po[v]} translate(${T.x}px,${T.y}px)`)})}if(!this._marker&&t._showingGlobe()){let g=r.eW(t.transform,this._lngLat)?0:1;this._setOpacity(g)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let d=this._container.querySelector(Zy);d&&d.focus()}_onClose(){this.remove()}_setOpacity(d){this._container&&(this._container.style.opacity=`${d}`),this._content&&(this._content.style.pointerEvents=d?"auto":"none")}},Marker:Oo,Style:Jo,LngLat:r.ci,LngLatBounds:r.aG,Point:r.P,MercatorCoordinate:r.ac,FreeCameraOptions:Y_,Evented:r.E,config:r.e,prewarm:r.e_,clearPrewarmedResources:r.eZ,get accessToken(){return r.e.ACCESS_TOKEN},set accessToken(d){r.e.ACCESS_TOKEN=d},get baseApiUrl(){return r.e.API_URL},set baseApiUrl(d){r.e.API_URL=d},get workerCount(){return r.f7.workerCount},set workerCount(d){r.f7.workerCount=d},get maxParallelImageRequests(){return r.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(d){r.e.MAX_PARALLEL_IMAGE_REQUESTS=d},clearStorage(d){r.f6(d)},get workerUrl(){return r.f5.workerUrl},set workerUrl(d){r.f5.workerUrl=d},get workerClass(){return r.f5.workerClass},set workerClass(d){r.f5.workerClass=d},get workerParams(){return r.f5.workerParams},set workerParams(d){r.f5.workerParams=d},get dracoUrl(){return r.f4()},set dracoUrl(d){r.f3(d)},get meshoptUrl(){return r.f2()},set meshoptUrl(d){r.f1(d)},setNow:r.q.setNow,restoreNow:r.q.restoreNow}});var b=l;return b})});var bF=yM((Uie,xb)=>{"use strict";var Wd={};function vF(a){return Math.floor(Math.abs(a)+.5)*(a>=0?1:-1)}function vb(a,u,l){a=vF(a*l),u=vF(u*l);var m=(a-u)*2;m<0&&(m=-m-1);for(var b="";m>=32;)b+=String.fromCharCode((32|m&31)+63),m/=32;return b+=String.fromCharCode((m|0)+63),b}Wd.decode=function(a,u){for(var l=0,m=0,b=0,r=[],M=0,k=0,U=null,ae,Ee,Be=Math.pow(10,Number.isInteger(u)?u:5);l<a.length;){U=null,M=1,k=0;do U=a.charCodeAt(l++)-63,k+=(U&31)*M,M*=32;while(U>=32);ae=k&1?(-k-1)/2:k/2,M=1,k=0;do U=a.charCodeAt(l++)-63,k+=(U&31)*M,M*=32;while(U>=32);Ee=k&1?(-k-1)/2:k/2,m+=ae,b+=Ee,r.push([m/Be,b/Be])}return r};Wd.encode=function(a,u){if(!a.length)return"";for(var l=Math.pow(10,Number.isInteger(u)?u:5),m=vb(a[0][0],0,l)+vb(a[0][1],0,l),b=1;b<a.length;b++){var r=a[b],M=a[b-1];m+=vb(r[0],M[0],l),m+=vb(r[1],M[1],l)}return m};function xF(a){for(var u=[],l=0;l<a.length;l++){var m=a[l].slice();u.push([m[1],m[0]])}return u}Wd.fromGeoJSON=function(a,u){if(a&&a.type==="Feature"&&(a=a.geometry),!a||a.type!=="LineString")throw new Error("Input must be a GeoJSON LineString");return Wd.encode(xF(a.coordinates),u)};Wd.toGeoJSON=function(a,u){var l=Wd.decode(a,u);return{type:"LineString",coordinates:xF(l)}};typeof xb=="object"&&xb.exports&&(xb.exports=Wd)});var Ew;function Wv(){return Ew}function Va(a){let u=Ew;return Ew=a,u}var vM=Symbol("NotFound");function mf(a){return a===vM||a?.name==="\u0275NotFound"}function xM(a,u){return Object.is(a,u)}var vo=null,Zv=!1,Iw=1,o3=null,Tl=Symbol("SIGNAL");function pr(a){let u=vo;return vo=a,u}function qv(){return vo}var Xv={version:0,lastCleanEpoch:0,dirty:!1,producers:void 0,producersTail:void 0,consumers:void 0,consumersTail:void 0,recomputing:!1,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,kind:"unknown",producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function Yv(a){if(Zv)throw new Error("");if(vo===null)return;vo.consumerOnSignalRead(a);let u=vo.producersTail;if(u!==void 0&&u.producer===a)return;let l,m=vo.recomputing;if(m&&(l=u!==void 0?u.nextProducer:vo.producers,l!==void 0&&l.producer===a)){vo.producersTail=l,l.lastReadVersion=a.version;return}let b=a.consumersTail;if(b!==void 0&&b.consumer===vo&&(!m||a3(b,vo)))return;let r=gf(vo),M={producer:a,consumer:vo,nextProducer:l,prevConsumer:b,lastReadVersion:a.version,nextConsumer:void 0};vo.producersTail=M,u!==void 0?u.nextProducer=M:vo.producers=M,r&&EM(a,M)}function bM(){Iw++}function wM(a){if(!(gf(a)&&!a.dirty)&&!(!a.dirty&&a.lastCleanEpoch===Iw)){if(!a.producerMustRecompute(a)&&!Jv(a)){Tw(a);return}a.producerRecomputeValue(a),Tw(a)}}function Sw(a){if(a.consumers===void 0)return;let u=Zv;Zv=!0;try{for(let l=a.consumers;l!==void 0;l=l.nextConsumer){let m=l.consumer;m.dirty||s3(m)}}finally{Zv=u}}function Dw(){return vo?.consumerAllowSignalWrites!==!1}function s3(a){a.dirty=!0,Sw(a),a.consumerMarkedDirty?.(a)}function Tw(a){a.dirty=!1,a.lastCleanEpoch=Iw}function Kv(a){return a&&(a.producersTail=void 0,a.recomputing=!0),pr(a)}function Cw(a,u){if(pr(u),!a)return;a.recomputing=!1;let l=a.producersTail,m=l!==void 0?l.nextProducer:a.producers;if(m!==void 0){if(gf(a))do m=Mw(m);while(m!==void 0);l!==void 0?l.nextProducer=void 0:a.producers=void 0}}function Jv(a){for(let u=a.producers;u!==void 0;u=u.nextProducer){let l=u.producer,m=u.lastReadVersion;if(m!==l.version||(wM(l),m!==l.version))return!0}return!1}function Aw(a){if(gf(a)){let u=a.producers;for(;u!==void 0;)u=Mw(u)}a.producers=void 0,a.producersTail=void 0,a.consumers=void 0,a.consumersTail=void 0}function EM(a,u){let l=a.consumersTail,m=gf(a);if(l!==void 0?(u.nextConsumer=l.nextConsumer,l.nextConsumer=u):(u.nextConsumer=void 0,a.consumers=u),u.prevConsumer=l,a.consumersTail=u,!m)for(let b=a.producers;b!==void 0;b=b.nextProducer)EM(b.producer,b)}function Mw(a){let u=a.producer,l=a.nextProducer,m=a.nextConsumer,b=a.prevConsumer;if(a.nextConsumer=void 0,a.prevConsumer=void 0,m!==void 0?m.prevConsumer=b:u.consumersTail=b,b!==void 0)b.nextConsumer=m;else if(u.consumers=m,!gf(u)){let r=u.producers;for(;r!==void 0;)r=Mw(r)}return l}function gf(a){return a.consumerIsAlwaysLive||a.consumers!==void 0}function TM(a){o3?.(a)}function a3(a,u){let l=u.producersTail;if(l!==void 0){let m=u.producers;do{if(m===a)return!0;if(m===l)break;m=m.nextProducer}while(m!==void 0)}return!1}function l3(){throw new Error}var IM=l3;function SM(a){IM(a)}function Rw(a){IM=a}var c3=null;function Pw(a,u){let l=Object.create(Qv);l.value=a,u!==void 0&&(l.equal=u);let m=()=>DM(l);return m[Tl]=l,TM(l),[m,M=>xg(l,M),M=>CM(l,M)]}function DM(a){return Yv(a),a.value}function xg(a,u){Dw()||SM(a),a.equal(a.value,u)||(a.value=u,u3(a))}function CM(a,u){Dw()||SM(a),xg(a,u(a.value))}var Qv=Vr($t({},Xv),{equal:xM,value:void 0,kind:"signal"});function u3(a){a.version++,bM(),Sw(a),c3?.(a)}function qn(a){return typeof a=="function"}function _f(a){let l=a(m=>{Error.call(m),m.stack=new Error().stack});return l.prototype=Object.create(Error.prototype),l.prototype.constructor=l,l}var e0=_f(a=>function(l){a(this),this.message=l?`${l.length} errors occurred during unsubscription:
${l.map((m,b)=>`${b+1}) ${m.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=l});function bg(a,u){if(a){let l=a.indexOf(u);0<=l&&a.splice(l,1)}}var _i=class a{constructor(u){this.initialTeardown=u,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let u;if(!this.closed){this.closed=!0;let{_parentage:l}=this;if(l)if(this._parentage=null,Array.isArray(l))for(let r of l)r.remove(this);else l.remove(this);let{initialTeardown:m}=this;if(qn(m))try{m()}catch(r){u=r instanceof e0?r.errors:[r]}let{_finalizers:b}=this;if(b){this._finalizers=null;for(let r of b)try{AM(r)}catch(M){u=u??[],M instanceof e0?u=[...u,...M.errors]:u.push(M)}}if(u)throw new e0(u)}}add(u){var l;if(u&&u!==this)if(this.closed)AM(u);else{if(u instanceof a){if(u.closed||u._hasParent(this))return;u._addParent(this)}(this._finalizers=(l=this._finalizers)!==null&&l!==void 0?l:[]).push(u)}}_hasParent(u){let{_parentage:l}=this;return l===u||Array.isArray(l)&&l.includes(u)}_addParent(u){let{_parentage:l}=this;this._parentage=Array.isArray(l)?(l.push(u),l):l?[l,u]:u}_removeParent(u){let{_parentage:l}=this;l===u?this._parentage=null:Array.isArray(l)&&bg(l,u)}remove(u){let{_finalizers:l}=this;l&&bg(l,u),u instanceof a&&u._removeParent(this)}};_i.EMPTY=(()=>{let a=new _i;return a.closed=!0,a})();var Ow=_i.EMPTY;function t0(a){return a instanceof _i||a&&"closed"in a&&qn(a.remove)&&qn(a.add)&&qn(a.unsubscribe)}function AM(a){qn(a)?a():a.unsubscribe()}var Ks={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var yf={setTimeout(a,u,...l){let{delegate:m}=yf;return m?.setTimeout?m.setTimeout(a,u,...l):setTimeout(a,u,...l)},clearTimeout(a){let{delegate:u}=yf;return(u?.clearTimeout||clearTimeout)(a)},delegate:void 0};function n0(a){yf.setTimeout(()=>{let{onUnhandledError:u}=Ks;if(u)u(a);else throw a})}function wg(){}var MM=Lw("C",void 0,void 0);function RM(a){return Lw("E",void 0,a)}function PM(a){return Lw("N",a,void 0)}function Lw(a,u,l){return{kind:a,value:u,error:l}}var dd=null;function vf(a){if(Ks.useDeprecatedSynchronousErrorHandling){let u=!dd;if(u&&(dd={errorThrown:!1,error:null}),a(),u){let{errorThrown:l,error:m}=dd;if(dd=null,l)throw m}}else a()}function OM(a){Ks.useDeprecatedSynchronousErrorHandling&&dd&&(dd.errorThrown=!0,dd.error=a)}var hd=class extends _i{constructor(u){super(),this.isStopped=!1,u?(this.destination=u,t0(u)&&u.add(this)):this.destination=f3}static create(u,l,m){return new xf(u,l,m)}next(u){this.isStopped?kw(PM(u),this):this._next(u)}error(u){this.isStopped?kw(RM(u),this):(this.isStopped=!0,this._error(u))}complete(){this.isStopped?kw(MM,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(u){this.destination.next(u)}_error(u){try{this.destination.error(u)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},d3=Function.prototype.bind;function Fw(a,u){return d3.call(a,u)}var Nw=class{constructor(u){this.partialObserver=u}next(u){let{partialObserver:l}=this;if(l.next)try{l.next(u)}catch(m){r0(m)}}error(u){let{partialObserver:l}=this;if(l.error)try{l.error(u)}catch(m){r0(m)}else r0(u)}complete(){let{partialObserver:u}=this;if(u.complete)try{u.complete()}catch(l){r0(l)}}},xf=class extends hd{constructor(u,l,m){super();let b;if(qn(u)||!u)b={next:u??void 0,error:l??void 0,complete:m??void 0};else{let r;this&&Ks.useDeprecatedNextContext?(r=Object.create(u),r.unsubscribe=()=>this.unsubscribe(),b={next:u.next&&Fw(u.next,r),error:u.error&&Fw(u.error,r),complete:u.complete&&Fw(u.complete,r)}):b=u}this.destination=new Nw(b)}};function r0(a){Ks.useDeprecatedSynchronousErrorHandling?OM(a):n0(a)}function h3(a){throw a}function kw(a,u){let{onStoppedNotification:l}=Ks;l&&yf.setTimeout(()=>l(a,u))}var f3={closed:!0,next:wg,error:h3,complete:wg};var bf=typeof Symbol=="function"&&Symbol.observable||"@@observable";function ms(a){return a}function zw(...a){return Bw(a)}function Bw(a){return a.length===0?ms:a.length===1?a[0]:function(l){return a.reduce((m,b)=>b(m),l)}}var br=(()=>{class a{constructor(l){l&&(this._subscribe=l)}lift(l){let m=new a;return m.source=this,m.operator=l,m}subscribe(l,m,b){let r=m3(l)?l:new xf(l,m,b);return vf(()=>{let{operator:M,source:k}=this;r.add(M?M.call(r,k):k?this._subscribe(r):this._trySubscribe(r))}),r}_trySubscribe(l){try{return this._subscribe(l)}catch(m){l.error(m)}}forEach(l,m){return m=LM(m),new m((b,r)=>{let M=new xf({next:k=>{try{l(k)}catch(U){r(U),M.unsubscribe()}},error:r,complete:b});this.subscribe(M)})}_subscribe(l){var m;return(m=this.source)===null||m===void 0?void 0:m.subscribe(l)}[bf](){return this}pipe(...l){return Bw(l)(this)}toPromise(l){return l=LM(l),new l((m,b)=>{let r;this.subscribe(M=>r=M,M=>b(M),()=>m(r))})}}return a.create=u=>new a(u),a})();function LM(a){var u;return(u=a??Ks.Promise)!==null&&u!==void 0?u:Promise}function p3(a){return a&&qn(a.next)&&qn(a.error)&&qn(a.complete)}function m3(a){return a&&a instanceof hd||p3(a)&&t0(a)}function Vw(a){return qn(a?.lift)}function Tr(a){return u=>{if(Vw(u))return u.lift(function(l){try{return a(l,this)}catch(m){this.error(m)}});throw new TypeError("Unable to lift unknown Observable type")}}function Ir(a,u,l,m,b){return new Uw(a,u,l,m,b)}var Uw=class extends hd{constructor(u,l,m,b,r,M){super(u),this.onFinalize=r,this.shouldUnsubscribe=M,this._next=l?function(k){try{l(k)}catch(U){u.error(U)}}:super._next,this._error=b?function(k){try{b(k)}catch(U){u.error(U)}finally{this.unsubscribe()}}:super._error,this._complete=m?function(){try{m()}catch(k){u.error(k)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var u;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:l}=this;super.unsubscribe(),!l&&((u=this.onFinalize)===null||u===void 0||u.call(this))}}};function wf(){return Tr((a,u)=>{let l=null;a._refCount++;let m=Ir(u,void 0,void 0,void 0,()=>{if(!a||a._refCount<=0||0<--a._refCount){l=null;return}let b=a._connection,r=l;l=null,b&&(!r||b===r)&&b.unsubscribe(),u.unsubscribe()});a.subscribe(m),m.closed||(l=a.connect())})}var Ef=class extends br{constructor(u,l){super(),this.source=u,this.subjectFactory=l,this._subject=null,this._refCount=0,this._connection=null,Vw(u)&&(this.lift=u.lift)}_subscribe(u){return this.getSubject().subscribe(u)}getSubject(){let u=this._subject;return(!u||u.isStopped)&&(this._subject=this.subjectFactory()),this._subject}_teardown(){this._refCount=0;let{_connection:u}=this;this._subject=this._connection=null,u?.unsubscribe()}connect(){let u=this._connection;if(!u){u=this._connection=new _i;let l=this.getSubject();u.add(this.source.subscribe(Ir(l,void 0,()=>{this._teardown(),l.complete()},m=>{this._teardown(),l.error(m)},()=>this._teardown()))),u.closed&&(this._connection=null,u=_i.EMPTY)}return u}refCount(){return wf()(this)}};var FM=_f(a=>function(){a(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var Ai=(()=>{class a extends br{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(l){let m=new i0(this,this);return m.operator=l,m}_throwIfClosed(){if(this.closed)throw new FM}next(l){vf(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let m of this.currentObservers)m.next(l)}})}error(l){vf(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=l;let{observers:m}=this;for(;m.length;)m.shift().error(l)}})}complete(){vf(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:l}=this;for(;l.length;)l.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var l;return((l=this.observers)===null||l===void 0?void 0:l.length)>0}_trySubscribe(l){return this._throwIfClosed(),super._trySubscribe(l)}_subscribe(l){return this._throwIfClosed(),this._checkFinalizedStatuses(l),this._innerSubscribe(l)}_innerSubscribe(l){let{hasError:m,isStopped:b,observers:r}=this;return m||b?Ow:(this.currentObservers=null,r.push(l),new _i(()=>{this.currentObservers=null,bg(r,l)}))}_checkFinalizedStatuses(l){let{hasError:m,thrownError:b,isStopped:r}=this;m?l.error(b):r&&l.complete()}asObservable(){let l=new br;return l.source=this,l}}return a.create=(u,l)=>new i0(u,l),a})(),i0=class extends Ai{constructor(u,l){super(),this.destination=u,this.source=l}next(u){var l,m;(m=(l=this.destination)===null||l===void 0?void 0:l.next)===null||m===void 0||m.call(l,u)}error(u){var l,m;(m=(l=this.destination)===null||l===void 0?void 0:l.error)===null||m===void 0||m.call(l,u)}complete(){var u,l;(l=(u=this.destination)===null||u===void 0?void 0:u.complete)===null||l===void 0||l.call(u)}_subscribe(u){var l,m;return(m=(l=this.source)===null||l===void 0?void 0:l.subscribe(u))!==null&&m!==void 0?m:Ow}};var oo=class extends Ai{constructor(u){super(),this._value=u}get value(){return this.getValue()}_subscribe(u){let l=super._subscribe(u);return!l.closed&&u.next(this._value),l}getValue(){let{hasError:u,thrownError:l,_value:m}=this;if(u)throw l;return this._throwIfClosed(),m}next(u){super.next(this._value=u)}};var Tf=class extends Ai{constructor(){super(...arguments),this._value=null,this._hasValue=!1,this._isComplete=!1}_checkFinalizedStatuses(u){let{hasError:l,_hasValue:m,_value:b,thrownError:r,isStopped:M,_isComplete:k}=this;l?u.error(r):(M||k)&&(m&&u.next(b),u.complete())}next(u){this.isStopped||(this._value=u,this._hasValue=!0)}complete(){let{_hasValue:u,_value:l,_isComplete:m}=this;m||(this._isComplete=!0,u&&super.next(l),super.complete())}};var rs=new br(a=>a.complete());function kM(a){return a&&qn(a.schedule)}function NM(a){return a[a.length-1]}function zM(a){return qn(NM(a))?a.pop():void 0}function Bc(a){return kM(NM(a))?a.pop():void 0}function VM(a,u,l,m){function b(r){return r instanceof l?r:new l(function(M){M(r)})}return new(l||(l=Promise))(function(r,M){function k(Ee){try{ae(m.next(Ee))}catch(Be){M(Be)}}function U(Ee){try{ae(m.throw(Ee))}catch(Be){M(Be)}}function ae(Ee){Ee.done?r(Ee.value):b(Ee.value).then(k,U)}ae((m=m.apply(a,u||[])).next())})}function BM(a){var u=typeof Symbol=="function"&&Symbol.iterator,l=u&&a[u],m=0;if(l)return l.call(a);if(a&&typeof a.length=="number")return{next:function(){return a&&m>=a.length&&(a=void 0),{value:a&&a[m++],done:!a}}};throw new TypeError(u?"Object is not iterable.":"Symbol.iterator is not defined.")}function fd(a){return this instanceof fd?(this.v=a,this):new fd(a)}function UM(a,u,l){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var m=l.apply(a,u||[]),b,r=[];return b=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),k("next"),k("throw"),k("return",M),b[Symbol.asyncIterator]=function(){return this},b;function M(Oe){return function(Ct){return Promise.resolve(Ct).then(Oe,Be)}}function k(Oe,Ct){m[Oe]&&(b[Oe]=function(Vt){return new Promise(function(Ut,Nt){r.push([Oe,Vt,Ut,Nt])>1||U(Oe,Vt)})},Ct&&(b[Oe]=Ct(b[Oe])))}function U(Oe,Ct){try{ae(m[Oe](Ct))}catch(Vt){ht(r[0][3],Vt)}}function ae(Oe){Oe.value instanceof fd?Promise.resolve(Oe.value.v).then(Ee,Be):ht(r[0][2],Oe)}function Ee(Oe){U("next",Oe)}function Be(Oe){U("throw",Oe)}function ht(Oe,Ct){Oe(Ct),r.shift(),r.length&&U(r[0][0],r[0][1])}}function jM(a){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var u=a[Symbol.asyncIterator],l;return u?u.call(a):(a=typeof BM=="function"?BM(a):a[Symbol.iterator](),l={},m("next"),m("throw"),m("return"),l[Symbol.asyncIterator]=function(){return this},l);function m(r){l[r]=a[r]&&function(M){return new Promise(function(k,U){M=a[r](M),b(k,U,M.done,M.value)})}}function b(r,M,k,U){Promise.resolve(U).then(function(ae){r({value:ae,done:k})},M)}}var o0=a=>a&&typeof a.length=="number"&&typeof a!="function";function s0(a){return qn(a?.then)}function a0(a){return qn(a[bf])}function l0(a){return Symbol.asyncIterator&&qn(a?.[Symbol.asyncIterator])}function c0(a){return new TypeError(`You provided ${a!==null&&typeof a=="object"?"an invalid object":`'${a}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function g3(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var u0=g3();function d0(a){return qn(a?.[u0])}function h0(a){return UM(this,arguments,function*(){let l=a.getReader();try{for(;;){let{value:m,done:b}=yield fd(l.read());if(b)return yield fd(void 0);yield yield fd(m)}}finally{l.releaseLock()}})}function f0(a){return qn(a?.getReader)}function $i(a){if(a instanceof br)return a;if(a!=null){if(a0(a))return _3(a);if(o0(a))return y3(a);if(s0(a))return v3(a);if(l0(a))return HM(a);if(d0(a))return x3(a);if(f0(a))return b3(a)}throw c0(a)}function _3(a){return new br(u=>{let l=a[bf]();if(qn(l.subscribe))return l.subscribe(u);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function y3(a){return new br(u=>{for(let l=0;l<a.length&&!u.closed;l++)u.next(a[l]);u.complete()})}function v3(a){return new br(u=>{a.then(l=>{u.closed||(u.next(l),u.complete())},l=>u.error(l)).then(null,n0)})}function x3(a){return new br(u=>{for(let l of a)if(u.next(l),u.closed)return;u.complete()})}function HM(a){return new br(u=>{w3(a,u).catch(l=>u.error(l))})}function b3(a){return HM(h0(a))}function w3(a,u){var l,m,b,r;return VM(this,void 0,void 0,function*(){try{for(l=jM(a);m=yield l.next(),!m.done;){let M=m.value;if(u.next(M),u.closed)return}}catch(M){b={error:M}}finally{try{m&&!m.done&&(r=l.return)&&(yield r.call(l))}finally{if(b)throw b.error}}u.complete()})}function is(a,u,l,m=0,b=!1){let r=u.schedule(function(){l(),b?a.add(this.schedule(null,m)):this.unsubscribe()},m);if(a.add(r),!b)return r}function p0(a,u=0){return Tr((l,m)=>{l.subscribe(Ir(m,b=>is(m,a,()=>m.next(b),u),()=>is(m,a,()=>m.complete(),u),b=>is(m,a,()=>m.error(b),u)))})}function m0(a,u=0){return Tr((l,m)=>{m.add(a.schedule(()=>l.subscribe(m),u))})}function GM(a,u){return $i(a).pipe(m0(u),p0(u))}function $M(a,u){return $i(a).pipe(m0(u),p0(u))}function WM(a,u){return new br(l=>{let m=0;return u.schedule(function(){m===a.length?l.complete():(l.next(a[m++]),l.closed||this.schedule())})})}function ZM(a,u){return new br(l=>{let m;return is(l,u,()=>{m=a[u0](),is(l,u,()=>{let b,r;try{({value:b,done:r}=m.next())}catch(M){l.error(M);return}r?l.complete():l.next(b)},0,!0)}),()=>qn(m?.return)&&m.return()})}function g0(a,u){if(!a)throw new Error("Iterable cannot be null");return new br(l=>{is(l,u,()=>{let m=a[Symbol.asyncIterator]();is(l,u,()=>{m.next().then(b=>{b.done?l.complete():l.next(b.value)})},0,!0)})})}function qM(a,u){return g0(h0(a),u)}function XM(a,u){if(a!=null){if(a0(a))return GM(a,u);if(o0(a))return WM(a,u);if(s0(a))return $M(a,u);if(l0(a))return g0(a,u);if(d0(a))return ZM(a,u);if(f0(a))return qM(a,u)}throw c0(a)}function yi(a,u){return u?XM(a,u):$i(a)}function In(...a){let u=Bc(a);return yi(a,u)}function If(a,u){let l=qn(a)?a:()=>a,m=b=>b.error(l());return new br(u?b=>u.schedule(m,0,b):m)}function jw(a){return!!a&&(a instanceof br||qn(a.lift)&&qn(a.subscribe))}var Js=_f(a=>function(){a(this),this.name="EmptyError",this.message="no elements in sequence"});function Hw(a,u){let l=typeof u=="object";return new Promise((m,b)=>{let r=!1,M;a.subscribe({next:k=>{M=k,r=!0},error:b,complete:()=>{r?m(M):l?m(u.defaultValue):b(new Js)}})})}function or(a,u){return Tr((l,m)=>{let b=0;l.subscribe(Ir(m,r=>{m.next(a.call(u,r,b++))}))})}var{isArray:E3}=Array;function T3(a,u){return E3(u)?a(...u):a(u)}function YM(a){return or(u=>T3(a,u))}var{isArray:I3}=Array,{getPrototypeOf:S3,prototype:D3,keys:C3}=Object;function KM(a){if(a.length===1){let u=a[0];if(I3(u))return{args:u,keys:null};if(A3(u)){let l=C3(u);return{args:l.map(m=>u[m]),keys:l}}}return{args:a,keys:null}}function A3(a){return a&&typeof a=="object"&&S3(a)===D3}function JM(a,u){return a.reduce((l,m,b)=>(l[m]=u[b],l),{})}function Eg(...a){let u=Bc(a),l=zM(a),{args:m,keys:b}=KM(a);if(m.length===0)return yi([],u);let r=new br(M3(m,u,b?M=>JM(b,M):ms));return l?r.pipe(YM(l)):r}function M3(a,u,l=ms){return m=>{QM(u,()=>{let{length:b}=a,r=new Array(b),M=b,k=b;for(let U=0;U<b;U++)QM(u,()=>{let ae=yi(a[U],u),Ee=!1;ae.subscribe(Ir(m,Be=>{r[U]=Be,Ee||(Ee=!0,k--),k||m.next(l(r.slice()))},()=>{--M||m.complete()}))},m)},m)}}function QM(a,u,l){a?is(l,a,u):u()}function eR(a,u,l,m,b,r,M,k){let U=[],ae=0,Ee=0,Be=!1,ht=()=>{Be&&!U.length&&!ae&&u.complete()},Oe=Vt=>ae<m?Ct(Vt):U.push(Vt),Ct=Vt=>{r&&u.next(Vt),ae++;let Ut=!1;$i(l(Vt,Ee++)).subscribe(Ir(u,Nt=>{b?.(Nt),r?Oe(Nt):u.next(Nt)},()=>{Ut=!0},void 0,()=>{if(Ut)try{for(ae--;U.length&&ae<m;){let Nt=U.shift();M?is(u,M,()=>Ct(Nt)):Ct(Nt)}ht()}catch(Nt){u.error(Nt)}}))};return a.subscribe(Ir(u,Oe,()=>{Be=!0,ht()})),()=>{k?.()}}function bi(a,u,l=1/0){return qn(u)?bi((m,b)=>or((r,M)=>u(m,r,b,M))($i(a(m,b))),l):(typeof u=="number"&&(l=u),Tr((m,b)=>eR(m,b,a,l)))}function Sf(a=1/0){return bi(ms,a)}function tR(){return Sf(1)}function Df(...a){return tR()(yi(a,Bc(a)))}function Tg(a){return new br(u=>{$i(a()).subscribe(u)})}function xo(a,u){return Tr((l,m)=>{let b=0;l.subscribe(Ir(m,r=>a.call(u,r,b++)&&m.next(r)))})}function Il(a){return Tr((u,l)=>{let m=null,b=!1,r;m=u.subscribe(Ir(l,void 0,void 0,M=>{r=$i(a(M,Il(a)(u))),m?(m.unsubscribe(),m=null,r.subscribe(l)):b=!0})),b&&(m.unsubscribe(),m=null,r.subscribe(l))})}function nR(a,u,l,m,b){return(r,M)=>{let k=l,U=u,ae=0;r.subscribe(Ir(M,Ee=>{let Be=ae++;U=k?a(U,Ee,Be):(k=!0,Ee),m&&M.next(U)},b&&(()=>{k&&M.next(U),M.complete()})))}}function Ua(a,u){return qn(u)?bi(a,u,1):bi(a,1)}function Vc(a){return Tr((u,l)=>{let m=!1;u.subscribe(Ir(l,b=>{m=!0,l.next(b)},()=>{m||l.next(a),l.complete()}))})}function Sl(a){return a<=0?()=>rs:Tr((u,l)=>{let m=0;u.subscribe(Ir(l,b=>{++m<=a&&(l.next(b),a<=m&&l.complete())}))})}function _0(a=R3){return Tr((u,l)=>{let m=!1;u.subscribe(Ir(l,b=>{m=!0,l.next(b)},()=>m?l.complete():l.error(a())))})}function R3(){return new Js}function Uc(a){return Tr((u,l)=>{try{u.subscribe(l)}finally{l.add(a)}})}function Dl(a,u){let l=arguments.length>=2;return m=>m.pipe(a?xo((b,r)=>a(b,r,m)):ms,Sl(1),l?Vc(u):_0(()=>new Js))}function Cf(a){return a<=0?()=>rs:Tr((u,l)=>{let m=[];u.subscribe(Ir(l,b=>{m.push(b),a<m.length&&m.shift()},()=>{for(let b of m)l.next(b);l.complete()},void 0,()=>{m=null}))})}function Gw(a,u){let l=arguments.length>=2;return m=>m.pipe(a?xo((b,r)=>a(b,r,m)):ms,Cf(1),l?Vc(u):_0(()=>new Js))}function $w(a,u){return Tr(nR(a,u,arguments.length>=2,!0))}function Ww(...a){let u=Bc(a);return Tr((l,m)=>{(u?Df(a,l,u):Df(a,l)).subscribe(m)})}function Vo(a,u){return Tr((l,m)=>{let b=null,r=0,M=!1,k=()=>M&&!b&&m.complete();l.subscribe(Ir(m,U=>{b?.unsubscribe();let ae=0,Ee=r++;$i(a(U,Ee)).subscribe(b=Ir(m,Be=>m.next(u?u(U,Be,Ee,ae++):Be),()=>{b=null,k()}))},()=>{M=!0,k()}))})}function y0(a){return Tr((u,l)=>{$i(a).subscribe(Ir(l,()=>l.complete(),wg)),!l.closed&&u.subscribe(l)})}function Wi(a,u,l){let m=qn(a)||u||l?{next:a,error:u,complete:l}:a;return m?Tr((b,r)=>{var M;(M=m.subscribe)===null||M===void 0||M.call(m);let k=!0;b.subscribe(Ir(r,U=>{var ae;(ae=m.next)===null||ae===void 0||ae.call(m,U),r.next(U)},()=>{var U;k=!1,(U=m.complete)===null||U===void 0||U.call(m),r.complete()},U=>{var ae;k=!1,(ae=m.error)===null||ae===void 0||ae.call(m,U),r.error(U)},()=>{var U,ae;k&&((U=m.unsubscribe)===null||U===void 0||U.call(m)),(ae=m.finalize)===null||ae===void 0||ae.call(m)}))}):ms}var iE="https://angular.dev/best-practices/security#preventing-cross-site-scripting-xss",en=class extends Error{code;constructor(u,l){super(vd(u,l)),this.code=u}};function O3(a){return`NG0${Math.abs(a)}`}function vd(a,u){return`${O3(a)}${u?": "+u:""}`}var ea=globalThis;function Ur(a){for(let u in a)if(a[u]===Ur)return u;throw Error("")}function jc(a){if(typeof a=="string")return a;if(Array.isArray(a))return`[${a.map(jc).join(", ")}]`;if(a==null)return""+a;let u=a.overriddenName||a.name;if(u)return`${u}`;let l=a.toString();if(l==null)return""+l;let m=l.indexOf(`
`);return m>=0?l.slice(0,m):l}function E0(a,u){return a?u?`${a} ${u}`:a:u||""}var L3=Ur({__forward_ref__:Ur});function T0(a){return a.__forward_ref__=T0,a.toString=function(){return jc(this())},a}function so(a){return oE(a)?a():a}function oE(a){return typeof a=="function"&&a.hasOwnProperty(L3)&&a.__forward_ref__===T0}function oR(a,u){a==null&&sE(u,a,null,"!=")}function sE(a,u,l,m){throw new Error(`ASSERTION ERROR: ${a}`+(m==null?"":` [Expected=> ${l} ${m} ${u} <=Actual]`))}function Zt(a){return{token:a.token,providedIn:a.providedIn||null,factory:a.factory,value:void 0}}function bo(a){return{providers:a.providers||[],imports:a.imports||[]}}function Ag(a){return F3(a,I0)}function aE(a){return Ag(a)!==null}function F3(a,u){return a.hasOwnProperty(u)&&a[u]||null}function k3(a){let u=a?.[I0]??null;return u||null}function qw(a){return a&&a.hasOwnProperty(x0)?a[x0]:null}var I0=Ur({\u0275prov:Ur}),x0=Ur({\u0275inj:Ur}),Kt=class{_desc;ngMetadataName="InjectionToken";\u0275prov;constructor(u,l){this._desc=u,this.\u0275prov=void 0,typeof l=="number"?this.__NG_ELEMENT_ID__=l:l!==void 0&&(this.\u0275prov=Zt({token:this,providedIn:l.providedIn||"root",factory:l.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function lE(a){return a&&!!a.\u0275providers}var cE=Ur({\u0275cmp:Ur}),uE=Ur({\u0275dir:Ur}),dE=Ur({\u0275pipe:Ur}),hE=Ur({\u0275mod:Ur}),Dg=Ur({\u0275fac:Ur}),xd=Ur({__NG_ELEMENT_ID__:Ur}),rR=Ur({__NG_ENV_ID__:Ur});function sR(a){return typeof a=="string"?a:a==null?"":String(a)}function b0(a){return typeof a=="function"?a.name||a.toString():typeof a=="object"&&a!=null&&typeof a.type=="function"?a.type.name||a.type.toString():sR(a)}var fE=Ur({ngErrorCode:Ur}),aR=Ur({ngErrorMessage:Ur}),Sg=Ur({ngTokenPath:Ur});function pE(a,u){return lR("",-200,u)}function S0(a,u){throw new en(-201,!1)}function N3(a,u){a[Sg]??=[];let l=a[Sg],m;typeof u=="object"&&"multi"in u&&u?.multi===!0?(oR(u.provide,"Token with multi: true should have a provide property"),m=b0(u.provide)):m=b0(u),l[0]!==m&&a[Sg].unshift(m)}function z3(a,u){let l=a[Sg],m=a[fE],b=a[aR]||a.message;return a.message=V3(b,m,l,u),a}function lR(a,u,l){let m=new en(u,a);return m[fE]=u,m[aR]=a,l&&(m[Sg]=l),m}function B3(a){return a[fE]}function V3(a,u,l=[],m=null){let b="";l&&l.length>1&&(b=` Path: ${l.join(" -> ")}.`);let r=m?` Source: ${m}.`:"";return vd(u,`${a}${r}${b}`)}var Xw;function cR(){return Xw}function gs(a){let u=Xw;return Xw=a,u}function mE(a,u,l){let m=Ag(a);if(m&&m.providedIn=="root")return m.value===void 0?m.value=m.factory():m.value;if(l&8)return null;if(u!==void 0)return u;S0(a,"Injector")}var U3={},pd=U3,j3="__NG_DI_FLAG__",Yw=class{injector;constructor(u){this.injector=u}retrieve(u,l){let m=md(l)||0;try{return this.injector.get(u,m&8?null:pd,m)}catch(b){if(mf(b))return b;throw b}}};function H3(a,u=0){let l=Wv();if(l===void 0)throw new en(-203,!1);if(l===null)return mE(a,void 0,u);{let m=G3(u),b=l.retrieve(a,m);if(mf(b)){if(m.optional)return null;throw b}return b}}function ln(a,u=0){return(cR()||H3)(so(a),u)}function ut(a,u){return ln(a,md(u))}function md(a){return typeof a>"u"||typeof a=="number"?a:0|(a.optional&&8)|(a.host&&1)|(a.self&&2)|(a.skipSelf&&4)}function G3(a){return{optional:!!(a&8),host:!!(a&1),self:!!(a&2),skipSelf:!!(a&4)}}function Kw(a){let u=[];for(let l=0;l<a.length;l++){let m=so(a[l]);if(Array.isArray(m)){if(m.length===0)throw new en(900,!1);let b,r=0;for(let M=0;M<m.length;M++){let k=m[M],U=$3(k);typeof U=="number"?U===-1?b=k.token:r|=U:b=k}u.push(ln(b,r))}else u.push(ln(m))}return u}function $3(a){return a[j3]}function gd(a,u){let l=a.hasOwnProperty(Dg);return l?a[Dg]:null}function uR(a,u,l){if(a.length!==u.length)return!1;for(let m=0;m<a.length;m++){let b=a[m],r=u[m];if(l&&(b=l(b),r=l(r)),r!==b)return!1}return!0}function dR(a){return a.flat(Number.POSITIVE_INFINITY)}function D0(a,u){a.forEach(l=>Array.isArray(l)?D0(l,u):u(l))}function gE(a,u,l){u>=a.length?a.push(l):a.splice(u,0,l)}function Mg(a,u){return u>=a.length-1?a.pop():a.splice(u,1)[0]}function hR(a,u){let l=[];for(let m=0;m<a;m++)l.push(u);return l}function fR(a,u,l,m){let b=a.length;if(b==u)a.push(l,m);else if(b===1)a.push(m,a[0]),a[0]=l;else{for(b--,a.push(a[b-1],a[b]);b>u;){let r=b-2;a[b]=a[r],b--}a[u]=l,a[u+1]=m}}function _E(a,u,l){let m=Mf(a,u);return m>=0?a[m|1]=l:(m=~m,fR(a,m,u,l)),m}function C0(a,u){let l=Mf(a,u);if(l>=0)return a[l|1]}function Mf(a,u){return W3(a,u,1)}function W3(a,u,l){let m=0,b=a.length>>l;for(;b!==m;){let r=m+(b-m>>1),M=a[r<<l];if(u===M)return r<<l;M>u?b=r:m=r+1}return~(b<<l)}var bd={},os=[],Ml=new Kt(""),yE=new Kt("",-1),vE=new Kt(""),Cg=class{get(u,l=pd){if(l===pd){let b=lR("",-201);throw b.name="\u0275NotFound",b}return l}};function xE(a){return a[hE]||null}function Rl(a){return a[cE]||null}function bE(a){return a[uE]||null}function pR(a){return a[dE]||null}function Gc(a){return{\u0275providers:a}}function mR(a){return Gc([{provide:Ml,multi:!0,useValue:a}])}function gR(...a){return{\u0275providers:wE(!0,a),\u0275fromNgModule:!0}}function wE(a,...u){let l=[],m=new Set,b,r=M=>{l.push(M)};return D0(u,M=>{let k=M;w0(k,r,[],m)&&(b||=[],b.push(k))}),b!==void 0&&_R(b,r),l}function _R(a,u){for(let l=0;l<a.length;l++){let{ngModule:m,providers:b}=a[l];EE(b,r=>{u(r,m)})}}function w0(a,u,l,m){if(a=so(a),!a)return!1;let b=null,r=qw(a),M=!r&&Rl(a);if(!r&&!M){let U=a.ngModule;if(r=qw(U),r)b=U;else return!1}else{if(M&&!M.standalone)return!1;b=a}let k=m.has(b);if(M){if(k)return!1;if(m.add(b),M.dependencies){let U=typeof M.dependencies=="function"?M.dependencies():M.dependencies;for(let ae of U)w0(ae,u,l,m)}}else if(r){if(r.imports!=null&&!k){m.add(b);let ae;try{D0(r.imports,Ee=>{w0(Ee,u,l,m)&&(ae||=[],ae.push(Ee))})}finally{}ae!==void 0&&_R(ae,u)}if(!k){let ae=gd(b)||(()=>new b);u({provide:b,useFactory:ae,deps:os},b),u({provide:vE,useValue:b,multi:!0},b),u({provide:Ml,useValue:()=>ln(b),multi:!0},b)}let U=r.providers;if(U!=null&&!k){let ae=a;EE(U,Ee=>{u(Ee,ae)})}}else return!1;return b!==a&&a.providers!==void 0}function EE(a,u){for(let l of a)lE(l)&&(l=l.\u0275providers),Array.isArray(l)?EE(l,u):u(l)}var Z3=Ur({provide:String,useValue:Ur});function yR(a){return a!==null&&typeof a=="object"&&Z3 in a}function q3(a){return!!(a&&a.useExisting)}function X3(a){return!!(a&&a.useFactory)}function _d(a){return typeof a=="function"}function vR(a){return!!a.useClass}var Rg=new Kt(""),v0={},iR={},Zw;function Pg(){return Zw===void 0&&(Zw=new Cg),Zw}var wi=class{},yd=class extends wi{parent;source;scopes;records=new Map;_ngOnDestroyHooks=new Set;_onDestroyHooks=[];get destroyed(){return this._destroyed}_destroyed=!1;injectorDefTypes;constructor(u,l,m,b){super(),this.parent=l,this.source=m,this.scopes=b,Qw(u,M=>this.processProvider(M)),this.records.set(yE,Af(void 0,this)),b.has("environment")&&this.records.set(wi,Af(void 0,this));let r=this.records.get(Rg);r!=null&&typeof r.value=="string"&&this.scopes.add(r.value),this.injectorDefTypes=new Set(this.get(vE,os,{self:!0}))}retrieve(u,l){let m=md(l)||0;try{return this.get(u,pd,m)}catch(b){if(mf(b))return b;throw b}}destroy(){Ig(this),this._destroyed=!0;let u=pr(null);try{for(let m of this._ngOnDestroyHooks)m.ngOnDestroy();let l=this._onDestroyHooks;this._onDestroyHooks=[];for(let m of l)m()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),pr(u)}}onDestroy(u){return Ig(this),this._onDestroyHooks.push(u),()=>this.removeOnDestroy(u)}runInContext(u){Ig(this);let l=Va(this),m=gs(void 0),b;try{return u()}finally{Va(l),gs(m)}}get(u,l=pd,m){if(Ig(this),u.hasOwnProperty(rR))return u[rR](this);let b=md(m),r,M=Va(this),k=gs(void 0);try{if(!(b&4)){let ae=this.records.get(u);if(ae===void 0){let Ee=eB(u)&&Ag(u);Ee&&this.injectableDefInScope(Ee)?ae=Af(Jw(u),v0):ae=null,this.records.set(u,ae)}if(ae!=null)return this.hydrate(u,ae,b)}let U=b&2?Pg():this.parent;return l=b&8&&l===pd?null:l,U.get(u,l)}catch(U){let ae=B3(U);throw ae===-200||ae===-201?new en(ae,null):U}finally{gs(k),Va(M)}}resolveInjectorInitializers(){let u=pr(null),l=Va(this),m=gs(void 0),b;try{let r=this.get(Ml,os,{self:!0});for(let M of r)M()}finally{Va(l),gs(m),pr(u)}}toString(){let u=[],l=this.records;for(let m of l.keys())u.push(jc(m));return`R3Injector[${u.join(", ")}]`}processProvider(u){u=so(u);let l=_d(u)?u:so(u&&u.provide),m=K3(u);if(!_d(u)&&u.multi===!0){let b=this.records.get(l);b||(b=Af(void 0,v0,!0),b.factory=()=>Kw(b.multi),this.records.set(l,b)),l=u,b.multi.push(u)}this.records.set(l,m)}hydrate(u,l,m){let b=pr(null);try{if(l.value===iR)throw pE(jc(u));return l.value===v0&&(l.value=iR,l.value=l.factory(void 0,m)),typeof l.value=="object"&&l.value&&Q3(l.value)&&this._ngOnDestroyHooks.add(l.value),l.value}finally{pr(b)}}injectableDefInScope(u){if(!u.providedIn)return!1;let l=so(u.providedIn);return typeof l=="string"?l==="any"||this.scopes.has(l):this.injectorDefTypes.has(l)}removeOnDestroy(u){let l=this._onDestroyHooks.indexOf(u);l!==-1&&this._onDestroyHooks.splice(l,1)}};function Jw(a){let u=Ag(a),l=u!==null?u.factory:gd(a);if(l!==null)return l;if(a instanceof Kt)throw new en(204,!1);if(a instanceof Function)return Y3(a);throw new en(204,!1)}function Y3(a){if(a.length>0)throw new en(204,!1);let l=k3(a);return l!==null?()=>l.factory(a):()=>new a}function K3(a){if(yR(a))return Af(void 0,a.useValue);{let u=TE(a);return Af(u,v0)}}function TE(a,u,l){let m;if(_d(a)){let b=so(a);return gd(b)||Jw(b)}else if(yR(a))m=()=>so(a.useValue);else if(X3(a))m=()=>a.useFactory(...Kw(a.deps||[]));else if(q3(a))m=(b,r)=>ln(so(a.useExisting),r!==void 0&&r&8?8:void 0);else{let b=so(a&&(a.useClass||a.provide));if(J3(a))m=()=>new b(...Kw(a.deps));else return gd(b)||Jw(b)}return m}function Ig(a){if(a.destroyed)throw new en(205,!1)}function Af(a,u,l=!1){return{factory:a,value:u,multi:l?[]:void 0}}function J3(a){return!!a.deps}function Q3(a){return a!==null&&typeof a=="object"&&typeof a.ngOnDestroy=="function"}function eB(a){return typeof a=="function"||typeof a=="object"&&a.ngMetadataName==="InjectionToken"}function Qw(a,u){for(let l of a)Array.isArray(l)?Qw(l,u):l&&lE(l)?Qw(l.\u0275providers,u):u(l)}function Xi(a,u){let l;a instanceof yd?(Ig(a),l=a):l=new Yw(a);let m,b=Va(l),r=gs(void 0);try{return u()}finally{Va(b),gs(r)}}function IE(){return cR()!==void 0||Wv()!=null}var ta=0,Nn=1,Un=2,Zi=3,Rs=4,Uo=5,Rf=6,Pf=7,ss=8,wd=9,Pl=10,ao=11,Of=12,SE=13,Lf=14,as=15,$c=16,Ed=17,ja=18,Og=19,DE=20,Cl=21,A0=22,Lg=23,_s=24,Td=25,jo=26,xR=1;var Wc=7,Fg=8,Id=9,Ho=10;function Ol(a){return Array.isArray(a)&&typeof a[xR]=="object"}function na(a){return Array.isArray(a)&&a[xR]===!0}function CE(a){return(a.flags&4)!==0}function Zc(a){return a.componentOffset>-1}function M0(a){return(a.flags&1)===1}function qc(a){return!!a.template}function Ff(a){return(a[Un]&512)!==0}function Sd(a){return(a[Un]&256)===256}var bR="svg",wR="math";function Ps(a){for(;Array.isArray(a);)a=a[ta];return a}function ER(a,u){return Ps(u[a])}function Ha(a,u){return Ps(u[a.index])}function R0(a,u){return a.data[u]}function ra(a,u){let l=u[a];return Ol(l)?l:l[ta]}function TR(a){return(a[Un]&4)===4}function P0(a){return(a[Un]&128)===128}function IR(a){return na(a[Zi])}function kf(a,u){return u==null?null:a[u]}function AE(a){a[Ed]=0}function ME(a){a[Un]&1024||(a[Un]|=1024,P0(a)&&Nf(a))}function kg(a){return!!(a[Un]&9216||a[_s]?.dirty)}function O0(a){a[Pl].changeDetectionScheduler?.notify(8),a[Un]&64&&(a[Un]|=1024),kg(a)&&Nf(a)}function Nf(a){a[Pl].changeDetectionScheduler?.notify(0);let u=Hc(a);for(;u!==null&&!(u[Un]&8192||(u[Un]|=8192,!P0(u)));)u=Hc(u)}function RE(a,u){if(Sd(a))throw new en(911,!1);a[Cl]===null&&(a[Cl]=[]),a[Cl].push(u)}function SR(a,u){if(a[Cl]===null)return;let l=a[Cl].indexOf(u);l!==-1&&a[Cl].splice(l,1)}function Hc(a){let u=a[Zi];return na(u)?u[Zi]:u}function PE(a){return a[Pf]??=[]}function OE(a){return a.cleanup??=[]}function DR(a,u,l,m){let b=PE(u);b.push(l),a.firstCreatePass&&OE(a).push(m,b.length-1)}var Sr={lFrame:UR(null),bindingsEnabled:!0,skipHydrationRootTNode:null},Ng=function(a){return a[a.Off=0]="Off",a[a.Exhaustive=1]="Exhaustive",a[a.OnlyDirtyViews=2]="OnlyDirtyViews",a}(Ng||{}),tB=0,eE=!1;function CR(){return Sr.lFrame.elementDepthCount}function AR(){Sr.lFrame.elementDepthCount++}function LE(){Sr.lFrame.elementDepthCount--}function MR(){return Sr.bindingsEnabled}function FE(){return Sr.skipHydrationRootTNode!==null}function kE(a){return Sr.skipHydrationRootTNode===a}function NE(){Sr.skipHydrationRootTNode=null}function si(){return Sr.lFrame.lView}function ia(){return Sr.lFrame.tView}function ls(){let a=zE();for(;a!==null&&a.type===64;)a=a.parent;return a}function zE(){return Sr.lFrame.currentTNode}function RR(){let a=Sr.lFrame,u=a.currentTNode;return a.isParent?u:u.parent}function zg(a,u){let l=Sr.lFrame;l.currentTNode=a,l.isParent=u}function BE(){return Sr.lFrame.isParent}function VE(){Sr.lFrame.isParent=!1}function UE(a){sE("Must never be called in production mode"),tB=a}function jE(){return eE}function HE(a){let u=eE;return eE=a,u}function PR(){let a=Sr.lFrame,u=a.bindingRootIndex;return u===-1&&(u=a.bindingRootIndex=a.tView.bindingStartIndex),u}function OR(a){return Sr.lFrame.bindingIndex=a}function LR(){return Sr.lFrame.bindingIndex++}function FR(a){let u=Sr.lFrame,l=u.bindingIndex;return u.bindingIndex=u.bindingIndex+a,l}function kR(){return Sr.lFrame.inI18n}function NR(a,u){let l=Sr.lFrame;l.bindingIndex=l.bindingRootIndex=a,L0(u)}function zR(){return Sr.lFrame.currentDirectiveIndex}function L0(a){Sr.lFrame.currentDirectiveIndex=a}function BR(a){let u=Sr.lFrame.currentDirectiveIndex;return u===-1?null:a[u]}function GE(){return Sr.lFrame.currentQueryIndex}function F0(a){Sr.lFrame.currentQueryIndex=a}function nB(a){let u=a[Nn];return u.type===2?u.declTNode:u.type===1?a[Uo]:null}function $E(a,u,l){if(l&4){let b=u,r=a;for(;b=b.parent,b===null&&!(l&1);)if(b=nB(r),b===null||(r=r[Lf],b.type&10))break;if(b===null)return!1;u=b,a=r}let m=Sr.lFrame=VR();return m.currentTNode=u,m.lView=a,!0}function k0(a){let u=VR(),l=a[Nn];Sr.lFrame=u,u.currentTNode=l.firstChild,u.lView=a,u.tView=l,u.contextLView=a,u.bindingIndex=l.bindingStartIndex,u.inI18n=!1}function VR(){let a=Sr.lFrame,u=a===null?null:a.child;return u===null?UR(a):u}function UR(a){let u={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:a,child:null,inI18n:!1};return a!==null&&(a.child=u),u}function jR(){let a=Sr.lFrame;return Sr.lFrame=a.parent,a.currentTNode=null,a.lView=null,a}var WE=jR;function N0(){let a=jR();a.isParent=!0,a.tView=null,a.selectedIndex=-1,a.contextLView=null,a.elementDepthCount=0,a.currentDirectiveIndex=-1,a.currentNamespace=null,a.bindingRootIndex=-1,a.bindingIndex=-1,a.currentQueryIndex=0}function zf(){return Sr.lFrame.selectedIndex}function Xc(a){Sr.lFrame.selectedIndex=a}function HR(){let a=Sr.lFrame;return R0(a.tView,a.selectedIndex)}function GR(){return Sr.lFrame.currentNamespace}var $R=!0;function ZE(){return $R}function qE(a){$R=a}function tE(a,u=null,l=null,m){let b=XE(a,u,l,m);return b.resolveInjectorInitializers(),b}function XE(a,u=null,l=null,m,b=new Set){let r=[l||os,gR(a)];return m=m||(typeof a=="object"?void 0:jc(a)),new yd(r,u||Pg(),m||null,b)}var qi=class a{static THROW_IF_NOT_FOUND=pd;static NULL=new Cg;static create(u,l){if(Array.isArray(u))return tE({name:""},l,u,"");{let m=u.name??"";return tE({name:m},u.parent,u.providers,m)}}static \u0275prov=Zt({token:a,providedIn:"any",factory:()=>ln(yE)});static __NG_ELEMENT_ID__=-1},di=new Kt(""),Ga=(()=>{class a{static __NG_ELEMENT_ID__=rB;static __NG_ENV_ID__=l=>l}return a})(),nE=class extends Ga{_lView;constructor(u){super(),this._lView=u}get destroyed(){return Sd(this._lView)}onDestroy(u){let l=this._lView;return RE(l,u),()=>SR(l,u)}};function rB(){return new nE(si())}var Qs=class{_console=console;handleError(u){this._console.error("ERROR",u)}},ys=new Kt("",{providedIn:"root",factory:()=>{let a=ut(wi),u;return l=>{a.destroyed&&!u?setTimeout(()=>{throw l}):(u??=a.get(Qs),u.handleError(l))}}}),WR={provide:Ml,useValue:()=>void ut(Qs),multi:!0},iB=new Kt("",{providedIn:"root",factory:()=>{let a=ut(di).defaultView;if(!a)return;let u=ut(ys),l=r=>{u(r.reason),r.preventDefault()},m=r=>{r.error?u(r.error):u(new Error(r.message,{cause:r})),r.preventDefault()},b=()=>{a.addEventListener("unhandledrejection",l),a.addEventListener("error",m)};typeof Zone<"u"?Zone.root.run(b):b(),ut(Ga).onDestroy(()=>{a.removeEventListener("error",m),a.removeEventListener("unhandledrejection",l)})}});function YE(){return Gc([mR(()=>void ut(iB))])}function Bg(a,u){let[l,m,b]=Pw(a,u?.equal),r=l,M=r[Tl];return r.set=m,r.update=b,r.asReadonly=ZR.bind(r),r}function ZR(){let a=this[Tl];if(a.readonlyFn===void 0){let u=()=>this();u[Tl]=a,a.readonlyFn=u}return a.readonlyFn}var Al=class{},z0=new Kt("",{providedIn:"root",factory:()=>!1});var KE=new Kt(""),JE=new Kt("");var B0=(()=>{class a{view;node;constructor(l,m){this.view=l,this.node=m}static __NG_ELEMENT_ID__=oB}return a})();function oB(){return new B0(si(),ls())}var $a=(()=>{class a{taskId=0;pendingTasks=new Set;destroyed=!1;pendingTask=new oo(!1);get hasPendingTasks(){return this.destroyed?!1:this.pendingTask.value}get hasPendingTasksObservable(){return this.destroyed?new br(l=>{l.next(!1),l.complete()}):this.pendingTask}add(){!this.hasPendingTasks&&!this.destroyed&&this.pendingTask.next(!0);let l=this.taskId++;return this.pendingTasks.add(l),l}has(l){return this.pendingTasks.has(l)}remove(l){this.pendingTasks.delete(l),this.pendingTasks.size===0&&this.hasPendingTasks&&this.pendingTask.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks&&this.pendingTask.next(!1),this.destroyed=!0,this.pendingTask.unsubscribe()}static \u0275prov=Zt({token:a,providedIn:"root",factory:()=>new a})}return a})(),Vg=(()=>{class a{internalPendingTasks=ut($a);scheduler=ut(Al);errorHandler=ut(ys);add(){let l=this.internalPendingTasks.add();return()=>{this.internalPendingTasks.has(l)&&(this.scheduler.notify(11),this.internalPendingTasks.remove(l))}}run(l){let m=this.add();l().catch(this.errorHandler).finally(m)}static \u0275prov=Zt({token:a,providedIn:"root",factory:()=>new a})}return a})();function Ug(...a){}var QE=(()=>{class a{static \u0275prov=Zt({token:a,providedIn:"root",factory:()=>new rE})}return a})(),rE=class{dirtyEffectCount=0;queues=new Map;add(u){this.enqueue(u),this.schedule(u)}schedule(u){u.dirty&&this.dirtyEffectCount++}remove(u){let l=u.zone,m=this.queues.get(l);m.has(u)&&(m.delete(u),u.dirty&&this.dirtyEffectCount--)}enqueue(u){let l=u.zone;this.queues.has(l)||this.queues.set(l,new Set);let m=this.queues.get(l);m.has(u)||m.add(u)}flush(){for(;this.dirtyEffectCount>0;){let u=!1;for(let[l,m]of this.queues)l===null?u||=this.flushQueue(m):u||=l.run(()=>this.flushQueue(m));u||(this.dirtyEffectCount=0)}}flushQueue(u){let l=!1;for(let m of u)m.dirty&&(this.dirtyEffectCount--,l=!0,m.run());return l}};function Yg(a){return{toString:a}.toString()}function w2(a){let u=ea.ng;if(u&&u.\u0275compilerFacade)return u.\u0275compilerFacade;throw new Error("JIT compiler unavailable")}function _B(a){return typeof a=="function"}var W0=class{previousValue;currentValue;firstChange;constructor(u,l,m){this.previousValue=u,this.currentValue=l,this.firstChange=m}isFirstChange(){return this.firstChange}};function E2(a,u,l,m){u!==null?u.applyValueToInputSignal(u,m):a[l]=m}var Pd=(()=>{let a=()=>T2;return a.ngInherit=!0,a})();function T2(a){return a.type.prototype.ngOnChanges&&(a.setInput=vB),yB}function yB(){let a=S2(this),u=a?.current;if(u){let l=a.previous;if(l===bd)a.previous=u;else for(let m in u)l[m]=u[m];a.current=null,this.ngOnChanges(u)}}function vB(a,u,l,m,b){let r=this.declaredInputs[m],M=S2(a)||xB(a,{previous:bd,current:null}),k=M.current||(M.current={}),U=M.previous,ae=U[r];k[r]=new W0(ae&&ae.currentValue,l,U===bd),E2(a,u,b,l)}var I2="__ngSimpleChanges__";function S2(a){return a[I2]||null}function xB(a,u){return a[I2]=u}var qR=[];var Kr=function(a,u=null,l){for(let m=0;m<qR.length;m++){let b=qR[m];b(a,u,l)}};function bB(a,u,l){let{ngOnChanges:m,ngOnInit:b,ngDoCheck:r}=u.type.prototype;if(m){let M=T2(u);(l.preOrderHooks??=[]).push(a,M),(l.preOrderCheckHooks??=[]).push(a,M)}b&&(l.preOrderHooks??=[]).push(0-a,b),r&&((l.preOrderHooks??=[]).push(a,r),(l.preOrderCheckHooks??=[]).push(a,r))}function wB(a,u){for(let l=u.directiveStart,m=u.directiveEnd;l<m;l++){let r=a.data[l].type.prototype,{ngAfterContentInit:M,ngAfterContentChecked:k,ngAfterViewInit:U,ngAfterViewChecked:ae,ngOnDestroy:Ee}=r;M&&(a.contentHooks??=[]).push(-l,M),k&&((a.contentHooks??=[]).push(l,k),(a.contentCheckHooks??=[]).push(l,k)),U&&(a.viewHooks??=[]).push(-l,U),ae&&((a.viewHooks??=[]).push(l,ae),(a.viewCheckHooks??=[]).push(l,ae)),Ee!=null&&(a.destroyHooks??=[]).push(l,Ee)}}function j0(a,u,l){D2(a,u,3,l)}function H0(a,u,l,m){(a[Un]&3)===l&&D2(a,u,l,m)}function eT(a,u){let l=a[Un];(l&3)===u&&(l&=16383,l+=1,a[Un]=l)}function D2(a,u,l,m){let b=m!==void 0?a[Ed]&65535:0,r=m??-1,M=u.length-1,k=0;for(let U=b;U<M;U++)if(typeof u[U+1]=="number"){if(k=u[U],m!=null&&k>=m)break}else u[U]<0&&(a[Ed]+=65536),(k<r||r==-1)&&(EB(a,l,u,U),a[Ed]=(a[Ed]&4294901760)+U+2),U++}function XR(a,u){Kr(4,a,u);let l=pr(null);try{u.call(a)}finally{pr(l),Kr(5,a,u)}}function EB(a,u,l,m){let b=l[m]<0,r=l[m+1],M=b?-l[m]:l[m],k=a[M];b?a[Un]>>14<a[Ed]>>16&&(a[Un]&3)===u&&(a[Un]+=16384,XR(k,r)):XR(k,r)}var Vf=-1,Cd=class{factory;name;injectImpl;resolving=!1;canSeeViewProviders;multi;componentProviders;index;providerFactory;constructor(u,l,m,b){this.factory=u,this.name=b,this.canSeeViewProviders=l,this.injectImpl=m}};function TB(a){return(a.flags&8)!==0}function IB(a){return(a.flags&16)!==0}function SB(a,u,l){let m=0;for(;m<l.length;){let b=l[m];if(typeof b=="number"){if(b!==0)break;m++;let r=l[m++],M=l[m++],k=l[m++];a.setAttribute(u,M,k,r)}else{let r=b,M=l[++m];CB(r)?a.setProperty(u,r,M):a.setAttribute(u,r,M),m++}}return m}function DB(a){return a===3||a===4||a===6}function CB(a){return a.charCodeAt(0)===64}function lx(a,u){if(!(u===null||u.length===0))if(a===null||a.length===0)a=u.slice();else{let l=-1;for(let m=0;m<u.length;m++){let b=u[m];typeof b=="number"?l=b:l===0||(l===-1||l===2?YR(a,l,b,null,u[++m]):YR(a,l,b,null,null))}}return a}function YR(a,u,l,m,b){let r=0,M=a.length;if(u===-1)M=-1;else for(;r<a.length;){let k=a[r++];if(typeof k=="number"){if(k===u){M=-1;break}else if(k>u){M=r-1;break}}}for(;r<a.length;){let k=a[r];if(typeof k=="number")break;if(k===l){b!==null&&(a[r+1]=b);return}r++,b!==null&&r++}M!==-1&&(a.splice(M,0,u),r=M+1),a.splice(r++,0,l),b!==null&&a.splice(r++,0,b)}function C2(a){return a!==Vf}function Z0(a){return a&32767}function AB(a){return a>>16}function q0(a,u){let l=AB(a),m=u;for(;l>0;)m=m[Lf],l--;return m}var cT=!0;function KR(a){let u=cT;return cT=a,u}var MB=256,A2=MB-1,M2=5,RB=0,Wa={};function PB(a,u,l){let m;typeof l=="string"?m=l.charCodeAt(0)||0:l.hasOwnProperty(xd)&&(m=l[xd]),m==null&&(m=l[xd]=RB++);let b=m&A2,r=1<<b;u.data[a+(b>>M2)]|=r}function X0(a,u){let l=R2(a,u);if(l!==-1)return l;let m=u[Nn];m.firstCreatePass&&(a.injectorIndex=u.length,tT(m.data,a),tT(u,null),tT(m.blueprint,null));let b=zT(a,u),r=a.injectorIndex;if(C2(b)){let M=Z0(b),k=q0(b,u),U=k[Nn].data;for(let ae=0;ae<8;ae++)u[r+ae]=k[M+ae]|U[M+ae]}return u[r+8]=b,r}function tT(a,u){a.push(0,0,0,0,0,0,0,0,u)}function R2(a,u){return a.injectorIndex===-1||a.parent&&a.parent.injectorIndex===a.injectorIndex||u[a.injectorIndex+8]===null?-1:a.injectorIndex}function zT(a,u){if(a.parent&&a.parent.injectorIndex!==-1)return a.parent.injectorIndex;let l=0,m=null,b=u;for(;b!==null;){if(m=k2(b),m===null)return Vf;if(l++,b=b[Lf],m.injectorIndex!==-1)return m.injectorIndex|l<<16}return Vf}function uT(a,u,l){PB(a,u,l)}function P2(a,u,l){if(l&8||a!==void 0)return a;S0(u,"NodeInjector")}function O2(a,u,l,m){if(l&8&&m===void 0&&(m=null),(l&3)===0){let b=a[wd],r=gs(void 0);try{return b?b.get(u,m,l&8):mE(u,m,l&8)}finally{gs(r)}}return P2(m,u,l)}function L2(a,u,l,m=0,b){if(a!==null){if(u[Un]&2048&&!(m&2)){let M=kB(a,u,l,m,Wa);if(M!==Wa)return M}let r=F2(a,u,l,m,Wa);if(r!==Wa)return r}return O2(u,l,m,b)}function F2(a,u,l,m,b){let r=LB(l);if(typeof r=="function"){if(!$E(u,a,m))return m&1?P2(b,l,m):O2(u,l,m,b);try{let M;if(M=r(m),M==null&&!(m&8))S0(l);else return M}finally{WE()}}else if(typeof r=="number"){let M=null,k=R2(a,u),U=Vf,ae=m&1?u[as][Uo]:null;for((k===-1||m&4)&&(U=k===-1?zT(a,u):u[k+8],U===Vf||!QR(m,!1)?k=-1:(M=u[Nn],k=Z0(U),u=q0(U,u)));k!==-1;){let Ee=u[Nn];if(JR(r,k,Ee.data)){let Be=OB(k,u,l,M,m,ae);if(Be!==Wa)return Be}U=u[k+8],U!==Vf&&QR(m,u[Nn].data[k+8]===ae)&&JR(r,k,u)?(M=Ee,k=Z0(U),u=q0(U,u)):k=-1}}return b}function OB(a,u,l,m,b,r){let M=u[Nn],k=M.data[a+8],U=m==null?Zc(k)&&cT:m!=M&&(k.type&3)!==0,ae=b&1&&r===k,Ee=G0(k,M,l,U,ae);return Ee!==null?Gg(u,M,Ee,k,b):Wa}function G0(a,u,l,m,b){let r=a.providerIndexes,M=u.data,k=r&1048575,U=a.directiveStart,ae=a.directiveEnd,Ee=r>>20,Be=m?k:k+Ee,ht=b?k+Ee:ae;for(let Oe=Be;Oe<ht;Oe++){let Ct=M[Oe];if(Oe<U&&l===Ct||Oe>=U&&Ct.type===l)return Oe}if(b){let Oe=M[U];if(Oe&&qc(Oe)&&Oe.type===l)return U}return null}function Gg(a,u,l,m,b){let r=a[l],M=u.data;if(r instanceof Cd){let k=r;if(k.resolving){let Oe=b0(M[l]);throw pE(Oe)}let U=KR(k.canSeeViewProviders);k.resolving=!0;let ae=M[l].type||M[l],Ee,Be=k.injectImpl?gs(k.injectImpl):null,ht=$E(a,m,0);try{r=a[l]=k.factory(void 0,b,M,a,m),u.firstCreatePass&&l>=m.directiveStart&&bB(l,M[l],u)}finally{Be!==null&&gs(Be),KR(U),k.resolving=!1,WE()}}return r}function LB(a){if(typeof a=="string")return a.charCodeAt(0)||0;let u=a.hasOwnProperty(xd)?a[xd]:void 0;return typeof u=="number"?u>=0?u&A2:FB:u}function JR(a,u,l){let m=1<<a;return!!(l[u+(a>>M2)]&m)}function QR(a,u){return!(a&2)&&!(a&1&&u)}var Dd=class{_tNode;_lView;constructor(u,l){this._tNode=u,this._lView=l}get(u,l,m){return L2(this._tNode,this._lView,u,md(m),l)}};function FB(){return new Dd(ls(),si())}function cx(a){return Yg(()=>{let u=a.prototype.constructor,l=u[Dg]||dT(u),m=Object.prototype,b=Object.getPrototypeOf(a.prototype).constructor;for(;b&&b!==m;){let r=b[Dg]||dT(b);if(r&&r!==l)return r;b=Object.getPrototypeOf(b)}return r=>new r})}function dT(a){return oE(a)?()=>{let u=dT(so(a));return u&&u()}:gd(a)}function kB(a,u,l,m,b){let r=a,M=u;for(;r!==null&&M!==null&&M[Un]&2048&&!Ff(M);){let k=F2(r,M,l,m|2,Wa);if(k!==Wa)return k;let U=r.parent;if(!U){let ae=M[DE];if(ae){let Ee=ae.get(l,Wa,m);if(Ee!==Wa)return Ee}U=k2(M),M=M[Lf]}r=U}return b}function k2(a){let u=a[Nn],l=u.type;return l===2?u.declTNode:l===1?a[Uo]:null}function NB(){return $f(ls(),si())}function $f(a,u){return new Kc(Ha(a,u))}var Kc=(()=>{class a{nativeElement;constructor(l){this.nativeElement=l}static __NG_ELEMENT_ID__=NB}return a})();function zB(a){return a instanceof Kc?a.nativeElement:a}function BB(){return this._results[Symbol.iterator]()}var Y0=class{_emitDistinctChangesOnly;dirty=!0;_onDirty=void 0;_results=[];_changesDetected=!1;_changes=void 0;length=0;first=void 0;last=void 0;get changes(){return this._changes??=new Ai}constructor(u=!1){this._emitDistinctChangesOnly=u}get(u){return this._results[u]}map(u){return this._results.map(u)}filter(u){return this._results.filter(u)}find(u){return this._results.find(u)}reduce(u,l){return this._results.reduce(u,l)}forEach(u){this._results.forEach(u)}some(u){return this._results.some(u)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(u,l){this.dirty=!1;let m=dR(u);(this._changesDetected=!uR(this._results,m,l))&&(this._results=m,this.length=m.length,this.last=m[this.length-1],this.first=m[0])}notifyOnChanges(){this._changes!==void 0&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.next(this)}onDirty(u){this._onDirty=u}setDirty(){this.dirty=!0,this._onDirty?.()}destroy(){this._changes!==void 0&&(this._changes.complete(),this._changes.unsubscribe())}[Symbol.iterator]=BB};function N2(a){return(a.flags&128)===128}var BT=function(a){return a[a.OnPush=0]="OnPush",a[a.Default=1]="Default",a}(BT||{}),z2=new Map,VB=0;function UB(){return VB++}function jB(a){z2.set(a[Og],a)}function hT(a){z2.delete(a[Og])}var e2="__ngContext__";function Uf(a,u){Ol(u)?(a[e2]=u[Og],jB(u)):a[e2]=u}function B2(a){return U2(a[Of])}function V2(a){return U2(a[Rs])}function U2(a){for(;a!==null&&!na(a);)a=a[Rs];return a}var fT;function VT(a){fT=a}function j2(){if(fT!==void 0)return fT;if(typeof document<"u")return document;throw new en(210,!1)}var ux=new Kt("",{providedIn:"root",factory:()=>HB}),HB="ng",dx=new Kt(""),Wf=new Kt("",{providedIn:"platform",factory:()=>"unknown"});var hx=new Kt("",{providedIn:"root",factory:()=>j2().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});var GB="h",$B="b";var H2=!1,G2=new Kt("",{providedIn:"root",factory:()=>H2});var WB=(a,u,l,m)=>{};function ZB(a,u,l,m){WB(a,u,l,m)}function fx(a){return(a.flags&32)===32}var qB=()=>null;function $2(a,u,l=!1){return qB(a,u,l)}function W2(a,u){let l=a.contentQueries;if(l!==null){let m=pr(null);try{for(let b=0;b<l.length;b+=2){let r=l[b],M=l[b+1];if(M!==-1){let k=a.data[M];F0(r),k.contentQueries(2,u[M],M)}}}finally{pr(m)}}}function pT(a,u,l){F0(0);let m=pr(null);try{u(a,l)}finally{pr(m)}}function Z2(a,u,l){if(CE(u)){let m=pr(null);try{let b=u.directiveStart,r=u.directiveEnd;for(let M=b;M<r;M++){let k=a.data[M];if(k.contentQueries){let U=l[M];k.contentQueries(1,U,M)}}}finally{pr(m)}}}var Ll=function(a){return a[a.Emulated=0]="Emulated",a[a.None=2]="None",a[a.ShadowDom=3]="ShadowDom",a}(Ll||{});var mT=class{changingThisBreaksApplicationSecurity;constructor(u){this.changingThisBreaksApplicationSecurity=u}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see ${iE})`}};function px(a){return a instanceof mT?a.changingThisBreaksApplicationSecurity:a}function q2(a){return a instanceof Function?a():a}function XB(a,u,l){let m=a.length;for(;;){let b=a.indexOf(u,l);if(b===-1)return b;if(b===0||a.charCodeAt(b-1)<=32){let r=u.length;if(b+r===m||a.charCodeAt(b+r)<=32)return b}l=b+1}}var X2="ng-template";function YB(a,u,l,m){let b=0;if(m){for(;b<u.length&&typeof u[b]=="string";b+=2)if(u[b]==="class"&&XB(u[b+1].toLowerCase(),l,0)!==-1)return!0}else if(UT(a))return!1;if(b=u.indexOf(1,b),b>-1){let r;for(;++b<u.length&&typeof(r=u[b])=="string";)if(r.toLowerCase()===l)return!0}return!1}function UT(a){return a.type===4&&a.value!==X2}function KB(a,u,l){let m=a.type===4&&!l?X2:a.value;return u===m}function JB(a,u,l){let m=4,b=a.attrs,r=b!==null?t5(b):0,M=!1;for(let k=0;k<u.length;k++){let U=u[k];if(typeof U=="number"){if(!M&&!oa(m)&&!oa(U))return!1;if(M&&oa(U))continue;M=!1,m=U|m&1;continue}if(!M)if(m&4){if(m=2|m&1,U!==""&&!KB(a,U,l)||U===""&&u.length===1){if(oa(m))return!1;M=!0}}else if(m&8){if(b===null||!YB(a,b,U,l)){if(oa(m))return!1;M=!0}}else{let ae=u[++k],Ee=QB(U,b,UT(a),l);if(Ee===-1){if(oa(m))return!1;M=!0;continue}if(ae!==""){let Be;if(Ee>r?Be="":Be=b[Ee+1].toLowerCase(),m&2&&ae!==Be){if(oa(m))return!1;M=!0}}}}return oa(m)||M}function oa(a){return(a&1)===0}function QB(a,u,l,m){if(u===null)return-1;let b=0;if(m||!l){let r=!1;for(;b<u.length;){let M=u[b];if(M===a)return b;if(M===3||M===6)r=!0;else if(M===1||M===2){let k=u[++b];for(;typeof k=="string";)k=u[++b];continue}else{if(M===4)break;if(M===0){b+=4;continue}}b+=r?1:2}return-1}else return n5(u,a)}function Y2(a,u,l=!1){for(let m=0;m<u.length;m++)if(JB(a,u[m],l))return!0;return!1}function e5(a){let u=a.attrs;if(u!=null){let l=u.indexOf(5);if((l&1)===0)return u[l+1]}return null}function t5(a){for(let u=0;u<a.length;u++){let l=a[u];if(DB(l))return u}return a.length}function n5(a,u){let l=a.indexOf(4);if(l>-1)for(l++;l<a.length;){let m=a[l];if(typeof m=="number")return-1;if(m===u)return l;l++}return-1}function r5(a,u){e:for(let l=0;l<u.length;l++){let m=u[l];if(a.length===m.length){for(let b=0;b<a.length;b++)if(a[b]!==m[b])continue e;return!0}}return!1}function t2(a,u){return a?":not("+u.trim()+")":u}function i5(a){let u=a[0],l=1,m=2,b="",r=!1;for(;l<a.length;){let M=a[l];if(typeof M=="string")if(m&2){let k=a[++l];b+="["+M+(k.length>0?'="'+k+'"':"")+"]"}else m&8?b+="."+M:m&4&&(b+=" "+M);else b!==""&&!oa(M)&&(u+=t2(r,b),b=""),m=M,r=r||!oa(m);l++}return b!==""&&(u+=t2(r,b)),u}function o5(a){return a.map(i5).join(",")}function s5(a){let u=[],l=[],m=1,b=2;for(;m<a.length;){let r=a[m];if(typeof r=="string")b===2?r!==""&&u.push(r,a[++m]):b===8&&l.push(r);else{if(!oa(b))break;b=r}m++}return l.length&&u.push(1,...l),u}var Jc={};function K2(a,u,l){return a.createElement(u,l)}function K0(a,u,l,m,b){a.insertBefore(u,l,m,b)}function J2(a,u,l){a.appendChild(u,l)}function n2(a,u,l,m,b){m!==null?K0(a,u,l,m,b):J2(a,u,l)}function a5(a,u,l){a.removeChild(null,u,l)}function l5(a,u,l){a.setAttribute(u,"style",l)}function c5(a,u,l){l===""?a.removeAttribute(u,"class"):a.setAttribute(u,"class",l)}function Q2(a,u,l){let{mergedAttrs:m,classes:b,styles:r}=l;m!==null&&SB(a,u,m),b!==null&&c5(a,u,b),r!==null&&l5(a,u,r)}function jT(a,u,l,m,b,r,M,k,U,ae,Ee){let Be=jo+m,ht=Be+b,Oe=u5(Be,ht),Ct=typeof ae=="function"?ae():ae;return Oe[Nn]={type:a,blueprint:Oe,template:l,queries:null,viewQuery:k,declTNode:u,data:Oe.slice().fill(null,Be),bindingStartIndex:Be,expandoStartIndex:ht,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof r=="function"?r():r,pipeRegistry:typeof M=="function"?M():M,firstChild:null,schemas:U,consts:Ct,incompleteFirstPass:!1,ssrId:Ee}}function u5(a,u){let l=[];for(let m=0;m<u;m++)l.push(m<a?null:Jc);return l}function d5(a){let u=a.tView;return u===null||u.incompleteFirstPass?a.tView=jT(1,null,a.template,a.decls,a.vars,a.directiveDefs,a.pipeDefs,a.viewQuery,a.schemas,a.consts,a.id):u}function HT(a,u,l,m,b,r,M,k,U,ae,Ee){let Be=u.blueprint.slice();return Be[ta]=b,Be[Un]=m|4|128|8|64|1024,(ae!==null||a&&a[Un]&2048)&&(Be[Un]|=2048),AE(Be),Be[Zi]=Be[Lf]=a,Be[ss]=l,Be[Pl]=M||a&&a[Pl],Be[ao]=k||a&&a[ao],Be[wd]=U||a&&a[wd]||null,Be[Uo]=r,Be[Og]=UB(),Be[Rf]=Ee,Be[DE]=ae,Be[as]=u.type==2?a[as]:Be,Be}function h5(a,u,l){let m=Ha(u,a),b=d5(l),r=a[Pl].rendererFactory,M=GT(a,HT(a,b,null,eP(l),m,u,null,r.createRenderer(m,l),null,null,null));return a[u.index]=M}function eP(a){let u=16;return a.signals?u=4096:a.onPush&&(u=64),u}function tP(a,u,l,m){if(l===0)return-1;let b=u.length;for(let r=0;r<l;r++)u.push(m),a.blueprint.push(m),a.data.push(null);return b}function GT(a,u){return a[Of]?a[SE][Rs]=u:a[Of]=u,a[SE]=u,u}function $T(a=1){nP(ia(),si(),zf()+a,!1)}function nP(a,u,l,m){if(!m)if((u[Un]&3)===3){let r=a.preOrderCheckHooks;r!==null&&j0(u,r,l)}else{let r=a.preOrderHooks;r!==null&&H0(u,r,0,l)}Xc(l)}var mx=function(a){return a[a.None=0]="None",a[a.SignalBased=1]="SignalBased",a[a.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",a}(mx||{});function gT(a,u,l,m){let b=pr(null);try{let[r,M,k]=a.inputs[l],U=null;(M&mx.SignalBased)!==0&&(U=u[r][Tl]),U!==null&&U.transformFn!==void 0?m=U.transformFn(m):k!==null&&(m=k.call(u,m)),a.setInput!==null?a.setInput(u,U,m,l,r):E2(u,U,r,m)}finally{pr(b)}}var Fl=function(a){return a[a.Important=1]="Important",a[a.DashCase=2]="DashCase",a}(Fl||{}),f5;function WT(a,u){return f5(a,u)}function Bf(a,u,l,m,b){if(m!=null){let r,M=!1;na(m)?r=m:Ol(m)&&(M=!0,m=m[ta]);let k=Ps(m);a===0&&l!==null?b==null?J2(u,l,k):K0(u,l,k,b||null,!0):a===1&&l!==null?K0(u,l,k,b||null,!0):a===2?a5(u,k,M):a===3&&u.destroyNode(k),r!=null&&E5(u,a,r,l,b)}}function p5(a,u){rP(a,u),u[ta]=null,u[Uo]=null}function m5(a,u,l,m,b,r){m[ta]=b,m[Uo]=u,gx(a,m,l,1,b,r)}function rP(a,u){u[Pl].changeDetectionScheduler?.notify(9),gx(a,u,u[ao],2,null,null)}function g5(a){let u=a[Of];if(!u)return nT(a[Nn],a);for(;u;){let l=null;if(Ol(u))l=u[Of];else{let m=u[Ho];m&&(l=m)}if(!l){for(;u&&!u[Rs]&&u!==a;)Ol(u)&&nT(u[Nn],u),u=u[Zi];u===null&&(u=a),Ol(u)&&nT(u[Nn],u),l=u&&u[Rs]}u=l}}function ZT(a,u){let l=a[Id],m=l.indexOf(u);l.splice(m,1)}function iP(a,u){if(Sd(u))return;let l=u[ao];l.destroyNode&&gx(a,u,l,3,null,null),g5(u)}function nT(a,u){if(Sd(u))return;let l=pr(null);try{u[Un]&=-129,u[Un]|=256,u[_s]&&Aw(u[_s]),y5(a,u),_5(a,u),u[Nn].type===1&&u[ao].destroy();let m=u[$c];if(m!==null&&na(u[Zi])){m!==u[Zi]&&ZT(m,u);let b=u[ja];b!==null&&b.detachView(a)}hT(u)}finally{pr(l)}}function _5(a,u){let l=a.cleanup,m=u[Pf];if(l!==null)for(let M=0;M<l.length-1;M+=2)if(typeof l[M]=="string"){let k=l[M+3];k>=0?m[k]():m[-k].unsubscribe(),M+=2}else{let k=m[l[M+1]];l[M].call(k)}m!==null&&(u[Pf]=null);let b=u[Cl];if(b!==null){u[Cl]=null;for(let M=0;M<b.length;M++){let k=b[M];k()}}let r=u[Lg];if(r!==null){u[Lg]=null;for(let M of r)M.destroy()}}function y5(a,u){let l;if(a!=null&&(l=a.destroyHooks)!=null)for(let m=0;m<l.length;m+=2){let b=u[l[m]];if(!(b instanceof Cd)){let r=l[m+1];if(Array.isArray(r))for(let M=0;M<r.length;M+=2){let k=b[r[M]],U=r[M+1];Kr(4,k,U);try{U.call(k)}finally{Kr(5,k,U)}}else{Kr(4,b,r);try{r.call(b)}finally{Kr(5,b,r)}}}}}function oP(a,u,l){return v5(a,u.parent,l)}function v5(a,u,l){let m=u;for(;m!==null&&m.type&168;)u=m,m=u.parent;if(m===null)return l[ta];if(Zc(m)){let{encapsulation:b}=a.data[m.directiveStart+m.componentOffset];if(b===Ll.None||b===Ll.Emulated)return null}return Ha(m,l)}function sP(a,u,l){return b5(a,u,l)}function x5(a,u,l){return a.type&40?Ha(a,l):null}var b5=x5,r2;function aP(a,u,l,m){let b=oP(a,m,u),r=u[ao],M=m.parent||u[Uo],k=sP(M,m,u);if(b!=null)if(Array.isArray(l))for(let U=0;U<l.length;U++)n2(r,b,l[U],k,!1);else n2(r,b,l,k,!1);r2!==void 0&&r2(r,m,u,l,b)}function jg(a,u){if(u!==null){let l=u.type;if(l&3)return Ha(u,a);if(l&4)return _T(-1,a[u.index]);if(l&8){let m=u.child;if(m!==null)return jg(a,m);{let b=a[u.index];return na(b)?_T(-1,b):Ps(b)}}else{if(l&128)return jg(a,u.next);if(l&32)return WT(u,a)()||Ps(a[u.index]);{let m=lP(a,u);if(m!==null){if(Array.isArray(m))return m[0];let b=Hc(a[as]);return jg(b,m)}else return jg(a,u.next)}}}return null}function lP(a,u){if(u!==null){let m=a[as][Uo],b=u.projection;return m.projection[b]}return null}function _T(a,u){let l=Ho+a+1;if(l<u.length){let m=u[l],b=m[Nn].firstChild;if(b!==null)return jg(m,b)}return u[Wc]}function qT(a,u,l,m,b,r,M){for(;l!=null;){if(l.type===128){l=l.next;continue}let k=m[l.index],U=l.type;if(M&&u===0&&(k&&Uf(Ps(k),m),l.flags|=2),!fx(l))if(U&8)qT(a,u,l.child,m,b,r,!1),Bf(u,a,b,k,r);else if(U&32){let ae=WT(l,m),Ee;for(;Ee=ae();)Bf(u,a,b,Ee,r);Bf(u,a,b,k,r)}else U&16?cP(a,u,m,l,b,r):Bf(u,a,b,k,r);l=M?l.projectionNext:l.next}}function gx(a,u,l,m,b,r){qT(l,m,a.firstChild,u,b,r,!1)}function w5(a,u,l){let m=u[ao],b=oP(a,l,u),r=l.parent||u[Uo],M=sP(r,l,u);cP(m,0,u,l,b,M)}function cP(a,u,l,m,b,r){let M=l[as],U=M[Uo].projection[m.projection];if(Array.isArray(U))for(let ae=0;ae<U.length;ae++){let Ee=U[ae];Bf(u,a,b,Ee,r)}else{let ae=U,Ee=M[Zi];N2(m)&&(ae.flags|=128),qT(a,u,ae,Ee,b,r,!0)}}function E5(a,u,l,m,b){let r=l[Wc],M=Ps(l);r!==M&&Bf(u,a,m,r,b);for(let k=Ho;k<l.length;k++){let U=l[k];gx(U[Nn],U,a,u,m,r)}}function T5(a,u,l,m,b){if(u)b?a.addClass(l,m):a.removeClass(l,m);else{let r=m.indexOf("-")===-1?void 0:Fl.DashCase;b==null?a.removeStyle(l,m,r):(typeof b=="string"&&b.endsWith("!important")&&(b=b.slice(0,-10),r|=Fl.Important),a.setStyle(l,m,b,r))}}function uP(a,u,l,m,b){let r=zf(),M=m&2;try{Xc(-1),M&&u.length>jo&&nP(a,u,jo,!1),Kr(M?2:0,b,l),l(m,b)}finally{Xc(r),Kr(M?3:1,b,l)}}function dP(a,u,l){P5(a,u,l),(l.flags&64)===64&&O5(a,u,l)}function XT(a,u,l=Ha){let m=u.localNames;if(m!==null){let b=u.index+1;for(let r=0;r<m.length;r+=2){let M=m[r+1],k=M===-1?l(u,a):a[M];a[b++]=k}}}function I5(a,u,l,m){let r=m.get(G2,H2)||l===Ll.ShadowDom,M=a.selectRootElement(u,r);return S5(M),M}function S5(a){D5(a)}var D5=()=>null;function C5(a){return a==="class"?"className":a==="for"?"htmlFor":a==="formaction"?"formAction":a==="innerHtml"?"innerHTML":a==="readonly"?"readOnly":a==="tabindex"?"tabIndex":a}function A5(a,u,l,m,b,r){let M=u[Nn];if(YT(a,M,u,l,m)){Zc(a)&&R5(u,a.index);return}a.type&3&&(l=C5(l)),M5(a,u,l,m,b,r)}function M5(a,u,l,m,b,r){if(a.type&3){let M=Ha(a,u);m=r!=null?r(m,a.value||"",l):m,b.setProperty(M,l,m)}else a.type&12}function R5(a,u){let l=ra(u,a);l[Un]&16||(l[Un]|=64)}function P5(a,u,l){let m=l.directiveStart,b=l.directiveEnd;Zc(l)&&h5(u,l,a.data[m+l.componentOffset]),a.firstCreatePass||X0(l,u);let r=l.initialInputs;for(let M=m;M<b;M++){let k=a.data[M],U=Gg(u,a,M,l);if(Uf(U,u),r!==null&&k5(u,M-m,U,k,l,r),qc(k)){let ae=ra(l.index,u);ae[ss]=Gg(u,a,M,l)}}}function O5(a,u,l){let m=l.directiveStart,b=l.directiveEnd,r=l.index,M=zR();try{Xc(r);for(let k=m;k<b;k++){let U=a.data[k],ae=u[k];L0(k),(U.hostBindings!==null||U.hostVars!==0||U.hostAttrs!==null)&&L5(U,ae)}}finally{Xc(-1),L0(M)}}function L5(a,u){a.hostBindings!==null&&a.hostBindings(1,u)}function F5(a,u){let l=a.directiveRegistry,m=null;if(l)for(let b=0;b<l.length;b++){let r=l[b];Y2(u,r.selectors,!1)&&(m??=[],qc(r)?m.unshift(r):m.push(r))}return m}function k5(a,u,l,m,b,r){let M=r[u];if(M!==null)for(let k=0;k<M.length;k+=2){let U=M[k],ae=M[k+1];gT(m,l,U,ae)}}function hP(a,u,l,m,b){let r=jo+l,M=u[Nn],k=b(M,u,a,m,l);u[r]=k,zg(a,!0);let U=a.type===2;return U?(Q2(u[ao],k,a),(CR()===0||M0(a))&&Uf(k,u),AR()):Uf(k,u),ZE()&&(!U||!fx(a))&&aP(M,u,k,a),a}function fP(a){let u=a;return BE()?VE():(u=u.parent,zg(u,!1)),u}function N5(a,u){let l=a[wd];if(!l)return;l.get(ys,null)?.(u)}function YT(a,u,l,m,b){let r=a.inputs?.[m],M=a.hostDirectiveInputs?.[m],k=!1;if(M)for(let U=0;U<M.length;U+=2){let ae=M[U],Ee=M[U+1],Be=u.data[ae];gT(Be,l[ae],Ee,b),k=!0}if(r)for(let U of r){let ae=l[U],Ee=u.data[U];gT(Ee,ae,m,b),k=!0}return k}function z5(a,u){let l=ra(u,a),m=l[Nn];B5(m,l);let b=l[ta];b!==null&&l[Rf]===null&&(l[Rf]=$2(b,l[wd])),Kr(18),KT(m,l,l[ss]),Kr(19,l[ss])}function B5(a,u){for(let l=u.length;l<a.blueprint.length;l++)u.push(a.blueprint[l])}function KT(a,u,l){k0(u);try{let m=a.viewQuery;m!==null&&pT(1,m,l);let b=a.template;b!==null&&uP(a,u,b,1,l),a.firstCreatePass&&(a.firstCreatePass=!1),u[ja]?.finishViewCreation(a),a.staticContentQueries&&W2(a,u),a.staticViewQueries&&pT(2,a.viewQuery,l);let r=a.components;r!==null&&V5(u,r)}catch(m){throw a.firstCreatePass&&(a.incompleteFirstPass=!0,a.firstCreatePass=!1),m}finally{u[Un]&=-5,N0()}}function V5(a,u){for(let l=0;l<u.length;l++)z5(a,u[l])}function pP(a,u,l,m){let b=pr(null);try{let r=u.tView,k=a[Un]&4096?4096:16,U=HT(a,r,l,k,null,u,null,null,m?.injector??null,m?.embeddedViewInjector??null,m?.dehydratedView??null),ae=a[u.index];U[$c]=ae;let Ee=a[ja];return Ee!==null&&(U[ja]=Ee.createEmbeddedView(r)),KT(r,U,l),U}finally{pr(b)}}function yT(a,u){return!u||u.firstChild===null||N2(a)}var i2=!1,U5=new Kt("");function $g(a,u,l,m,b=!1){for(;l!==null;){if(l.type===128){l=b?l.projectionNext:l.next;continue}let r=u[l.index];r!==null&&m.push(Ps(r)),na(r)&&mP(r,m);let M=l.type;if(M&8)$g(a,u,l.child,m);else if(M&32){let k=WT(l,u),U;for(;U=k();)m.push(U)}else if(M&16){let k=lP(u,l);if(Array.isArray(k))m.push(...k);else{let U=Hc(u[as]);$g(U[Nn],U,k,m,!0)}}l=b?l.projectionNext:l.next}return m}function mP(a,u){for(let l=Ho;l<a.length;l++){let m=a[l],b=m[Nn].firstChild;b!==null&&$g(m[Nn],m,b,u)}a[Wc]!==a[ta]&&u.push(a[Wc])}function gP(a){if(a[Td]!==null){for(let u of a[Td])u.impl.addSequence(u);a[Td].length=0}}var _P=[];function j5(a){return a[_s]??H5(a)}function H5(a){let u=_P.pop()??Object.create($5);return u.lView=a,u}function G5(a){a.lView[_s]!==a&&(a.lView=null,_P.push(a))}var $5=Vr($t({},Xv),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:a=>{Nf(a.lView)},consumerOnSignalRead(){this.lView[_s]=this}});function W5(a){let u=a[_s]??Object.create(Z5);return u.lView=a,u}var Z5=Vr($t({},Xv),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:a=>{let u=Hc(a.lView);for(;u&&!yP(u[Nn]);)u=Hc(u);u&&ME(u)},consumerOnSignalRead(){this.lView[_s]=this}});function yP(a){return a.type!==2}function vP(a){if(a[Lg]===null)return;let u=!0;for(;u;){let l=!1;for(let m of a[Lg])m.dirty&&(l=!0,m.zone===null||Zone.current===m.zone?m.run():m.zone.run(()=>m.run()));u=l&&!!(a[Un]&8192)}}var q5=100;function JT(a,u=0){let m=a[Pl].rendererFactory,b=!1;b||m.begin?.();try{X5(a,u)}finally{b||m.end?.()}}function X5(a,u){let l=jE();try{HE(!0),vT(a,u);let m=0;for(;kg(a);){if(m===q5)throw new en(103,!1);m++,vT(a,1)}}finally{HE(l)}}function xP(a,u){UE(u?Ng.Exhaustive:Ng.OnlyDirtyViews);try{JT(a)}finally{UE(Ng.Off)}}function Y5(a,u,l,m){if(Sd(u))return;let b=u[Un],r=!1,M=!1;k0(u);let k=!0,U=null,ae=null;r||(yP(a)?(ae=j5(u),U=Kv(ae)):qv()===null?(k=!1,ae=W5(u),U=Kv(ae)):u[_s]&&(Aw(u[_s]),u[_s]=null));try{AE(u),OR(a.bindingStartIndex),l!==null&&uP(a,u,l,2,m);let Ee=(b&3)===3;if(!r)if(Ee){let Oe=a.preOrderCheckHooks;Oe!==null&&j0(u,Oe,null)}else{let Oe=a.preOrderHooks;Oe!==null&&H0(u,Oe,0,null),eT(u,0)}if(M||K5(u),vP(u),bP(u,0),a.contentQueries!==null&&W2(a,u),!r)if(Ee){let Oe=a.contentCheckHooks;Oe!==null&&j0(u,Oe)}else{let Oe=a.contentHooks;Oe!==null&&H0(u,Oe,1),eT(u,1)}Q5(a,u);let Be=a.components;Be!==null&&EP(u,Be,0);let ht=a.viewQuery;if(ht!==null&&pT(2,ht,m),!r)if(Ee){let Oe=a.viewCheckHooks;Oe!==null&&j0(u,Oe)}else{let Oe=a.viewHooks;Oe!==null&&H0(u,Oe,2),eT(u,2)}if(a.firstUpdatePass===!0&&(a.firstUpdatePass=!1),u[A0]){for(let Oe of u[A0])Oe();u[A0]=null}r||(gP(u),u[Un]&=-73)}catch(Ee){throw r||Nf(u),Ee}finally{ae!==null&&(Cw(ae,U),k&&G5(ae)),N0()}}function bP(a,u){for(let l=B2(a);l!==null;l=V2(l))for(let m=Ho;m<l.length;m++){let b=l[m];wP(b,u)}}function K5(a){for(let u=B2(a);u!==null;u=V2(u)){if(!(u[Un]&2))continue;let l=u[Id];for(let m=0;m<l.length;m++){let b=l[m];ME(b)}}}function J5(a,u,l){Kr(18);let m=ra(u,a);wP(m,l),Kr(19,m[ss])}function wP(a,u){P0(a)&&vT(a,u)}function vT(a,u){let m=a[Nn],b=a[Un],r=a[_s],M=!!(u===0&&b&16);if(M||=!!(b&64&&u===0),M||=!!(b&1024),M||=!!(r?.dirty&&Jv(r)),M||=!1,r&&(r.dirty=!1),a[Un]&=-9217,M)Y5(m,a,m.template,a[ss]);else if(b&8192){let k=pr(null);try{vP(a),bP(a,1);let U=m.components;U!==null&&EP(a,U,1),gP(a)}finally{pr(k)}}}function EP(a,u,l){for(let m=0;m<u.length;m++)J5(a,u[m],l)}function Q5(a,u){let l=a.hostBindingOpCodes;if(l!==null)try{for(let m=0;m<l.length;m++){let b=l[m];if(b<0)Xc(~b);else{let r=b,M=l[++m],k=l[++m];NR(M,r);let U=u[r];Kr(24,U),k(2,U),Kr(25,U)}}}finally{Xc(-1)}}function QT(a,u){let l=jE()?64:1088;for(a[Pl].changeDetectionScheduler?.notify(u);a;){a[Un]|=l;let m=Hc(a);if(Ff(a)&&!m)return a;a=m}return null}function TP(a,u,l,m){return[a,!0,0,u,null,m,null,l,null,null]}function IP(a,u,l,m=!0){let b=u[Nn];if(eV(b,u,a,l),m){let M=_T(l,a),k=u[ao],U=k.parentNode(a[Wc]);U!==null&&m5(b,a[Uo],k,u,U,M)}let r=u[Rf];r!==null&&r.firstChild!==null&&(r.firstChild=null)}function xT(a,u){if(a.length<=Ho)return;let l=Ho+u,m=a[l];if(m){let b=m[$c];b!==null&&b!==a&&ZT(b,m),u>0&&(a[l-1][Rs]=m[Rs]);let r=Mg(a,Ho+u);p5(m[Nn],m);let M=r[ja];M!==null&&M.detachView(r[Nn]),m[Zi]=null,m[Rs]=null,m[Un]&=-129}return m}function eV(a,u,l,m){let b=Ho+m,r=l.length;m>0&&(l[b-1][Rs]=u),m<r-Ho?(u[Rs]=l[b],gE(l,Ho+m,u)):(l.push(u),u[Rs]=null),u[Zi]=l;let M=u[$c];M!==null&&l!==M&&SP(M,u);let k=u[ja];k!==null&&k.insertView(a),O0(u),u[Un]|=128}function SP(a,u){let l=a[Id],m=u[Zi];if(Ol(m))a[Un]|=2;else{let b=m[Zi][as];u[as]!==b&&(a[Un]|=2)}l===null?a[Id]=[u]:l.push(u)}var Yc=class{_lView;_cdRefInjectingView;_appRef=null;_attachedToViewContainer=!1;exhaustive;get rootNodes(){let u=this._lView,l=u[Nn];return $g(l,u,l.firstChild,[])}constructor(u,l){this._lView=u,this._cdRefInjectingView=l}get context(){return this._lView[ss]}set context(u){this._lView[ss]=u}get destroyed(){return Sd(this._lView)}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let u=this._lView[Zi];if(na(u)){let l=u[Fg],m=l?l.indexOf(this):-1;m>-1&&(xT(u,m),Mg(l,m))}this._attachedToViewContainer=!1}iP(this._lView[Nn],this._lView)}onDestroy(u){RE(this._lView,u)}markForCheck(){QT(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[Un]&=-129}reattach(){O0(this._lView),this._lView[Un]|=128}detectChanges(){this._lView[Un]|=1024,JT(this._lView)}checkNoChanges(){return;try{this.exhaustive??=this._lView[wd].get(U5,i2)}catch{this.exhaustive=i2}}attachToViewContainerRef(){if(this._appRef)throw new en(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let u=Ff(this._lView),l=this._lView[$c];l!==null&&!u&&ZT(l,this._lView),rP(this._lView[Nn],this._lView)}attachToAppRef(u){if(this._attachedToViewContainer)throw new en(902,!1);this._appRef=u;let l=Ff(this._lView),m=this._lView[$c];m!==null&&!l&&SP(m,this._lView),O0(this._lView)}};var jf=(()=>{class a{_declarationLView;_declarationTContainer;elementRef;static __NG_ELEMENT_ID__=tV;constructor(l,m,b){this._declarationLView=l,this._declarationTContainer=m,this.elementRef=b}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(l,m){return this.createEmbeddedViewImpl(l,m)}createEmbeddedViewImpl(l,m,b){let r=pP(this._declarationLView,this._declarationTContainer,l,{embeddedViewInjector:m,dehydratedView:b});return new Yc(r)}}return a})();function tV(){return eI(ls(),si())}function eI(a,u){return a.type&4?new jf(u,a,$f(a,u)):null}function _x(a,u,l,m,b){let r=a.data[u];if(r===null)r=nV(a,u,l,m,b),kR()&&(r.flags|=32);else if(r.type&64){r.type=l,r.value=m,r.attrs=b;let M=RR();r.injectorIndex=M===null?-1:M.injectorIndex}return zg(r,!0),r}function nV(a,u,l,m,b){let r=zE(),M=BE(),k=M?r:r&&r.parent,U=a.data[u]=iV(a,k,l,u,m,b);return rV(a,U,r,M),U}function rV(a,u,l,m){a.firstChild===null&&(a.firstChild=u),l!==null&&(m?l.child==null&&u.parent!==null&&(l.child=u):l.next===null&&(l.next=u,u.prev=l))}function iV(a,u,l,m,b,r){let M=u?u.injectorIndex:-1,k=0;return FE()&&(k|=128),{type:l,index:m,insertBeforeIndex:null,injectorIndex:M,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:k,providerIndexes:0,value:b,attrs:r,mergedAttrs:null,localNames:null,initialInputs:null,inputs:null,hostDirectiveInputs:null,outputs:null,hostDirectiveOutputs:null,directiveToIndex:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:u,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}var D7=new RegExp(`^(\\d+)*(${$B}|${GB})*(.*)`);var oV=()=>null;function bT(a,u){return oV(a,u)}var DP=class{},yx=class{},wT=class{resolveComponentFactory(u){throw new en(917,!1)}},Kg=class{static NULL=new wT},Ad=class{};var CP=(()=>{class a{static \u0275prov=Zt({token:a,providedIn:"root",factory:()=>null})}return a})();var $0={},ET=class{injector;parentInjector;constructor(u,l){this.injector=u,this.parentInjector=l}get(u,l,m){let b=this.injector.get(u,$0,m);return b!==$0||l===$0?b:this.parentInjector.get(u,l,m)}};function J0(a,u,l){let m=l?a.styles:null,b=l?a.classes:null,r=0;if(u!==null)for(let M=0;M<u.length;M++){let k=u[M];if(typeof k=="number")r=k;else if(r==1)b=E0(b,k);else if(r==2){let U=k,ae=u[++M];m=E0(m,U+": "+ae+";")}}l?a.styles=m:a.stylesWithoutHost=m,l?a.classes=b:a.classesWithoutHost=b}function Qc(a,u=0){let l=si();if(l===null)return ln(a,u);let m=ls();return L2(m,l,so(a),u)}function tI(){let a="invalid";throw new Error(a)}function sV(a,u,l,m,b){let r=m===null?null:{"":-1},M=b(a,l);if(M!==null){let k=M,U=null,ae=null;for(let Ee of M)if(Ee.resolveHostDirectives!==null){[k,U,ae]=Ee.resolveHostDirectives(M);break}cV(a,u,l,k,r,U,ae)}r!==null&&m!==null&&aV(l,m,r)}function aV(a,u,l){let m=a.localNames=[];for(let b=0;b<u.length;b+=2){let r=l[u[b+1]];if(r==null)throw new en(-301,!1);m.push(u[b],r)}}function lV(a,u,l){u.componentOffset=l,(a.components??=[]).push(u.index)}function cV(a,u,l,m,b,r,M){let k=m.length,U=!1;for(let ht=0;ht<k;ht++){let Oe=m[ht];!U&&qc(Oe)&&(U=!0,lV(a,l,ht)),uT(X0(l,u),a,Oe.type)}mV(l,a.data.length,k);for(let ht=0;ht<k;ht++){let Oe=m[ht];Oe.providersResolver&&Oe.providersResolver(Oe)}let ae=!1,Ee=!1,Be=tP(a,u,k,null);k>0&&(l.directiveToIndex=new Map);for(let ht=0;ht<k;ht++){let Oe=m[ht];if(l.mergedAttrs=lx(l.mergedAttrs,Oe.hostAttrs),dV(a,l,u,Be,Oe),pV(Be,Oe,b),M!==null&&M.has(Oe)){let[Vt,Ut]=M.get(Oe);l.directiveToIndex.set(Oe.type,[Be,Vt+l.directiveStart,Ut+l.directiveStart])}else(r===null||!r.has(Oe))&&l.directiveToIndex.set(Oe.type,Be);Oe.contentQueries!==null&&(l.flags|=4),(Oe.hostBindings!==null||Oe.hostAttrs!==null||Oe.hostVars!==0)&&(l.flags|=64);let Ct=Oe.type.prototype;!ae&&(Ct.ngOnChanges||Ct.ngOnInit||Ct.ngDoCheck)&&((a.preOrderHooks??=[]).push(l.index),ae=!0),!Ee&&(Ct.ngOnChanges||Ct.ngDoCheck)&&((a.preOrderCheckHooks??=[]).push(l.index),Ee=!0),Be++}uV(a,l,r)}function uV(a,u,l){for(let m=u.directiveStart;m<u.directiveEnd;m++){let b=a.data[m];if(l===null||!l.has(b))o2(0,u,b,m),o2(1,u,b,m),a2(u,m,!1);else{let r=l.get(b);s2(0,u,r,m),s2(1,u,r,m),a2(u,m,!0)}}}function o2(a,u,l,m){let b=a===0?l.inputs:l.outputs;for(let r in b)if(b.hasOwnProperty(r)){let M;a===0?M=u.inputs??={}:M=u.outputs??={},M[r]??=[],M[r].push(m),AP(u,r)}}function s2(a,u,l,m){let b=a===0?l.inputs:l.outputs;for(let r in b)if(b.hasOwnProperty(r)){let M=b[r],k;a===0?k=u.hostDirectiveInputs??={}:k=u.hostDirectiveOutputs??={},k[M]??=[],k[M].push(m,r),AP(u,M)}}function AP(a,u){u==="class"?a.flags|=8:u==="style"&&(a.flags|=16)}function a2(a,u,l){let{attrs:m,inputs:b,hostDirectiveInputs:r}=a;if(m===null||!l&&b===null||l&&r===null||UT(a)){a.initialInputs??=[],a.initialInputs.push(null);return}let M=null,k=0;for(;k<m.length;){let U=m[k];if(U===0){k+=4;continue}else if(U===5){k+=2;continue}else if(typeof U=="number")break;if(!l&&b.hasOwnProperty(U)){let ae=b[U];for(let Ee of ae)if(Ee===u){M??=[],M.push(U,m[k+1]);break}}else if(l&&r.hasOwnProperty(U)){let ae=r[U];for(let Ee=0;Ee<ae.length;Ee+=2)if(ae[Ee]===u){M??=[],M.push(ae[Ee+1],m[k+1]);break}}k+=2}a.initialInputs??=[],a.initialInputs.push(M)}function dV(a,u,l,m,b){a.data[m]=b;let r=b.factory||(b.factory=gd(b.type,!0)),M=new Cd(r,qc(b),Qc,null);a.blueprint[m]=M,l[m]=M,hV(a,u,m,tP(a,l,b.hostVars,Jc),b)}function hV(a,u,l,m,b){let r=b.hostBindings;if(r){let M=a.hostBindingOpCodes;M===null&&(M=a.hostBindingOpCodes=[]);let k=~u.index;fV(M)!=k&&M.push(k),M.push(l,m,r)}}function fV(a){let u=a.length;for(;u>0;){let l=a[--u];if(typeof l=="number"&&l<0)return l}return 0}function pV(a,u,l){if(l){if(u.exportAs)for(let m=0;m<u.exportAs.length;m++)l[u.exportAs[m]]=a;qc(u)&&(l[""]=a)}}function mV(a,u,l){a.flags|=1,a.directiveStart=u,a.directiveEnd=u+l,a.providerIndexes=u}function MP(a,u,l,m,b,r,M,k){let U=u[Nn],ae=U.consts,Ee=kf(ae,M),Be=_x(U,a,l,m,Ee);return r&&sV(U,u,Be,kf(ae,k),b),Be.mergedAttrs=lx(Be.mergedAttrs,Be.attrs),Be.attrs!==null&&J0(Be,Be.attrs,!1),Be.mergedAttrs!==null&&J0(Be,Be.mergedAttrs,!0),U.queries!==null&&U.queries.elementStart(U,Be),Be}function RP(a,u){wB(a,u),CE(u)&&a.queries.elementEnd(u)}function gV(a,u,l,m,b,r){let M=u.consts,k=kf(M,b),U=_x(u,a,l,m,k);if(U.mergedAttrs=lx(U.mergedAttrs,U.attrs),r!=null){let ae=kf(M,r);U.localNames=[];for(let Ee=0;Ee<ae.length;Ee+=2)U.localNames.push(ae[Ee],-1)}return U.attrs!==null&&J0(U,U.attrs,!1),U.mergedAttrs!==null&&J0(U,U.mergedAttrs,!0),u.queries!==null&&u.queries.elementStart(u,U),U}function _V(a,u,l){return a[u]=l}function nI(a,u,l){if(l===Jc)return!1;let m=a[u];return Object.is(m,l)?!1:(a[u]=l,!0)}function rT(a,u,l){return function m(b){let r=Zc(a)?ra(a.index,u):u;QT(r,5);let M=u[ss],k=l2(u,M,l,b),U=m.__ngNextListenerFn__;for(;U;)k=l2(u,M,U,b)&&k,U=U.__ngNextListenerFn__;return k}}function l2(a,u,l,m){let b=pr(null);try{return Kr(6,u,l),l(m)!==!1}catch(r){return N5(a,r),!1}finally{Kr(7,u,l),pr(b)}}function yV(a,u,l,m,b,r,M,k){let U=M0(a),ae=!1,Ee=null;if(!m&&U&&(Ee=vV(u,l,r,a.index)),Ee!==null){let Be=Ee.__ngLastListenerFn__||Ee;Be.__ngNextListenerFn__=M,Ee.__ngLastListenerFn__=M,ae=!0}else{let Be=Ha(a,l),ht=m?m(Be):Be;ZB(l,ht,r,k);let Oe=b.listen(ht,r,k),Ct=m?Vt=>m(Ps(Vt[a.index])):a.index;PP(Ct,u,l,r,k,Oe,!1)}return ae}function vV(a,u,l,m){let b=a.cleanup;if(b!=null)for(let r=0;r<b.length-1;r+=2){let M=b[r];if(M===l&&b[r+1]===m){let k=u[Pf],U=b[r+2];return k&&k.length>U?k[U]:null}typeof M=="string"&&(r+=2)}return null}function PP(a,u,l,m,b,r,M){let k=u.firstCreatePass?OE(u):null,U=PE(l),ae=U.length;U.push(b,r),k&&k.push(m,a,ae,(ae+1)*(M?-1:1))}function c2(a,u,l,m,b,r){let M=u[l],k=u[Nn],ae=k.data[l].outputs[m],Be=M[ae].subscribe(r);PP(a.index,k,u,b,r,Be,!0)}var TT=Symbol("BINDING");var Q0=class extends Kg{ngModule;constructor(u){super(),this.ngModule=u}resolveComponentFactory(u){let l=Rl(u);return new Md(l,this.ngModule)}};function xV(a){return Object.keys(a).map(u=>{let[l,m,b]=a[u],r={propName:l,templateName:u,isSignal:(m&mx.SignalBased)!==0};return b&&(r.transform=b),r})}function bV(a){return Object.keys(a).map(u=>({propName:a[u],templateName:u}))}function wV(a,u,l){let m=u instanceof wi?u:u?.injector;return m&&a.getStandaloneInjector!==null&&(m=a.getStandaloneInjector(m)||m),m?new ET(l,m):l}function EV(a){let u=a.get(Ad,null);if(u===null)throw new en(407,!1);let l=a.get(CP,null),m=a.get(Al,null);return{rendererFactory:u,sanitizer:l,changeDetectionScheduler:m,ngReflect:!1}}function TV(a,u){let l=(a.selectors[0][0]||"div").toLowerCase();return K2(u,l,l==="svg"?bR:l==="math"?wR:null)}var Md=class extends yx{componentDef;ngModule;selector;componentType;ngContentSelectors;isBoundToModule;cachedInputs=null;cachedOutputs=null;get inputs(){return this.cachedInputs??=xV(this.componentDef.inputs),this.cachedInputs}get outputs(){return this.cachedOutputs??=bV(this.componentDef.outputs),this.cachedOutputs}constructor(u,l){super(),this.componentDef=u,this.ngModule=l,this.componentType=u.type,this.selector=o5(u.selectors),this.ngContentSelectors=u.ngContentSelectors??[],this.isBoundToModule=!!l}create(u,l,m,b,r,M){Kr(22);let k=pr(null);try{let U=this.componentDef,ae=IV(m,U,M,r),Ee=wV(U,b||this.ngModule,u),Be=EV(Ee),ht=Be.rendererFactory.createRenderer(null,U),Oe=m?I5(ht,m,U.encapsulation,Ee):TV(U,ht),Ct=M?.some(u2)||r?.some(Nt=>typeof Nt!="function"&&Nt.bindings.some(u2)),Vt=HT(null,ae,null,512|eP(U),null,null,Be,ht,Ee,null,$2(Oe,Ee,!0));Vt[jo]=Oe,k0(Vt);let Ut=null;try{let Nt=MP(jo,Vt,2,"#host",()=>ae.directiveRegistry,!0,0);Oe&&(Q2(ht,Oe,Nt),Uf(Oe,Vt)),dP(ae,Vt,Nt),Z2(ae,Nt,Vt),RP(ae,Nt),l!==void 0&&DV(Nt,this.ngContentSelectors,l),Ut=ra(Nt.index,Vt),Vt[ss]=Ut[ss],KT(ae,Vt,null)}catch(Nt){throw Ut!==null&&hT(Ut),hT(Vt),Nt}finally{Kr(23),N0()}return new ex(this.componentType,Vt,!!Ct)}finally{pr(k)}}};function IV(a,u,l,m){let b=a?["ng-version","20.1.6"]:s5(u.selectors[0]),r=null,M=null,k=0;if(l)for(let Ee of l)k+=Ee[TT].requiredVars,Ee.create&&(Ee.targetIdx=0,(r??=[]).push(Ee)),Ee.update&&(Ee.targetIdx=0,(M??=[]).push(Ee));if(m)for(let Ee=0;Ee<m.length;Ee++){let Be=m[Ee];if(typeof Be!="function")for(let ht of Be.bindings){k+=ht[TT].requiredVars;let Oe=Ee+1;ht.create&&(ht.targetIdx=Oe,(r??=[]).push(ht)),ht.update&&(ht.targetIdx=Oe,(M??=[]).push(ht))}}let U=[u];if(m)for(let Ee of m){let Be=typeof Ee=="function"?Ee:Ee.type,ht=bE(Be);U.push(ht)}return jT(0,null,SV(r,M),1,k,U,null,null,null,[b],null)}function SV(a,u){return!a&&!u?null:l=>{if(l&1&&a)for(let m of a)m.create();if(l&2&&u)for(let m of u)m.update()}}function u2(a){let u=a[TT].kind;return u==="input"||u==="twoWay"}var ex=class extends DP{_rootLView;_hasInputBindings;instance;hostView;changeDetectorRef;componentType;location;previousInputValues=null;_tNode;constructor(u,l,m){super(),this._rootLView=l,this._hasInputBindings=m,this._tNode=R0(l[Nn],jo),this.location=$f(this._tNode,l),this.instance=ra(this._tNode.index,l)[ss],this.hostView=this.changeDetectorRef=new Yc(l,void 0),this.componentType=u}setInput(u,l){this._hasInputBindings;let m=this._tNode;if(this.previousInputValues??=new Map,this.previousInputValues.has(u)&&Object.is(this.previousInputValues.get(u),l))return;let b=this._rootLView,r=YT(m,b[Nn],b,u,l);this.previousInputValues.set(u,l);let M=ra(m.index,b);QT(M,1)}get injector(){return new Dd(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(u){this.hostView.onDestroy(u)}};function DV(a,u,l){let m=a.projection=[];for(let b=0;b<u.length;b++){let r=l[b];m.push(r!=null&&r.length?Array.from(r):null)}}var Od=(()=>{class a{static __NG_ELEMENT_ID__=CV}return a})();function CV(){let a=ls();return LP(a,si())}var AV=Od,OP=class extends AV{_lContainer;_hostTNode;_hostLView;constructor(u,l,m){super(),this._lContainer=u,this._hostTNode=l,this._hostLView=m}get element(){return $f(this._hostTNode,this._hostLView)}get injector(){return new Dd(this._hostTNode,this._hostLView)}get parentInjector(){let u=zT(this._hostTNode,this._hostLView);if(C2(u)){let l=q0(u,this._hostLView),m=Z0(u),b=l[Nn].data[m+8];return new Dd(b,l)}else return new Dd(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(u){let l=d2(this._lContainer);return l!==null&&l[u]||null}get length(){return this._lContainer.length-Ho}createEmbeddedView(u,l,m){let b,r;typeof m=="number"?b=m:m!=null&&(b=m.index,r=m.injector);let M=bT(this._lContainer,u.ssrId),k=u.createEmbeddedViewImpl(l||{},r,M);return this.insertImpl(k,b,yT(this._hostTNode,M)),k}createComponent(u,l,m,b,r,M,k){let U=u&&!_B(u),ae;if(U)ae=l;else{let Ut=l||{};ae=Ut.index,m=Ut.injector,b=Ut.projectableNodes,r=Ut.environmentInjector||Ut.ngModuleRef,M=Ut.directives,k=Ut.bindings}let Ee=U?u:new Md(Rl(u)),Be=m||this.parentInjector;if(!r&&Ee.ngModule==null){let Nt=(U?Be:this.parentInjector).get(wi,null);Nt&&(r=Nt)}let ht=Rl(Ee.componentType??{}),Oe=bT(this._lContainer,ht?.id??null),Ct=Oe?.firstChild??null,Vt=Ee.create(Be,b,Ct,r,M,k);return this.insertImpl(Vt.hostView,ae,yT(this._hostTNode,Oe)),Vt}insert(u,l){return this.insertImpl(u,l,!0)}insertImpl(u,l,m){let b=u._lView;if(IR(b)){let k=this.indexOf(u);if(k!==-1)this.detach(k);else{let U=b[Zi],ae=new OP(U,U[Uo],U[Zi]);ae.detach(ae.indexOf(u))}}let r=this._adjustIndex(l),M=this._lContainer;return IP(M,b,r,m),u.attachToViewContainerRef(),gE(iT(M),r,u),u}move(u,l){return this.insert(u,l)}indexOf(u){let l=d2(this._lContainer);return l!==null?l.indexOf(u):-1}remove(u){let l=this._adjustIndex(u,-1),m=xT(this._lContainer,l);m&&(Mg(iT(this._lContainer),l),iP(m[Nn],m))}detach(u){let l=this._adjustIndex(u,-1),m=xT(this._lContainer,l);return m&&Mg(iT(this._lContainer),l)!=null?new Yc(m):null}_adjustIndex(u,l=0){return u??this.length+l}};function d2(a){return a[Fg]}function iT(a){return a[Fg]||(a[Fg]=[])}function LP(a,u){let l,m=u[a.index];return na(m)?l=m:(l=TP(m,u,null,a),u[a.index]=l,GT(u,l)),RV(l,u,a,m),new OP(l,a,u)}function MV(a,u){let l=a[ao],m=l.createComment(""),b=Ha(u,a),r=l.parentNode(b);return K0(l,r,m,l.nextSibling(b),!1),m}var RV=LV,PV=()=>!1;function OV(a,u,l){return PV(a,u,l)}function LV(a,u,l,m){if(a[Wc])return;let b;l.type&8?b=Ps(m):b=MV(u,l),a[Wc]=b}var IT=class a{queryList;matches=null;constructor(u){this.queryList=u}clone(){return new a(this.queryList)}setDirty(){this.queryList.setDirty()}},ST=class a{queries;constructor(u=[]){this.queries=u}createEmbeddedView(u){let l=u.queries;if(l!==null){let m=u.contentQueries!==null?u.contentQueries[0]:l.length,b=[];for(let r=0;r<m;r++){let M=l.getByIndex(r),k=this.queries[M.indexInDeclarationView];b.push(k.clone())}return new a(b)}return null}insertView(u){this.dirtyQueriesWithMatches(u)}detachView(u){this.dirtyQueriesWithMatches(u)}finishViewCreation(u){this.dirtyQueriesWithMatches(u)}dirtyQueriesWithMatches(u){for(let l=0;l<this.queries.length;l++)rI(u,l).matches!==null&&this.queries[l].setDirty()}},DT=class{flags;read;predicate;constructor(u,l,m=null){this.flags=l,this.read=m,typeof u=="string"?this.predicate=jV(u):this.predicate=u}},CT=class a{queries;constructor(u=[]){this.queries=u}elementStart(u,l){for(let m=0;m<this.queries.length;m++)this.queries[m].elementStart(u,l)}elementEnd(u){for(let l=0;l<this.queries.length;l++)this.queries[l].elementEnd(u)}embeddedTView(u){let l=null;for(let m=0;m<this.length;m++){let b=l!==null?l.length:0,r=this.getByIndex(m).embeddedTView(u,b);r&&(r.indexInDeclarationView=m,l!==null?l.push(r):l=[r])}return l!==null?new a(l):null}template(u,l){for(let m=0;m<this.queries.length;m++)this.queries[m].template(u,l)}getByIndex(u){return this.queries[u]}get length(){return this.queries.length}track(u){this.queries.push(u)}},AT=class a{metadata;matches=null;indexInDeclarationView=-1;crossesNgTemplate=!1;_declarationNodeIndex;_appliesToNextNode=!0;constructor(u,l=-1){this.metadata=u,this._declarationNodeIndex=l}elementStart(u,l){this.isApplyingToNode(l)&&this.matchTNode(u,l)}elementEnd(u){this._declarationNodeIndex===u.index&&(this._appliesToNextNode=!1)}template(u,l){this.elementStart(u,l)}embeddedTView(u,l){return this.isApplyingToNode(u)?(this.crossesNgTemplate=!0,this.addMatch(-u.index,l),new a(this.metadata)):null}isApplyingToNode(u){if(this._appliesToNextNode&&(this.metadata.flags&1)!==1){let l=this._declarationNodeIndex,m=u.parent;for(;m!==null&&m.type&8&&m.index!==l;)m=m.parent;return l===(m!==null?m.index:-1)}return this._appliesToNextNode}matchTNode(u,l){let m=this.metadata.predicate;if(Array.isArray(m))for(let b=0;b<m.length;b++){let r=m[b];this.matchTNodeWithReadOption(u,l,FV(l,r)),this.matchTNodeWithReadOption(u,l,G0(l,u,r,!1,!1))}else m===jf?l.type&4&&this.matchTNodeWithReadOption(u,l,-1):this.matchTNodeWithReadOption(u,l,G0(l,u,m,!1,!1))}matchTNodeWithReadOption(u,l,m){if(m!==null){let b=this.metadata.read;if(b!==null)if(b===Kc||b===Od||b===jf&&l.type&4)this.addMatch(l.index,-2);else{let r=G0(l,u,b,!1,!1);r!==null&&this.addMatch(l.index,r)}else this.addMatch(l.index,m)}}addMatch(u,l){this.matches===null?this.matches=[u,l]:this.matches.push(u,l)}};function FV(a,u){let l=a.localNames;if(l!==null){for(let m=0;m<l.length;m+=2)if(l[m]===u)return l[m+1]}return null}function kV(a,u){return a.type&11?$f(a,u):a.type&4?eI(a,u):null}function NV(a,u,l,m){return l===-1?kV(u,a):l===-2?zV(a,u,m):Gg(a,a[Nn],l,u)}function zV(a,u,l){if(l===Kc)return $f(u,a);if(l===jf)return eI(u,a);if(l===Od)return LP(u,a)}function FP(a,u,l,m){let b=u[ja].queries[m];if(b.matches===null){let r=a.data,M=l.matches,k=[];for(let U=0;M!==null&&U<M.length;U+=2){let ae=M[U];if(ae<0)k.push(null);else{let Ee=r[ae];k.push(NV(u,Ee,M[U+1],l.metadata.read))}}b.matches=k}return b.matches}function MT(a,u,l,m){let b=a.queries.getByIndex(l),r=b.matches;if(r!==null){let M=FP(a,u,b,l);for(let k=0;k<r.length;k+=2){let U=r[k];if(U>0)m.push(M[k/2]);else{let ae=r[k+1],Ee=u[-U];for(let Be=Ho;Be<Ee.length;Be++){let ht=Ee[Be];ht[$c]===ht[Zi]&&MT(ht[Nn],ht,ae,m)}if(Ee[Id]!==null){let Be=Ee[Id];for(let ht=0;ht<Be.length;ht++){let Oe=Be[ht];MT(Oe[Nn],Oe,ae,m)}}}}}return m}function BV(a,u){return a[ja].queries[u].queryList}function VV(a,u,l){let m=new Y0((l&4)===4);return DR(a,u,m,m.destroy),(u[ja]??=new ST).queries.push(new IT(m))-1}function UV(a,u,l){let m=ia();return m.firstCreatePass&&(HV(m,new DT(a,u,l),-1),(u&2)===2&&(m.staticViewQueries=!0)),VV(m,si(),u)}function jV(a){return a.split(",").map(u=>u.trim())}function HV(a,u,l){a.queries===null&&(a.queries=new CT),a.queries.track(new AT(u,l))}function rI(a,u){return a.queries.getByIndex(u)}function GV(a,u){let l=a[Nn],m=rI(l,u);return m.crossesNgTemplate?MT(l,a,u,[]):FP(l,a,m,u)}function kP(a){let u=[],l=new Map;function m(b){let r=l.get(b);if(!r){let M=a(b);l.set(b,r=M.then(k=>WV(b,k)))}return r}return tx.forEach((b,r)=>{let M=[];b.templateUrl&&M.push(m(b.templateUrl).then(ae=>{b.template=ae}));let k=typeof b.styles=="string"?[b.styles]:b.styles||[];if(b.styles=k,b.styleUrl&&b.styleUrls?.length)throw new Error("@Component cannot define both `styleUrl` and `styleUrls`. Use `styleUrl` if the component has one stylesheet, or `styleUrls` if it has multiple");if(b.styleUrls?.length){let ae=b.styles.length,Ee=b.styleUrls;b.styleUrls.forEach((Be,ht)=>{k.push(""),M.push(m(Be).then(Oe=>{k[ae+ht]=Oe,Ee.splice(Ee.indexOf(Be),1),Ee.length==0&&(b.styleUrls=void 0)}))})}else b.styleUrl&&M.push(m(b.styleUrl).then(ae=>{k.push(ae),b.styleUrl=void 0}));let U=Promise.all(M).then(()=>ZV(r));u.push(U)}),NP(),Promise.all(u).then(()=>{})}var tx=new Map,$V=new Set;function NP(){let a=tx;return tx=new Map,a}function zP(){return tx.size===0}function WV(a,u){return typeof u=="string"?u:u.status!==void 0&&u.status!==200?Promise.reject(new en(918,!1)):u.text()}function ZV(a){$V.delete(a)}var h2=new Set;function Ld(a){h2.has(a)||(h2.add(a),performance?.mark?.("mark_feature_usage",{detail:{feature:a}}))}var Hf=class{},vx=class{};var Wg=class extends Hf{ngModuleType;_parent;_bootstrapComponents=[];_r3Injector;instance;destroyCbs=[];componentFactoryResolver=new Q0(this);constructor(u,l,m,b=!0){super(),this.ngModuleType=u,this._parent=l;let r=xE(u);this._bootstrapComponents=q2(r.bootstrap),this._r3Injector=XE(u,l,[{provide:Hf,useValue:this},{provide:Kg,useValue:this.componentFactoryResolver},...m],jc(u),new Set(["environment"])),b&&this.resolveInjectorInitializers()}resolveInjectorInitializers(){this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(this.ngModuleType)}get injector(){return this._r3Injector}destroy(){let u=this._r3Injector;!u.destroyed&&u.destroy(),this.destroyCbs.forEach(l=>l()),this.destroyCbs=null}onDestroy(u){this.destroyCbs.push(u)}},Zg=class extends vx{moduleType;constructor(u){super(),this.moduleType=u}create(u){return new Wg(this.moduleType,u,[])}};function BP(a,u,l){return new Wg(a,u,l,!1)}var nx=class extends Hf{injector;componentFactoryResolver=new Q0(this);instance=null;constructor(u){super();let l=new yd([...u.providers,{provide:Hf,useValue:this},{provide:Kg,useValue:this.componentFactoryResolver}],u.parent||Pg(),u.debugName,new Set(["environment"]));this.injector=l,u.runEnvironmentInitializers&&l.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(u){this.injector.onDestroy(u)}};function Zf(a,u,l=null){return new nx({providers:a,parent:u,debugName:l,runEnvironmentInitializers:!0}).injector}var qV=(()=>{class a{_injector;cachedInjectors=new Map;constructor(l){this._injector=l}getOrCreateStandaloneInjector(l){if(!l.standalone)return null;if(!this.cachedInjectors.has(l)){let m=wE(!1,l.type),b=m.length>0?Zf([m],this._injector,`Standalone[${l.type.name}]`):null;this.cachedInjectors.set(l,b)}return this.cachedInjectors.get(l)}ngOnDestroy(){try{for(let l of this.cachedInjectors.values())l!==null&&l.destroy()}finally{this.cachedInjectors.clear()}}static \u0275prov=Zt({token:a,providedIn:"environment",factory:()=>new a(ln(wi))})}return a})();function kl(a){return Yg(()=>{let u=VP(a),l=Vr($t({},u),{decls:a.decls,vars:a.vars,template:a.template,consts:a.consts||null,ngContentSelectors:a.ngContentSelectors,onPush:a.changeDetection===BT.OnPush,directiveDefs:null,pipeDefs:null,dependencies:u.standalone&&a.dependencies||null,getStandaloneInjector:u.standalone?b=>b.get(qV).getOrCreateStandaloneInjector(l):null,getExternalStyles:null,signals:a.signals??!1,data:a.data||{},encapsulation:a.encapsulation||Ll.Emulated,styles:a.styles||os,_:null,schemas:a.schemas||null,tView:null,id:""});u.standalone&&Ld("NgStandalone"),UP(l);let m=a.dependencies;return l.directiveDefs=f2(m,XV),l.pipeDefs=f2(m,pR),l.id=JV(l),l})}function XV(a){return Rl(a)||bE(a)}function $o(a){return Yg(()=>({type:a.type,bootstrap:a.bootstrap||os,declarations:a.declarations||os,imports:a.imports||os,exports:a.exports||os,transitiveCompileScopes:null,schemas:a.schemas||null,id:a.id||null}))}function YV(a,u){if(a==null)return bd;let l={};for(let m in a)if(a.hasOwnProperty(m)){let b=a[m],r,M,k,U;Array.isArray(b)?(k=b[0],r=b[1],M=b[2]??r,U=b[3]||null):(r=b,M=b,k=mx.None,U=null),l[r]=[m,k,U],u[r]=M}return l}function KV(a){if(a==null)return bd;let u={};for(let l in a)a.hasOwnProperty(l)&&(u[a[l]]=l);return u}function Jg(a){return Yg(()=>{let u=VP(a);return UP(u),u})}function VP(a){let u={};return{type:a.type,providersResolver:null,factory:null,hostBindings:a.hostBindings||null,hostVars:a.hostVars||0,hostAttrs:a.hostAttrs||null,contentQueries:a.contentQueries||null,declaredInputs:u,inputConfig:a.inputs||bd,exportAs:a.exportAs||null,standalone:a.standalone??!0,signals:a.signals===!0,selectors:a.selectors||os,viewQuery:a.viewQuery||null,features:a.features||null,setInput:null,resolveHostDirectives:null,hostDirectives:null,inputs:YV(a.inputs,u),outputs:KV(a.outputs),debugInfo:null}}function UP(a){a.features?.forEach(u=>u(a))}function f2(a,u){return a?()=>{let l=typeof a=="function"?a():a,m=[];for(let b of l){let r=u(b);r!==null&&m.push(r)}return m}:null}function JV(a){let u=0,l=typeof a.consts=="function"?"":a.consts,m=[a.selectors,a.ngContentSelectors,a.hostVars,a.hostAttrs,l,a.vars,a.decls,a.encapsulation,a.standalone,a.signals,a.exportAs,JSON.stringify(a.inputs),JSON.stringify(a.outputs),Object.getOwnPropertyNames(a.type.prototype),!!a.contentQueries,!!a.viewQuery];for(let r of m.join("|"))u=Math.imul(31,u)+r.charCodeAt(0)<<0;return u+=2147483648,"c"+u}function QV(a,u,l,m,b,r,M,k){if(l.firstCreatePass){a.mergedAttrs=lx(a.mergedAttrs,a.attrs);let Ee=a.tView=jT(2,a,b,r,M,l.directiveRegistry,l.pipeRegistry,null,l.schemas,l.consts,null);l.queries!==null&&(l.queries.template(l,a),Ee.queries=l.queries.embeddedTView(a))}k&&(a.flags|=k),zg(a,!1);let U=t4(l,u,a,m);ZE()&&aP(l,u,U,a),Uf(U,u);let ae=TP(U,u,U,a);u[m+jo]=ae,GT(u,ae),OV(ae,a,u)}function e4(a,u,l,m,b,r,M,k,U,ae,Ee){let Be=l+jo,ht;if(u.firstCreatePass){if(ht=_x(u,Be,4,M||null,k||null),ae!=null){let Oe=kf(u.consts,ae);ht.localNames=[];for(let Ct=0;Ct<Oe.length;Ct+=2)ht.localNames.push(Oe[Ct],-1)}}else ht=u.data[Be];return QV(ht,a,u,l,m,b,r,U),ae!=null&&XT(a,ht,Ee),ht}var t4=n4;function n4(a,u,l,m){return qE(!0),u[ao].createComment("")}var xx=function(a){return a[a.CHANGE_DETECTION=0]="CHANGE_DETECTION",a[a.AFTER_NEXT_RENDER=1]="AFTER_NEXT_RENDER",a}(xx||{}),Fd=new Kt(""),jP=!1,RT=class extends Ai{__isAsync;destroyRef=void 0;pendingTasks=void 0;constructor(u=!1){super(),this.__isAsync=u,IE()&&(this.destroyRef=ut(Ga,{optional:!0})??void 0,this.pendingTasks=ut($a,{optional:!0})??void 0)}emit(u){let l=pr(null);try{super.next(u)}finally{pr(l)}}subscribe(u,l,m){let b=u,r=l||(()=>null),M=m;if(u&&typeof u=="object"){let U=u;b=U.next?.bind(U),r=U.error?.bind(U),M=U.complete?.bind(U)}this.__isAsync&&(r=this.wrapInTimeout(r),b&&(b=this.wrapInTimeout(b)),M&&(M=this.wrapInTimeout(M)));let k=super.subscribe({next:b,error:r,complete:M});return u instanceof _i&&u.add(k),k}wrapInTimeout(u){return l=>{let m=this.pendingTasks?.add();setTimeout(()=>{try{u(l)}finally{m!==void 0&&this.pendingTasks?.remove(m)}})}}},an=RT;function HP(a){let u,l;function m(){a=Ug;try{l!==void 0&&typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(l),u!==void 0&&clearTimeout(u)}catch{}}return u=setTimeout(()=>{a(),m()}),typeof requestAnimationFrame=="function"&&(l=requestAnimationFrame(()=>{a(),m()})),()=>m()}function p2(a){return queueMicrotask(()=>a()),()=>{a=Ug}}var iI="isAngularZone",rx=iI+"_ID",r4=0,$r=class a{hasPendingMacrotasks=!1;hasPendingMicrotasks=!1;isStable=!0;onUnstable=new an(!1);onMicrotaskEmpty=new an(!1);onStable=new an(!1);onError=new an(!1);constructor(u){let{enableLongStackTrace:l=!1,shouldCoalesceEventChangeDetection:m=!1,shouldCoalesceRunChangeDetection:b=!1,scheduleInRootZone:r=jP}=u;if(typeof Zone>"u")throw new en(908,!1);Zone.assertZonePatched();let M=this;M._nesting=0,M._outer=M._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(M._inner=M._inner.fork(new Zone.TaskTrackingZoneSpec)),l&&Zone.longStackTraceZoneSpec&&(M._inner=M._inner.fork(Zone.longStackTraceZoneSpec)),M.shouldCoalesceEventChangeDetection=!b&&m,M.shouldCoalesceRunChangeDetection=b,M.callbackScheduled=!1,M.scheduleInRootZone=r,s4(M)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get(iI)===!0}static assertInAngularZone(){if(!a.isInAngularZone())throw new en(909,!1)}static assertNotInAngularZone(){if(a.isInAngularZone())throw new en(909,!1)}run(u,l,m){return this._inner.run(u,l,m)}runTask(u,l,m,b){let r=this._inner,M=r.scheduleEventTask("NgZoneEvent: "+b,u,i4,Ug,Ug);try{return r.runTask(M,l,m)}finally{r.cancelTask(M)}}runGuarded(u,l,m){return this._inner.runGuarded(u,l,m)}runOutsideAngular(u){return this._outer.run(u)}},i4={};function oI(a){if(a._nesting==0&&!a.hasPendingMicrotasks&&!a.isStable)try{a._nesting++,a.onMicrotaskEmpty.emit(null)}finally{if(a._nesting--,!a.hasPendingMicrotasks)try{a.runOutsideAngular(()=>a.onStable.emit(null))}finally{a.isStable=!0}}}function o4(a){if(a.isCheckStableRunning||a.callbackScheduled)return;a.callbackScheduled=!0;function u(){HP(()=>{a.callbackScheduled=!1,PT(a),a.isCheckStableRunning=!0,oI(a),a.isCheckStableRunning=!1})}a.scheduleInRootZone?Zone.root.run(()=>{u()}):a._outer.run(()=>{u()}),PT(a)}function s4(a){let u=()=>{o4(a)},l=r4++;a._inner=a._inner.fork({name:"angular",properties:{[iI]:!0,[rx]:l,[rx+l]:!0},onInvokeTask:(m,b,r,M,k,U)=>{if(a4(U))return m.invokeTask(r,M,k,U);try{return m2(a),m.invokeTask(r,M,k,U)}finally{(a.shouldCoalesceEventChangeDetection&&M.type==="eventTask"||a.shouldCoalesceRunChangeDetection)&&u(),g2(a)}},onInvoke:(m,b,r,M,k,U,ae)=>{try{return m2(a),m.invoke(r,M,k,U,ae)}finally{a.shouldCoalesceRunChangeDetection&&!a.callbackScheduled&&!l4(U)&&u(),g2(a)}},onHasTask:(m,b,r,M)=>{m.hasTask(r,M),b===r&&(M.change=="microTask"?(a._hasPendingMicrotasks=M.microTask,PT(a),oI(a)):M.change=="macroTask"&&(a.hasPendingMacrotasks=M.macroTask))},onHandleError:(m,b,r,M)=>(m.handleError(r,M),a.runOutsideAngular(()=>a.onError.emit(M)),!1)})}function PT(a){a._hasPendingMicrotasks||(a.shouldCoalesceEventChangeDetection||a.shouldCoalesceRunChangeDetection)&&a.callbackScheduled===!0?a.hasPendingMicrotasks=!0:a.hasPendingMicrotasks=!1}function m2(a){a._nesting++,a.isStable&&(a.isStable=!1,a.onUnstable.emit(null))}function g2(a){a._nesting--,oI(a)}var qg=class{hasPendingMicrotasks=!1;hasPendingMacrotasks=!1;isStable=!0;onUnstable=new an;onMicrotaskEmpty=new an;onStable=new an;onError=new an;run(u,l,m){return u.apply(l,m)}runGuarded(u,l,m){return u.apply(l,m)}runOutsideAngular(u){return u()}runTask(u,l,m,b){return u.apply(l,m)}};function a4(a){return GP(a,"__ignore_ng_zone__")}function l4(a){return GP(a,"__scheduler_tick__")}function GP(a,u){return!Array.isArray(a)||a.length!==1?!1:a[0]?.data?.[u]===!0}function $P(a="zone.js",u){return a==="noop"?new qg:a==="zone.js"?new $r(u):a}var sI=(()=>{class a{impl=null;execute(){this.impl?.execute()}static \u0275prov=Zt({token:a,providedIn:"root",factory:()=>new a})}return a})(),WP=[0,1,2,3],ZP=(()=>{class a{ngZone=ut($r);scheduler=ut(Al);errorHandler=ut(Qs,{optional:!0});sequences=new Set;deferredRegistrations=new Set;executing=!1;constructor(){ut(Fd,{optional:!0})}execute(){let l=this.sequences.size>0;l&&Kr(16),this.executing=!0;for(let m of WP)for(let b of this.sequences)if(!(b.erroredOrDestroyed||!b.hooks[m]))try{b.pipelinedValue=this.ngZone.runOutsideAngular(()=>this.maybeTrace(()=>{let r=b.hooks[m];return r(b.pipelinedValue)},b.snapshot))}catch(r){b.erroredOrDestroyed=!0,this.errorHandler?.handleError(r)}this.executing=!1;for(let m of this.sequences)m.afterRun(),m.once&&(this.sequences.delete(m),m.destroy());for(let m of this.deferredRegistrations)this.sequences.add(m);this.deferredRegistrations.size>0&&this.scheduler.notify(7),this.deferredRegistrations.clear(),l&&Kr(17)}register(l){let{view:m}=l;m!==void 0?((m[Td]??=[]).push(l),Nf(m),m[Un]|=8192):this.executing?this.deferredRegistrations.add(l):this.addSequence(l)}addSequence(l){this.sequences.add(l),this.scheduler.notify(7)}unregister(l){this.executing&&this.sequences.has(l)?(l.erroredOrDestroyed=!0,l.pipelinedValue=void 0,l.once=!0):(this.sequences.delete(l),this.deferredRegistrations.delete(l))}maybeTrace(l,m){return m?m.run(xx.AFTER_NEXT_RENDER,l):l()}static \u0275prov=Zt({token:a,providedIn:"root",factory:()=>new a})}return a})(),ix=class{impl;hooks;view;once;snapshot;erroredOrDestroyed=!1;pipelinedValue=void 0;unregisterOnDestroy;constructor(u,l,m,b,r,M=null){this.impl=u,this.hooks=l,this.view=m,this.once=b,this.snapshot=M,this.unregisterOnDestroy=r?.onDestroy(()=>this.destroy())}afterRun(){this.erroredOrDestroyed=!1,this.pipelinedValue=void 0,this.snapshot?.dispose(),this.snapshot=null}destroy(){this.impl.unregister(this),this.unregisterOnDestroy?.();let u=this.view?.[Td];u&&(this.view[Td]=u.filter(l=>l!==this))}};function aI(a,u){let l=u?.injector??ut(qi);return Ld("NgAfterRender"),qP(a,l,u,!1)}function Qg(a,u){let l=u?.injector??ut(qi);return Ld("NgAfterNextRender"),qP(a,l,u,!0)}function c4(a){return a instanceof Function?[void 0,void 0,a,void 0]:[a.earlyRead,a.write,a.mixedReadWrite,a.read]}function qP(a,u,l,m){let b=u.get(sI);b.impl??=u.get(ZP);let r=u.get(Fd,null,{optional:!0}),M=l?.manualCleanup!==!0?u.get(Ga):null,k=u.get(B0,null,{optional:!0}),U=new ix(b.impl,c4(a),k?.view,m,M,r?.snapshot(null));return b.impl.register(U),U}var lI=(()=>{class a{log(l){console.log(l)}warn(l){console.warn(l)}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"platform"})}return a})();var bx=new Kt(""),qf=new Kt(""),e_=(()=>{class a{_ngZone;registry;_isZoneStable=!0;_callbacks=[];_taskTrackingZone=null;_destroyRef;constructor(l,m,b){this._ngZone=l,this.registry=m,IE()&&(this._destroyRef=ut(Ga,{optional:!0})??void 0),cI||(XP(b),b.addToWindow(m)),this._watchAngularEvents(),l.run(()=>{this._taskTrackingZone=typeof Zone>"u"?null:Zone.current.get("TaskTrackingZone")})}_watchAngularEvents(){let l=this._ngZone.onUnstable.subscribe({next:()=>{this._isZoneStable=!1}}),m=this._ngZone.runOutsideAngular(()=>this._ngZone.onStable.subscribe({next:()=>{$r.assertNotInAngularZone(),queueMicrotask(()=>{this._isZoneStable=!0,this._runCallbacksIfReady()})}}));this._destroyRef?.onDestroy(()=>{l.unsubscribe(),m.unsubscribe()})}isStable(){return this._isZoneStable&&!this._ngZone.hasPendingMacrotasks}_runCallbacksIfReady(){if(this.isStable())queueMicrotask(()=>{for(;this._callbacks.length!==0;){let l=this._callbacks.pop();clearTimeout(l.timeoutId),l.doneCb()}});else{let l=this.getPendingTasks();this._callbacks=this._callbacks.filter(m=>m.updateCb&&m.updateCb(l)?(clearTimeout(m.timeoutId),!1):!0)}}getPendingTasks(){return this._taskTrackingZone?this._taskTrackingZone.macroTasks.map(l=>({source:l.source,creationLocation:l.creationLocation,data:l.data})):[]}addCallback(l,m,b){let r=-1;m&&m>0&&(r=setTimeout(()=>{this._callbacks=this._callbacks.filter(M=>M.timeoutId!==r),l()},m)),this._callbacks.push({doneCb:l,timeoutId:r,updateCb:b})}whenStable(l,m,b){if(b&&!this._taskTrackingZone)throw new Error('Task tracking zone is required when passing an update callback to whenStable(). Is "zone.js/plugins/task-tracking" loaded?');this.addCallback(l,m,b),this._runCallbacksIfReady()}registerApplication(l){this.registry.registerApplication(l,this)}unregisterApplication(l){this.registry.unregisterApplication(l)}findProviders(l,m,b){return[]}static \u0275fac=function(m){return new(m||a)(ln($r),ln(t_),ln(qf))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),t_=(()=>{class a{_applications=new Map;registerApplication(l,m){this._applications.set(l,m)}unregisterApplication(l){this._applications.delete(l)}unregisterAllApplications(){this._applications.clear()}getTestability(l){return this._applications.get(l)||null}getAllTestabilities(){return Array.from(this._applications.values())}getAllRootElements(){return Array.from(this._applications.keys())}findTestabilityInTree(l,m=!0){return cI?.findTestabilityInTree(this,l,m)??null}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"platform"})}return a})();function XP(a){cI=a}var cI;function n_(a){return!!a&&typeof a.then=="function"}function YP(a){return!!a&&typeof a.subscribe=="function"}var uI=new Kt("");function wx(a){return Gc([{provide:uI,multi:!0,useValue:a}])}var dI=(()=>{class a{resolve;reject;initialized=!1;done=!1;donePromise=new Promise((l,m)=>{this.resolve=l,this.reject=m});appInits=ut(uI,{optional:!0})??[];injector=ut(qi);constructor(){}runInitializers(){if(this.initialized)return;let l=[];for(let b of this.appInits){let r=Xi(this.injector,b);if(n_(r))l.push(r);else if(YP(r)){let M=new Promise((k,U)=>{r.subscribe({complete:k,error:U})});l.push(M)}}let m=()=>{this.done=!0,this.resolve()};Promise.all(l).then(()=>{m()}).catch(b=>{this.reject(b)}),l.length===0&&m(),this.initialized=!0}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),Ex=new Kt("");function KP(){Rw(()=>{let a="";throw new en(600,a)})}function JP(a){return a.isBoundToModule}var u4=10;function hI(a,u){return Array.isArray(u)?u.reduce(hI,a):$t($t({},a),u)}var Nl=(()=>{class a{_runningTick=!1;_destroyed=!1;_destroyListeners=[];_views=[];internalErrorHandler=ut(ys);afterRenderManager=ut(sI);zonelessEnabled=ut(z0);rootEffectScheduler=ut(QE);dirtyFlags=0;tracingSnapshot=null;allTestViews=new Set;autoDetectTestViews=new Set;includeAllTestViews=!1;afterTick=new Ai;get allViews(){return[...(this.includeAllTestViews?this.allTestViews:this.autoDetectTestViews).keys(),...this._views]}get destroyed(){return this._destroyed}componentTypes=[];components=[];internalPendingTask=ut($a);get isStable(){return this.internalPendingTask.hasPendingTasksObservable.pipe(or(l=>!l))}constructor(){ut(Fd,{optional:!0})}whenStable(){let l;return new Promise(m=>{l=this.isStable.subscribe({next:b=>{b&&m()}})}).finally(()=>{l.unsubscribe()})}_injector=ut(wi);_rendererFactory=null;get injector(){return this._injector}bootstrap(l,m){return this.bootstrapImpl(l,m)}bootstrapImpl(l,m,b=qi.NULL){return this._injector.get($r).run(()=>{Kr(10);let M=l instanceof yx;if(!this._injector.get(dI).done){let Ct="";throw new en(405,Ct)}let U;M?U=l:U=this._injector.get(Kg).resolveComponentFactory(l),this.componentTypes.push(U.componentType);let ae=JP(U)?void 0:this._injector.get(Hf),Ee=m||U.selector,Be=U.create(b,[],Ee,ae),ht=Be.location.nativeElement,Oe=Be.injector.get(bx,null);return Oe?.registerApplication(ht),Be.onDestroy(()=>{this.detachView(Be.hostView),Hg(this.components,Be),Oe?.unregisterApplication(ht)}),this._loadComponent(Be),Kr(11,Be),Be})}tick(){this.zonelessEnabled||(this.dirtyFlags|=1),this._tick()}_tick(){Kr(12),this.tracingSnapshot!==null?this.tracingSnapshot.run(xx.CHANGE_DETECTION,this.tickImpl):this.tickImpl()}tickImpl=()=>{if(this._runningTick)throw new en(101,!1);let l=pr(null);try{this._runningTick=!0,this.synchronize()}finally{this._runningTick=!1,this.tracingSnapshot?.dispose(),this.tracingSnapshot=null,pr(l),this.afterTick.next(),Kr(13)}};synchronize(){this._rendererFactory===null&&!this._injector.destroyed&&(this._rendererFactory=this._injector.get(Ad,null,{optional:!0}));let l=0;for(;this.dirtyFlags!==0&&l++<u4;)Kr(14),this.synchronizeOnce(),Kr(15)}synchronizeOnce(){this.dirtyFlags&16&&(this.dirtyFlags&=-17,this.rootEffectScheduler.flush());let l=!1;if(this.dirtyFlags&7){let m=!!(this.dirtyFlags&1);this.dirtyFlags&=-8,this.dirtyFlags|=8;for(let{_lView:b}of this.allViews){if(!m&&!kg(b))continue;let r=m&&!this.zonelessEnabled?0:1;JT(b,r),l=!0}if(this.dirtyFlags&=-5,this.syncDirtyFlagsWithViews(),this.dirtyFlags&23)return}l||(this._rendererFactory?.begin?.(),this._rendererFactory?.end?.()),this.dirtyFlags&8&&(this.dirtyFlags&=-9,this.afterRenderManager.execute()),this.syncDirtyFlagsWithViews()}syncDirtyFlagsWithViews(){if(this.allViews.some(({_lView:l})=>kg(l))){this.dirtyFlags|=2;return}else this.dirtyFlags&=-8}attachView(l){let m=l;this._views.push(m),m.attachToAppRef(this)}detachView(l){let m=l;Hg(this._views,m),m.detachFromAppRef()}_loadComponent(l){this.attachView(l.hostView);try{this.tick()}catch(b){this.internalErrorHandler(b)}this.components.push(l),this._injector.get(Ex,[]).forEach(b=>b(l))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(l=>l()),this._views.slice().forEach(l=>l.destroy())}finally{this._destroyed=!0,this._views=[],this._destroyListeners=[]}}onDestroy(l){return this._destroyListeners.push(l),()=>Hg(this._destroyListeners,l)}destroy(){if(this._destroyed)throw new en(406,!1);let l=this._injector;l.destroy&&!l.destroyed&&l.destroy()}get viewCount(){return this._views.length}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function Hg(a,u){let l=a.indexOf(u);l>-1&&a.splice(l,1)}function Tx(a,u,l){let m=si(),b=LR();if(nI(m,b,u)){let r=ia(),M=HR();A5(M,m,a,u,m[ao],l)}return Tx}function OT(a,u,l,m,b){YT(u,a,l,b?"class":"style",m)}function r_(a,u,l,m){let b=si(),r=b[Nn],M=a+jo,k=r.firstCreatePass?MP(M,b,2,u,F5,MR(),l,m):r.data[M];if(hP(k,b,a,u,QP),M0(k)){let U=b[Nn];dP(U,b,k),Z2(U,k,b)}return m!=null&&XT(b,k),r_}function i_(){let a=ia(),u=ls(),l=fP(u);return a.firstCreatePass&&RP(a,l),kE(l)&&NE(),LE(),l.classesWithoutHost!=null&&TB(l)&&OT(a,l,si(),l.classesWithoutHost,!0),l.stylesWithoutHost!=null&&IB(l)&&OT(a,l,si(),l.stylesWithoutHost,!1),i_}function Xf(a,u,l,m){return r_(a,u,l,m),i_(),Xf}function o_(a,u,l,m){let b=si(),r=b[Nn],M=a+jo,k=r.firstCreatePass?gV(M,r,2,u,l,m):r.data[M];return hP(k,b,a,u,QP),m!=null&&XT(b,k),o_}function s_(){let a=ls(),u=fP(a);return kE(u)&&NE(),LE(),s_}function Ix(a,u,l,m){return o_(a,u,l,m),s_(),Ix}var QP=(a,u,l,m,b)=>(qE(!0),K2(u[ao],m,GR()));var a_="en-US";var d4=a_;function eO(a){typeof a=="string"&&(d4=a.toLowerCase().replace(/_/g,"-"))}function l_(a,u,l){let m=si(),b=ia(),r=ls();return h4(b,m,m[ao],r,a,u,l),l_}function h4(a,u,l,m,b,r,M){let k=!0,U=null;if((m.type&3||M)&&(U??=rT(m,u,r),yV(m,a,u,M,l,b,r,U)&&(k=!1)),k){let ae=m.outputs?.[b],Ee=m.hostDirectiveOutputs?.[b];if(Ee&&Ee.length)for(let Be=0;Be<Ee.length;Be+=2){let ht=Ee[Be],Oe=Ee[Be+1];U??=rT(m,u,r),c2(m,u,ht,Oe,b,U)}if(ae&&ae.length)for(let Be of ae)U??=rT(m,u,r),c2(m,u,Be,b,b,U)}}function f4(a,u){let l=null,m=e5(a);for(let b=0;b<u.length;b++){let r=u[b];if(r==="*"){l=b;continue}if(m===null?Y2(a,r,!0):r5(m,r))return b}return l}function fI(a){let u=si()[as][Uo];if(!u.projection){let l=a?a.length:1,m=u.projection=hR(l,null),b=m.slice(),r=u.child;for(;r!==null;){if(r.type!==128){let M=a?f4(r,a):0;M!==null&&(b[M]?b[M].projectionNext=r:m[M]=r,b[M]=r)}r=r.next}}}function pI(a,u=0,l,m,b,r){let M=si(),k=ia(),U=m?a+1:null;U!==null&&e4(M,k,U,m,b,r,null,l);let ae=_x(k,jo+a,16,null,l||null);ae.projection===null&&(ae.projection=u),VE();let Be=!M[Rf]||FE();M[as][Uo].projection[ae.projection]===null&&U!==null?p4(M,k,U):Be&&!fx(ae)&&w5(k,M,ae)}function p4(a,u,l){let m=jo+l,b=u.data[m],r=a[m],M=bT(r,b.tView.ssrId),k=pP(a,b,void 0,{dehydratedView:M});IP(r,k,0,yT(b,M))}function c_(a,u,l){UV(a,u,l)}function Yf(a){let u=si(),l=ia(),m=GE();F0(m+1);let b=rI(l,m);if(a.dirty&&TR(u)===((b.metadata.flags&2)===2)){if(b.matches===null)a.reset([]);else{let r=GV(u,m);a.reset(r,zB),a.notifyOnChanges()}return!0}return!1}function Kf(){return BV(si(),GE())}function V0(a,u){return a<<17|u<<2}function Rd(a){return a>>17&32767}function m4(a){return(a&2)==2}function g4(a,u){return a&131071|u<<17}function LT(a){return a|2}function Gf(a){return(a&131068)>>2}function oT(a,u){return a&-131069|u<<2}function _4(a){return(a&1)===1}function FT(a){return a|1}function y4(a,u,l,m,b,r){let M=r?u.classBindings:u.styleBindings,k=Rd(M),U=Gf(M);a[m]=l;let ae=!1,Ee;if(Array.isArray(l)){let Be=l;Ee=Be[1],(Ee===null||Mf(Be,Ee)>0)&&(ae=!0)}else Ee=l;if(b)if(U!==0){let ht=Rd(a[k+1]);a[m+1]=V0(ht,k),ht!==0&&(a[ht+1]=oT(a[ht+1],m)),a[k+1]=g4(a[k+1],m)}else a[m+1]=V0(k,0),k!==0&&(a[k+1]=oT(a[k+1],m)),k=m;else a[m+1]=V0(U,0),k===0?k=m:a[U+1]=oT(a[U+1],m),U=m;ae&&(a[m+1]=LT(a[m+1])),_2(a,Ee,m,!0),_2(a,Ee,m,!1),v4(u,Ee,a,m,r),M=V0(k,U),r?u.classBindings=M:u.styleBindings=M}function v4(a,u,l,m,b){let r=b?a.residualClasses:a.residualStyles;r!=null&&typeof u=="string"&&Mf(r,u)>=0&&(l[m+1]=FT(l[m+1]))}function _2(a,u,l,m){let b=a[l+1],r=u===null,M=m?Rd(b):Gf(b),k=!1;for(;M!==0&&(k===!1||r);){let U=a[M],ae=a[M+1];x4(U,u)&&(k=!0,a[M+1]=m?FT(ae):LT(ae)),M=m?Rd(ae):Gf(ae)}k&&(a[l+1]=m?LT(b):FT(b))}function x4(a,u){return a===null||u==null||(Array.isArray(a)?a[1]:a)===u?!0:Array.isArray(a)&&typeof u=="string"?Mf(a,u)>=0:!1}var Go={textEnd:0,key:0,keyEnd:0,value:0,valueEnd:0};function b4(a){return a.substring(Go.key,Go.keyEnd)}function w4(a){return a.substring(Go.value,Go.valueEnd)}function E4(a){return T4(a),tO(a,ox(a,0,Go.textEnd))}function tO(a,u){let l=Go.textEnd,m=Go.key=ox(a,u,l);return l===m?-1:(m=Go.keyEnd=I4(a,m,l),m=y2(a,m,l,58),m=Go.value=ox(a,m,l),m=Go.valueEnd=S4(a,m,l),y2(a,m,l,59))}function T4(a){Go.key=0,Go.keyEnd=0,Go.value=0,Go.valueEnd=0,Go.textEnd=a.length}function ox(a,u,l){for(;u<l&&a.charCodeAt(u)<=32;)u++;return u}function I4(a,u,l){let m;for(;u<l&&((m=a.charCodeAt(u))===45||m===95||(m&-33)>=65&&(m&-33)<=90||m>=48&&m<=57);)u++;return u}function y2(a,u,l,m){return u=ox(a,u,l),u<l&&u++,u}function S4(a,u,l){let m=-1,b=-1,r=-1,M=u,k=M;for(;M<l;){let U=a.charCodeAt(M++);if(U===59)return k;U===34||U===39?k=M=v2(a,U,M,l):u===M-4&&r===85&&b===82&&m===76&&U===40?k=M=v2(a,41,M,l):U>32&&(k=M),r=b,b=m,m=U&-33}return k}function v2(a,u,l,m){let b=-1,r=l;for(;r<m;){let M=a.charCodeAt(r++);if(M==u&&b!==92)return r;M==92&&b===92?b=0:b=M}throw new Error}function mI(a){C4(rO,D4,a,!1)}function D4(a,u){for(let l=E4(u);l>=0;l=tO(u,l))rO(a,b4(u),w4(u))}function C4(a,u,l,m){let b=ia(),r=FR(2);b.firstUpdatePass&&A4(b,null,r,m);let M=si();if(l!==Jc&&nI(M,r,l)){let k=b.data[zf()];if(iO(k,m)&&!nO(b,r)){let U=m?k.classesWithoutHost:k.stylesWithoutHost;U!==null&&(l=E0(U,l||"")),OT(b,k,M,l,m)}else F4(b,k,M,M[ao],M[r+1],M[r+1]=L4(a,u,l),m,r)}}function nO(a,u){return u>=a.expandoStartIndex}function A4(a,u,l,m){let b=a.data;if(b[l+1]===null){let r=b[zf()],M=nO(a,l);iO(r,m)&&u===null&&!M&&(u=!1),u=M4(b,r,u,m),y4(b,r,u,l,M,m)}}function M4(a,u,l,m){let b=BR(a),r=m?u.residualClasses:u.residualStyles;if(b===null)(m?u.classBindings:u.styleBindings)===0&&(l=sT(null,a,u,l,m),l=Xg(l,u.attrs,m),r=null);else{let M=u.directiveStylingLast;if(M===-1||a[M]!==b)if(l=sT(b,a,u,l,m),r===null){let U=R4(a,u,m);U!==void 0&&Array.isArray(U)&&(U=sT(null,a,u,U[1],m),U=Xg(U,u.attrs,m),P4(a,u,m,U))}else r=O4(a,u,m)}return r!==void 0&&(m?u.residualClasses=r:u.residualStyles=r),l}function R4(a,u,l){let m=l?u.classBindings:u.styleBindings;if(Gf(m)!==0)return a[Rd(m)]}function P4(a,u,l,m){let b=l?u.classBindings:u.styleBindings;a[Rd(b)]=m}function O4(a,u,l){let m,b=u.directiveEnd;for(let r=1+u.directiveStylingLast;r<b;r++){let M=a[r].hostAttrs;m=Xg(m,M,l)}return Xg(m,u.attrs,l)}function sT(a,u,l,m,b){let r=null,M=l.directiveEnd,k=l.directiveStylingLast;for(k===-1?k=l.directiveStart:k++;k<M&&(r=u[k],m=Xg(m,r.hostAttrs,b),r!==a);)k++;return a!==null&&(l.directiveStylingLast=k),m}function Xg(a,u,l){let m=l?1:2,b=-1;if(u!==null)for(let r=0;r<u.length;r++){let M=u[r];typeof M=="number"?b=M:b===m&&(Array.isArray(a)||(a=a===void 0?[]:["",a]),_E(a,M,l?!0:u[++r]))}return a===void 0?null:a}function L4(a,u,l){if(l==null||l==="")return os;let m=[],b=px(l);if(Array.isArray(b))for(let r=0;r<b.length;r++)a(m,b[r],!0);else if(typeof b=="object")for(let r in b)b.hasOwnProperty(r)&&a(m,r,b[r]);else typeof b=="string"&&u(m,b);return m}function rO(a,u,l){_E(a,u,px(l))}function F4(a,u,l,m,b,r,M,k){b===Jc&&(b=os);let U=0,ae=0,Ee=0<b.length?b[0]:null,Be=0<r.length?r[0]:null;for(;Ee!==null||Be!==null;){let ht=U<b.length?b[U+1]:void 0,Oe=ae<r.length?r[ae+1]:void 0,Ct=null,Vt;Ee===Be?(U+=2,ae+=2,ht!==Oe&&(Ct=Be,Vt=Oe)):Be===null||Ee!==null&&Ee<Be?(U+=2,Ct=Ee):(ae+=2,Ct=Be,Vt=Oe),Ct!==null&&k4(a,u,l,m,Ct,Vt,M,k),Ee=U<b.length?b[U]:null,Be=ae<r.length?r[ae]:null}}function k4(a,u,l,m,b,r,M,k){if(!(u.type&3))return;let U=a.data,ae=U[k+1],Ee=_4(ae)?x2(U,u,l,b,Gf(ae),M):void 0;if(!sx(Ee)){sx(r)||m4(ae)&&(r=x2(U,null,l,b,k,M));let Be=ER(zf(),l);T5(m,M,Be,b,r)}}function x2(a,u,l,m,b,r){let M=u===null,k;for(;b>0;){let U=a[b],ae=Array.isArray(U),Ee=ae?U[1]:U,Be=Ee===null,ht=l[b+1];ht===Jc&&(ht=Be?os:void 0);let Oe=Be?C0(ht,m):Ee===m?ht:void 0;if(ae&&!sx(Oe)&&(Oe=C0(U,m)),sx(Oe)&&(k=Oe,M))return k;let Ct=a[b+1];b=M?Rd(Ct):Gf(Ct)}if(u!==null){let U=r?u.residualClasses:u.residualStyles;U!=null&&(k=C0(U,m))}return k}function sx(a){return a!==void 0}function iO(a,u){return(a.flags&(u?8:16))!==0}function N4(a,u,l){let m=ia();if(m.firstCreatePass){let b=qc(a);kT(l,m.data,m.blueprint,b,!0),kT(u,m.data,m.blueprint,b,!1)}}function kT(a,u,l,m,b){if(a=so(a),Array.isArray(a))for(let r=0;r<a.length;r++)kT(a[r],u,l,m,b);else{let r=ia(),M=si(),k=ls(),U=_d(a)?a:so(a.provide),ae=TE(a),Ee=k.providerIndexes&1048575,Be=k.directiveStart,ht=k.providerIndexes>>20;if(_d(a)||!a.multi){let Oe=new Cd(ae,b,Qc,null),Ct=lT(U,u,b?Ee:Ee+ht,Be);Ct===-1?(uT(X0(k,M),r,U),aT(r,a,u.length),u.push(U),k.directiveStart++,k.directiveEnd++,b&&(k.providerIndexes+=1048576),l.push(Oe),M.push(Oe)):(l[Ct]=Oe,M[Ct]=Oe)}else{let Oe=lT(U,u,Ee+ht,Be),Ct=lT(U,u,Ee,Ee+ht),Vt=Oe>=0&&l[Oe],Ut=Ct>=0&&l[Ct];if(b&&!Ut||!b&&!Vt){uT(X0(k,M),r,U);let Nt=V4(b?B4:z4,l.length,b,m,ae,a);!b&&Ut&&(l[Ct].providerFactory=Nt),aT(r,a,u.length,0),u.push(U),k.directiveStart++,k.directiveEnd++,b&&(k.providerIndexes+=1048576),l.push(Nt),M.push(Nt)}else{let Nt=oO(l[b?Ct:Oe],ae,!b&&m);aT(r,a,Oe>-1?Oe:Ct,Nt)}!b&&m&&Ut&&l[Ct].componentProviders++}}}function aT(a,u,l,m){let b=_d(u),r=vR(u);if(b||r){let U=(r?so(u.useClass):u).prototype.ngOnDestroy;if(U){let ae=a.destroyHooks||(a.destroyHooks=[]);if(!b&&u.multi){let Ee=ae.indexOf(l);Ee===-1?ae.push(l,[m,U]):ae[Ee+1].push(m,U)}else ae.push(l,U)}}}function oO(a,u,l){return l&&a.componentProviders++,a.multi.push(u)-1}function lT(a,u,l,m){for(let b=l;b<m;b++)if(u[b]===a)return b;return-1}function z4(a,u,l,m,b){return NT(this.multi,[])}function B4(a,u,l,m,b){let r=this.multi,M;if(this.providerFactory){let k=this.providerFactory.componentProviders,U=Gg(m,m[Nn],this.providerFactory.index,b);M=U.slice(0,k),NT(r,M);for(let ae=k;ae<U.length;ae++)M.push(U[ae])}else M=[],NT(r,M);return M}function NT(a,u){for(let l=0;l<a.length;l++){let m=a[l];u.push(m())}return u}function V4(a,u,l,m,b,r){let M=new Cd(a,l,Qc,null);return M.multi=[],M.index=u,M.componentProviders=0,oO(M,b,m&&!l),M}function gI(a,u=[]){return l=>{l.providersResolver=(m,b)=>N4(m,b?b(a):a,u)}}function _I(a,u,l,m){return j4(si(),PR(),a,u,l,m)}function U4(a,u){let l=a[u];return l===Jc?void 0:l}function j4(a,u,l,m,b,r){let M=u+l;return nI(a,M,b)?_V(a,M+1,r?m.call(r,b):m(b)):U4(a,M+1)}var U0=null;function sO(a){U0!==null&&(a.defaultEncapsulation!==U0.defaultEncapsulation||a.preserveWhitespaces!==U0.preserveWhitespaces)||(U0=a)}var ax=class{ngModuleFactory;componentFactories;constructor(u,l){this.ngModuleFactory=u,this.componentFactories=l}},yI=(()=>{class a{compileModuleSync(l){return new Zg(l)}compileModuleAsync(l){return Promise.resolve(this.compileModuleSync(l))}compileModuleAndAllComponentsSync(l){let m=this.compileModuleSync(l),b=xE(l),r=q2(b.declarations).reduce((M,k)=>{let U=Rl(k);return U&&M.push(new Md(U)),M},[]);return new ax(m,r)}compileModuleAndAllComponentsAsync(l){return Promise.resolve(this.compileModuleAndAllComponentsSync(l))}clearCache(){}clearCacheFor(l){}getModuleId(l){}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),aO=new Kt("");var H4=(()=>{class a{zone=ut($r);changeDetectionScheduler=ut(Al);applicationRef=ut(Nl);applicationErrorHandler=ut(ys);_onMicrotaskEmptySubscription;initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{try{this.applicationRef.dirtyFlags|=1,this.applicationRef._tick()}catch(l){this.applicationErrorHandler(l)}})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function lO({ngZoneFactory:a,ignoreChangesOutsideZone:u,scheduleInRootZone:l}){return a??=()=>new $r(Vr($t({},vI()),{scheduleInRootZone:l})),[{provide:$r,useFactory:a},{provide:Ml,multi:!0,useFactory:()=>{let m=ut(H4,{optional:!0});return()=>m.initialize()}},{provide:Ml,multi:!0,useFactory:()=>{let m=ut(G4);return()=>{m.initialize()}}},u===!0?{provide:KE,useValue:!0}:[],{provide:JE,useValue:l??jP},{provide:ys,useFactory:()=>{let m=ut($r),b=ut(wi),r;return M=>{m.runOutsideAngular(()=>{b.destroyed&&!r?setTimeout(()=>{throw M}):(r??=b.get(Qs),r.handleError(M))})}}}]}function vI(a){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:a?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:a?.runCoalescing??!1}}var G4=(()=>{class a{subscription=new _i;initialized=!1;zone=ut($r);pendingTasks=ut($a);initialize(){if(this.initialized)return;this.initialized=!0;let l=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(l=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{$r.assertNotInAngularZone(),queueMicrotask(()=>{l!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(l),l=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{$r.assertInAngularZone(),l??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();var cO=(()=>{class a{applicationErrorHandler=ut(ys);appRef=ut(Nl);taskService=ut($a);ngZone=ut($r);zonelessEnabled=ut(z0);tracing=ut(Fd,{optional:!0});disableScheduling=ut(KE,{optional:!0})??!1;zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run;schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}];subscriptions=new _i;angularZoneId=this.zoneIsDefined?this.ngZone._inner?.get(rx):null;scheduleInRootZone=!this.zonelessEnabled&&this.zoneIsDefined&&(ut(JE,{optional:!0})??!1);cancelScheduledCallback=null;useMicrotaskScheduler=!1;runningTick=!1;pendingRenderTaskId=null;constructor(){this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()})),this.disableScheduling||=!this.zonelessEnabled&&(this.ngZone instanceof qg||!this.zoneIsDefined)}notify(l){if(!this.zonelessEnabled&&l===5)return;let m=!1;switch(l){case 0:{this.appRef.dirtyFlags|=2;break}case 3:case 2:case 4:case 5:case 1:{this.appRef.dirtyFlags|=4;break}case 6:{this.appRef.dirtyFlags|=2,m=!0;break}case 12:{this.appRef.dirtyFlags|=16,m=!0;break}case 13:{this.appRef.dirtyFlags|=2,m=!0;break}case 11:{m=!0;break}case 9:case 8:case 7:case 10:default:this.appRef.dirtyFlags|=8}if(this.appRef.tracingSnapshot=this.tracing?.snapshot(this.appRef.tracingSnapshot)??null,!this.shouldScheduleTick(m))return;let b=this.useMicrotaskScheduler?p2:HP;this.pendingRenderTaskId=this.taskService.add(),this.scheduleInRootZone?this.cancelScheduledCallback=Zone.root.run(()=>b(()=>this.tick())):this.cancelScheduledCallback=this.ngZone.runOutsideAngular(()=>b(()=>this.tick()))}shouldScheduleTick(l){return!(this.disableScheduling&&!l||this.appRef.destroyed||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&Zone.current.get(rx+this.angularZoneId))}tick(){if(this.runningTick||this.appRef.destroyed)return;if(this.appRef.dirtyFlags===0){this.cleanup();return}!this.zonelessEnabled&&this.appRef.dirtyFlags&7&&(this.appRef.dirtyFlags|=1);let l=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick()},void 0,this.schedulerTickApplyArgs)}catch(m){this.taskService.remove(l),this.applicationErrorHandler(m)}finally{this.cleanup()}this.useMicrotaskScheduler=!0,p2(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(l)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let l=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(l)}}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function $4(){return typeof $localize<"u"&&$localize.locale||a_}var xI=new Kt("",{providedIn:"root",factory:()=>ut(xI,{optional:!0,skipSelf:!0})||$4()});var mO=Symbol("InputSignalNode#UNSET"),tU=Vr($t({},Qv),{transformFn:void 0,applyValueToInputSignal(a,u){xg(a,u)}});function gO(a,u){let l=Object.create(tU);l.value=a,l.transformFn=u?.transform;function m(){if(Yv(l),l.value===mO){let b=null;throw new en(-950,b)}return l.value}return m[Tl]=l,m}var nU=new Kt("");nU.__NG_ELEMENT_ID__=a=>{let u=ls();if(u===null)throw new en(204,!1);if(u.type&2)return u.value;if(a&8)return null;throw new en(204,!1)};function uO(a,u){return gO(a,u)}function rU(a){return gO(mO,a)}var _n=(uO.required=rU,uO);function iU(a,u,l){let m=new Zg(l);return Promise.resolve(m)}function dO(a){for(let u=a.length-1;u>=0;u--)if(a[u]!==void 0)return a[u]}var Sx=new Kt(""),oU=new Kt("");function u_(a){return!a.moduleRef}function sU(a){let u=u_(a)?a.r3Injector:a.moduleRef.injector,l=u.get($r);return l.run(()=>{u_(a)?a.r3Injector.resolveInjectorInitializers():a.moduleRef.resolveInjectorInitializers();let m=u.get(ys),b;if(l.runOutsideAngular(()=>{b=l.onError.subscribe({next:m})}),u_(a)){let r=()=>u.destroy(),M=a.platformInjector.get(Sx);M.add(r),u.onDestroy(()=>{b.unsubscribe(),M.delete(r)})}else{let r=()=>a.moduleRef.destroy(),M=a.platformInjector.get(Sx);M.add(r),a.moduleRef.onDestroy(()=>{Hg(a.allPlatformModules,a.moduleRef),b.unsubscribe(),M.delete(r)})}return lU(m,l,()=>{let r=u.get($a),M=r.add(),k=u.get(dI);return k.runInitializers(),k.donePromise.then(()=>{let U=u.get(xI,a_);if(eO(U||a_),!u.get(oU,!0))return u_(a)?u.get(Nl):(a.allPlatformModules.push(a.moduleRef),a.moduleRef);if(u_(a)){let Ee=u.get(Nl);return a.rootComponent!==void 0&&Ee.bootstrap(a.rootComponent),Ee}else return _O?.(a.moduleRef,a.allPlatformModules),a.moduleRef}).finally(()=>void r.remove(M))})})}var _O;function hO(){_O=aU}function aU(a,u){let l=a.injector.get(Nl);if(a._bootstrapComponents.length>0)a._bootstrapComponents.forEach(m=>l.bootstrap(m));else if(a.instance.ngDoBootstrap)a.instance.ngDoBootstrap(l);else throw new en(-403,!1);u.push(a)}function lU(a,u,l){try{let m=l();return n_(m)?m.catch(b=>{throw u.runOutsideAngular(()=>a(b)),b}):m}catch(m){throw u.runOutsideAngular(()=>a(m)),m}}var yO=(()=>{class a{_injector;_modules=[];_destroyListeners=[];_destroyed=!1;constructor(l){this._injector=l}bootstrapModuleFactory(l,m){let b=m?.scheduleInRootZone,r=()=>$P(m?.ngZone,Vr($t({},vI({eventCoalescing:m?.ngZoneEventCoalescing,runCoalescing:m?.ngZoneRunCoalescing})),{scheduleInRootZone:b})),M=m?.ignoreChangesOutsideZone,k=[lO({ngZoneFactory:r,ignoreChangesOutsideZone:M}),{provide:Al,useExisting:cO},WR],U=BP(l.moduleType,this.injector,k);return hO(),sU({moduleRef:U,allPlatformModules:this._modules,platformInjector:this.injector})}bootstrapModule(l,m=[]){let b=hI({},m);return hO(),iU(this.injector,b,l).then(r=>this.bootstrapModuleFactory(r,b))}onDestroy(l){this._destroyListeners.push(l)}get injector(){return this._injector}destroy(){if(this._destroyed)throw new en(404,!1);this._modules.slice().forEach(m=>m.destroy()),this._destroyListeners.forEach(m=>m());let l=this._injector.get(Sx,null);l&&(l.forEach(m=>m()),l.clear()),this._destroyed=!0}get destroyed(){return this._destroyed}static \u0275fac=function(m){return new(m||a)(ln(qi))};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"platform"})}return a})(),d_=null,vO=new Kt("");function cU(a){if(d_&&!d_.get(vO,!1))throw new en(400,!1);KP(),d_=a;let u=a.get(yO);return hU(a),u}function wI(a,u,l=[]){let m=`Platform: ${u}`,b=new Kt(m);return(r=[])=>{let M=xO();if(!M||M.injector.get(vO,!1)){let k=[...l,...r,{provide:b,useValue:!0}];a?a(k):cU(uU(k,m))}return dU(b)}}function uU(a=[],u){return qi.create({name:u,providers:[{provide:Rg,useValue:"platform"},{provide:Sx,useValue:new Set([()=>d_=null])},...a]})}function dU(a){let u=xO();if(!u)throw new en(401,!1);return u}function xO(){return d_?.get(yO)??null}function hU(a){let u=a.get(dx,null);Xi(a,()=>{u?.forEach(l=>l())})}var h_=(()=>{class a{static __NG_ELEMENT_ID__=fU}return a})();function fU(a){return pU(ls(),si(),(a&16)===16)}function pU(a,u,l){if(Zc(a)&&!l){let m=ra(a.index,u);return new Yc(m,m)}else if(a.type&175){let m=u[as];return new Yc(m,u)}return null}var bO=wI(null,"core",[]),wO=(()=>{class a{constructor(l){}static \u0275fac=function(m){return new(m||a)(ln(Nl))};static \u0275mod=$o({type:a});static \u0275inj=bo({})}return a})();function EO(a){let u=Rl(a);if(!u)return null;let l=new Md(u);return{get selector(){return l.selector},get type(){return l.componentType},get inputs(){return l.inputs},get outputs(){return l.outputs},get ngContentSelectors(){return l.ngContentSelectors},get isStandalone(){return u.standalone},get isSignal(){return u.signals}}}var SO=null;function Za(){return SO}function EI(a){SO??=a}var f_=class{},p_=(()=>{class a{historyGo(l){throw new Error("")}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>ut(DO),providedIn:"platform"})}return a})(),TI=new Kt(""),DO=(()=>{class a extends p_{_location;_history;_doc=ut(di);constructor(){super(),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return Za().getBaseHref(this._doc)}onPopState(l){let m=Za().getGlobalEventTarget(this._doc,"window");return m.addEventListener("popstate",l,!1),()=>m.removeEventListener("popstate",l)}onHashChange(l){let m=Za().getGlobalEventTarget(this._doc,"window");return m.addEventListener("hashchange",l,!1),()=>m.removeEventListener("hashchange",l)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(l){this._location.pathname=l}pushState(l,m,b){this._history.pushState(l,m,b)}replaceState(l,m,b){this._history.replaceState(l,m,b)}forward(){this._history.forward()}back(){this._history.back()}historyGo(l=0){this._history.go(l)}getState(){return this._history.state}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>new a,providedIn:"platform"})}return a})();function Dx(a,u){return a?u?a.endsWith("/")?u.startsWith("/")?a+u.slice(1):a+u:u.startsWith("/")?a+u:`${a}/${u}`:a:u}function TO(a){let u=a.search(/#|\?|$/);return a[u-1]==="/"?a.slice(0,u-1)+a.slice(u):a}function sa(a){return a&&a[0]!=="?"?`?${a}`:a}var zl=(()=>{class a{historyGo(l){throw new Error("")}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>ut(Ax),providedIn:"root"})}return a})(),Cx=new Kt(""),Ax=(()=>{class a extends zl{_platformLocation;_baseHref;_removeListenerFns=[];constructor(l,m){super(),this._platformLocation=l,this._baseHref=m??this._platformLocation.getBaseHrefFromDOM()??ut(di).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(l){this._removeListenerFns.push(this._platformLocation.onPopState(l),this._platformLocation.onHashChange(l))}getBaseHref(){return this._baseHref}prepareExternalUrl(l){return Dx(this._baseHref,l)}path(l=!1){let m=this._platformLocation.pathname+sa(this._platformLocation.search),b=this._platformLocation.hash;return b&&l?`${m}${b}`:m}pushState(l,m,b,r){let M=this.prepareExternalUrl(b+sa(r));this._platformLocation.pushState(l,m,M)}replaceState(l,m,b,r){let M=this.prepareExternalUrl(b+sa(r));this._platformLocation.replaceState(l,m,M)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(l=0){this._platformLocation.historyGo?.(l)}static \u0275fac=function(m){return new(m||a)(ln(p_),ln(Cx,8))};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),eu=(()=>{class a{_subject=new Ai;_basePath;_locationStrategy;_urlChangeListeners=[];_urlChangeSubscription=null;constructor(l){this._locationStrategy=l;let m=this._locationStrategy.getBaseHref();this._basePath=_U(TO(IO(m))),this._locationStrategy.onPopState(b=>{this._subject.next({url:this.path(!0),pop:!0,state:b.state,type:b.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(l=!1){return this.normalize(this._locationStrategy.path(l))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(l,m=""){return this.path()==this.normalize(l+sa(m))}normalize(l){return a.stripTrailingSlash(gU(this._basePath,IO(l)))}prepareExternalUrl(l){return l&&l[0]!=="/"&&(l="/"+l),this._locationStrategy.prepareExternalUrl(l)}go(l,m="",b=null){this._locationStrategy.pushState(b,"",l,m),this._notifyUrlChangeListeners(this.prepareExternalUrl(l+sa(m)),b)}replaceState(l,m="",b=null){this._locationStrategy.replaceState(b,"",l,m),this._notifyUrlChangeListeners(this.prepareExternalUrl(l+sa(m)),b)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(l=0){this._locationStrategy.historyGo?.(l)}onUrlChange(l){return this._urlChangeListeners.push(l),this._urlChangeSubscription??=this.subscribe(m=>{this._notifyUrlChangeListeners(m.url,m.state)}),()=>{let m=this._urlChangeListeners.indexOf(l);this._urlChangeListeners.splice(m,1),this._urlChangeListeners.length===0&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(l="",m){this._urlChangeListeners.forEach(b=>b(l,m))}subscribe(l,m,b){return this._subject.subscribe({next:l,error:m??void 0,complete:b??void 0})}static normalizeQueryParams=sa;static joinWithSlash=Dx;static stripTrailingSlash=TO;static \u0275fac=function(m){return new(m||a)(ln(zl))};static \u0275prov=Zt({token:a,factory:()=>mU(),providedIn:"root"})}return a})();function mU(){return new eu(ln(zl))}function gU(a,u){if(!a||!u.startsWith(a))return u;let l=u.substring(a.length);return l===""||["/",";","?","#"].includes(l[0])?l:u}function IO(a){return a.replace(/\/index.html$/,"")}function _U(a){if(new RegExp("^(https?:)?//").test(a)){let[,l]=a.split(/\/\/[^\/]+/);return l}return a}var II=(()=>{class a extends zl{_platformLocation;_baseHref="";_removeListenerFns=[];constructor(l,m){super(),this._platformLocation=l,m!=null&&(this._baseHref=m)}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(l){this._removeListenerFns.push(this._platformLocation.onPopState(l),this._platformLocation.onHashChange(l))}getBaseHref(){return this._baseHref}path(l=!1){let m=this._platformLocation.hash??"#";return m.length>0?m.substring(1):m}prepareExternalUrl(l){let m=Dx(this._baseHref,l);return m.length>0?"#"+m:m}pushState(l,m,b,r){let M=this.prepareExternalUrl(b+sa(r))||this._platformLocation.pathname;this._platformLocation.pushState(l,m,M)}replaceState(l,m,b,r){let M=this.prepareExternalUrl(b+sa(r))||this._platformLocation.pathname;this._platformLocation.replaceState(l,m,M)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(l=0){this._platformLocation.historyGo?.(l)}static \u0275fac=function(m){return new(m||a)(ln(p_),ln(Cx,8))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})();var SI=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275mod=$o({type:a});static \u0275inj=bo({})}return a})();function m_(a,u){u=encodeURIComponent(u);for(let l of a.split(";")){let m=l.indexOf("="),[b,r]=m==-1?[l,""]:[l.slice(0,m),l.slice(m+1)];if(b.trim()===u)return decodeURIComponent(r)}return null}var kd=class{};var CO="browser";var AO=(()=>{class a{static \u0275prov=Zt({token:a,providedIn:"root",factory:()=>new DI(ut(di),window)})}return a})(),DI=class{document;window;offset=()=>[0,0];constructor(u,l){this.document=u,this.window=l}setOffset(u){Array.isArray(u)?this.offset=()=>u:this.offset=u}getScrollPosition(){return[this.window.scrollX,this.window.scrollY]}scrollToPosition(u,l){this.window.scrollTo(Vr($t({},l),{left:u[0],top:u[1]}))}scrollToAnchor(u,l){let m=xU(this.document,u);m&&(this.scrollToElement(m,l),m.focus())}setHistoryScrollRestoration(u){try{this.window.history.scrollRestoration=u}catch{console.warn(vd(2400,!1))}}scrollToElement(u,l){let m=u.getBoundingClientRect(),b=m.left+this.window.pageXOffset,r=m.top+this.window.pageYOffset,M=this.offset();this.window.scrollTo(Vr($t({},l),{left:b-M[0],top:r-M[1]}))}};function xU(a,u){let l=a.getElementById(u)||a.getElementsByName(u)[0];if(l)return l;if(typeof a.createTreeWalker=="function"&&a.body&&typeof a.body.attachShadow=="function"){let m=a.createTreeWalker(a.body,NodeFilter.SHOW_ELEMENT),b=m.currentNode;for(;b;){let r=b.shadowRoot;if(r){let M=r.getElementById(u)||r.querySelector(`[name="${u}"]`);if(M)return M}b=m.nextNode()}}return null}var Rx=new Kt(""),PI=(()=>{class a{_zone;_plugins;_eventNameToPlugin=new Map;constructor(l,m){this._zone=m,l.forEach(b=>{b.manager=this}),this._plugins=l.slice().reverse()}addEventListener(l,m,b,r){return this._findPluginFor(m).addEventListener(l,m,b,r)}getZone(){return this._zone}_findPluginFor(l){let m=this._eventNameToPlugin.get(l);if(m)return m;if(m=this._plugins.find(r=>r.supports(l)),!m)throw new en(5101,!1);return this._eventNameToPlugin.set(l,m),m}static \u0275fac=function(m){return new(m||a)(ln(Rx),ln($r))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),g_=class{_doc;constructor(u){this._doc=u}manager},CI="ng-app-id";function MO(a){for(let u of a)u.remove()}function RO(a,u){let l=u.createElement("style");return l.textContent=a,l}function bU(a,u,l,m){let b=a.head?.querySelectorAll(`style[${CI}="${u}"],link[${CI}="${u}"]`);if(b)for(let r of b)r.removeAttribute(CI),r instanceof HTMLLinkElement?m.set(r.href.slice(r.href.lastIndexOf("/")+1),{usage:0,elements:[r]}):r.textContent&&l.set(r.textContent,{usage:0,elements:[r]})}function MI(a,u){let l=u.createElement("link");return l.setAttribute("rel","stylesheet"),l.setAttribute("href",a),l}var OI=(()=>{class a{doc;appId;nonce;inline=new Map;external=new Map;hosts=new Set;constructor(l,m,b,r={}){this.doc=l,this.appId=m,this.nonce=b,bU(l,m,this.inline,this.external),this.hosts.add(l.head)}addStyles(l,m){for(let b of l)this.addUsage(b,this.inline,RO);m?.forEach(b=>this.addUsage(b,this.external,MI))}removeStyles(l,m){for(let b of l)this.removeUsage(b,this.inline);m?.forEach(b=>this.removeUsage(b,this.external))}addUsage(l,m,b){let r=m.get(l);r?r.usage++:m.set(l,{usage:1,elements:[...this.hosts].map(M=>this.addElement(M,b(l,this.doc)))})}removeUsage(l,m){let b=m.get(l);b&&(b.usage--,b.usage<=0&&(MO(b.elements),m.delete(l)))}ngOnDestroy(){for(let[,{elements:l}]of[...this.inline,...this.external])MO(l);this.hosts.clear()}addHost(l){this.hosts.add(l);for(let[m,{elements:b}]of this.inline)b.push(this.addElement(l,RO(m,this.doc)));for(let[m,{elements:b}]of this.external)b.push(this.addElement(l,MI(m,this.doc)))}removeHost(l){this.hosts.delete(l)}addElement(l,m){return this.nonce&&m.setAttribute("nonce",this.nonce),l.appendChild(m)}static \u0275fac=function(m){return new(m||a)(ln(di),ln(ux),ln(hx,8),ln(Wf))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),AI={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},LI=/%COMP%/g;var OO="%COMP%",wU=`_nghost-${OO}`,EU=`_ngcontent-${OO}`,TU=!0,IU=new Kt("",{providedIn:"root",factory:()=>TU});function SU(a){return EU.replace(LI,a)}function DU(a){return wU.replace(LI,a)}function LO(a,u){return u.map(l=>l.replace(LI,a))}var FI=(()=>{class a{eventManager;sharedStylesHost;appId;removeStylesOnCompDestroy;doc;platformId;ngZone;nonce;tracingService;rendererByCompId=new Map;defaultRenderer;platformIsServer;constructor(l,m,b,r,M,k,U,ae=null,Ee=null){this.eventManager=l,this.sharedStylesHost=m,this.appId=b,this.removeStylesOnCompDestroy=r,this.doc=M,this.platformId=k,this.ngZone=U,this.nonce=ae,this.tracingService=Ee,this.platformIsServer=!1,this.defaultRenderer=new __(l,M,U,this.platformIsServer,this.tracingService)}createRenderer(l,m){if(!l||!m)return this.defaultRenderer;let b=this.getOrCreateRenderer(l,m);return b instanceof Mx?b.applyToHost(l):b instanceof y_&&b.applyStyles(),b}getOrCreateRenderer(l,m){let b=this.rendererByCompId,r=b.get(m.id);if(!r){let M=this.doc,k=this.ngZone,U=this.eventManager,ae=this.sharedStylesHost,Ee=this.removeStylesOnCompDestroy,Be=this.platformIsServer,ht=this.tracingService;switch(m.encapsulation){case Ll.Emulated:r=new Mx(U,ae,m,this.appId,Ee,M,k,Be,ht);break;case Ll.ShadowDom:return new RI(U,ae,l,m,M,k,this.nonce,Be,ht);default:r=new y_(U,ae,m,Ee,M,k,Be,ht);break}b.set(m.id,r)}return r}ngOnDestroy(){this.rendererByCompId.clear()}componentReplaced(l){this.rendererByCompId.delete(l)}static \u0275fac=function(m){return new(m||a)(ln(PI),ln(OI),ln(ux),ln(IU),ln(di),ln(Wf),ln($r),ln(hx),ln(Fd,8))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),__=class{eventManager;doc;ngZone;platformIsServer;tracingService;data=Object.create(null);throwOnSyntheticProps=!0;constructor(u,l,m,b,r){this.eventManager=u,this.doc=l,this.ngZone=m,this.platformIsServer=b,this.tracingService=r}destroy(){}destroyNode=null;createElement(u,l){return l?this.doc.createElementNS(AI[l]||l,u):this.doc.createElement(u)}createComment(u){return this.doc.createComment(u)}createText(u){return this.doc.createTextNode(u)}appendChild(u,l){(PO(u)?u.content:u).appendChild(l)}insertBefore(u,l,m){u&&(PO(u)?u.content:u).insertBefore(l,m)}removeChild(u,l){l.remove()}selectRootElement(u,l){let m=typeof u=="string"?this.doc.querySelector(u):u;if(!m)throw new en(-5104,!1);return l||(m.textContent=""),m}parentNode(u){return u.parentNode}nextSibling(u){return u.nextSibling}setAttribute(u,l,m,b){if(b){l=b+":"+l;let r=AI[b];r?u.setAttributeNS(r,l,m):u.setAttribute(l,m)}else u.setAttribute(l,m)}removeAttribute(u,l,m){if(m){let b=AI[m];b?u.removeAttributeNS(b,l):u.removeAttribute(`${m}:${l}`)}else u.removeAttribute(l)}addClass(u,l){u.classList.add(l)}removeClass(u,l){u.classList.remove(l)}setStyle(u,l,m,b){b&(Fl.DashCase|Fl.Important)?u.style.setProperty(l,m,b&Fl.Important?"important":""):u.style[l]=m}removeStyle(u,l,m){m&Fl.DashCase?u.style.removeProperty(l):u.style[l]=""}setProperty(u,l,m){u!=null&&(u[l]=m)}setValue(u,l){u.nodeValue=l}listen(u,l,m,b){if(typeof u=="string"&&(u=Za().getGlobalEventTarget(this.doc,u),!u))throw new en(5102,!1);let r=this.decoratePreventDefault(m);return this.tracingService?.wrapEventListener&&(r=this.tracingService.wrapEventListener(u,l,r)),this.eventManager.addEventListener(u,l,r,b)}decoratePreventDefault(u){return l=>{if(l==="__ngUnwrap__")return u;u(l)===!1&&l.preventDefault()}}};function PO(a){return a.tagName==="TEMPLATE"&&a.content!==void 0}var RI=class extends __{sharedStylesHost;hostEl;shadowRoot;constructor(u,l,m,b,r,M,k,U,ae){super(u,r,M,U,ae),this.sharedStylesHost=l,this.hostEl=m,this.shadowRoot=m.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);let Ee=b.styles;Ee=LO(b.id,Ee);for(let ht of Ee){let Oe=document.createElement("style");k&&Oe.setAttribute("nonce",k),Oe.textContent=ht,this.shadowRoot.appendChild(Oe)}let Be=b.getExternalStyles?.();if(Be)for(let ht of Be){let Oe=MI(ht,r);k&&Oe.setAttribute("nonce",k),this.shadowRoot.appendChild(Oe)}}nodeOrShadowRoot(u){return u===this.hostEl?this.shadowRoot:u}appendChild(u,l){return super.appendChild(this.nodeOrShadowRoot(u),l)}insertBefore(u,l,m){return super.insertBefore(this.nodeOrShadowRoot(u),l,m)}removeChild(u,l){return super.removeChild(null,l)}parentNode(u){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(u)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}},y_=class extends __{sharedStylesHost;removeStylesOnCompDestroy;styles;styleUrls;constructor(u,l,m,b,r,M,k,U,ae){super(u,r,M,k,U),this.sharedStylesHost=l,this.removeStylesOnCompDestroy=b;let Ee=m.styles;this.styles=ae?LO(ae,Ee):Ee,this.styleUrls=m.getExternalStyles?.(ae)}applyStyles(){this.sharedStylesHost.addStyles(this.styles,this.styleUrls)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles,this.styleUrls)}},Mx=class extends y_{contentAttr;hostAttr;constructor(u,l,m,b,r,M,k,U,ae){let Ee=b+"-"+m.id;super(u,l,m,r,M,k,U,ae,Ee),this.contentAttr=SU(Ee),this.hostAttr=DU(Ee)}applyToHost(u){this.applyStyles(),this.setAttribute(u,this.hostAttr,"")}createElement(u,l){let m=super.createElement(u,l);return super.setAttribute(m,this.contentAttr,""),m}};var Px=class a extends f_{supportsDOMEvents=!0;static makeCurrent(){EI(new a)}onAndCancel(u,l,m,b){return u.addEventListener(l,m,b),()=>{u.removeEventListener(l,m,b)}}dispatchEvent(u,l){u.dispatchEvent(l)}remove(u){u.remove()}createElement(u,l){return l=l||this.getDefaultDocument(),l.createElement(u)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(u){return u.nodeType===Node.ELEMENT_NODE}isShadowRoot(u){return u instanceof DocumentFragment}getGlobalEventTarget(u,l){return l==="window"?window:l==="document"?u:l==="body"?u.body:null}getBaseHref(u){let l=CU();return l==null?null:AU(l)}resetBaseElement(){v_=null}getUserAgent(){return window.navigator.userAgent}getCookie(u){return m_(document.cookie,u)}},v_=null;function CU(){return v_=v_||document.head.querySelector("base"),v_?v_.getAttribute("href"):null}function AU(a){return new URL(a,document.baseURI).pathname}var Ox=class{addToWindow(u){ea.getAngularTestability=(m,b=!0)=>{let r=u.findTestabilityInTree(m,b);if(r==null)throw new en(5103,!1);return r},ea.getAllAngularTestabilities=()=>u.getAllTestabilities(),ea.getAllAngularRootElements=()=>u.getAllRootElements();let l=m=>{let b=ea.getAllAngularTestabilities(),r=b.length,M=function(){r--,r==0&&m()};b.forEach(k=>{k.whenStable(M)})};ea.frameworkStabilizers||(ea.frameworkStabilizers=[]),ea.frameworkStabilizers.push(l)}findTestabilityInTree(u,l,m){if(l==null)return null;let b=u.getTestability(l);return b??(m?Za().isShadowRoot(l)?this.findTestabilityInTree(u,l.host,!0):this.findTestabilityInTree(u,l.parentElement,!0):null)}},MU=(()=>{class a{build(){return new XMLHttpRequest}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),kO=(()=>{class a extends g_{constructor(l){super(l)}supports(l){return!0}addEventListener(l,m,b,r){return l.addEventListener(m,b,r),()=>this.removeEventListener(l,m,b,r)}removeEventListener(l,m,b,r){return l.removeEventListener(m,b,r)}static \u0275fac=function(m){return new(m||a)(ln(di))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),FO=["alt","control","meta","shift"],RU={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},PU={alt:a=>a.altKey,control:a=>a.ctrlKey,meta:a=>a.metaKey,shift:a=>a.shiftKey},NO=(()=>{class a extends g_{constructor(l){super(l)}supports(l){return a.parseEventName(l)!=null}addEventListener(l,m,b,r){let M=a.parseEventName(m),k=a.eventCallback(M.fullKey,b,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>Za().onAndCancel(l,M.domEventName,k,r))}static parseEventName(l){let m=l.toLowerCase().split("."),b=m.shift();if(m.length===0||!(b==="keydown"||b==="keyup"))return null;let r=a._normalizeKey(m.pop()),M="",k=m.indexOf("code");if(k>-1&&(m.splice(k,1),M="code."),FO.forEach(ae=>{let Ee=m.indexOf(ae);Ee>-1&&(m.splice(Ee,1),M+=ae+".")}),M+=r,m.length!=0||r.length===0)return null;let U={};return U.domEventName=b,U.fullKey=M,U}static matchEventFullKeyCode(l,m){let b=RU[l.key]||l.key,r="";return m.indexOf("code.")>-1&&(b=l.code,r="code."),b==null||!b?!1:(b=b.toLowerCase(),b===" "?b="space":b==="."&&(b="dot"),FO.forEach(M=>{if(M!==b){let k=PU[M];k(l)&&(r+=M+".")}}),r+=b,r===m)}static eventCallback(l,m,b){return r=>{a.matchEventFullKeyCode(r,l)&&b.runGuarded(()=>m(r))}}static _normalizeKey(l){return l==="esc"?"escape":l}static \u0275fac=function(m){return new(m||a)(ln(di))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})();function OU(){Px.makeCurrent()}function LU(){return new Qs}function FU(){return VT(document),document}var kU=[{provide:Wf,useValue:CO},{provide:dx,useValue:OU,multi:!0},{provide:di,useFactory:FU}],kI=wI(bO,"browser",kU);var NU=[{provide:qf,useClass:Ox},{provide:bx,useClass:e_,deps:[$r,t_,qf]},{provide:e_,useClass:e_,deps:[$r,t_,qf]}],zU=[{provide:Rg,useValue:"root"},{provide:Qs,useFactory:LU},{provide:Rx,useClass:kO,multi:!0,deps:[di]},{provide:Rx,useClass:NO,multi:!0,deps:[di]},FI,OI,PI,{provide:Ad,useExisting:FI},{provide:kd,useClass:MU},[]],NI=(()=>{class a{constructor(){}static \u0275fac=function(m){return new(m||a)};static \u0275mod=$o({type:a});static \u0275inj=bo({providers:[...zU,...NU],imports:[SI,wO]})}return a})();var ep=class{},x_=class{},qa=class a{headers;normalizedNames=new Map;lazyInit;lazyUpdate=null;constructor(u){u?typeof u=="string"?this.lazyInit=()=>{this.headers=new Map,u.split(`
`).forEach(l=>{let m=l.indexOf(":");if(m>0){let b=l.slice(0,m),r=l.slice(m+1).trim();this.addHeaderEntry(b,r)}})}:typeof Headers<"u"&&u instanceof Headers?(this.headers=new Map,u.forEach((l,m)=>{this.addHeaderEntry(m,l)})):this.lazyInit=()=>{this.headers=new Map,Object.entries(u).forEach(([l,m])=>{this.setHeaderEntries(l,m)})}:this.headers=new Map}has(u){return this.init(),this.headers.has(u.toLowerCase())}get(u){this.init();let l=this.headers.get(u.toLowerCase());return l&&l.length>0?l[0]:null}keys(){return this.init(),Array.from(this.normalizedNames.values())}getAll(u){return this.init(),this.headers.get(u.toLowerCase())||null}append(u,l){return this.clone({name:u,value:l,op:"a"})}set(u,l){return this.clone({name:u,value:l,op:"s"})}delete(u,l){return this.clone({name:u,value:l,op:"d"})}maybeSetNormalizedName(u,l){this.normalizedNames.has(l)||this.normalizedNames.set(l,u)}init(){this.lazyInit&&(this.lazyInit instanceof a?this.copyFrom(this.lazyInit):this.lazyInit(),this.lazyInit=null,this.lazyUpdate&&(this.lazyUpdate.forEach(u=>this.applyUpdate(u)),this.lazyUpdate=null))}copyFrom(u){u.init(),Array.from(u.headers.keys()).forEach(l=>{this.headers.set(l,u.headers.get(l)),this.normalizedNames.set(l,u.normalizedNames.get(l))})}clone(u){let l=new a;return l.lazyInit=this.lazyInit&&this.lazyInit instanceof a?this.lazyInit:this,l.lazyUpdate=(this.lazyUpdate||[]).concat([u]),l}applyUpdate(u){let l=u.name.toLowerCase();switch(u.op){case"a":case"s":let m=u.value;if(typeof m=="string"&&(m=[m]),m.length===0)return;this.maybeSetNormalizedName(u.name,l);let b=(u.op==="a"?this.headers.get(l):void 0)||[];b.push(...m),this.headers.set(l,b);break;case"d":let r=u.value;if(!r)this.headers.delete(l),this.normalizedNames.delete(l);else{let M=this.headers.get(l);if(!M)return;M=M.filter(k=>r.indexOf(k)===-1),M.length===0?(this.headers.delete(l),this.normalizedNames.delete(l)):this.headers.set(l,M)}break}}addHeaderEntry(u,l){let m=u.toLowerCase();this.maybeSetNormalizedName(u,m),this.headers.has(m)?this.headers.get(m).push(l):this.headers.set(m,[l])}setHeaderEntries(u,l){let m=(Array.isArray(l)?l:[l]).map(r=>r.toString()),b=u.toLowerCase();this.headers.set(b,m),this.maybeSetNormalizedName(u,b)}forEach(u){this.init(),Array.from(this.normalizedNames.keys()).forEach(l=>u(this.normalizedNames.get(l),this.headers.get(l)))}};var Fx=class{encodeKey(u){return zO(u)}encodeValue(u){return zO(u)}decodeKey(u){return decodeURIComponent(u)}decodeValue(u){return decodeURIComponent(u)}};function BU(a,u){let l=new Map;return a.length>0&&a.replace(/^\?/,"").split("&").forEach(b=>{let r=b.indexOf("="),[M,k]=r==-1?[u.decodeKey(b),""]:[u.decodeKey(b.slice(0,r)),u.decodeValue(b.slice(r+1))],U=l.get(M)||[];U.push(k),l.set(M,U)}),l}var VU=/%(\d[a-f0-9])/gi,UU={40:"@","3A":":",24:"$","2C":",","3B":";","3D":"=","3F":"?","2F":"/"};function zO(a){return encodeURIComponent(a).replace(VU,(u,l)=>UU[l]??u)}function Lx(a){return`${a}`}var Bl=class a{map;encoder;updates=null;cloneFrom=null;constructor(u={}){if(this.encoder=u.encoder||new Fx,u.fromString){if(u.fromObject)throw new en(2805,!1);this.map=BU(u.fromString,this.encoder)}else u.fromObject?(this.map=new Map,Object.keys(u.fromObject).forEach(l=>{let m=u.fromObject[l],b=Array.isArray(m)?m.map(Lx):[Lx(m)];this.map.set(l,b)})):this.map=null}has(u){return this.init(),this.map.has(u)}get(u){this.init();let l=this.map.get(u);return l?l[0]:null}getAll(u){return this.init(),this.map.get(u)||null}keys(){return this.init(),Array.from(this.map.keys())}append(u,l){return this.clone({param:u,value:l,op:"a"})}appendAll(u){let l=[];return Object.keys(u).forEach(m=>{let b=u[m];Array.isArray(b)?b.forEach(r=>{l.push({param:m,value:r,op:"a"})}):l.push({param:m,value:b,op:"a"})}),this.clone(l)}set(u,l){return this.clone({param:u,value:l,op:"s"})}delete(u,l){return this.clone({param:u,value:l,op:"d"})}toString(){return this.init(),this.keys().map(u=>{let l=this.encoder.encodeKey(u);return this.map.get(u).map(m=>l+"="+this.encoder.encodeValue(m)).join("&")}).filter(u=>u!=="").join("&")}clone(u){let l=new a({encoder:this.encoder});return l.cloneFrom=this.cloneFrom||this,l.updates=(this.updates||[]).concat(u),l}init(){this.map===null&&(this.map=new Map),this.cloneFrom!==null&&(this.cloneFrom.init(),this.cloneFrom.keys().forEach(u=>this.map.set(u,this.cloneFrom.map.get(u))),this.updates.forEach(u=>{switch(u.op){case"a":case"s":let l=(u.op==="a"?this.map.get(u.param):void 0)||[];l.push(Lx(u.value)),this.map.set(u.param,l);break;case"d":if(u.value!==void 0){let m=this.map.get(u.param)||[],b=m.indexOf(Lx(u.value));b!==-1&&m.splice(b,1),m.length>0?this.map.set(u.param,m):this.map.delete(u.param)}else{this.map.delete(u.param);break}}}),this.cloneFrom=this.updates=null)}};var kx=class{map=new Map;set(u,l){return this.map.set(u,l),this}get(u){return this.map.has(u)||this.map.set(u,u.defaultValue()),this.map.get(u)}delete(u){return this.map.delete(u),this}has(u){return this.map.has(u)}keys(){return this.map.keys()}};function jU(a){switch(a){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"JSONP":return!1;default:return!0}}function BO(a){return typeof ArrayBuffer<"u"&&a instanceof ArrayBuffer}function VO(a){return typeof Blob<"u"&&a instanceof Blob}function UO(a){return typeof FormData<"u"&&a instanceof FormData}function HU(a){return typeof URLSearchParams<"u"&&a instanceof URLSearchParams}var jO="Content-Type",HO="Accept",$O="X-Request-URL",WO="text/plain",ZO="application/json",GU=`${ZO}, ${WO}, */*`,Jf=class a{url;body=null;headers;context;reportProgress=!1;withCredentials=!1;credentials;keepalive=!1;cache;priority;mode;redirect;responseType="json";method;params;urlWithParams;transferCache;timeout;constructor(u,l,m,b){this.url=l,this.method=u.toUpperCase();let r;if(jU(this.method)||b?(this.body=m!==void 0?m:null,r=b):r=m,r){if(this.reportProgress=!!r.reportProgress,this.withCredentials=!!r.withCredentials,this.keepalive=!!r.keepalive,r.responseType&&(this.responseType=r.responseType),r.headers&&(this.headers=r.headers),r.context&&(this.context=r.context),r.params&&(this.params=r.params),r.priority&&(this.priority=r.priority),r.cache&&(this.cache=r.cache),r.credentials&&(this.credentials=r.credentials),typeof r.timeout=="number"){if(r.timeout<1||!Number.isInteger(r.timeout))throw new Error("");this.timeout=r.timeout}r.mode&&(this.mode=r.mode),r.redirect&&(this.redirect=r.redirect),this.transferCache=r.transferCache}if(this.headers??=new qa,this.context??=new kx,!this.params)this.params=new Bl,this.urlWithParams=l;else{let M=this.params.toString();if(M.length===0)this.urlWithParams=l;else{let k=l.indexOf("?"),U=k===-1?"?":k<l.length-1?"&":"";this.urlWithParams=l+U+M}}}serializeBody(){return this.body===null?null:typeof this.body=="string"||BO(this.body)||VO(this.body)||UO(this.body)||HU(this.body)?this.body:this.body instanceof Bl?this.body.toString():typeof this.body=="object"||typeof this.body=="boolean"||Array.isArray(this.body)?JSON.stringify(this.body):this.body.toString()}detectContentTypeHeader(){return this.body===null||UO(this.body)?null:VO(this.body)?this.body.type||null:BO(this.body)?null:typeof this.body=="string"?WO:this.body instanceof Bl?"application/x-www-form-urlencoded;charset=UTF-8":typeof this.body=="object"||typeof this.body=="number"||typeof this.body=="boolean"?ZO:null}clone(u={}){let l=u.method||this.method,m=u.url||this.url,b=u.responseType||this.responseType,r=u.keepalive??this.keepalive,M=u.priority||this.priority,k=u.cache||this.cache,U=u.mode||this.mode,ae=u.redirect||this.redirect,Ee=u.credentials||this.credentials,Be=u.transferCache??this.transferCache,ht=u.timeout??this.timeout,Oe=u.body!==void 0?u.body:this.body,Ct=u.withCredentials??this.withCredentials,Vt=u.reportProgress??this.reportProgress,Ut=u.headers||this.headers,Nt=u.params||this.params,li=u.context??this.context;return u.setHeaders!==void 0&&(Ut=Object.keys(u.setHeaders).reduce((ci,Rr)=>ci.set(Rr,u.setHeaders[Rr]),Ut)),u.setParams&&(Nt=Object.keys(u.setParams).reduce((ci,Rr)=>ci.set(Rr,u.setParams[Rr]),Nt)),new a(l,m,Oe,{params:Nt,headers:Ut,context:li,reportProgress:Vt,responseType:b,withCredentials:Ct,transferCache:Be,keepalive:r,cache:k,priority:M,timeout:ht,mode:U,redirect:ae,credentials:Ee})}},Nd=function(a){return a[a.Sent=0]="Sent",a[a.UploadProgress=1]="UploadProgress",a[a.ResponseHeader=2]="ResponseHeader",a[a.DownloadProgress=3]="DownloadProgress",a[a.Response=4]="Response",a[a.User=5]="User",a}(Nd||{}),tp=class{headers;status;statusText;url;ok;type;constructor(u,l=200,m="OK"){this.headers=u.headers||new qa,this.status=u.status!==void 0?u.status:l,this.statusText=u.statusText||m,this.url=u.url||null,this.ok=this.status>=200&&this.status<300}},Nx=class a extends tp{constructor(u={}){super(u)}type=Nd.ResponseHeader;clone(u={}){return new a({headers:u.headers||this.headers,status:u.status!==void 0?u.status:this.status,statusText:u.statusText||this.statusText,url:u.url||this.url||void 0})}},b_=class a extends tp{body;constructor(u={}){super(u),this.body=u.body!==void 0?u.body:null}type=Nd.Response;clone(u={}){return new a({body:u.body!==void 0?u.body:this.body,headers:u.headers||this.headers,status:u.status!==void 0?u.status:this.status,statusText:u.statusText||this.statusText,url:u.url||this.url||void 0})}},Qf=class extends tp{name="HttpErrorResponse";message;error;ok=!1;constructor(u){super(u,0,"Unknown Error"),this.status>=200&&this.status<300?this.message=`Http failure during parsing for ${u.url||"(unknown url)"}`:this.message=`Http failure response for ${u.url||"(unknown url)"}: ${u.status} ${u.statusText}`,this.error=u.error||null}},$U=200,WU=204;function zI(a,u){return{body:u,headers:a.headers,context:a.context,observe:a.observe,params:a.params,reportProgress:a.reportProgress,responseType:a.responseType,withCredentials:a.withCredentials,transferCache:a.transferCache,keepalive:a.keepalive,priority:a.priority,cache:a.cache,mode:a.mode,redirect:a.redirect}}var Bx=(()=>{class a{handler;constructor(l){this.handler=l}request(l,m,b={}){let r;if(l instanceof Jf)r=l;else{let U;b.headers instanceof qa?U=b.headers:U=new qa(b.headers);let ae;b.params&&(b.params instanceof Bl?ae=b.params:ae=new Bl({fromObject:b.params})),r=new Jf(l,m,b.body!==void 0?b.body:null,{headers:U,context:b.context,params:ae,reportProgress:b.reportProgress,responseType:b.responseType||"json",withCredentials:b.withCredentials,transferCache:b.transferCache,keepalive:b.keepalive,priority:b.priority,cache:b.cache,mode:b.mode,redirect:b.redirect,credentials:b.credentials})}let M=In(r).pipe(Ua(U=>this.handler.handle(U)));if(l instanceof Jf||b.observe==="events")return M;let k=M.pipe(xo(U=>U instanceof b_));switch(b.observe||"body"){case"body":switch(r.responseType){case"arraybuffer":return k.pipe(or(U=>{if(U.body!==null&&!(U.body instanceof ArrayBuffer))throw new en(2806,!1);return U.body}));case"blob":return k.pipe(or(U=>{if(U.body!==null&&!(U.body instanceof Blob))throw new en(2807,!1);return U.body}));case"text":return k.pipe(or(U=>{if(U.body!==null&&typeof U.body!="string")throw new en(2808,!1);return U.body}));case"json":default:return k.pipe(or(U=>U.body))}case"response":return k;default:throw new en(2809,!1)}}delete(l,m={}){return this.request("DELETE",l,m)}get(l,m={}){return this.request("GET",l,m)}head(l,m={}){return this.request("HEAD",l,m)}jsonp(l,m){return this.request("JSONP",l,{params:new Bl().append(m,"JSONP_CALLBACK"),observe:"body",responseType:"json"})}options(l,m={}){return this.request("OPTIONS",l,m)}patch(l,m,b={}){return this.request("PATCH",l,zI(b,m))}post(l,m,b={}){return this.request("POST",l,zI(b,m))}put(l,m,b={}){return this.request("PUT",l,zI(b,m))}static \u0275fac=function(m){return new(m||a)(ln(ep))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})();var ZU=new Kt("");function qO(a,u){return u(a)}function qU(a,u){return(l,m)=>u.intercept(l,{handle:b=>a(b,m)})}function XU(a,u,l){return(m,b)=>Xi(l,()=>u(m,r=>a(r,b)))}var XO=new Kt(""),VI=new Kt(""),YO=new Kt(""),UI=new Kt("",{providedIn:"root",factory:()=>!0});function YU(){let a=null;return(u,l)=>{a===null&&(a=(ut(XO,{optional:!0})??[]).reduceRight(qU,qO));let m=ut(Vg);if(ut(UI)){let r=m.add();return a(u,l).pipe(Uc(r))}else return a(u,l)}}var zx=(()=>{class a extends ep{backend;injector;chain=null;pendingTasks=ut(Vg);contributeToStability=ut(UI);constructor(l,m){super(),this.backend=l,this.injector=m}handle(l){if(this.chain===null){let m=Array.from(new Set([...this.injector.get(VI),...this.injector.get(YO,[])]));this.chain=m.reduceRight((b,r)=>XU(b,r,this.injector),qO)}if(this.contributeToStability){let m=this.pendingTasks.add();return this.chain(l,b=>this.backend.handle(b)).pipe(Uc(m))}else return this.chain(l,m=>this.backend.handle(m))}static \u0275fac=function(m){return new(m||a)(ln(x_),ln(wi))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})();var KU=/^\)\]\}',?\n/,JU=RegExp(`^${$O}:`,"m");function QU(a){return"responseURL"in a&&a.responseURL?a.responseURL:JU.test(a.getAllResponseHeaders())?a.getResponseHeader($O):null}var BI=(()=>{class a{xhrFactory;constructor(l){this.xhrFactory=l}handle(l){if(l.method==="JSONP")throw new en(-2800,!1);let m=this.xhrFactory;return In(null).pipe(Vo(()=>new br(r=>{let M=m.build();if(M.open(l.method,l.urlWithParams),l.withCredentials&&(M.withCredentials=!0),l.headers.forEach((Ut,Nt)=>M.setRequestHeader(Ut,Nt.join(","))),l.headers.has(HO)||M.setRequestHeader(HO,GU),!l.headers.has(jO)){let Ut=l.detectContentTypeHeader();Ut!==null&&M.setRequestHeader(jO,Ut)}if(l.timeout&&(M.timeout=l.timeout),l.responseType){let Ut=l.responseType.toLowerCase();M.responseType=Ut!=="json"?Ut:"text"}let k=l.serializeBody(),U=null,ae=()=>{if(U!==null)return U;let Ut=M.statusText||"OK",Nt=new qa(M.getAllResponseHeaders()),li=QU(M)||l.url;return U=new Nx({headers:Nt,status:M.status,statusText:Ut,url:li}),U},Ee=()=>{let{headers:Ut,status:Nt,statusText:li,url:ci}=ae(),Rr=null;Nt!==WU&&(Rr=typeof M.response>"u"?M.responseText:M.response),Nt===0&&(Nt=Rr?$U:0);let bs=Nt>=200&&Nt<300;if(l.responseType==="json"&&typeof Rr=="string"){let wo=Rr;Rr=Rr.replace(KU,"");try{Rr=Rr!==""?JSON.parse(Rr):null}catch(ws){Rr=wo,bs&&(bs=!1,Rr={error:ws,text:Rr})}}bs?(r.next(new b_({body:Rr,headers:Ut,status:Nt,statusText:li,url:ci||void 0})),r.complete()):r.error(new Qf({error:Rr,headers:Ut,status:Nt,statusText:li,url:ci||void 0}))},Be=Ut=>{let{url:Nt}=ae(),li=new Qf({error:Ut,status:M.status||0,statusText:M.statusText||"Unknown Error",url:Nt||void 0});r.error(li)},ht=Be;l.timeout&&(ht=Ut=>{let{url:Nt}=ae(),li=new Qf({error:new DOMException("Request timed out","TimeoutError"),status:M.status||0,statusText:M.statusText||"Request timeout",url:Nt||void 0});r.error(li)});let Oe=!1,Ct=Ut=>{Oe||(r.next(ae()),Oe=!0);let Nt={type:Nd.DownloadProgress,loaded:Ut.loaded};Ut.lengthComputable&&(Nt.total=Ut.total),l.responseType==="text"&&M.responseText&&(Nt.partialText=M.responseText),r.next(Nt)},Vt=Ut=>{let Nt={type:Nd.UploadProgress,loaded:Ut.loaded};Ut.lengthComputable&&(Nt.total=Ut.total),r.next(Nt)};return M.addEventListener("load",Ee),M.addEventListener("error",Be),M.addEventListener("timeout",ht),M.addEventListener("abort",Be),l.reportProgress&&(M.addEventListener("progress",Ct),k!==null&&M.upload&&M.upload.addEventListener("progress",Vt)),M.send(k),r.next({type:Nd.Sent}),()=>{M.removeEventListener("error",Be),M.removeEventListener("abort",Be),M.removeEventListener("load",Ee),M.removeEventListener("timeout",ht),l.reportProgress&&(M.removeEventListener("progress",Ct),k!==null&&M.upload&&M.upload.removeEventListener("progress",Vt)),M.readyState!==M.DONE&&M.abort()}})))}static \u0275fac=function(m){return new(m||a)(ln(kd))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),KO=new Kt(""),ej="XSRF-TOKEN",tj=new Kt("",{providedIn:"root",factory:()=>ej}),nj="X-XSRF-TOKEN",rj=new Kt("",{providedIn:"root",factory:()=>nj}),w_=class{},ij=(()=>{class a{doc;cookieName;lastCookieString="";lastToken=null;parseCount=0;constructor(l,m){this.doc=l,this.cookieName=m}getToken(){let l=this.doc.cookie||"";return l!==this.lastCookieString&&(this.parseCount++,this.lastToken=m_(l,this.cookieName),this.lastCookieString=l),this.lastToken}static \u0275fac=function(m){return new(m||a)(ln(di),ln(tj))};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})();function oj(a,u){let l=a.url.toLowerCase();if(!ut(KO)||a.method==="GET"||a.method==="HEAD"||l.startsWith("http://")||l.startsWith("https://"))return u(a);let m=ut(w_).getToken(),b=ut(rj);return m!=null&&!a.headers.has(b)&&(a=a.clone({headers:a.headers.set(b,m)})),u(a)}var jI=function(a){return a[a.Interceptors=0]="Interceptors",a[a.LegacyInterceptors=1]="LegacyInterceptors",a[a.CustomXsrfConfiguration=2]="CustomXsrfConfiguration",a[a.NoXsrfProtection=3]="NoXsrfProtection",a[a.JsonpSupport=4]="JsonpSupport",a[a.RequestsMadeViaParent=5]="RequestsMadeViaParent",a[a.Fetch=6]="Fetch",a}(jI||{});function sj(a,u){return{\u0275kind:a,\u0275providers:u}}function JO(...a){let u=[Bx,BI,zx,{provide:ep,useExisting:zx},{provide:x_,useFactory:()=>ut(ZU,{optional:!0})??ut(BI)},{provide:VI,useValue:oj,multi:!0},{provide:KO,useValue:!0},{provide:w_,useClass:ij}];for(let l of a)u.push(...l.\u0275providers);return Gc(u)}var GO=new Kt("");function QO(){return sj(jI.LegacyInterceptors,[{provide:GO,useFactory:YU},{provide:VI,useExisting:GO,multi:!0}])}var HI=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275mod=$o({type:a});static \u0275inj=bo({providers:[JO(QO())]})}return a})();var eL=(()=>{class a{_doc;constructor(l){this._doc=l}getTitle(){return this._doc.title}setTitle(l){this._doc.title=l||""}static \u0275fac=function(m){return new(m||a)(ln(di))};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();var np=ww(WI(),1);var ZI=new Kt("MapboxApiKey"),E_=(()=>{class a{zone=ut($r);MAPBOX_API_KEY=ut(ZI,{optional:!0});injector=ut(qi);mapInstance;mapCreated$;mapLoaded$;mapEvents;mapCreated=new Tf;mapLoaded=new Tf;markersToRemove=[];popupsToRemove=[];imageIdsToRemove=[];subscription=new _i;constructor(){this.mapCreated$=this.mapCreated.asObservable(),this.mapLoaded$=this.mapLoaded.asObservable()}setup(l){let m=Vr($t({},l.mapOptions),{bearing:Array.isArray(l.mapOptions.bearing)?l.mapOptions.bearing[0]:l.mapOptions.bearing,zoom:Array.isArray(l.mapOptions.zoom)?l.mapOptions.zoom[0]:l.mapOptions.zoom,pitch:Array.isArray(l.mapOptions.pitch)?l.mapOptions.pitch[0]:l.mapOptions.pitch,accessToken:l.accessToken||this.MAPBOX_API_KEY||""});this.createMap(m),this.hookEvents(l.mapEvents),this.mapEvents=l.mapEvents,this.mapCreated.next(void 0),this.mapCreated.complete(),l.mapEvents.mapCreate.observed&&this.zone.run(()=>{l.mapEvents.mapCreate.emit(this.mapInstance)})}destroyMap(){this.mapInstance&&(this.subscription.unsubscribe(),this.mapInstance.remove())}updateProjection(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setProjection(l)})}updateMinZoom(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMinZoom(l)})}updateMaxZoom(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMaxZoom(l)})}updateMinPitch(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMinPitch(l)})}updateMaxPitch(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMaxPitch(l)})}updateRenderWorldCopies(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setRenderWorldCopies(l)})}updateScrollZoom(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.scrollZoom.enable():this.mapInstance.scrollZoom.disable()})}updateDragRotate(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.dragRotate.enable():this.mapInstance.dragRotate.disable()})}updateTouchPitch(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.touchPitch.enable():this.mapInstance.touchPitch.disable()})}updateTouchZoomRotate(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.touchZoomRotate.enable():this.mapInstance.touchZoomRotate.disable()})}updateDoubleClickZoom(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.doubleClickZoom.enable():this.mapInstance.doubleClickZoom.disable()})}updateKeyboard(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.keyboard.enable():this.mapInstance.keyboard.disable()})}updateDragPan(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.dragPan.enable():this.mapInstance.dragPan.disable()})}updateBoxZoom(l){return this.zone.runOutsideAngular(()=>{l?this.mapInstance.boxZoom.enable():this.mapInstance.boxZoom.disable()})}updateStyle(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setStyle(l)})}updateMaxBounds(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.setMaxBounds(l)})}changeCanvasCursor(l){let m=this.mapInstance.getCanvasContainer();m.style.cursor=l}queryRenderedFeatures(l,m){return this.mapInstance.queryRenderedFeatures(l,m)}panTo(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.panTo(l,m)})}move(l,m,b,r,M,k){return this.zone.runOutsideAngular(()=>{this.mapInstance[l](Vr($t({},m),{zoom:b??this.mapInstance.getZoom(),center:r??this.mapInstance.getCenter(),bearing:M??this.mapInstance.getBearing(),pitch:k??this.mapInstance.getPitch()}))})}addLayer(l,m,b){this.zone.runOutsideAngular(()=>{Object.keys(l.layerOptions).forEach(r=>{let M=r;l.layerOptions[M]===void 0&&delete l.layerOptions[M]}),this.mapInstance.addLayer(l.layerOptions,b),m&&(l.layerEvents.layerClick.observed&&this.mapInstance.on("click",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerClick.emit(r)})}),l.layerEvents.layerDblClick.observed&&this.mapInstance.on("dblclick",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerDblClick.emit(r)})}),l.layerEvents.layerMouseDown.observed&&this.mapInstance.on("mousedown",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseDown.emit(r)})}),l.layerEvents.layerMouseUp.observed&&this.mapInstance.on("mouseup",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseUp.emit(r)})}),l.layerEvents.layerMouseEnter.observed&&this.mapInstance.on("mouseenter",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseEnter.emit(r)})}),l.layerEvents.layerMouseLeave.observed&&this.mapInstance.on("mouseleave",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseLeave.emit(r)})}),l.layerEvents.layerMouseMove.observed&&this.mapInstance.on("mousemove",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseMove.emit(r)})}),l.layerEvents.layerMouseOver.observed&&this.mapInstance.on("mouseover",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseOver.emit(r)})}),l.layerEvents.layerMouseOut.observed&&this.mapInstance.on("mouseout",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerMouseOut.emit(r)})}),l.layerEvents.layerContextMenu.observed&&this.mapInstance.on("contextmenu",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerContextMenu.emit(r)})}),l.layerEvents.layerTouchStart.observed&&this.mapInstance.on("touchstart",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerTouchStart.emit(r)})}),l.layerEvents.layerTouchEnd.observed&&this.mapInstance.on("touchend",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerTouchEnd.emit(r)})}),l.layerEvents.layerTouchCancel.observed&&this.mapInstance.on("touchcancel",l.layerOptions.id,r=>{this.zone.run(()=>{l.layerEvents.layerTouchCancel.emit(r)})}))})}removeLayer(l){this.zone.runOutsideAngular(()=>{this.mapInstance.getLayer(l)!=null&&this.mapInstance.removeLayer(l)})}addMarker(l){let m={offset:l.markersOptions.offset,anchor:l.markersOptions.anchor,draggable:l.markersOptions.draggable,rotationAlignment:l.markersOptions.rotationAlignment,pitchAlignment:l.markersOptions.pitchAlignment,clickTolerance:l.markersOptions.clickTolerance};Object.keys(m).forEach(M=>{let k=M;m[k]===void 0&&delete m[k]}),l.markersOptions.element.childNodes.length>0&&(m.element=l.markersOptions.element);let b=new np.Marker(m);l.markersEvents.markerDragStart.observed&&b.on("dragstart",M=>{if(M){let{target:k}=M;this.zone.run(()=>{l.markersEvents.markerDragStart.emit(k)})}}),l.markersEvents.markerDrag.observed&&b.on("drag",M=>{if(M){let{target:k}=M;this.zone.run(()=>{l.markersEvents.markerDrag.emit(k)})}}),l.markersEvents.markerDragEnd.observed&&b.on("dragend",M=>{if(M){let{target:k}=M;this.zone.run(()=>{l.markersEvents.markerDragEnd.emit(k)})}});let r=l.markersOptions.feature?l.markersOptions.feature.geometry.coordinates:l.markersOptions.lngLat;return b.setLngLat(r),this.zone.runOutsideAngular(()=>(b.addTo(this.mapInstance),b))}removeMarker(l){this.markersToRemove.push(l)}createPopup(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(l.popupOptions).forEach(r=>{let M=r;return l.popupOptions[M]===void 0&&delete l.popupOptions[M]});let b=new np.Popup(l.popupOptions);return b.setDOMContent(m),l.popupEvents.popupClose.observed&&b.on("close",()=>{this.zone.run(()=>{l.popupEvents.popupClose.emit()})}),l.popupEvents.popupOpen.observed&&b.on("open",()=>{this.zone.run(()=>{l.popupEvents.popupOpen.emit()})}),b})}addPopupToMap(l,m,b=!1){return this.zone.runOutsideAngular(()=>{b&&l._listeners&&delete l._listeners.open,l.setLngLat(m),l.addTo(this.mapInstance)})}addPopupToMarker(l,m){return this.zone.runOutsideAngular(()=>{l.setPopup(m)})}removePopupFromMap(l,m=!1){m&&l._listeners&&delete l._listeners.close,this.popupsToRemove.push(l)}removePopupFromMarker(l){return this.zone.runOutsideAngular(()=>{l.setPopup(void 0)})}addControl(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.addControl(l,m)})}removeControl(l){return this.zone.runOutsideAngular(()=>{this.mapInstance.removeControl(l)})}loadAndAddImage(l,m,b){return El(this,null,function*(){return this.zone.runOutsideAngular(()=>new Promise((r,M)=>{this.mapInstance.loadImage(m,(k,U)=>{if(k){M(k);return}if(!U){M(new Error("Image not loaded"));return}this.addImage(l,U,b),r()})}))})}addImage(l,m,b){return this.zone.runOutsideAngular(()=>{this.mapInstance.addImage(l,m,b)})}removeImage(l){this.imageIdsToRemove.push(l)}addSource(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(m).forEach(b=>{let r=b;return m[r]===void 0&&delete m[r]}),this.mapInstance.addSource(l,m)})}getSource(l){return this.mapInstance.getSource(l)}removeSource(l){this.zone.runOutsideAngular(()=>{this.findLayersBySourceId(l).forEach(m=>this.mapInstance.removeLayer(m.id)),this.mapInstance.removeSource(l)})}setLayerAllPaintProperty(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(m).forEach(b=>{let r=b;this.mapInstance.setPaintProperty(l,r,m[r])})})}setLayerAllLayoutProperty(l,m){return this.zone.runOutsideAngular(()=>{Object.keys(m).forEach(b=>{let r=b;this.mapInstance.setLayoutProperty(l,r,m[r])})})}setLayerFilter(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.setFilter(l,m)})}setLayerBefore(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.moveLayer(l,m)})}setLayerZoomRange(l,m,b){return this.zone.runOutsideAngular(()=>{this.mapInstance.setLayerZoomRange(l,m||0,b||20)})}fitBounds(l,m){return this.zone.runOutsideAngular(()=>{this.mapInstance.fitBounds(l,m)})}fitScreenCoordinates(l,m,b){return this.zone.runOutsideAngular(()=>{this.mapInstance.fitScreenCoordinates(l[0],l[1],m,b)})}applyChanges(){this.zone.runOutsideAngular(()=>{this.removeMarkers(),this.removePopups(),this.removeImages()})}createMap(l){$r.assertNotInAngularZone(),Object.keys(l).forEach(m=>{let b=m;l[b]===void 0&&delete l[b]}),this.mapInstance=new np.Map(l),aI({write:()=>{this.applyChanges()}},{injector:this.injector})}removeMarkers(){for(let l of this.markersToRemove)l.remove();this.markersToRemove=[]}removePopups(){for(let l of this.popupsToRemove)l.remove();this.popupsToRemove=[]}removeImages(){for(let l of this.imageIdsToRemove)this.mapInstance.removeImage(l);this.imageIdsToRemove=[]}findLayersBySourceId(l){let m=this.mapInstance.getStyle().layers;return m==null?[]:m.filter(b=>"source"in b?b.source===l:!1)}hookEvents(l){this.mapInstance.on("load",m=>{this.mapLoaded.next(void 0),this.mapLoaded.complete(),this.zone.run(()=>{l.mapLoad.emit(m)})}),l.mapResize.observed&&this.mapInstance.on("resize",m=>this.zone.run(()=>{l.mapResize.emit(m)})),l.mapRemove.observed&&this.mapInstance.on("remove",m=>this.zone.run(()=>{l.mapRemove.emit(m)})),l.mapMouseDown.observed&&this.mapInstance.on("mousedown",m=>this.zone.run(()=>{l.mapMouseDown.emit(m)})),l.mapMouseUp.observed&&this.mapInstance.on("mouseup",m=>this.zone.run(()=>{l.mapMouseUp.emit(m)})),l.mapMouseMove.observed&&this.mapInstance.on("mousemove",m=>this.zone.run(()=>{l.mapMouseMove.emit(m)})),l.mapClick.observed&&this.mapInstance.on("click",m=>this.zone.run(()=>{l.mapClick.emit(m)})),l.mapDblClick.observed&&this.mapInstance.on("dblclick",m=>this.zone.run(()=>{l.mapDblClick.emit(m)})),l.mapMouseOver.observed&&this.mapInstance.on("mouseover",m=>this.zone.run(()=>{l.mapMouseOver.emit(m)})),l.mapMouseOut.observed&&this.mapInstance.on("mouseout",m=>this.zone.run(()=>{l.mapMouseOut.emit(m)})),l.mapContextMenu.observed&&this.mapInstance.on("contextmenu",m=>this.zone.run(()=>{l.mapContextMenu.emit(m)})),l.mapTouchStart.observed&&this.mapInstance.on("touchstart",m=>this.zone.run(()=>{l.mapTouchStart.emit(m)})),l.mapTouchEnd.observed&&this.mapInstance.on("touchend",m=>this.zone.run(()=>{l.mapTouchEnd.emit(m)})),l.mapTouchMove.observed&&this.mapInstance.on("touchmove",m=>this.zone.run(()=>{l.mapTouchMove.emit(m)})),l.mapTouchCancel.observed&&this.mapInstance.on("touchcancel",m=>this.zone.run(()=>{l.mapTouchCancel.emit(m)})),l.mapWheel.observed&&this.mapInstance.on("wheel",m=>this.zone.run(()=>{l.mapWheel.emit(m)})),l.moveStart.observed&&this.mapInstance.on("movestart",m=>this.zone.run(()=>l.moveStart.emit(m))),l.move.observed&&this.mapInstance.on("move",m=>this.zone.run(()=>l.move.emit(m))),l.moveEnd.observed&&this.mapInstance.on("moveend",m=>this.zone.run(()=>l.moveEnd.emit(m))),l.mapDragStart.observed&&this.mapInstance.on("dragstart",m=>this.zone.run(()=>l.mapDragStart.emit(m))),l.mapDrag.observed&&this.mapInstance.on("drag",m=>this.zone.run(()=>l.mapDrag.emit(m))),l.mapDragEnd.observed&&this.mapInstance.on("dragend",m=>this.zone.run(()=>l.mapDragEnd.emit(m))),l.zoomStart.observed&&this.mapInstance.on("zoomstart",()=>this.zone.run(()=>l.zoomStart.emit())),l.zoomEvt.observed&&this.mapInstance.on("zoom",()=>this.zone.run(()=>l.zoomEvt.emit())),l.zoomEnd.observed&&this.mapInstance.on("zoomend",()=>this.zone.run(()=>l.zoomEnd.emit())),l.rotateStart.observed&&this.mapInstance.on("rotatestart",m=>this.zone.run(()=>l.rotateStart.emit(m))),l.rotate.observed&&this.mapInstance.on("rotate",m=>this.zone.run(()=>l.rotate.emit(m))),l.rotateEnd.observed&&this.mapInstance.on("rotateend",m=>this.zone.run(()=>l.rotateEnd.emit(m))),l.pitchStart.observed&&this.mapInstance.on("pitchstart",()=>this.zone.run(()=>l.pitchStart.emit())),l.pitchEvt.observed&&this.mapInstance.on("pitch",()=>this.zone.run(()=>l.pitchEvt.emit())),l.pitchEnd.observed&&this.mapInstance.on("pitchend",()=>this.zone.run(()=>l.pitchEnd.emit())),l.boxZoomStart.observed&&this.mapInstance.on("boxzoomstart",m=>this.zone.run(()=>l.boxZoomStart.emit(m))),l.boxZoomEnd.observed&&this.mapInstance.on("boxzoomend",m=>this.zone.run(()=>l.boxZoomEnd.emit(m))),l.boxZoomCancel.observed&&this.mapInstance.on("boxzoomcancel",m=>this.zone.run(()=>l.boxZoomCancel.emit(m))),l.webGlContextLost.observed&&this.mapInstance.on("webglcontextlost",m=>this.zone.run(()=>l.webGlContextLost.emit(m))),l.webGlContextRestored.observed&&this.mapInstance.on("webglcontextrestored",m=>this.zone.run(()=>l.webGlContextRestored.emit(m))),l.render.observed&&this.mapInstance.on("render",()=>this.zone.run(()=>l.render.emit())),l.mapError.observed&&this.mapInstance.on("error",m=>this.zone.run(()=>l.mapError.emit(m.error))),l.data.observed&&this.mapInstance.on("data",m=>this.zone.run(()=>l.data.emit(m))),l.styleData.observed&&this.mapInstance.on("styledata",m=>this.zone.run(()=>l.styleData.emit(m))),l.sourceData.observed&&this.mapInstance.on("sourcedata",m=>this.zone.run(()=>l.sourceData.emit(m))),l.dataLoading.observed&&this.mapInstance.on("dataloading",m=>this.zone.run(()=>l.dataLoading.emit(m))),l.styleDataLoading.observed&&this.mapInstance.on("styledataloading",m=>this.zone.run(()=>l.styleDataLoading.emit(m))),l.sourceDataLoading.observed&&this.mapInstance.on("sourcedataloading",m=>this.zone.run(()=>l.sourceDataLoading.emit(m))),l.styleImageMissing.observed&&this.mapInstance.on("styleimagemissing",m=>this.zone.run(()=>l.styleImageMissing.emit(m))),l.idle.observed&&this.mapInstance.on("idle",()=>this.zone.run(()=>l.idle.emit()))}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})();function nL(a){return{provide:ZI,useValue:a.accessToken}}var cj=["content"],uj=["*"],qI=class{container;constructor(u){this.container=u}onAdd(){return this.container}onRemove(){return this.container.parentNode.removeChild(this.container)}getDefaultPosition(){return"top-right"}},rL=(()=>{class a{mapService=ut(E_);position=_n();content;control;controlAdded=!1;ngAfterContentInit(){this.content.nativeElement.childNodes.length&&(this.control=new qI(this.content.nativeElement),this.mapService.mapCreated$.subscribe(()=>{this.mapService.addControl(this.control,this.position()),this.controlAdded=!0}))}ngOnDestroy(){this.controlAdded&&this.mapService.removeControl(this.control)}static \u0275fac=function(m){return new(m||a)};static \u0275cmp=kl({type:a,selectors:[["mgl-control"]],viewQuery:function(m,b){if(m&1&&c_(cj,7),m&2){let r;Yf(r=Kf())&&(b.content=r.first)}},inputs:{position:[1,"position"]},ngContentSelectors:uj,decls:3,vars:0,consts:[["content",""],[1,"mapboxgl-ctrl"]],template:function(m,b){m&1&&(fI(),o_(0,"div",1,0),pI(2),s_())},encapsulation:2,changeDetection:0})}return a})();var dj=["container"],Vx=(()=>{class a{mapService=ut(E_);accessToken=_n();collectResourceTiming=_n();crossSourceCollisions=_n();fadeDuration=_n();hash=_n();refreshExpiredTiles=_n();failIfMajorPerformanceCaveat=_n();bearingSnap=_n();interactive=_n();pitchWithRotate=_n();clickTolerance=_n();attributionControl=_n();logoPosition=_n();maxTileCacheSize=_n();localIdeographFontFamily=_n();preserveDrawingBuffer=_n();trackResize=_n();transformRequest=_n();bounds=_n();antialias=_n();locale=_n();cooperativeGestures=_n();minZoom=_n();maxZoom=_n();minPitch=_n();maxPitch=_n();scrollZoom=_n();dragRotate=_n();touchPitch=_n();touchZoomRotate=_n();doubleClickZoom=_n();keyboard=_n();dragPan=_n();boxZoom=_n();style=_n();center=_n();maxBounds=_n();zoom=_n();bearing=_n();pitch=_n();fitBoundsOptions=_n();renderWorldCopies=_n();projection=_n();movingMethod=_n("flyTo");movingOptions=_n();fitBounds=_n();fitScreenCoordinates=_n();centerWithPanTo=_n();panToOptions=_n();cursorStyle=_n();mapResize=new an;mapRemove=new an;mapMouseDown=new an;mapMouseUp=new an;mapMouseMove=new an;mapClick=new an;mapDblClick=new an;mapMouseOver=new an;mapMouseOut=new an;mapContextMenu=new an;mapTouchStart=new an;mapTouchEnd=new an;mapTouchMove=new an;mapTouchCancel=new an;mapWheel=new an;moveStart=new an;move=new an;moveEnd=new an;mapDragStart=new an;mapDrag=new an;mapDragEnd=new an;zoomStart=new an;zoomEvt=new an;zoomEnd=new an;rotateStart=new an;rotate=new an;rotateEnd=new an;pitchStart=new an;pitchEvt=new an;pitchEnd=new an;boxZoomStart=new an;boxZoomEnd=new an;boxZoomCancel=new an;webGlContextLost=new an;webGlContextRestored=new an;mapLoad=new an;mapCreate=new an;idle=new an;render=new an;mapError=new an;data=new an;styleData=new an;sourceData=new an;dataLoading=new an;styleDataLoading=new an;sourceDataLoading=new an;styleImageMissing=new an;get mapInstance(){return this.mapService.mapInstance}mapContainer;constructor(){Qg(()=>{this.mapService.setup({accessToken:this.accessToken(),mapOptions:{collectResourceTiming:this.collectResourceTiming(),container:this.mapContainer.nativeElement,crossSourceCollisions:this.crossSourceCollisions(),fadeDuration:this.fadeDuration(),minZoom:this.minZoom(),maxZoom:this.maxZoom(),minPitch:this.minPitch(),maxPitch:this.maxPitch(),style:this.style(),hash:this.hash(),interactive:this.interactive(),bearingSnap:this.bearingSnap(),pitchWithRotate:this.pitchWithRotate(),clickTolerance:this.clickTolerance(),attributionControl:this.attributionControl(),logoPosition:this.logoPosition(),failIfMajorPerformanceCaveat:this.failIfMajorPerformanceCaveat(),preserveDrawingBuffer:this.preserveDrawingBuffer(),refreshExpiredTiles:this.refreshExpiredTiles(),maxBounds:this.maxBounds(),scrollZoom:this.scrollZoom(),boxZoom:this.boxZoom(),dragRotate:this.dragRotate(),dragPan:this.dragPan(),keyboard:this.keyboard(),doubleClickZoom:this.doubleClickZoom(),touchPitch:this.touchPitch(),touchZoomRotate:this.touchZoomRotate(),trackResize:this.trackResize(),center:this.center(),zoom:this.zoom(),bearing:this.bearing(),pitch:this.pitch(),renderWorldCopies:this.renderWorldCopies(),maxTileCacheSize:this.maxTileCacheSize(),localIdeographFontFamily:this.localIdeographFontFamily(),transformRequest:this.transformRequest(),bounds:this.bounds()?this.bounds():this.fitBounds(),fitBoundsOptions:this.fitBoundsOptions(),antialias:this.antialias(),locale:this.locale(),cooperativeGestures:this.cooperativeGestures(),projection:this.projection()},mapEvents:this}),this.cursorStyle()&&this.mapService.changeCanvasCursor(this.cursorStyle())})}ngOnDestroy(){this.mapService.destroyMap()}ngOnChanges(l){return El(this,null,function*(){if(yield Hw(this.mapService.mapCreated$),l.cursorStyle&&!l.cursorStyle.isFirstChange()&&this.mapService.changeCanvasCursor(l.cursorStyle.currentValue),l.projection&&!l.projection.isFirstChange()&&this.mapService.updateProjection(l.projection.currentValue),l.minZoom&&!l.minZoom.isFirstChange()&&this.mapService.updateMinZoom(l.minZoom.currentValue),l.maxZoom&&!l.maxZoom.isFirstChange()&&this.mapService.updateMaxZoom(l.maxZoom.currentValue),l.minPitch&&!l.minPitch.isFirstChange()&&this.mapService.updateMinPitch(l.minPitch.currentValue),l.maxPitch&&!l.maxPitch.isFirstChange()&&this.mapService.updateMaxPitch(l.maxPitch.currentValue),l.renderWorldCopies&&!l.renderWorldCopies.isFirstChange()&&this.mapService.updateRenderWorldCopies(l.renderWorldCopies.currentValue),l.scrollZoom&&!l.scrollZoom.isFirstChange()&&this.mapService.updateScrollZoom(l.scrollZoom.currentValue),l.dragRotate&&!l.dragRotate.isFirstChange()&&this.mapService.updateDragRotate(l.dragRotate.currentValue),l.touchPitch&&!l.touchPitch.isFirstChange()&&this.mapService.updateTouchPitch(l.touchPitch.currentValue),l.touchZoomRotate&&!l.touchZoomRotate.isFirstChange()&&this.mapService.updateTouchZoomRotate(l.touchZoomRotate.currentValue),l.doubleClickZoom&&!l.doubleClickZoom.isFirstChange()&&this.mapService.updateDoubleClickZoom(l.doubleClickZoom.currentValue),l.keyboard&&!l.keyboard.isFirstChange()&&this.mapService.updateKeyboard(l.keyboard.currentValue),l.dragPan&&!l.dragPan.isFirstChange()&&this.mapService.updateDragPan(l.dragPan.currentValue),l.boxZoom&&!l.boxZoom.isFirstChange()&&this.mapService.updateBoxZoom(l.boxZoom.currentValue),l.style&&!l.style.isFirstChange()&&this.mapService.updateStyle(l.style.currentValue),l.maxBounds&&!l.maxBounds.isFirstChange()&&this.mapService.updateMaxBounds(l.maxBounds.currentValue),l.fitBounds&&l.fitBounds.currentValue&&!l.fitBounds.isFirstChange()&&this.mapService.fitBounds(l.fitBounds.currentValue,this.fitBoundsOptions()),l.fitScreenCoordinates&&l.fitScreenCoordinates.currentValue){(this.center()||this.zoom()||this.pitch()||this.fitBounds())&&l.fitScreenCoordinates.isFirstChange()&&console.warn("[ngx-mapbox-gl] center / zoom / pitch / fitBounds inputs are being overridden by fitScreenCoordinates input");let m=this.bearing();this.mapService.fitScreenCoordinates(l.fitScreenCoordinates.currentValue,Array.isArray(m)?m[0]:m||0,this.movingOptions())}if(this.centerWithPanTo()&&l.center&&!l.center.isFirstChange()&&!l.zoom&&!l.bearing&&!l.pitch)this.mapService.panTo(this.center(),this.panToOptions());else if(l.center&&!l.center.isFirstChange()||l.zoom&&!l.zoom.isFirstChange()||l.bearing&&!l.bearing.isFirstChange()&&!l.fitScreenCoordinates||l.pitch&&!l.pitch.isFirstChange()){let m=this.zoom(),b=this.center(),r=this.bearing(),M=this.pitch();this.mapService.move(this.movingMethod(),this.movingOptions(),l.zoom&&m?Array.isArray(m)?m[0]:m:void 0,l.center?b:void 0,l.bearing&&r?Array.isArray(r)?r[0]:r:void 0,l.pitch&&M?Array.isArray(M)?M[0]:M:void 0)}})}static \u0275fac=function(m){return new(m||a)};static \u0275cmp=kl({type:a,selectors:[["mgl-map"]],viewQuery:function(m,b){if(m&1&&c_(dj,7),m&2){let r;Yf(r=Kf())&&(b.mapContainer=r.first)}},inputs:{accessToken:[1,"accessToken"],collectResourceTiming:[1,"collectResourceTiming"],crossSourceCollisions:[1,"crossSourceCollisions"],fadeDuration:[1,"fadeDuration"],hash:[1,"hash"],refreshExpiredTiles:[1,"refreshExpiredTiles"],failIfMajorPerformanceCaveat:[1,"failIfMajorPerformanceCaveat"],bearingSnap:[1,"bearingSnap"],interactive:[1,"interactive"],pitchWithRotate:[1,"pitchWithRotate"],clickTolerance:[1,"clickTolerance"],attributionControl:[1,"attributionControl"],logoPosition:[1,"logoPosition"],maxTileCacheSize:[1,"maxTileCacheSize"],localIdeographFontFamily:[1,"localIdeographFontFamily"],preserveDrawingBuffer:[1,"preserveDrawingBuffer"],trackResize:[1,"trackResize"],transformRequest:[1,"transformRequest"],bounds:[1,"bounds"],antialias:[1,"antialias"],locale:[1,"locale"],cooperativeGestures:[1,"cooperativeGestures"],minZoom:[1,"minZoom"],maxZoom:[1,"maxZoom"],minPitch:[1,"minPitch"],maxPitch:[1,"maxPitch"],scrollZoom:[1,"scrollZoom"],dragRotate:[1,"dragRotate"],touchPitch:[1,"touchPitch"],touchZoomRotate:[1,"touchZoomRotate"],doubleClickZoom:[1,"doubleClickZoom"],keyboard:[1,"keyboard"],dragPan:[1,"dragPan"],boxZoom:[1,"boxZoom"],style:[1,"style"],center:[1,"center"],maxBounds:[1,"maxBounds"],zoom:[1,"zoom"],bearing:[1,"bearing"],pitch:[1,"pitch"],fitBoundsOptions:[1,"fitBoundsOptions"],renderWorldCopies:[1,"renderWorldCopies"],projection:[1,"projection"],movingMethod:[1,"movingMethod"],movingOptions:[1,"movingOptions"],fitBounds:[1,"fitBounds"],fitScreenCoordinates:[1,"fitScreenCoordinates"],centerWithPanTo:[1,"centerWithPanTo"],panToOptions:[1,"panToOptions"],cursorStyle:[1,"cursorStyle"]},outputs:{mapResize:"mapResize",mapRemove:"mapRemove",mapMouseDown:"mapMouseDown",mapMouseUp:"mapMouseUp",mapMouseMove:"mapMouseMove",mapClick:"mapClick",mapDblClick:"mapDblClick",mapMouseOver:"mapMouseOver",mapMouseOut:"mapMouseOut",mapContextMenu:"mapContextMenu",mapTouchStart:"mapTouchStart",mapTouchEnd:"mapTouchEnd",mapTouchMove:"mapTouchMove",mapTouchCancel:"mapTouchCancel",mapWheel:"mapWheel",moveStart:"moveStart",move:"move",moveEnd:"moveEnd",mapDragStart:"mapDragStart",mapDrag:"mapDrag",mapDragEnd:"mapDragEnd",zoomStart:"zoomStart",zoomEvt:"zoomEvt",zoomEnd:"zoomEnd",rotateStart:"rotateStart",rotate:"rotate",rotateEnd:"rotateEnd",pitchStart:"pitchStart",pitchEvt:"pitchEvt",pitchEnd:"pitchEnd",boxZoomStart:"boxZoomStart",boxZoomEnd:"boxZoomEnd",boxZoomCancel:"boxZoomCancel",webGlContextLost:"webGlContextLost",webGlContextRestored:"webGlContextRestored",mapLoad:"mapLoad",mapCreate:"mapCreate",idle:"idle",render:"render",mapError:"mapError",data:"data",styleData:"styleData",sourceData:"sourceData",dataLoading:"dataLoading",styleDataLoading:"styleDataLoading",sourceDataLoading:"sourceDataLoading",styleImageMissing:"styleImageMissing"},features:[gI([E_]),Pd],decls:2,vars:0,consts:[["container",""]],template:function(m,b){m&1&&Ix(0,"div",null,0)},styles:["[_nghost-%COMP%]{display:block}div[_ngcontent-%COMP%]{height:100%;width:100%}"],changeDetection:0})}return a})();var cL="3.7.7",hj=cL,ip=typeof Buffer=="function",iL=typeof TextDecoder=="function"?new TextDecoder:void 0,oL=typeof TextEncoder=="function"?new TextEncoder:void 0,fj="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",T_=Array.prototype.slice.call(fj),Ux=(a=>{let u={};return a.forEach((l,m)=>u[l]=m),u})(T_),pj=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,co=String.fromCharCode.bind(String),sL=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):a=>new Uint8Array(Array.prototype.slice.call(a,0)),uL=a=>a.replace(/=/g,"").replace(/[+\/]/g,u=>u=="+"?"-":"_"),dL=a=>a.replace(/[^A-Za-z0-9\+\/]/g,""),hL=a=>{let u,l,m,b,r="",M=a.length%3;for(let k=0;k<a.length;){if((l=a.charCodeAt(k++))>255||(m=a.charCodeAt(k++))>255||(b=a.charCodeAt(k++))>255)throw new TypeError("invalid character found");u=l<<16|m<<8|b,r+=T_[u>>18&63]+T_[u>>12&63]+T_[u>>6&63]+T_[u&63]}return M?r.slice(0,M-3)+"===".substring(M):r},KI=typeof btoa=="function"?a=>btoa(a):ip?a=>Buffer.from(a,"binary").toString("base64"):hL,XI=ip?a=>Buffer.from(a).toString("base64"):a=>{let l=[];for(let m=0,b=a.length;m<b;m+=4096)l.push(co.apply(null,a.subarray(m,m+4096)));return KI(l.join(""))},jx=(a,u=!1)=>u?uL(XI(a)):XI(a),mj=a=>{if(a.length<2){var u=a.charCodeAt(0);return u<128?a:u<2048?co(192|u>>>6)+co(128|u&63):co(224|u>>>12&15)+co(128|u>>>6&63)+co(128|u&63)}else{var u=65536+(a.charCodeAt(0)-55296)*1024+(a.charCodeAt(1)-56320);return co(240|u>>>18&7)+co(128|u>>>12&63)+co(128|u>>>6&63)+co(128|u&63)}},gj=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,fL=a=>a.replace(gj,mj),aL=ip?a=>Buffer.from(a,"utf8").toString("base64"):oL?a=>XI(oL.encode(a)):a=>KI(fL(a)),rp=(a,u=!1)=>u?uL(aL(a)):aL(a),lL=a=>rp(a,!0),_j=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,yj=a=>{switch(a.length){case 4:var u=(7&a.charCodeAt(0))<<18|(63&a.charCodeAt(1))<<12|(63&a.charCodeAt(2))<<6|63&a.charCodeAt(3),l=u-65536;return co((l>>>10)+55296)+co((l&1023)+56320);case 3:return co((15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2));default:return co((31&a.charCodeAt(0))<<6|63&a.charCodeAt(1))}},pL=a=>a.replace(_j,yj),mL=a=>{if(a=a.replace(/\s+/g,""),!pj.test(a))throw new TypeError("malformed base64.");a+="==".slice(2-(a.length&3));let u,l="",m,b;for(let r=0;r<a.length;)u=Ux[a.charAt(r++)]<<18|Ux[a.charAt(r++)]<<12|(m=Ux[a.charAt(r++)])<<6|(b=Ux[a.charAt(r++)]),l+=m===64?co(u>>16&255):b===64?co(u>>16&255,u>>8&255):co(u>>16&255,u>>8&255,u&255);return l},JI=typeof atob=="function"?a=>atob(dL(a)):ip?a=>Buffer.from(a,"base64").toString("binary"):mL,gL=ip?a=>sL(Buffer.from(a,"base64")):a=>sL(JI(a).split("").map(u=>u.charCodeAt(0))),_L=a=>gL(yL(a)),vj=ip?a=>Buffer.from(a,"base64").toString("utf8"):iL?a=>iL.decode(gL(a)):a=>pL(JI(a)),yL=a=>dL(a.replace(/[-_]/g,u=>u=="-"?"+":"/")),YI=a=>vj(yL(a)),xj=a=>{if(typeof a!="string")return!1;let u=a.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(u)||!/[^\s0-9a-zA-Z\-_]/.test(u)},vL=a=>({value:a,enumerable:!1,writable:!0,configurable:!0}),xL=function(){let a=(u,l)=>Object.defineProperty(String.prototype,u,vL(l));a("fromBase64",function(){return YI(this)}),a("toBase64",function(u){return rp(this,u)}),a("toBase64URI",function(){return rp(this,!0)}),a("toBase64URL",function(){return rp(this,!0)}),a("toUint8Array",function(){return _L(this)})},bL=function(){let a=(u,l)=>Object.defineProperty(Uint8Array.prototype,u,vL(l));a("toBase64",function(u){return jx(this,u)}),a("toBase64URI",function(){return jx(this,!0)}),a("toBase64URL",function(){return jx(this,!0)})},bj=()=>{xL(),bL()},zd={version:cL,VERSION:hj,atob:JI,atobPolyfill:mL,btoa:KI,btoaPolyfill:hL,fromBase64:YI,toBase64:rp,encode:rp,encodeURI:lL,encodeURL:lL,utob:fL,btou:pL,decode:YI,isValid:xj,fromUint8Array:jx,toUint8Array:_L,extendString:xL,extendUint8Array:bL,extendBuiltins:bj};var Bd={STRAVA_ID:"Njk4NDc=",STRAVA_SECRET:"ZTI3ZGIzYWViYjU3MjM3MGZhZjhiZGMzYWNjMWUwYWFlMDE2ZDYyMg==",STRAVA_TOKEN:"Njc2M2IyOTRmYjg5NDgzNmEzMGFiYjJiYjg5ZTljZWNlYWRiMzBhZQ==",MAPBOX_API_KEY:"cGsuZXlKMUlqb2lhR2R5YVdabU1HNGlMQ0poSWpvaVkyMWxNMlJ6WW5wdE1EWmpZVEpxY0hWbE0ycG9jbW80ZGlKOS41SWo0SjA0M000ZVdnR0t2cWZkQzVB",appVersion:"0.0.0",production:!0};var tu=class a{constructor(){}get stravaClient(){return{id:zd.decode(Bd.STRAVA_ID),secret:zd.decode(Bd.STRAVA_SECRET),token:zd.decode(Bd.STRAVA_TOKEN)}}get mapbox(){return{api_key:zd.decode(Bd.MAPBOX_API_KEY)}}static \u0275fac=function(l){return new(l||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})};var Yn="primary",N_=Symbol("RouteTitle"),rS=class{params;constructor(u){this.params=u||{}}has(u){return Object.prototype.hasOwnProperty.call(this.params,u)}get(u){if(this.has(u)){let l=this.params[u];return Array.isArray(l)?l[0]:l}return null}getAll(u){if(this.has(u)){let l=this.params[u];return Array.isArray(l)?l:[l]}return[]}get keys(){return Object.keys(this.params)}};function jd(a){return new rS(a)}function AL(a,u,l){let m=l.path.split("/");if(m.length>a.length||l.pathMatch==="full"&&(u.hasChildren()||m.length<a.length))return null;let b={};for(let r=0;r<m.length;r++){let M=m[r],k=a[r];if(M[0]===":")b[M.substring(1)]=k;else if(M!==k.path)return null}return{consumed:a.slice(0,m.length),posParams:b}}function Ej(a,u){if(a.length!==u.length)return!1;for(let l=0;l<a.length;++l)if(!Xa(a[l],u[l]))return!1;return!0}function Xa(a,u){let l=a?iS(a):void 0,m=u?iS(u):void 0;if(!l||!m||l.length!=m.length)return!1;let b;for(let r=0;r<l.length;r++)if(b=l[r],!ML(a[b],u[b]))return!1;return!0}function iS(a){return[...Object.keys(a),...Object.getOwnPropertySymbols(a)]}function ML(a,u){if(Array.isArray(a)&&Array.isArray(u)){if(a.length!==u.length)return!1;let l=[...a].sort(),m=[...u].sort();return l.every((b,r)=>m[r]===b)}else return a===u}function RL(a){return a.length>0?a[a.length-1]:null}function Vl(a){return jw(a)?a:n_(a)?yi(Promise.resolve(a)):In(a)}var Tj={exact:OL,subset:LL},PL={exact:Ij,subset:Sj,ignored:()=>!0};function wL(a,u,l){return Tj[l.paths](a.root,u.root,l.matrixParams)&&PL[l.queryParams](a.queryParams,u.queryParams)&&!(l.fragment==="exact"&&a.fragment!==u.fragment)}function Ij(a,u){return Xa(a,u)}function OL(a,u,l){if(!Vd(a.segments,u.segments)||!$x(a.segments,u.segments,l)||a.numberOfChildren!==u.numberOfChildren)return!1;for(let m in u.children)if(!a.children[m]||!OL(a.children[m],u.children[m],l))return!1;return!0}function Sj(a,u){return Object.keys(u).length<=Object.keys(a).length&&Object.keys(u).every(l=>ML(a[l],u[l]))}function LL(a,u,l){return FL(a,u,u.segments,l)}function FL(a,u,l,m){if(a.segments.length>l.length){let b=a.segments.slice(0,l.length);return!(!Vd(b,l)||u.hasChildren()||!$x(b,l,m))}else if(a.segments.length===l.length){if(!Vd(a.segments,l)||!$x(a.segments,l,m))return!1;for(let b in u.children)if(!a.children[b]||!LL(a.children[b],u.children[b],m))return!1;return!0}else{let b=l.slice(0,a.segments.length),r=l.slice(a.segments.length);return!Vd(a.segments,b)||!$x(a.segments,b,m)||!a.children[Yn]?!1:FL(a.children[Yn],u,r,m)}}function $x(a,u,l){return u.every((m,b)=>PL[l](a[b].parameters,m.parameters))}var Ka=class{root;queryParams;fragment;_queryParamMap;constructor(u=new Fr([],{}),l={},m=null){this.root=u,this.queryParams=l,this.fragment=m}get queryParamMap(){return this._queryParamMap??=jd(this.queryParams),this._queryParamMap}toString(){return Aj.serialize(this)}},Fr=class{segments;children;parent=null;constructor(u,l){this.segments=u,this.children=l,Object.values(l).forEach(m=>m.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return Wx(this)}},nu=class{path;parameters;_parameterMap;constructor(u,l){this.path=u,this.parameters=l}get parameterMap(){return this._parameterMap??=jd(this.parameters),this._parameterMap}toString(){return NL(this)}};function Dj(a,u){return Vd(a,u)&&a.every((l,m)=>Xa(l.parameters,u[m].parameters))}function Vd(a,u){return a.length!==u.length?!1:a.every((l,m)=>l.path===u[m].path)}function Cj(a,u){let l=[];return Object.entries(a.children).forEach(([m,b])=>{m===Yn&&(l=l.concat(u(b,m)))}),Object.entries(a.children).forEach(([m,b])=>{m!==Yn&&(l=l.concat(u(b,m)))}),l}var Hd=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>new ru,providedIn:"root"})}return a})(),ru=class{parse(u){let l=new sS(u);return new Ka(l.parseRootSegment(),l.parseQueryParams(),l.parseFragment())}serialize(u){let l=`/${I_(u.root,!0)}`,m=Pj(u.queryParams),b=typeof u.fragment=="string"?`#${Mj(u.fragment)}`:"";return`${l}${m}${b}`}},Aj=new ru;function Wx(a){return a.segments.map(u=>NL(u)).join("/")}function I_(a,u){if(!a.hasChildren())return Wx(a);if(u){let l=a.children[Yn]?I_(a.children[Yn],!1):"",m=[];return Object.entries(a.children).forEach(([b,r])=>{b!==Yn&&m.push(`${b}:${I_(r,!1)}`)}),m.length>0?`${l}(${m.join("//")})`:l}else{let l=Cj(a,(m,b)=>b===Yn?[I_(a.children[Yn],!1)]:[`${b}:${I_(m,!1)}`]);return Object.keys(a.children).length===1&&a.children[Yn]!=null?`${Wx(a)}/${l[0]}`:`${Wx(a)}/(${l.join("//")})`}}function kL(a){return encodeURIComponent(a).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function Hx(a){return kL(a).replace(/%3B/gi,";")}function Mj(a){return encodeURI(a)}function oS(a){return kL(a).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function Zx(a){return decodeURIComponent(a)}function EL(a){return Zx(a.replace(/\+/g,"%20"))}function NL(a){return`${oS(a.path)}${Rj(a.parameters)}`}function Rj(a){return Object.entries(a).map(([u,l])=>`;${oS(u)}=${oS(l)}`).join("")}function Pj(a){let u=Object.entries(a).map(([l,m])=>Array.isArray(m)?m.map(b=>`${Hx(l)}=${Hx(b)}`).join("&"):`${Hx(l)}=${Hx(m)}`).filter(l=>l);return u.length?`?${u.join("&")}`:""}var Oj=/^[^\/()?;#]+/;function QI(a){let u=a.match(Oj);return u?u[0]:""}var Lj=/^[^\/()?;=#]+/;function Fj(a){let u=a.match(Lj);return u?u[0]:""}var kj=/^[^=?&#]+/;function Nj(a){let u=a.match(kj);return u?u[0]:""}var zj=/^[^&#]+/;function Bj(a){let u=a.match(zj);return u?u[0]:""}var sS=class{url;remaining;constructor(u){this.url=u,this.remaining=u}parseRootSegment(){return this.consumeOptional("/"),this.remaining===""||this.peekStartsWith("?")||this.peekStartsWith("#")?new Fr([],{}):new Fr([],this.parseChildren())}parseQueryParams(){let u={};if(this.consumeOptional("?"))do this.parseQueryParam(u);while(this.consumeOptional("&"));return u}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(this.remaining==="")return{};this.consumeOptional("/");let u=[];for(this.peekStartsWith("(")||u.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),u.push(this.parseSegment());let l={};this.peekStartsWith("/(")&&(this.capture("/"),l=this.parseParens(!0));let m={};return this.peekStartsWith("(")&&(m=this.parseParens(!1)),(u.length>0||Object.keys(l).length>0)&&(m[Yn]=new Fr(u,l)),m}parseSegment(){let u=QI(this.remaining);if(u===""&&this.peekStartsWith(";"))throw new en(4009,!1);return this.capture(u),new nu(Zx(u),this.parseMatrixParams())}parseMatrixParams(){let u={};for(;this.consumeOptional(";");)this.parseParam(u);return u}parseParam(u){let l=Fj(this.remaining);if(!l)return;this.capture(l);let m="";if(this.consumeOptional("=")){let b=QI(this.remaining);b&&(m=b,this.capture(m))}u[Zx(l)]=Zx(m)}parseQueryParam(u){let l=Nj(this.remaining);if(!l)return;this.capture(l);let m="";if(this.consumeOptional("=")){let M=Bj(this.remaining);M&&(m=M,this.capture(m))}let b=EL(l),r=EL(m);if(u.hasOwnProperty(b)){let M=u[b];Array.isArray(M)||(M=[M],u[b]=M),M.push(r)}else u[b]=r}parseParens(u){let l={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){let m=QI(this.remaining),b=this.remaining[m.length];if(b!=="/"&&b!==")"&&b!==";")throw new en(4010,!1);let r;m.indexOf(":")>-1?(r=m.slice(0,m.indexOf(":")),this.capture(r),this.capture(":")):u&&(r=Yn);let M=this.parseChildren();l[r]=Object.keys(M).length===1?M[Yn]:new Fr([],M),this.consumeOptional("//")}return l}peekStartsWith(u){return this.remaining.startsWith(u)}consumeOptional(u){return this.peekStartsWith(u)?(this.remaining=this.remaining.substring(u.length),!0):!1}capture(u){if(!this.consumeOptional(u))throw new en(4011,!1)}};function zL(a){return a.segments.length>0?new Fr([],{[Yn]:a}):a}function BL(a){let u={};for(let[m,b]of Object.entries(a.children)){let r=BL(b);if(m===Yn&&r.segments.length===0&&r.hasChildren())for(let[M,k]of Object.entries(r.children))u[M]=k;else(r.segments.length>0||r.hasChildren())&&(u[m]=r)}let l=new Fr(a.segments,u);return Vj(l)}function Vj(a){if(a.numberOfChildren===1&&a.children[Yn]){let u=a.children[Yn];return new Fr(a.segments.concat(u.segments),u.children)}return a}function up(a){return a instanceof Ka}function VL(a,u,l=null,m=null){let b=UL(a);return jL(b,u,l,m)}function UL(a){let u;function l(r){let M={};for(let U of r.children){let ae=l(U);M[U.outlet]=ae}let k=new Fr(r.url,M);return r===a&&(u=k),k}let m=l(a.root),b=zL(m);return u??b}function jL(a,u,l,m){let b=a;for(;b.parent;)b=b.parent;if(u.length===0)return eS(b,b,b,l,m);let r=Uj(u);if(r.toRoot())return eS(b,b,new Fr([],{}),l,m);let M=jj(r,b,a),k=M.processChildren?D_(M.segmentGroup,M.index,r.commands):GL(M.segmentGroup,M.index,r.commands);return eS(b,M.segmentGroup,k,l,m)}function qx(a){return typeof a=="object"&&a!=null&&!a.outlets&&!a.segmentPath}function A_(a){return typeof a=="object"&&a!=null&&a.outlets}function eS(a,u,l,m,b){let r={};m&&Object.entries(m).forEach(([U,ae])=>{r[U]=Array.isArray(ae)?ae.map(Ee=>`${Ee}`):`${ae}`});let M;a===u?M=l:M=HL(a,u,l);let k=zL(BL(M));return new Ka(k,r,b)}function HL(a,u,l){let m={};return Object.entries(a.children).forEach(([b,r])=>{r===u?m[b]=l:m[b]=HL(r,u,l)}),new Fr(a.segments,m)}var Xx=class{isAbsolute;numberOfDoubleDots;commands;constructor(u,l,m){if(this.isAbsolute=u,this.numberOfDoubleDots=l,this.commands=m,u&&m.length>0&&qx(m[0]))throw new en(4003,!1);let b=m.find(A_);if(b&&b!==RL(m))throw new en(4004,!1)}toRoot(){return this.isAbsolute&&this.commands.length===1&&this.commands[0]=="/"}};function Uj(a){if(typeof a[0]=="string"&&a.length===1&&a[0]==="/")return new Xx(!0,0,a);let u=0,l=!1,m=a.reduce((b,r,M)=>{if(typeof r=="object"&&r!=null){if(r.outlets){let k={};return Object.entries(r.outlets).forEach(([U,ae])=>{k[U]=typeof ae=="string"?ae.split("/"):ae}),[...b,{outlets:k}]}if(r.segmentPath)return[...b,r.segmentPath]}return typeof r!="string"?[...b,r]:M===0?(r.split("/").forEach((k,U)=>{U==0&&k==="."||(U==0&&k===""?l=!0:k===".."?u++:k!=""&&b.push(k))}),b):[...b,r]},[]);return new Xx(l,u,m)}var ap=class{segmentGroup;processChildren;index;constructor(u,l,m){this.segmentGroup=u,this.processChildren=l,this.index=m}};function jj(a,u,l){if(a.isAbsolute)return new ap(u,!0,0);if(!l)return new ap(u,!1,NaN);if(l.parent===null)return new ap(l,!0,0);let m=qx(a.commands[0])?0:1,b=l.segments.length-1+m;return Hj(l,b,a.numberOfDoubleDots)}function Hj(a,u,l){let m=a,b=u,r=l;for(;r>b;){if(r-=b,m=m.parent,!m)throw new en(4005,!1);b=m.segments.length}return new ap(m,!1,b-r)}function Gj(a){return A_(a[0])?a[0].outlets:{[Yn]:a}}function GL(a,u,l){if(a??=new Fr([],{}),a.segments.length===0&&a.hasChildren())return D_(a,u,l);let m=$j(a,u,l),b=l.slice(m.commandIndex);if(m.match&&m.pathIndex<a.segments.length){let r=new Fr(a.segments.slice(0,m.pathIndex),{});return r.children[Yn]=new Fr(a.segments.slice(m.pathIndex),a.children),D_(r,0,b)}else return m.match&&b.length===0?new Fr(a.segments,{}):m.match&&!a.hasChildren()?aS(a,u,l):m.match?D_(a,0,b):aS(a,u,l)}function D_(a,u,l){if(l.length===0)return new Fr(a.segments,{});{let m=Gj(l),b={};if(Object.keys(m).some(r=>r!==Yn)&&a.children[Yn]&&a.numberOfChildren===1&&a.children[Yn].segments.length===0){let r=D_(a.children[Yn],u,l);return new Fr(a.segments,r.children)}return Object.entries(m).forEach(([r,M])=>{typeof M=="string"&&(M=[M]),M!==null&&(b[r]=GL(a.children[r],u,M))}),Object.entries(a.children).forEach(([r,M])=>{m[r]===void 0&&(b[r]=M)}),new Fr(a.segments,b)}}function $j(a,u,l){let m=0,b=u,r={match:!1,pathIndex:0,commandIndex:0};for(;b<a.segments.length;){if(m>=l.length)return r;let M=a.segments[b],k=l[m];if(A_(k))break;let U=`${k}`,ae=m<l.length-1?l[m+1]:null;if(b>0&&U===void 0)break;if(U&&ae&&typeof ae=="object"&&ae.outlets===void 0){if(!IL(U,ae,M))return r;m+=2}else{if(!IL(U,{},M))return r;m++}b++}return{match:!0,pathIndex:b,commandIndex:m}}function aS(a,u,l){let m=a.segments.slice(0,u),b=0;for(;b<l.length;){let r=l[b];if(A_(r)){let U=Wj(r.outlets);return new Fr(m,U)}if(b===0&&qx(l[0])){let U=a.segments[u];m.push(new nu(U.path,TL(l[0]))),b++;continue}let M=A_(r)?r.outlets[Yn]:`${r}`,k=b<l.length-1?l[b+1]:null;M&&k&&qx(k)?(m.push(new nu(M,TL(k))),b+=2):(m.push(new nu(M,{})),b++)}return new Fr(m,{})}function Wj(a){let u={};return Object.entries(a).forEach(([l,m])=>{typeof m=="string"&&(m=[m]),m!==null&&(u[l]=aS(new Fr([],{}),0,m))}),u}function TL(a){let u={};return Object.entries(a).forEach(([l,m])=>u[l]=`${m}`),u}function IL(a,u,l){return a==l.path&&Xa(u,l.parameters)}var lp="imperative",Ni=function(a){return a[a.NavigationStart=0]="NavigationStart",a[a.NavigationEnd=1]="NavigationEnd",a[a.NavigationCancel=2]="NavigationCancel",a[a.NavigationError=3]="NavigationError",a[a.RoutesRecognized=4]="RoutesRecognized",a[a.ResolveStart=5]="ResolveStart",a[a.ResolveEnd=6]="ResolveEnd",a[a.GuardsCheckStart=7]="GuardsCheckStart",a[a.GuardsCheckEnd=8]="GuardsCheckEnd",a[a.RouteConfigLoadStart=9]="RouteConfigLoadStart",a[a.RouteConfigLoadEnd=10]="RouteConfigLoadEnd",a[a.ChildActivationStart=11]="ChildActivationStart",a[a.ChildActivationEnd=12]="ChildActivationEnd",a[a.ActivationStart=13]="ActivationStart",a[a.ActivationEnd=14]="ActivationEnd",a[a.Scroll=15]="Scroll",a[a.NavigationSkipped=16]="NavigationSkipped",a}(Ni||{}),xs=class{id;url;constructor(u,l){this.id=u,this.url=l}},iu=class extends xs{type=Ni.NavigationStart;navigationTrigger;restoredState;constructor(u,l,m="imperative",b=null){super(u,l),this.navigationTrigger=m,this.restoredState=b}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}},la=class extends xs{urlAfterRedirects;type=Ni.NavigationEnd;constructor(u,l,m){super(u,l),this.urlAfterRedirects=m}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}},Wo=function(a){return a[a.Redirect=0]="Redirect",a[a.SupersededByNewNavigation=1]="SupersededByNewNavigation",a[a.NoDataFromResolver=2]="NoDataFromResolver",a[a.GuardRejected=3]="GuardRejected",a[a.Aborted=4]="Aborted",a}(Wo||{}),dp=function(a){return a[a.IgnoredSameUrlNavigation=0]="IgnoredSameUrlNavigation",a[a.IgnoredByUrlHandlingStrategy=1]="IgnoredByUrlHandlingStrategy",a}(dp||{}),Ya=class extends xs{reason;code;type=Ni.NavigationCancel;constructor(u,l,m,b){super(u,l),this.reason=m,this.code=b}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}},Ja=class extends xs{reason;code;type=Ni.NavigationSkipped;constructor(u,l,m,b){super(u,l),this.reason=m,this.code=b}},hp=class extends xs{error;target;type=Ni.NavigationError;constructor(u,l,m,b){super(u,l),this.error=m,this.target=b}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}},M_=class extends xs{urlAfterRedirects;state;type=Ni.RoutesRecognized;constructor(u,l,m,b){super(u,l),this.urlAfterRedirects=m,this.state=b}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Yx=class extends xs{urlAfterRedirects;state;type=Ni.GuardsCheckStart;constructor(u,l,m,b){super(u,l),this.urlAfterRedirects=m,this.state=b}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Kx=class extends xs{urlAfterRedirects;state;shouldActivate;type=Ni.GuardsCheckEnd;constructor(u,l,m,b,r){super(u,l),this.urlAfterRedirects=m,this.state=b,this.shouldActivate=r}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}},Jx=class extends xs{urlAfterRedirects;state;type=Ni.ResolveStart;constructor(u,l,m,b){super(u,l),this.urlAfterRedirects=m,this.state=b}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Qx=class extends xs{urlAfterRedirects;state;type=Ni.ResolveEnd;constructor(u,l,m,b){super(u,l),this.urlAfterRedirects=m,this.state=b}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},eb=class{route;type=Ni.RouteConfigLoadStart;constructor(u){this.route=u}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}},tb=class{route;type=Ni.RouteConfigLoadEnd;constructor(u){this.route=u}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}},nb=class{snapshot;type=Ni.ChildActivationStart;constructor(u){this.snapshot=u}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},rb=class{snapshot;type=Ni.ChildActivationEnd;constructor(u){this.snapshot=u}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},ib=class{snapshot;type=Ni.ActivationStart;constructor(u){this.snapshot=u}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},ob=class{snapshot;type=Ni.ActivationEnd;constructor(u){this.snapshot=u}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},fp=class{routerEvent;position;anchor;type=Ni.Scroll;constructor(u,l,m){this.routerEvent=u,this.position=l,this.anchor=m}toString(){let u=this.position?`${this.position[0]}, ${this.position[1]}`:null;return`Scroll(anchor: '${this.anchor}', position: '${u}')`}},R_=class{},pp=class{url;navigationBehaviorOptions;constructor(u,l){this.url=u,this.navigationBehaviorOptions=l}};function Zj(a){return!(a instanceof R_)&&!(a instanceof pp)}function qj(a,u){return a.providers&&!a._injector&&(a._injector=Zf(a.providers,u,`Route: ${a.path}`)),a._injector??u}function aa(a){return a.outlet||Yn}function Xj(a,u){let l=a.filter(m=>aa(m)===u);return l.push(...a.filter(m=>aa(m)!==u)),l}function _p(a){if(!a)return null;if(a.routeConfig?._injector)return a.routeConfig._injector;for(let u=a.parent;u;u=u.parent){let l=u.routeConfig;if(l?._loadedInjector)return l._loadedInjector;if(l?._injector)return l._injector}return null}var sb=class{rootInjector;outlet=null;route=null;children;attachRef=null;get injector(){return _p(this.route?.snapshot)??this.rootInjector}constructor(u){this.rootInjector=u,this.children=new Gd(this.rootInjector)}},Gd=(()=>{class a{rootInjector;contexts=new Map;constructor(l){this.rootInjector=l}onChildOutletCreated(l,m){let b=this.getOrCreateContext(l);b.outlet=m,this.contexts.set(l,b)}onChildOutletDestroyed(l){let m=this.getContext(l);m&&(m.outlet=null,m.attachRef=null)}onOutletDeactivated(){let l=this.contexts;return this.contexts=new Map,l}onOutletReAttached(l){this.contexts=l}getOrCreateContext(l){let m=this.getContext(l);return m||(m=new sb(this.rootInjector),this.contexts.set(l,m)),m}getContext(l){return this.contexts.get(l)||null}static \u0275fac=function(m){return new(m||a)(ln(wi))};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),ab=class{_root;constructor(u){this._root=u}get root(){return this._root.value}parent(u){let l=this.pathFromRoot(u);return l.length>1?l[l.length-2]:null}children(u){let l=lS(u,this._root);return l?l.children.map(m=>m.value):[]}firstChild(u){let l=lS(u,this._root);return l&&l.children.length>0?l.children[0].value:null}siblings(u){let l=cS(u,this._root);return l.length<2?[]:l[l.length-2].children.map(b=>b.value).filter(b=>b!==u)}pathFromRoot(u){return cS(u,this._root).map(l=>l.value)}};function lS(a,u){if(a===u.value)return u;for(let l of u.children){let m=lS(a,l);if(m)return m}return null}function cS(a,u){if(a===u.value)return[u];for(let l of u.children){let m=cS(a,l);if(m.length)return m.unshift(u),m}return[]}var vs=class{value;children;constructor(u,l){this.value=u,this.children=l}toString(){return`TreeNode(${this.value})`}};function sp(a){let u={};return a&&a.children.forEach(l=>u[l.value.outlet]=l),u}var P_=class extends ab{snapshot;constructor(u,l){super(u),this.snapshot=l,_S(this,u)}toString(){return this.snapshot.toString()}};function $L(a){let u=Yj(a),l=new oo([new nu("",{})]),m=new oo({}),b=new oo({}),r=new oo({}),M=new oo(""),k=new ou(l,m,r,M,b,Yn,a,u.root);return k.snapshot=u.root,new P_(new vs(k,[]),u)}function Yj(a){let u={},l={},m={},b="",r=new Ud([],u,m,b,l,Yn,a,null,{});return new O_("",new vs(r,[]))}var ou=class{urlSubject;paramsSubject;queryParamsSubject;fragmentSubject;dataSubject;outlet;component;snapshot;_futureSnapshot;_routerState;_paramMap;_queryParamMap;title;url;params;queryParams;fragment;data;constructor(u,l,m,b,r,M,k,U){this.urlSubject=u,this.paramsSubject=l,this.queryParamsSubject=m,this.fragmentSubject=b,this.dataSubject=r,this.outlet=M,this.component=k,this._futureSnapshot=U,this.title=this.dataSubject?.pipe(or(ae=>ae[N_]))??In(void 0),this.url=u,this.params=l,this.queryParams=m,this.fragment=b,this.data=r}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=this.params.pipe(or(u=>jd(u))),this._paramMap}get queryParamMap(){return this._queryParamMap??=this.queryParams.pipe(or(u=>jd(u))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}};function lb(a,u,l="emptyOnly"){let m,{routeConfig:b}=a;return u!==null&&(l==="always"||b?.path===""||!u.component&&!u.routeConfig?.loadComponent)?m={params:$t($t({},u.params),a.params),data:$t($t({},u.data),a.data),resolve:$t($t($t($t({},a.data),u.data),b?.data),a._resolvedData)}:m={params:$t({},a.params),data:$t({},a.data),resolve:$t($t({},a.data),a._resolvedData??{})},b&&ZL(b)&&(m.resolve[N_]=b.title),m}var Ud=class{url;params;queryParams;fragment;data;outlet;component;routeConfig;_resolve;_resolvedData;_routerState;_paramMap;_queryParamMap;get title(){return this.data?.[N_]}constructor(u,l,m,b,r,M,k,U,ae){this.url=u,this.params=l,this.queryParams=m,this.fragment=b,this.data=r,this.outlet=M,this.component=k,this.routeConfig=U,this._resolve=ae}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=jd(this.params),this._paramMap}get queryParamMap(){return this._queryParamMap??=jd(this.queryParams),this._queryParamMap}toString(){let u=this.url.map(m=>m.toString()).join("/"),l=this.routeConfig?this.routeConfig.path:"";return`Route(url:'${u}', path:'${l}')`}},O_=class extends ab{url;constructor(u,l){super(l),this.url=u,_S(this,l)}toString(){return WL(this._root)}};function _S(a,u){u.value._routerState=a,u.children.forEach(l=>_S(a,l))}function WL(a){let u=a.children.length>0?` { ${a.children.map(WL).join(", ")} } `:"";return`${a.value}${u}`}function tS(a){if(a.snapshot){let u=a.snapshot,l=a._futureSnapshot;a.snapshot=l,Xa(u.queryParams,l.queryParams)||a.queryParamsSubject.next(l.queryParams),u.fragment!==l.fragment&&a.fragmentSubject.next(l.fragment),Xa(u.params,l.params)||a.paramsSubject.next(l.params),Ej(u.url,l.url)||a.urlSubject.next(l.url),Xa(u.data,l.data)||a.dataSubject.next(l.data)}else a.snapshot=a._futureSnapshot,a.dataSubject.next(a._futureSnapshot.data)}function uS(a,u){let l=Xa(a.params,u.params)&&Dj(a.url,u.url),m=!a.parent!=!u.parent;return l&&!m&&(!a.parent||uS(a.parent,u.parent))}function ZL(a){return typeof a.title=="string"||a.title===null}var qL=new Kt(""),z_=(()=>{class a{activated=null;get activatedComponentRef(){return this.activated}_activatedRoute=null;name=Yn;activateEvents=new an;deactivateEvents=new an;attachEvents=new an;detachEvents=new an;routerOutletData=_n(void 0);parentContexts=ut(Gd);location=ut(Od);changeDetector=ut(h_);inputBinder=ut(B_,{optional:!0});supportsBindingToComponentInputs=!0;ngOnChanges(l){if(l.name){let{firstChange:m,previousValue:b}=l.name;if(m)return;this.isTrackedInParentContexts(b)&&(this.deactivate(),this.parentContexts.onChildOutletDestroyed(b)),this.initializeOutletWithName()}}ngOnDestroy(){this.isTrackedInParentContexts(this.name)&&this.parentContexts.onChildOutletDestroyed(this.name),this.inputBinder?.unsubscribeFromRouteData(this)}isTrackedInParentContexts(l){return this.parentContexts.getContext(l)?.outlet===this}ngOnInit(){this.initializeOutletWithName()}initializeOutletWithName(){if(this.parentContexts.onChildOutletCreated(this.name,this),this.activated)return;let l=this.parentContexts.getContext(this.name);l?.route&&(l.attachRef?this.attach(l.attachRef,l.route):this.activateWith(l.route,l.injector))}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new en(4012,!1);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new en(4012,!1);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new en(4012,!1);this.location.detach();let l=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(l.instance),l}attach(l,m){this.activated=l,this._activatedRoute=m,this.location.insert(l.hostView),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.attachEvents.emit(l.instance)}deactivate(){if(this.activated){let l=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(l)}}activateWith(l,m){if(this.isActivated)throw new en(4013,!1);this._activatedRoute=l;let b=this.location,M=l.snapshot.component,k=this.parentContexts.getOrCreateContext(this.name).children,U=new dS(l,k,b.injector,this.routerOutletData);this.activated=b.createComponent(M,{index:b.length,injector:U,environmentInjector:m}),this.changeDetector.markForCheck(),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.activateEvents.emit(this.activated.instance)}static \u0275fac=function(m){return new(m||a)};static \u0275dir=Jg({type:a,selectors:[["router-outlet"]],inputs:{name:"name",routerOutletData:[1,"routerOutletData"]},outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],features:[Pd]})}return a})(),dS=class{route;childContexts;parent;outletData;constructor(u,l,m,b){this.route=u,this.childContexts=l,this.parent=m,this.outletData=b}get(u,l){return u===ou?this.route:u===Gd?this.childContexts:u===qL?this.outletData:this.parent.get(u,l)}},B_=new Kt(""),yS=(()=>{class a{outletDataSubscriptions=new Map;bindActivatedRouteToOutletComponent(l){this.unsubscribeFromRouteData(l),this.subscribeToRouteData(l)}unsubscribeFromRouteData(l){this.outletDataSubscriptions.get(l)?.unsubscribe(),this.outletDataSubscriptions.delete(l)}subscribeToRouteData(l){let{activatedRoute:m}=l,b=Eg([m.queryParams,m.params,m.data]).pipe(Vo(([r,M,k],U)=>(k=$t($t($t({},r),M),k),U===0?In(k):Promise.resolve(k)))).subscribe(r=>{if(!l.isActivated||!l.activatedComponentRef||l.activatedRoute!==m||m.component===null){this.unsubscribeFromRouteData(l);return}let M=EO(m.component);if(!M){this.unsubscribeFromRouteData(l);return}for(let{templateName:k}of M.inputs)l.activatedComponentRef.setInput(k,r[k])});this.outletDataSubscriptions.set(l,b)}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})(),vS=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275cmp=kl({type:a,selectors:[["ng-component"]],exportAs:["emptyRouterOutlet"],decls:1,vars:0,template:function(m,b){m&1&&Xf(0,"router-outlet")},dependencies:[z_],encapsulation:2})}return a})();function xS(a){let u=a.children&&a.children.map(xS),l=u?Vr($t({},a),{children:u}):$t({},a);return!l.component&&!l.loadComponent&&(u||l.loadChildren)&&l.outlet&&l.outlet!==Yn&&(l.component=vS),l}function Kj(a,u,l){let m=L_(a,u._root,l?l._root:void 0);return new P_(m,u)}function L_(a,u,l){if(l&&a.shouldReuseRoute(u.value,l.value.snapshot)){let m=l.value;m._futureSnapshot=u.value;let b=Jj(a,u,l);return new vs(m,b)}else{if(a.shouldAttach(u.value)){let r=a.retrieve(u.value);if(r!==null){let M=r.route;return M.value._futureSnapshot=u.value,M.children=u.children.map(k=>L_(a,k)),M}}let m=Qj(u.value),b=u.children.map(r=>L_(a,r));return new vs(m,b)}}function Jj(a,u,l){return u.children.map(m=>{for(let b of l.children)if(a.shouldReuseRoute(m.value,b.value.snapshot))return L_(a,m,b);return L_(a,m)})}function Qj(a){return new ou(new oo(a.url),new oo(a.params),new oo(a.queryParams),new oo(a.fragment),new oo(a.data),a.outlet,a.component,a)}var mp=class{redirectTo;navigationBehaviorOptions;constructor(u,l){this.redirectTo=u,this.navigationBehaviorOptions=l}},XL="ngNavigationCancelingError";function cb(a,u){let{redirectTo:l,navigationBehaviorOptions:m}=up(u)?{redirectTo:u,navigationBehaviorOptions:void 0}:u,b=YL(!1,Wo.Redirect);return b.url=l,b.navigationBehaviorOptions=m,b}function YL(a,u){let l=new Error(`NavigationCancelingError: ${a||""}`);return l[XL]=!0,l.cancellationCode=u,l}function e6(a){return KL(a)&&up(a.url)}function KL(a){return!!a&&a[XL]}var t6=(a,u,l,m)=>or(b=>(new hS(u,b.targetRouterState,b.currentRouterState,l,m).activate(a),b)),hS=class{routeReuseStrategy;futureState;currState;forwardEvent;inputBindingEnabled;constructor(u,l,m,b,r){this.routeReuseStrategy=u,this.futureState=l,this.currState=m,this.forwardEvent=b,this.inputBindingEnabled=r}activate(u){let l=this.futureState._root,m=this.currState?this.currState._root:null;this.deactivateChildRoutes(l,m,u),tS(this.futureState.root),this.activateChildRoutes(l,m,u)}deactivateChildRoutes(u,l,m){let b=sp(l);u.children.forEach(r=>{let M=r.value.outlet;this.deactivateRoutes(r,b[M],m),delete b[M]}),Object.values(b).forEach(r=>{this.deactivateRouteAndItsChildren(r,m)})}deactivateRoutes(u,l,m){let b=u.value,r=l?l.value:null;if(b===r)if(b.component){let M=m.getContext(b.outlet);M&&this.deactivateChildRoutes(u,l,M.children)}else this.deactivateChildRoutes(u,l,m);else r&&this.deactivateRouteAndItsChildren(l,m)}deactivateRouteAndItsChildren(u,l){u.value.component&&this.routeReuseStrategy.shouldDetach(u.value.snapshot)?this.detachAndStoreRouteSubtree(u,l):this.deactivateRouteAndOutlet(u,l)}detachAndStoreRouteSubtree(u,l){let m=l.getContext(u.value.outlet),b=m&&u.value.component?m.children:l,r=sp(u);for(let M of Object.values(r))this.deactivateRouteAndItsChildren(M,b);if(m&&m.outlet){let M=m.outlet.detach(),k=m.children.onOutletDeactivated();this.routeReuseStrategy.store(u.value.snapshot,{componentRef:M,route:u,contexts:k})}}deactivateRouteAndOutlet(u,l){let m=l.getContext(u.value.outlet),b=m&&u.value.component?m.children:l,r=sp(u);for(let M of Object.values(r))this.deactivateRouteAndItsChildren(M,b);m&&(m.outlet&&(m.outlet.deactivate(),m.children.onOutletDeactivated()),m.attachRef=null,m.route=null)}activateChildRoutes(u,l,m){let b=sp(l);u.children.forEach(r=>{this.activateRoutes(r,b[r.value.outlet],m),this.forwardEvent(new ob(r.value.snapshot))}),u.children.length&&this.forwardEvent(new rb(u.value.snapshot))}activateRoutes(u,l,m){let b=u.value,r=l?l.value:null;if(tS(b),b===r)if(b.component){let M=m.getOrCreateContext(b.outlet);this.activateChildRoutes(u,l,M.children)}else this.activateChildRoutes(u,l,m);else if(b.component){let M=m.getOrCreateContext(b.outlet);if(this.routeReuseStrategy.shouldAttach(b.snapshot)){let k=this.routeReuseStrategy.retrieve(b.snapshot);this.routeReuseStrategy.store(b.snapshot,null),M.children.onOutletReAttached(k.contexts),M.attachRef=k.componentRef,M.route=k.route.value,M.outlet&&M.outlet.attach(k.componentRef,k.route.value),tS(k.route.value),this.activateChildRoutes(u,null,M.children)}else M.attachRef=null,M.route=b,M.outlet&&M.outlet.activateWith(b,M.injector),this.activateChildRoutes(u,null,M.children)}else this.activateChildRoutes(u,null,m)}},ub=class{path;route;constructor(u){this.path=u,this.route=this.path[this.path.length-1]}},cp=class{component;route;constructor(u,l){this.component=u,this.route=l}};function n6(a,u,l){let m=a._root,b=u?u._root:null;return S_(m,b,l,[m.value])}function r6(a){let u=a.routeConfig?a.routeConfig.canActivateChild:null;return!u||u.length===0?null:{node:a,guards:u}}function yp(a,u){let l=Symbol(),m=u.get(a,l);return m===l?typeof a=="function"&&!aE(a)?a:u.get(a):m}function S_(a,u,l,m,b={canDeactivateChecks:[],canActivateChecks:[]}){let r=sp(u);return a.children.forEach(M=>{i6(M,r[M.value.outlet],l,m.concat([M.value]),b),delete r[M.value.outlet]}),Object.entries(r).forEach(([M,k])=>C_(k,l.getContext(M),b)),b}function i6(a,u,l,m,b={canDeactivateChecks:[],canActivateChecks:[]}){let r=a.value,M=u?u.value:null,k=l?l.getContext(a.value.outlet):null;if(M&&r.routeConfig===M.routeConfig){let U=o6(M,r,r.routeConfig.runGuardsAndResolvers);U?b.canActivateChecks.push(new ub(m)):(r.data=M.data,r._resolvedData=M._resolvedData),r.component?S_(a,u,k?k.children:null,m,b):S_(a,u,l,m,b),U&&k&&k.outlet&&k.outlet.isActivated&&b.canDeactivateChecks.push(new cp(k.outlet.component,M))}else M&&C_(u,k,b),b.canActivateChecks.push(new ub(m)),r.component?S_(a,null,k?k.children:null,m,b):S_(a,null,l,m,b);return b}function o6(a,u,l){if(typeof l=="function")return l(a,u);switch(l){case"pathParamsChange":return!Vd(a.url,u.url);case"pathParamsOrQueryParamsChange":return!Vd(a.url,u.url)||!Xa(a.queryParams,u.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!uS(a,u)||!Xa(a.queryParams,u.queryParams);case"paramsChange":default:return!uS(a,u)}}function C_(a,u,l){let m=sp(a),b=a.value;Object.entries(m).forEach(([r,M])=>{b.component?u?C_(M,u.children.getContext(r),l):C_(M,null,l):C_(M,u,l)}),b.component?u&&u.outlet&&u.outlet.isActivated?l.canDeactivateChecks.push(new cp(u.outlet.component,b)):l.canDeactivateChecks.push(new cp(null,b)):l.canDeactivateChecks.push(new cp(null,b))}function V_(a){return typeof a=="function"}function s6(a){return typeof a=="boolean"}function a6(a){return a&&V_(a.canLoad)}function l6(a){return a&&V_(a.canActivate)}function c6(a){return a&&V_(a.canActivateChild)}function u6(a){return a&&V_(a.canDeactivate)}function d6(a){return a&&V_(a.canMatch)}function JL(a){return a instanceof Js||a?.name==="EmptyError"}var Gx=Symbol("INITIAL_VALUE");function gp(){return Vo(a=>Eg(a.map(u=>u.pipe(Sl(1),Ww(Gx)))).pipe(or(u=>{for(let l of u)if(l!==!0){if(l===Gx)return Gx;if(l===!1||h6(l))return l}return!0}),xo(u=>u!==Gx),Sl(1)))}function h6(a){return up(a)||a instanceof mp}function f6(a,u){return bi(l=>{let{targetSnapshot:m,currentSnapshot:b,guards:{canActivateChecks:r,canDeactivateChecks:M}}=l;return M.length===0&&r.length===0?In(Vr($t({},l),{guardsResult:!0})):p6(M,m,b,a).pipe(bi(k=>k&&s6(k)?m6(m,r,a,u):In(k)),or(k=>Vr($t({},l),{guardsResult:k})))})}function p6(a,u,l,m){return yi(a).pipe(bi(b=>x6(b.component,b.route,l,u,m)),Dl(b=>b!==!0,!0))}function m6(a,u,l,m){return yi(u).pipe(Ua(b=>Df(_6(b.route.parent,m),g6(b.route,m),v6(a,b.path,l),y6(a,b.route,l))),Dl(b=>b!==!0,!0))}function g6(a,u){return a!==null&&u&&u(new ib(a)),In(!0)}function _6(a,u){return a!==null&&u&&u(new nb(a)),In(!0)}function y6(a,u,l){let m=u.routeConfig?u.routeConfig.canActivate:null;if(!m||m.length===0)return In(!0);let b=m.map(r=>Tg(()=>{let M=_p(u)??l,k=yp(r,M),U=l6(k)?k.canActivate(u,a):Xi(M,()=>k(u,a));return Vl(U).pipe(Dl())}));return In(b).pipe(gp())}function v6(a,u,l){let m=u[u.length-1],r=u.slice(0,u.length-1).reverse().map(M=>r6(M)).filter(M=>M!==null).map(M=>Tg(()=>{let k=M.guards.map(U=>{let ae=_p(M.node)??l,Ee=yp(U,ae),Be=c6(Ee)?Ee.canActivateChild(m,a):Xi(ae,()=>Ee(m,a));return Vl(Be).pipe(Dl())});return In(k).pipe(gp())}));return In(r).pipe(gp())}function x6(a,u,l,m,b){let r=u&&u.routeConfig?u.routeConfig.canDeactivate:null;if(!r||r.length===0)return In(!0);let M=r.map(k=>{let U=_p(u)??b,ae=yp(k,U),Ee=u6(ae)?ae.canDeactivate(a,u,l,m):Xi(U,()=>ae(a,u,l,m));return Vl(Ee).pipe(Dl())});return In(M).pipe(gp())}function b6(a,u,l,m){let b=u.canLoad;if(b===void 0||b.length===0)return In(!0);let r=b.map(M=>{let k=yp(M,a),U=a6(k)?k.canLoad(u,l):Xi(a,()=>k(u,l));return Vl(U)});return In(r).pipe(gp(),QL(m))}function QL(a){return zw(Wi(u=>{if(typeof u!="boolean")throw cb(a,u)}),or(u=>u===!0))}function w6(a,u,l,m){let b=u.canMatch;if(!b||b.length===0)return In(!0);let r=b.map(M=>{let k=yp(M,a),U=d6(k)?k.canMatch(u,l):Xi(a,()=>k(u,l));return Vl(U)});return In(r).pipe(gp(),QL(m))}var F_=class{segmentGroup;constructor(u){this.segmentGroup=u||null}},k_=class extends Error{urlTree;constructor(u){super(),this.urlTree=u}};function op(a){return If(new F_(a))}function E6(a){return If(new en(4e3,!1))}function T6(a){return If(YL(!1,Wo.GuardRejected))}var fS=class{urlSerializer;urlTree;constructor(u,l){this.urlSerializer=u,this.urlTree=l}lineralizeSegments(u,l){let m=[],b=l.root;for(;;){if(m=m.concat(b.segments),b.numberOfChildren===0)return In(m);if(b.numberOfChildren>1||!b.children[Yn])return E6(`${u.redirectTo}`);b=b.children[Yn]}}applyRedirectCommands(u,l,m,b,r){return I6(l,b,r).pipe(or(M=>{if(M instanceof Ka)throw new k_(M);let k=this.applyRedirectCreateUrlTree(M,this.urlSerializer.parse(M),u,m);if(M[0]==="/")throw new k_(k);return k}))}applyRedirectCreateUrlTree(u,l,m,b){let r=this.createSegmentGroup(u,l.root,m,b);return new Ka(r,this.createQueryParams(l.queryParams,this.urlTree.queryParams),l.fragment)}createQueryParams(u,l){let m={};return Object.entries(u).forEach(([b,r])=>{if(typeof r=="string"&&r[0]===":"){let k=r.substring(1);m[b]=l[k]}else m[b]=r}),m}createSegmentGroup(u,l,m,b){let r=this.createSegments(u,l.segments,m,b),M={};return Object.entries(l.children).forEach(([k,U])=>{M[k]=this.createSegmentGroup(u,U,m,b)}),new Fr(r,M)}createSegments(u,l,m,b){return l.map(r=>r.path[0]===":"?this.findPosParam(u,r,b):this.findOrReturn(r,m))}findPosParam(u,l,m){let b=m[l.path.substring(1)];if(!b)throw new en(4001,!1);return b}findOrReturn(u,l){let m=0;for(let b of l){if(b.path===u.path)return l.splice(m),b;m++}return u}};function I6(a,u,l){if(typeof a=="string")return In(a);let m=a,{queryParams:b,fragment:r,routeConfig:M,url:k,outlet:U,params:ae,data:Ee,title:Be}=u;return Vl(Xi(l,()=>m({params:ae,data:Ee,queryParams:b,fragment:r,routeConfig:M,url:k,outlet:U,title:Be})))}var pS={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function S6(a,u,l,m,b){let r=eF(a,u,l);return r.matched?(m=qj(u,m),w6(m,u,l,b).pipe(or(M=>M===!0?r:$t({},pS)))):In(r)}function eF(a,u,l){if(u.path==="**")return D6(l);if(u.path==="")return u.pathMatch==="full"&&(a.hasChildren()||l.length>0)?$t({},pS):{matched:!0,consumedSegments:[],remainingSegments:l,parameters:{},positionalParamSegments:{}};let b=(u.matcher||AL)(l,a,u);if(!b)return $t({},pS);let r={};Object.entries(b.posParams??{}).forEach(([k,U])=>{r[k]=U.path});let M=b.consumed.length>0?$t($t({},r),b.consumed[b.consumed.length-1].parameters):r;return{matched:!0,consumedSegments:b.consumed,remainingSegments:l.slice(b.consumed.length),parameters:M,positionalParamSegments:b.posParams??{}}}function D6(a){return{matched:!0,parameters:a.length>0?RL(a).parameters:{},consumedSegments:a,remainingSegments:[],positionalParamSegments:{}}}function SL(a,u,l,m){return l.length>0&&M6(a,l,m)?{segmentGroup:new Fr(u,A6(m,new Fr(l,a.children))),slicedSegments:[]}:l.length===0&&R6(a,l,m)?{segmentGroup:new Fr(a.segments,C6(a,l,m,a.children)),slicedSegments:l}:{segmentGroup:new Fr(a.segments,a.children),slicedSegments:l}}function C6(a,u,l,m){let b={};for(let r of l)if(hb(a,u,r)&&!m[aa(r)]){let M=new Fr([],{});b[aa(r)]=M}return $t($t({},m),b)}function A6(a,u){let l={};l[Yn]=u;for(let m of a)if(m.path===""&&aa(m)!==Yn){let b=new Fr([],{});l[aa(m)]=b}return l}function M6(a,u,l){return l.some(m=>hb(a,u,m)&&aa(m)!==Yn)}function R6(a,u,l){return l.some(m=>hb(a,u,m))}function hb(a,u,l){return(a.hasChildren()||u.length>0)&&l.pathMatch==="full"?!1:l.path===""}function P6(a,u,l){return u.length===0&&!a.children[l]}var mS=class{};function O6(a,u,l,m,b,r,M="emptyOnly"){return new gS(a,u,l,m,b,M,r).recognize()}var L6=31,gS=class{injector;configLoader;rootComponentType;config;urlTree;paramsInheritanceStrategy;urlSerializer;applyRedirects;absoluteRedirectCount=0;allowRedirects=!0;constructor(u,l,m,b,r,M,k){this.injector=u,this.configLoader=l,this.rootComponentType=m,this.config=b,this.urlTree=r,this.paramsInheritanceStrategy=M,this.urlSerializer=k,this.applyRedirects=new fS(this.urlSerializer,this.urlTree)}noMatchError(u){return new en(4002,`'${u.segmentGroup}'`)}recognize(){let u=SL(this.urlTree.root,[],[],this.config).segmentGroup;return this.match(u).pipe(or(({children:l,rootSnapshot:m})=>{let b=new vs(m,l),r=new O_("",b),M=VL(m,[],this.urlTree.queryParams,this.urlTree.fragment);return M.queryParams=this.urlTree.queryParams,r.url=this.urlSerializer.serialize(M),{state:r,tree:M}}))}match(u){let l=new Ud([],Object.freeze({}),Object.freeze($t({},this.urlTree.queryParams)),this.urlTree.fragment,Object.freeze({}),Yn,this.rootComponentType,null,{});return this.processSegmentGroup(this.injector,this.config,u,Yn,l).pipe(or(m=>({children:m,rootSnapshot:l})),Il(m=>{if(m instanceof k_)return this.urlTree=m.urlTree,this.match(m.urlTree.root);throw m instanceof F_?this.noMatchError(m):m}))}processSegmentGroup(u,l,m,b,r){return m.segments.length===0&&m.hasChildren()?this.processChildren(u,l,m,r):this.processSegment(u,l,m,m.segments,b,!0,r).pipe(or(M=>M instanceof vs?[M]:[]))}processChildren(u,l,m,b){let r=[];for(let M of Object.keys(m.children))M==="primary"?r.unshift(M):r.push(M);return yi(r).pipe(Ua(M=>{let k=m.children[M],U=Xj(l,M);return this.processSegmentGroup(u,U,k,M,b)}),$w((M,k)=>(M.push(...k),M)),Vc(null),Gw(),bi(M=>{if(M===null)return op(m);let k=tF(M);return F6(k),In(k)}))}processSegment(u,l,m,b,r,M,k){return yi(l).pipe(Ua(U=>this.processSegmentAgainstRoute(U._injector??u,l,U,m,b,r,M,k).pipe(Il(ae=>{if(ae instanceof F_)return In(null);throw ae}))),Dl(U=>!!U),Il(U=>{if(JL(U))return P6(m,b,r)?In(new mS):op(m);throw U}))}processSegmentAgainstRoute(u,l,m,b,r,M,k,U){return aa(m)!==M&&(M===Yn||!hb(b,r,m))?op(b):m.redirectTo===void 0?this.matchSegmentAgainstRoute(u,b,m,r,M,U):this.allowRedirects&&k?this.expandSegmentAgainstRouteUsingRedirect(u,b,l,m,r,M,U):op(b)}expandSegmentAgainstRouteUsingRedirect(u,l,m,b,r,M,k){let{matched:U,parameters:ae,consumedSegments:Ee,positionalParamSegments:Be,remainingSegments:ht}=eF(l,b,r);if(!U)return op(l);typeof b.redirectTo=="string"&&b.redirectTo[0]==="/"&&(this.absoluteRedirectCount++,this.absoluteRedirectCount>L6&&(this.allowRedirects=!1));let Oe=new Ud(r,ae,Object.freeze($t({},this.urlTree.queryParams)),this.urlTree.fragment,DL(b),aa(b),b.component??b._loadedComponent??null,b,CL(b)),Ct=lb(Oe,k,this.paramsInheritanceStrategy);return Oe.params=Object.freeze(Ct.params),Oe.data=Object.freeze(Ct.data),this.applyRedirects.applyRedirectCommands(Ee,b.redirectTo,Be,Oe,u).pipe(Vo(Ut=>this.applyRedirects.lineralizeSegments(b,Ut)),bi(Ut=>this.processSegment(u,m,l,Ut.concat(ht),M,!1,k)))}matchSegmentAgainstRoute(u,l,m,b,r,M){let k=S6(l,m,b,u,this.urlSerializer);return m.path==="**"&&(l.children={}),k.pipe(Vo(U=>U.matched?(u=m._injector??u,this.getChildConfig(u,m,b).pipe(Vo(({routes:ae})=>{let Ee=m._loadedInjector??u,{parameters:Be,consumedSegments:ht,remainingSegments:Oe}=U,Ct=new Ud(ht,Be,Object.freeze($t({},this.urlTree.queryParams)),this.urlTree.fragment,DL(m),aa(m),m.component??m._loadedComponent??null,m,CL(m)),Vt=lb(Ct,M,this.paramsInheritanceStrategy);Ct.params=Object.freeze(Vt.params),Ct.data=Object.freeze(Vt.data);let{segmentGroup:Ut,slicedSegments:Nt}=SL(l,ht,Oe,ae);if(Nt.length===0&&Ut.hasChildren())return this.processChildren(Ee,ae,Ut,Ct).pipe(or(ci=>new vs(Ct,ci)));if(ae.length===0&&Nt.length===0)return In(new vs(Ct,[]));let li=aa(m)===r;return this.processSegment(Ee,ae,Ut,Nt,li?Yn:r,!0,Ct).pipe(or(ci=>new vs(Ct,ci instanceof vs?[ci]:[])))}))):op(l)))}getChildConfig(u,l,m){return l.children?In({routes:l.children,injector:u}):l.loadChildren?l._loadedRoutes!==void 0?In({routes:l._loadedRoutes,injector:l._loadedInjector}):b6(u,l,m,this.urlSerializer).pipe(bi(b=>b?this.configLoader.loadChildren(u,l).pipe(Wi(r=>{l._loadedRoutes=r.routes,l._loadedInjector=r.injector})):T6(l))):In({routes:[],injector:u})}};function F6(a){a.sort((u,l)=>u.value.outlet===Yn?-1:l.value.outlet===Yn?1:u.value.outlet.localeCompare(l.value.outlet))}function k6(a){let u=a.value.routeConfig;return u&&u.path===""}function tF(a){let u=[],l=new Set;for(let m of a){if(!k6(m)){u.push(m);continue}let b=u.find(r=>m.value.routeConfig===r.value.routeConfig);b!==void 0?(b.children.push(...m.children),l.add(b)):u.push(m)}for(let m of l){let b=tF(m.children);u.push(new vs(m.value,b))}return u.filter(m=>!l.has(m))}function DL(a){return a.data||{}}function CL(a){return a.resolve||{}}function N6(a,u,l,m,b,r){return bi(M=>O6(a,u,l,m,M.extractedUrl,b,r).pipe(or(({state:k,tree:U})=>Vr($t({},M),{targetSnapshot:k,urlAfterRedirects:U}))))}function z6(a,u){return bi(l=>{let{targetSnapshot:m,guards:{canActivateChecks:b}}=l;if(!b.length)return In(l);let r=new Set(b.map(U=>U.route)),M=new Set;for(let U of r)if(!M.has(U))for(let ae of nF(U))M.add(ae);let k=0;return yi(M).pipe(Ua(U=>r.has(U)?B6(U,m,a,u):(U.data=lb(U,U.parent,a).resolve,In(void 0))),Wi(()=>k++),Cf(1),bi(U=>k===M.size?In(l):rs))})}function nF(a){let u=a.children.map(l=>nF(l)).flat();return[a,...u]}function B6(a,u,l,m){let b=a.routeConfig,r=a._resolve;return b?.title!==void 0&&!ZL(b)&&(r[N_]=b.title),Tg(()=>(a.data=lb(a,a.parent,l).resolve,V6(r,a,u,m).pipe(or(M=>(a._resolvedData=M,a.data=$t($t({},a.data),M),null)))))}function V6(a,u,l,m){let b=iS(a);if(b.length===0)return In({});let r={};return yi(b).pipe(bi(M=>U6(a[M],u,l,m).pipe(Dl(),Wi(k=>{if(k instanceof mp)throw cb(new ru,k);r[M]=k}))),Cf(1),or(()=>r),Il(M=>JL(M)?rs:If(M)))}function U6(a,u,l,m){let b=_p(u)??m,r=yp(a,b),M=r.resolve?r.resolve(u,l):Xi(b,()=>r(u,l));return Vl(M)}function nS(a){return Vo(u=>{let l=a(u);return l?yi(l).pipe(or(()=>u)):In(u)})}var bS=(()=>{class a{buildTitle(l){let m,b=l.root;for(;b!==void 0;)m=this.getResolvedTitleForRoute(b)??m,b=b.children.find(r=>r.outlet===Yn);return m}getResolvedTitleForRoute(l){return l.data[N_]}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>ut(rF),providedIn:"root"})}return a})(),rF=(()=>{class a extends bS{title;constructor(l){super(),this.title=l}updateTitle(l){let m=this.buildTitle(l);m!==void 0&&this.title.setTitle(m)}static \u0275fac=function(m){return new(m||a)(ln(eL))};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),$d=new Kt("",{providedIn:"root",factory:()=>({})}),vp=new Kt(""),fb=(()=>{class a{componentLoaders=new WeakMap;childrenLoaders=new WeakMap;onLoadStartListener;onLoadEndListener;compiler=ut(yI);loadComponent(l,m){if(this.componentLoaders.get(m))return this.componentLoaders.get(m);if(m._loadedComponent)return In(m._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(m);let b=Vl(Xi(l,()=>m.loadComponent())).pipe(or(oF),Wi(M=>{this.onLoadEndListener&&this.onLoadEndListener(m),m._loadedComponent=M}),Uc(()=>{this.componentLoaders.delete(m)})),r=new Ef(b,()=>new Ai).pipe(wf());return this.componentLoaders.set(m,r),r}loadChildren(l,m){if(this.childrenLoaders.get(m))return this.childrenLoaders.get(m);if(m._loadedRoutes)return In({routes:m._loadedRoutes,injector:m._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(m);let r=iF(m,this.compiler,l,this.onLoadEndListener).pipe(Uc(()=>{this.childrenLoaders.delete(m)})),M=new Ef(r,()=>new Ai).pipe(wf());return this.childrenLoaders.set(m,M),M}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function iF(a,u,l,m){return Vl(Xi(l,()=>a.loadChildren())).pipe(or(oF),bi(b=>b instanceof vx||Array.isArray(b)?In(b):yi(u.compileModuleAsync(b))),or(b=>{m&&m(a);let r,M,k=!1;return Array.isArray(b)?(M=b,k=!0):(r=b.create(l).injector,M=r.get(vp,[],{optional:!0,self:!0}).flat()),{routes:M.map(xS),injector:r}}))}function j6(a){return a&&typeof a=="object"&&"default"in a}function oF(a){return j6(a)?a.default:a}var pb=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>ut(H6),providedIn:"root"})}return a})(),H6=(()=>{class a{shouldProcessUrl(l){return!0}extract(l){return l}merge(l,m){return l}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),wS=new Kt(""),ES=new Kt("");function sF(a,u,l){let m=a.get(ES),b=a.get(di);if(!b.startViewTransition||m.skipNextTransition)return m.skipNextTransition=!1,new Promise(ae=>setTimeout(ae));let r,M=new Promise(ae=>{r=ae}),k=b.startViewTransition(()=>(r(),G6(a)));k.ready.catch(ae=>{});let{onViewTransitionCreated:U}=m;return U&&Xi(a,()=>U({transition:k,from:u,to:l})),M}function G6(a){return new Promise(u=>{Qg({read:()=>setTimeout(u)},{injector:a})})}var TS=new Kt(""),mb=(()=>{class a{currentNavigation=null;currentTransition=null;lastSuccessfulNavigation=null;events=new Ai;transitionAbortWithErrorSubject=new Ai;configLoader=ut(fb);environmentInjector=ut(wi);destroyRef=ut(Ga);urlSerializer=ut(Hd);rootContexts=ut(Gd);location=ut(eu);inputBindingEnabled=ut(B_,{optional:!0})!==null;titleStrategy=ut(bS);options=ut($d,{optional:!0})||{};paramsInheritanceStrategy=this.options.paramsInheritanceStrategy||"emptyOnly";urlHandlingStrategy=ut(pb);createViewTransition=ut(wS,{optional:!0});navigationErrorHandler=ut(TS,{optional:!0});navigationId=0;get hasRequestedNavigation(){return this.navigationId!==0}transitions;afterPreactivation=()=>In(void 0);rootComponentType=null;destroyed=!1;constructor(){let l=b=>this.events.next(new eb(b)),m=b=>this.events.next(new tb(b));this.configLoader.onLoadEndListener=m,this.configLoader.onLoadStartListener=l,this.destroyRef.onDestroy(()=>{this.destroyed=!0})}complete(){this.transitions?.complete()}handleNavigationRequest(l){let m=++this.navigationId;this.transitions?.next(Vr($t({},l),{extractedUrl:this.urlHandlingStrategy.extract(l.rawUrl),targetSnapshot:null,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null,abortController:new AbortController,id:m}))}setupNavigations(l){return this.transitions=new oo(null),this.transitions.pipe(xo(m=>m!==null),Vo(m=>{let b=!1;return In(m).pipe(Vo(r=>{if(this.navigationId>m.id)return this.cancelNavigationTransition(m,"",Wo.SupersededByNewNavigation),rs;this.currentTransition=m,this.currentNavigation={id:r.id,initialUrl:r.rawUrl,extractedUrl:r.extractedUrl,targetBrowserUrl:typeof r.extras.browserUrl=="string"?this.urlSerializer.parse(r.extras.browserUrl):r.extras.browserUrl,trigger:r.source,extras:r.extras,previousNavigation:this.lastSuccessfulNavigation?Vr($t({},this.lastSuccessfulNavigation),{previousNavigation:null}):null,abort:()=>r.abortController.abort()};let M=!l.navigated||this.isUpdatingInternalState()||this.isUpdatedBrowserUrl(),k=r.extras.onSameUrlNavigation??l.onSameUrlNavigation;if(!M&&k!=="reload"){let U="";return this.events.next(new Ja(r.id,this.urlSerializer.serialize(r.rawUrl),U,dp.IgnoredSameUrlNavigation)),r.resolve(!1),rs}if(this.urlHandlingStrategy.shouldProcessUrl(r.rawUrl))return In(r).pipe(Vo(U=>(this.events.next(new iu(U.id,this.urlSerializer.serialize(U.extractedUrl),U.source,U.restoredState)),U.id!==this.navigationId?rs:Promise.resolve(U))),N6(this.environmentInjector,this.configLoader,this.rootComponentType,l.config,this.urlSerializer,this.paramsInheritanceStrategy),Wi(U=>{m.targetSnapshot=U.targetSnapshot,m.urlAfterRedirects=U.urlAfterRedirects,this.currentNavigation=Vr($t({},this.currentNavigation),{finalUrl:U.urlAfterRedirects});let ae=new M_(U.id,this.urlSerializer.serialize(U.extractedUrl),this.urlSerializer.serialize(U.urlAfterRedirects),U.targetSnapshot);this.events.next(ae)}));if(M&&this.urlHandlingStrategy.shouldProcessUrl(r.currentRawUrl)){let{id:U,extractedUrl:ae,source:Ee,restoredState:Be,extras:ht}=r,Oe=new iu(U,this.urlSerializer.serialize(ae),Ee,Be);this.events.next(Oe);let Ct=$L(this.rootComponentType).snapshot;return this.currentTransition=m=Vr($t({},r),{targetSnapshot:Ct,urlAfterRedirects:ae,extras:Vr($t({},ht),{skipLocationChange:!1,replaceUrl:!1})}),this.currentNavigation.finalUrl=ae,In(m)}else{let U="";return this.events.next(new Ja(r.id,this.urlSerializer.serialize(r.extractedUrl),U,dp.IgnoredByUrlHandlingStrategy)),r.resolve(!1),rs}}),Wi(r=>{let M=new Yx(r.id,this.urlSerializer.serialize(r.extractedUrl),this.urlSerializer.serialize(r.urlAfterRedirects),r.targetSnapshot);this.events.next(M)}),or(r=>(this.currentTransition=m=Vr($t({},r),{guards:n6(r.targetSnapshot,r.currentSnapshot,this.rootContexts)}),m)),f6(this.environmentInjector,r=>this.events.next(r)),Wi(r=>{if(m.guardsResult=r.guardsResult,r.guardsResult&&typeof r.guardsResult!="boolean")throw cb(this.urlSerializer,r.guardsResult);let M=new Kx(r.id,this.urlSerializer.serialize(r.extractedUrl),this.urlSerializer.serialize(r.urlAfterRedirects),r.targetSnapshot,!!r.guardsResult);this.events.next(M)}),xo(r=>r.guardsResult?!0:(this.cancelNavigationTransition(r,"",Wo.GuardRejected),!1)),nS(r=>{if(r.guards.canActivateChecks.length!==0)return In(r).pipe(Wi(M=>{let k=new Jx(M.id,this.urlSerializer.serialize(M.extractedUrl),this.urlSerializer.serialize(M.urlAfterRedirects),M.targetSnapshot);this.events.next(k)}),Vo(M=>{let k=!1;return In(M).pipe(z6(this.paramsInheritanceStrategy,this.environmentInjector),Wi({next:()=>k=!0,complete:()=>{k||this.cancelNavigationTransition(M,"",Wo.NoDataFromResolver)}}))}),Wi(M=>{let k=new Qx(M.id,this.urlSerializer.serialize(M.extractedUrl),this.urlSerializer.serialize(M.urlAfterRedirects),M.targetSnapshot);this.events.next(k)}))}),nS(r=>{let M=k=>{let U=[];if(k.routeConfig?.loadComponent&&!k.routeConfig._loadedComponent){let ae=_p(k)??this.environmentInjector;U.push(this.configLoader.loadComponent(ae,k.routeConfig).pipe(Wi(Ee=>{k.component=Ee}),or(()=>{})))}for(let ae of k.children)U.push(...M(ae));return U};return Eg(M(r.targetSnapshot.root)).pipe(Vc(null),Sl(1))}),nS(()=>this.afterPreactivation()),Vo(()=>{let{currentSnapshot:r,targetSnapshot:M}=m,k=this.createViewTransition?.(this.environmentInjector,r.root,M.root);return k?yi(k).pipe(or(()=>m)):In(m)}),or(r=>{let M=Kj(l.routeReuseStrategy,r.targetSnapshot,r.currentRouterState);return this.currentTransition=m=Vr($t({},r),{targetRouterState:M}),this.currentNavigation.targetRouterState=M,m}),Wi(()=>{this.events.next(new R_)}),t6(this.rootContexts,l.routeReuseStrategy,r=>this.events.next(r),this.inputBindingEnabled),Sl(1),y0(new br(r=>{let M=m.abortController.signal,k=()=>r.next();return M.addEventListener("abort",k),()=>M.removeEventListener("abort",k)}).pipe(xo(()=>!b&&!m.targetRouterState),Wi(()=>{this.cancelNavigationTransition(m,m.abortController.signal.reason+"",Wo.Aborted)}))),Wi({next:r=>{b=!0,this.lastSuccessfulNavigation=this.currentNavigation,this.events.next(new la(r.id,this.urlSerializer.serialize(r.extractedUrl),this.urlSerializer.serialize(r.urlAfterRedirects))),this.titleStrategy?.updateTitle(r.targetRouterState.snapshot),r.resolve(!0)},complete:()=>{b=!0}}),y0(this.transitionAbortWithErrorSubject.pipe(Wi(r=>{throw r}))),Uc(()=>{b||this.cancelNavigationTransition(m,"",Wo.SupersededByNewNavigation),this.currentTransition?.id===m.id&&(this.currentNavigation=null,this.currentTransition=null)}),Il(r=>{if(this.destroyed)return m.resolve(!1),rs;if(b=!0,KL(r))this.events.next(new Ya(m.id,this.urlSerializer.serialize(m.extractedUrl),r.message,r.cancellationCode)),e6(r)?this.events.next(new pp(r.url,r.navigationBehaviorOptions)):m.resolve(!1);else{let M=new hp(m.id,this.urlSerializer.serialize(m.extractedUrl),r,m.targetSnapshot??void 0);try{let k=Xi(this.environmentInjector,()=>this.navigationErrorHandler?.(M));if(k instanceof mp){let{message:U,cancellationCode:ae}=cb(this.urlSerializer,k);this.events.next(new Ya(m.id,this.urlSerializer.serialize(m.extractedUrl),U,ae)),this.events.next(new pp(k.redirectTo,k.navigationBehaviorOptions))}else throw this.events.next(M),r}catch(k){this.options.resolveNavigationPromiseOnError?m.resolve(!1):m.reject(k)}}return rs}))}))}cancelNavigationTransition(l,m,b){let r=new Ya(l.id,this.urlSerializer.serialize(l.extractedUrl),m,b);this.events.next(r),l.resolve(!1)}isUpdatingInternalState(){return this.currentTransition?.extractedUrl.toString()!==this.currentTransition?.currentUrlTree.toString()}isUpdatedBrowserUrl(){let l=this.urlHandlingStrategy.extract(this.urlSerializer.parse(this.location.path(!0))),m=this.currentNavigation?.targetBrowserUrl??this.currentNavigation?.extractedUrl;return l.toString()!==m?.toString()&&!this.currentNavigation?.extras.skipLocationChange}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function $6(a){return a!==lp}var aF=(()=>{class a{static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>ut(W6),providedIn:"root"})}return a})(),db=class{shouldDetach(u){return!1}store(u,l){}shouldAttach(u){return!1}retrieve(u){return null}shouldReuseRoute(u,l){return u.routeConfig===l.routeConfig}},W6=(()=>{class a extends db{static \u0275fac=(()=>{let l;return function(b){return(l||(l=cx(a)))(b||a)}})();static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),lF=(()=>{class a{urlSerializer=ut(Hd);options=ut($d,{optional:!0})||{};canceledNavigationResolution=this.options.canceledNavigationResolution||"replace";location=ut(eu);urlHandlingStrategy=ut(pb);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";currentUrlTree=new Ka;getCurrentUrlTree(){return this.currentUrlTree}rawUrlTree=this.currentUrlTree;getRawUrlTree(){return this.rawUrlTree}createBrowserPath({finalUrl:l,initialUrl:m,targetBrowserUrl:b}){let r=l!==void 0?this.urlHandlingStrategy.merge(l,m):m,M=b??r;return M instanceof Ka?this.urlSerializer.serialize(M):M}commitTransition({targetRouterState:l,finalUrl:m,initialUrl:b}){m&&l?(this.currentUrlTree=m,this.rawUrlTree=this.urlHandlingStrategy.merge(m,b),this.routerState=l):this.rawUrlTree=b}routerState=$L(null);getRouterState(){return this.routerState}stateMemento=this.createStateMemento();updateStateMemento(){this.stateMemento=this.createStateMemento()}createStateMemento(){return{rawUrlTree:this.rawUrlTree,currentUrlTree:this.currentUrlTree,routerState:this.routerState}}resetInternalState({finalUrl:l}){this.routerState=this.stateMemento.routerState,this.currentUrlTree=this.stateMemento.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,l??this.rawUrlTree)}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:()=>ut(Z6),providedIn:"root"})}return a})(),Z6=(()=>{class a extends lF{currentPageId=0;lastSuccessfulId=-1;restoredState(){return this.location.getState()}get browserPageId(){return this.canceledNavigationResolution!=="computed"?this.currentPageId:this.restoredState()?.\u0275routerPageId??this.currentPageId}registerNonRouterCurrentEntryChangeListener(l){return this.location.subscribe(m=>{m.type==="popstate"&&setTimeout(()=>{l(m.url,m.state,"popstate")})})}handleRouterEvent(l,m){l instanceof iu?this.updateStateMemento():l instanceof Ja?this.commitTransition(m):l instanceof M_?this.urlUpdateStrategy==="eager"&&(m.extras.skipLocationChange||this.setBrowserUrl(this.createBrowserPath(m),m)):l instanceof R_?(this.commitTransition(m),this.urlUpdateStrategy==="deferred"&&!m.extras.skipLocationChange&&this.setBrowserUrl(this.createBrowserPath(m),m)):l instanceof Ya&&l.code!==Wo.SupersededByNewNavigation&&l.code!==Wo.Redirect?this.restoreHistory(m):l instanceof hp?this.restoreHistory(m,!0):l instanceof la&&(this.lastSuccessfulId=l.id,this.currentPageId=this.browserPageId)}setBrowserUrl(l,{extras:m,id:b}){let{replaceUrl:r,state:M}=m;if(this.location.isCurrentPathEqualTo(l)||r){let k=this.browserPageId,U=$t($t({},M),this.generateNgRouterState(b,k));this.location.replaceState(l,"",U)}else{let k=$t($t({},M),this.generateNgRouterState(b,this.browserPageId+1));this.location.go(l,"",k)}}restoreHistory(l,m=!1){if(this.canceledNavigationResolution==="computed"){let b=this.browserPageId,r=this.currentPageId-b;r!==0?this.location.historyGo(r):this.getCurrentUrlTree()===l.finalUrl&&r===0&&(this.resetInternalState(l),this.resetUrlToCurrentUrlTree())}else this.canceledNavigationResolution==="replace"&&(m&&this.resetInternalState(l),this.resetUrlToCurrentUrlTree())}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.getRawUrlTree()),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}generateNgRouterState(l,m){return this.canceledNavigationResolution==="computed"?{navigationId:l,\u0275routerPageId:m}:{navigationId:l}}static \u0275fac=(()=>{let l;return function(b){return(l||(l=cx(a)))(b||a)}})();static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function gb(a,u){a.events.pipe(xo(l=>l instanceof la||l instanceof Ya||l instanceof hp||l instanceof Ja),or(l=>l instanceof la||l instanceof Ja?0:(l instanceof Ya?l.code===Wo.Redirect||l.code===Wo.SupersededByNewNavigation:!1)?2:1),xo(l=>l!==2),Sl(1)).subscribe(()=>{u()})}var q6={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},X6={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"},su=(()=>{class a{get currentUrlTree(){return this.stateManager.getCurrentUrlTree()}get rawUrlTree(){return this.stateManager.getRawUrlTree()}disposed=!1;nonRouterCurrentEntryChangeSubscription;console=ut(lI);stateManager=ut(lF);options=ut($d,{optional:!0})||{};pendingTasks=ut($a);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";navigationTransitions=ut(mb);urlSerializer=ut(Hd);location=ut(eu);urlHandlingStrategy=ut(pb);injector=ut(wi);_events=new Ai;get events(){return this._events}get routerState(){return this.stateManager.getRouterState()}navigated=!1;routeReuseStrategy=ut(aF);onSameUrlNavigation=this.options.onSameUrlNavigation||"ignore";config=ut(vp,{optional:!0})?.flat()??[];componentInputBindingEnabled=!!ut(B_,{optional:!0});constructor(){this.resetConfig(this.config),this.navigationTransitions.setupNavigations(this).subscribe({error:l=>{this.console.warn(l)}}),this.subscribeToNavigationEvents()}eventsSubscription=new _i;subscribeToNavigationEvents(){let l=this.navigationTransitions.events.subscribe(m=>{try{let b=this.navigationTransitions.currentTransition,r=this.navigationTransitions.currentNavigation;if(b!==null&&r!==null){if(this.stateManager.handleRouterEvent(m,r),m instanceof Ya&&m.code!==Wo.Redirect&&m.code!==Wo.SupersededByNewNavigation)this.navigated=!0;else if(m instanceof la)this.navigated=!0;else if(m instanceof pp){let M=m.navigationBehaviorOptions,k=this.urlHandlingStrategy.merge(m.url,b.currentRawUrl),U=$t({browserUrl:b.extras.browserUrl,info:b.extras.info,skipLocationChange:b.extras.skipLocationChange,replaceUrl:b.extras.replaceUrl||this.urlUpdateStrategy==="eager"||$6(b.source)},M);this.scheduleNavigation(k,lp,null,U,{resolve:b.resolve,reject:b.reject,promise:b.promise})}}Zj(m)&&this._events.next(m)}catch(b){this.navigationTransitions.transitionAbortWithErrorSubject.next(b)}});this.eventsSubscription.add(l)}resetRootComponentType(l){this.routerState.root.component=l,this.navigationTransitions.rootComponentType=l}initialNavigation(){this.setUpLocationChangeListener(),this.navigationTransitions.hasRequestedNavigation||this.navigateToSyncWithBrowser(this.location.path(!0),lp,this.stateManager.restoredState())}setUpLocationChangeListener(){this.nonRouterCurrentEntryChangeSubscription??=this.stateManager.registerNonRouterCurrentEntryChangeListener((l,m,b)=>{this.navigateToSyncWithBrowser(l,b,m)})}navigateToSyncWithBrowser(l,m,b){let r={replaceUrl:!0},M=b?.navigationId?b:null;if(b){let U=$t({},b);delete U.navigationId,delete U.\u0275routerPageId,Object.keys(U).length!==0&&(r.state=U)}let k=this.parseUrl(l);this.scheduleNavigation(k,m,M,r).catch(U=>{this.disposed||this.injector.get(ys)(U)})}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return this.navigationTransitions.currentNavigation}get lastSuccessfulNavigation(){return this.navigationTransitions.lastSuccessfulNavigation}resetConfig(l){this.config=l.map(xS),this.navigated=!1}ngOnDestroy(){this.dispose()}dispose(){this._events.unsubscribe(),this.navigationTransitions.complete(),this.nonRouterCurrentEntryChangeSubscription&&(this.nonRouterCurrentEntryChangeSubscription.unsubscribe(),this.nonRouterCurrentEntryChangeSubscription=void 0),this.disposed=!0,this.eventsSubscription.unsubscribe()}createUrlTree(l,m={}){let{relativeTo:b,queryParams:r,fragment:M,queryParamsHandling:k,preserveFragment:U}=m,ae=U?this.currentUrlTree.fragment:M,Ee=null;switch(k??this.options.defaultQueryParamsHandling){case"merge":Ee=$t($t({},this.currentUrlTree.queryParams),r);break;case"preserve":Ee=this.currentUrlTree.queryParams;break;default:Ee=r||null}Ee!==null&&(Ee=this.removeEmptyProps(Ee));let Be;try{let ht=b?b.snapshot:this.routerState.snapshot.root;Be=UL(ht)}catch{(typeof l[0]!="string"||l[0][0]!=="/")&&(l=[]),Be=this.currentUrlTree.root}return jL(Be,l,Ee,ae??null)}navigateByUrl(l,m={skipLocationChange:!1}){let b=up(l)?l:this.parseUrl(l),r=this.urlHandlingStrategy.merge(b,this.rawUrlTree);return this.scheduleNavigation(r,lp,null,m)}navigate(l,m={skipLocationChange:!1}){return Y6(l),this.navigateByUrl(this.createUrlTree(l,m),m)}serializeUrl(l){return this.urlSerializer.serialize(l)}parseUrl(l){try{return this.urlSerializer.parse(l)}catch{return this.urlSerializer.parse("/")}}isActive(l,m){let b;if(m===!0?b=$t({},q6):m===!1?b=$t({},X6):b=m,up(l))return wL(this.currentUrlTree,l,b);let r=this.parseUrl(l);return wL(this.currentUrlTree,r,b)}removeEmptyProps(l){return Object.entries(l).reduce((m,[b,r])=>(r!=null&&(m[b]=r),m),{})}scheduleNavigation(l,m,b,r,M){if(this.disposed)return Promise.resolve(!1);let k,U,ae;M?(k=M.resolve,U=M.reject,ae=M.promise):ae=new Promise((Be,ht)=>{k=Be,U=ht});let Ee=this.pendingTasks.add();return gb(this,()=>{queueMicrotask(()=>this.pendingTasks.remove(Ee))}),this.navigationTransitions.handleNavigationRequest({source:m,restoredState:b,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,rawUrl:l,extras:r,resolve:k,reject:U,promise:ae,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),ae.catch(Be=>Promise.reject(Be))}static \u0275fac=function(m){return new(m||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function Y6(a){for(let u=0;u<a.length;u++)if(a[u]==null)throw new en(4008,!1)}var U_=class{};var cF=(()=>{class a{router;injector;preloadingStrategy;loader;subscription;constructor(l,m,b,r){this.router=l,this.injector=m,this.preloadingStrategy=b,this.loader=r}setUpPreloading(){this.subscription=this.router.events.pipe(xo(l=>l instanceof la),Ua(()=>this.preload())).subscribe(()=>{})}preload(){return this.processRoutes(this.injector,this.router.config)}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}processRoutes(l,m){let b=[];for(let r of m){r.providers&&!r._injector&&(r._injector=Zf(r.providers,l,`Route: ${r.path}`));let M=r._injector??l,k=r._loadedInjector??M;(r.loadChildren&&!r._loadedRoutes&&r.canLoad===void 0||r.loadComponent&&!r._loadedComponent)&&b.push(this.preloadConfig(M,r)),(r.children||r._loadedRoutes)&&b.push(this.processRoutes(k,r.children??r._loadedRoutes))}return yi(b).pipe(Sf())}preloadConfig(l,m){return this.preloadingStrategy.preload(m,()=>{let b;m.loadChildren&&m.canLoad===void 0?b=this.loader.loadChildren(l,m):b=In(null);let r=b.pipe(bi(M=>M===null?In(void 0):(m._loadedRoutes=M.routes,m._loadedInjector=M.injector,this.processRoutes(M.injector??l,M.routes))));if(m.loadComponent&&!m._loadedComponent){let M=this.loader.loadComponent(l,m);return yi([r,M]).pipe(Sf())}else return r})}static \u0275fac=function(m){return new(m||a)(ln(su),ln(wi),ln(U_),ln(fb))};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),uF=new Kt(""),K6=(()=>{class a{urlSerializer;transitions;viewportScroller;zone;options;routerEventsSubscription;scrollEventsSubscription;lastId=0;lastSource=lp;restoredId=0;store={};constructor(l,m,b,r,M={}){this.urlSerializer=l,this.transitions=m,this.viewportScroller=b,this.zone=r,this.options=M,M.scrollPositionRestoration||="disabled",M.anchorScrolling||="disabled"}init(){this.options.scrollPositionRestoration!=="disabled"&&this.viewportScroller.setHistoryScrollRestoration("manual"),this.routerEventsSubscription=this.createScrollEvents(),this.scrollEventsSubscription=this.consumeScrollEvents()}createScrollEvents(){return this.transitions.events.subscribe(l=>{l instanceof iu?(this.store[this.lastId]=this.viewportScroller.getScrollPosition(),this.lastSource=l.navigationTrigger,this.restoredId=l.restoredState?l.restoredState.navigationId:0):l instanceof la?(this.lastId=l.id,this.scheduleScrollEvent(l,this.urlSerializer.parse(l.urlAfterRedirects).fragment)):l instanceof Ja&&l.code===dp.IgnoredSameUrlNavigation&&(this.lastSource=void 0,this.restoredId=0,this.scheduleScrollEvent(l,this.urlSerializer.parse(l.url).fragment))})}consumeScrollEvents(){return this.transitions.events.subscribe(l=>{l instanceof fp&&(l.position?this.options.scrollPositionRestoration==="top"?this.viewportScroller.scrollToPosition([0,0]):this.options.scrollPositionRestoration==="enabled"&&this.viewportScroller.scrollToPosition(l.position):l.anchor&&this.options.anchorScrolling==="enabled"?this.viewportScroller.scrollToAnchor(l.anchor):this.options.scrollPositionRestoration!=="disabled"&&this.viewportScroller.scrollToPosition([0,0]))})}scheduleScrollEvent(l,m){this.zone.runOutsideAngular(()=>El(this,null,function*(){yield new Promise(b=>{setTimeout(b),typeof requestAnimationFrame<"u"&&requestAnimationFrame(b)}),this.zone.run(()=>{this.transitions.events.next(new fp(l,this.lastSource==="popstate"?this.store[this.restoredId]:null,m))})}))}ngOnDestroy(){this.routerEventsSubscription?.unsubscribe(),this.scrollEventsSubscription?.unsubscribe()}static \u0275fac=function(m){tI()};static \u0275prov=Zt({token:a,factory:a.\u0275fac})}return a})();function J6(a){return a.routerState.root}function j_(a,u){return{\u0275kind:a,\u0275providers:u}}function Q6(){let a=ut(qi);return u=>{let l=a.get(Nl);if(u!==l.components[0])return;let m=a.get(su),b=a.get(dF);a.get(SS)===1&&m.initialNavigation(),a.get(pF,null,{optional:!0})?.setUpPreloading(),a.get(uF,null,{optional:!0})?.init(),m.resetRootComponentType(l.componentTypes[0]),b.closed||(b.next(),b.complete(),b.unsubscribe())}}var dF=new Kt("",{factory:()=>new Ai}),SS=new Kt("",{providedIn:"root",factory:()=>1});function hF(){let a=[{provide:SS,useValue:0},wx(()=>{let u=ut(qi);return u.get(TI,Promise.resolve()).then(()=>new Promise(m=>{let b=u.get(su),r=u.get(dF);gb(b,()=>{m(!0)}),u.get(mb).afterPreactivation=()=>(m(!0),r.closed?In(void 0):r),b.initialNavigation()}))})];return j_(2,a)}function fF(){let a=[wx(()=>{ut(su).setUpLocationChangeListener()}),{provide:SS,useValue:2}];return j_(3,a)}var pF=new Kt("");function mF(a){return j_(0,[{provide:pF,useExisting:cF},{provide:U_,useExisting:a}])}function gF(){return j_(8,[yS,{provide:B_,useExisting:yS}])}function _F(a){Ld("NgRouterViewTransitions");let u=[{provide:wS,useValue:sF},{provide:ES,useValue:$t({skipNextTransition:!!a?.skipInitialTransition},a)}];return j_(9,u)}var yF=[eu,{provide:Hd,useClass:ru},su,Gd,{provide:ou,useFactory:J6,deps:[su]},fb,[]],_b=(()=>{class a{constructor(){}static forRoot(l,m){return{ngModule:a,providers:[yF,[],{provide:vp,multi:!0,useValue:l},[],m?.errorHandler?{provide:TS,useValue:m.errorHandler}:[],{provide:$d,useValue:m||{}},m?.useHash?tH():nH(),eH(),m?.preloadingStrategy?mF(m.preloadingStrategy).\u0275providers:[],m?.initialNavigation?rH(m):[],m?.bindToComponentInputs?gF().\u0275providers:[],m?.enableViewTransitions?_F().\u0275providers:[],iH()]}}static forChild(l){return{ngModule:a,providers:[{provide:vp,multi:!0,useValue:l}]}}static \u0275fac=function(m){return new(m||a)};static \u0275mod=$o({type:a});static \u0275inj=bo({})}return a})();function eH(){return{provide:uF,useFactory:()=>{let a=ut(AO),u=ut($r),l=ut($d),m=ut(mb),b=ut(Hd);return l.scrollOffset&&a.setOffset(l.scrollOffset),new K6(b,m,a,u,l)}}}function tH(){return{provide:zl,useClass:II}}function nH(){return{provide:zl,useClass:Ax}}function rH(a){return[a.initialNavigation==="disabled"?fF().\u0275providers:[],a.initialNavigation==="enabledBlocking"?hF().\u0275providers:[]]}var IS=new Kt("");function iH(){return[{provide:IS,useFactory:Q6},{provide:Ex,multi:!0,useExisting:IS}]}var aH=[],yb=class a{static \u0275fac=function(l){return new(l||a)};static \u0275mod=$o({type:a});static \u0275inj=bo({imports:[_b.forRoot(aH),_b]})};var EF=ww(WI()),TF=ww(bF());var wF=[{id:696322,resource_state:3,name:"18th St Climb",activity_type:"Ride",distance:2243.98,average_grade:6.3,maximum_grade:10,elevation_high:358.4,elevation_low:216.8,start_latlng:[40.42608495801687,-79.98083202168345],end_latlng:[40.4193573910743,-79.98949287459254],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/IW5HON52AR2LJCQKOXSUX3INOW2H7I3EH7RHJXLWAC4M563MVTXLKKLE4MMNYVPQZSEHMAIJ3QWI77FVJJ2DEQQ=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/IW5HON52AR2LJCQKOXSUX3INOW2H7I3EH7RHJXLWAC4M563MVTXLKKLE4MMNYVPQZSEHMAIJ3QWI77FVJJ2DEQQ=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/QX4K2DB3K4547YBZAXU7QD32VYHY4N76Y4IOHYBKPAG7ZP7PSN2RZTR6CULXHO22MZNQWEM5QODIBY4MLCL7GQQ="},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2011-08-01T09:18:22Z",updated_at:"2021-05-19T08:01:56Z",total_elevation_gain:141.6,map:{id:"s696322",polyline:"_vvuFfgdgNn@@dAJ~@?VGJQDu@Lc@@g@Jm@Nk@Ly@VaCPkA?a@DQLM`@]RCx@Sv@@^C`@F^Jf@TjAv@b@^HLT\\|@dCtA~B`@fBPf@BPBf@SnBMXMJGR[bBCR@TIh@]lAQdAUv@Gd@DZb@b@j@v@f@~@jA~DVj@X\\rAbAR^~AlDLPTFPAVQZm@L]Pm@Vu@Va@XYHCTDd@?j@H^@d@H?JCFeA`Cw@|ASf@[jAYb@o@r@Yn@I^IR_@p@",resource_state:3},effort_count:2637,athlete_count:750,star_count:5,athlete_segment_stats:{pr_elapsed_time:554,pr_date:"2024-08-21",pr_visibility:"only_me",pr_activity_id:12208646196,pr_activity_visibility:"everyone",effort_count:11},xoms:{kom:"6:07",qom:"7:08",overall:"6:07",destination:{href:"strava://segments/696322/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:5613936,title:"P Lee",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/5613936/2705118/1/large.jpg",effort_description:"4 efforts in the last 90 days",effort_count:"4",effort_counts:{overall:"4 efforts",female:"2 efforts"},destination:"strava://segments/696322/local_legend?categories%5B%5D=overall"}},{id:815373,resource_state:3,name:"Dirty Dozen Hill 8 - Sycamore (official end)",activity_type:"Ride",distance:756.3,average_grade:11.9,maximum_grade:23.5,elevation_high:362.6,elevation_low:272.4,start_latlng:[40.43034221045673,-80.00079461373389],end_latlng:[40.43030709028244,-80.00649481080472],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/XBSOL3N3IFBDJF4W7H7YKLM7OHT6H2UNGQIHARGLXCC3FLTC6G4CKBWNFPN3GG7DPEARPM77Q2SFVAS64AERTGA=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/XBSOL3N3IFBDJF4W7H7YKLM7OHT6H2UNGQIHARGLXCC3FLTC6G4CKBWNFPN3GG7DPEARPM77Q2SFVAS64AERTGA=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/Q4A7MNQ6UNB2LY6K2VQM474IJSDI7IWVQ7CFIELRYBBYQDP3HOXJ2WTCK7KTYL5PAZU3BHWEK5CNPVUMWB3VQZA="},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2011-11-04T15:53:22Z",updated_at:"2021-05-20T08:02:06Z",total_elevation_gain:90.2,map:{id:"s815373",polyline:"spwuF~chgNTMHFDNA^GJC^[l@Kh@E^]~@GXKZANLb@ZRHHVv@X~BAj@Hb@DJPBPA`@KF?PJb@Nd@ZJJj@Jj@PDLEVKJ]D_A@a@DWHQLo@zAc@bBGp@CHSXEB",resource_state:3},effort_count:12580,athlete_count:2463,star_count:251,athlete_segment_stats:{pr_elapsed_time:311,pr_date:"2023-10-19",pr_visibility:"everyone",pr_activity_id:10069295323,pr_activity_visibility:"everyone",effort_count:5},xoms:{kom:"2:43",qom:"3:37",overall:"2:43",destination:{href:"strava://segments/815373/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:6526075,title:"Burak Tekes",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/6526075/2053057/13/large.jpg",effort_description:"11 efforts in the last 90 days",effort_count:"11",effort_counts:{overall:"11 efforts",female:"2 efforts"},destination:"strava://segments/815373/local_legend?categories%5B%5D=overall"}},{id:2678725,resource_state:3,name:"Barry Holt Elanor - Dirty Dozen #12",activity_type:"Ride",distance:689.2,average_grade:15.1,maximum_grade:26.6,elevation_high:297.6,elevation_low:193.2,start_latlng:[40.42379083111882,-79.96889577247202],end_latlng:[40.42020211927593,-79.97237493284047],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/STWBS67F4RRROW7T4HJOORDRHSKBFFO7YBQB2P6NUZT4NJ4NGC2BC2ZP3HKN3HF7MIAEEPBIYJWZ6ALNWTJUULHL",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/STWBS67F4RRROW7T4HJOORDRHSKBFFO7YBQB2P6NUZT4NJ4NGC2BC2ZP3HKN3HF7MIAEEPBIYJWZ6ALNWTJUULHL",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/VRAXEET5SQKJOPABCMX7U6TKMUHY5J42S5MVHLEPXU7GAB65EZYJJNMFS33HBKQE3Y3VKGJAJHFZWT75DUF4WQZ4"},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2012-11-03T15:38:37Z",updated_at:"2021-05-20T08:02:21Z",total_elevation_gain:104.4,map:{id:"s2678725",polyline:"ugvuFr|agNFx@?^Db@Gb@BNHL?PBBl@NL@NABB@An@X^V^NBCXVPDTNP@RNLp@Ep@Mp@DjC?|ABLBDN?JG~@SjAIJ?XKb@CXI\\?TIn@BLF@C",resource_state:3},effort_count:6420,athlete_count:1547,star_count:168,athlete_segment_stats:{pr_elapsed_time:348,pr_date:"2024-05-03",pr_visibility:"everyone",pr_activity_id:11322606934,pr_activity_visibility:"everyone",effort_count:3},xoms:{kom:"2:48",qom:"3:47",overall:"2:48",destination:{href:"strava://segments/2678725/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:6321316,title:"George Chen",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/6321316/4446594/1/large.jpg",effort_description:"4 efforts in the last 90 days",effort_count:"4",effort_counts:{overall:"4 efforts",female:null},destination:"strava://segments/2678725/local_legend?categories%5B%5D=overall"}},{id:656361,resource_state:3,name:"Southern",activity_type:"Ride",distance:1808.46,average_grade:5.2,maximum_grade:9,elevation_high:354.2,elevation_low:259.4,start_latlng:[40.414436,-80.009874],end_latlng:[40.427857,-80.008805],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/V2ROZDVPFYDRKFWJ2BP2MBJXFVDK525VNKMFD6ETEBHZNOQFN4SMGOHWH5AE2DULV3NYAE7DCFDE3PLTR6XBHE45",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/V2ROZDVPFYDRKFWJ2BP2MBJXFVDK525VNKMFD6ETEBHZNOQFN4SMGOHWH5AE2DULV3NYAE7DCFDE3PLTR6XBHE45",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/7NFGX45MK35ZBAQIBDWHI3FUT73EXC6LY6MO2T7EAZDHBSMGMRQMR5S7YB5UQGJ6SDCUMT7SMH3KIOAQTZZJ465V"},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2011-05-23T01:40:58Z",updated_at:"2021-05-20T08:02:04Z",total_elevation_gain:95.35,map:{id:"s656361",polyline:"emtuFv|igNsBzDYp@e@N]KYRKj@@t@S~EAVQn@]PeARqA\\k@Tc@XkBd@o@EeCs@}P}DmAWcBc@i@g@qA{AgFmE{@aAsBgCa@YoC_As@KaBc@cAOwA?mAU",resource_state:3},effort_count:10697,athlete_count:1413,star_count:31,athlete_segment_stats:{pr_elapsed_time:444,pr_date:"2024-10-05",pr_visibility:"everyone",pr_activity_id:12582482334,pr_activity_visibility:"everyone",effort_count:2},xoms:{kom:"4:05",qom:"5:28",overall:"4:05",destination:{href:"strava://segments/656361/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:24978314,title:"B Tang",profile:"https://lh3.googleusercontent.com/a/ACg8ocJnt40qri3MP0FXt0u1fdKS4d6OHuGpH5QcF8XSLwAgecTFQA=s96-c",effort_description:"11 efforts in the last 90 days",effort_count:"11",effort_counts:{overall:"11 efforts",female:"1 effort"},destination:"strava://segments/656361/local_legend?categories%5B%5D=overall"}},{id:686600,resource_state:3,name:"Greenleaf St, Mt Washington",activity_type:"Ride",distance:1143.18,average_grade:10.2,maximum_grade:24.1,elevation_high:351.2,elevation_low:229,start_latlng:[40.44324,-80.02812],end_latlng:[40.43891,-80.02634],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/ACM6AIRXCUIWVPM33QDUXHW7FKAQFJW4IPGHYVW3JFKX32EY5OMXVRACPLKV2S4TEZERAF7R2I6MSX22LP6DNPPD",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/ACM6AIRXCUIWVPM33QDUXHW7FKAQFJW4IPGHYVW3JFKX32EY5OMXVRACPLKV2S4TEZERAF7R2I6MSX22LP6DNPPD",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/BLS7ZODFGI3RX5J6QVGTRS4CG4WXWKOURGXYRWJ45JBAVCFRFOAOIFJDW45JJ3F3MS52SK37JSI3ZUZ33WPNPKEN"},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2011-07-20T04:51:25Z",updated_at:"2021-05-20T08:02:05Z",total_elevation_gain:116.698,map:{id:"s686600",polyline:"gazuFvnmgNN@JDFLHHj@jAHHPLh@NR@@NPRBPN`@FFDLDDLRZRZ\\PJBFbAl@BFTHLH^f@l@LPPF?RLVXZDDJ`@Jb@VJ?RPFHJFPTHAFFRH`ANb@FJEHDf@HJCJEVGHODe@?OUuAIUScAW_AIk@Sw@[{AEk@Qg@EE[oAFcAFYCQF]Fy@@o@Hu@Ai@GW",resource_state:3},effort_count:2189,athlete_count:571,star_count:59,athlete_segment_stats:{pr_elapsed_time:396,pr_date:"2025-05-13",pr_visibility:"everyone",pr_activity_id:14468432387,pr_activity_visibility:"everyone",effort_count:2},xoms:{kom:"3:45",qom:"5:08",overall:"3:45",destination:{href:"strava://segments/686600/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:14265,title:"David Kl\xFCg",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/14265/3358060/5/large.jpg",effort_description:"5 efforts in the last 90 days",effort_count:"5",effort_counts:{overall:"5 efforts",female:"1 effort"},destination:"strava://segments/686600/local_legend?categories%5B%5D=overall"}},{id:8813588,resource_state:3,name:"Mooney",activity_type:"Ride",distance:620.7,average_grade:15,maximum_grade:23.9,elevation_high:206.6,elevation_low:113.6,start_latlng:[40.379097,-79.92372],end_latlng:[40.379526,-79.917717],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/MZIX5OBJTPC6NMGKAAC4HPUQZQO6XDE5A6YAMAQYVFOXPBXYMWE4AZYOZTT3V6YTJN35ONOPODZA6BZ5B234KCQO",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/MZIX5OBJTPC6NMGKAAC4HPUQZQO6XDE5A6YAMAQYVFOXPBXYMWE4AZYOZTT3V6YTJN35ONOPODZA6BZ5B234KCQO",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/KHQCBOKQL7TE62EBVW4N4WMD2UIQ5IOZ72BDBPM56OL6ERVW5EWSET6YSKH77C4WC3NSOWETKSMVIRFL2DZVB3UE"},climb_category:1,city:"Pittsburgh",state:"Pennsylvania",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2015-01-22T23:09:37Z",updated_at:"2021-05-15T02:16:01Z",total_elevation_gain:92.2,map:{id:"s8813588",polyline:"ipmuFfbyfNGCCGCW`@cAH[HiBZcCT_AbA}BZeAJm@@m@E_@Uu@gBoCeAgBo@}@a@qA",resource_state:3},effort_count:216,athlete_count:105,star_count:9,athlete_segment_stats:{pr_elapsed_time:288,pr_date:"2023-04-25",pr_visibility:"everyone",pr_activity_id:8957642702,pr_activity_visibility:"everyone",effort_count:1},xoms:{kom:null,qom:"3:46",overall:"2:51",destination:{href:"strava://segments/8813588/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:10701355,title:"Sean Wehr",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/10701355/8645132/1/large.jpg",effort_description:"2 efforts in the last 90 days",effort_count:"2",effort_counts:{overall:"2 efforts",female:"1 effort"},destination:"strava://segments/8813588/local_legend?categories%5B%5D=overall"}},{id:709140,resource_state:3,name:"The Run to Fifth (via Panther Hollow) (updated)",activity_type:"Ride",distance:2291.62,average_grade:2.1,maximum_grade:31.9,elevation_high:274,elevation_low:223.3,start_latlng:[40.4276852,-79.94905765],end_latlng:[40.44671955,-79.94706183333334],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/4B6MPOWP27MCQX5QUXFW5JLWQTS6ZM6CPYJKX4GBJETYCEUTANUORCBZGG2IGCZMD3CCH3PJV3AL3JOQY24BWQDV",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/4B6MPOWP27MCQX5QUXFW5JLWQTS6ZM6CPYJKX4GBJETYCEUTANUORCBZGG2IGCZMD3CCH3PJV3AL3JOQY24BWQDV",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/OENORUP4KCKORTIVK4SU4Y4S3RAKXXBP7H5PJQ5BIUDQZOMGS7TKOA3ZR23ELWCRUVZUYE73ZMXFQMB36HMVENOD"},climb_category:0,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2011-08-10T12:35:04Z",updated_at:"2021-05-20T08:02:05Z",total_elevation_gain:54.29,map:{id:"s709140",polyline:"_`wuFr`~fNiEt@o@Ts@f@eA|@kA^e@V[`@_@PWX_@Pq@Hg@@g@Ae@Qe@_@i@Sk@Gm@@wAK{@KqA]k@IwAEk@Bk@CgC[m@A_BNoBAiBIo@@uE`@o@RaCjAg@Rg@Nq@_@c@c@a@e@y@uA]a@_@YmB}@}A_A}EyEqA}@aDkBYUQWe@Ys@Io@?sBb@uAb@]DmAb@",resource_state:3},effort_count:59347,athlete_count:5637,star_count:13,athlete_segment_stats:{pr_elapsed_time:299,pr_date:"2023-07-18",pr_visibility:"everyone",pr_activity_id:9477979906,pr_activity_visibility:"everyone",effort_count:90},xoms:{kom:"3:54",qom:"4:43",overall:"3:54",destination:{href:"strava://segments/709140/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:142054980,title:"Jordan Wilson",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/142054980/36686873/4/large.jpg",effort_description:"28 efforts in the last 90 days",effort_count:"28",effort_counts:{overall:"28 efforts",female:"25 efforts"},destination:"strava://segments/709140/local_legend?categories%5B%5D=overall"}},{id:20855939,resource_state:3,name:"Nobles Ln.",activity_type:"Ride",distance:1287.4,average_grade:5.5,maximum_grade:8,elevation_high:413,elevation_low:342,start_latlng:[40.396293,-79.997127],end_latlng:[40.403615,-79.990575],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/DCNQ2265JTJOO3HG5MUYL23VI3NDJW5QMRSU27ABKFHORQ2Y3TEMTSMHPE46SOVNAPSEAZ2BZ4ZZ7TZEQONPFBY=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/DCNQ2265JTJOO3HG5MUYL23VI3NDJW5QMRSU27ABKFHORQ2Y3TEMTSMHPE46SOVNAPSEAZ2BZ4ZZ7TZEQONPFBY=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/TQ6PHZVAY5LZGTZJ6P45LU4ZXEX5KLY7BC3WCEPYZ7HZ5MDOAFCJLG27MBM3QXZJZIZ5DEDC5IT2L5V6G4GVF6Q="},climb_category:0,city:null,state:null,country:null,private:!1,hazardous:!1,starred:!1,created_at:"2019-06-12T13:30:38Z",updated_at:"2021-05-18T08:05:39Z",total_elevation_gain:71,map:{id:"s20855939",polyline:"y{puF`mggNkAf@eAh@e@Nc@Jc@Bu@Ee@?cB\\iDUa@?yAPqDhA_@CYQUWm@kCMe@Ie@QqBKi@Sa@s@s@Wc@Og@Ki@UoCw@oMWw@iCgF",resource_state:3},effort_count:1490,athlete_count:234,star_count:7,athlete_segment_stats:{pr_elapsed_time:344,pr_date:"2023-08-18",pr_visibility:"everyone",pr_activity_id:9674468030,pr_activity_visibility:"everyone",effort_count:2},xoms:{kom:null,qom:"4:44",overall:null,destination:{href:"strava://segments/20855939/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:14846123,title:"Edward Phillips",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/14846123/4192764/3/large.jpg",effort_description:"15 efforts in the last 90 days",effort_count:"15",effort_counts:{overall:"15 efforts",female:"5 efforts"},destination:"strava://segments/20855939/local_legend?categories%5B%5D=overall"}},{id:5406416,resource_state:3,name:"Greenfield - Haldane",activity_type:"Ride",distance:786.8,average_grade:7.2,maximum_grade:11.9,elevation_high:284,elevation_low:227.6,start_latlng:[40.424978,-79.952131],end_latlng:[40.425394,-79.943295],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/HCHVFSYGQC25EDUKHKFE326F6YSLQSHBY63GDBK3CKE6WFIFR2BPFZ6ZCGDMNEYLLZCL6E7AKUJCLNJ4FZN74RY=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/HCHVFSYGQC25EDUKHKFE326F6YSLQSHBY63GDBK3CKE6WFIFR2BPFZ6ZCGDMNEYLLZCL6E7AKUJCLNJ4FZN74RY=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/CF4EACRUJ2H4542B2FSWXIFLSTRZL5QRUHA22XVKIRYC67VA22DPPJIYUXDGXECSRFBET25EZBCXXBD76UZQLTQ="},climb_category:0,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2013-09-06T19:52:27Z",updated_at:"2021-05-20T08:02:42Z",total_elevation_gain:58.4,map:{id:"s5406416",polyline:"aovuFzs~fN@[EUMKM[oA}Cc@aECg@PoCF_@Hm@ZkBTsBLeBH_C?uAAo@EWMg@IQOuA?mALoB@q@IcA",resource_state:3},effort_count:21106,athlete_count:2170,star_count:34,athlete_segment_stats:{pr_elapsed_time:179,pr_date:"2022-08-27",pr_visibility:"everyone",pr_activity_id:7708910614,pr_activity_visibility:"everyone",effort_count:7},xoms:{kom:"1:03",qom:"1:59",overall:"1:03",destination:{href:"strava://segments/5406416/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:38968634,title:"Ben Freed",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/38968634/16684746/2/large.jpg",effort_description:"18 efforts in the last 90 days",effort_count:"18",effort_counts:{overall:"18 efforts",female:"6 efforts"},destination:"strava://segments/5406416/local_legend?categories%5B%5D=overall"}},{id:10590095,resource_state:3,name:"William Street ",activity_type:"Ride",distance:819.4,average_grade:9.6,maximum_grade:19.6,elevation_high:376.2,elevation_low:297.8,start_latlng:[40.42818,-79.997038],end_latlng:[40.427144,-80.00527],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/L6ALH425DHJKGPVS6YBUVESWMY7PV7NNBSIJJUSYAIOVKUHZVRTZU5NQEZWGP7OIZNWWH4EIWRNW6P5KUGOHDQI=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/L6ALH425DHJKGPVS6YBUVESWMY7PV7NNBSIJJUSYAIOVKUHZVRTZU5NQEZWGP7OIZNWWH4EIWRNW6P5KUGOHDQI=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/CFRSVRUTPD33HOY6LIBUYR43JDWJSGPBVA7U57YJFEFMWE5VMRZ3GSLZDXJDE3P6I5KEO3TMQOOCCOBXKQDDQLI="},climb_category:0,city:"Pittsburgh",state:"Pennsylvania",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2015-09-30T17:56:04Z",updated_at:"2021-05-19T08:03:26Z",total_elevation_gain:78.4,map:{id:"s10590095",polyline:"acwuFnlggNEBSVEHCLAJBf@H^Ap@EJMt@IlA@NHVLTXZJf@@VCZU`@K\\k@n@?LGNMLQZc@bBI`ABNJVv@hAFlAF\\`@`A\\\\R\\Tr@LZd@~AR`@Vp@Ll@z@`C",resource_state:3},effort_count:1234,athlete_count:316,star_count:14,athlete_segment_stats:{pr_elapsed_time:291,pr_date:"2023-04-13",pr_visibility:"everyone",pr_activity_id:8885657859,pr_activity_visibility:"everyone",effort_count:2},xoms:{kom:"2:36",qom:"3:42",overall:"2:36",destination:{href:"strava://segments/10590095/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:14265,title:"David Kl\xFCg",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/14265/3358060/5/large.jpg",effort_description:"23 efforts in the last 90 days",effort_count:"23",effort_counts:{overall:"23 efforts",female:"1 effort"},destination:"strava://segments/10590095/local_legend?categories%5B%5D=overall"}},{id:887503,resource_state:3,name:"Swinburne Street",activity_type:"Ride",distance:653.7,average_grade:4.7,maximum_grade:23.1,elevation_high:289.4,elevation_low:259,start_latlng:[40.427283653989434,-79.95091499760747],end_latlng:[40.43168247677386,-79.95273035019636],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/2SIFLYM7LAMKTJDYLXES4C77GW4X5EOFK22FXHCMHPFBBISDWPDAHNN7W2B6A3TMBJLZZUXPU6XEKUVDG3ULUVA=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/2SIFLYM7LAMKTJDYLXES4C77GW4X5EOFK22FXHCMHPFBBISDWPDAHNN7W2B6A3TMBJLZZUXPU6XEKUVDG3ULUVA=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/RWLGN6RN5LZ4HTXAWJMUTEF4ZPCRRQ4DHDEP5P5U5Z2V7O73WWT7RDHPV77VPE2TVTDMUCA6WWP4LU3UCTULDQI="},climb_category:0,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!0,created_at:"2012-01-01T20:36:26Z",updated_at:"2021-05-20T08:02:07Z",total_elevation_gain:30,map:{id:"s887503",polyline:"o}vuFfl~fNc@LCFD??Gi@o@MIu@q@]QYKY@s@Rm@DiA\\u@^eAz@m@Zm@\\IHo@hAQNQBSEYSc@_@QIYDEDGDEPOtAIvB",resource_state:3},effort_count:14653,athlete_count:1552,star_count:45,athlete_segment_stats:{pr_elapsed_time:81,pr_date:"2024-05-28",pr_visibility:"everyone",pr_activity_id:11521029464,pr_activity_visibility:"everyone",effort_count:26},xoms:{kom:"54s",qom:"1:19",overall:"54s",destination:{href:"strava://segments/887503/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:186406,title:"Mark Perry",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/186406/1074744/2/large.jpg",effort_description:"39 efforts in the last 90 days",effort_count:"39",effort_counts:{overall:"39 efforts",female:"8 efforts"},destination:"strava://segments/887503/local_legend?categories%5B%5D=overall"}},{id:2392489,resource_state:3,name:"West End to Crafton Climb",activity_type:"Ride",distance:2613.21,average_grade:4.5,maximum_grade:21.8,elevation_high:287.4,elevation_low:166.2,start_latlng:[40.44444912113249,-80.02897549420595],end_latlng:[40.444008903577924,-80.0554355699569],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/GWQQSNYIAAHOKR5MTSHGODDGXYYY3NN3RRQMSV7N4UA4ITQYSBLGIMPC3R3EACY2UXDEKNHFKVQFEL364GAQMTQ=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/GWQQSNYIAAHOKR5MTSHGODDGXYYY3NN3RRQMSV7N4UA4ITQYSBLGIMPC3R3EACY2UXDEKNHFKVQFEL364GAQMTQ=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/MQG4OKWO2CHFH532A6LILFTQK5QSPUYGZGNLQMNVDUL2WXX6NV3FDR4BRPW5MUNJE3OMST7ZZXPLFLP47U37URQ="},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2012-09-16T15:27:04Z",updated_at:"2021-05-15T02:12:29Z",total_elevation_gain:130.6,map:{id:"s2392489",polyline:"whzuFbtmgNXt@l@hAd@jANd@xAdE^x@b@pAd@|ARfAPx@n@fBf@bBv@|Cx@nCZpARn@Rf@D`@@|@C|DD`@Lb@BXKrA@j@Ct@Dh@ANHt@G^Ad@q@fAg@jAe@h@w@~Ae@f@u@jAITy@bAMf@YTORGTCx@@ZLh@L|@Rf@d@j@NL`@VV\\t@p@l@bArBbC`@p@HRHh@BvACRQx@cAnBs@jAK\\c@pB_AjH]jBS|@WZKd@?RQ|@c@jAKPGd@cA~DOXOb@M~@K\\G`@Sz@OjA",resource_state:3},effort_count:378,athlete_count:178,star_count:2,athlete_segment_stats:{pr_elapsed_time:null,pr_date:null,pr_visibility:null,pr_activity_id:null,pr_activity_visibility:null,effort_count:0},xoms:{kom:"6:53",qom:"3:45",overall:"3:45",destination:{href:"strava://segments/2392489/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:80147073,title:"Ben Gower",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/80147073/19719602/4/large.jpg",effort_description:"1 effort in the last 90 days",effort_count:"1",effort_counts:{overall:"1 effort",female:null},destination:"strava://segments/2392489/local_legend?categories%5B%5D=overall"}},{id:7702218,resource_state:3,name:"Brentwood, Schuette, Willett Rd climb",activity_type:"Ride",distance:3347.6,average_grade:3.7,maximum_grade:17.2,elevation_high:385.9,elevation_low:261.1,start_latlng:[40.365977,-79.949999],end_latlng:[40.385548,-79.971341],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/XZDDIAR5WUVUWKCV5NVNT2GRTEZWVEAUEV7SARZNF3CC67RTI5BVQ7QMMTKOH64GU5ACEMFMNCYBYSGMEITAQKLS",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/XZDDIAR5WUVUWKCV5NVNT2GRTEZWVEAUEV7SARZNF3CC67RTI5BVQ7QMMTKOH64GU5ACEMFMNCYBYSGMEITAQKLS",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/RBRWC5LPGIRCR5Q3G75FRYQ4SYRHG5DITPI5WAW5C4QYF7RCZZDHXMOBD5XFTOJMWUQEOR5JIJ7NTD4UU6RXWBCW"},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2014-07-21T21:20:26Z",updated_at:"2021-05-15T02:15:22Z",total_elevation_gain:138.2,map:{id:"s7702218",polyline:"i~juFnf~fNOdAQbA_BrHaAzD]hA[GIVL\\CHg@x@q@t@mCfCaBhA]\\m@bAo@`BW`AIn@Dl@HBFb@Bz@DP?d@Kv@GPMRUL]FiA@a@GUEYOiAkAIEUEW@i@R[Fc@@SCa@SWUo@{@QMOEUAQDkCbAODU@wEk@w@GOIRSIQBHDACDMHAJcGpFoEzD_@`@_@j@i@`Aa@lAY~@y@xFc@jBc@~Aa@rAcEjKiBxGeB|GSp@Yh@MRc@b@e@\\s@`@i@RiAVyBXuD^g@N}@h@WR_CjC",resource_state:3},effort_count:301,athlete_count:84,star_count:3,athlete_segment_stats:{pr_elapsed_time:693,pr_date:"2022-09-11",pr_visibility:"everyone",pr_activity_id:7792440134,pr_activity_visibility:"everyone",effort_count:1},xoms:{kom:"7:40",qom:"10:13",overall:"7:40",destination:{href:"strava://segments/7702218/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:8969861,title:"Rusty Duff",profile:"https://graph.facebook.com/10204525319353248/picture?height=256&width=256",effort_description:"5 efforts in the last 90 days",effort_count:"5",effort_counts:{overall:"5 efforts",female:null},destination:"strava://segments/7702218/local_legend?categories%5B%5D=overall"}},{id:2138299,resource_state:3,name:"Prospect Rd Climb",activity_type:"Ride",distance:1743.11,average_grade:5.3,maximum_grade:12.2,elevation_high:391.9,elevation_low:299.8,start_latlng:[40.35209319625906,-79.96460695700209],end_latlng:[40.35936285609915,-79.98034779409679],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/4WOCV3EKVUT6PRJR6HPGNUJV4NXCFUQKC362XPO3ELL7J7UHZJFIGX2HHNSQPUMG56RNQPHQ6JE44ZHLPKO6RMA=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/4WOCV3EKVUT6PRJR6HPGNUJV4NXCFUQKC362XPO3ELL7J7UHZJFIGX2HHNSQPUMG56RNQPHQ6JE44ZHLPKO6RMA=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/N7L5XLTHTFTEB3YZ2TLFCZTAJLVDESORWXHVJLLEO665JNIVAS2UFTQKEWHGMZBHMEM4IYCG43VYDB4MWVQVSXQ="},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2012-08-15T20:35:49Z",updated_at:"2021-05-15T02:12:22Z",total_elevation_gain:94.7873,map:{id:"s2138299",polyline:"qghuFxaagNU`@QJIJSp@w@|@kAz@cBxAoBjBc@f@WTyDzBi@`@o@b@}@z@_BlBkA`Bs@fAu@x@kAvAMTKXi@~AWnAIh@MhBEVM`DQr@]r@Wr@Op@O`DEf@?|@JxAl@dEnAlG@f@Cr@CTm@|A[^_@p@ELUXg@|@",resource_state:3},effort_count:188,athlete_count:39,star_count:2,athlete_segment_stats:{pr_elapsed_time:null,pr_date:null,pr_visibility:null,pr_activity_id:null,pr_activity_visibility:null,effort_count:0},xoms:{kom:"4:23",qom:"6:57",overall:"4:23",destination:{href:"strava://segments/2138299/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:8382841,title:"David Denis",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/8382841/4688766/4/large.jpg",effort_description:"2 efforts in the last 90 days",effort_count:"2",effort_counts:{overall:"2 efforts",female:null},destination:"strava://segments/2138299/local_legend?categories%5B%5D=overall"}},{id:4961664,resource_state:3,name:"Josephine St/ Arlington Ave Climb",activity_type:"Ride",distance:1777.2,average_grade:6.7,maximum_grade:19.9,elevation_high:358.7,elevation_low:240.2,start_latlng:[40.423798,-79.96876],end_latlng:[40.417497,-79.972786],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/ECGRF6553OBKQBUGJ7CL2TFN35JEAOXDW3Y2FYLPERQN3WJ4WJFEDAIXMMMDMJBHDQNKHNKBDW4UMOLQGKWBXIZJ",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/ECGRF6553OBKQBUGJ7CL2TFN35JEAOXDW3Y2FYLPERQN3WJ4WJFEDAIXMMMDMJBHDQNKHNKBDW4UMOLQGKWBXIZJ",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/XPNTTED32DFBOMC2EPDL4K7QFA2RHWOOVXNWRVE2T36CABKFJ4Y3W7HFNUY6UDENY7AWRA366TSIBJSOME2LBOOM"},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!0,created_at:"2013-08-02T14:42:25Z",updated_at:"2021-05-19T08:02:29Z",total_elevation_gain:125.3,map:{id:"s4961664",polyline:"ugvuFv{agNFGRq@jAkCJKf@]HOBM?e@Dg@DMdAwCx@qBLCr@wAj@_ABKjAcBPa@NQL@HET@vEdAbCn@^N^Xx@dA^fALr@J|ACt@B\\J^DHTLH@JATKFKJ{@LkDHQFEP?HDJNBJDl@ALNzAHxAC`AMfA?ZWtBOhC_@bFEfA?fAFfB\\pG",resource_state:3},effort_count:6601,athlete_count:1661,star_count:40,athlete_segment_stats:{pr_elapsed_time:422,pr_date:"2023-09-13",pr_visibility:"everyone",pr_activity_id:9844599090,pr_activity_visibility:"everyone",effort_count:10},xoms:{kom:"4:29",qom:"5:48",overall:"4:29",destination:{href:"strava://segments/4961664/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:240924,title:"Lars Cleath",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/240924/43084/12/large.jpg",effort_description:"7 efforts in the last 90 days",effort_count:"7",effort_counts:{overall:"7 efforts",female:"2 efforts"},destination:"strava://segments/4961664/local_legend?categories%5B%5D=overall"}},{id:14674301,resource_state:3,name:"PA 60 Outbound",activity_type:"Ride",distance:2580.9,average_grade:4.4,maximum_grade:10.8,elevation_high:343.9,elevation_low:231.1,start_latlng:[40.440528,-80.035636],end_latlng:[40.437285,-80.058541],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/LSRI7IX5FASUYT5DCBU33HTLPZMB3QV7VPUFBBTEJML46UV4NDKTZSYE5FOUTPH6QZSKFEMHO5ECSJ2JPKIGL5A=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/LSRI7IX5FASUYT5DCBU33HTLPZMB3QV7VPUFBBTEJML46UV4NDKTZSYE5FOUTPH6QZSKFEMHO5ECSJ2JPKIGL5A=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/VJUGGHFKG47L3NBXVJHSMSM64575GEC6KJAEQSKF6F2Z35ASVDVZL4PKPFG4LHJIQKSKZEVUTGYZKAGJKL3SEHQ="},climb_category:1,city:"Pittsburgh",state:"Pennsylvania",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2017-04-22T14:55:48Z",updated_at:"2021-05-15T02:19:14Z",total_elevation_gain:112.8,map:{id:"s14674301",polyline:"gpyuFv}ngNDBVCvA_A\\QRGr@EbBBr@TPJ\\Hl@Xd@Nl@J~@Hd@Nf@Gf@?`BBXFz@DPFLLH\\Aj@Q`BAv@Mp@YtBQp@ILe@fBUl@o@z@c@\\MLOVQp@UzCOxA]dBa@|C_@hBUr@]jBc@zCMbBAlADlEV|DNxA?z@E~AK`ABf@H|@bAnC^vAHz@FbAAbBMbCG\\Ur@Wl@Sn@Iv@?TTxCNxDDXDl@@z@R`FDX?^BT\\`Ad@zB",resource_state:3},effort_count:9151,athlete_count:569,star_count:2,athlete_segment_stats:{pr_elapsed_time:561,pr_date:"2023-09-03",pr_visibility:"everyone",pr_activity_id:9775357970,pr_activity_visibility:"everyone",effort_count:6},xoms:{kom:"5:45",qom:"6:15",overall:"5:45",destination:{href:"strava://segments/14674301/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:14846123,title:"Edward Phillips",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/14846123/4192764/3/large.jpg",effort_description:"22 efforts in the last 90 days",effort_count:"22",effort_counts:{overall:"22 efforts",female:"2 efforts"},destination:"strava://segments/14674301/local_legend?categories%5B%5D=overall"}},{id:25652064,resource_state:3,name:"Glass Run + Cathell",activity_type:"Ride",distance:2795,average_grade:4.8,maximum_grade:10.8,elevation_high:362.1,elevation_low:228.6,start_latlng:[40.389641,-79.935078],end_latlng:[40.385149,-79.949682],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/4XVQ2PZQUY4MFWORAILVWALM6VDTSIGEDBEIMFU6M7USVIBXXR7Z6DZ44DQETFDSOOWM2AIVZIKCE52GQW4WAYCU",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/4XVQ2PZQUY4MFWORAILVWALM6VDTSIGEDBEIMFU6M7USVIBXXR7Z6DZ44DQETFDSOOWM2AIVZIKCE52GQW4WAYCU",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/ZQW2CRELZAOXFNJRAGYV5DM6PP3VJ3QIXN3B6FANXVHM43TICOZQN5SVAF7PAEB5QCBXG4LUZSDUUX23KLHJA223"},climb_category:1,city:"Pittsburgh",state:"Pennsylvania",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2020-09-09T16:24:19Z",updated_at:"2021-05-19T08:05:32Z",total_elevation_gain:133.5,map:{id:"s25652064",polyline:"grouFfi{fNJrCB~Ea@|SJfCEvA@^Bn@Jv@@v@?DIL[`@k@~@a@|@Kj@@l@BVFTBf@BbBEv@K`AEt@A\\Jh@DvAJh@B^@p@SfCy@pEI`Aw@vCAj@VbDFVNV^@@OAY[aB?u@JWb@i@v@sANc@XaARYZYPa@HqALw@Hu@@_@?mDL{@b@kBFu@RiALgARw@LSJGN?LJf@fAb@zBl@fBZr@FJh@|Av@zCf@xBPpAN`BrAfFJLVLLBLAz@SnAo@n@M",resource_state:3},effort_count:524,athlete_count:83,star_count:2,athlete_segment_stats:{pr_elapsed_time:569,pr_date:"2024-12-10",pr_visibility:"everyone",pr_activity_id:13087456201,pr_activity_visibility:"everyone",effort_count:2},xoms:{kom:"7:28",qom:"9:33",overall:"7:28",destination:{href:"strava://segments/25652064/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:27934388,title:"Billy Kanarek",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/27934388/13764114/1/large.jpg",effort_description:"4 efforts in the last 90 days",effort_count:"4",effort_counts:{overall:"4 efforts",female:null},destination:"strava://segments/25652064/local_legend?categories%5B%5D=overall"}},{id:837458,resource_state:3,name:"greentree to parkway center",activity_type:"Ride",distance:1371.19,average_grade:9.2,maximum_grade:13.7,elevation_high:349.8,elevation_low:224,start_latlng:[40.434826193377376,-80.035006608814],end_latlng:[40.42525850236416,-80.04221018403769],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/ZVNBB7GDQZCWOI2KV5WJHFKBA5T4HCKBRLXSTC4L544B7MBZ56AMR4MJK3XRGNJAIVS5GL2GY5IYHSEAIN2CQLA=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/ZVNBB7GDQZCWOI2KV5WJHFKBA5T4HCKBRLXSTC4L544B7MBZ56AMR4MJK3XRGNJAIVS5GL2GY5IYHSEAIN2CQLA=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/VTDOFRESUXWQNIEGK5K7FM3NV5JJAQU2L5ZJX7ZTFQ7UKDTG25PXCL4WZDFOQF2Q5ZVDPME4YLBCI64XJSVEVGQ="},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2011-11-25T14:38:53Z",updated_at:"2021-05-20T08:02:07Z",total_elevation_gain:125.8,map:{id:"s837458",polyline:"slxuFxyngNFjBAVEHIr@Ad@HVDXEL?r@Nd@Zj@Zr@HH^NPNb@@RDBFAD@J`APn@n@JPJ@VNJTHJXD^?z@f@j@Tb@EP@x@`@\\@z@Rb@RZBRLb@HFF\\LNJ~@L|@Fn@b@v@x@JV^h@V`AXb@x@~@x@r@HBjAJzAYH@v@K~@SRAZ@\\Jr@`@zAjB^\\",resource_state:3},effort_count:1873,athlete_count:299,star_count:5,athlete_segment_stats:{pr_elapsed_time:null,pr_date:null,pr_visibility:null,pr_activity_id:null,pr_activity_visibility:null,effort_count:0},xoms:{kom:"4:44",qom:"7:07",overall:"4:44",destination:{href:"strava://segments/837458/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:3114344,title:"Nik Reinert",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/3114344/11867795/5/large.jpg",effort_description:"17 efforts in the last 90 days",effort_count:"17",effort_counts:{overall:"17 efforts",female:"17 efforts"},destination:"strava://segments/837458/local_legend?categories%5B%5D=overall"}},{id:2749245,resource_state:3,name:"Walbridge Herschel Climb",activity_type:"Ride",distance:1048.27,average_grade:11,maximum_grade:31.1,elevation_high:124.2,elevation_low:9.4,start_latlng:[40.44040745124221,-80.03559686243534],end_latlng:[40.44094305485487,-80.0437605008483],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/AQ62D3Y334EAA6BJ6L3QTZWBTOMVHI5D6VNOMMNVCVGK3SR7YTYLXH5CYYIG2LHW4VCT4QOFAPV5VZ2LEWZ4ZZQ=",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/AQ62D3Y334EAA6BJ6L3QTZWBTOMVHI5D6VNOMMNVCVGK3SR7YTYLXH5CYYIG2LHW4VCT4QOFAPV5VZ2LEWZ4ZZQ=",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/TOTV3UXTVCUOJTRBJWFAM4SG7EKRJ2LVHXCCUKJ7RI6O64C7PCZT7VIIGVRQJX3A2YWVWGAIPS5ZXEDWVPDJJSA="},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2012-11-17T17:43:46Z",updated_at:"2021-05-15T02:12:40Z",total_elevation_gain:114.8,map:{id:"s2749245",polyline:"ooyuFn}ngNBb@CJBt@DPD`@Xd@^dAh@l@N@VARETO^ANG@FLDr@DZH\\BT?XL`@Bd@NFH?F[nAAf@MfAGVKnA_@~AK\\CVGNEr@_@vAo@jESx@s@`As@h@SXq@t@c@h@{A~As@p@[^",resource_state:3},effort_count:233,athlete_count:96,star_count:11,athlete_segment_stats:{pr_elapsed_time:null,pr_date:null,pr_visibility:null,pr_activity_id:null,pr_activity_visibility:null,effort_count:0},xoms:{kom:"4:04",qom:"5:15",overall:"4:04",destination:{href:"strava://segments/2749245/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:73118811,title:"Danielle Voye",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/73118811/17792881/1/large.jpg",effort_description:"1 effort in the last 90 days",effort_count:"1",effort_counts:{overall:"1 effort",female:"1 effort"},destination:"strava://segments/2749245/local_legend?categories%5B%5D=overall"}},{id:7394647,resource_state:3,name:"PJ McCardle Full Climb SS-Mt Washington",activity_type:"Ride",distance:2281.4,average_grade:4.6,maximum_grade:10.8,elevation_high:313,elevation_low:208,start_latlng:[40.427219,-79.989244],end_latlng:[40.435551,-80.01259],elevation_profile:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/56LLXMNTQ56S7WRSLEV4GLKNXWGBN42ZYT6D2UW7OQACUAEWNLWSUKL4IULYARSJGMGB7ECDH2BLAOYI5WYVD4ID",elevation_profiles:{light_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/56LLXMNTQ56S7WRSLEV4GLKNXWGBN42ZYT6D2UW7OQACUAEWNLWSUKL4IULYARSJGMGB7ECDH2BLAOYI5WYVD4ID",dark_url:"https://d3o5xota0a1fcr.cloudfront.net/v6/charts/37IVIIA465WKXIC3CNS53Y42ROR2LKHPZ4AY2J2E3GLK5FSEHS5CMZMAICNVZMUUHI2AECAX5ZWIEOQICBTAYP5I"},climb_category:1,city:"Pittsburgh",state:"PA",country:"United States",private:!1,hazardous:!1,starred:!1,created_at:"2014-06-09T17:01:58Z",updated_at:"2021-05-17T08:05:09Z",total_elevation_gain:105,map:{id:"s7394647",polyline:"a}vuFx{egN?dCCfBaBlGMn@KlA?XRnCElAM`Ak@xCa@jA]|AWbBsBxGYlABb@Nf@f@j@@XSh@mAfEKt@a@dAWf@s@~BQjAMj@[p@_C~Gg@x@Q^UXg@nAc@rA?NKP@LFXQv@KNAJ}@tB{@rCW^GRk@lAAVK\\Ml@KhAQb@q@z@IRQh@S`@Oj@Qb@e@r@{@bBq@~@a@n@eBrB]t@[rA",resource_state:3},effort_count:1528,athlete_count:416,star_count:4,athlete_segment_stats:{pr_elapsed_time:723,pr_date:"2021-10-03",pr_visibility:"everyone",pr_activity_id:6057731275,pr_activity_visibility:"everyone",effort_count:1},xoms:{kom:"6:21",qom:"7:59",overall:"6:21",destination:{href:"strava://segments/7394647/leaderboard",type:"overall",name:"All-Time"}},local_legend:{athlete_id:9503498,title:"Cam Spooner",profile:"https://dgalywyr863hv.cloudfront.net/pictures/athletes/9503498/2882130/7/large.jpg",effort_description:"6 efforts in the last 90 days",effort_count:"6",effort_counts:{overall:"6 efforts",female:"1 effort"},destination:"strava://segments/7394647/local_legend?categories%5B%5D=overall"}}];var bb=class a{segmentList=[];constructor(){this.segmentList=Array.from(wF).map(u=>{let l=u;return l.start_latlng.reverse(),l.end_latlng.reverse(),l})}getAllSegments(){return this.segmentList}getSegmentByDomId(u){return this.segmentList.at(u)}directionVector(u){let l=u.start_latlng,m=u.end_latlng;return[m[0]-l[0],m[1]-l[1]]}midpoint(u){let l=u.start_latlng,m=u.end_latlng;return[(l[0]+m[0])/2,(l[1]+m[1])/2]}vectorToBearing(u){let[l,m]=u,b=Math.atan2(l,m)*(180/Math.PI);return b<0&&(b+=360),b}static \u0275fac=function(l){return new(l||a)};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})};var wb=class a{constructor(u){this.http=u}apiURL="https://www.strava.com/api/v3/";config=ut(tu).stravaClient;ngOnInit(){[].map(l=>{this.getSegment(l).subscribe(m=>{console.log(JSON.stringify(m))})})}getSegment(u){let l=`${this.apiURL}/segments/${u}`,m=new qa({"Content-Type":"application/json",Authorization:`Bearer ${this.config.token}`});return this.http.get(l,{headers:m})}static \u0275fac=function(l){return new(l||a)(ln(Bx))};static \u0275prov=Zt({token:a,factory:a.\u0275fac,providedIn:"root"})};var uH=a=>[a,40.44],dH="#B64129",hH="#EE4B2B",Eb=class a{constructor(u){this.config=u;this.segment=ut(bb),this.strava=ut(wb)}title=Bg("velopitt");map;segment;strava;onLoad(u){this.map=u.target,this.map.resize(),this.map.getCanvas().style.cursor="default",this.addAllSegments()}addAllSegments(){if(this.map==null)throw new Error("Map is not loaded");this.map.addSource("segments",{type:"geojson",generateId:!0,data:{type:"FeatureCollection",features:this.segment.getAllSegments().map(l=>({type:"Feature",properties:{},geometry:TF.toGeoJSON(l.map.polyline)}))}}),this.map.addLayer({id:"segments-layer",type:"line",source:"segments",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["case",["boolean",["feature-state","selected"],!1],hH,dH],"line-width":["interpolate",["exponential",2],["zoom"],0,["*",12,["^",2,-6]],24,["*",12,["^",2,8]]]}});let u=this.map;u.addInteraction("segment-clicks",{type:"click",target:{layerId:"segments-layer"},handler:this.handleSegmentClickEvent()}),u.addInteraction("segments-hover",{type:"mouseenter",target:{layerId:"segments-layer"},handler:l=>{u.getCanvas().style.cursor="pointer",this.highlightSegment(l.feature?.id,!0)}}),u.addInteraction("segments-leave",{type:"mouseleave",target:{layerId:"segments-layer"},handler:l=>{this.highlightSegment(l.feature?.id,!1),u.getCanvas().style.cursor="default"}})}highlightSegment(u,l){this.map?.setFeatureState({source:"segments",id:u},{selected:l})}handleSegmentClickEvent(){return u=>{if(this.map==null)return;let l=u.feature?.id,m=this.segment.getSegmentByDomId(l);this.map.flyTo({center:m?.start_latlng,bearing:this.segment.vectorToBearing(this.segment.directionVector(m)),zoom:16.5,speed:1}),this.highlightSegment(l,!0),new EF.Popup().setLngLat(u.lngLat).setHTML(`<p><b>${m?.name}</b></p>`).addTo(this.map)}}static \u0275fac=function(l){return new(l||a)(Qc(tu))};static \u0275cmp=kl({type:a,selectors:[["app-root"]],standalone:!1,decls:3,vars:10,consts:[[1,"map",2,"height","100vh","width","100%"],[3,"mapLoad","zoom","center","interactive","maxZoom","bearing","pitch"]],template:function(l,m){l&1&&(r_(0,"div",0)(1,"mgl-map",1),l_("mapLoad",function(r){return m.onLoad(r)}),i_()(),Xf(2,"router-outlet")),l&2&&($T(),mI("mapbox://styles/hgriff0n/cmds2q1t100u101s2063wbeh6"),Tx("zoom",15)("center",_I(8,uH,-79.997))("interactive",!0)("maxZoom",31)("bearing",90)("pitch",70))},dependencies:[z_,Vx],styles:["[_nghost-%COMP%]{display:flex;flex:1}mgl-map[_ngcontent-%COMP%]{height:100%;width:100%}"]})};var Tb=class a{config=ut(tu);static \u0275fac=function(l){return new(l||a)};static \u0275mod=$o({type:a,bootstrap:[Eb]});static \u0275inj=bo({providers:[YE(),nL({accessToken:zd.decode(Bd.MAPBOX_API_KEY)})],imports:[NI,yb,HI,Vx,rL]})};kI().bootstrapModule(Tb,{ngZoneEventCoalescing:!0}).catch(a=>console.error(a));
